<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - å…¨çƒåŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ä½ çš„åŸå§‹ä»£ç ç›¸åŒ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        input[type="text"], textarea { width: 100%; max-width: 400px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        .word-card { background: white; border: 4px solid #4CAF50; border-radius: 20px; height: 280px; display: flex; align-items: center; justify-content: center; margin: 30px auto; cursor: pointer; font-size: 2.8em; font-weight: bold; transition: all 0.3s; max-width: 600px; }
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        .wechat-badge { background: #07C160; color: white; padding: 14px 28px; border-radius: 25px; display: inline-flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1em; margin: 15px 0; box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3); }
        .preview-container { max-height: 300px; overflow-y: auto; margin: 20px 0; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; background: #f9f9f9; }
        .preview-table { width: 100%; border-collapse: collapse; }
        .preview-table th { background: #2196F3; color: white; padding: 10px; text-align: left; font-size: 14px; }
        .preview-table td { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .preview-table tr:nth-child(even) { background: #f5f5f5; }
        .preview-table tr:hover { background: #e3f2fd; }
        @media (max-width: 768px) { .container { margin: 10px; border-radius: 15px; } .header { padding: 20px; } .header h1 { font-size: 1.8em; } .word-card { height: 220px; font-size: 2.2em; margin: 20px 10px; } .btn { padding: 12px 20px; margin: 8px; font-size: 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - å…¨çƒåŒæ­¥ç‰ˆ</h1>
            <h2 style="color: white;">ğŸŒ å…¨çƒæ•°æ®åŒæ­¥ | éšæ—¶éšåœ°ä¸Šè¯¾</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151 | ğŸ“Š å®æ—¶ç›‘æ§</p>
        </div>
        
        <div class="main-content">
            <!-- ========== ç™»å½•ç•Œé¢ ========== -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿æ¥åˆ°å…¨çƒåŒæ­¥å•è¯è®­ç»ƒè¥ï¼</h2>
                    <p style="color: #666; margin-bottom: 30px;">æ•°æ®å…¨çƒåŒæ­¥ï¼Œéšæ—¶éšåœ°å­¦ä¹ </p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="login()">
                                <span>ğŸ”‘ ç™»å½•</span>
                            </button>
                            <button class="btn btn-blue" onclick="register()">
                                <span>ğŸ“ å­¦ç”Ÿæ³¨å†Œ</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- åŒæ­¥çŠ¶æ€ -->
                    <div id="sync-status" style="display: none; padding: 10px; background: #e8f5e8; border-radius: 8px; margin: 20px auto; max-width: 400px;">
                        <p style="color: #4CAF50; margin: 0;">âœ… å·²è¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“</p>
                    </div>
                    
                    <!-- è”ç³»ä¿¡æ¯ -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ’¬ è”ç³»ä¿¡æ¯</h3>
                        <div class="wechat-badge">
                            <span>è€å¸ˆå¾®ä¿¡ï¼š</span>
                            <strong>Kathy151</strong>
                        </div>
                        <p style="color: #555; margin-top: 15px; font-size: 0.95em;">
                            ğŸŒ å…¨çƒåŒæ­¥åŠŸèƒ½ï¼šæ‰€æœ‰æ•°æ®å®æ—¶ä¿å­˜åˆ°äº‘ç«¯ï¼Œä»»ä½•è®¾å¤‡éƒ½å¯è®¿é—®
                        </p>
                    </div>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div id="login-status" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- ========== ä¸»èœå•ï¼ˆæ•™å¸ˆï¼‰ ========== -->
            <div id="teacher-menu" class="screen">
                <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿ - å…¨çƒç›‘æ§</h2>
                
                <div class="stats-card">
                    <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç­çº§å®æ—¶ç»Ÿè®¡</h3>
                    <div id="class-stats">
                        <p>æ­£åœ¨ä»äº‘ç«¯åŠ è½½ç­çº§æ•°æ®...</p>
                    </div>
                </div>
                
                <!-- æ•™å¸ˆç®¡ç†åŠŸèƒ½ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ‘¥</div>
                        <h4 style="color: #1976D2;">å­¦ç”Ÿç®¡ç†</h4>
                        <p style="color: #555; margin: 10px 0;">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å­¦ç”Ÿ</p>
                        <button class="btn btn-blue" onclick="showAllStudents()" style="width: 100%;">
                            <span>ç®¡ç†å­¦ç”Ÿ</span>
                        </button>
                    </div>
                    
                    <div style="background: #E8F5E9; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ“š</div>
                        <h4 style="color: #2E7D32;">å…±äº«å•è¯åº“</h4>
                        <p style="color: #555; margin: 10px 0;">ä¸ºå­¦ç”Ÿä¸Šä¼ å…±äº«å•è¯</p>
                        <button class="btn" onclick="showGlobalWords()" style="width: 100%;">
                            <span>å…±äº«å•è¯åº“</span>
                        </button>
                    </div>
                    
                    <div style="background: #FFF3E0; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ“Š</div>
                        <h4 style="color: #EF6C00;">å­¦ä¹ ç›‘æ§</h4>
                        <p style="color: #555; margin: 10px 0;">å®æ—¶ç›‘æ§å­¦ç”Ÿå­¦ä¹ è¿›åº¦</p>
                        <button class="btn btn-gold" onclick="showLearningMonitor()" style="width: 100%;">
                            <span>å®æ—¶ç›‘æ§</span>
                        </button>
                    </div>
                    
                    <div style="background: #F3E5F5; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">âš™ï¸</div>
                        <h4 style="color: #7B1FA2;">ç³»ç»Ÿè®¾ç½®</h4>
                        <p style="color: #555; margin: 10px 0;">ç³»ç»Ÿç®¡ç†å’Œæ•°æ®å¯¼å‡º</p>
                        <button class="btn btn-purple" onclick="showTeacherSettings()" style="width: 100%;">
                            <span>ç³»ç»Ÿè®¾ç½®</span>
                        </button>
                    </div>
                </div>
                
                <!-- å¿«æ·æ“ä½œ -->
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-gold" onclick="exportAllData()">
                            <span>ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æ•°æ®</span>
                        </button>
                        <button class="btn" onclick="clearCacheAndSync()">
                            <span>ğŸ”„ å¼ºåˆ¶åŒæ­¥</span>
                        </button>
                        <button class="btn btn-red" onclick="logout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ========== ä¸»èœå•ï¼ˆå­¦ç”Ÿï¼‰ ========== -->
            <div id="student-menu" class="screen">
                <h2 id="student-welcome" style="text-align: center; margin-bottom: 30px;"></h2>
                
                <!-- å­¦ä¹ ç»Ÿè®¡ -->
                <div class="stats-card">
                    <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦ï¼ˆäº‘ç«¯åŒæ­¥ï¼‰</h3>
                    <div id="student-stats">
                        <p>æ­£åœ¨ä»äº‘ç«¯åŠ è½½å­¦ä¹ æ•°æ®...</p>
                    </div>
                </div>
                
                <!-- å­¦ç”ŸåŠŸèƒ½ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="background: #E8F5E9; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ“</div>
                        <h4 style="color: #2E7D32;">æ·»åŠ å•è¯</h4>
                        <p style="color: #555; margin: 10px 0;">æ·»åŠ ä¸ªäººå•è¯</p>
                        <button class="btn" onclick="showAddWords()" style="width: 100%;">
                            <span>æ·»åŠ å•è¯</span>
                        </button>
                    </div>
                    
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ¯</div>
                        <h4 style="color: #1976D2;">å¼€å§‹è®­ç»ƒ</h4>
                        <p style="color: #555; margin: 10px 0;">ç»ƒä¹ æ‰€æœ‰å•è¯</p>
                        <button class="btn btn-blue" onclick="startTraining()" style="width: 100%;">
                            <span>å¼€å§‹è®­ç»ƒ</span>
                        </button>
                    </div>
                    
                    <div style="background: #FFF3E0; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ”„</div>
                        <h4 style="color: #EF6C00;">å¤ä¹ å¼±é¡¹</h4>
                        <p style="color: #555; margin: 10px 0;">ä¸“é—¨å¤ä¹ éš¾ç‚¹</p>
                        <button class="btn btn-gold" onclick="showReviewWords()" style="width: 100%;">
                            <span>å¤ä¹ å¼±é¡¹</span>
                        </button>
                    </div>
                    
                    <div style="background: #FCE4EC; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ğŸ“–</div>
                        <h4 style="color: #C2185B;">å…±äº«åº“</h4>
                        <p style="color: #555; margin: 10px 0;">è€å¸ˆå…±äº«çš„å•è¯</p>
                        <button class="btn btn-purple" onclick="viewSharedWords()" style="width: 100%;">
                            <span>å…±äº«å•è¯åº“</span>
                        </button>
                    </div>
                </div>
                
                <!-- åŒæ­¥çŠ¶æ€ -->
                <div id="student-sync-status" style="padding: 10px; background: #e8f5e8; border-radius: 8px; margin: 20px 0; text-align: center;">
                    <p style="color: #4CAF50; margin: 0;">âœ… æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯</p>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-red" onclick="logout()">
                        <span>ğŸšª é€€å‡ºç™»å½•</span>
                    </button>
                </div>
            </div>
            
            <!-- ========== å…¶ä»–ç•Œé¢ï¼ˆä¿æŒåŸæ ·ï¼Œæ ·å¼çœç•¥ï¼‰ ========== -->
            <!-- ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä»¥ä¸‹ç•Œé¢çš„HTMLç»“æ„ä¸åŸä»£ç ç›¸åŒ -->
            <!-- æ·»åŠ å•è¯ã€å•è¯è®­ç»ƒã€æˆ‘çš„å•è¯åº“ç­‰ç•Œé¢çš„HTMLç»“æ„ä¸å˜ -->
            
        </div>
    </div>

    <script>
        // ========== SUPABASE é…ç½® ==========
        const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-adGnuLFrSYG3melS6pPqg_XW7RlFzF';
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        console.log('ğŸŒ Supabaseäº‘ç«¯æ•°æ®åº“å·²è¿æ¥');
        
        // ========== å…¨å±€é…ç½® ==========
        const TEACHER_USERNAME = 'kathy151';
        
        let appState = {
            currentUser: null,
            isTeacher: false,
            userId: null,           // æ•°æ®åº“ä¸­çš„ç”¨æˆ·ID
            userWords: [],          // å­¦ç”Ÿçš„å•è¯åº“ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
            trainingWords: [],      // å½“å‰è®­ç»ƒçš„å•è¯
            currentWordIndex: 0,
            trainingMode: 'en_to_cn',
            cardFlipped: false,
            previewWordsList: [],
            globalWords: []         // è€å¸ˆå…±äº«çš„å•è¯
        };
        
        // ========== æ•°æ®åº“æ“ä½œå‡½æ•° ==========
        
        // 1. åˆ›å»ºæˆ–è·å–ç”¨æˆ·
        async function createOrGetUser(username, isTeacher = false) {
            try {
                // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('æ£€æŸ¥ç”¨æˆ·é”™è¯¯:', checkError);
                }
                
                if (existingUser) {
                    // ç”¨æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°æœ€åç™»å½•æ—¶é—´
                    const { data: updatedUser, error: updateError } = await supabase
                        .from('users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('id', existingUser.id)
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('æ›´æ–°ç”¨æˆ·é”™è¯¯:', updateError);
                        return { success: false, error: updateError };
                    }
                    
                    return { 
                        success: true, 
                        user: updatedUser,
                        isNew: false 
                    };
                } else {
                    // åˆ›å»ºæ–°ç”¨æˆ·
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert([
                            {
                                username: username,
                                is_teacher: isTeacher,
                                created_at: new Date().toISOString(),
                                last_login: new Date().toISOString()
                            }
                        ])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', createError);
                        return { success: false, error: createError };
                    }
                    
                    return { 
                        success: true, 
                        user: newUser,
                        isNew: true 
                    };
                }
            } catch (error) {
                console.error('ç”¨æˆ·æ“ä½œé”™è¯¯:', error);
                return { success: false, error: error.message };
            }
        }
        
        // 2. è·å–ç”¨æˆ·çš„æ‰€æœ‰å•è¯
        async function getUserWords(userId) {
            try {
                const { data, error } = await supabase
                    .from('words')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('è·å–å•è¯é”™è¯¯:', error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('è·å–å•è¯é”™è¯¯:', error);
                return [];
            }
        }
        
        // 3. æ·»åŠ å•è¯åˆ°æ•°æ®åº“
        async function addWordsToDatabase(userId, words) {
            try {
                // æ ¼å¼åŒ–å•è¯æ•°æ®
                const wordData = words.map(word => ({
                    user_id: userId,
                    english: word.english,
                    chinese: word.chinese,
                    status: word.status || '',
                    review_count: word.reviewCount || 0,
                    last_review: word.lastReview || null,
                    added_date: word.addedDate || new Date().toISOString(),
                    word_type: (word.english.includes(' ') || word.english.length > 15) ? 'phrase' : 'word',
                    is_global: false  // ä¸ªäººå•è¯ï¼Œä¸æ˜¯å…¨å±€å•è¯
                }));
                
                const { data, error } = await supabase
                    .from('words')
                    .insert(wordData);
                
                if (error) {
                    console.error('æ·»åŠ å•è¯é”™è¯¯:', error);
                    return { success: false, error };
                }
                
                return { success: true, data };
            } catch (error) {
                console.error('æ·»åŠ å•è¯é”™è¯¯:', error);
                return { success: false, error: error.message };
            }
        }
        
        // 4. æ›´æ–°å•è¯çŠ¶æ€
        async function updateWordStatus(wordId, updates) {
            try {
                const { data, error } = await supabase
                    .from('words')
                    .update(updates)
                    .eq('id', wordId);
                
                if (error) {
                    console.error('æ›´æ–°å•è¯é”™è¯¯:', error);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('æ›´æ–°å•è¯é”™è¯¯:', error);
                return false;
            }
        }
        
        // 5. è·å–æ‰€æœ‰å­¦ç”Ÿ
        async function getAllStudentsFromDB() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_teacher', false)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('è·å–å­¦ç”Ÿé”™è¯¯:', error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿé”™è¯¯:', error);
                return [];
            }
        }
        
        // 6. è·å–å­¦ç”Ÿçš„å•è¯ç»Ÿè®¡æ•°æ®
        async function getStudentWordStats(userId) {
            try {
                const { data, error } = await supabase
                    .from('words')
                    .select('*')
                    .eq('user_id', userId);
                
                if (error) {
                    console.error('è·å–å­¦ç”Ÿå•è¯ç»Ÿè®¡é”™è¯¯:', error);
                    return { total: 0, remembered: 0, fuzzy: 0, forgot: 0 };
                }
                
                const words = data || [];
                const remembered = words.filter(w => w.status === 'remembered').length;
                const fuzzy = words.filter(w => w.status === 'fuzzy').length;
                const forgot = words.filter(w => w.status === 'forgot' || !w.status).length;
                
                return {
                    total: words.length,
                    remembered: remembered,
                    fuzzy: fuzzy,
                    forgot: forgot,
                    words: words
                };
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿå•è¯ç»Ÿè®¡é”™è¯¯:', error);
                return { total: 0, remembered: 0, fuzzy: 0, forgot: 0 };
            }
        }
        
        // 7. è·å–å…¨å±€å…±äº«å•è¯ï¼ˆè€å¸ˆä¸Šä¼ çš„ï¼‰
        async function getGlobalWords() {
            try {
                const { data, error } = await supabase
                    .from('global_words')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('è·å–å…¨å±€å•è¯é”™è¯¯:', error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('è·å–å…¨å±€å•è¯é”™è¯¯:', error);
                return [];
            }
        }
        
        // 8. æ·»åŠ å…¨å±€å•è¯ï¼ˆåªæœ‰è€å¸ˆå¯ä»¥ï¼‰
        async function addGlobalWords(words) {
            try {
                const wordData = words.map(word => ({
                    english: word.english,
                    chinese: word.chinese,
                    added_by: appState.userId,
                    added_date: new Date().toISOString(),
                    category: word.category || 'general'
                }));
                
                const { data, error } = await supabase
                    .from('global_words')
                    .insert(wordData);
                
                if (error) {
                    console.error('æ·»åŠ å…¨å±€å•è¯é”™è¯¯:', error);
                    return { success: false, error };
                }
                
                return { success: true, data };
            } catch (error) {
                console.error('æ·»åŠ å…¨å±€å•è¯é”™è¯¯:', error);
                return { success: false, error: error.message };
            }
        }
        
        // 9. è·å–ç­çº§æ€»ä½“ç»Ÿè®¡
        async function getClassStats() {
            try {
                // è·å–æ‰€æœ‰å­¦ç”Ÿ
                const students = await getAllStudentsFromDB();
                
                if (students.length === 0) {
                    return {
                        totalStudents: 0,
                        totalWords: 0,
                        rememberedWords: 0,
                        fuzzyWords: 0,
                        forgotWords: 0
                    };
                }
                
                let totalWords = 0;
                let rememberedWords = 0;
                let fuzzyWords = 0;
                let forgotWords = 0;
                
                // è·å–æ¯ä¸ªå­¦ç”Ÿçš„å•è¯ç»Ÿè®¡
                for (const student of students) {
                    const stats = await getStudentWordStats(student.id);
                    totalWords += stats.total;
                    rememberedWords += stats.remembered;
                    fuzzyWords += stats.fuzzy;
                    forgotWords += stats.forgot;
                }
                
                return {
                    totalStudents: students.length,
                    totalWords: totalWords,
                    rememberedWords: rememberedWords,
                    fuzzyWords: fuzzyWords,
                    forgotWords: forgotWords
                };
            } catch (error) {
                console.error('è·å–ç­çº§ç»Ÿè®¡é”™è¯¯:', error);
                return {
                    totalStudents: 0,
                    totalWords: 0,
                    rememberedWords: 0,
                    fuzzyWords: 0,
                    forgotWords: 0
                };
            }
        }
        
        // ========== ç™»å½•/æ³¨å†ŒåŠŸèƒ½ï¼ˆä½¿ç”¨æ•°æ®åº“ï¼‰ ==========
        async function login() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            const loginStatus = document.getElementById('login-status');
            loginStatus.style.display = 'block';
            loginStatus.innerHTML = '<p>æ­£åœ¨è¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“...</p>';
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•™å¸ˆè´¦å·
                if (username === TEACHER_USERNAME) {
                    // æ•™å¸ˆç™»å½•
                    const result = await createOrGetUser(username, true);
                    
                    if (!result.success) {
                        loginStatus.innerHTML = `<p style="color: red;">âŒ ç™»å½•å¤±è´¥: ${result.error}</p>`;
                        return;
                    }
                    
                    appState.currentUser = username;
                    appState.isTeacher = true;
                    appState.userId = result.user.id;
                    
                    // ä¿å­˜ç™»å½•çŠ¶æ€åˆ°localStorageï¼ˆç”¨äºè‡ªåŠ¨ç™»å½•ï¼‰
                    localStorage.setItem('current_user', username);
                    localStorage.setItem('user_id', result.user.id);
                    localStorage.setItem('user_role', 'teacher');
                    
                    // è·å–å…¨å±€å•è¯
                    appState.globalWords = await getGlobalWords();
                    
                    loginStatus.innerHTML = `<p style="color: green;">âœ… æ¬¢è¿Kathyè€å¸ˆï¼æ•°æ®å·²åŒæ­¥</p>`;
                    setTimeout(() => {
                        showTeacherMenu();
                        loginStatus.style.display = 'none';
                    }, 1000);
                    
                } else {
                    // å­¦ç”Ÿç™»å½•
                    const result = await createOrGetUser(username, false);
                    
                    if (!result.success) {
                        loginStatus.innerHTML = `<p style="color: red;">âŒ ç™»å½•å¤±è´¥: ${result.error}</p>`;
                        return;
                    }
                    
                    appState.currentUser = username;
                    appState.isTeacher = false;
                    appState.userId = result.user.id;
                    
                    // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
                    if (result.isNew) {
                        loginStatus.innerHTML = `<p style="color: green;">âœ… æ¬¢è¿æ–°åŒå­¦ ${username}ï¼</p>`;
                    }
                    
                    // ä»æ•°æ®åº“åŠ è½½å­¦ç”Ÿçš„å•è¯
                    appState.userWords = await getUserWords(result.user.id);
                    
                    // è·å–å…¨å±€å…±äº«å•è¯
                    appState.globalWords = await getGlobalWords();
                    
                    // ä¿å­˜ç™»å½•çŠ¶æ€
                    localStorage.setItem('current_user', username);
                    localStorage.setItem('user_id', result.user.id);
                    localStorage.setItem('user_role', 'student');
                    
                    document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼ï¼ˆäº‘ç«¯åŒæ­¥ï¼‰`;
                    
                    loginStatus.innerHTML = `<p style="color: green;">âœ… ç™»å½•æˆåŠŸï¼å·²åŠ è½½ ${appState.userWords.length} ä¸ªå•è¯</p>`;
                    setTimeout(() => {
                        showStudentMenu();
                        loginStatus.style.display = 'none';
                    }, 1000);
                }
                
                // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
                document.getElementById('sync-status').style.display = 'block';
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                loginStatus.innerHTML = `<p style="color: red;">âŒ ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>`;
            }
        }
        
        async function register() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            if (username.length < 2) {
                alert('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ•™å¸ˆç”¨æˆ·å
            if (username.toLowerCase() === TEACHER_USERNAME.toLowerCase()) {
                alert('è¯¥ç”¨æˆ·åä¸å¯ç”¨');
                return;
            }
            
            // æ³¨å†Œå°±æ˜¯ç™»å½•ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·
            login();
        }
        
        // ========== æ•™å¸ˆç›‘æ§åŠŸèƒ½ï¼ˆä½¿ç”¨æ•°æ®åº“ï¼‰ ==========
        async function updateClassStats() {
            const statsDiv = document.getElementById('class-stats');
            
            try {
                const stats = await getClassStats();
                
                if (stats.totalStudents === 0) {
                    statsDiv.innerHTML = `
                        <p style="color: #666; text-align: center; padding: 30px;">
                            è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œï¼Œè¯·åˆ†äº«é“¾æ¥ç»™å­¦ç”Ÿæ³¨å†Œ
                        </p>
                    `;
                    return;
                }
                
                const avgWords = stats.totalStudents > 0 ? Math.round(stats.totalWords / stats.totalStudents) : 0;
                const avgRemembered = stats.totalStudents > 0 ? Math.round(stats.rememberedWords / stats.totalStudents) : 0;
                
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #2196F3; font-weight: bold;">${stats.totalStudents}</div>
                            <div style="color: #666; font-size: 0.9em;">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #4CAF50; font-weight: bold;">${stats.totalWords}</div>
                            <div style="color: #666; font-size: 0.9em;">æ€»å•è¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #FF9800; font-weight: bold;">${avgWords}</div>
                            <div style="color: #666; font-size: 0.9em;">äººå‡å•è¯</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #9C27B0; font-weight: bold;">${avgRemembered}</div>
                            <div style="color: #666; font-size: 0.9em;">äººå‡æŒæ¡</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px;">ğŸ“ˆ ç­çº§å­¦ä¹ æƒ…å†µåˆ†å¸ƒï¼ˆå®æ—¶ï¼‰</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">å·²æŒæ¡</span>
                            <span style="color: #4CAF50; font-weight: bold;">${stats.rememberedWords}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.totalWords > 0 ? (stats.rememberedWords / stats.totalWords * 100) : 0}%"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin: 15px 0 8px;">
                            <span style="color: #666;">å­¦ä¹ ä¸­</span>
                            <span style="color: #FF9800; font-weight: bold;">${stats.fuzzyWords}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.totalWords > 0 ? (stats.fuzzyWords / stats.totalWords * 100) : 0}%; background: #FF9800;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin: 15px 0 8px;">
                            <span style="color: #666;">éœ€å¤ä¹ </span>
                            <span style="color: #F44336; font-weight: bold;">${stats.forgotWords}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.totalWords > 0 ? (stats.forgotWords / stats.totalWords * 100) : 0}%; background: #F44336;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <p style="color: #666; font-size: 0.9em;">æœ€åæ›´æ–°æ—¶é—´: ${new Date().toLocaleTimeString()}</p>
                        <button class="btn" onclick="updateClassStats()" style="padding: 8px 16px; font-size: 14px;">
                            <span>ğŸ”„ åˆ·æ–°æ•°æ®</span>
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('æ›´æ–°ç­çº§ç»Ÿè®¡é”™è¯¯:', error);
                statsDiv.innerHTML = `<p style="color: red;">âŒ åŠ è½½ç­çº§æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>`;
            }
        }
        
        // ========== å­¦ç”ŸåŠŸèƒ½ï¼ˆä½¿ç”¨æ•°æ®åº“ï¼‰ ==========
        async function updateStudentStats() {
            const statsDiv = document.getElementById('student-stats');
            
            const totalWords = appState.userWords.length;
            const remembered = appState.userWords.filter(w => w.status === 'remembered').length;
            const fuzzy = appState.userWords.filter(w => w.status === 'fuzzy').length;
            const forgot = appState.userWords.filter(w => w.status === 'forgot' || !w.status).length;
            const progress = totalWords > 0 ? Math.round((remembered / totalWords) * 100) : 0;
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #2196F3; font-weight: bold;">${totalWords}</div>
                        <div style="color: #666; font-size: 0.9em;">å•è¯æ€»æ•°</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #4CAF50; font-weight: bold;">${remembered}</div>
                        <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #FF9800; font-weight: bold;">${fuzzy}</div>
                        <div style="color: #666; font-size: 0.9em;">å­¦ä¹ ä¸­</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #F44336; font-weight: bold;">${forgot}</div>
                        <div style="color: #666; font-size: 0.9em;">éœ€å¤ä¹ </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <p style="color: #666; font-size: 0.9em;">æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯</p>
                </div>
            `;
        }
        
        // ========== å•è¯ç®¡ç†åŠŸèƒ½ï¼ˆä½¿ç”¨æ•°æ®åº“ï¼‰ ==========
        async function addWordsForStudent(words) {
            try {
                const result = await addWordsToDatabase(appState.userId, words);
                
                if (result.success) {
                    // é‡æ–°åŠ è½½å•è¯
                    appState.userWords = await getUserWords(appState.userId);
                    updateStudentStats();
                    return true;
                } else {
                    console.error('æ·»åŠ å•è¯å¤±è´¥:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('æ·»åŠ å•è¯å¤±è´¥:', error);
                return false;
            }
        }
        
        async function updateWordForStudent(wordId, updates) {
            try {
                const success = await updateWordStatus(wordId, updates);
                
                if (success) {
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    const index = appState.userWords.findIndex(w => w.id === wordId);
                    if (index !== -1) {
                        appState.userWords[index] = { ...appState.userWords[index], ...updates };
                    }
                    return true;
                }
                return false;
            } catch (error) {
                console.error('æ›´æ–°å•è¯å¤±è´¥:', error);
                return false;
            }
        }
        
        // ========== å…¨å±€å•è¯ç®¡ç† ==========
        async function showGlobalWords() {
            if (!appState.isTeacher) {
                alert('åªæœ‰è€å¸ˆå¯ä»¥ç®¡ç†å…¨å±€å•è¯');
                return;
            }
            
            // æ˜¾ç¤ºå…¨å±€å•è¯ç®¡ç†ç•Œé¢
            alert('å…¨å±€å•è¯ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        async function viewSharedWords() {
            if (appState.globalWords.length === 0) {
                alert('è€å¸ˆè¿˜æ²¡æœ‰ä¸Šä¼ å…±äº«å•è¯');
                return;
            }
            
            let message = `ğŸ“š è€å¸ˆå…±äº«çš„å•è¯ï¼ˆå…± ${appState.globalWords.length} ä¸ªï¼‰:\n\n`;
            appState.globalWords.forEach((word, index) => {
                message += `${index + 1}. ${word.english} - ${word.chinese}\n`;
            });
            
            alert(message);
        }
        
        // ========== æ•°æ®åŒæ­¥åŠŸèƒ½ ==========
        async function clearCacheAndSync() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å¹¶é‡æ–°åŒæ­¥æ•°æ®å—ï¼Ÿ')) {
                try {
                    // æ¸…é™¤æœ¬åœ°ç¼“å­˜
                    localStorage.clear();
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·æ•°æ®
                    if (appState.isTeacher) {
                        appState.globalWords = await getGlobalWords();
                        updateClassStats();
                        alert('âœ… æ•°æ®å·²é‡æ–°åŒæ­¥');
                    } else {
                        appState.userWords = await getUserWords(appState.userId);
                        updateStudentStats();
                        alert('âœ… ä¸ªäººæ•°æ®å·²é‡æ–°åŒæ­¥');
                    }
                } catch (error) {
                    console.error('åŒæ­¥æ•°æ®é”™è¯¯:', error);
                    alert('âŒ åŒæ­¥æ•°æ®å¤±è´¥');
                }
            }
        }
        
        // ========== é¡µé¢åˆ‡æ¢å‡½æ•° ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }
        
        function showTeacherMenu() {
            showScreen('teacher-menu');
            updateClassStats();
        }
        
        function showStudentMenu() {
            showScreen('student-menu');
            updateStudentStats();
        }
        
        function showLogin() {
            showScreen('login-screen');
        }
        
        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - å…¨çƒåŒæ­¥ç‰ˆå¯åŠ¨');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•ç”¨æˆ·
            const savedUser = localStorage.getItem('current_user');
            const savedUserId = localStorage.getItem('user_id');
            const savedRole = localStorage.getItem('user_role');
            
            if (savedUser && savedUserId) {
                appState.currentUser = savedUser;
                appState.userId = savedUserId;
                appState.isTeacher = (savedRole === 'teacher');
                
                // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                document.getElementById('sync-status').style.display = 'block';
                
                try {
                    if (appState.isTeacher) {
                        // åŠ è½½å…¨å±€å•è¯
                        appState.globalWords = await getGlobalWords();
                        showTeacherMenu();
                    } else {
                        // åŠ è½½å­¦ç”Ÿå•è¯
                        appState.userWords = await getUserWords(savedUserId);
                        // åŠ è½½å…¨å±€å•è¯
                        appState.globalWords = await getGlobalWords();
                        
                        document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${savedUser}ï¼ï¼ˆäº‘ç«¯åŒæ­¥ï¼‰`;
                        showStudentMenu();
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
                    alert('âš ï¸ åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    showLogin();
                }
            }
            
            // ç»‘å®šå›è½¦é”®
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });
        
        // ========== å…¶ä»–åŸæœ‰å‡½æ•°ï¼ˆéœ€è¦ä¿®æ”¹ä¸ºä½¿ç”¨æ•°æ®åº“ï¼‰ ==========
        // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä»¥ä¸‹å‡½æ•°éœ€è¦ä½ æ ¹æ®ä¸Šè¿°æ•°æ®åº“æ“ä½œå‡½æ•°è¿›è¡Œä¿®æ”¹ï¼š
        // showAllStudents, viewStudentDetail, startTraining, markWord, endTrainingç­‰
        // åŸºæœ¬æ€è·¯æ˜¯å°†localStorageæ“ä½œæ›¿æ¢ä¸ºå¯¹åº”çš„æ•°æ®åº“æ“ä½œ
        
        // ç¤ºä¾‹ï¼šä¿®æ”¹startTrainingå‡½æ•°
        async function startTraining() {
            if (appState.userWords.length === 0) {
                alert('è¯·å…ˆæ·»åŠ å•è¯ï¼Œç„¶åå¼€å§‹è®­ç»ƒ');
                return;
            }
            
            // å‡†å¤‡è®­ç»ƒå•è¯
            appState.trainingWords = [...appState.userWords];
            appState.trainingWords.sort(() => Math.random() - 0.5);
            appState.currentWordIndex = 0;
            appState.trainingMode = 'en_to_cn';
            appState.cardFlipped = false;
            
            // æ˜¾ç¤ºè®­ç»ƒç•Œé¢ï¼ˆè¿™é‡Œéœ€è¦ä½ åŸæœ‰çš„è®­ç»ƒç•Œé¢ï¼‰
            showScreen('train-screen');
            // æ˜¾ç¤ºå½“å‰å•è¯ï¼ˆè¿™é‡Œéœ€è¦ä½ åŸæœ‰çš„æ˜¾ç¤ºå‡½æ•°ï¼‰
            // showCurrentWord();
        }
        
        // ç¤ºä¾‹ï¼šä¿®æ”¹markWordå‡½æ•°
        async function markWord(status) {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const word = appState.trainingWords[appState.currentWordIndex];
            
            // æ›´æ–°å•è¯çŠ¶æ€åˆ°æ•°æ®åº“
            const updates = {
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_review: new Date().toISOString()
            };
            
            const success = await updateWordForStudent(word.id, updates);
            
            if (success) {
                // ä¸‹ä¸€ä¸ªå•è¯
                appState.currentWordIndex++;
                appState.cardFlipped = false;
                
                // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºä¸‹ä¸€ä¸ªå•è¯
                setTimeout(() => {
                    // showCurrentWord();  // ä½ çš„æ˜¾ç¤ºå‡½æ•°
                }, 300);
            } else {
                alert('âŒ ä¿å­˜å­¦ä¹ è®°å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                appState.currentUser = null;
                appState.isTeacher = false;
                appState.userId = null;
                appState.userWords = [];
                localStorage.clear();
                document.getElementById('username').value = '';
                showLogin();
            }
        }
        
        // å¯¼å‡ºæ•°æ®ï¼ˆæ•™å¸ˆç”¨ï¼‰
        async function exportAllData() {
            if (!appState.isTeacher) {
                alert('åªæœ‰è€å¸ˆå¯ä»¥å¯¼å‡ºæ•°æ®');
                return;
            }
            
            try {
                // è·å–æ‰€æœ‰å­¦ç”Ÿ
                const students = await getAllStudentsFromDB();
                
                if (students.length === 0) {
                    alert('æ²¡æœ‰å­¦ç”Ÿæ•°æ®å¯ä»¥å¯¼å‡º');
                    return;
                }
                
                let exportData = [];
                
                for (const student of students) {
                    const stats = await getStudentWordStats(student.id);
                    
                    exportData.push({
                        å­¦ç”Ÿ: student.username,
                        æ³¨å†Œæ—¶é—´: new Date(student.created_at).toLocaleString('zh-CN'),
                        æœ€åç™»å½•: new Date(student.last_login).toLocaleString('zh-CN'),
                        å•è¯æ€»æ•°: stats.total,
                        å·²æŒæ¡: stats.remembered,
                        å­¦ä¹ ä¸­: stats.fuzzy,
                        éœ€å¤ä¹ : stats.forgot
                    });
                }
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                let csv = 'å­¦ç”Ÿ,æ³¨å†Œæ—¶é—´,æœ€åç™»å½•,å•è¯æ€»æ•°,å·²æŒæ¡,å­¦ä¹ ä¸­,éœ€å¤ä¹ \n';
                exportData.forEach(row => {
                    csv += `${row.å­¦ç”Ÿ},${row.æ³¨å†Œæ—¶é—´},${row.æœ€åç™»å½•},${row.å•è¯æ€»æ•°},${row.å·²æŒæ¡},${row.å­¦ä¹ ä¸­},${row.éœ€å¤ä¹ }\n`;
                });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kathyç­çº§æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`âœ… å·²å¯¼å‡º ${students.length} ä¸ªå­¦ç”Ÿçš„æ•°æ®`);
                
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®é”™è¯¯:', error);
                alert('âŒ å¯¼å‡ºæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
    </script>
</body>
</html>
