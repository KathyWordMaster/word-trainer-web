<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        
        input[type="text"], textarea, input[type="password"], select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°å•è¯æ¡† */
        .word-card { 
            background: white; 
            border: 4px solid #4CAF50; 
            border-radius: 20px; 
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px auto; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            max-width: 600px;
            padding: 20px;
            word-wrap: break-word;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .word-card-content {
            width: 100%;
            text-align: center;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´ */
        .font-size-xl { font-size: 2.8em; }
        .font-size-lg { font-size: 2.2em; }
        .font-size-md { font-size: 1.8em; }
        .font-size-sm { font-size: 1.5em; }
        .font-size-xs { font-size: 1.2em; }
        
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .message-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .message-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .message-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .message-info { background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB; }
        .message-warning { background: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; }
        
        .wechat-badge { background: #07C160; color: white; padding: 14px 28px; border-radius: 25px; display: inline-flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1em; margin: 15px 0; box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3); }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* å›ºå®šå¤´éƒ¨æ ·å¼ */
        .fixed-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            z-index: 1000; 
            padding: 15px 30px; 
            border-bottom: 2px solid #f0f0f0; 
        }
        
        .content-padding { padding-top: 100px; padding-bottom: 30px; }
        
        /* æ‰“å¡å¥–åŠ±ç›¸å…³æ ·å¼ */
        .checkin-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        .checkin-reward {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }
        
        .checkin-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .checkin-day {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px 5px;
            text-align: center;
            position: relative;
        }
        
        .checkin-day.checked {
            background: #4CAF50;
            color: white;
        }
        
        .checkin-day.today {
            border-color: #FF9800;
            animation: pulse-today 2s infinite;
        }
        
        .checkin-day.reward {
            background: #FFD700;
            color: #333;
            border-color: #FFA500;
        }
        
        @keyframes pulse-today {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 152, 0, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        
        .memorization-progress {
            background: #E3F2FD;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .ebbinghaus-chart {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
        }
        
        .memorization-timeline {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            position: relative;
        }
        
        .timeline-point {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
        }
        
        .timeline-point.active {
            background: #4CAF50;
            color: white;
        }
        
        .timeline-point.passed {
            background: #2196F3;
            color: white;
        }
        
        .timeline-point.future {
            background: #FF9800;
            color: white;
        }
        
        .timeline-line {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            height: 4px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* å­¦ä¹ æ¨¡å¼é€‰æ‹© */
        .learning-mode {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .mode-option {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .mode-option.selected {
            border-color: #4CAF50;
            background: #E8F5E9;
        }
        
        .mode-option.review {
            border-color: #2196F3;
        }
        
        .mode-option.extra {
            border-color: #FF9800;
        }
        
        .mode-option.mastered {
            border-color: #9C27B0;
        }
        
        .mode-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .batch-controls { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        
        @media (max-width: 768px) {
            .two-column { grid-template-columns: 1fr; }
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { 
                height: 220px; 
                max-width: 90%;
                margin: 20px auto;
                padding: 15px;
            }
            .font-size-xl { font-size: 2.2em; }
            .font-size-lg { font-size: 1.8em; }
            .font-size-md { font-size: 1.5em; }
            .font-size-sm { font-size: 1.3em; }
            .font-size-xs { font-size: 1.1em; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
            .card-grid { grid-template-columns: 1fr 1fr; }
            .content-padding { padding-top: 90px; }
            .fixed-header { padding: 12px 20px; }
            .checkin-grid { grid-template-columns: repeat(7, 1fr); gap: 5px; }
            .checkin-day { padding: 10px 3px; font-size: 0.9em; }
        }
        
        @media (max-width: 480px) {
            .word-card { 
                height: 200px; 
                padding: 10px;
            }
            .font-size-xl { font-size: 1.8em; }
            .font-size-lg { font-size: 1.5em; }
            .font-size-md { font-size: 1.3em; }
            .font-size-sm { font-size: 1.1em; }
            .font-size-xs { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">ğŸ‘­å’Œå•è¯åšæœ‹å‹ğŸ§¡</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">ğŸ§¡Kathyé™ªä½ ä¸€èµ·å’Œå•è¯ç©æ¸¸æˆğŸ§¡</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box message-info">
                            æ­£åœ¨è¿æ¥ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testDatabase()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ“± ä½¿ç”¨è¯´æ˜</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ‘©â€ğŸ«</div>
                                <div style="font-weight: bold; margin: 10px 0;">Kathyæ•™å¸ˆç«¯</div>
                                <div>å…³æ³¨å®ä»¬æ¯å¤©å•è¯è¿›åº¦</div>
                                <div>ä»Šå¤©ä½ å’Œå•è¯ç©æ¸¸æˆäº†ä¹ˆï¼Ÿ</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“</div>
                                <div style="font-weight: bold; margin: 10px 0;">å­¦ç”Ÿè´¦å·</div>
                                <div>Kathyå•ç‹¬å‘é€</div>
                                <div>åå­—é¦–å­—æ¯è¦å¤§å†™å“¦</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <div class="wechat-badge">
                                <span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            <p style="color: #555; margin-top: 15px;">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="teacher-stats" class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="continuous-checkins">0</div>
                                <div class="label">è¿ç»­æ‰“å¡</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="weekly-review">0</div>
                                <div class="label">ä»Šæ—¥å¤ä¹ </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-purple" onclick="showUploadWordsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“</div>
                                <div>ä¸Šä¼ å•è¯</div>
                            </button>
                            <button class="btn btn-blue" onclick="showGroupManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ‘¥</div>
                                <div>åˆ†ç»„ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showAllStudentsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“‹</div>
                                <div>æ‰€æœ‰å­¦ç”Ÿ</div>
                            </button>
                            <button class="btn btn-gold" onclick="showLearningProgressPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“Š</div>
                                <div>å­¦ä¹ è¿›åº¦</div>
                            </button>
                            <button class="btn" onclick="showWordManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>å•è¯ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showCheckinStatsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“…</div>
                                <div>æ‰“å¡ç»Ÿè®¡</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <!-- æ‰“å¡åŒºåŸŸ -->
                    <div id="checkin-section" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½æ‰“å¡ä¿¡æ¯ -->
                    </div>
                    
                    <!-- ä»Šæ—¥å­¦ä¹ æƒ…å†µ -->
                    <div id="today-status" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥æ•°æ® -->
                    </div>
                    
                    <!-- æˆ‘çš„å­¦ä¹ è¿›åº¦ -->
                    <div id="my-progress-summary" class="stats-card" style="margin-bottom: 30px;">
                        <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                        <!-- åŠ¨æ€åŠ è½½è¿›åº¦æ•°æ® -->
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button class="btn" onclick="showIntelligentTraining()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ¯</div>
                                <div>æ™ºèƒ½è®­ç»ƒ</div>
                            </button>
                            <button class="btn btn-blue" onclick="showMyAchievementsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ†</div>
                                <div>æˆ‘çš„æˆå°±</div>
                            </button>
                            <button class="btn" onclick="showMyWordListPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>æˆ‘çš„å•è¯æœ¬</div>
                            </button>
                            <button class="btn btn-orange" onclick="showEbbinghausReview()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“ˆ</div>
                                <div>è®°å¿†æ›²çº¿</div>
                            </button>
                            <button class="btn btn-gold" onclick="manualSyncWords()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ”„</div>
                                <div>ç«‹å³åŒæ­¥</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æœ¬å‘¨å­¦ä¹ è®¡åˆ’ -->
                    <div id="weekly-plan" class="stats-card">
                        <h3 style="color: #333; margin-bottom: 20px;">ğŸ“… æœ¬å‘¨å­¦ä¹ è®¡åˆ’</h3>
                        <div id="weekly-plan-content">
                            <!-- åŠ¨æ€åŠ è½½å‘¨è®¡åˆ’ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- æ™ºèƒ½è®­ç»ƒé€‰æ‹©é¡µé¢ -->
            <div id="intelligent-training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ æ™ºèƒ½è®­ç»ƒæ¨¡å¼</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <!-- æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿè¯´æ˜ -->
                        <div class="stats-card">
                            <h3 style="color: #333; margin-bottom: 15px;">ğŸ§  æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ</h3>
                            <div class="memorization-progress">
                                <h4>ğŸ“ˆ è®°å¿†æ›²çº¿ç®—æ³•</h4>
                                <p style="color: #666; margin: 10px 0;">åŸºäºè‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ï¼Œæ™ºèƒ½å®‰æ’å¤ä¹ æ—¶é—´ï¼š</p>
                                <div class="memorization-timeline">
                                    <div class="timeline-line"></div>
                                    <div class="timeline-point active">å½“å¤©</div>
                                    <div class="timeline-point">1å¤©</div>
                                    <div class="timeline-point">2å¤©</div>
                                    <div class="timeline-point">4å¤©</div>
                                    <div class="timeline-point">7å¤©</div>
                                    <div class="timeline-point">15å¤©</div>
                                    <div class="timeline-point">30å¤©</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä»Šæ—¥ä»»åŠ¡çŠ¶æ€ -->
                        <div id="daily-task-status" class="stats-card">
                            <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥ä»»åŠ¡çŠ¶æ€</h3>
                            <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥ä»»åŠ¡çŠ¶æ€ -->
                        </div>
                        
                        <!-- è®­ç»ƒæ¨¡å¼é€‰æ‹© -->
                        <div class="learning-mode">
                            <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸš€ é€‰æ‹©è®­ç»ƒæ¨¡å¼</h3>
                            
                            <!-- æ ‡å‡†æ¨¡å¼ -->
                            <div class="mode-option" onclick="selectTrainingMode('standard')" id="mode-standard">
                                <div class="mode-icon">ğŸ“š</div>
                                <h4>æ ‡å‡†æ¨¡å¼</h4>
                                <p><strong>æ¯å¤©10ä¸ªæ–°å•è¯</strong></p>
                                <p>â€¢ æ ¹æ®è®°å¿†æ›²çº¿å®‰æ’å¤ä¹ </p>
                                <p>â€¢ è¿ç»­6å¤©å­¦ä¹ æ–°å•è¯</p>
                                <p>â€¢ ç¬¬7å¤©ä¸ºå¤ä¹ æ—¥</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="standard-progress" style="width: 0%"></div>
                                    </div>
                                    <p style="color: #666; font-size: 0.9em; text-align: center;" id="standard-status">å‡†å¤‡å¼€å§‹</p>
                                </div>
                                <button class="btn" onclick="startStandardTraining()" style="margin-top: 15px;">å¼€å§‹è®­ç»ƒ</button>
                            </div>
                            
                            <!-- å¤ä¹ æ¨¡å¼ -->
                            <div class="mode-option review" onclick="selectTrainingMode('review')" id="mode-review">
                                <div class="mode-icon">ğŸ”„</div>
                                <h4>å¤ä¹ æ¨¡å¼</h4>
                                <p><strong>å¤ä¹ ä»Šæ—¥ä»»åŠ¡</strong></p>
                                <p>â€¢ é‡ç‚¹å¤ä¹ ä»Šå¤©å­¦è¿‡çš„å•è¯</p>
                                <p>â€¢ å·©å›ºè®°å¿†æ•ˆæœ</p>
                                <p>â€¢ å¼ºåŒ–è–„å¼±ç¯èŠ‚</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="review-progress" style="width: 0%"></div>
                                    </div>
                                    <p style="color: #666; font-size: 0.9em; text-align: center;" id="review-status">å‡†å¤‡å¼€å§‹</p>
                                </div>
                                <button class="btn btn-blue" onclick="startReviewTraining()" style="margin-top: 15px;">å¼€å§‹å¤ä¹ </button>
                            </div>
                            
                            <!-- é¢å¤–æ–°è¯ -->
                            <div class="mode-option extra" onclick="selectTrainingMode('extra')" id="mode-extra">
                                <div class="mode-icon">âœ¨</div>
                                <h4>é¢å¤–æ–°è¯</h4>
                                <p><strong>å†å­¦10ä¸ªæ–°å•è¯</strong></p>
                                <p>â€¢ è¶…è¿‡æ¯æ—¥åŸºç¡€ä»»åŠ¡</p>
                                <p>â€¢ è‡ªä¸»é€‰æ‹©å­¦ä¹ å†…å®¹</p>
                                <p>â€¢ åŠ é€Ÿå­¦ä¹ è¿›åº¦</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="extra-progress" style="width: 0%"></div>
                                    </div>
                                    <p style="color: #666; font-size: 0.9em; text-align: center;" id="extra-status">å‡†å¤‡å¼€å§‹</p>
                                </div>
                                <button class="btn btn-orange" onclick="startExtraTraining()" style="margin-top: 15px;">å¼€å§‹å­¦ä¹ </button>
                            </div>
                            
                            <!-- å¼ºåŒ–å¤ä¹  -->
                            <div class="mode-option mastered" onclick="selectTrainingMode('intensive')" id="mode-intensive">
                                <div class="mode-icon">ğŸ’ª</div>
                                <h4>å¼ºåŒ–å¤ä¹ </h4>
                                <p><strong>é‡ç‚¹é’ˆå¯¹å­¦ä¹ ä¸­å•è¯</strong></p>
                                <p>â€¢ æœ€å¤šå¤ä¹ 8ä¸ªå­¦ä¹ ä¸­å•è¯</p>
                                <p>â€¢ æ™ºèƒ½é€‰æ‹©è–„å¼±ç¯èŠ‚</p>
                                <p>â€¢ æé«˜æŒæ¡ç‡</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="intensive-progress" style="width: 0%"></div>
                                    </div>
                                    <p style="color: #666; font-size: 0.9em; text-align: center;" id="intensive-status">å‡†å¤‡å¼€å§‹</p>
                                </div>
                                <button class="btn btn-purple" onclick="startIntensiveTraining()" style="margin-top: 15px;">å¼ºåŒ–å¤ä¹ </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®­ç»ƒé¡µé¢ -->
            <div id="training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666;">
                            è¿›åº¦: <span id="training-progress">0/0</span>
                            <span style="margin-left: 20px;">æ¨¡å¼: <span id="training-mode">æ ‡å‡†æ¨¡å¼</span></span>
                        </div>
                        <button class="btn btn-red" onclick="cancelTraining()" style="padding: 8px 16px;">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="training-content" style="max-width: 600px; margin: 0 auto;">
                        <!-- åŠ¨æ€åŠ è½½è®­ç»ƒå†…å®¹ -->
                    </div>
                </div>
            </div>
            
            <!-- è®°å¿†æ›²çº¿é¡µé¢ -->
            <div id="ebbinghaus-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ˆ è®°å¿†æ›²çº¿åˆ†æ</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="ebbinghaus-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿæˆå°±é¡µé¢ -->
            <div id="student-achievements-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ† æˆ‘çš„æˆå°±</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="achievements-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿå•è¯æœ¬é¡µé¢ -->
            <div id="student-wordlist-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– æˆ‘çš„å•è¯æœ¬</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="wordlist-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆæ‰“å¡ç»Ÿè®¡é¡µé¢ -->
            <div id="teacher-checkin-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“… å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-checkin-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ========== -->
            <!-- æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ ä¸Šä¼ å•è¯</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-upload-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ -->
            <div id="teacher-groups-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-groups-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ -->
            <div id="teacher-students-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-students-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ -->
            <div id="teacher-progress-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-progress-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ -->
            <div id="teacher-words-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– å•è¯ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-words-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

<script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null,
    checkinData: {
        streak: 0,
        lastCheckin: null,
        totalCheckins: 0,
        missedDays: 0,
        rewards: []
    },
    trainingMode: 'standard', // standard, review, extra, intensive
    weeklyPlan: {
        dayOfWeek: 0,
        isReviewDay: false,
        progress: 0
    }
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
}

function showAlert(message, type = 'info') {
    const alertBox = document.createElement('div');
    alertBox.className = `message-box message-${type}`;
    alertBox.style.position = 'fixed';
    alertBox.style.top = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.zIndex = '1000';
    alertBox.style.maxWidth = '500px';
    alertBox.textContent = message;
    
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
}

// ========== æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´ ==========
function getFontSizeClass(text) {
    const length = text.length;
    if (length <= 10) return 'font-size-xl';
    if (length <= 15) return 'font-size-lg';
    if (length <= 20) return 'font-size-md';
    if (length <= 25) return 'font-size-sm';
    return 'font-size-xs';
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { error } = await dbClient.from('users').select('count').limit(1);
        if (error) throw error;
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // æ–°ç”¨æˆ·æ³¨å†Œ
            const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            appState.currentUser = username;
            appState.isTeacher = isTeacherAccount;
            appState.userId = username;
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
            // å¦‚æœæ˜¯å­¦ç”Ÿï¼ŒåŒæ­¥æ•™å¸ˆå•è¯
            if (!isTeacherAccount) {
                await syncGroupWordsToStudent(username);
            }
            
        } else if (checkError) {
            throw checkError;
        } else {
            // è€ç”¨æˆ·ç™»å½•
            appState.currentUser = username;
            appState.isTeacher = existingUser.is_teacher;
            appState.userId = username;
            
            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            await dbClient
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // å¦‚æœæ˜¯æ•™å¸ˆï¼Œåˆå§‹åŒ–åˆ†ç»„ç³»ç»Ÿ
        if (appState.isTeacher) {
            await initializeTeacherGroups();
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', appState.isTeacher ? 'teacher' : 'student');
        
        // åŠ è½½ä»Šæ—¥è®­ç»ƒçŠ¶æ€å’Œæ‰“å¡æ•°æ®
        if (!appState.isTeacher) {
            await loadDailyTrainingState();
            await loadCheckinData();
            await loadWeeklyPlan();
        }
        
        // è·³è½¬åˆ°å¯¹åº”ç•Œé¢
        setTimeout(() => {
            if (appState.isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== æ‰“å¡ç³»ç»Ÿ ==========
async function loadCheckinData() {
    try {
        const username = appState.currentUser;
        const today = new Date().toDateString();
        
        // ä»localStorageåŠ è½½æ‰“å¡æ•°æ®
        const storedData = localStorage.getItem(`kathy_checkin_${username}`);
        if (storedData) {
            const data = JSON.parse(storedData);
            appState.checkinData = data;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®è¿ç»­æ‰“å¡
            if (data.lastCheckin) {
                const lastCheckinDate = new Date(data.lastCheckin);
                const todayDate = new Date();
                const diffDays = Math.floor((todayDate - lastCheckinDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 1) {
                    // è¶…è¿‡1å¤©æœªæ‰“å¡ï¼Œé‡ç½®è¿ç»­æ‰“å¡å¤©æ•°
                    appState.checkinData.streak = 0;
                    appState.checkinData.missedDays += diffDays - 1;
                    
                    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
                    saveCheckinData();
                }
            }
        }
        
        // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
        if (appState.checkinData.lastCheckin === today) {
            return true; // ä»Šæ—¥å·²æ‰“å¡
        }
        
        return false; // ä»Šæ—¥æœªæ‰“å¡
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡æ•°æ®é”™è¯¯:', error);
        return false;
    }
}

async function processCheckin() {
    try {
        const username = appState.currentUser;
        const today = new Date().toDateString();
        
        // æ£€æŸ¥æ˜¯å¦å·²æ‰“å¡
        if (appState.checkinData.lastCheckin === today) {
            showAlert('ä»Šæ—¥å·²ç»æ‰“å¡è¿‡äº†ï¼', 'info');
            return;
        }
        
        // æ›´æ–°æ‰“å¡æ•°æ®
        const lastCheckinDate = appState.checkinData.lastCheckin ? new Date(appState.checkinData.lastCheckin) : null;
        const todayDate = new Date();
        
        if (lastCheckinDate) {
            const diffDays = Math.floor((todayDate - lastCheckinDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                // è¿ç»­æ‰“å¡
                appState.checkinData.streak += 1;
            } else if (diffDays > 1) {
                // æ–­ç­¾
                appState.checkinData.streak = 1;
                appState.checkinData.missedDays += diffDays - 1;
            } else {
                // åŒä¸€å¤©
                appState.checkinData.streak = Math.max(appState.checkinData.streak, 1);
            }
        } else {
            // ç¬¬ä¸€æ¬¡æ‰“å¡
            appState.checkinData.streak = 1;
        }
        
        appState.checkinData.lastCheckin = today;
        appState.checkinData.totalCheckins += 1;
        
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°7å¤©è¿ç»­æ‰“å¡
        let rewardMessage = '';
        if (appState.checkinData.streak % 7 === 0) {
            const rewardCount = Math.floor(appState.checkinData.streak / 7);
            appState.checkinData.rewards.push({
                date: today,
                streak: appState.checkinData.streak,
                type: 'weekly'
            });
            
            rewardMessage = `ğŸ‰ æ­å–œï¼è¿ç»­æ‰“å¡${appState.checkinData.streak}å¤©ï¼Œè·å¾—ç¬¬${rewardCount}ä¸ªè¯­è¨€å­¦ä¹ å¥–åŠ±ï¼`;
            showAlert(rewardMessage, 'success');
        }
        
        // ä¿å­˜æ•°æ®
        saveCheckinData();
        
        // æ›´æ–°æ•°æ®åº“
        await dbClient
            .from('checkin_records')
            .insert([{
                student_id: username,
                checkin_date: today,
                streak: appState.checkinData.streak
            }]);
        
        // æ›´æ–°æ˜¾ç¤º
        updateCheckinDisplay();
        
        // æ˜¾ç¤ºæ‰“å¡æˆåŠŸæ¶ˆæ¯
        const message = `âœ… æ‰“å¡æˆåŠŸï¼\nè¿ç»­æ‰“å¡ï¼š${appState.checkinData.streak}å¤©\næ€»æ‰“å¡ï¼š${appState.checkinData.totalCheckins}æ¬¡${rewardMessage ? '\n' + rewardMessage : ''}`;
        showAlert(message, 'success');
        
        return true;
        
    } catch (error) {
        console.error('å¤„ç†æ‰“å¡é”™è¯¯:', error);
        showAlert('æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        return false;
    }
}

function saveCheckinData() {
    const username = appState.currentUser;
    localStorage.setItem(`kathy_checkin_${username}`, JSON.stringify(appState.checkinData));
}

function updateCheckinDisplay() {
    const checkinSection = document.getElementById('checkin-section');
    if (!checkinSection) return;
    
    const today = new Date();
    const todayStr = today.toDateString();
    const isCheckedToday = appState.checkinData.lastCheckin === todayStr;
    
    let checkinHTML = `
        <div class="stats-card">
            <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… æ‰“å¡ç³»ç»Ÿ</h3>
            <div class="checkin-grid">
    `;
    
    // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ‰“å¡æƒ…å†µ
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();
        const isToday = i === 0;
        const isChecked = appState.checkinData.lastCheckin === dateStr;
        const isRewardDay = appState.checkinData.streak > 0 && (appState.checkinData.streak + i - 6) % 7 === 0;
        
        let className = 'checkin-day';
        if (isToday) className += ' today';
        if (isChecked) className += ' checked';
        if (isRewardDay) className += ' reward';
        
        const dayName = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
        
        checkinHTML += `
            <div class="${className}">
                <div>${dayName}</div>
                <div>${date.getDate()}</div>
                ${isRewardDay ? '<div style="font-size: 12px; margin-top: 5px;">ğŸ</div>' : ''}
            </div>
        `;
    }
    
    checkinHTML += `
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${appState.checkinData.streak}</div>
                        <div class="label">è¿ç»­æ‰“å¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${appState.checkinData.totalCheckins}</div>
                        <div class="label">æ€»æ‰“å¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${appState.checkinData.missedDays}</div>
                        <div class="label">ç¼ºå¡å¤©æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${Math.floor(appState.checkinData.streak / 7)}</div>
                        <div class="label">è·å¾—å¥–åŠ±</div>
                    </div>
                </div>
    `;
    
    if (!isCheckedToday) {
        checkinHTML += `
                <button class="btn btn-gold" onclick="processCheckin()" style="margin-top: 20px;">
                    <span>âœ… ä»Šæ—¥æ‰“å¡</span>
                </button>
        `;
    } else {
        checkinHTML += `
                <div class="checkin-banner" style="margin-top: 20px;">
                    âœ… ä»Šæ—¥å·²æ‰“å¡ï¼ç»§ç»­åŠ æ²¹ï¼
                </div>
        `;
    }
    
    // æ˜¾ç¤ºå¥–åŠ±ä¿¡æ¯
    if (appState.checkinData.streak >= 7) {
        const nextRewardDay = 7 - (appState.checkinData.streak % 7);
        checkinHTML += `
                <div class="checkin-reward">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">ğŸ å¥–åŠ±ç³»ç»Ÿ</div>
                    <p>è¿ç»­æ‰“å¡${appState.checkinData.streak}å¤©</p>
                    <p>${nextRewardDay === 7 ? 'ğŸ‰ ä»Šå¤©è·å¾—å¥–åŠ±ï¼' : `è·ç¦»ä¸‹æ¬¡å¥–åŠ±è¿˜æœ‰${nextRewardDay}å¤©`}</p>
                </div>
        `;
    }
    
    checkinHTML += `
            </div>
        </div>
    `;
    
    checkinSection.innerHTML = checkinHTML;
}

// ========== æ¯å‘¨å­¦ä¹ è®¡åˆ’ ==========
async function loadWeeklyPlan() {
    try {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
        
        // è®¡ç®—æœ¬å‘¨çš„èµ·å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ä¸ºç¬¬ä¸€å¤©ï¼‰
        let startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        startOfWeek.setHours(0, 0, 0, 0);
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯å¤ä¹ æ—¥ï¼ˆè¿ç»­å­¦ä¹ 6å¤©åï¼Œç¬¬7å¤©ä¸ºå¤ä¹ æ—¥ï¼‰
        const lastTrainingDate = localStorage.getItem(`kathy_last_training_date_${appState.currentUser}`);
        
        if (lastTrainingDate) {
            const lastDate = new Date(lastTrainingDate);
            const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
            
            // è·å–è¿ç»­å­¦ä¹ å¤©æ•°
            const trainingDays = parseInt(localStorage.getItem(`kathy_consecutive_days_${appState.currentUser}`)) || 0;
            
            if (diffDays === 0) {
                // ä»Šå¤©å·²ç»å­¦ä¹ è¿‡
                appState.weeklyPlan.progress = trainingDays % 7;
            } else if (diffDays === 1) {
                // æ˜¨å¤©å­¦ä¹ è¿‡ï¼Œè¿ç»­å¤©æ•°+1
                const newDays = (trainingDays + 1) % 7;
                localStorage.setItem(`kathy_consecutive_days_${appState.currentUser}`, newDays);
                appState.weeklyPlan.progress = newDays;
            } else if (diffDays > 1) {
                // ä¸­æ–­å­¦ä¹ ï¼Œé‡ç½®
                localStorage.setItem(`kathy_consecutive_days_${appState.currentUser}`, '0');
                appState.weeklyPlan.progress = 0;
            }
        }
        
        appState.weeklyPlan.dayOfWeek = dayOfWeek;
        appState.weeklyPlan.isReviewDay = (appState.weeklyPlan.progress % 7 === 6); // ç¬¬7å¤©æ˜¯å¤ä¹ æ—¥
        
        // ä¿å­˜è®¡åˆ’çŠ¶æ€
        localStorage.setItem(`kathy_weekly_plan_${appState.currentUser}`, JSON.stringify(appState.weeklyPlan));
        
    } catch (error) {
        console.error('åŠ è½½å‘¨è®¡åˆ’é”™è¯¯:', error);
    }
}

function updateWeeklyPlanDisplay() {
    const planDiv = document.getElementById('weekly-plan-content');
    if (!planDiv) return;
    
    const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
    const currentDay = appState.weeklyPlan.dayOfWeek;
    const adjustedDay = currentDay === 0 ? 6 : currentDay - 1; // è½¬æ¢ä¸ºå‘¨ä¸€ä¸ºç¬¬ä¸€å¤©
    
    let planHTML = '<div style="display: flex; justify-content: space-between; margin-bottom: 20px;">';
    
    for (let i = 0; i < 7; i++) {
        const dayName = days[i];
        const isToday = i === adjustedDay;
        const isCompleted = i < appState.weeklyPlan.progress;
        const isReviewDay = i === 6; // å‘¨æ—¥æ˜¯å¤ä¹ æ—¥
        
        let className = 'checkin-day';
        if (isToday) className += ' today';
        if (isCompleted) className += ' checked';
        if (isReviewDay) className += ' reward';
        
        planHTML += `
            <div class="${className}" style="flex: 1; margin: 0 5px;">
                <div style="font-size: 14px; margin-bottom: 5px;">${dayName}</div>
                ${isReviewDay ? '<div style="font-size: 12px;">ğŸ”„ å¤ä¹ </div>' : '<div style="font-size: 12px;">ğŸ“š å­¦ä¹ </div>'}
            </div>
        `;
    }
    
    planHTML += '</div>';
    
    // æ˜¾ç¤ºæœ¬å‘¨è®¡åˆ’è¯´æ˜
    if (appState.weeklyPlan.isReviewDay) {
        planHTML += `
            <div class="checkin-reward">
                <h4>ğŸ”„ ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼</h4>
                <p>è¿ç»­å­¦ä¹ 6å¤©åï¼Œä»Šå¤©æ˜¯å·©å›ºå¤ä¹ çš„æ—¥å­</p>
                <p>å¤ä¹ æ¯”ä¾‹ï¼šéœ€å­¦ä¹ (50%) + å­¦ä¹ ä¸­(30%) + å·²æŒæ¡(20%)</p>
                <p>é‡ç‚¹å¤ä¹ è–„å¼±ç¯èŠ‚ï¼Œå·©å›ºè®°å¿†</p>
            </div>
        `;
    } else {
        const daysLeft = 6 - appState.weeklyPlan.progress;
        planHTML += `
            <div style="text-align: center;">
                <p>æœ¬å‘¨å·²å­¦ä¹  ${appState.weeklyPlan.progress} å¤©ï¼Œè¿˜æœ‰ ${daysLeft} å¤©å­¦ä¹ æ–°å•è¯</p>
                <p>ç¬¬7å¤©æ˜¯å¤ä¹ æ—¥ï¼Œå°†æ ¹æ®è®°å¿†æ›²çº¿å®‰æ’å¤ä¹ </p>
            </div>
        `;
    }
    
    planDiv.innerHTML = planHTML;
}

// ========== è®°å¿†æ›²çº¿ç®—æ³• ==========
function calculateEbbinghausSchedule(lastReviewDate) {
    if (!lastReviewDate) return { nextReview: 0, schedule: [] };
    
    const now = new Date();
    const lastReview = new Date(lastReviewDate);
    const diffDays = Math.floor((now - lastReview) / (1000 * 60 * 60 * 24));
    
    // è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿é—´éš”ï¼š1, 2, 4, 7, 15, 30å¤©
    const intervals = [0, 1, 2, 4, 7, 15, 30];
    let nextReviewIndex = 0;
    
    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¤ä¹ ç‚¹
    for (let i = intervals.length - 1; i >= 0; i--) {
        if (diffDays >= intervals[i]) {
            nextReviewIndex = i + 1;
            break;
        }
    }
    
    // å¦‚æœå·²ç»è¶…è¿‡æ‰€æœ‰é—´éš”ï¼Œä¿æŒæœ€åä¸€æ¬¡å¤ä¹ 
    if (nextReviewIndex >= intervals.length) {
        nextReviewIndex = intervals.length - 1;
    }
    
    const schedule = intervals.map((days, index) => ({
        days,
        status: diffDays >= days ? 'passed' : 'future',
        isNext: index === nextReviewIndex
    }));
    
    return {
        nextReview: intervals[nextReviewIndex] || 0,
        nextReviewDays: intervals[nextReviewIndex] - diffDays,
        schedule
    };
}

function getEbbinghausReviewWords(words, count = 10) {
    const today = new Date();
    
    // ä¸ºæ¯ä¸ªå•è¯è®¡ç®—å¤ä¹ ä¼˜å…ˆçº§åˆ†æ•°
    const scoredWords = words.map(word => {
        const lastReview = word.last_reviewed ? new Date(word.last_reviewed) : null;
        let priorityScore = 0;
        
        if (!lastReview) {
            // ä»æœªå¤ä¹ è¿‡çš„æ–°å•è¯
            priorityScore = 100;
        } else {
            const diffDays = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
            const schedule = calculateEbbinghausSchedule(word.last_reviewed);
            
            // æ ¹æ®è®°å¿†æ›²çº¿è®¡ç®—ä¼˜å…ˆçº§
            if (diffDays >= schedule.nextReview) {
                // è¶…è¿‡å¤ä¹ æ—¶é—´ï¼Œä¼˜å…ˆçº§é«˜
                priorityScore = 90 - diffDays;
            } else if (word.status === 'new') {
                priorityScore = 80 - diffDays;
            } else if (word.status === 'learning') {
                priorityScore = 70 - diffDays;
            } else {
                priorityScore = 60 - diffDays;
            }
            
            // æ ¹æ®å¤ä¹ æ¬¡æ•°è°ƒæ•´
            priorityScore -= (word.review_count || 0) * 2;
            
            // æ ¹æ®æŒæ¡çŠ¶æ€è°ƒæ•´
            if (word.status === 'mastered') {
                priorityScore -= 20;
            } else if (word.status === 'learning') {
                priorityScore += 10;
            } else {
                priorityScore += 30;
            }
        }
        
        return { ...word, priorityScore };
    });
    
    // æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„å•è¯
    return scoredWords
        .sort((a, b) => b.priorityScore - a.priorityScore)
        .slice(0, count);
}

function showEbbinghausReview() {
    showScreen('ebbinghaus-screen');
    loadEbbinghausAnalysis();
}

async function loadEbbinghausAnalysis() {
    try {
        const content = document.getElementById('ebbinghaus-content');
        content.innerHTML = '<p style="text-align: center;">åŠ è½½è®°å¿†æ›²çº¿åˆ†æ...</p>';
        
        // è·å–ç”¨æˆ·çš„æ‰€æœ‰å•è¯
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        const totalWords = records.length;
        const newWords = records.filter(w => w.status === 'new').length;
        const learningWords = records.filter(w => w.status === 'learning').length;
        const masteredWords = records.filter(w => w.status === 'mastered').length;
        
        // åˆ†æå¤ä¹ æƒ…å†µ
        const today = new Date();
        const reviewStats = {
            overdue: 0, // è¶…æœŸæœªå¤ä¹ 
            dueToday: 0, // ä»Šå¤©éœ€è¦å¤ä¹ 
            dueSoon: 0, // è¿‘æœŸéœ€è¦å¤ä¹ 
            onSchedule: 0 // æŒ‰æ—¶å¤ä¹ 
        };
        
        const ebbinghausData = records.map(word => {
            const schedule = calculateEbbinghausSchedule(word.last_reviewed);
            const status = schedule.nextReviewDays;
            
            if (status < 0) reviewStats.overdue++;
            else if (status === 0) reviewStats.dueToday++;
            else if (status <= 2) reviewStats.dueSoon++;
            else reviewStats.onSchedule++;
            
            return {
                word: word.english,
                chinese: word.chinese,
                status: word.status,
                lastReview: word.last_reviewed,
                reviewCount: word.review_count || 0,
                schedule: schedule.schedule
            };
        });
        
        // ç”ŸæˆHTML
        let html = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ˆ è®°å¿†æ›²çº¿åˆ†æ</h3>
                
                <div class="stats-card">
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${totalWords}</div>
                            <div class="label">æ€»å•è¯æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${newWords}</div>
                            <div class="label">éœ€å­¦ä¹ </div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${learningWords}</div>
                            <div class="label">å­¦ä¹ ä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${masteredWords}</div>
                            <div class="label">å·²æŒæ¡</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card" style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ”„ å¤ä¹ çŠ¶æ€</h4>
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number" style="color: #F44336;">${reviewStats.overdue}</div>
                            <div class="label">è¶…æœŸæœªå¤ä¹ </div>
                        </div>
                        <div class="stat-card">
                            <div class="number" style="color: #FF9800;">${reviewStats.dueToday}</div>
                            <div class="label">ä»Šæ—¥éœ€å¤ä¹ </div>
                        </div>
                        <div class="stat-card">
                            <div class="number" style="color: #2196F3;">${reviewStats.dueSoon}</div>
                            <div class="label">è¿‘æœŸéœ€å¤ä¹ </div>
                        </div>
                        <div class="stat-card">
                            <div class="number" style="color: #4CAF50;">${reviewStats.onSchedule}</div>
                            <div class="label">æŒ‰æ—¶å¤ä¹ </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card" style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ“Š è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿</h4>
                    <div class="memorization-timeline">
                        <div class="timeline-line"></div>
        `;
        
        // æ˜¾ç¤ºè®°å¿†æ›²çº¿æ—¶é—´ç‚¹
        const intervals = [0, 1, 2, 4, 7, 15, 30];
        intervals.forEach((days, index) => {
            let className = 'timeline-point';
            if (days === 0) className += ' active';
            
            html += `
                <div class="${className}" style="position: relative;">
                    <div>${days}å¤©</div>
                    <div style="position: absolute; top: 35px; left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: 12px; color: #666;">
                        ${index === 0 ? 'å­¦ä¹ ' : 'å¤ä¹ '}
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                    <p style="color: #666; margin-top: 30px; text-align: center;">
                        æ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ï¼Œåœ¨å­¦ä¹ åçš„ç‰¹å®šæ—¶é—´ç‚¹å¤ä¹ ï¼Œè®°å¿†æ•ˆæœæœ€ä½³
                    </p>
                </div>
                
                <div class="stats-card" style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ æ™ºèƒ½å»ºè®®</h4>
                    <div style="padding: 15px; background: #E3F2FD; border-radius: 10px;">
        `;
        
        // ç”Ÿæˆæ™ºèƒ½å»ºè®®
        if (reviewStats.overdue > 10) {
            html += `<p>âš ï¸ æœ‰${reviewStats.overdue}ä¸ªå•è¯è¶…æœŸæœªå¤ä¹ ï¼Œå»ºè®®ä¼˜å…ˆå¤ä¹ è¿™äº›å•è¯</p>`;
        }
        if (reviewStats.dueToday > 0) {
            html += `<p>ğŸ“… ä»Šå¤©æœ‰${reviewStats.dueToday}ä¸ªå•è¯éœ€è¦å¤ä¹ </p>`;
        }
        if (newWords > 20) {
            html += `<p>ğŸ“š æœ‰${newWords}ä¸ªæ–°å•è¯å¾…å­¦ä¹ ï¼Œå»ºè®®æ¯å¤©å­¦ä¹ 10ä¸ª</p>`;
        }
        if (learningWords > 15) {
            html += `<p>ğŸ”„ æœ‰${learningWords}ä¸ªå•è¯æ­£åœ¨å­¦ä¹ ä¸­ï¼Œéœ€è¦é‡ç‚¹å¤ä¹ </p>`;
        }
        
        html += `
                        <p>ğŸ¯ æ¨èä½¿ç”¨"æ™ºèƒ½è®­ç»ƒ"æ¨¡å¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®è®°å¿†æ›²çº¿å®‰æ’å­¦ä¹ è®¡åˆ’</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-blue" onclick="startEbbinghausTraining()">å¼€å§‹æ™ºèƒ½å¤ä¹ </button>
                    <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
                </div>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½è®°å¿†æ›²çº¿åˆ†æé”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function startEbbinghausTraining() {
    try {
        // è·å–éœ€è¦å¤ä¹ çš„å•è¯ï¼ˆæ ¹æ®è®°å¿†æ›²çº¿ï¼‰
        const reviewWords = getEbbinghausReviewWords(appState.userWords, 15);
        
        if (reviewWords.length === 0) {
            showAlert('æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼', 'info');
            return;
        }
        
        appState.trainingWords = reviewWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        appState.trainingMode = 'ebbinghaus';
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼€å§‹è®°å¿†æ›²çº¿è®­ç»ƒé”™è¯¯:', error);
        showAlert('å¼€å§‹è®­ç»ƒå¤±è´¥', 'error');
    }
}

// ========== æ™ºèƒ½è®­ç»ƒç³»ç»Ÿ ==========
function showIntelligentTraining() {
    showScreen('intelligent-training-screen');
    loadIntelligentTrainingOptions();
}

async function loadIntelligentTrainingOptions() {
    try {
        const dailyStatus = document.getElementById('daily-task-status');
        const totalWords = appState.userWords.length;
        
        // æ£€æŸ¥ä»Šæ—¥ä»»åŠ¡å®Œæˆæƒ…å†µ
        const today = new Date().toDateString();
        const todayProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
        const dailyTarget = 10;
        
        let dailyStatusHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${todayProgress}</div>
                    <div class="label">ä»Šæ—¥å·²å­¦</div>
                </div>
                <div class="stat-card">
                    <div class="number">${dailyTarget}</div>
                    <div class="label">æ¯æ—¥ç›®æ ‡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${Math.max(0, dailyTarget - todayProgress)}</div>
                    <div class="label">è¿˜éœ€å­¦ä¹ </div>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${(todayProgress / dailyTarget) * 100}%"></div>
                </div>
            </div>
        `;
        
        if (todayProgress >= dailyTarget) {
            dailyStatusHTML += '<div class="checkin-banner">ğŸ‰ ä»Šæ—¥åŸºç¡€ä»»åŠ¡å·²å®Œæˆï¼å¯ä»¥é€‰æ‹©é¢å¤–å­¦ä¹ æˆ–å¤ä¹ </div>';
        } else if (todayProgress > 0) {
            dailyStatusHTML += `<p style="color: #4CAF50; text-align: center;">ğŸ’ª ç»§ç»­åŠ æ²¹ï¼è¿˜æœ‰${dailyTarget - todayProgress}ä¸ªå•è¯</p>`;
        }
        
        dailyStatus.innerHTML = dailyStatusHTML;
        
        // æ›´æ–°å„æ¨¡å¼çš„è¿›åº¦æ˜¾ç¤º
        updateModeProgress('standard', todayProgress, dailyTarget);
        updateModeProgress('review', todayProgress, dailyTarget);
        updateModeProgress('extra', todayProgress, dailyTarget);
        updateModeProgress('intensive', todayProgress, dailyTarget);
        
    } catch (error) {
        console.error('åŠ è½½æ™ºèƒ½è®­ç»ƒé€‰é¡¹é”™è¯¯:', error);
    }
}

function updateModeProgress(mode, todayProgress, dailyTarget) {
    const progressBar = document.getElementById(`${mode}-progress`);
    const statusText = document.getElementById(`${mode}-status`);
    
    if (!progressBar || !statusText) return;
    
    switch(mode) {
        case 'standard':
            if (todayProgress >= dailyTarget) {
                progressBar.style.width = '100%';
                statusText.textContent = 'âœ… ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆ';
            } else {
                const progress = (todayProgress / dailyTarget) * 100;
                progressBar.style.width = `${progress}%`;
                statusText.textContent = `å­¦ä¹ ä¸­ ${todayProgress}/${dailyTarget}`;
            }
            break;
            
        case 'review':
            // è®¡ç®—ä»Šå¤©å­¦è¿‡çš„å•è¯æ•°é‡
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayWords = appState.userWords.filter(w => 
                w.last_reviewed && new Date(w.last_reviewed) >= today
            ).length;
            
            if (todayWords === 0) {
                progressBar.style.width = '0%';
                statusText.textContent = 'ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ å•è¯';
            } else {
                progressBar.style.width = '50%';
                statusText.textContent = `ä»Šå¤©å­¦ä¹ äº†${todayWords}ä¸ªå•è¯`;
            }
            break;
            
        case 'extra':
            const extraProgress = Math.max(0, todayProgress - dailyTarget);
            if (extraProgress > 0) {
                progressBar.style.width = `${Math.min(extraProgress * 10, 100)}%`;
                statusText.textContent = `é¢å¤–å­¦ä¹ äº†${extraProgress}ä¸ªå•è¯`;
            } else {
                progressBar.style.width = '0%';
                statusText.textContent = 'å°šæœªå¼€å§‹é¢å¤–å­¦ä¹ ';
            }
            break;
            
        case 'intensive':
            const learningWords = appState.userWords.filter(w => w.status === 'learning').length;
            if (learningWords === 0) {
                progressBar.style.width = '0%';
                statusText.textContent = 'æ²¡æœ‰å­¦ä¹ ä¸­å•è¯';
            } else {
                const progress = Math.min((learningWords / 8) * 100, 100);
                progressBar.style.width = `${progress}%`;
                statusText.textContent = `${learningWords}ä¸ªå­¦ä¹ ä¸­å•è¯`;
            }
            break;
    }
}

function selectTrainingMode(mode) {
    // ç§»é™¤æ‰€æœ‰é€‰é¡¹çš„é€‰æ‹©çŠ¶æ€
    document.querySelectorAll('.mode-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // æ·»åŠ å½“å‰é€‰æ‹©çš„çŠ¶æ€
    const selectedOption = document.getElementById(`mode-${mode}`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
    
    appState.trainingMode = mode;
}

async function startStandardTraining() {
    try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¤ä¹ æ—¥
        if (appState.weeklyPlan.isReviewDay) {
            startReviewDayTraining();
            return;
        }
        
        // æ ‡å‡†æ¨¡å¼ï¼šæ¯å¤©10ä¸ªæ–°å•è¯
        const target = 10;
        const todayProgress = appState.dailyTrainingProgress || 0;
        
        // å¦‚æœä»Šæ—¥å·²å®ŒæˆåŸºç¡€è®­ç»ƒï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
        if (todayProgress >= target) {
            const continueTraining = confirm(`æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼æ˜¯å¦ç»§ç»­å­¦ä¹ æ›´å¤šå•è¯ï¼Ÿ`);
            if (!continueTraining) {
                showAlert('æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€è®­ç»ƒï¼Œå¾ˆæ£’ï¼', 'success');
                return;
            }
        }
        
        // æ™ºèƒ½é€‰æ‹©ä»Šæ—¥å•è¯ï¼ˆé‡ç‚¹ï¼šæ–°å•è¯ï¼‰
        const newWords = appState.userWords.filter(w => w.status === 'new');
        const learningWords = appState.userWords.filter(w => w.status === 'learning');
        
        let dailyWords = [];
        const wordsNeeded = Math.max(5, target - todayProgress);
        
        // ä¼˜å…ˆé€‰æ‹©æ–°å•è¯ï¼ˆ60%ï¼‰
        if (newWords.length > 0) {
            const newCount = Math.min(Math.ceil(wordsNeeded * 0.6), newWords.length);
            dailyWords = dailyWords.concat(newWords.slice(0, newCount));
        }
        
        // å…¶æ¬¡æ˜¯å­¦ä¹ ä¸­å•è¯ï¼ˆ40%ï¼‰
        if (learningWords.length > 0 && dailyWords.length < wordsNeeded) {
            const learningCount = wordsNeeded - dailyWords.length;
            dailyWords = dailyWords.concat(learningWords.slice(0, learningCount));
        }
        
        // å¦‚æœè¿˜ä¸å¤Ÿï¼Œä»æ‰€æœ‰å•è¯ä¸­éšæœºé€‰æ‹©
        if (dailyWords.length < wordsNeeded) {
            const allWords = [...appState.userWords];
            const remaining = wordsNeeded - dailyWords.length;
            const usedIds = new Set(dailyWords.map(w => w.id || w.word_id));
            
            for (let i = 0; i < allWords.length && dailyWords.length < wordsNeeded; i++) {
                const word = allWords[i];
                if (!usedIds.has(word.id || word.word_id)) {
                    dailyWords.push(word);
                }
            }
        }
        
        // é™åˆ¶å•è¯æ€»æ•°ä¸è¶…è¿‡100æ—¶çš„ç­–ç•¥
        if (appState.userWords.length > 100) {
            // å•è¯è¶…è¿‡100ä¸ªæ—¶ï¼Œå‡å°‘æ–°å•è¯å­¦ä¹ 
            dailyWords = dailyWords.slice(0, 8); // æœ€å¤š8ä¸ªå•è¯
        }
        
        if (dailyWords.length === 0) {
            showAlert('æ²¡æœ‰åˆé€‚çš„å•è¯å¯ä»¥å­¦ä¹ ï¼', 'info');
            return;
        }
        
        dailyWords.sort(() => Math.random() - 0.5);
        appState.trainingWords = dailyWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        appState.trainingMode = 'standard';
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼€å§‹æ ‡å‡†è®­ç»ƒé”™è¯¯:', error);
        showAlert('å¼€å§‹è®­ç»ƒå¤±è´¥', 'error');
    }
}

async function startReviewTraining() {
    try {
        // å¤ä¹ æ¨¡å¼ï¼šå¤ä¹ ä»Šæ—¥ä»»åŠ¡
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayWords = appState.userWords.filter(word => 
            word.last_reviewed && new Date(word.last_reviewed) >= today
        );
        
        if (todayWords.length === 0) {
            showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
            return;
        }
        
        // ä¼˜å…ˆå¤ä¹ ä»Šå¤©å­¦ä¹ ä¸­æˆ–æœªæŒæ¡çš„å•è¯
        const reviewWords = todayWords.sort((a, b) => {
            // æœªæŒæ¡ä¼˜å…ˆ
            if (a.status === 'new' && b.status !== 'new') return -1;
            if (a.status !== 'new' && b.status === 'new') return 1;
            if (a.status === 'learning' && b.status === 'mastered') return -1;
            if (a.status === 'mastered' && b.status === 'learning') return 1;
            
            // å¤ä¹ æ¬¡æ•°å°‘çš„ä¼˜å…ˆ
            return (a.review_count || 0) - (b.review_count || 0);
        }).slice(0, 10);
        
        if (reviewWords.length === 0) {
            showAlert('ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯', 'info');
            return;
        }
        
        reviewWords.sort(() => Math.random() - 0.5);
        appState.trainingWords = reviewWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        appState.trainingMode = 'review';
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼€å§‹å¤ä¹ è®­ç»ƒé”™è¯¯:', error);
        showAlert('å¼€å§‹å¤ä¹ å¤±è´¥', 'error');
    }
}

async function startExtraTraining() {
    try {
        // é¢å¤–æ–°è¯æ¨¡å¼ï¼šå†å­¦10ä¸ªæ–°å•è¯
        const target = 10;
        
        // æ™ºèƒ½é€‰æ‹©å•è¯ï¼ˆä¼˜å…ˆæ–°å•è¯ï¼Œå…¶æ¬¡æ˜¯å­¦ä¹ ä¸­å•è¯ï¼‰
        const newWords = appState.userWords.filter(w => w.status === 'new');
        const learningWords = appState.userWords.filter(w => w.status === 'learning');
        
        let extraWords = [];
        
        // ä¼˜å…ˆé€‰æ‹©æ–°å•è¯ï¼ˆ70%ï¼‰
        if (newWords.length > 0) {
            const newCount = Math.min(Math.ceil(target * 0.7), newWords.length);
            extraWords = extraWords.concat(newWords.slice(0, newCount));
        }
        
        // å…¶æ¬¡æ˜¯å­¦ä¹ ä¸­å•è¯ï¼ˆ30%ï¼‰
        if (learningWords.length > 0 && extraWords.length < target) {
            const learningCount = target - extraWords.length;
            extraWords = extraWords.concat(learningWords.slice(0, learningCount));
        }
        
        // å¦‚æœè¿˜ä¸å¤Ÿï¼Œä»æ‰€æœ‰å•è¯ä¸­éšæœºé€‰æ‹©
        if (extraWords.length < target) {
            const allWords = [...appState.userWords];
            const remaining = target - extraWords.length;
            const usedIds = new Set(extraWords.map(w => w.id || w.word_id));
            
            for (let i = 0; i < allWords.length && extraWords.length < target; i++) {
                const word = allWords[i];
                if (!usedIds.has(word.id || word.word_id)) {
                    extraWords.push(word);
                }
            }
        }
        
        if (extraWords.length === 0) {
            showAlert('æ²¡æœ‰åˆé€‚çš„å•è¯å¯ä»¥å­¦ä¹ ï¼', 'info');
            return;
        }
        
        extraWords.sort(() => Math.random() - 0.5);
        appState.trainingWords = extraWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        appState.trainingMode = 'extra';
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼€å§‹é¢å¤–è®­ç»ƒé”™è¯¯:', error);
        showAlert('å¼€å§‹é¢å¤–å­¦ä¹ å¤±è´¥', 'error');
    }
}

async function startIntensiveTraining() {
    try {
        // å¼ºåŒ–å¤ä¹ æ¨¡å¼ï¼šé‡ç‚¹é’ˆå¯¹å­¦ä¹ ä¸­å•è¯ï¼Œæœ€å¤š8ä¸ª
        const learningWords = appState.userWords.filter(w => w.status === 'learning');
        
        if (learningWords.length === 0) {
            showAlert('æ²¡æœ‰å­¦ä¹ ä¸­å•è¯ï¼', 'info');
            return;
        }
        
        // é€‰æ‹©æœ€éœ€è¦å¤ä¹ çš„å­¦ä¹ ä¸­å•è¯
        const intensiveWords = learningWords.sort((a, b) => {
            // å¤ä¹ æ¬¡æ•°å°‘çš„ä¼˜å…ˆ
            const aCount = a.review_count || 0;
            const bCount = b.review_count || 0;
            
            // æœ€è¿‘å¤ä¹ è¿‡çš„ä¼˜å…ˆ
            const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
            const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
            
            // ç»¼åˆè¯„åˆ†ï¼šå¤ä¹ æ¬¡æ•°å°‘ + æœ€è¿‘æ²¡å¤ä¹ è¿‡çš„ä¼˜å…ˆçº§é«˜
            const aScore = aCount - (new Date() - aDate) / (1000 * 60 * 60 * 24);
            const bScore = bCount - (new Date() - bDate) / (1000 * 60 * 60 * 24);
            
            return aScore - bScore;
        }).slice(0, 8); // æœ€å¤š8ä¸ªå•è¯
        
        intensiveWords.sort(() => Math.random() - 0.5);
        appState.trainingWords = intensiveWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        appState.trainingMode = 'intensive';
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼€å§‹å¼ºåŒ–å¤ä¹ é”™è¯¯:', error);
        showAlert('å¼€å§‹å¼ºåŒ–å¤ä¹ å¤±è´¥', 'error');
    }
}

async function startReviewDayTraining() {
    try {
        // å¤ä¹ æ—¥è®­ç»ƒï¼šæŒ‰æ¯”ä¾‹å¤ä¹ å•è¯
        const newWords = appState.userWords.filter(w => w.status === 'new');
        const learningWords = appState.userWords.filter(w => w.status === 'learning');
        const masteredWords = appState.userWords.filter(w => w.status === 'mastered');
        
        let reviewWords = [];
        const target = 15; // å¤ä¹ æ—¥å•è¯æ•°é‡
        
        // æŒ‰æ¯”ä¾‹é€‰æ‹©å•è¯ï¼šéœ€å­¦ä¹ 50% + å­¦ä¹ ä¸­30% + å·²æŒæ¡20%
        const newCount = Math.min(Math.ceil(target * 0.5), newWords.length);
        const learningCount = Math.min(Math.ceil(target * 0.3), learningWords.length);
        const masteredCount = Math.min(Math.ceil(target * 0.2), masteredWords.length);
        
        // é€‰æ‹©éœ€å­¦ä¹ å•è¯ï¼ˆé‡ç‚¹å¤ä¹ ï¼‰
        if (newWords.length > 0) {
            // ä¼˜å…ˆé€‰æ‹©æœ€è¿‘å­¦ä¹ è¿‡çš„éœ€å­¦ä¹ å•è¯
            const recentNewWords = newWords.sort((a, b) => {
                const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
                const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
                return bDate - aDate; // æœ€è¿‘å­¦ä¹ çš„ä¼˜å…ˆ
            }).slice(0, newCount);
            reviewWords = reviewWords.concat(recentNewWords);
        }
        
        // é€‰æ‹©å­¦ä¹ ä¸­å•è¯
        if (learningWords.length > 0 && reviewWords.length < target) {
            // é€‰æ‹©å¤ä¹ æ¬¡æ•°å°‘çš„å­¦ä¹ ä¸­å•è¯
            const learningReviewWords = learningWords.sort((a, b) => {
                return (a.review_count || 0) - (b.review_count || 0);
            }).slice(0, learningCount);
            reviewWords = reviewWords.concat(learningReviewWords);
        }
        
        // é€‰æ‹©å·²æŒæ¡å•è¯ï¼ˆéœ€è¦å·©å›ºè®°å¿†ï¼‰
        if (masteredWords.length > 0 && reviewWords.length < target) {
            // é€‰æ‹©å¾ˆä¹…æ²¡å¤ä¹ çš„å·²æŒæ¡å•è¯
            const masteredReviewWords = masteredWords.sort((a, b) => {
                const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
                const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
                return aDate - bDate; // å¾ˆä¹…æ²¡å¤ä¹ çš„ä¼˜å…ˆ
            }).slice(0, masteredCount);
            reviewWords = reviewWords.concat(masteredReviewWords);
        }
        
        // å¦‚æœè¿˜ä¸å¤Ÿï¼Œä»æ‰€æœ‰å•è¯ä¸­éšæœºé€‰æ‹©
        if (reviewWords.length < target) {
            const allWords = [...appState.userWords];
            const remaining = target - reviewWords.length;
            const usedIds = new Set(reviewWords.map(w => w.id || w.word_id));
            
            for (let i = 0; i < allWords.length && reviewWords.length < target; i++) {
                const word = allWords[i];
                if (!usedIds.has(word.id || word.word_id)) {
                    reviewWords.push(word);
                }
            }
        }
        
        if (reviewWords.length === 0) {
            showAlert('æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼', 'info');
            return;
        }
        
        reviewWords.sort(() => Math.random() - 0.5);
        appState.trainingWords = reviewWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        appState.trainingMode = 'review-day';
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼€å§‹å¤ä¹ æ—¥è®­ç»ƒé”™è¯¯:', error);
        showAlert('å¼€å§‹å¤ä¹ æ—¥è®­ç»ƒå¤±è´¥', 'error');
    }
}

// ========== è®­ç»ƒé¡µé¢åŠŸèƒ½ ==========
function startTrainingSession() {
    showScreen('training-screen');
    showTrainingScreen();
}

function showTrainingScreen() {
    if (appState.currentWordIndex >= appState.trainingWords.length) {
        finishTraining();
        return;
    }
    
    const word = appState.trainingWords[appState.currentWordIndex];
    const total = appState.trainingWords.length;
    const current = appState.currentWordIndex + 1;
    
    document.getElementById('training-progress').textContent = `${current}/${total}`;
    
    // è®¾ç½®è®­ç»ƒæ¨¡å¼æ˜¾ç¤º
    let modeText = '';
    switch(appState.trainingMode) {
        case 'standard': modeText = 'æ ‡å‡†æ¨¡å¼'; break;
        case 'review': modeText = 'å¤ä¹ æ¨¡å¼'; break;
        case 'extra': modeText = 'é¢å¤–å­¦ä¹ '; break;
        case 'intensive': modeText = 'å¼ºåŒ–å¤ä¹ '; break;
        case 'review-day': modeText = 'å¤ä¹ æ—¥'; break;
        case 'ebbinghaus': modeText = 'è®°å¿†æ›²çº¿'; break;
    }
    document.getElementById('training-mode').textContent = modeText;
    
    // æ™ºèƒ½è°ƒæ•´å­—ä½“å¤§å°
    const englishFontSize = getFontSizeClass(word.english);
    const chineseFontSize = getFontSizeClass(word.chinese);
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 14px;">
                æ¨¡å¼ï¼š${modeText} | å•è¯çŠ¶æ€ï¼š${getStatusText(word.status)}
            </div>
            
            <!-- å•è¯å¡ç‰‡ -->
            <div class="word-card ${appState.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
                <div class="word-card-content ${appState.isCardFlipped ? chineseFontSize : englishFontSize}">
                    ${appState.isCardFlipped ? `
                        <div style="color: #2E7D32; word-break: break-word;">
                            ${word.chinese}
                        </div>
                    ` : `
                        <div style="color: #333; word-break: break-word;">
                            ${word.english}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- çŠ¶æ€æŒ‰é’® -->
            <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn" onclick="markTrainingWord('mastered')" 
                        style="padding: 15px; background: #4CAF50;">
                    <div style="font-size: 20px; margin-bottom: 5px;">âœ…</div>
                    <div>å·²æŒæ¡</div>
                </button>
                
                <button class="btn btn-blue" onclick="markTrainingWord('learning')" 
                        style="padding: 15px; background: #2196F3;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ”„</div>
                    <div>å­¦ä¹ ä¸­</div>
                </button>
                
                <button class="btn" onclick="markTrainingWord('new')" 
                        style="padding: 15px; background: #FF9800;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ“</div>
                    <div>éœ€å­¦ä¹ </div>
                </button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn" onclick="skipTrainingWord()" 
                        style="flex: 1; padding: 12px; background: #9E9E9E;">
                    <div>â­ï¸ è·³è¿‡</div>
                </button>
                
                <button class="btn" onclick="saveTrainingProgress()" 
                        style="flex: 1; padding: 12px; background: #607D8B;">
                    <div>ğŸ’¾ ä¿å­˜è¿›åº¦</div>
                </button>
                
                <button class="btn" onclick="showStudentDashboard()" 
                        style="flex: 1; padding: 12px; background: #795548;">
                    <div>ğŸ“‹ è¿”å›</div>
                </button>
            </div>
            
            <div style="margin-top: 20px; color: #666; font-size: 14px;">
                <p>ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
                <p>é€‰æ‹©é€‚å½“çš„æŒæ¡ç¨‹åº¦</p>
            </div>
        </div>
    `;
}

function getStatusText(status) {
    switch(status) {
        case 'mastered': return 'å·²æŒæ¡';
        case 'learning': return 'å­¦ä¹ ä¸­';
        case 'new': return 'éœ€å­¦ä¹ ';
        default: return 'æœªçŸ¥';
    }
}

function flipTrainingCard() {
    const word = appState.trainingWords[appState.currentWordIndex];
    const card = document.querySelector('.word-card');
    const content = card.querySelector('.word-card-content');
    
    if (appState.isCardFlipped) {
        card.classList.remove('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.english);
        content.innerHTML = `
            <div style="color: #333; word-break: break-word;">
                ${word.english}
            </div>
        `;
    } else {
        card.classList.add('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.chinese);
        content.innerHTML = `
            <div style="color: #2E7D32; word-break: break-word;">
                ${word.chinese}
            </div>
        `;
    }
    
    appState.isCardFlipped = !appState.isCardFlipped;
}

async function markTrainingWord(status) {
    const word = appState.trainingWords[appState.currentWordIndex];
    
    try {
        // æ£€æŸ¥å·²æŒæ¡å•è¯çš„æ¯æ—¥å¤ä¹ é™åˆ¶
        if (word.status === 'mastered' && status === 'mastered') {
            const today = new Date().toDateString();
            const masteredToday = localStorage.getItem(`kathy_mastered_today_${appState.currentUser}_${word.word_id || word.id}`);
            
            if (masteredToday === today) {
                showAlert('å·²æŒæ¡å•è¯ä»Šå¤©å·²ç»å¤ä¹ è¿‡äº†ï¼Œæ˜å¤©å†æ¥å¤ä¹ å§ï¼', 'warning');
                return;
            }
            
            // è®°å½•ä»Šæ—¥å¤ä¹ 
            localStorage.setItem(`kathy_mastered_today_${appState.currentUser}_${word.word_id || word.id}`, today);
        }
        
        // æ›´æ–°æ•°æ®åº“è®°å½•
        const { error } = await dbClient
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', appState.currentUser)
            .eq('word_id', word.word_id || word.id);
        
        if (error) throw error;
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        
        // ç«‹å³æ›´æ–°å…¨å±€çŠ¶æ€
        const globalIndex = appState.userWords.findIndex(w => 
            w.word_id === word.word_id || w.id === word.id
        );
        if (globalIndex !== -1) {
            appState.userWords[globalIndex] = { ...appState.userWords[globalIndex], ...word };
        }
        
        // æ›´æ–°ä»Šæ—¥è®­ç»ƒè¿›åº¦å’Œè¿ç»­å­¦ä¹ å¤©æ•°
        updateTrainingProgress();
        
        // æ˜¾ç¤ºåé¦ˆ
        const statusText = {
            'mastered': 'âœ… å·²æŒæ¡',
            'learning': 'ğŸ”„ å­¦ä¹ ä¸­',
            'new': 'ğŸ“ éœ€å­¦ä¹ '
        }[status];
        
        showAlert(`${statusText}: ${word.english}`, 'success');
        
        // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
        setTimeout(() => {
            appState.currentWordIndex++;
            appState.isCardFlipped = false;
            
            if (appState.currentWordIndex < appState.trainingWords.length) {
                showTrainingScreen();
            } else {
                finishTraining();
            }
        }, 800);
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

function updateTrainingProgress() {
    // æ›´æ–°ä»Šæ—¥è®­ç»ƒè¿›åº¦
    const today = new Date().toDateString();
    const currentProgress = appState.dailyTrainingProgress + 1;
    appState.dailyTrainingProgress = currentProgress;
    
    localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
    localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, currentProgress.toString());
    
    // æ›´æ–°è¿ç»­å­¦ä¹ å¤©æ•°
    const lastTrainingDate = localStorage.getItem(`kathy_last_training_date_${appState.currentUser}`);
    const todayDate = new Date().toDateString();
    
    if (lastTrainingDate !== todayDate) {
        const consecutiveDays = parseInt(localStorage.getItem(`kathy_consecutive_days_${appState.currentUser}`)) || 0;
        localStorage.setItem(`kathy_consecutive_days_${appState.currentUser}`, (consecutiveDays + 1).toString());
        localStorage.setItem(`kathy_last_training_date_${appState.currentUser}`, todayDate);
    }
    
    // è‡ªåŠ¨æ‰“å¡
    if (appState.checkinData.lastCheckin !== todayDate) {
        processCheckin();
    }
}

function skipTrainingWord() {
    appState.currentWordIndex++;
    appState.isCardFlipped = false;
    
    if (appState.currentWordIndex < appState.trainingWords.length) {
        showTrainingScreen();
    } else {
        finishTraining();
    }
}

function saveTrainingProgress() {
    if (appState.trainingWords.length === 0) return;
    
    const progress = {
        date: new Date().toDateString(),
        index: appState.currentWordIndex,
        total: appState.trainingWords.length,
        mode: appState.trainingMode,
        words: appState.trainingWords.map(w => w.id || w.word_id)
    };
    
    localStorage.setItem(`kathy_training_${appState.currentUser}`, JSON.stringify(progress));
    showAlert('è®­ç»ƒè¿›åº¦å·²ä¿å­˜ï¼', 'success');
}

function finishTraining() {
    const total = appState.trainingWords.length;
    const mastered = appState.trainingWords.filter(w => w.status === 'mastered').length;
    const learning = appState.trainingWords.filter(w => w.status === 'learning').length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    // æ¸…é™¤è®­ç»ƒè¿›åº¦
    localStorage.removeItem(`kathy_training_${appState.currentUser}`);
    
    // æ›´æ–°å­¦ç”Ÿé¢æ¿æ•°æ®
    updateStudentDashboard();
    
    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‰</div>
            <h3 style="color: #333; margin-bottom: 15px;">è®­ç»ƒå®Œæˆï¼</h3>
            <div class="stats-card" style="max-width: 400px; margin: 0 auto;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">è®­ç»ƒå•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">å­¦ä¹ ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progress}%</div>
                        <div class="label">æŒæ¡ç‡</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn" onclick="showIntelligentTraining()" style="margin: 10px;">
                    ç»§ç»­è®­ç»ƒ
                </button>
                <button class="btn btn-red" onclick="showStudentDashboard()" style="margin: 10px;">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
}

function cancelTraining() {
    if (confirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„è®­ç»ƒè¿›åº¦å¯ä»¥ç¨åç»§ç»­ã€‚')) {
        saveTrainingProgress();
        showStudentDashboard();
    }
}

// ========== å­¦ç”Ÿé¢æ¿åŠŸèƒ½ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await updateStudentDashboard();
}

async function updateStudentDashboard() {
    try {
        // è®¾ç½®å­¦ç”Ÿå§“å
        document.getElementById('student-name').textContent = appState.currentUser;
        
        // è·å–å­¦ä¹ è®°å½•
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        appState.userWords = records || [];
        
        // æ›´æ–°æ‰“å¡æ˜¾ç¤º
        updateCheckinDisplay();
        
        // ä»Šæ—¥å­¦ä¹ æƒ…å†µ
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayRecords = records?.filter(r => 
            r.last_reviewed && new Date(r.last_reviewed) >= today
        ) || [];
        
        const target = 10; // æ¯æ—¥ç›®æ ‡å•è¯æ•°
        const todayProgress = Math.min(todayRecords.length, target);
        const progressPercent = (todayProgress / target) * 100;
        
        const todayStatus = document.getElementById('today-status');
        todayStatus.innerHTML = `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${todayRecords.length}</div>
                        <div class="label">ä»Šæ—¥å·²å­¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${Math.max(0, target - todayRecords.length)}</div>
                        <div class="label">å»ºè®®å­¦ä¹ </div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${todayRecords.filter(r => r.status === 'mastered').length}</div>
                        <div class="label">ä»Šæ—¥æŒæ¡</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayProgress}/${target}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                ${todayRecords.length >= target ? 
                    '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼å¯ä»¥é€‰æ‹©é¢å¤–å­¦ä¹ æˆ–å¤ä¹ </div>' : 
                    '<p style="color: #FF9800; text-align: center; margin-top: 15px;">ğŸ’ª ç»§ç»­åŠªåŠ›ï¼</p>'}
            </div>
        `;
        
        // å­¦ä¹ è¿›åº¦
        const total = records?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const learning = records?.filter(r => r.status === 'learning').length || 0;
        const review = records?.filter(r => r.status === 'new').length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        const progressSummary = document.getElementById('my-progress-summary');
        progressSummary.innerHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${total}</div>
                    <div class="label">å•è¯æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${mastered}</div>
                    <div class="label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${learning}</div>
                    <div class="label">å­¦ä¹ ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="number">${review}</div>
                    <div class="label">éœ€å­¦ä¹ </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
        `;
        
        // æ›´æ–°å‘¨è®¡åˆ’æ˜¾ç¤º
        updateWeeklyPlanDisplay();
        
    } catch (error) {
        console.error('æ›´æ–°å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// ========== æ•™å¸ˆæ‰“å¡ç»Ÿè®¡ ==========
function showCheckinStatsPage() {
    showScreen('teacher-checkin-screen');
    loadCheckinStats();
}

async function loadCheckinStats() {
    try {
        const content = document.getElementById('teacher-checkin-content');
        content.innerHTML = '<p style="text-align: center;">åŠ è½½æ‰“å¡ç»Ÿè®¡æ•°æ®...</p>';
        
        // è·å–æ‰€æœ‰å­¦ç”Ÿ
        const { data: students, error } = await dbClient
            .from('users')
            .select('username')
            .eq('is_teacher', false);
        
        if (error) throw error;
        
        if (!students || students.length === 0) {
            content.innerHTML = '<p style="text-align: center;">æ²¡æœ‰å­¦ç”Ÿæ•°æ®</p>';
            return;
        }
        
        let statsHTML = `
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“… å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿå§“å</th>
                            <th>è¿ç»­æ‰“å¡</th>
                            <th>æ€»æ‰“å¡æ¬¡æ•°</th>
                            <th>æœ¬æœˆç¼ºå¡</th>
                            <th>è·å¾—å¥–åŠ±</th>
                            <th>æœ€åæ‰“å¡</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        const today = new Date();
        const currentMonth = today.getMonth();
        
        for (const student of students) {
            // è·å–å­¦ç”Ÿçš„æ‰“å¡è®°å½•
            const { data: checkins } = await dbClient
                .from('checkin_records')
                .select('*')
                .eq('student_id', student.username)
                .order('checkin_date', { ascending: false });
            
            const totalCheckins = checkins?.length || 0;
            
            // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
            let streak = 0;
            let lastCheckin = null;
            
            if (checkins && checkins.length > 0) {
                lastCheckin = checkins[0].checkin_date;
                
                // æ£€æŸ¥è¿ç»­æ‰“å¡
                let currentStreak = 0;
                let expectedDate = new Date();
                expectedDate.setHours(0, 0, 0, 0);
                
                for (const checkin of checkins) {
                    const checkinDate = new Date(checkin.checkin_date);
                    checkinDate.setHours(0, 0, 0, 0);
                    
                    if (checkinDate.getTime() === expectedDate.getTime()) {
                        currentStreak++;
                        expectedDate.setDate(expectedDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                
                streak = currentStreak;
            }
            
            // è®¡ç®—æœ¬æœˆç¼ºå¡å¤©æ•°
            let missedDays = 0;
            const monthStart = new Date(today.getFullYear(), currentMonth, 1);
            const monthEnd = new Date(today.getFullYear(), currentMonth + 1, 0);
            
            if (checkins) {
                const checkinDates = checkins.map(c => new Date(c.checkin_date).toDateString());
                
                // è®¡ç®—æœ¬æœˆåº”æœ‰æ‰“å¡å¤©æ•°
                const currentDate = new Date(monthStart);
                while (currentDate <= monthEnd) {
                    if (currentDate <= today) { // åªç»Ÿè®¡åˆ°ä»Šå¤©ä¸ºæ­¢
                        const dateStr = currentDate.toDateString();
                        if (!checkinDates.includes(dateStr)) {
                            missedDays++;
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            // è®¡ç®—è·å¾—å¥–åŠ±æ¬¡æ•°
            const rewardCount = checkins ? checkins.filter(c => c.streak % 7 === 0).length : 0;
            
            statsHTML += `
                <tr>
                    <td><strong>${student.username}</strong></td>
                    <td style="color: ${streak >= 7 ? '#4CAF50' : streak >= 3 ? '#2196F3' : '#666'};">
                        ${streak}å¤©
                        ${streak >= 7 ? 'ğŸ”¥' : streak >= 3 ? 'â­' : ''}
                    </td>
                    <td>${totalCheckins}</td>
                    <td style="color: ${missedDays === 0 ? '#4CAF50' : missedDays <= 3 ? '#FF9800' : '#F44336'}">
                        ${missedDays}å¤©
                    </td>
                    <td>${rewardCount}æ¬¡</td>
                    <td>${lastCheckin ? new Date(lastCheckin).toLocaleDateString('zh-CN') : 'ä»æœª'}</td>
                </tr>
            `;
        }
        
        statsHTML += `
                    </tbody>
                </table>
            </div>
            
            <div class="stats-card" style="margin-top: 30px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ“Š æ‰“å¡ç»Ÿè®¡æ¦‚è§ˆ</h4>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${students.length}</div>
                        <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="avg-streak">0</div>
                        <div class="label">å¹³å‡è¿ç»­æ‰“å¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="active-students-count">0</div>
                        <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="reward-students">0</div>
                        <div class="label">è·å¾—å¥–åŠ±</div>
                    </div>
                </div>
            </div>
        `;
        
        content.innerHTML = statsHTML;
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡ç»Ÿè®¡é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// ========== å…¶ä»–ç°æœ‰å‡½æ•°ï¼ˆéœ€è¦ä¿ç•™ï¼‰ ==========
// æ³¨æ„ï¼šä»¥ä¸‹å‡½æ•°æ˜¯åŸä»£ç ä¸­çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦ä¿ç•™
// ç”±äºä»£ç é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œåªåˆ—å‡ºå‡½æ•°åï¼Œå®é™…ä»£ç åº”è¯¥ä¿ç•™

async function loadDailyTrainingState() {
    // åŸæœ‰ä»£ç 
}

async function initializeTeacherGroups() {
    // åŸæœ‰ä»£ç 
}

async function syncGroupWordsToStudent(studentId) {
    // åŸæœ‰ä»£ç 
}

async function showTeacherDashboard() {
    // åŸæœ‰ä»£ç 
}

async function loadTeacherDashboard() {
    // åŸæœ‰ä»£ç 
}

function showUploadWordsPage() {
    // åŸæœ‰ä»£ç 
}

function showGroupManagementPage() {
    // åŸæœ‰ä»£ç 
}

function showAllStudentsPage() {
    // åŸæœ‰ä»£ç 
}

function showLearningProgressPage() {
    // åŸæœ‰ä»£ç 
}

function showWordManagementPage() {
    // åŸæœ‰ä»£ç 
}

async function manualSyncWords() {
    // åŸæœ‰ä»£ç 
}

function showMyAchievementsPage() {
    // åŸæœ‰ä»£ç 
}

async function loadStudentAchievements() {
    // åŸæœ‰ä»£ç 
}

function showMyWordListPage() {
    // åŸæœ‰ä»£ç 
}

async function loadStudentWordList() {
    // åŸæœ‰ä»£ç 
}

function handleLogout() {
    // åŸæœ‰ä»£ç 
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯è®­ç»ƒç³»ç»Ÿå¯åŠ¨ - æ™ºèƒ½ç‰ˆ');
    
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        appState.currentUser = savedUser;
        appState.isTeacher = (savedRole === 'teacher');
        appState.userId = savedUser;
        
        if (appState.isTeacher) {
            showTeacherDashboard();
        } else {
            // åŠ è½½å­¦ç”Ÿæ•°æ®
            await loadDailyTrainingState();
            await loadCheckinData();
            await loadWeeklyPlan();
            showStudentDashboard();
        }
    } else {
        testDatabase();
    }
    
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};
</script>
</body>
</html>
