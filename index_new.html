<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ Â· æœ€ç»ˆç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<style>
/* ========== åŸºç¡€æ ·å¼ï¼ˆåŒæ–°ç‰ˆï¼Œå·²å…¼å®¹ç§»åŠ¨ç«¯ï¼‰ ========== */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft YaHei','Segoe UI',Arial,sans-serif;}
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;line-height:1.6;color:#333;}
.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
.header{background:linear-gradient(135deg,#2C3E50 0%,#4A6491 100%);color:#fff;padding:30px;text-align:center;}
.header h1{font-size:2.5em;margin-bottom:10px;color:#F1C40F;}
.main-content{padding:30px;min-height:500px;}
.screen{display:none;animation:fadeIn .5s;}
.screen.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.btn{background:#4CAF50;color:#fff;border:none;padding:14px 28px;margin:10px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:bold;transition:all .3s;display:inline-flex;align-items:center;justify-content:center;gap:10px;}
.btn:hover{background:#45a049;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.1);}
.btn-blue{background:#2196F3}.btn-blue:hover{background:#1976D2}
.btn-red{background:#F44336}.btn-red:hover{background:#D32F2F}
.btn-purple{background:#9C27B0}.btn-purple:hover{background:#7B1FA2}
.btn-gold{background:#FFC107;color:#333}.btn-gold:hover{background:#FFA000}
input[type=text],textarea,input[type=password],select{width:100%;max-width:500px;padding:16px;margin:12px 0;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s;}
textarea{height:200px;font-family:'Courier New',monospace;resize:vertical;}
.word-card{background:#fff;border:4px solid #4CAF50;border-radius:20px;height:280px;display:flex;align-items:center;justify-content:center;margin:30px auto;cursor:pointer;font-weight:bold;transition:all .3s;max-width:600px;padding:20px;word-wrap:break-word;overflow:hidden;line-height:1.3;}
.word-card-content{width:100%;text-align:center;word-break:break-word;hyphens:auto;overflow-wrap:break-word;max-height:100%;display:flex;align-items:center;justify-content:center;padding:10px}
.font-size-xl{font-size:2.8em}.font-size-lg{font-size:2.2em}.font-size-md{font-size:1.8em}.font-size-sm{font-size:1.5em}.font-size-xs{font-size:1.2em}
.word-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}.word-card.flipped{background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-color:#2E7D32}
.stats-card{background:#f8f9fa;border-radius:15px;padding:25px;margin:20px 0;border-left:5px solid #4CAF50}
.data-table{width:100%;border-collapse:collapse;margin:20px 0;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.05)}.data-table th{background:#4CAF50;color:#fff;padding:15px;text-align:left;font-weight:600}.data-table td{padding:12px 15px;border-bottom:1px solid #eee}.data-table tr:hover{background:#f5f5f5}
.progress-container{width:100%;max-width:600px;margin:20px auto}.progress-bar{width:100%;height:12px;background:#e0e0e0;border-radius:6px;overflow:hidden;margin:10px 0}.progress-fill{height:100%;background:linear-gradient(90deg,#4CAF50,#8BC34A);width:0;transition:width .5s}
.message-box{padding:15px;border-radius:8px;margin:10px 0;text-align:center;border:1px solid transparent}
.message-success{background:#D4EDDA;color:#155724;border-color:#C3E6CB}.message-error{background:#F8D7DA;color:#721C24;border-color:#F5C6CB}.message-info{background:#D1ECF1;color:#0C5460;border-color:#BEE5EB}.message-warning{background:#FFF3CD;color:#856404;border-color:#FFEEBA}
.wechat-badge{background:#07C160;color:#fff;padding:14px 28px;border-radius:25px;display:inline-flex;align-items:center;gap:12px;font-weight:bold;font-size:1.1em;margin:15px 0;box-shadow:0 4px 15px rgba(7,193,96,.3)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}.stat-card{background:#fff;border-radius:10px;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.05);transition:transform .3s}.stat-card:hover{transform:translateY(-5px);box-shadow:0 5px 20px rgba(0,0,0,.1)}.stat-card .number{font-size:2.5em;font-weight:bold;margin:10px 0;color:#2C3E50}.stat-card .label{color:#666;font-size:.9em;text-transform:uppercase;letter-spacing:1px}
.two-column{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:40px}
.fixed-header{position:fixed;top:0;left:0;right:0;background:#fff;z-index:1000;padding:15px 30px;border-bottom:2px solid #f0f0f0;box-shadow:0 2px 10px rgba(0,0,0,.1)}.content-padding{padding-top:100px;padding-bottom:30px}
.celebration-banner{background:linear-gradient(135deg,#FFD700,#FFA500);color:#856404;padding:20px;border-radius:15px;text-align:center;margin:20px 0;animation:pulse 2s infinite;font-weight:bold}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.batch-controls{background:#f8f9fa;border-radius:10px;padding:15px;margin:20px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
@media(max-width:768px){.two-column{grid-template-columns:1fr}.container{margin:10px;border-radius:15px}.header{padding:20px}.header h1{font-size:1.8em}.word-card{height:220px;max-width:90%;margin:20px auto;padding:15px}.font-size-xl{font-size:2.2em}.font-size-lg{font-size:1.8em}.font-size-md{font-size:1.5em}.font-size-sm{font-size:1.3em}.font-size-xs{font-size:1.1em}.btn{padding:12px 20px;margin:8px;font-size:15px}.card-grid{grid-template-columns:repeat(2,1fr);gap:15px}.content-padding{padding-top:90px}.fixed-header{padding:12px 20px}}
@media(max-width:480px){.word-card{height:200px;padding:10px}.font-size-xl{font-size:1.8em}.font-size-lg{font-size:1.5em}.font-size-md{font-size:1.3em}.font-size-sm{font-size:1.1em}.font-size-xs{font-size:.9em}.card-grid{grid-template-columns:1fr}.batch-controls{flex-direction:column;align-items:stretch}.batch-controls .btn{width:100%;margin:5px 0}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="fas fa-bolt"></i> Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
    <h2 style="color:#fff">ğŸ‘­å’Œå•è¯åšæœ‹å‹ğŸ§¡</h2>
    <p style="color:#BDC3C7;font-size:.9em">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151</p>
  </div>

  <div class="main-content">
    <!-- ===== ç™»å½• ===== -->
    <div id="login-screen" class="screen active">
      <div class="text-center">
        <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
        <p style="color:#666;margin-bottom:30px">ğŸ§¡Kathyé™ªä½ ä¸€èµ·å’Œå•è¯ç©æ¸¸æˆğŸ§¡</p>
        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
        <div id="login-message" class="message-box message-info">æ­£åœ¨è¿æ¥ç³»ç»Ÿ...</div>
        <div style="margin:25px 0">
          <button class="btn" onclick="handleLogin()"><i class="fas fa-key"></i> ç™»å½•/æ³¨å†Œ</button>
          <button class="btn btn-blue" onclick="testDatabase()"><i class="fas fa-wrench"></i> æµ‹è¯•è¿æ¥</button>
        </div>
        <div class="stats-card">
          <h3 style="color:#2C3E50;margin-bottom:20px">ğŸ“± ä½¿ç”¨è¯´æ˜</h3>
          <div class="card-grid">
            <div class="stat-card"><div style="font-size:2em">ğŸ‘©â€ğŸ«</div><div style="font-weight:bold;margin:10px 0">Kathyæ•™å¸ˆç«¯</div><div>å…³æ³¨å®ä»¬æ¯å¤©å•è¯è¿›åº¦</div><div>ä»Šå¤©ä½ å’Œå•è¯ç©æ¸¸æˆäº†ä¹ˆï¼Ÿ</div></div>
            <div class="stat-card"><div style="font-size:2em">ğŸ“</div><div style="font-weight:bold;margin:10px 0">å­¦ç”Ÿè´¦å·</div><div>Kathyå•ç‹¬å‘é€</div><div>åå­—é¦–å­—æ¯è¦å¤§å†™å“¦</div></div>
          </div>
          <div class="mt-30">
            <div class="wechat-badge"><i class="fab fa-weixin"></i><span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span><strong>Kathy151</strong></div>
            <p style="color:#555;margin-top:15px">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== æ•™å¸ˆç«¯ ===== -->
    <div id="teacher-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-crown"></i> æ•™å¸ˆç®¡ç†é¢æ¿</h2>
          <button class="btn btn-red" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
        </div>
      </div>
      <div class="content-padding">
        <div id="teacher-stats" class="stats-card">
          <h3 style="color:#9C27B0;margin-bottom:20px"><i class="fas fa-chart-bar"></i> ç³»ç»Ÿæ¦‚è§ˆ</h3>
          <div class="card-grid">
            <div class="stat-card"><div class="number" id="total-words">0</div><div class="label">å•è¯æ€»æ•°</div></div>
            <div class="stat-card"><div class="number" id="total-students">0</div><div class="label">å­¦ç”Ÿæ€»æ•°</div></div>
            <div class="stat-card"><div class="number" id="mastered-words">0</div><div class="label">å·²æŒæ¡å•è¯</div></div>
            <div class="stat-card"><div class="number" id="active-students">0</div><div class="label">æ´»è·ƒå­¦ç”Ÿ</div></div>
          </div>
        </div>
        <div class="text-center mb-30">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px">
            <button class="btn btn-purple" onclick="showUploadWordsPage()" style="height:80px;font-size:18px"><i class="fas fa-upload"></i><div>ä¸Šä¼ å•è¯</div></button>
            <button class="btn btn-blue" onclick="showGroupManagementPage()" style="height:80px;font-size:18px"><i class="fas fa-users"></i><div>åˆ†ç»„ç®¡ç†</div></button>
            <button class="btn" onclick="showAllStudentsPage()" style="height:80px;font-size:18px"><i class="fas fa-list"></i><div>æ‰€æœ‰å­¦ç”Ÿ</div></button>
            <button class="btn btn-gold" onclick="showLearningProgressPage()" style="height:80px;font-size:18px"><i class="fas fa-chart-line"></i><div>å­¦ä¹ è¿›åº¦</div></button>
            <button class="btn" onclick="showWordManagementPage()" style="height:80px;font-size:18px"><i class="fas fa-book"></i><div>å•è¯ç®¡ç†</div></button>
            <button class="btn btn-orange" onclick="showAttendanceReport()" style="height:80px;font-size:18px"><i class="fas fa-calendar-check"></i><div>æ‰“å¡ç»Ÿè®¡</div></button>
          </div>
        </div>
        <div id="teacher-content"></div>
      </div>
    </div>

    <!-- ===== å­¦ç”Ÿç«¯ ===== -->
    <div id="student-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-graduation-cap"></i> æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
          <button class="btn btn-red" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
        </div>
      </div>
      <div class="content-padding">
        <div id="today-status" class="mb-30"></div>
        <div id="my-progress-summary" class="stats-card mb-30"></div>
        <div class="stats-card">
          <h3 class="text-center mb-20"><i class="fas fa-rocket"></i> å¿«é€Ÿå¼€å§‹</h3>
          <div class="grid grid-template-columns:repeat(2,1fr);gap-15">
            <button class="btn" onclick="showTrainingOptions()" style="height:80px;font-size:18px"><i class="fas fa-bullseye"></i><div>å¼€å§‹è®­ç»ƒ</div></button>
            <button class="btn btn-blue" onclick="showMyAchievementsPage()" style="height:80px;font-size:18px"><i class="fas fa-trophy"></i><div>æˆ‘çš„æˆå°±</div></button>
            <button class="btn" onclick="showMyWordListPage()" style="height:80px;font-size:18px"><i class="fas fa-book"></i><div>æˆ‘çš„å•è¯æœ¬</div></button>
            <button class="btn" onclick="startReviewTraining()" style="height:80px;font-size:18px"><i class="fas fa-redo"></i><div>å¤ä¹ å¼±é¡¹</div></button>
            <button class="btn" onclick="showTodayWordsPage()" style="height:80px;font-size:18px;grid-column:span 2"><i class="fas fa-calendar-day"></i><div>ä»Šæ—¥ä»»åŠ¡</div></button>
            <button class="btn btn-gold" onclick="manualSyncWords()" style="height:80px;font-size:18px;grid-column:span 2"><i class="fas fa-sync"></i><div>ç«‹å³åŒæ­¥</div></button>
          </div>
        </div>
        <div id="group-details" class="mb-30"></div>
      </div>
    </div>

    <!-- ===== å­¦ç”Ÿ-è®­ç»ƒé€‰æ‹© ===== -->
    <div id="training-options-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-bullseye"></i> é€‰æ‹©è®­ç»ƒæ¨¡å¼</h2>
          <button class="btn" onclick="showStudentDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding">
        <div style="max-width:600px;margin:0 auto">
          <div class="stats-card">
            <h3 class="text-center mb-30">é€‰æ‹©è®­ç»ƒå†…å®¹</h3>
            <div id="daily-training-options" class="mb-40"></div>
            <button class="btn" onclick="startAllWordsTraining()" style="width:100%;padding:25px;font-size:18px;margin-bottom:15px"><i class="fas fa-book" style="font-size:24px;margin-bottom:10px"></i><div style="font-weight:bold;margin-bottom:5px">æ‰€æœ‰å•è¯è®­ç»ƒ</div><div style="color:#666;font-size:14px">è®­ç»ƒæ‰€æœ‰å·²åŒæ­¥çš„å•è¯</div></button>
            <button class="btn btn-blue" onclick="startReviewTraining()" style="width:100%;padding:25px;font-size:18px"><i class="fas fa-redo" style="font-size:24px;margin-bottom:10px"></i><div style="font-weight:bold;margin-bottom:5px">å¤ä¹ å¼±é¡¹</div><div style="color:#666;font-size:14px">é‡ç‚¹å¤ä¹ æœªæŒæ¡å•è¯</div></button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== å­¦ç”Ÿ-è®­ç»ƒè¿›è¡Œä¸­ ===== -->
    <div id="training-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <div style="color:#666"><i class="fas fa-chart-line"></i> è¿›åº¦: <span id="training-progress">0/0</span></div>
          <button class="btn btn-red" onclick="cancelTraining()"><i class="fas fa-flag-checkered"></i> ç»“æŸè®­ç»ƒ</button>
        </div>
      </div>
      <div class="content-padding">
        <div id="training-content" style="max-width:600px;margin:0 auto"></div>
      </div>
    </div>

    <!-- ===== å­¦ç”Ÿ-æˆå°± ===== -->
    <div id="student-achievements-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-trophy"></i> æˆ‘çš„æˆå°±</h2>
          <button class="btn" onclick="showStudentDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="achievements-content"></div>
    </div>

    <!-- ===== å­¦ç”Ÿ-å•è¯æœ¬ ===== -->
    <div id="student-wordlist-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-book"></i> æˆ‘çš„å•è¯æœ¬</h2>
          <button class="btn" onclick="showStudentDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="wordlist-content"></div>
    </div>

    <!-- ===== å­¦ç”Ÿ-ä»Šæ—¥ä»»åŠ¡ ===== -->
    <div id="student-today-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-calendar-day"></i> ä»Šæ—¥ä»»åŠ¡</h2>
          <button class="btn" onclick="showStudentDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="today-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-ä¸Šä¼  ===== -->
    <div id="teacher-upload-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-upload"></i> ä¸Šä¼ å•è¯</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-upload-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-åˆ†ç»„ ===== -->
    <div id="teacher-groups-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-users"></i> åˆ†ç»„ç®¡ç†</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-groups-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-å­¦ç”Ÿåˆ—è¡¨ ===== -->
    <div id="teacher-students-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-list"></i> æ‰€æœ‰å­¦ç”Ÿ</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-students-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-è¿›åº¦ ===== -->
    <div id="teacher-progress-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-chart-line"></i> å­¦ä¹ è¿›åº¦</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-progress-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-å•è¯ç®¡ç† ===== -->
    <div id="teacher-words-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-book"></i> å•è¯ç®¡ç†</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-words-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-æ‰“å¡ç»Ÿè®¡ ===== -->
    <div id="teacher-attendance-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-calendar-check"></i> æ‰“å¡ç»Ÿè®¡</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-attendance-content"></div>
    </div>

    <!-- ===== æ•™å¸ˆ-åˆ†äº« ===== -->
    <div id="teacher-share-screen" class="screen">
      <div class="fixed-header">
        <div class="flex justify-between items-center">
          <h2 style="margin:0;color:#333"><i class="fas fa-share-alt"></i> åˆ†äº«ç³»ç»Ÿ</h2>
          <button class="btn" onclick="showTeacherDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
      </div>
      <div class="content-padding" id="teacher-share-content"></div>
    </div>
  </div>
</div>

<!-- ===== å…¨å±€æ¶ˆæ¯å®¹å™¨ ===== -->
<div id="global-message-container" style="position:fixed;top:20px;right:20px;z-index:9999;max-width:400px"></div>

<script>
/* ==================== æ•°æ®åº“é…ç½® ==================== */
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==================== çŠ¶æ€ ==================== */
const appState = {
  currentUser: null, isTeacher: false, userId: null, userWords: [], trainingWords: [],
  currentWordIndex: 0, isCardFlipped: false, teacherId: 'kathy151', selectedGroupId: null,
  selectedWords: [], dailyTrainingProgress: 0, lastTrainingDate: null, consecutiveDays: 0,
  monthlyMissedDays: 0, lastStudyDate: null, reviewDay: false, todayWordsToReview: [],
  attendanceStreak: 0, todayStudyCount: 0,
  dailyTarget: 10,
  reviewSettings: { mastered: { maxPerDay: 2, weight: 20 }, learning: { maxPerDay: 5, weight: 30 }, new: { maxPerDay: 10, weight: 50 } },
  memoryCurve: { intervals: [1, 2, 4, 7, 15, 30], retentionRates: [100, 90, 80, 70, 60, 50] }
};

/* ==================== å·¥å…·å‡½æ•° ==================== */
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0, 0); }
function showMessage(elId, msg, type = 'info') { const el = document.getElementById(elId); if (!el) return; el.textContent = msg; el.className = `message-box message-${type}`; el.style.display = 'block'; if (type === 'success' || type === 'error') setTimeout(() => el.style.display = 'none', 3000); }
function showGlobalMessage(msg, type = 'info', dur = 3000) {
  const box = document.createElement('div'); box.className = `message-box message-${type}`; box.style.marginBottom = '10px'; box.style.animation = 'fadeIn .5s'; box.innerHTML = `<div class="flex items-center gap-10"><i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':type==='warning'?'exclamation-triangle':'info-circle'}"></i><span>${msg}</span></div>`;
  document.getElementById('global-message-container').appendChild(box); setTimeout(() => { box.style.opacity = '0'; box.style.transition = 'opacity .5s'; setTimeout(() => box.remove(), 500); }, dur);
}
function getFontSizeClass(txt) { const len = txt?.length || 0; if (len <= 8) return 'font-size-xl'; if (len <= 12) return 'font-size-lg'; if (len <= 16) return 'font-size-md'; if (len <= 20) return 'font-size-sm'; return 'font-size-xs'; }

/* ==================== æ•°æ®åº“è¿æ¥æµ‹è¯• ==================== */
async function testDatabase() {
  showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
  const { error } = await db.from('users').select('count').limit(1);
  if (error) showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
  else showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
}

/* ==================== ç™»å½•/æ³¨å†Œ ==================== */
async function handleLogin() {
  const username = document.getElementById('username').value.trim(); if (!username) return showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
  showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
  try {
    const { data: exist, error: checkErr } = await db.from('users').select('*').eq('username', username).single();
    if (checkErr && checkErr.code !== 'PGRST116') throw checkErr;
    const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
    if (!exist) {
      const { error: createErr } = await db.from('users').insert([{ username, is_teacher: isTeacherAccount, teacher_id: appState.teacherId, last_login: new Date().toISOString() }]);
      if (createErr) throw createErr;
    } else {
      await db.from('users').update({ last_login: new Date().toISOString() }).eq('username', username);
    }
    appState.currentUser = username; appState.isTeacher = isTeacherAccount; appState.userId = username;
    localStorage.setItem('kathy_current_user', username); localStorage.setItem('kathy_user_role', isTeacherAccount ? 'teacher' : 'student');
    if (!isTeacherAccount) await syncGroupWordsToStudent(username);
    if (isTeacherAccount) await initializeTeacherGroups(); else await loadDailyTrainingState();
    setTimeout(() => isTeacherAccount ? showTeacherDashboard() : showStudentDashboard(), 800);
  } catch (e) { console.error(e); showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${e.message}`, 'error'); }
}
async function loadDailyTrainingState() {
  const today = new Date().toDateString(); const stored = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
  if (stored === today) appState.dailyTrainingProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0; else { appState.dailyTrainingProgress = 0; localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today); localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0'); }
}
function saveDailyTrainingProgress(n) { const today = new Date().toDateString(); appState.dailyTrainingProgress += n; localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today); localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, appState.dailyTrainingProgress); }

/* ==================== åˆå§‹åŒ–æ•™å¸ˆåˆ†ç»„ ==================== */
async function initializeTeacherGroups() {
  const { data: groups } = await db.from('groups').select('*').eq('teacher_id', appState.teacherId);
  if (!groups || groups.length === 0) {
    const { data: g } = await db.from('groups').insert([{ name: 'é»˜è®¤åˆ†ç»„', teacher_id: appState.teacherId }]).select().single();
    await db.from('words').update({ group_id: g.id }).eq('teacher_id', appState.teacherId);
  }
}

/* ==================== åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ ==================== */
async function syncGroupWordsToStudent(studentId) {
  try {
    const { data: sg } = await db.from('group_students').select('group_id').eq('student_id', studentId); if (!sg || sg.length === 0) { showGlobalMessage('æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„ï¼Œè¯·è”ç³»è€å¸ˆ', 'warning'); return 0; }
    const gIds = sg.map(x => x.group_id);
    const { data: words } = await db.from('words').select('*').in('group_id', gIds).eq('teacher_id', appState.teacherId); if (!words || words.length === 0) { showGlobalMessage('æ‚¨æ‰€åœ¨çš„åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯', 'info'); return 0; }
    const { data: exist } = await db.from('study_records').select('word_id').eq('student_id', studentId);
    const existIds = new Set(exist?.map(r => r.word_id) || []);
    const toAdd = words.filter(w => !existIds.has(w.id)).map(w => ({ student_id: studentId, word_id: w.id, english: w.english, chinese: w.chinese, status: 'new', review_count: 0, group_id: w.group_id, added_date: new Date().toISOString() }));
    if (toAdd.length === 0) { showGlobalMessage(`ğŸ“š å·²åŒæ­¥æ‰€æœ‰åˆ†ç»„å•è¯ï¼ˆå…±${words.length}ä¸ªï¼‰`, 'info'); return 0; }
    const batch = 50; for (let i = 0; i < toAdd.length; i += batch) { const { error } = await db.from('study_records').insert(toAdd.slice(i, i + batch)); if (error) console.warn('æ‰¹é‡æ’å…¥å­¦ä¹ è®°å½•å¤±è´¥', error); }
    showGlobalMessage(`âœ… å·²åŒæ­¥ ${toAdd.length} ä¸ªæ–°å•è¯`, 'success'); return toAdd.length;
  } catch (e) { console.error(e); showGlobalMessage(`åŒæ­¥å¤±è´¥ï¼š${e.message}`, 'error'); return 0; }
}

/* ==================== æ•™å¸ˆé¢æ¿ ==================== */
async function showTeacherDashboard() { showScreen('teacher-screen'); await loadTeacherDashboard(); }
async function loadTeacherDashboard() {
  const [{ data: w }, { data: s }, { data: r }] = await Promise.all([db.from('words').select('count').eq('teacher_id', appState.teacherId), db.from('users').select('count').eq('is_teacher', false), db.from('study_records').select('*')]);
  document.getElementById('total-words').textContent = w?.[0]?.count || 0; document.getElementById('total-students').textContent = s?.[0]?.count || 0; document.getElementById('mastered-words').textContent = r?.filter(x => x.status === 'mastered').length || 0;
  const seven = new Date(); seven.setDate(seven.getDate() - 7); const { data: a } = await db.from('study_records').select('student_id').gte('last_reviewed', seven.toISOString());
  document.getElementById('active-students').textContent = a ? new Set(a.map(x => x.student_id)).size : 0;
  document.getElementById('teacher-content').innerHTML = `
    <div class="text-center p-20">
      <h3 class="mb-20"><i class="fas fa-magic"></i> å¿«é€Ÿæ“ä½œ</h3>
      <div class="flex flex-wrap justify-center gap-10 mb-20">
        <button class="btn" onclick="showUploadWordsPage()"><i class="fas fa-upload"></i> å¿«é€Ÿä¸Šä¼ </button>
        <button class="btn btn-blue" onclick="quickStats()"><i class="fas fa-chart-bar"></i> ä»Šæ—¥æ•°æ®</button>
        <button class="btn" onclick="showStudentActivity()"><i class="fas fa-running"></i> å­¦ç”Ÿæ´»è·ƒ</button>
        <button class="btn btn-orange" onclick="showAttendanceReport()"><i class="fas fa-calendar-check"></i> æ‰“å¡ç»Ÿè®¡</button>
      </div>
      <div class="stats-card">
        <h4 class="mb-15"><i class="fas fa-lightbulb"></i> ç³»ç»Ÿæç¤º</h4>
        <p>â€¢ å·²ä¸Šä¼  <strong>${w?.[0]?.count || 0}</strong> ä¸ªå•è¯</p>
        <p>â€¢ å…±æœ‰ <strong>${s?.[0]?.count || 0}</strong> åå­¦ç”Ÿ</p>
        <p>â€¢ æœ€è¿‘7å¤© <strong>${a ? new Set(a.map(x => x.student_id)).size : 0}</strong> åæ´»è·ƒå­¦ç”Ÿ</p>
        <p>â€¢ å­¦ç”Ÿå…±æŒæ¡ <strong>${r?.filter(x => x.status === 'mastered').length || 0}</strong> ä¸ªå•è¯</p>
        <div class="mt-10 p-10" style="background:#fff;border-radius:8px">
          <p><i class="fas fa-check-circle" style="color:#4CAF50"></i> æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿå·²å¯ç”¨ï¼šå­¦ç”Ÿæ¯å¤©å­¦ä¹ 10ä¸ªæ–°å•è¯</p>
          <p><i class="fas fa-check-circle" style="color:#4CAF50"></i> æ‰“å¡ç³»ç»Ÿå·²å¯ç”¨ï¼šè¿ç»­7å¤©å­¦ä¹ è·å¾—å¥–åŠ±</p>
          <p><i class="fas fa-check-circle" style="color:#4CAF50"></i> å¤ä¹ æ—¥ç³»ç»Ÿï¼šç¬¬7å¤©ä¸ºå¤ä¹ æ—¥ï¼Œä¸å­¦æ–°å•è¯</p>
        </div>
      </div>
    </div>
  `;
}

/* ==================== æ•™å¸ˆ-ä¸Šä¼ å•è¯ ==================== */
function showUploadWordsPage() { showScreen('teacher-upload-screen'); loadUploadWordsPage(); }
function loadUploadWordsPage() {
  document.getElementById('teacher-upload-content').innerHTML = `
    <div style="max-width:800px;margin:0 auto">
      <h3 class="text-center mb-20"><i class="fas fa-upload"></i> ä¸Šä¼ å•è¯</h3>
      <div class="stats-card mb-20">
        <label class="block mb-10" style="font-weight:bold;color:#1565C0"><i class="fas fa-folder"></i> é€‰æ‹©åˆ†ç»„</label>
        <div id="group-select-container"><p>åŠ è½½åˆ†ç»„ä¸­...</p></div>
      </div>
      <div class="stats-card mb-25">
        <h4 class="mb-15" style="color:#2E7D32"><i class="fas fa-info-circle"></i> ä¸Šä¼ è¯´æ˜</h4>
        <div class="stats-card" style="background:#fff;margin-bottom:0">
          <p>â€¢ æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼š<strong>è‹±æ–‡ ä¸­æ–‡</strong></p>
          <p>â€¢ ç¤ºä¾‹ï¼š<code>hello ä½ å¥½</code></p>
          <p>â€¢ æ”¯æŒçŸ­è¯­ï¼š<code>"good morning" æ—©ä¸Šå¥½</code></p>
          <p>â€¢ ä¸€æ¬¡æœ€å¤š500ä¸ªå•è¯</p>
        </div>
      </div>
      <textarea id="words-input" placeholder="apple è‹¹æœ&#10;banana é¦™è•‰&#10;&quot;good morning&quot; æ—©ä¸Šå¥½&#10;computer ç”µè„‘" style="width:100%;height:300px;font-family:monospace;padding:15px;border:2px solid #ddd;border-radius:10px"></textarea>
      <div class="text-center mt-20 mb-25">
        <button class="btn btn-blue" onclick="previewUploadWordsStable()"><i class="fas fa-eye"></i> é¢„è§ˆ</button>
        <button class="btn" onclick="submitUploadWordsStable()"><i class="fas fa-upload"></i> ä¸Šä¼ </button>
        <button class="btn" onclick="loadExampleWordsStable()"><i class="fas fa-book"></i> ç¤ºä¾‹</button>
        <button class="btn btn-red" onclick="clearUploadForm()"><i class="fas fa-trash"></i> æ¸…ç©º</button>
      </div>
      <div id="upload-preview-stable" style="display:none"></div><div id="upload-result-stable"></div>
    </div>
  `; setTimeout(loadGroupSelectorStable, 100);
}
async function loadGroupSelectorStable() {
  const { data: groups } = await db.from('groups').select('*').eq('teacher_id', appState.teacherId).order('name');
  const cont = document.getElementById('group-select-container');
  if (!groups || groups.length === 0) { cont.innerHTML = `<p>æš‚æ— åˆ†ç»„</p><button class="btn" onclick="showGroupManagementPage()">å»åˆ›å»º</button>`; return; }
  appState.selectedGroupId = appState.selectedGroupId || groups[0].id;
  let html = `<select id="selected-group" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px">`;
  groups.forEach(g => html += `<option value="${g.id}" ${g.id === appState.selectedGroupId ? 'selected' : ''}>${g.name}</option>`); html += `</select>`;
  html += `<div class="mt-10 flex gap-10"><button class="btn" onclick="showGroupManagementPage()"><i class="fas fa-cog"></i> ç®¡ç†åˆ†ç»„</button><button class="btn" onclick="createNewGroupFromUpload()"><i class="fas fa-plus"></i> æ–°å»ºåˆ†ç»„</button></div>`;
  cont.innerHTML = html;
}
function createNewGroupFromUpload() { const name = prompt('æ–°åˆ†ç»„åç§°ï¼š'); if (name) createNewGroupDirectly(name); }
async function createNewGroupDirectly(name) {
  const { data } = await db.from('groups').insert([{ name, teacher_id: appState.teacherId }]).select().single();
  appState.selectedGroupId = data.id; loadGroupSelectorStable(); showGlobalMessage(`åˆ†ç»„ã€Œ${name}ã€åˆ›å»ºæˆåŠŸ`, 'success');
}
function previewUploadWordsStable() {
  const input = document.getElementById('words-input').value.trim(); if (!input) return showGlobalMessage('è¯·è¾“å…¥å•è¯', 'error');
  const lines = input.split('\n'); let valid = 0, dup = 0, seen = new Set(), html = '';
  lines.forEach(l => {
    const t = l.trim(); if (!t || t.startsWith('#')) return; const p = t.split(/\s+/); if (p.length < 2) return;
    const en = p.slice(0, -1).join(' '), cn = p[p.length - 1], key = en.toLowerCase();
    const isDup = seen.has(key); if (isDup) dup++; else seen.add(key);
    html += `<tr><td><strong>${en}</strong>${isDup ? '<span style="color:#F44336;margin-left:10px">(é‡å¤)</span>' : ''}</td><td>${cn}</td><td style="color:${isDup ? '#F44336' : '#4CAF50'}">${isDup ? 'âŒ é‡å¤' : 'âœ… æœ‰æ•ˆ'}</td></tr>`; valid++;
  });
  if (valid === 0) return showGlobalMessage('æœªæ‰¾åˆ°æœ‰æ•ˆå•è¯', 'error');
  const preview = document.getElementById('upload-preview-stable'); preview.innerHTML = `<h4>é¢„è§ˆï¼ˆ${valid} ä¸ªï¼Œ${dup} é‡å¤ï¼‰</h4><div style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:15px"><table class="w-100"><thead><tr style="background:#f5f5f5"><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>çŠ¶æ€</th></tr></thead><tbody>${html}</tbody></table></div>`; preview.style.display = 'block';
  showGlobalMessage(`æ‰¾åˆ° ${valid} ä¸ªæœ‰æ•ˆå•è¯${dup ? `ï¼ˆè·³è¿‡ ${dup} ä¸ªé‡å¤ï¼‰` : ''}`, dup ? 'warning' : 'success');
}
function clearUploadForm() { document.getElementById('words-input').value = ''; document.getElementById('upload-preview-stable').style.display = 'none'; document.getElementById('upload-result-stable').innerHTML = ''; }
function loadExampleWordsStable() { document.getElementById('words-input').value = `hello ä½ å¥½\nworld ä¸–ç•Œ\napple è‹¹æœ\n"good morning" æ—©ä¸Šå¥½\nteacher è€å¸ˆ\nstudent å­¦ç”Ÿ\ncomputer ç”µè„‘\nbook ä¹¦\nhomework ä½œä¸š\nexam è€ƒè¯•`; previewUploadWordsStable(); }
async function submitUploadWordsStable() {
  const input = document.getElementById('words-input').value.trim(); if (!input) return showGlobalMessage('è¯·è¾“å…¥å•è¯', 'error');
  const gid = document.getElementById('selected-group')?.value; if (!gid) return showGlobalMessage('è¯·é€‰æ‹©åˆ†ç»„', 'error');
  const lines = input.split('\n'); const raw = [];
  lines.forEach(l => { const t = l.trim(); if (!t || t.startsWith('#')) return; const p = t.split(/\s+/); if (p.length < 2) return; raw.push({ english: p.slice(0, -1).join(' '), chinese: p[p.length - 1] }); });
  if (raw.length === 0) return showGlobalMessage('æ²¡æœ‰æœ‰æ•ˆå•è¯', 'error');
  try {
    const { data: g } = await db.from('groups').select('name').eq('id', gid).single();
    const { data: exist } = await db.from('words').select('english').eq('group_id', gid).eq('teacher_id', appState.teacherId);
    const existSet = new Set(exist?.map(w => w.english.toLowerCase()) || []);
    const toAdd = [], dup = []; const seen = new Set();
    raw.forEach(w => {
      const key = w.english.toLowerCase();
      if (seen.has(key)) { dup.push(w.english); return; }
      seen.add(key);
      if (existSet.has(key)) { dup.push(w.english); return; }
      toAdd.push({ teacher_id: appState.teacherId, english: w.english, chinese: w.chinese, group_id: gid });
    });
    if (toAdd.length === 0) return showGlobalMessage(`æ‰€æœ‰ ${dup.length} ä¸ªå•è¯å·²å­˜åœ¨`, 'warning');
    const BATCH = 100; let uploaded = 0;
    for (let i = 0; i < toAdd.length; i += BATCH) {
      const { data: ins } = await db.from('words').insert(toAdd.slice(i, i + BATCH)).select('id, english, chinese');
      if (ins) uploaded += ins.length;
    }
    const { data: stus } = await db.from('group_students').select('student_id').eq('group_id', gid);
    if (stus && stus.length && uploaded) {
      const newRec = toAdd.map(w => stus.map(s => ({ student_id: s.student_id, word_id: w.id, english: w.english, chinese: w.chinese, status: 'new', review_count: 0, group_id: gid, added_date: new Date().toISOString() }))).flat();
      for (let i = 0; i < newRec.length; i += BATCH) await db.from('study_records').insert(newRec.slice(i, i + BATCH));
    }
    showGlobalMessage(`æˆåŠŸä¸Šä¼  ${uploaded} ä¸ªæ–°å•è¯åˆ°ã€Œ${g.name}ã€`, 'success');
    document.getElementById('words-input').value = ''; document.getElementById('upload-preview-stable').style.display = 'none';
    setTimeout(() => showTeacherDashboard(), 1500);
  } catch (e) { console.error(e); showGlobalMessage(`ä¸Šä¼ å¤±è´¥ï¼š${e.message}`, 'error'); }
}

/* ==================== åˆ†ç»„ç®¡ç† ==================== */
function showGroupManagementPage() { showScreen('teacher-groups-screen'); loadGroupManagementPage(); }
function loadGroupManagementPage() {
  document.getElementById('teacher-groups-content').innerHTML = `
    <div style="max-width:1200px;margin:0 auto">
      <h3 class="mb-30"><i class="fas fa-users"></i> åˆ†ç»„ç®¡ç†</h3>
      <div class="two-column">
        <div class="stats-card"><h4 class="mb-20"><i class="fas fa-folder"></i> æˆ‘çš„åˆ†ç»„</h4><div id="group-list"><p class="text-center">åŠ è½½ä¸­...</p></div>
          <div class="mt-30"><h4 class="mb-15"><i class="fas fa-plus"></i> åˆ›å»ºæ–°åˆ†ç»„</h4>
            <div class="flex gap-10"><input id="new-group-name" placeholder="è¾“å…¥åˆ†ç»„åç§°" style="flex:1;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px">
              <button class="btn" onclick="createNewGroup()">åˆ›å»º</button></div></div></div>
        <div class="stats-card"><h4 class="mb-20"><i class="fas fa-info-circle"></i> åˆ†ç»„è¯¦æƒ…</h4><div id="group-detail"><p class="text-center text-gray">é€‰æ‹©ä¸€ä¸ªåˆ†ç»„æŸ¥çœ‹è¯¦æƒ…</p></div></div>
      </div>
    </div>
  `; loadGroupList(); }
async function loadGroupList() {
  const { data: groups } = await db.from('groups').select(`*, words(count), group_students(count)`).eq('teacher_id', appState.teacherId).order('created_at', { ascending: false });
  const list = document.getElementById('group-list');
  if (!groups || groups.length === 0) { list.innerHTML = '<p class="text-center text-gray">æš‚æ— åˆ†ç»„</p>'; return; }
  let html = '<div class="flex flex-col gap-15">'; groups.forEach(g => {
    const wc = g.words?.[0]?.count || 0, sc = g.group_students?.[0]?.count || 0;
    html += `<div class="stats-card" style="cursor:pointer" onclick="showGroupDetail('${g.id}')">
      <div class="flex justify-between items-center mb-10"><h5 class="m-0" style="color:#333;font-size:1.2em">${g.name}</h5>
        <button class="btn btn-red" style="padding:6px 12px;font-size:14px" onclick="event.stopPropagation();deleteGroup('${g.id}','${g.name}')">åˆ é™¤</button></div>
      <div class="flex gap-20 text-sm text-gray-600"><div><i class="fas fa-book"></i> å•è¯ <strong>${wc}</strong></div><div><i class="fas fa-user"></i> å­¦ç”Ÿ <strong>${sc}</strong></div></div>
      <div class="text-xs text-gray-400 mt-10"><i class="fas fa-calendar"></i> åˆ›å»ºäº ${new Date(g.created_at).toLocaleDateString('zh-CN')}</div>
    </div>`; }); html += '</div>'; list.innerHTML = html;
}
async function createNewGroup() {
  const name = document.getElementById('new-group-name').value.trim(); if (!name) return showGlobalMessage('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error');
  await db.from('groups').insert([{ name, teacher_id: appState.teacherId }]);
  document.getElementById('new-group-name').value = ''; showGlobalMessage(`åˆ†ç»„ã€Œ${name}ã€åˆ›å»ºæˆåŠŸ`, 'success'); loadGroupList();
}
async function showGroupDetail(gid) {
  const [{ data: g }, { data: gstus }, { data: allstus }] = await Promise.all([db.from('groups').select('*').eq('id', gid).single(), db.from('group_students').select('student_id').eq('group_id', gid), db.from('users').select('username,created_at').eq('is_teacher', false).order('username')]);
  const inSet = new Set(gstus?.map(x => x.student_id) || []);
  const { data: gwords } = await db.from('words').select('*').eq('group_id', gid).order('created_at', { ascending: false }).limit(20);
  let html = `
    <div class="mb-20"><h4 class="mb-10" style="color:#333"><i class="fas fa-folder-open"></i> ${g.name}</h4><p class="text-sm text-gray-600">åˆ›å»ºäº ${new Date(g.created_at).toLocaleDateString('zh-CN')}</p></div>
    <div class="mb-30">
      <div class="flex justify-between items-center mb-15"><h5><i class="fas fa-user-friends"></i> å­¦ç”Ÿç®¡ç†</h5><button class="btn" onclick="addAllStudentsToGroup('${gid}')"><i class="fas fa-user-plus"></i> æ·»åŠ æ‰€æœ‰å­¦ç”Ÿ</button></div>
      <div class="overflow-x-auto"><table class="data-table"><thead><tr><th>å­¦ç”Ÿ</th><th>æ³¨å†Œæ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>
  `; allstus?.forEach(u => {
    const inGroup = inSet.has(u.username);
    html += `<tr><td><i class="fas fa-user"></i> ${u.username}</td><td>${new Date(u.created_at).toLocaleDateString('zh-CN')}</td>
      <td>${inGroup ? '<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> å·²åŠ å…¥</span>' : '<span class="text-orange-600"><i class="fas fa-times-circle"></i> æœªåŠ å…¥</span>'}</td>
      <td>${inGroup ? `<button class="btn btn-red" onclick="removeStudentFromGroup('${gid}','${u.username}')">ç§»é™¤</button>` : `<button class="btn" onclick="addStudentToGroup('${gid}','${u.username}')">æ·»åŠ </button>`}</td></tr>`;
  }); html += `</tbody></table></div><p class="text-sm text-gray-600 mt-10">å·²é€‰æ‹© ${inSet.size} åå­¦ç”Ÿ</p></div>
    <div class="mb-30"><h5 class="mb-15"><i class="fas fa-book"></i> åˆ†ç»„å•è¯ (${gwords?.length || 0}ä¸ª)</h5>
      ${gwords?.length ? `<div class="flex flex-wrap gap-10">${gwords.map(w => `<div class="stat-card" style="padding:8px 12px;margin:0"><b>${w.english}</b> - ${w.chinese}</div>`).join('')}</div>` : '<p class="text-center text-gray">æš‚æ— å•è¯</p>'}</div>
    <div class="text-center"><button class="btn btn-blue" onclick="uploadWordsToGroup('${gid}')"><i class="fas fa-upload"></i> ä¸Šä¼ å•è¯åˆ°è¿™ä¸ªåˆ†ç»„</button></div>
  `; document.getElementById('group-detail').innerHTML = html;
}
async function addStudentToGroup(gid, stu) { await db.from('group_students').insert([{ group_id: gid, student_id: stu }], { onConflict: 'group_id,student_id' }); showGlobalMessage(`å·²æ·»åŠ  ${stu}`, 'success'); await syncGroupWordsToStudent(stu); showGroupDetail(gid); }
async function removeStudentFromGroup(gid, stu) { await db.from('group_students').delete().eq('group_id', gid).eq('student_id', stu); showGlobalMessage(`å·²ç§»é™¤ ${stu}`, 'success'); showGroupDetail(gid); }
async function addAllStudentsToGroup(gid) {
  const { data: all } = await db.from('users').select('username').eq('is_teacher', false); if (!all || all.length === 0) return showGlobalMessage('æ²¡æœ‰å­¦ç”Ÿ', 'info');
  const bulk = all.map(u => ({ group_id: gid, student_id: u.username }));
  await db.from('group_students').insert(bulk, { onConflict: 'group_id,student_id' });
  showGlobalMessage(`å·²æ·»åŠ å…¨éƒ¨ ${all.length} åå­¦ç”Ÿ`, 'success');
  for (const u of all) await syncGroupWordsToStudent(u.username);
  showGroupDetail(gid);
}
async function deleteGroup(gid, name) {
  if (!await showConfirm(`ç¡®å®šåˆ é™¤åˆ†ç»„ã€Œ${name}ã€ï¼Ÿåˆ†ç»„å†…å•è¯ä¸ä¼šè¢«åˆ é™¤ï¼Œä½†ä¼šç§»å‡ºåˆ†ç»„ã€‚`, 'ç¡®å®šåˆ é™¤', 'å–æ¶ˆ')) return;
  await db.from('groups').delete().eq('id', gid); showGlobalMessage('å·²åˆ é™¤', 'success'); loadGroupList(); document.getElementById('group-detail').innerHTML = '<p class="text-center text-gray">è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç»„</p>';
}
function uploadWordsToGroup(gid) { appState.selectedGroupId = gid; showUploadWordsPage(); }

/* ==================== æ•™å¸ˆ-å­¦ç”Ÿåˆ—è¡¨ ==================== */
function showAllStudentsPage() { showScreen('teacher-students-screen'); loadAllStudentsPage(); }
async function loadAllStudentsPage() {
  const cont = document.getElementById('teacher-students-content'); cont.innerHTML = '<div class="loader"></div>';
  const { data: stus } = await db.from('users').select('*').eq('is_teacher', false).order('last_login', { ascending: false });
  if (!stus || stus.length === 0) { cont.innerHTML = '<div class="text-center p-40"><div style="font-size:3em;margin-bottom:20px;color:#666">ğŸ‘¥</div><h3 class="text-gray-600">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</h3><p class="text-gray-400">åˆ†äº«é“¾æ¥ç»™å­¦ç”Ÿæ³¨å†Œ</p></div>'; return; }
  let html = `<h3 class="mb-20"><i class="fas fa-list"></i> æ‰€æœ‰å­¦ç”Ÿï¼ˆå…± ${stus.length} äººï¼‰</h3><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>å­¦ç”Ÿ</th><th>æ³¨å†Œæ—¶é—´</th><th>æœ€åç™»å½•</th><th>å•è¯æ€»æ•°</th><th>å·²æŒæ¡</th><th>å­¦ä¹ ä¸­</th><th>éœ€å¤ä¹ </th><th>æ“ä½œ</th></tr></thead><tbody>`;
  for (const u of stus) {
    const { data: rec } = await db.from('study_records').select('*').eq('student_id', u.username);
    const total = rec?.length || 0, mastered = rec?.filter(x => x.status === 'mastered').length || 0, learning = rec?.filter(x => x.status === 'learning').length || 0, review = rec?.filter(x => x.status === 'new').length || 0;
    html += `<tr><td><strong><i class="fas fa-user"></i> ${u.username}</strong></td><td>${new Date(u.created_at).toLocaleDateString('zh-CN')}</td><td>${u.last_login ? new Date(u.last_login).toLocaleDateString('zh-CN') : 'ä»æœªç™»å½•'}</td><td>${total}</td><td style="color:#4CAF50">${mastered}</td><td style="color:#FF9800">${learning}</td><td style="color:#F44336">${review}</td><td><button class="btn" onclick="viewStudentDetail('${u.username}')"><i class="fas fa-eye"></i> è¯¦æƒ…</button><button class="btn btn-red ml-5" onclick="deleteStudent('${u.username}')"><i class="fas fa-trash"></i> åˆ é™¤</button></td></tr>`;
  } html += '</tbody></table></div>'; cont.innerHTML = html;
}
async function viewStudentDetail(stu) {
  const cont = document.getElementById('teacher-students-content'); cont.innerHTML = '<div class="loader"></div>';
  const [{ data: rec }, { data: user }] = await Promise.all([db.from('study_records').select('*').eq('student_id', stu).order('last_reviewed', { ascending: false }), db.from('users').select('*').eq('username', stu).single()]);
  const total = rec?.length || 0, mastered = rec?.filter(x => x.status === 'mastered').length || 0, learning = rec?.filter(x => x.status === 'learning').length || 0, review = rec?.filter(x => x.status === 'new').length || 0, prog = total ? Math.round(mastered / total * 100) : 0;
  let html = `
    <div style="max-width:1000px;margin:0 auto">
      <div class="flex justify-between items-center mb-30"><h3><i class="fas fa-user"></i> å­¦ç”Ÿï¼š${stu}</h3><button class="btn" onclick="showAllStudentsPage()"><i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨</button></div>
      <div class="stats-card">
        <div class="card-grid">
          <div class="stat-card"><div class="number">${total}</div><div class="label">å•è¯æ€»æ•°</div></div>
          <div class="stat-card"><div class="number">${mastered}</div><div class="label">å·²æŒæ¡</div></div>
          <div class="stat-card"><div class="number">${learning}</div><div class="label">å­¦ä¹ ä¸­</div></div>
          <div class="stat-card"><div class="number">${review}</div><div class="label">éœ€å¤ä¹ </div></div>
        </div>
        <div class="mt-20"><div class="flex justify-between mb-8"><span class="text-gray-600">æŒæ¡è¿›åº¦</span><span class="text-green-600 font-bold">${prog}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div></div>
      </div>
  `;
  if (rec && rec.length) {
    html += `<div class="stats-card mt-30"><h4 class="mb-15"><i class="fas fa-book"></i> è¯¦ç»†å­¦ä¹ è®°å½•</h4><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>çŠ¶æ€</th><th>å¤ä¹ æ¬¡æ•°</th><th>æœ€åå¤ä¹ </th></tr></thead><tbody>`;
    rec.forEach(r => {
      let stxt = '', scol = ''; switch (r.status) { case 'mastered': stxt = 'âœ… å·²æŒæ¡'; scol = '#4CAF50'; break; case 'learning': stxt = 'ğŸ”„ å­¦ä¹ ä¸­'; scol = '#FF9800'; break; default: stxt = 'ğŸ“ éœ€å­¦ä¹ '; scol = '#666'; }
      html += `<tr><td><strong>${r.english}</strong></td><td>${r.chinese}</td><td style="color:${scol}">${stxt}</td><td>${r.review_count || 0}</td><td>${r.last_reviewed ? new Date(r.last_reviewed).toLocaleDateString('zh-CN') : 'ä»æœª'}</td></tr>`;
    }); html += '</tbody></table></div></div>';
  }
  html += `</div>`; cont.innerHTML = html;
}
async function deleteStudent(stu) {
  if (stu === appState.currentUser) return showGlobalMessage('ä¸èƒ½åˆ é™¤å½“å‰ç”¨æˆ·', 'error');
  if (!await showConfirm(`ç¡®å®šåˆ é™¤å­¦ç”Ÿã€Œ${stu}ã€ï¼Ÿ\nâš ï¸ æ‰€æœ‰å­¦ä¹ è®°å½•ã€åˆ†ç»„å…³è”ç­‰å°†è¢«æ°¸ä¹…åˆ é™¤ï¼`, 'ç¡®å®šåˆ é™¤', 'å–æ¶ˆ')) return;
  await db.from('study_records').delete().eq('student_id', stu);
  await db.from('group_students').delete().eq('student_id', stu);
  await db.from('attendance_records').delete().eq('student_id', stu);
  await db.from('users').delete().eq('username', stu);
  showGlobalMessage('å·²åˆ é™¤', 'success'); loadAllStudentsPage();
}

/* ==================== æ•™å¸ˆ-å­¦ä¹ è¿›åº¦ ==================== */
function showLearningProgressPage() { showScreen('teacher-progress-screen'); loadLearningProgressPage(); }
async function loadLearningProgressPage() {
  const cont = document.getElementById('teacher-progress-content'); cont.innerHTML = '<div class="loader"></div>';
  const { data: stus } = await db.from('users').select('username').eq('is_teacher', false);
  if (!stus || stus.length === 0) { cont.innerHTML = '<p class="text-center">æ²¡æœ‰å­¦ç”Ÿæ•°æ®</p>'; return; }
  let allRec = []; for (const u of stus) { const { data: r } = await db.from('study_records').select('*').eq('student_id', u.username); if (r) allRec = allRec.concat(r); }
  const total = allRec.length, mastered = allRec.filter(x => x.status === 'mastered').length, learning = allRec.filter(x => x.status === 'learning').length, review = allRec.filter(x => x.status === 'new').length, prog = total ? Math.round(mastered / total * 100) : 0;
  const wordStats = {}; allRec.forEach(r => { if (!wordStats[r.english]) wordStats[r.english] = { total: 0, mastered: 0, chinese: r.chinese }; wordStats[r.english].total++; if (r.status === 'mastered') wordStats[r.english].mastered++; });
  const difficult = Object.entries(wordStats).map(([en, s]) => ({ en, cn: s.chinese, total: s.total, mastered: s.mastered, rate: s.total ? Math.round(s.mastered / s.total * 100) : 0 })).filter(w => w.total >= 3).sort((a, b) => a.rate - b.rate).slice(0, 10);
  let html = `
    <div style="max-width:1000px;margin:0 auto">
      <h3 class="mb-30"><i class="fas fa-chart-line"></i> ç­çº§å­¦ä¹ è¿›åº¦æ€»è§ˆ</h3>
      <div class="stats-card">
        <div class="card-grid">
          <div class="stat-card"><div class="number">${stus.length}</div><div class="label">å­¦ç”Ÿæ€»æ•°</div></div>
          <div class="stat-card"><div class="number">${total}</div><div class="label">æ€»å­¦ä¹ æ¬¡æ•°</div></div>
          <div class="stat-card"><div class="number">${mastered}</div><div class="label">å·²æŒæ¡æ€»æ•°</div></div>
          <div class="stat-card"><div class="number">${prog}%</div><div class="label">æ•´ä½“æŒæ¡ç‡</div></div>
        </div>
        <div class="mt-20"><div class="flex justify-between mb-8"><span class="text-gray-600">æŒæ¡è¿›åº¦</span><span class="text-green-600 font-bold">${prog}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div></div>
      </div>
      ${difficult.length ? `<div class="stats-card mt-30"><h4 class="mb-20"><i class="fas fa-exclamation-triangle"></i> éœ€è¦é‡ç‚¹å…³æ³¨çš„å•è¯</h4><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>å­¦ä¹ äººæ•°</th><th>æŒæ¡äººæ•°</th><th>æŒæ¡ç‡</th></tr></thead><tbody>
        ${difficult.map(w => `<tr><td><strong>${w.en}</strong></td><td>${w.cn}</td><td>${w.total}</td><td>${w.mastered}</td><td style="color:${w.rate < 50 ? '#F44336' : w.rate < 80 ? '#FF9800' : '#4CAF50'}">${w.rate}%</td></tr>`).join('')}
      </tbody></table></div></div>` : ''}
    </div>
  `; cont.innerHTML = html;
}

/* ==================== æ•™å¸ˆ-å•è¯ç®¡ç† ==================== */
function showWordManagementPage() { showScreen('teacher-words-screen'); loadWordManagementPage(); }
async function loadWordManagementPage() {
  const cont = document.getElementById('teacher-words-content'); cont.innerHTML = `
    <div style="max-width:1200px;margin:0 auto">
      <h3 class="mb-20"><i class="fas fa-book"></i> å•è¯ç®¡ç†</h3>
      <div class="batch-controls">
        <button class="btn" onclick="selectAllWords()"><i class="fas fa-check-square"></i> å…¨é€‰</button>
        <button class="btn" onclick="deselectAllWords()"><i class="fas fa-square"></i> å…¨ä¸é€‰</button>
        <button class="btn btn-red" onclick="batchDeleteWords()" id="batch-delete-btn" disabled><i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤ (0)</button>
        <button class="btn" onclick="deleteAllWordsInGroup()" id="group-delete-btn" disabled><i class="fas fa-trash-alt"></i> åˆ é™¤åˆ†ç»„æ‰€æœ‰å•è¯</button>
        <span class="ml-auto text-gray-600 font-bold" id="selected-count">å·²é€‰æ‹© 0 ä¸ªå•è¯</span>
      </div>
      <div id="word-management-content"><div class="loader"></div></div>
    </div>
  `; appState.selectedWords = []; setTimeout(loadWordManagementList, 100);
}
async function loadWordManagementList() {
  const [{ data: words }, { data: groups }] = await Promise.all([db.from('words').select('*').eq('teacher_id', appState.teacherId).order('created_at', { ascending: false }), db.from('groups').select('id,name').eq('teacher_id', appState.teacherId)]);
  const cont = document.getElementById('word-management-content');
  if (!words || words.length === 0) { cont.innerHTML = '<div class="text-center p-40"><div style="font-size:3em;margin-bottom:20px;color:#666">ğŸ“š</div><h3 class="text-gray-600">è¿˜æ²¡æœ‰å•è¯</h3><p class="text-gray-400">è¯·å…ˆä¸Šä¼ å•è¯</p></div>'; return; }
  const gMap = {}; groups?.forEach(g => gMap[g.id] = g.name);
  let html = `<div class="mb-20"><p class="text-gray-700 font-bold">å…± ${words.length} ä¸ªå•è¯</p></div><div class="overflow-x-auto"><table class="data-table"><thead><tr><th style="width:40px"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)"></th><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>åˆ†ç»„</th><th>ä¸Šä¼ æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>`;
  words.forEach(w => {
    const gname = w.group_id ? (gMap[w.group_id] || 'æœªçŸ¥åˆ†ç»„') : 'æœªåˆ†ç»„', selected = appState.selectedWords.includes(w.id);
    html += `<tr id="word-row-${w.id}" ${selected ? 'style="background-color:#e8f5e9"' : ''}>
      <td><input type="checkbox" class="word-checkbox" value="${w.id}" onchange="toggleWordSelection('${w.id}', this.checked)" ${selected ? 'checked' : ''}></td>
      <td><strong>${w.english}</strong></td><td>${w.chinese}</td><td>${gname}</td><td>${new Date(w.created_at).toLocaleDateString('zh-CN')}</td>
      <td><button class="btn" style="padding:6px 12px;font-size:14px" onclick="editWord('${w.id}','${w.english.replace(/'/g, "\\'")}','${w.chinese.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
        <button class="btn btn-red ml-5" style="padding:6px 12px;font-size:14px" onclick="deleteWord('${w.id}','${w.english.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i> åˆ é™¤</button></td>
    </tr>`;
  }); html += '</tbody></table></div>'; cont.innerHTML = html; updateSelectionCount(); if (groups && groups.length) document.getElementById('group-delete-btn').disabled = false;
}
function toggleWordSelection(wid, checked) {
  if (checked) { if (!appState.selectedWords.includes(wid)) appState.selectedWords.push(wid); } else { appState.selectedWords = appState.selectedWords.filter(id => id !== wid); } updateSelectionCount();
}
function selectAllWords() { document.querySelectorAll('.word-checkbox').forEach(cb => { cb.checked = true; toggleWordSelection(cb.value, true); }); }
function deselectAllWords() { document.querySelectorAll('.word-checkbox').forEach(cb => { cb.checked = false; }); appState.selectedWords = []; updateSelectionCount(); }
function toggleSelectAll(checked) { if (checked) selectAllWords(); else deselectAllWords(); }
function updateSelectionCount() {
  const count = appState.selectedWords.length; document.getElementById('selected-count').textContent = `å·²é€‰æ‹© ${count} ä¸ªå•è¯`;
  const btn = document.getElementById('batch-delete-btn'); btn.disabled = !count; btn.innerHTML = `<i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤ (${count})`;
  document.querySelectorAll('.word-checkbox').forEach(cb => { const row = document.getElementById(`word-row-${cb.value}`); if (row) row.style.backgroundColor = cb.checked ? '#e8f5e9' : ''; });
}
async function batchDeleteWords() {
  const count = appState.selectedWords.length; if (!count) return showGlobalMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å•è¯', 'error');
  if (!await showConfirm(`ç¡®å®šæ‰¹é‡åˆ é™¤ ${count} ä¸ªå•è¯ï¼Ÿ\nâš ï¸ æ‰€æœ‰å­¦ç”Ÿå­¦ä¹ è¿™äº›å•è¯çš„è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼`, 'ç¡®å®šåˆ é™¤', 'å–æ¶ˆ')) return;
  try {
    const { data: studyRec } = await db.from('study_records').select('word_id').in('word_id', appState.selectedWords);
    const studentCount = studyRec?.length || 0; if (studentCount && !await showConfirm(`âš ï¸ æœ‰ ${studentCount} æ¡å­¦ç”Ÿå­¦ä¹ è®°å½•å…³è”åˆ°è¿™äº›å•è¯ï¼\nç¡®å®šç»§ç»­ï¼Ÿ`, 'ç»§ç»­åˆ é™¤', 'å–æ¶ˆ')) return;
    const BATCH = 50; let deleted = 0;
    for (let i = 0; i < appState.selectedWords.length; i += BATCH) {
      const { error } = await db.from('words').delete().in('id', appState.selectedWords.slice(i, i + BATCH)).eq('teacher_id', appState.teacherId);
      if (!error) deleted += Math.min(BATCH, appState.selectedWords.length - i);
    }
    showGlobalMessage(`æˆåŠŸåˆ é™¤ ${deleted} ä¸ªå•è¯`, 'success'); appState.selectedWords = []; loadWordManagementList();
  } catch (e) { showGlobalMessage(`åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error'); }
}
async function deleteAllWordsInGroup() {
  const { data: groups } = await db.from('groups').select('id,name').eq('teacher_id', appState.teacherId); if (!groups || groups.length === 0) return showGlobalMessage('æ²¡æœ‰åˆ†ç»„', 'error');
  let opts = ''; groups.forEach(g => opts += `<option value="${g.id}">${g.name}</option>`);
  if (!await showConfirm(`åˆ é™¤åˆ†ç»„æ‰€æœ‰å•è¯ï¼Ÿ\n${opts}`, 'ç¡®å®šåˆ é™¤', 'å–æ¶ˆ')) return;
  const gid = document.getElementById('delete-group-select')?.value || groups[0].id; const gname = groups.find(g => g.id === gid).name;
  const { data: wds } = await db.from('words').select('id').eq('group_id', gid).eq('teacher_id', appState.teacherId); if (!wds || wds.length === 0) return showGlobalMessage('è¯¥åˆ†ç»„æ— å•è¯', 'info');
  const wids = wds.map(w => w.id);
  const { data: studyRec } = await db.from('study_records').select('word_id').in('word_id', wids);
  const stuCount = studyRec?.length || 0; if (stuCount && !await showConfirm(`âš ï¸ æœ‰ ${stuCount} æ¡å­¦ä¹ è®°å½•å…³è”ï¼\nç¡®å®šåˆ é™¤åˆ†ç»„ã€Œ${gname}ã€æ‰€æœ‰ ${wids.length} ä¸ªå•è¯ï¼Ÿ`, 'ç»§ç»­åˆ é™¤', 'å–æ¶ˆ')) return;
  await db.from('words').delete().in('id', wids).eq('teacher_id', appState.teacherId);
  showGlobalMessage(`å·²åˆ é™¤åˆ†ç»„ã€Œ${gname}ã€æ‰€æœ‰å•è¯`, 'success'); loadWordManagementList();
}
function editWord(wid, en, cn) {
  const newEn = prompt('ä¿®æ”¹è‹±æ–‡ï¼š', en); if (newEn === null) return;
  const newCn = prompt('ä¿®æ”¹ä¸­æ–‡ï¼š', cn); if (newCn === null) return;
  if (!newEn.trim() || !newCn.trim()) return showGlobalMessage('è‹±æ–‡å’Œä¸­æ–‡ä¸èƒ½ä¸ºç©º', 'error');
  updateWord(wid, newEn.trim(), newCn.trim());
}
async function updateWord(wid, en, cn) {
  await db.from('words').update({ english: en, chinese: cn }).eq('id', wid).eq('teacher_id', appState.teacherId);
  await db.from('study_records').update({ english: en, chinese: cn }).eq('word_id', wid);
  showGlobalMessage(`å•è¯ã€Œ${en}ã€å·²æ›´æ–°`, 'success'); loadWordManagementList();
}
async function deleteWord(wid, en) {
  if (!await showConfirm(`ç¡®å®šåˆ é™¤å•è¯ã€Œ${en}ã€ï¼Ÿ\nâš ï¸ æ‰€æœ‰å­¦ç”Ÿå­¦ä¹ è¯¥å•è¯çš„è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼`, 'ç¡®å®šåˆ é™¤', 'å–æ¶ˆ')) return;
  const { data: sr } = await db.from('study_records').select('student_id').eq('word_id', wid);
  const stuCount = sr?.length || 0; if (stuCount && !await showConfirm(`âš ï¸ æœ‰ ${stuCount} åå­¦ç”Ÿåœ¨å­¦ä¹ è¯¥å•è¯ï¼\nç¡®å®šç»§ç»­ï¼Ÿ`, 'ç»§ç»­åˆ é™¤', 'å–æ¶ˆ')) return;
  await db.from('words').delete().eq('id', wid).eq('teacher_id', appState.teacherId);
  showGlobalMessage(`å·²åˆ é™¤ã€Œ${en}ã€`, 'success'); loadWordManagementList();
}

/* ==================== æ•™å¸ˆ-æ‰“å¡ç»Ÿè®¡ ==================== */
function showAttendanceReport() { showScreen('teacher-attendance-screen'); loadAttendanceReport(); }
async function loadAttendanceReport() {
  const cont = document.getElementById('teacher-attendance-content'); cont.innerHTML = '<div class="loader"></div>';
  const [{ data: stus }, { data: todayRec }] = await Promise.all([db.from('users').select('username,consecutive_days,monthly_missed_days,last_study_date').eq('is_teacher', false), db.from('attendance_records').select('*').eq('study_date', new Date().toISOString().split('T')[0])]);
  if (!stus || stus.length === 0) { cont.innerHTML = '<p class="text-center">æ²¡æœ‰å­¦ç”Ÿæ•°æ®</p>'; return; }
  const todayMap = {}; todayRec?.forEach(r => todayMap[r.student_id] = r);
  let html = `
    <div style="max-width:1200px;margin:0 auto">
      <h3 class="mb-20"><i class="fas fa-calendar-check"></i> å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡</h3>
      <div class="flex gap-15 mb-30 overflow-x-auto flex-wrap">
        <button class="btn" onclick="loadDailyAttendance()"><i class="fas fa-calendar-day"></i> ä»Šæ—¥æ‰“å¡</button>
        <button class="btn btn-blue" onclick="loadWeeklyAttendance()"><i class="fas fa-calendar-week"></i> æœ¬å‘¨ç»Ÿè®¡</button>
        <button class="btn" onclick="loadMonthlyAttendance()"><i class="fas fa-calendar-alt"></i> æœ¬æœˆç»Ÿè®¡</button>
      </div>
      <div id="attendance-data">
        <div class="stats-card">
          <h4 class="mb-20"><i class="fas fa-chart-bar"></i> å­¦ç”Ÿæ‰“å¡æ¦‚è§ˆ</h4>
          <div class="overflow-x-auto"><table class="data-table"><thead><tr><th>å­¦ç”Ÿ</th><th>è¿ç»­å¤©æ•°</th><th>æœ¬æœˆç¼ºå¡</th><th>æœ€åå­¦ä¹ </th><th>ä»Šæ—¥çŠ¶æ€</th><th>æ€»å­¦ä¹ å¤©æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>
  `; for (const u of stus) {
    const { data: att } = await db.from('attendance_records').select('count').eq('student_id', u.username);
    const totalDays = att?.[0]?.count || 0; const todaySt = todayMap[u.username];
    html += `<tr>
      <td><strong><i class="fas fa-user"></i> ${u.username}</strong></td>
      <td>${u.consecutive_days || 0}å¤©</td><td>${u.monthly_missed_days || 0}å¤©</td>
      <td>${u.last_study_date ? new Date(u.last_study_date).toLocaleDateString('zh-CN') : 'ä»æœª'}</td>
      <td>${todaySt ? '<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> å·²æ‰“å¡</span>' : '<span class="text-red-600 font-bold"><i class="fas fa-times-circle"></i> æœªæ‰“å¡</span>'}</td>
      <td>${totalDays}å¤©</td>
      <td><button class="btn" onclick="viewStudentAttendanceDetail('${u.username}')"><i class="fas fa-eye"></i> è¯¦æƒ…</button></td>
    </tr>`;
  } html += `</tbody></table></div>
          <div class="stats-card mt-30" style="background:#E3F2FD"><h5 class="mb-10" style="color:#1565C0"><i class="fas fa-chart-line"></i> ç»Ÿè®¡æ•°æ®</h5><div class="card-grid">
            <div class="stat-card"><div class="number">${stus.length}</div><div class="label">å­¦ç”Ÿæ€»æ•°</div></div>
            <div class="stat-card"><div class="number">${Object.keys(todayMap).length}</div><div class="label">ä»Šæ—¥æ‰“å¡</div></div>
            <div class="stat-card"><div class="number">${stus.filter(s => s.consecutive_days >= 7).length}</div><div class="label">è¿ç»­7å¤©+</div></div>
            <div class="stat-card"><div class="number">${stus.reduce((a, s) => a + (s.monthly_missed_days || 0), 0)}</div><div class="label">æ€»ç¼ºå¡æ•°</div></div>
          </div></div>
        </div>
      </div>
    </div>
  `; cont.innerHTML = html;
}
async function loadDailyAttendance() {
  const today = new Date().toISOString().split('T')[0]; const { data: rec } = await db.from('attendance_records').select('*').eq('study_date', today).order('student_id');
  const cont = document.getElementById('attendance-data'); if (!rec || rec.length === 0) { cont.innerHTML = '<p class="text-center">ä»Šæ—¥è¿˜æ²¡æœ‰å­¦ç”Ÿæ‰“å¡</p>'; return; }
  let html = `<h4 class="mb-15"><i class="fas fa-calendar-day"></i> ä»Šæ—¥æ‰“å¡ (${rec.length}äºº)</h4><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>å­¦ç”Ÿ</th><th>æ€»å•è¯</th><th>æ–°å•è¯</th><th>å¤ä¹ å•è¯</th><th>çŠ¶æ€</th></tr></thead><tbody>`;
  rec.forEach(r => html += `<tr><td><strong><i class="fas fa-user"></i> ${r.student_id}</strong></td><td>${r.word_count}</td><td>${r.new_word_count}</td><td>${r.review_word_count}</td><td><span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> å·²å®Œæˆ</span></td></tr>`); html += '</tbody></table></div>'; cont.innerHTML = html;
}
async function loadWeeklyAttendance() {
  const start = new Date(); start.setDate(start.getDate() - 7); const { data: rec } = await db.from('attendance_records').select('*').gte('study_date', start.toISOString().split('T')[0]).order('student_id').order('study_date', { ascending: false });
  const cont = document.getElementById('attendance-data'); if (!rec || rec.length === 0) { cont.innerHTML = '<p class="text-center">æœ¬å‘¨æ²¡æœ‰æ‰“å¡æ•°æ®</p>'; return; }
  const stats = {}; rec.forEach(r => { if (!stats[r.student_id]) stats[r.student_id] = { totalDays: 0, totalWords: 0, totalNew: 0, totalReview: 0 }; stats[r.student_id].totalDays++; stats[r.student_id].totalWords += r.word_count; stats[r.student_id].totalNew += r.new_word_count; stats[r.student_id].totalReview += r.review_word_count; });
  let html = `<h4 class="mb-15"><i class="fas fa-calendar-week"></i> æœ¬å‘¨å­¦ä¹ ç»Ÿè®¡</h4><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>å­¦ç”Ÿ</th><th>æ‰“å¡å¤©æ•°</th><th>æ€»å•è¯</th><th>æ–°å•è¯</th><th>å¤ä¹ å•è¯</th><th>å¹³å‡æ¯æ—¥</th><th>è¿ç»­å¤©æ•°</th></tr></thead><tbody>`;
  for (const [stu, s] of Object.entries(stats)) {
    const avg = Math.round(s.totalWords / s.totalDays); const con = await getConsecutiveDays(stu);
    html += `<tr><td><strong><i class="fas fa-user"></i> ${stu}</strong></td><td>${s.totalDays}</td><td>${s.totalWords}</td><td>${s.totalNew}</td><td>${s.totalReview}</td><td>${avg}</td>
      <td>${con ? `<div class="streak-badge" style="padding:5px 10px;font-size:.9em"><i class="fas fa-fire"></i> ${con}å¤©</div>` : '0å¤©'}</td></tr>`;
  } html += '</tbody></table></div>'; cont.innerHTML = html;
}
async function getConsecutiveDays(stu) {
  const { data: att } = await db.from('attendance_records').select('study_date').eq('student_id', stu).order('study_date', { ascending: false }).limit(7);
  if (!att || att.length === 0) return 0;
  let c = 0; const today = new Date(); today.setHours(0, 0, 0, 0);
  for (let i = 0; i < 7; i++) {
    const d = new Date(today); d.setDate(d.getDate() - i); const ds = d.toISOString().split('T')[0];
    if (att.some(a => a.study_date === ds)) c++; else break;
  } return c;
}
async function viewStudentAttendanceDetail(stu) {
  const cont = document.getElementById('teacher-attendance-content');
  const [{ data: attRec }, { data: user }] = await Promise.all([db.from('attendance_records').select('*').eq('student_id', stu).order('study_date', { ascending: false }).limit(30), db.from('users').select('consecutive_days,monthly_missed_days').eq('username', stu).single()]);
  const totalDays = attRec?.length || 0; const con = user?.consecutive_days || 0; const missed = user?.monthly_missed_days || 0;
  let html = `
    <div style="max-width:1000px;margin:0 auto">
      <div class="flex justify-between items-center mb-30"><h3><i class="fas fa-user"></i> å­¦ç”Ÿæ‰“å¡è¯¦æƒ…ï¼š${stu}</h3><button class="btn" onclick="loadAttendanceReport()"><i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨</button></div>
      <div class="stats-card">
        <div class="card-grid">
          <div class="stat-card"><div class="number">${con}</div><div class="label">è¿ç»­æ‰“å¡å¤©æ•°</div></div>
          <div class="stat-card"><div class="number">${missed}</div><div class="label">æœ¬æœˆç¼ºå¡</div></div>
          <div class="stat-card"><div class="number">${totalDays}</div><div class="label">æ€»æ‰“å¡å¤©æ•°</div></div>
          <div class="stat-card"><div class="number">${con >= 7 ? 'ğŸ†' : 'ğŸƒ'}</div><div class="label">7å¤©å¥–åŠ±çŠ¶æ€</div></div>
        </div>
      </div>
  `;
  if (attRec && attRec.length) {
    html += `<div class="stats-card mt-30"><h4 class="mb-15"><i class="fas fa-calendar-alt"></i> æœ€è¿‘30å¤©æ‰“å¡æ—¥å†</h4><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>æ—¥æœŸ</th><th>æ€»å•è¯</th><th>æ–°å•è¯</th><th>å¤ä¹ å•è¯</th><th>çŠ¶æ€</th></tr></thead><tbody>`;
    const today = new Date();
    for (let i = 0; i < 30; i++) {
      const d = new Date(today); d.setDate(d.getDate() - i); const ds = d.toISOString().split('T')[0]; const r = attRec.find(a => a.study_date === ds);
      html += `<tr${r ? '' : ' style="background:#f9f9f9"'}><td>${d.toLocaleDateString('zh-CN')}</td><td>${r ? r.word_count : '-'}</td><td>${r ? r.new_word_count : '-'}</td><td>${r ? r.review_word_count : '-'}</td><td>${r ? '<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> å·²æ‰“å¡</span>' : '<span class="text-gray-500"><i class="fas fa-times-circle"></i> æœªæ‰“å¡</span>'}</td></tr>`;
    } html += '</tbody></table></div></div>';
  }
  html += `<div class="text-center mt-30"><button class="btn btn-blue" onclick="sendReminderToStudent('${stu}')"><i class="fas fa-bell"></i> å‘é€å­¦ä¹ æé†’</button></div></div>`; cont.innerHTML = html;
}
async function sendReminderToStudent(stu) {
  await db.from('teacher_notifications').insert([{ teacher_id: appState.teacherId, student_id: stu, message: `è€å¸ˆæé†’æ‚¨ï¼šè®°å¾—æ¯å¤©å­¦ä¹ 10ä¸ªæ–°å•è¯å“¦ï¼`, read: false, created_at: new Date().toISOString() }]);
  showGlobalMessage(`å·²å‘ ${stu} å‘é€å­¦ä¹ æé†’`, 'success');
}

/* ==================== æ•™å¸ˆ-åˆ†äº«ç³»ç»Ÿ ==================== */
function showShareSystemPage() { showScreen('teacher-share-screen'); loadShareSystemPage(); }
function loadShareSystemPage() {
  const url = window.location.href; document.getElementById('teacher-share-content').innerHTML = `
    <div style="max-width:700px;margin:0 auto">
      <h3 class="mb-20"><i class="fas fa-share-alt"></i> åˆ†äº«ç³»ç»Ÿç»™å­¦ç”Ÿ</h3>
      <div class="stats-card">
        <h4 class="mb-15"><i class="fas fa-link"></i> å­¦ç”Ÿè®¿é—®é“¾æ¥</h4>
        <div style="background:#f1f3f4;padding:15px;border-radius:8px;margin:20px 0"><input id="share-url" value="${url}" readonly style="width:100%;padding:10px;border:none;background:transparent;font-size:16px;font-weight:bold"></div>
        <button class="btn" onclick="copyShareLink()"><i class="fas fa-copy"></i> å¤åˆ¶é“¾æ¥</button>
        <h4 class="mt-40 mb-20" style="color:#333"><i class="fas fa-graduation-cap"></i> å­¦ç”Ÿä½¿ç”¨è¯´æ˜</h4>
        <div class="text-left mt-20 mb-20">
          <div class="flex items-start mb-15"><div style="background:#4CAF50;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px;font-weight:bold">1</div><div>è®¿é—®ä¸Šé¢çš„é“¾æ¥</div></div>
          <div class="flex items-start mb-15"><div style="background:#4CAF50;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px;font-weight:bold">2</div><div>è¾“å…¥è‹±æ–‡åæ³¨å†Œè´¦å·</div></div>
          <div class="flex items-start mb-15"><div style="background:#4CAF50;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px;font-weight:bold">3</div><div>ç™»å½•åå³å¯å¼€å§‹å­¦ä¹ æ‚¨ä¸Šä¼ çš„å•è¯</div></div>
          <div class="flex items-start mb-15"><div style="background:#4CAF50;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px;font-weight:bold">4</div><div>æ•™å¸ˆå¯ä»¥åœ¨åå°æŸ¥çœ‹å­¦ä¹ è¿›åº¦</div></div>
        </div>
        <div class="mt-40"><div class="wechat-badge"><i class="fab fa-weixin"></i><span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span><strong>Kathy151</strong></div><p class="text-gray-600 mt-15">å¦‚æœ‰é—®é¢˜è¯·éšæ—¶è”ç³»</p></div>
      </div>
    </div>
  `;
}
function copyShareLink() { const inp = document.getElementById('share-url'); inp.select(); document.execCommand('copy'); showGlobalMessage('é“¾æ¥å·²å¤åˆ¶ï¼', 'success'); }

/* ==================== æ•™å¸ˆ-å¿«é€Ÿç»Ÿè®¡ ==================== */
async function quickStats() {
  const today = new Date(); today.setHours(0, 0, 0, 0); const { data: r } = await db.from('study_records').select('*').gte('last_reviewed', today.toISOString());
  const todayCount = r?.length || 0, todayStus = new Set(r?.map(x => x.student_id) || []).size, todayMastered = r?.filter(x => x.status === 'mastered').length || 0;
  showGlobalMessage(`ä»Šæ—¥æ•°æ®ï¼š${todayStus} åå­¦ç”Ÿå­¦ä¹ äº† ${todayCount} æ¬¡ï¼ŒæŒæ¡äº† ${todayMastered} ä¸ªå•è¯`, 'success');
}
async function showStudentActivity() {
  const cont = document.getElementById('teacher-content'); cont.innerHTML = '<div class="loader"></div>';
  const seven = new Date(); seven.setDate(seven.getDate() - 7); const { data: rec } = await db.from('study_records').select('student_id,last_reviewed').gte('last_reviewed', seven.toISOString());
  if (!rec || rec.length === 0) { cont.innerHTML = '<p class="text-center">æœ€è¿‘7å¤©æ²¡æœ‰å­¦ä¹ è®°å½•</p>'; return; }
  const act = {}; rec.forEach(r => { if (!act[r.student_id]) act[r.student_id] = 0; act[r.student_id]++; });
  const arr = Object.entries(act).map(([s, c]) => ({ s, c })).sort((a, b) => b.c - a.c);
  let html = `<h3 class="mb-20"><i class="fas fa-running"></i> æœ€è¿‘7å¤©å­¦ç”Ÿæ´»è·ƒåº¦</h3><div class="overflow-x-auto"><table class="data-table"><thead><tr><th>æ’å</th><th>å­¦ç”Ÿ</th><th>å­¦ä¹ æ¬¡æ•°</th><th>æ´»è·ƒåº¦</th></tr></thead><tbody>`;
  arr.forEach((x, i) => { const lvl = x.c >= 50 ? 'ğŸ”¥ éå¸¸æ´»è·ƒ' : x.c >= 20 ? 'â­ æ´»è·ƒ' : x.c >= 5 ? 'âœ… ä¸€èˆ¬' : 'ğŸ“ è¾ƒå°‘'; const col = x.c >= 50 ? '#F44336' : x.c >= 20 ? '#FF9800' : x.c >= 5 ? '#4CAF50' : '#666'; html += `<tr><td>#${i + 1}</td><td><strong>${x.s}</strong></td><td>${x.c}</td><td style="color:${col};font-weight:bold">${lvl}</td></tr>`; }); html += '</tbody></table></div>'; cont.innerHTML = html;
}

/* ==================== å­¦ç”Ÿé¢æ¿ ==================== */
async function showStudentDashboard() { showScreen('student-screen'); await loadStudentDashboardSimple(); }
async function loadStudentDashboardSimple() {
  document.getElementById('student-name').textContent = appState.currentUser;
  await syncGroupWordsToStudent(appState.currentUser);
  const { data: rec } = await db.from('study_records').select('*').eq('student_id', appState.currentUser);
  appState.userWords = rec || [];
  const today = new Date(); today.setHours(0, 0, 0, 0); const todayRec = rec?.filter(r => r.last_reviewed && new Date(r.last_reviewed) >= today) || [];
  const target = appState.dailyTarget; const todayProg = Math.min(todayRec.length, target); const progPer = (todayProg / target) * 100;
  document.getElementById('today-status').innerHTML = `
    <div class="stats-card">
      <h3 class="mb-15"><i class="fas fa-calendar-day"></i> ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
      <div class="card-grid">
        <div class="stat-card"><div class="number">${todayRec.length}</div><div class="label">ä»Šæ—¥å·²å­¦</div></div>
        <div class="stat-card"><div class="number">${Math.max(0, target - todayRec.length)}</div><div class="label">å»ºè®®å­¦ä¹ </div></div>
        <div class="stat-card"><div class="number">${todayRec.filter(x => x.status === 'mastered').length}</div><div class="label">ä»Šæ—¥æŒæ¡</div></div>
      </div>
      <div class="mt-20"><div class="flex justify-between mb-8"><span class="text-gray-600">ä»Šæ—¥è¿›åº¦</span><span class="text-green-600 font-bold">${todayProg}/${target}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${progPer}%"></div></div></div>
      ${todayProg >= target ? '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : '<p class="text-orange-600 text-center font-bold mt-15">ğŸ’ª ç»§ç»­åŠªåŠ›å®Œæˆä»Šæ—¥ç›®æ ‡ï¼</p>'}
    </div>
  `;
  const total = rec?.length || 0, mastered = rec?.filter(x => x.status === 'mastered').length || 0, learning = rec?.filter(x => x.status === 'learning').length || 0, review = rec?.filter(x => x.status === 'new').length || 0, prog = total ? Math.round(mastered / total * 100) : 0;
  document.getElementById('my-progress-summary').innerHTML = `
    <h3 class="mb-20"><i class="fas fa-chart-line"></i> æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
    <div class="card-grid">
      <div class="stat-card"><div class="number">${total}</div><div class="label">å•è¯æ€»æ•°</div></div>
      <div class="stat-card"><div class="number">${mastered}</div><div class="label">å·²æŒæ¡</div></div>
      <div class="stat-card"><div class="number">${learning}</div><div class="label">å­¦ä¹ ä¸­</div></div>
      <div class="stat-card"><div class="number">${review}</div><div class="label">éœ€å­¦ä¹ </div></div>
    </div>
    <div class="mt-20"><div class="flex justify-between mb-8"><span class="text-gray-600">æ•´ä½“æŒæ¡è¿›åº¦</span><span class="text-green-600 font-bold">${prog}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div></div>
  `;
  const { data: sg } = await db.from('group_students').select('group_id').eq('student_id', appState.currentUser);
  let ghtml = ''; if (sg && sg.length) {
    const { data: groups } = await db.from('groups').select('id,name').in('id', sg.map(x => x.group_id));
    for (const g of groups) {
      const [{ data: gw }, { data: my }] = await Promise.all([db.from('words').select('count').eq('group_id', g.id), db.from('study_records').select('count').eq('student_id', appState.currentUser).eq('group_id', g.id)]);
      ghtml += `<div class="stats-card" style="border:2px solid #4CAF50"><div class="font-bold text-green-800 mb-5"><i class="fas fa-folder"></i> ${g.name}</div><div class="text-sm text-gray-600"><i class="fas fa-book"></i> åˆ†ç»„å•è¯ï¼š${gw?.[0]?.count || 0} | <i class="fas fa-user"></i> æˆ‘çš„å•è¯ï¼š${my?.[0]?.count || 0}</div></div>`;
    }
  } else { ghtml = `<div class="stats-card"><h3 class="mb-15"><i class="fas fa-folder-open"></i> åˆ†ç»„çŠ¶æ€</h3><p class="text-orange-600 text-center">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„</p><p class="text-gray-600 text-center text-sm">è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­</p></div>`; }
  document.getElementById('group-details').innerHTML = ghtml;
}
async function manualSyncWords() {
  showGlobalMessage('æ­£åœ¨åŒæ­¥å•è¯...', 'info'); const n = await syncGroupWordsToStudent(appState.currentUser);
  if (n > 0) showGlobalMessage(`åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥ ${n} ä¸ªæ–°å•è¯`, 'success'); else showGlobalMessage('æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
  await loadStudentDashboardSimple();
}

/* ==================== å­¦ç”Ÿ-è®­ç»ƒé€‰æ‹© ==================== */
function showTrainingOptions() { showScreen('training-options-screen'); loadTrainingOptions(); }
async function loadTrainingOptions() {
  const today = new Date().toDateString(); const stored = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`); const prog = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
  const opt = document.getElementById('daily-training-options');
  if (stored === today && prog >= 10) {
    opt.innerHTML = `
      <div class="stats-card" style="background:#E3F2FD">
        <h4 class="mb-15" style="color:#1565C0"><i class="fas fa-calendar-day"></i> ä»Šæ—¥è®­ç»ƒ</h4>
        <p class="text-gray-600 mb-20">æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${prog} ä¸ªå•è¯ï¼</p>
        <div class="grid grid-cols-2 gap-15">
          <button class="btn" onclick="startNewDailyTraining()" style="padding:20px;font-size:16px"><div style="font-size:24px;margin-bottom:10px">ğŸ†•</div><div style="font-weight:bold;margin-bottom:5px">æ–°å•è¯è®­ç»ƒ</div><div style="color:#666;font-size:14px">å­¦ä¹ æ–°çš„å•è¯</div></button>
          <button class="btn btn-blue" onclick="continueReviewTraining()" style="padding:20px;font-size:16px"><div style="font-size:24px;margin-bottom:10px">ğŸ”„</div><div style="font-weight:bold;margin-bottom:5px">ç»§ç»­å¤ä¹ </div><div style="color:#666;font-size:14px">å¤ä¹ ä»Šæ—¥å­¦è¿‡çš„å•è¯</div></button>
        </div>
        <p class="text-green-600 text-center font-bold mt-15">ğŸ‰ å¤ªæ£’äº†ï¼æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€ä»»åŠ¡ï¼</p>
      </div>
    `;
  } else {
    opt.innerHTML = `<button class="btn btn-blue" onclick="startDailyTraining()" style="width:100%;padding:25px;font-size:18px;margin-bottom:15px"><i class="fas fa-calendar-day" style="font-size:24px;margin-bottom:10px"></i><div style="font-weight:bold;margin-bottom:5px">ä»Šæ—¥è®­ç»ƒ</div><div style="color:#666;font-size:14px">æ¯å¤©10ä¸ªå•è¯ï¼Œç§‘å­¦è®°å¿†</div>${prog > 0 ? `<div class="text-green-600 mt-5">ä»Šæ—¥è¿›åº¦ï¼š${prog}/10</div>` : ''}</button>`;
  }
}
function startNewDailyTraining() { localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0'); startDailyTraining(); }
async function continueReviewTraining() {
  const today = new Date(); today.setHours(0, 0, 0, 0); const todayWords = appState.userWords.filter(w => w.last_reviewed && new Date(w.last_reviewed) >= today);
  if (todayWords.length === 0) { showGlobalMessage('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info'); startNewDailyTraining(); return; }
  const reviewWords = todayWords.sort((a, b) => { if (a.status === 'new' && b.status !== 'new') return -1; if (a.status !== 'new' && b.status === 'new') return 1; if (a.status === 'learning' && b.status === 'mastered') return -1; if (a.status === 'mastered' && b.status === 'learning') return 1; return (a.review_count || 0) - (b.review_count || 0); }).slice(0, 10);
  if (reviewWords.length === 0) { showGlobalMessage('ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯', 'info'); startNewDailyTraining(); return; }
  reviewWords.sort(() => Math.random() - 0.5); appState.trainingWords = reviewWords; appState.currentWordIndex = 0; appState.isCardFlipped = false; startTrainingSession();
}
function startAllWordsTraining() {
  if (appState.userWords.length === 0) return showGlobalMessage('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
  const saved = localStorage.getItem(`kathy_all_training_${appState.currentUser}`); let start = 0;
  if (saved) try { const p = JSON.parse(saved); if (p.date === new Date().toDateString() && p.index > 0) if (confirm(`å‘ç°ä¸Šæ¬¡è®­ç»ƒè¿›åº¦ï¼ˆ${p.index}/${p.total}ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) start = p.index; } catch (e) {}
  appState.trainingWords = [...appState.userWords].sort(() => Math.random() - 0.5); appState.currentWordIndex = start; appState.isCardFlipped = false; startTrainingSession();
}
async function startDailyTraining() {
  if (appState.userWords.length === 0) return showGlobalMessage('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
  const prog = appState.dailyTrainingProgress || 0; const target = appState.dailyTarget;
  if (prog >= target) if (!await showConfirm(`æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${prog} ä¸ªå•è¯ï¼æ˜¯å¦ç»§ç»­æ›´å¤šï¼Ÿ`, 'ç»§ç»­å­¦ä¹ ', 'å–æ¶ˆ')) { showGlobalMessage('æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€ä»»åŠ¡ï¼Œå¾ˆæ£’ï¼', 'success'); return; }
  showGlobalMessage('æ­£åœ¨æ™ºèƒ½ç”Ÿæˆä»Šæ—¥å­¦ä¹ è®¡åˆ’...', 'info');
  const todays = await generateDailyTasks(); if (todays.length === 0) return showGlobalMessage('ä»Šæ—¥ä»»åŠ¡ç”Ÿæˆå¤±è´¥', 'error');
  const newCount = todays.filter(w => w.status === 'new').length, reviewCount = todays.length - newCount;
  let msg = `ä»Šæ—¥å­¦ä¹ ä»»åŠ¡ï¼š\næ–°å•è¯ï¼š${newCount}ä¸ª\nå¤ä¹ å•è¯ï¼š${reviewCount}ä¸ª\næ€»å•è¯ï¼š${todays.length}ä¸ª\n\næ™ºèƒ½åˆ†é…ï¼š\nâ€¢ å·²æŒæ¡å•è¯ï¼šæ¯å¤©æœ€å¤šå¤ä¹ 2æ¬¡\nâ€¢ å­¦ä¹ ä¸­å•è¯ï¼šé€‚å½“å¢åŠ å¤ä¹ \nâ€¢ éœ€å­¦ä¹ å•è¯ï¼šé‡ç‚¹å¤ä¹ `; if (appState.reviewDay) msg = `ğŸ“… ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼\nä¸å­¦ä¹ æ–°å•è¯ï¼Œä¸“æ³¨å¤ä¹ å·²å­¦å†…å®¹ã€‚\n\nä»Šæ—¥å¤ä¹ ä»»åŠ¡ï¼š${todays.length}ä¸ªå•è¯\nå¤ä¹ æ¯”ä¾‹ï¼šéœ€å­¦ä¹ (50%)Â·å­¦ä¹ ä¸­(30%)Â·å·²æŒæ¡(20%)`;
  if (!await showConfirm(msg, 'å¼€å§‹å­¦ä¹ ', 'å–æ¶ˆ')) return;
  appState.trainingWords = todays.sort(() => Math.random() - 0.5); appState.currentWordIndex = 0; appState.isCardFlipped = false; startTrainingSession();
}
function startReviewTraining() {
  if (appState.userWords.length === 0) return showGlobalMessage('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
  const weak = appState.userWords.filter(w => w.status === 'new' || w.status === 'learning'); if (weak.length === 0) { showGlobalMessage('ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰éœ€è¦å¤ä¹ çš„å¼±é¡¹å•è¯ï¼', 'success'); return; }
  weak.sort(() => Math.random() - 0.5); appState.trainingWords = weak; appState.currentWordIndex = 0; appState.isCardFlipped = false; startTrainingSession();
}
function startTrainingSession() { showScreen('training-screen'); showTrainingScreenSimple(); }
function showTrainingScreenSimple() {
  if (appState.currentWordIndex >= appState.trainingWords.length) { finishTraining(); return; }
  const w = appState.trainingWords[appState.currentWordIndex]; const total = appState.trainingWords.length; const current = appState.currentWordIndex + 1;
  document.getElementById('training-progress').textContent = `${current}/${total}`;
  const enFont = getFontSizeClass(w.english), cnFont = getFontSizeClass(w.chinese);
  document.getElementById('training-content').innerHTML = `
    <div class="text-center">
      <div class="word-card ${appState.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
        <div class="word-card-content ${appState.isCardFlipped ? cnFont : enFont}">
          ${appState.isCardFlipped ? `<div style="color:#2E7D32;word-break:break-word">${w.chinese}</div>` : `<div style="color:#333;word-break:break-word">${w.english}</div>`}
        </div>
      </div>
      <div class="mt-40 grid grid-cols-3 gap-15">
        <button class="btn" onclick="markTrainingWord('mastered')" style="padding:15px;background:#4CAF50"><div style="font-size:20px;margin-bottom:5px">âœ…</div><div>å·²æŒæ¡</div></button>
        <button class="btn btn-blue" onclick="markTrainingWord('learning')" style="padding:15px;background:#2196F3"><div style="font-size:20px;margin-bottom:5px">ğŸ”„</div><div>å­¦ä¹ ä¸­</div></button>
        <button class="btn" onclick="markTrainingWord('new')" style="padding:15px;background:#FF9800"><div style="font-size:20px;margin-bottom:5px">ğŸ“</div><div>éœ€å­¦ä¹ </div></button>
      </div>
      <div class="mt-30 flex gap-15">
        <button class="btn" onclick="skipTrainingWord()" style="flex:1;padding:12px;background:#9E9E9E"><div>â­ï¸ è·³è¿‡</div></button>
        <button class="btn" onclick="saveTrainingProgress()" style="flex:1;padding:12px;background:#607D8B"><div>ğŸ’¾ ä¿å­˜è¿›åº¦</div></button>
        <button class="btn" onclick="showStudentDashboard()" style="flex:1;padding:12px;background:#795548"><div>ğŸ“‹ è¿”å›</div></button>
      </div>
      <div class="mt-20 text-gray-600 text-sm"><p><i class="fas fa-mouse-pointer"></i> ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p><p><i class="fas fa-star"></i> é€‰æ‹©é€‚å½“çš„æŒæ¡ç¨‹åº¦</p></div>
    </div>
  `;
}
function saveTrainingProgress() {
  if (appState.trainingWords.length === 0) return;
  const progress = { date: new Date().toDateString(), index: appState.currentWordIndex, total: appState.trainingWords.length, words: appState.trainingWords.map(w => w.id || w.word_id) };
  localStorage.setItem(`kathy_all_training_${appState.currentUser}`, JSON.stringify(progress)); showGlobalMessage('è®­ç»ƒè¿›åº¦å·²ä¿å­˜ï¼', 'success');
}
function flipTrainingCard() {
  const w = appState.trainingWords[appState.currentWordIndex]; const card = document.querySelector('.word-card'); const content = card.querySelector('.word-card-content');
  if (appState.isCardFlipped) {
    card.classList.remove('flipped'); content.className = 'word-card-content ' + getFontSizeClass(w.english); content.innerHTML = `<div style="color:#333;word-break:break-word">${w.english}</div>`;
  } else {
    card.classList.add('flipped'); content.className = 'word-card-content ' + getFontSizeClass(w.chinese); content.innerHTML = `<div style="color:#2E7D32;word-break:break-word">${w.chinese}</div>`;
  } appState.isCardFlipped = !appState.isCardFlipped;
}
async function markTrainingWord(status) {
  const w = appState.trainingWords[appState.currentWordIndex]; try {
    await db.from('study_records').update({ status: status, review_count: (w.review_count || 0) + 1, last_reviewed: new Date().toISOString() }).eq('student_id', appState.currentUser).eq('word_id', w.word_id || w.id);
    w.status = status; w.review_count = (w.review_count || 0) + 1; w.last_reviewed = new Date().toISOString();
    const globalIndex = appState.userWords.findIndex(x => (x.word_id || x.id) === (w.word_id || w.id)); if (globalIndex !== -1) appState.userWords[globalIndex] = { ...appState.userWords[globalIndex], ...w };
    saveDailyTrainingProgress(1);
    const statusText = { mastered: 'âœ… å·²æŒæ¡', learning: 'ğŸ”„ å­¦ä¹ ä¸­', new: 'ğŸ“ éœ€å­¦ä¹ ' }[status];
    showGlobalMessage(`${statusText}: ${w.english}`, 'success');
    setTimeout(() => { appState.currentWordIndex++; appState.isCardFlipped = false; if (appState.currentWordIndex < appState.trainingWords.length) showTrainingScreenSimple(); else finishTraining(); }, 800);
  } catch (e) { console.error(e); showGlobalMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error'); }
}
function skipTrainingWord() { appState.currentWordIndex++; appState.isCardFlipped = false; if (appState.currentWordIndex < appState.trainingWords.length) showTrainingScreenSimple(); else finishTraining(); }
function finishTraining() {
  const total = appState.trainingWords.length; const mastered = appState.trainingWords.filter(w => w.status === 'mastered').length; const learning = appState.trainingWords.filter(w => w.status === 'learning').length; const prog = total ? Math.round(mastered / total * 100) : 0;
  localStorage.removeItem(`kathy_all_training_${appState.currentUser}`); loadStudentDashboardSimple();
  document.getElementById('training-content').innerHTML = `
    <div class="text-center p-40">
      <div style="font-size:3em;margin-bottom:20px;color:#4CAF50">ğŸ‰</div>
      <h3 class="mb-15">è®­ç»ƒå®Œæˆï¼</h3>
      <div class="stats-card" style="max-width:400px;margin:0 auto">
        <div class="card-grid">
          <div class="stat-card"><div class="number">${total}</div><div class="label">è®­ç»ƒå•è¯</div></div>
          <div class="stat-card"><div class="number">${mastered}</div><div class="label">å·²æŒæ¡</div></div>
          <div class="stat-card"><div class="number">${learning}</div><div class="label">å­¦ä¹ ä¸­</div></div>
          <div class="stat-card"><div class="number">${prog}%</div><div class="label">æŒæ¡ç‡</div></div>
        </div>
      </div>
      ${appState.dailyTrainingProgress >= 10 ? '<div class="celebration-banner mt-20">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : ''}
      <div class="mt-30"><button class="btn" onclick="startDailyTraining()" style="margin:10px">ç»§ç»­ä»Šæ—¥è®­ç»ƒ</button><button class="btn btn-red" onclick="showStudentDashboard()" style="margin:10px">è¿”å›ä¸»é¡µ</button></div>
    </div>
  `;
}
function cancelTraining() { if (confirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„è®­ç»ƒè¿›åº¦å¯ä»¥ç¨åç»§ç»­ã€‚')) { saveTrainingProgress(); showStudentDashboard(); } }

/* ==================== å­¦ç”Ÿ-æˆå°± ==================== */
function showMyAchievementsPage() { showScreen('student-achievements-screen'); loadStudentAchievements(); }
function loadStudentAchievements() {
  const total = appState.userWords.length, mastered = appState.userWords.filter(w => w.status === 'mastered').length, totalReviews = appState.userWords.reduce((a, w) => a + (w.review_count || 0), 0);
  const dates = appState.userWords.map(w => w.last_reviewed ? new Date(w.last_reviewed).setHours(0, 0, 0, 0) : null).filter(d => d).sort((a, b) => b - a);
  let con = 0; const today = new Date(); today.setHours(0, 0, 0, 0);
  for (let i = 0; i < dates.length; i++) { const d = new Date(today); d.setDate(d.getDate() - i); if (dates[i] === d.getTime()) con++; else break; }
  const ach = []; if (total >= 100) ach.push('ğŸ† å•è¯å¤§å¸ˆï¼šå­¦ä¹ 100ä¸ªå•è¯'); else if (total >= 50) ach.push('â­ å•è¯èƒ½æ‰‹ï¼šå­¦ä¹ 50ä¸ªå•è¯'); else if (total >= 10) ach.push('âœ… å•è¯æ–°æ‰‹ï¼šå­¦ä¹ 10ä¸ªå•è¯');
  if (mastered >= 50) ach.push('ğŸ¯ æŒæ¡å¤§å¸ˆï¼šæŒæ¡50ä¸ªå•è¯'); else if (mastered >= 20) ach.push('ğŸ“š æŒæ¡èƒ½æ‰‹ï¼šæŒæ¡20ä¸ªå•è¯');
  if (totalReviews >= 100) ach.push('ğŸ”„ å¤ä¹ è¾¾äººï¼šæ€»å¤ä¹ 100æ¬¡'); else if (totalReviews >= 50) ach.push('ğŸ“– å¤ä¹ èƒ½æ‰‹ï¼šæ€»å¤ä¹ 50æ¬¡');
  if (con >= 7) ach.push('ğŸ”¥ åšæŒä¹‹æ˜Ÿï¼šè¿ç»­å­¦ä¹ 7å¤©'); else if (con >= 3) ach.push('ğŸ’ª åšæŒèƒ½æ‰‹ï¼šè¿ç»­å­¦ä¹ 3å¤©');
  document.getElementById('achievements-content').innerHTML = `
    <div style="max-width:800px;margin:0 auto">
      <h3 class="mb-20"><i class="fas fa-trophy"></i> æˆ‘çš„å­¦ä¹ æˆå°±</h3>
      <div class="stats-card">
        <div class="card-grid">
          <div class="stat-card"><div class="number">${total}</div><div class="label">å•è¯æ€»æ•°</div></div>
          <div class="stat-card"><div class="number">${mastered}</div><div class="label">å·²æŒæ¡</div></div>
          <div class="stat-card"><div class="number">${totalReviews}</div><div class="label">æ€»å¤ä¹ æ¬¡æ•°</div></div>
          <div class="stat-card"><div class="number">${con}</div><div class="label">è¿ç»­å­¦ä¹ å¤©æ•°</div></div>
        </div>
      </div>
      <div class="stats-card mt-30"><h4 class="mb-15"><i class="fas fa-award"></i> å·²è·å¾—æˆå°±</h4>
        ${ach.length ? `<div class="flex flex-wrap gap-10">${ach.map(a => `<div class="stat-card" style="padding:10px 15px;margin:0"><div>${a}</div></div>`).join('')}</div>` : '<p class="text-center text-gray-600">è¿˜æ²¡æœ‰è·å¾—æˆå°±ï¼Œç»§ç»­åŠªåŠ›ï¼</p>'}
      </div>
      <div class="text-center mt-30"><button class="btn" onclick="showStudentDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ</button></div>
    </div>
  `;
}

/* ==================== å­¦ç”Ÿ-å•è¯æœ¬ ==================== */
function showMyWordListPage() { showScreen('student-wordlist-screen'); loadStudentWordList(); }
async function loadStudentWordList() {
  const cont = document.getElementById('wordlist-content'); cont.innerHTML = '<div class="loader"></div>';
  const { data: rec } = await db.from('study_records').select('*').eq('student_id', appState.currentUser).order('last_reviewed', { ascending: false });
  if (!rec || rec.length === 0) { cont.innerHTML = '<div class="text-center p-40"><div style="font-size:3em;margin-bottom:20px;color:#666">ğŸ“š</div><h3 class="text-gray-600">è¿˜æ²¡æœ‰å•è¯</h3><p class="text-gray-400">ç­‰å¾…æ•™å¸ˆä¸Šä¼ å•è¯</p></div>'; return; }
  appState.userWords = rec;
  const total = rec.length, mastered = rec.filter(w => w.status === 'mastered').length, learning = rec.filter(w => w.status === 'learning').length, review = rec.filter(w => w.status === 'new').length;
  let html = `
    <div class="mb-20">
      <div class="card-grid">
        <div class="stat-card"><div class="number">${total}</div><div class="label">å•è¯æ€»æ•°</div></div>
        <div class="stat-card"><div class="number">${mastered}</div><div class="label">å·²æŒæ¡</div></div>
        <div class="stat-card"><div class="number">${learning}</div><div class="label">å­¦ä¹ ä¸­</div></div>
        <div class="stat-card"><div class="number">${review}</div><div class="label">éœ€å­¦ä¹ </div></div>
      </div>
    </div>
    <div class="mb-20 flex flex-wrap gap-10"><select id="word-filter" class="p-10" onchange="filterMyWords()" style="border-radius:5px;border:2px solid #ddd;font-size:16px">
      <option value="all">æ‰€æœ‰å•è¯</option><option value="mastered">å·²æŒæ¡</option><option value="learning">å­¦ä¹ ä¸­</option><option value="new">éœ€å­¦ä¹ </option><option value="recent">æœ€è¿‘å­¦ä¹ </option>
    </select><input id="word-search" placeholder="ğŸ” æœç´¢å•è¯..." style="padding:10px;border-radius:5px;border:2px solid #ddd;font-size:16px" oninput="filterMyWords()"></div>
    <div class="overflow-x-auto max-h-500"><table class="data-table"><thead><tr><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>çŠ¶æ€</th><th>å¤ä¹ æ¬¡æ•°</th><th>æœ€åå¤ä¹ </th><th>æ“ä½œ</th></tr></thead><tbody id="words-table-body">
  `; rec.forEach(w => {
    let stxt = '', scol = ''; switch (w.status) { case 'mastered': stxt = 'âœ… å·²æŒæ¡'; scol = '#4CAF50'; break; case 'learning': stxt = 'ğŸ”„ å­¦ä¹ ä¸­'; scol = '#FF9800'; break; default: stxt = 'ğŸ“ éœ€å­¦ä¹ '; scol = '#666'; }
    html += `<tr data-status="${w.status}" data-english="${w.english.toLowerCase()}" data-chinese="${w.chinese}">
      <td><strong>${w.english}</strong></td><td>${w.chinese}</td><td style="color:${scol}">${stxt}</td><td>${w.review_count || 0}</td><td>${w.last_reviewed ? new Date(w.last_reviewed).toLocaleDateString('zh-CN') : 'ä»æœª'}</td>
      <td><button class="btn" onclick="practiceSingleWord('${w.english.replace(/'/g, "\\'")}', '${w.chinese.replace(/'/g, "\\'")}')"><i class="fas fa-play"></i> ç»ƒä¹ </button></td>
    </tr>`;
  }); html += '</tbody></table></div><div class="text-center mt-30"><button class="btn btn-red" onclick="showStudentDashboard()"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ</button></div>'; cont.innerHTML = html;
}
function filterMyWords() {
  const filter = document.getElementById('word-filter').value; const search = document.getElementById('word-search').value.toLowerCase(); const rows = document.querySelectorAll('#words-table-body tr');
  rows.forEach(row => {
    const status = row.getAttribute('data-status'); const en = row.getAttribute('data-english'); const cn = row.getAttribute('data-chinese');
    let statusMatch = true; if (filter !== 'all') {
      if (filter === 'recent') statusMatch = row.cells[4].textContent !== 'ä»æœª'; else statusMatch = (filter === status);
    } const searchMatch = !search || en.includes(search) || cn.includes(search); row.style.display = (statusMatch && searchMatch) ? '' : 'none';
  });
}
function practiceSingleWord(en, cn) { appState.trainingWords = [{ english: en, chinese: cn, status: 'new' }]; appState.currentWordIndex = 0; appState.isCardFlipped = false; startTrainingSession(); }

/* ==================== å­¦ç”Ÿ-ä»Šæ—¥ä»»åŠ¡ ==================== */
function showTodayWordsPage() { showScreen('student-today-screen'); loadTodayWordsPage(); }
function loadTodayWordsPage() {
  const today = new Date(); today.setHours(0, 0, 0, 0); const todayWords = appState.userWords.filter(w => w.last_reviewed && new Date(w.last_reviewed) >= today);
  if (todayWords.length === 0) { document.getElementById('today-content').innerHTML = '<div class="text-center p-40"><div style="font-size:3em;margin-bottom:20px;color:#666">ğŸ“…</div><h3 class="text-gray-600">ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ å•è¯</h3><p class="text-gray-400 mb-20">å¿«å»å¼€å§‹ä»Šæ—¥è®­ç»ƒå§ï¼</p><button class="btn btn-blue" onclick="startDailyTraining()" style="margin:10px">å¼€å§‹ä»Šæ—¥è®­ç»ƒ</button><button class="btn" onclick="showStudentDashboard()" style="margin:10px">è¿”å›ä¸»é¡µ</button></div>'; return; }
  const cont = document.getElementById('today-content'); const mastered = todayWords.filter(w => w.status === 'mastered'), learning = todayWords.filter(w => w.status === 'learning'), news = todayWords.filter(w => w.status === 'new');
  let html = `
    <div style="max-width:800px;margin:0 auto">
      <h3 class="mb-20"><i class="fas fa-calendar-day"></i> ä»Šæ—¥å·²å­¦ä¹ å•è¯</h3>
      <p class="text-gray-600 mb-20">ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayWords.length} ä¸ªå•è¯ï¼š</p>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-15">
  `; todayWords.forEach(w => html += `
    <div class="stats-card" style="border:2px solid #4CAF50;padding:15px;text-align:center">
      <div class="font-bold text-lg mb-10" style="word-break:break-word">${w.english}</div>
      <div class="text-green-800 mb-10" style="word-break:break-word">${w.chinese}</div>
      <div class="text-sm text-gray-600">${w.status === 'mastered' ? 'âœ… å·²æŒæ¡' : w.status === 'learning' ? 'ğŸ”„ å­¦ä¹ ä¸­' : 'ğŸ“ éœ€å­¦ä¹ '}</div>
    </div>
  `); html += `</div><div class="text-center mt-30"><button class="btn btn-blue" onclick="startDailyTraining()" style="margin:10px">ç»§ç»­ä»Šæ—¥å­¦ä¹ </button><button class="btn" onclick="showStudentDashboard()" style="margin:10px">è¿”å›ä¸»é¡µ</button></div></div>`; cont.innerHTML = html;
}

/* ==================== å­¦ç”Ÿ-æ™ºèƒ½æ¯æ—¥ä»»åŠ¡ç”Ÿæˆ ==================== */
async function generateDailyTasks() {
  try {
    const today = new Date().toISOString().split('T')[0]; const stu = appState.currentUser;
    appState.reviewDay = await checkIfReviewDay(stu);
    const { data: rec } = await db.from('study_records').select('*').eq('student_id', stu);
    const newWords = rec?.filter(w => w.status === 'new') || [], learningWords = rec?.filter(w => w.status === 'learning') || [], masteredWords = rec?.filter(w => w.status === 'mastered') || [];
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yestr = yesterday.toISOString().split('T')[0]; const yesterdayRec = rec?.filter(w => w.last_reviewed && new Date(w.last_reviewed).toISOString().split('T')[0] === yestr && w.status !== 'mastered') || [];
    let todaysWords = [];
    if (appState.reviewDay) todaysWords = await generateReviewDayWords(newWords, learningWords, masteredWords); else todaysWords = await generateNormalDayWords(newWords, learningWords, masteredWords, yesterdayRec);
    appState.todayWordsToReview = todaysWords;
    await recordAttendance(stu, todaysWords.length, todaysWords.filter(w => w.status === 'new').length);
    return todaysWords;
  } catch (e) { console.error(e); return []; }
}
async function checkIfReviewDay(stu) {
  const { data: att } = await db.from('attendance_records').select('study_date').eq('student_id', stu).order('study_date', { ascending: false }).limit(7);
  if (!att || att.length === 0) return false;
  let c = 0; const today = new Date(); today.setHours(0, 0, 0, 0);
  for (let i = 0; i < 7; i++) { const d = new Date(today); d.setDate(d.getDate() - i); const ds = d.toISOString().split('T')[0]; if (att.some(a => a.study_date === ds)) c++; else break; }
  appState.consecutiveDays = c; appState.attendanceStreak = c;
  return c % 7 === 0 && c > 0;
}
async function generateNormalDayWords(newWords, learningWords, masteredWords, yesterdayRec) {
  const todaysWords = []; const target = appState.dailyTarget; const totalWords = newWords.length + learningWords.length + masteredWords.length;
  const yesterdayToReview = yesterdayRec.slice(0, 5); todaysWords.push(...yesterdayToReview);
  if (totalWords <= 50) { const newToLearn = newWords.slice(0, target); todaysWords.push(...newToLearn); const learningToReview = selectByWeight(learningWords, 5, 'learning'); todaysWords.push(...learningToReview); const masteredToReview = selectByWeight(masteredWords, 2, 'mastered'); todaysWords.push(...masteredToReview); }
  else if (totalWords <= 100) { const newToLearn = newWords.slice(0, target); todaysWords.push(...newToLearn); const learningCount = Math.min(3, learningWords.length); const learningToReview = selectByWeight(learningWords, learningCount, 'learning'); todaysWords.push(...learningToReview); const masteredCount = Math.min(1, masteredWords.length); const masteredToReview = selectByWeight(masteredWords, masteredCount, 'mastered'); todaysWords.push(...masteredToReview); }
  else { const newCount = newWords.length; const recentMastered = await getRecentMasteredWords(7); if (newCount > 20 && recentMastered.length < 10) { const newToLearn = newWords.slice(0, Math.min(5, target)); todaysWords.push(...newToLearn); } else { const newToLearn = newWords.slice(0, target); todaysWords.push(...newToLearn); } const reviewWords = selectSmartReviewWords(learningWords, masteredWords, totalWords); todaysWords.push(...reviewWords); }
  const seen = new Set(); const unique = []; for (const w of todaysWords) { const key = w.id || w.word_id; if (!seen.has(key)) { seen.add(key); unique.push(w); } }
  return unique.sort(() => Math.random() - 0.5);
}
async function generateReviewDayWords(newWords, learningWords, masteredWords) {
  const todaysWords = []; const totalWords = newWords.length + learningWords.length + masteredWords.length; const targetReview = Math.min(30, totalWords);
  const newWeight = 50, learningWeight = 30, masteredWeight = 20; const newCount = Math.ceil(targetReview * (newWeight / 100)), learningCount = Math.ceil(targetReview * (learningWeight / 100)), masteredCount = Math.ceil(targetReview * (masteredWeight / 100));
  const newToReview = selectRecentWords(newWords, newCount); const learningToReview = selectRecentWords(learningWords, learningCount); const masteredToReview = selectRecentWords(masteredWords, masteredCount);
  todaysWords.push(...newToReview, ...learningToReview, ...masteredToReview); return todaysWords.sort(() => Math.random() - 0.5);
}
function selectSmartReviewWords(learningWords, masteredWords, totalWords) {
  const reviewWords = []; let learningCount = 0; if (totalWords <= 50) learningCount = Math.min(5, learningWords.length); else if (totalWords <= 100) learningCount = Math.min(3, learningWords.length); else learningCount = Math.min(2, learningWords.length);
  const learningToReview = [...learningWords].sort((a, b) => (a.review_count || 0) - (b.review_count || 0)).slice(0, learningCount); reviewWords.push(...learningToReview);
  const masteredCount = Math.min(2, masteredWords.length); const masteredToReview = [...masteredWords].sort((a, b) => { const da = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0); const db = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0); return da - db; }).slice(0, masteredCount); reviewWords.push(...masteredToReview); return reviewWords;
}
function selectByWeight(words, count, status) {
  if (words.length === 0) return [];
  const weights = words.map((w, i) => {
    let base = 1; const reviewWeight = 1 / (1 + (w.review_count || 0)); let recencyWeight = 1; if (w.last_reviewed) { const days = Math.floor((Date.now() - new Date(w.last_reviewed).getTime()) / (1000 * 60 * 60 * 24)); recencyWeight = Math.min(3, 1 + days * 0.5); } return base * reviewWeight * recencyWeight;
  });
  const totalWeight = weights.reduce((a, b) => a + b, 0); const norm = weights.map(w => w / totalWeight);
  const selected = []; const seen = new Set();
  while (selected.length < count && selected.length < words.length) {
    let r = Math.random(), sum = 0; for (let i = 0; i < norm.length; i++) { if (seen.has(i)) continue; sum += norm[i]; if (r <= sum) { selected.push(words[i]); seen.add(i); break; } }
  } return selected;
}
function selectRecentWords(words, count) {
  return [...words].sort((a, b) => {
    if (!a.last_reviewed && !b.last_reviewed) return 0; if (!a.last_reviewed) return 1; if (!b.last_reviewed) return -1; return new Date(b.last_reviewed) - new Date(a.last_reviewed);
  }).slice(0, Math.min(count, words.length));
}
async function getRecentMasteredWords(days) {
  const cut = new Date(); cut.setDate(cut.getDate() - days); const { data } = await db.from('study_records').select('*').eq('student_id', appState.currentUser).eq('status', 'mastered').gte('last_reviewed', cut.toISOString());
  return data || [];
}

/* ==================== æ‰“å¡ç³»ç»Ÿ ==================== */
async function recordAttendance(stu, wordCount, newWordCount) {
  try {
    const today = new Date().toISOString().split('T')[0];
    const { data: exist } = await db.from('attendance_records').select('*').eq('student_id', stu).eq('study_date', today).single();
    const reviewCount = wordCount - newWordCount;
    if (exist) {
      await db.from('attendance_records').update({ word_count: wordCount, new_word_count: newWordCount, review_word_count: reviewCount, status: 'completed' }).eq('id', exist.id);
    } else {
      await db.from('attendance_records').insert([{ student_id: stu, study_date: today, word_count: wordCount, new_word_count: newWordCount, review_word_count: reviewCount, status: 'completed' }]);
      await updateConsecutiveDays(stu);
      if (appState.attendanceStreak % 7 === 0 && appState.attendanceStreak > 0) await awardConsecutiveBonus(stu);
    }
    await db.from('users').update({ last_study_date: today, consecutive_days: appState.attendanceStreak, monthly_missed_days: appState.monthlyMissedDays }).eq('username', stu);
  } catch (e) { console.error(e); }
}
async function updateConsecutiveDays(stu) {
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yestr = yesterday.toISOString().split('T')[0];
  const { data: yest } = await db.from('attendance_records').select('*').eq('student_id', stu).eq('study_date', yestr).single();
  const { data: user } = await db.from('users').select('consecutive_days').eq('username', stu).single();
  let newStreak = 1; if (yest) newStreak = (user?.consecutive_days || 0) + 1; appState.attendanceStreak = newStreak; appState.consecutiveDays = newStreak;
  if (!yest && user?.consecutive_days > 0) { appState.monthlyMissedDays = (user.monthly_missed_days || 0) + 1; }
}
async function awardConsecutiveBonus(stu) {
  const streak = appState.attendanceStreak; const weeks = Math.floor(streak / 7);
  let msg = ''; if (weeks === 1) msg = 'ğŸ‰ æ­å–œï¼æ‚¨å·²è¿ç»­å­¦ä¹ 7å¤©ï¼è·å¾—"åšæŒä¹‹æ˜Ÿ"ç§°å·ï¼'; else if (weeks === 2) msg = 'ğŸ‰ å¤ªæ£’äº†ï¼æ‚¨å·²è¿ç»­å­¦ä¹ 14å¤©ï¼è·å¾—"æ¯…åŠ›ä¹‹æ˜Ÿ"ç§°å·ï¼'; else if (weeks === 3) msg = 'ğŸ‰ äº†ä¸èµ·ï¼æ‚¨å·²è¿ç»­å­¦ä¹ 21å¤©ï¼è·å¾—"å­¦ä¹ ç‹è€…"ç§°å·ï¼'; else msg = `ğŸ‰ æ­å–œï¼æ‚¨å·²è¿ç»­å­¦ä¹ ${streak}å¤©ï¼ç»§ç»­ä¿æŒï¼`;
  showGlobalMessage(msg, 'success', 5000);
  try { await db.from('achievements').insert([{ student_id: stu, achievement_type: `consecutive_${streak}_days`, awarded_date: new Date().toISOString().split('T')[0], description: `è¿ç»­å­¦ä¹ ${streak}å¤©å¥–åŠ±` }]); } catch (e) {}
  await notifyTeacher(stu, `è¿ç»­${streak}å¤©æ‰“å¡`);
}
async function notifyTeacher(stu, msg) {
  try { await db.from('teacher_notifications').insert([{ teacher_id: appState.teacherId, student_id: stu, message: `${stu} ${msg}`, read: false, created_at: new Date().toISOString() }]); } catch (e) {}
}

/* ==================== å­¦ç”Ÿ-ä»Šæ—¥ä»»åŠ¡é¡µé¢ ==================== */
function showTodayWordsPage() { showScreen('student-today-screen'); loadTodayWordsPage(); }

/* ==================== é€€å‡ºç™»å½• ==================== */
async function handleLogout() {
  if (!await showConfirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'é€€å‡º', 'å–æ¶ˆ')) return;
  appState.currentUser = null; appState.isTeacher = false; appState.userId = null; appState.userWords = []; appState.trainingWords = []; appState.selectedGroupId = null; appState.selectedWords = []; appState.dailyTrainingProgress = 0; appState.lastTrainingDate = null; appState.consecutiveDays = 0; appState.lastStudyDate = null; appState.reviewDay = false; appState.todayWordsToReview = []; appState.attendanceStreak = 0; appState.monthlyMissedDays = 0; appState.todayStudyCount = 0;
  localStorage.removeItem('kathy_current_user'); localStorage.removeItem('kathy_user_role');
  showScreen('login-screen'); document.getElementById('username').value = ''; showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
}

/* ==================== é¡µé¢åˆå§‹åŒ– ==================== */
window.onload = async () => {
  console.log('ğŸš€ Kathyå•è¯è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
  const saved = localStorage.getItem('kathy_current_user'); const role = localStorage.getItem('kathy_user_role');
  if (saved) { appState.currentUser = saved; appState.isTeacher = (role === 'teacher'); appState.userId = saved; if (appState.isTeacher) showTeacherDashboard(); else showStudentDashboard(); } else testDatabase();
  document.getElementById('username')?.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
};

/* ==================== é”™è¯¯å¤„ç† ==================== */
window.onerror = (msg, src, line, col, error) => { console.error('å…¨å±€é”™è¯¯ï¼š', { msg, src, line, col, error }); showGlobalMessage(`ç³»ç»Ÿé”™è¯¯ï¼š${msg}`, 'error'); return true; };
window.addEventListener('unhandledrejection', e => { console.error('æœªå¤„ç†Promiseé”™è¯¯ï¼š', e.reason); showGlobalMessage(`ç³»ç»Ÿé”™è¯¯ï¼š${e.reason?.message || e.reason}`, 'error'); e.preventDefault(); });

/* ==================== å·¥å…·ï¼šç¡®è®¤å¯¹è¯æ¡† ==================== */
function showConfirm(msg, okText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ') {
  return new Promise(resolve => {
    const modal = document.createElement('div'); modal.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:9999`;
    modal.innerHTML = `
      <div style="background:#fff;padding:30px;border-radius:15px;max-width:500px;width:90%">
        <h3 style="color:#333;margin-bottom:20px">æç¤º</h3>
        <p style="color:#666;margin-bottom:30px;white-space:pre-wrap">${msg}</p>
        <div class="flex justify-end gap-10">
          <button class="btn btn-red" onclick="this.closest('.modal').remove();resolve(false)">${cancelText}</button>
          <button class="btn" onclick="this.closest('.modal').remove();resolve(true)">${okText}</button>
        </div>
      </div>
    `; modal.classList.add('modal'); document.body.appendChild(modal);
  });
}
</script>
</body>
</html>
