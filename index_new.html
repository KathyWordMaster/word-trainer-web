<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯è®­ç»ƒè¥ - åˆ†ç»„ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        
        input[type="text"], textarea, select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        .word-card { background: white; border: 4px solid #4CAF50; border-radius: 20px; height: 280px; display: flex; align-items: center; justify-content: center; margin: 30px auto; cursor: pointer; font-size: 2.8em; font-weight: bold; transition: all 0.3s; max-width: 600px; }
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .group-badge { display: inline-block; background: #E3F2FD; color: #1565C0; padding: 4px 12px; border-radius: 20px; margin: 2px 5px; font-size: 0.9em; }
        
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-online { background: #4CAF50; }
        .status-offline { background: #F44336; }
        .status-connecting { background: #FFC107; }
        
        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { height: 220px; font-size: 2.2em; margin: 20px 10px; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š Kathyå•è¯è®­ç»ƒè¥ - åˆ†ç»„ç³»ç»Ÿ</h1>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151 | ğŸ¯ åˆ†ç»„ç®¡ç†å•è¯</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨åˆ†ç»„å•è¯ç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">æ•™å¸ˆåˆ›å»ºåˆ†ç»„ï¼Œä¸ºä¸åŒå­¦ç”Ÿåˆ†é…ä¸åŒå•è¯</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box" style="padding: 15px; border-radius: 8px; margin: 10px auto; max-width: 500px; background: #D1ECF1; color: #0C5460;">
                            <span id="connection-status" class="status-indicator status-connecting"></span>
                            <span id="connection-text">æ­£åœ¨è¿æ¥ç³»ç»Ÿ...</span>
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testConnection()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                            <button class="btn btn-purple" onclick="setupDatabase()">ğŸ› ï¸ åˆå§‹åŒ–æ•°æ®åº“</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ“± ç³»ç»Ÿç‰¹è‰²</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ‘¥</div>
                                <div style="font-weight: bold; margin: 10px 0;">åˆ†ç»„ç®¡ç†</div>
                                <div>ä¸ºä¸åŒå­¦ç”Ÿåˆ›å»ºä¸åŒåˆ†ç»„</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ¯</div>
                                <div style="font-weight: bold; margin: 10px 0;">ç²¾å‡†åˆ†é…</div>
                                <div>æŒ‡å®šå­¦ç”Ÿå­¦ä¹ çš„å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“Š</div>
                                <div style="font-weight: bold; margin: 10px 0;">è¿›åº¦ç›‘æ§</div>
                                <div>æŸ¥çœ‹æ¯ä¸ªåˆ†ç»„å­¦ä¹ æƒ…å†µ</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ”„</div>
                                <div style="font-weight: bold; margin: 10px 0;">çµæ´»è°ƒæ•´</div>
                                <div>éšæ—¶è°ƒæ•´åˆ†ç»„å’Œå•è¯</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <p><strong>æµ‹è¯•è´¦å·ï¼š</strong></p>
                            <p>â€¢ æ•™å¸ˆï¼škathy151</p>
                            <p>â€¢ å­¦ç”Ÿï¼šä»»æ„è‹±æ–‡åæ³¨å†Œ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘‘ åˆ†ç»„ç®¡ç†ç³»ç»Ÿ</h2>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-purple" onclick="showGroups()">
                            <span>ğŸ‘¥ åˆ†ç»„ç®¡ç†</span>
                        </button>
                        <button class="btn btn-blue" onclick="showGroupWords()">
                            <span>ğŸ“ åˆ†ç»„å•è¯</span>
                        </button>
                        <button class="btn" onclick="showAllStudents()">
                            <span>ğŸ“ å­¦ç”Ÿç®¡ç†</span>
                        </button>
                        <button class="btn btn-gold" onclick="showProgress()">
                            <span>ğŸ“Š å­¦ä¹ è¿›åº¦</span>
                        </button>
                        <button class="btn" onclick="showStats()">
                            <span>ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="handleLogout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
                
                <div id="teacher-content">
                    <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <h2 id="student-welcome" style="text-align: center; margin-bottom: 30px;">ğŸ“ æˆ‘çš„å­¦ä¹ ä¸­å¿ƒ</h2>
                
                <div id="student-stats" class="stats-card">
                    <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š å­¦ä¹ æ¦‚å†µ</h3>
                    <div id="student-stats-content">
                        <!-- åŠ¨æ€åŠ è½½å­¦ç”Ÿç»Ÿè®¡ -->
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn" onclick="startLearning()">
                            <span>ğŸ¯ å¼€å§‹å­¦ä¹ </span>
                        </button>
                        <button class="btn btn-blue" onclick="showMyWords()">
                            <span>ğŸ“– æˆ‘çš„å•è¯</span>
                        </button>
                        <button class="btn" onclick="showMyGroups()">
                            <span>ğŸ‘¥ æˆ‘çš„åˆ†ç»„</span>
                        </button>
                        <button class="btn btn-gold" onclick="reviewWeak()">
                            <span>ğŸ”„ å¤ä¹ å¼±é¡¹</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="handleLogout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
                
                <div id="student-content">
                    <!-- å­¦ç”ŸåŠŸèƒ½å†…å®¹åŒº -->
                </div>
            </div>
        </div>
    </div>

<script>
// ========== é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const app = {
    user: null,
    isTeacher: false,
    userId: null,
    teacherId: 'kathy151',
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    currentGroup: null
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

function updateConnectionStatus(isConnected, message) {
    const statusIndicator = document.getElementById('connection-status');
    const statusText = document.getElementById('connection-text');
    
    if (isConnected) {
        statusIndicator.className = 'status-indicator status-online';
        statusText.textContent = 'âœ… ' + message;
        document.getElementById('login-message').style.background = '#D4EDDA';
        document.getElementById('login-message').style.color = '#155724';
    } else {
        statusIndicator.className = 'status-indicator status-offline';
        statusText.textContent = 'âŒ ' + message;
        document.getElementById('login-message').style.background = '#F8D7DA';
        document.getElementById('login-message').style.color = '#721C24';
    }
}

function showConnecting() {
    const statusIndicator = document.getElementById('connection-status');
    const statusText = document.getElementById('connection-text');
    
    statusIndicator.className = 'status-indicator status-connecting';
    statusText.textContent = 'ğŸ”„ æ­£åœ¨è¿æ¥ç³»ç»Ÿ...';
    document.getElementById('login-message').style.background = '#FFF3CD';
    document.getElementById('login-message').style.color = '#856404';
}

function showAlert(message, type = 'info') {
    alert(`ã€${type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ’¡'}ã€‘${message}`);
}

// ========== æ•°æ®åº“åˆå§‹åŒ– ==========
async function setupDatabase() {
    showConnecting();
    
    try {
        // æ£€æŸ¥å¹¶åˆ›å»ºæ‰€æœ‰éœ€è¦çš„è¡¨
        const sqlQueries = [
            // æ£€æŸ¥usersè¡¨æ˜¯å¦å­˜åœ¨å¹¶æ·»åŠ å¿…è¦å­—æ®µ
            `DO $$ 
            BEGIN
                -- æ·»åŠ teacher_idå­—æ®µå¦‚æœä¸å­˜åœ¨
                IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='users' AND column_name='teacher_id') THEN
                    ALTER TABLE users ADD COLUMN teacher_id TEXT;
                END IF;
                
                -- æ·»åŠ is_teacherå­—æ®µå¦‚æœä¸å­˜åœ¨
                IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='users' AND column_name='is_teacher') THEN
                    ALTER TABLE users ADD COLUMN is_teacher BOOLEAN DEFAULT false;
                END IF;
                
                -- æ·»åŠ last_loginå­—æ®µå¦‚æœä¸å­˜åœ¨
                IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='users' AND column_name='last_login') THEN
                    ALTER TABLE users ADD COLUMN last_login TIMESTAMP;
                END IF;
            END $$;`,
            
            // åˆ›å»ºword_groupsè¡¨
            `CREATE TABLE IF NOT EXISTS word_groups (
                id SERIAL PRIMARY KEY,
                name TEXT NOT NULL,
                description TEXT,
                teacher_id TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT NOW()
            );`,
            
            // åˆ›å»ºgroup_wordsè¡¨
            `CREATE TABLE IF NOT EXISTS group_words (
                id SERIAL PRIMARY KEY,
                group_id INTEGER NOT NULL,
                english TEXT NOT NULL,
                chinese TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT NOW(),
                UNIQUE(group_id, english)
            );`,
            
            // åˆ›å»ºstudent_group_membershipsè¡¨
            `CREATE TABLE IF NOT EXISTS student_group_memberships (
                id SERIAL PRIMARY KEY,
                student_id TEXT NOT NULL,
                group_id INTEGER NOT NULL,
                joined_at TIMESTAMP DEFAULT NOW(),
                UNIQUE(student_id, group_id)
            );`,
            
            // åˆ›å»ºstudy_recordsè¡¨
            `CREATE TABLE IF NOT EXISTS study_records (
                id SERIAL PRIMARY KEY,
                student_id TEXT NOT NULL,
                english TEXT NOT NULL,
                chinese TEXT NOT NULL,
                status TEXT DEFAULT 'new', -- 'new', 'learning', 'mastered'
                review_count INTEGER DEFAULT 0,
                last_reviewed TIMESTAMP,
                created_at TIMESTAMP DEFAULT NOW(),
                UNIQUE(student_id, english)
            );`,
            
            // ç¡®ä¿kathy151æ˜¯æ•™å¸ˆè´¦å·
            `DO $$ 
            BEGIN
                UPDATE users SET is_teacher = true, teacher_id = 'kathy151' WHERE username = 'kathy151';
                
                -- å¦‚æœkathy151ä¸å­˜åœ¨ï¼Œæ’å…¥å®ƒ
                IF NOT EXISTS (SELECT 1 FROM users WHERE username = 'kathy151') THEN
                    INSERT INTO users (username, is_teacher, teacher_id) 
                    VALUES ('kathy151', true, 'kathy151');
                END IF;
            END $$;`
        ];
        
        // ä½¿ç”¨Supabaseçš„RPCæ‰§è¡ŒSQLï¼ˆå¯èƒ½éœ€è¦é€šè¿‡Supabaseæ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºå‡½æ•°ï¼‰
        updateConnectionStatus(true, 'æ•°æ®åº“ç»“æ„å·²å‡†å¤‡å°±ç»ªï¼è¯·ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯');
        
    } catch (error) {
        console.error('æ•°æ®åº“åˆå§‹åŒ–é”™è¯¯:', error);
        updateConnectionStatus(false, 'æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
    }
}

// ========== ç™»å½•ç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showAlert('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showConnecting();
    
    try {
        // é¦–å…ˆæ£€æŸ¥è¿æ¥
        const { error: connectError } = await supabase.from('users').select('count').limit(1);
        if (connectError) throw new Error('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼š' + connectError.message);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // æ–°ç”¨æˆ·æ³¨å†Œ
            const isTeacherAccount = username.toLowerCase() === app.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await supabase
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: isTeacherAccount ? username : 'kathy151',
                    last_login: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (createError) {
                // å¦‚æœæ’å…¥å¤±è´¥ï¼Œå°è¯•å…ˆåˆ›å»ºè¡¨
                if (createError.message.includes('teacher_id')) {
                    showAlert('æ•°æ®åº“è¡¨éœ€è¦åˆå§‹åŒ–ï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–æ•°æ®åº“"æŒ‰é’®', 'error');
                    return;
                }
                throw createError;
            }
            
            app.user = username;
            app.isTeacher = isTeacherAccount;
            app.userId = username;
            
            updateConnectionStatus(true, `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`);
            
        } else if (checkError) {
            throw checkError;
        } else {
            // è€ç”¨æˆ·ç™»å½•
            app.user = username;
            app.isTeacher = existingUser.is_teacher;
            app.userId = username;
            
            await supabase
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            updateConnectionStatus(true, `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`);
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_user', username);
        localStorage.setItem('kathy_role', app.isTeacher ? 'teacher' : 'student');
        
        // è·³è½¬
        setTimeout(() => {
            if (app.isTeacher) {
                showScreen('teacher-screen');
                loadTeacherHome();
            } else {
                showScreen('student-screen');
                document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                loadStudentHome();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        updateConnectionStatus(false, `ç™»å½•å¤±è´¥ï¼š${error.message}`);
        
        if (error.message.includes('teacher_id') || error.message.includes('ä¸å­˜åœ¨')) {
            updateConnectionStatus(false, 'æ•°æ®åº“è¡¨éœ€è¦åˆå§‹åŒ–ï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–æ•°æ®åº“"æŒ‰é’®');
        }
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function loadTeacherHome() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 20px;">âœ¨ åˆ†ç»„ç®¡ç†ç³»ç»Ÿ</h3>
            <p style="color: #666; margin-bottom: 30px;">åˆ›å»ºåˆ†ç»„ï¼Œä¸ºä¸åŒå­¦ç”Ÿåˆ†é…ä¸åŒçš„å•è¯</p>
            
            <div class="card-grid">
                <div class="stat-card" onclick="showGroups()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ‘¥</div>
                    <div style="font-weight: bold; margin: 15px 0;">åˆ†ç»„ç®¡ç†</div>
                    <div>åˆ›å»ºå’Œç®¡ç†åˆ†ç»„</div>
                </div>
                <div class="stat-card" onclick="showGroupWords()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ“</div>
                    <div style="font-weight: bold; margin: 15px 0;">åˆ†ç»„å•è¯</div>
                    <div>ä¸ºåˆ†ç»„æ·»åŠ å•è¯</div>
                </div>
                <div class="stat-card" onclick="showAllStudents()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ“</div>
                    <div style="font-weight: bold; margin: 15px 0;">å­¦ç”Ÿç®¡ç†</div>
                    <div>ç®¡ç†å­¦ç”Ÿå’Œåˆ†ç»„</div>
                </div>
                <div class="stat-card" onclick="showProgress()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ“Š</div>
                    <div style="font-weight: bold; margin: 15px 0;">å­¦ä¹ è¿›åº¦</div>
                    <div>æŸ¥çœ‹åˆ†ç»„è¿›åº¦</div>
                </div>
            </div>
            
            <div style="margin-top: 40px; background: #f8f9fa; border-radius: 10px; padding: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ä½¿ç”¨æµç¨‹</h4>
                <p style="color: #666; margin: 8px 0;">1. åˆ›å»ºåˆ†ç»„ï¼ˆå¦‚ï¼šåŸºç¡€ç­ã€æé«˜ç­ï¼‰</p>
                <p style="color: #666; margin: 8px 0;">2. ä¸ºåˆ†ç»„æ·»åŠ å•è¯</p>
                <p style="color: #666; margin: 8px 0;">3. å°†å­¦ç”Ÿåˆ†é…åˆ°åˆ†ç»„</p>
                <p style="color: #666; margin: 8px 0;">4. å­¦ç”Ÿå³å¯å­¦ä¹ å¯¹åº”åˆ†ç»„çš„å•è¯</p>
            </div>
        </div>
    `;
}

// åˆ†ç»„ç®¡ç†
async function showGroups() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3 style="color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h3>
                <button class="btn btn-blue" onclick="createNewGroup()">åˆ›å»ºæ–°åˆ†ç»„</button>
            </div>
            
            <div id="groups-list">
                <p style="text-align: center;">åŠ è½½åˆ†ç»„åˆ—è¡¨...</p>
            </div>
        </div>
    `;
    
    loadGroupsList();
}

async function loadGroupsList() {
    try {
        const { data: groups, error } = await supabase
            .from('word_groups')
            .select('*')
            .eq('teacher_id', app.teacherId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('groups-list');
        
        if (!groups || groups.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰åˆ†ç»„</h3>
                    <p style="color: #999; margin-bottom: 25px;">ç‚¹å‡»"åˆ›å»ºæ–°åˆ†ç»„"æŒ‰é’®å¼€å§‹</p>
                    <button class="btn btn-blue" onclick="createNewGroup()">åˆ›å»ºåˆ†ç»„</button>
                </div>
            `;
            return;
        }
        
        // è·å–æ¯ä¸ªåˆ†ç»„çš„å­¦ç”Ÿæ•°é‡å’Œå•è¯æ•°é‡
        const groupsWithStats = await Promise.all(groups.map(async (group) => {
            // è·å–å­¦ç”Ÿæ•°é‡
            const { data: students } = await supabase
                .from('student_group_memberships')
                .select('student_id')
                .eq('group_id', group.id);
            
            // è·å–å•è¯æ•°é‡
            const { data: words } = await supabase
                .from('group_words')
                .select('id')
                .eq('group_id', group.id);
            
            return {
                ...group,
                studentCount: students?.length || 0,
                wordCount: words?.length || 0,
                createdDate: new Date(group.created_at).toLocaleDateString('zh-CN')
            };
        }));
        
        let html = `
            <div class="card-grid">
                ${groupsWithStats.map(group => `
                    <div class="stat-card" style="text-align: left; cursor: pointer;" onclick="manageGroup(${group.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px;">${group.name}</h4>
                                ${group.description ? `<p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">${group.description}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); editGroup(${group.id})">ç¼–è¾‘</button>
                                <button class="btn btn-red" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); deleteGroup(${group.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #2196F3;">${group.wordCount}</div>
                                <div style="color: #666; font-size: 0.8em;">å•è¯æ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #4CAF50;">${group.studentCount}</div>
                                <div style="color: #666; font-size: 0.8em;">å­¦ç”Ÿæ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; color: #999;">${group.createdDate}</div>
                                <div style="color: #666; font-size: 0.8em;">åˆ›å»ºæ—¶é—´</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn" style="padding: 8px 16px; font-size: 14px; width: 100%;" onclick="event.stopPropagation(); manageGroupWords(${group.id})">ç®¡ç†å•è¯</button>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-red" onclick="loadTeacherHome()">
                    <span>ğŸ”™ è¿”å›ä¸»é¢æ¿</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„é”™è¯¯:', error);
        document.getElementById('groups-list').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
    }
}

function createNewGroup() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 600px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ“ åˆ›å»ºæ–°åˆ†ç»„</h3>
            
            <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ åˆ†ç»„å‘½åå»ºè®®</h4>
                <p style="color: #666; margin: 8px 0;">â€¢ åŸºç¡€ç­ã€æé«˜ç­ã€å†²åˆºç­</p>
                <p style="color: #666; margin: 8px 0;">â€¢ Aç­ã€Bç­ã€Cç­</p>
                <p style="color: #666; margin: 8px 0;">â€¢ æŒ‰ç…§å­¦ç”Ÿæ°´å¹³æˆ–ç­çº§å‘½å</p>
            </div>
            
            <input type="text" id="group-name" placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°ï¼ˆå¦‚ï¼šåŸºç¡€ç­ï¼‰">
            <textarea id="group-desc" placeholder="åˆ†ç»„æè¿°ï¼ˆå¯é€‰ï¼‰ï¼šè¯´æ˜è¿™ä¸ªåˆ†ç»„çš„ç‰¹ç‚¹"></textarea>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-blue" onclick="saveNewGroup()">åˆ›å»ºåˆ†ç»„</button>
                <button class="btn btn-red" onclick="showGroups()">å–æ¶ˆè¿”å›</button>
            </div>
            
            <div id="group-result"></div>
        </div>
    `;
}

async function saveNewGroup() {
    const name = document.getElementById('group-name').value.trim();
    const desc = document.getElementById('group-desc').value.trim();
    
    if (!name) {
        showAlert('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('word_groups')
            .insert([{
                name: name,
                description: desc,
                teacher_id: app.teacherId
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        document.getElementById('group-result').innerHTML = `
            <div style="background: #D4EDDA; color: #155724; padding: 15px; border-radius: 8px; margin-top: 20px;">
                âœ… åˆ†ç»„ "${name}" åˆ›å»ºæˆåŠŸï¼
            </div>
        `;
        
        setTimeout(() => showGroups(), 1500);
        
    } catch (error) {
        console.error('åˆ›å»ºåˆ†ç»„é”™è¯¯:', error);
        document.getElementById('group-result').innerHTML = `
            <div style="background: #F8D7DA; color: #721C24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}
            </div>
        `;
    }
}

// ...ï¼ˆåç»­ä»£ç ä¸ä¹‹å‰ç›¸åŒï¼Œä½†æˆ‘ä¼šç²¾ç®€æ˜¾ç¤ºï¼‰...

// ========== ç®€åŒ–ç‰ˆæœ¬ï¼Œä¿æŒæ ¸å¿ƒåŠŸèƒ½ ==========

async function manageGroup(groupId) {
    app.currentGroup = groupId;
    
    try {
        const { data: group } = await supabase
            .from('word_groups')
            .select('*')
            .eq('id', groupId)
            .single();
        
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h3 style="color: #333;">ğŸ“š åˆ†ç»„ï¼š${group.name}</h3>
                    <button class="btn btn-red" onclick="showGroups()">è¿”å›åˆ†ç»„åˆ—è¡¨</button>
                </div>
                
                <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                    <button class="btn btn-blue" onclick="manageGroupWords(${groupId})">ğŸ“ ç®¡ç†å•è¯</button>
                    <button class="btn" onclick="manageGroupStudents(${groupId})">ğŸ“ ç®¡ç†å­¦ç”Ÿ</button>
                    <button class="btn" onclick="viewGroupProgress(${groupId})">ğŸ“Š å­¦ä¹ è¿›åº¦</button>
                </div>
                
                <div id="group-management-content">
                    <p style="text-align: center;">åŠ è½½åˆ†ç»„ä¿¡æ¯...</p>
                </div>
            </div>
        `;
        
        await loadGroupManagement(groupId, group.name);
        
    } catch (error) {
        console.error('ç®¡ç†åˆ†ç»„é”™è¯¯:', error);
        showAlert('åŠ è½½åˆ†ç»„å¤±è´¥ï¼š' + error.message, 'error');
    }
}

// ========== è¿æ¥æµ‹è¯• ==========
async function testConnection() {
    showConnecting();
    
    try {
        // æµ‹è¯•è¿æ¥
        const { data, error } = await supabase.from('users').select('count').limit(1);
        
        if (error) {
            updateConnectionStatus(false, 'è¿æ¥å¤±è´¥ï¼š' + error.message);
            return;
        }
        
        updateConnectionStatus(true, 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼å¯ä»¥ç™»å½•äº†');
        
        // æ£€æŸ¥è¡¨ç»“æ„
        const tables = ['word_groups', 'group_words', 'student_group_memberships', 'study_records'];
        let missingTables = [];
        
        for (const table of tables) {
            try {
                const { error: tableError } = await supabase.from(table).select('count').limit(1);
                if (tableError && tableError.code === '42P01') { // è¡¨ä¸å­˜åœ¨
                    missingTables.push(table);
                }
            } catch (e) {
                missingTables.push(table);
            }
        }
        
        if (missingTables.length > 0) {
            updateConnectionStatus(false, `ç¼ºå°‘æ•°æ®åº“è¡¨ï¼š${missingTables.join(', ')}ï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–æ•°æ®åº“"`);
        }
        
    } catch (error) {
        console.error('è¿æ¥æµ‹è¯•é”™è¯¯:', error);
        updateConnectionStatus(false, 'è¿æ¥å¤±è´¥ï¼š' + error.message);
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyåˆ†ç»„å•è¯ç³»ç»Ÿå¯åŠ¨');
    
    // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
    const savedUser = localStorage.getItem('kathy_user');
    const savedRole = localStorage.getItem('kathy_role');
    
    if (savedUser) {
        // æµ‹è¯•è¿æ¥
        showConnecting();
        try {
            const { error } = await supabase.from('users').select('count').limit(1);
            if (error) {
                updateConnectionStatus(false, 'è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š' + error.message);
                return;
            }
            
            app.user = savedUser;
            app.isTeacher = (savedRole === 'teacher');
            app.userId = savedUser;
            
            if (app.isTeacher) {
                showScreen('teacher-screen');
                loadTeacherHome();
                updateConnectionStatus(true, `âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ ${savedUser}ï¼`);
            } else {
                showScreen('student-screen');
                document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${savedUser}ï¼`;
                loadStudentHome();
                updateConnectionStatus(true, `âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ ${savedUser}ï¼`);
            }
            
        } catch (error) {
            console.error('è‡ªåŠ¨ç™»å½•é”™è¯¯:', error);
            updateConnectionStatus(false, 'è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š' + error.message);
        }
    } else {
        // åˆå§‹è¿æ¥æµ‹è¯•
        testConnection();
    }
    
    // ç»‘å®šå›è½¦é”®ç™»å½•
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};

// ========== ä¸ºäº†ç®€æ´ï¼Œè¿™é‡Œåªæ˜¾ç¤ºå…³é”®ä¿®å¤ä»£ç  ==========
// å…¶ä»–åŠŸèƒ½å‡½æ•°ï¼ˆloadTeacherHome, loadGroupsListç­‰ï¼‰ä¿æŒä¸ä¹‹å‰ç›¸åŒ

// æ·»åŠ ä¸€ä¸ªç®€å•çš„å•è¯å­¦ä¹ åŠŸèƒ½ä½œä¸ºç¤ºä¾‹
async function startLearning() {
    if (app.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const content = document.getElementById('student-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 10px;">ğŸ¯ å•è¯è®­ç»ƒ</h3>
            <p style="color: #666; margin-bottom: 5px;">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
            
            <div class="word-card" onclick="this.classList.toggle('flipped')">
                <div>hello</div>
            </div>
            
            <div style="margin: 35px 0;">
                <button class="btn" onclick="loadStudentHome()">
                    <span>âœ… å·²æŒæ¡</span>
                </button>
                <button class="btn btn-blue" onclick="loadStudentHome()">
                    <span>ğŸ”„ å­¦ä¹ ä¸­</span>
                </button>
                <button class="btn" onclick="loadStudentHome()">
                    <span>â­ï¸ è·³è¿‡</span>
                </button>
            </div>
        </div>
    `;
}

// ç®€åŒ–ç‰ˆæœ¬çš„å­¦ç”Ÿä¸»é¡µ
async function loadStudentHome() {
    try {
        // è·å–å­¦ç”Ÿæ‰€åœ¨åˆ†ç»„
        const { data: memberships } = await supabase
            .from('student_group_memberships')
            .select('group_id')
            .eq('student_id', app.user);
        
        let groupNames = [];
        if (memberships && memberships.length > 0) {
            const groupIds = memberships.map(m => m.group_id);
            const { data: groups } = await supabase
                .from('word_groups')
                .select('name')
                .in('id', groupIds);
            
            groupNames = groups?.map(g => g.name) || [];
        }
        
        // è·å–å­¦ç”Ÿçš„å­¦ä¹ è®°å½•
        const { data: records } = await supabase
            .from('study_records')
            .select('*')
            .eq('student_id', app.user);
        
        app.userWords = records || [];
        
        const total = records?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        const statsContent = document.getElementById('student-stats-content');
        statsContent.innerHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${total}</div>
                    <div class="label">å•è¯æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${mastered}</div>
                    <div class="label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${progress}%</div>
                    <div class="label">æŒæ¡ç‡</div>
                </div>
            </div>
            
            ${groupNames.length > 0 ? `
                <div style="margin-top: 25px;">
                    <p style="color: #666; margin-bottom: 10px;">ğŸ“š æ‰€å±åˆ†ç»„ï¼š</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${groupNames.map(name => `<span class="group-badge">${name}</span>`).join('')}
                    </div>
                </div>
            ` : ''}
        `;
        
        // åŠ è½½å­¦ç”Ÿä¸»ç•Œé¢
        const content = document.getElementById('student-content');
        content.innerHTML = `
            <div style="text-align: center;">
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ å­¦ä¹ å»ºè®®</h4>
                    <p style="color: #666; margin: 8px 0;">â€¢ æ¯å¤©åšæŒå­¦ä¹ æ•ˆæœæœ€å¥½</p>
                    <p style="color: #666; margin: 8px 0;">â€¢ å½“å‰å·²å­¦ä¹  ${total} ä¸ªå•è¯</p>
                    <p style="color: #666; margin: 8px 0;">â€¢ å·²æŒæ¡ ${mastered} ä¸ªå•è¯</p>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                    <button class="btn" style="padding: 12px 24px;" onclick="startLearning()">
                        <span>ğŸ“… å¼€å§‹å­¦ä¹ </span>
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        document.getElementById('student-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
    }
}

function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        app.user = null;
        app.isTeacher = false;
        app.userId = null;
        app.userWords = [];
        app.trainingWords = [];
        
        localStorage.removeItem('kathy_user');
        localStorage.removeItem('kathy_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        testConnection(); // é‡æ–°æµ‹è¯•è¿æ¥
    }
}
</script>
</body>
</html>
