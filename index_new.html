<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯è®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .main-content { padding: 30px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; margin: 10px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #45a049; }
        .btn-blue { background: #2196F3; }
        .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #f44336; }
        .btn-red:hover { background: #d32f2f; }
        input[type="text"], textarea { width: 100%; max-width: 400px; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; }
        textarea { height: 150px; }
        .word-card { background: white; border: 3px solid #4CAF50; border-radius: 15px; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; font-size: 2em; font-weight: bold; max-width: 500px; }
        .stats-card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 15px 0; border-left: 5px solid #4CAF50; }
        .progress-bar { width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 10px 0; }
        .progress-fill { height: 100%; background: #4CAF50; width: 0%; }
        .message { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.info { background: #d1ecf1; color: #0c5460; }
        #word-input { display: block; margin: 20px auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š Kathyå•è¯è®­ç»ƒè¥</h1>
            <p>æ•™å¸ˆï¼šKathy | å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <h2 style="text-align: center; margin-bottom: 30px;">æ¬¢è¿ä½¿ç”¨</h2>
                <div style="text-align: center;">
                    <input type="text" id="username" placeholder="ç”¨æˆ·å" style="display: block; margin: 20px auto;">
                    <div id="login-message" class="message info">è¯·è¾“å…¥ç”¨æˆ·åç™»å½•æˆ–æ³¨å†Œ</div>
                    <button class="btn" onclick="login()">ç™»å½•/æ³¨å†Œ</button>
                    <button class="btn btn-blue" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <p><strong>æµ‹è¯•è´¦å·ï¼š</strong></p>
                    <p>â€¢ æ•™å¸ˆï¼škathy151</p>
                    <p>â€¢ å­¦ç”Ÿï¼štom (æˆ–ä»»æ„è‹±æ–‡åæ³¨å†Œ)</p>
                </div>
            </div>

            <!-- æ•™å¸ˆç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 20px;">ğŸ‘©â€ğŸ« æ•™å¸ˆæ§åˆ¶å°</h2>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" id="btn-upload-words">ä¸Šä¼ å•è¯</button>
                    <button class="btn btn-blue" id="btn-view-students">æŸ¥çœ‹å­¦ç”Ÿ</button>
                    <button class="btn" id="btn-view-stats">æŸ¥çœ‹ç»Ÿè®¡</button>
                    <button class="btn btn-red" id="btn-logout-teacher">é€€å‡º</button>
                </div>
                
                <div id="teacher-content">
                    <p style="text-align: center;">æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>

            <!-- å­¦ç”Ÿç•Œé¢ -->
            <div id="student-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 20px;" id="student-name">ğŸ“ å­¦ç”Ÿç•Œé¢</h2>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" id="btn-start-learning">å¼€å§‹å­¦ä¹ </button>
                    <button class="btn btn-blue" id="btn-my-progress">æˆ‘çš„è¿›åº¦</button>
                    <button class="btn btn-red" id="btn-logout-student">é€€å‡º</button>
                </div>
                
                <div id="student-content">
                    <p style="text-align: center;">æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>
        </div>
    </div>

<script>
// ========== é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
let currentUser = null;
let isTeacher = false;
let trainingWords = [];
let currentWordIndex = 0;
let isCardFlipped = false;

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆ');
    
    // ç»‘å®šæ•™å¸ˆæŒ‰é’®äº‹ä»¶
    document.getElementById('btn-upload-words')?.addEventListener('click', showUploadWords);
    document.getElementById('btn-view-students')?.addEventListener('click', showAllStudents);
    document.getElementById('btn-view-stats')?.addEventListener('click', showStatistics);
    document.getElementById('btn-logout-teacher')?.addEventListener('click', logout);
    
    // ç»‘å®šå­¦ç”ŸæŒ‰é’®äº‹ä»¶
    document.getElementById('btn-start-learning')?.addEventListener('click', startLearning);
    document.getElementById('btn-my-progress')?.addEventListener('click', showMyProgress);
    document.getElementById('btn-logout-student')?.addEventListener('click', logout);
    
    // æµ‹è¯•å›è½¦é”®ç™»å½•
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
    });
    
    // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
    checkAutoLogin();
    
    // æµ‹è¯•è¿æ¥
    testConnection();
});

// ========== é¡µé¢åˆ‡æ¢ ==========
function showScreen(screenId) {
    console.log('åˆ‡æ¢åˆ°å±å¹•:', screenId);
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
}

// ========== æ¶ˆæ¯æ˜¾ç¤º ==========
function showMessage(elementId, message, type = 'info') {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.className = `message ${type}`;
    element.style.display = 'block';
}

// ========== è‡ªåŠ¨ç™»å½•æ£€æŸ¥ ==========
async function checkAutoLogin() {
    const savedUser = localStorage.getItem('current_user');
    const savedRole = localStorage.getItem('user_role');
    
    if (savedUser) {
        currentUser = savedUser;
        isTeacher = (savedRole === 'teacher');
        
        if (isTeacher) {
            showScreen('teacher-screen');
            loadTeacherDashboard();
        } else {
            showScreen('student-screen');
            document.getElementById('student-name').textContent = `ğŸ“ ${savedUser} çš„å­¦ä¹ ç•Œé¢`;
            loadStudentDashboard();
        }
    }
}

// ========== æ•°æ®åº“æµ‹è¯• ==========
async function testConnection() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
    try {
        const { data, error } = await supabase.from('users').select('count');
        if (error) throw error;
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
        console.error('è¿æ¥é”™è¯¯:', error);
    }
}

// ========== ç™»å½•/æ³¨å†Œ ==========
async function login() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'info');
    
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
            const isTeacherAccount = username.toLowerCase() === 'kathy151';
            
            const { data: newUser, error: createError } = await supabase
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            currentUser = username;
            isTeacher = isTeacherAccount;
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
        } else if (checkError) {
            throw checkError;
        } else {
            // ç”¨æˆ·å·²å­˜åœ¨
            currentUser = username;
            isTeacher = existingUser.is_teacher;
            
            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            await supabase
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('current_user', username);
        localStorage.setItem('user_role', isTeacher ? 'teacher' : 'student');
        
        // è·³è½¬åˆ°å¯¹åº”ç•Œé¢
        setTimeout(() => {
            if (isTeacher) {
                showScreen('teacher-screen');
                loadTeacherDashboard();
            } else {
                showScreen('student-screen');
                document.getElementById('student-name').textContent = `ğŸ“ ${username} çš„å­¦ä¹ ç•Œé¢`;
                loadStudentDashboard();
            }
        }, 1000);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function loadTeacherDashboard() {
    console.log('åŠ è½½æ•™å¸ˆé¢æ¿');
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p style="text-align: center;">åŠ è½½ä¸­...</p>';
    
    try {
        // è·å–ç»Ÿè®¡ä¿¡æ¯
        const { data: words, error: wordsError } = await supabase
            .from('words')
            .select('*')
            .eq('teacher_id', 'kathy151');
        
        const { data: students, error: studentsError } = await supabase
            .from('users')
            .select('*')
            .eq('is_teacher', false);
        
        const { data: records, error: recordsError } = await supabase
            .from('study_records')
            .select('*');
        
        const totalWords = words?.length || 0;
        const totalStudents = students?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        
        content.innerHTML = `
            <div class="stats-card">
                <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                <p>å•è¯æ€»æ•°ï¼š${totalWords}</p>
                <p>å­¦ç”Ÿäººæ•°ï¼š${totalStudents}</p>
                <p>å·²æŒæ¡å•è¯ï¼š${mastered}</p>
                <p>æ•™å¸ˆï¼šKathy</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <p>ğŸ’¡ æ‚¨å·²ç»ä¸Šä¼ äº† ${totalWords} ä¸ªå•è¯ï¼Œæœ‰ ${totalStudents} ä¸ªå­¦ç”Ÿåœ¨å­¦ä¹ </p>
                <button class="btn" style="margin-top: 20px;" onclick="showUploadWords()">ä¸Šä¼ æ–°å•è¯</button>
            </div>
        `;
    } catch (error) {
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function showUploadWords() {
    console.log('æ˜¾ç¤ºä¸Šä¼ å•è¯ç•Œé¢');
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <h3>ğŸ“ ä¸Šä¼ å•è¯</h3>
        <p>æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼šè‹±æ–‡ ä¸­æ–‡</p>
        <textarea id="word-input" placeholder="ä¾‹å¦‚ï¼š
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ"></textarea>
        <div style="text-align: center;">
            <button class="btn" onclick="uploadWords()">ä¸Šä¼ </button>
            <button class="btn" onclick="loadTeacherDashboard()">è¿”å›</button>
        </div>
        <div id="upload-result"></div>
    `;
}

async function uploadWords() {
    console.log('å¼€å§‹ä¸Šä¼ å•è¯');
    const textarea = document.getElementById('word-input');
    const input = textarea ? textarea.value.trim() : '';
    
    if (!input) {
        alert('è¯·è¾“å…¥å•è¯');
        return;
    }
    
    const lines = input.split('\n');
    const wordsToAdd = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            wordsToAdd.push({ teacher_id: 'kathy151', english, chinese });
        }
    });
    
    if (wordsToAdd.length === 0) {
        alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆå•è¯');
        return;
    }
    
    try {
        // æ’å…¥å•è¯åˆ°æ•°æ®åº“
        const { error } = await supabase
            .from('words')
            .insert(wordsToAdd);
        
        if (error) throw error;
        
        // ä¸ºæ‰€æœ‰å­¦ç”Ÿåˆ›å»ºå­¦ä¹ è®°å½•
        const { data: students } = await supabase
            .from('users')
            .select('username')
            .eq('is_teacher', false);
        
        if (students && students.length > 0) {
            const studyRecords = [];
            students.forEach(student => {
                wordsToAdd.forEach(word => {
                    studyRecords.push({
                        student_id: student.username,
                        english: word.english,
                        chinese: word.chinese,
                        status: 'new'
                    });
                });
            });
            
            await supabase.from('study_records').insert(studyRecords);
        }
        
        document.getElementById('upload-result').innerHTML = 
            `<div class="message success">âœ… æˆåŠŸä¸Šä¼  ${wordsToAdd.length} ä¸ªå•è¯ï¼</div>`;
        
        setTimeout(() => {
            loadTeacherDashboard();
        }, 1500);
        
    } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        document.getElementById('upload-result').innerHTML = 
            `<div class="message error">âŒ ä¸Šä¼ å¤±è´¥ï¼š${error.message}</div>`;
    }
}

async function showAllStudents() {
    console.log('æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨');
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p>åŠ è½½å­¦ç”Ÿåˆ—è¡¨...</p>';
    
    try {
        const { data: students, error } = await supabase
            .from('users')
            .select('*')
            .eq('is_teacher', false)
            .order('last_login', { ascending: false });
        
        if (error) throw error;
        
        if (!students || students.length === 0) {
            content.innerHTML = '<p>è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>';
            return;
        }
        
        let html = '<h3>ğŸ‘¥ å­¦ç”Ÿåˆ—è¡¨</h3><table style="width:100%; border-collapse:collapse; margin-top:20px;">';
        html += '<tr style="background:#f5f5f5;"><th>å­¦ç”Ÿ</th><th>æœ€åç™»å½•</th><th>å­¦ä¹ å¤©æ•°</th></tr>';
        
        students.forEach(student => {
            const regDate = new Date(student.created_at);
            const lastLogin = student.last_login ? new Date(student.last_login).toLocaleDateString() : 'ä»æœª';
            const days = Math.floor((new Date() - regDate) / (1000*60*60*24)) + 1;
            
            html += `<tr><td>${student.username}</td><td>${lastLogin}</td><td>${days}å¤©</td></tr>`;
        });
        
        html += '</table>';
        html += '<div style="text-align:center; margin-top:20px;">';
        html += '<button class="btn" onclick="loadTeacherDashboard()">è¿”å›</button>';
        html += '</div>';
        
        content.innerHTML = html;
    } catch (error) {
        content.innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
    }
}

async function showStatistics() {
    console.log('æ˜¾ç¤ºç»Ÿè®¡');
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p>åŠ è½½ç»Ÿè®¡æ•°æ®...</p>';
    
    try {
        const { data: records, error } = await supabase
            .from('study_records')
            .select('*');
        
        if (error) throw error;
        
        if (!records || records.length === 0) {
            content.innerHTML = '<p>è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</p>';
            return;
        }
        
        const mastered = records.filter(r => r.status === 'mastered').length;
        const learning = records.filter(r => r.status === 'learning').length;
        const needReview = records.filter(r => r.status === 'new').length;
        const total = records.length;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        content.innerHTML = `
            <h3>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h3>
            <div class="stats-card">
                <p>æ€»å­¦ä¹ æ¬¡æ•°ï¼š${total}</p>
                <p>å·²æŒæ¡ï¼š${mastered} (${progress}%)</p>
                <p>å­¦ä¹ ä¸­ï¼š${learning}</p>
                <p>éœ€å­¦ä¹ ï¼š${needReview}</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn" onclick="loadTeacherDashboard()">è¿”å›</button>
            </div>
        `;
    } catch (error) {
        content.innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function loadStudentDashboard() {
    console.log('åŠ è½½å­¦ç”Ÿé¢æ¿');
    const content = document.getElementById('student-content');
    content.innerHTML = '<p style="text-align:center;">åŠ è½½ä¸­...</p>';
    
    try {
        // è·å–å­¦ç”Ÿçš„å•è¯
        const { data: records, error } = await supabase
            .from('study_records')
            .select('*')
            .eq('student_id', currentUser);
        
        if (error) throw error;
        
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const learning = records?.filter(r => r.status === 'learning').length || 0;
        const needReview = records?.filter(r => r.status === 'new').length || 0;
        const total = records?.length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        // ä¿å­˜åˆ°å…¨å±€å˜é‡
        trainingWords = records || [];
        
        content.innerHTML = `
            <div class="stats-card">
                <h3>ğŸ“Š æˆ‘çš„è¿›åº¦</h3>
                <p>æ€»å•è¯æ•°ï¼š${total}</p>
                <p>å·²æŒæ¡ï¼š${mastered}</p>
                <p>å­¦ä¹ ä¸­ï¼š${learning}</p>
                <p>éœ€å­¦ä¹ ï¼š${needReview}</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <p>ğŸ’¡ ç‚¹å‡»"å¼€å§‹å­¦ä¹ "æŒ‰é’®å¼€å§‹è®­ç»ƒ</p>
                <button class="btn" style="margin-top: 20px;" onclick="startLearning()">å¼€å§‹å­¦ä¹ </button>
            </div>
        `;
    } catch (error) {
        content.innerHTML = `<p style="color:red; text-align:center;">åŠ è½½å¤±è´¥</p>`;
    }
}

function startLearning() {
    console.log('å¼€å§‹å­¦ä¹ ');
    if (trainingWords.length === 0) {
        alert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ');
        return;
    }
    
    // å‡†å¤‡éœ€è¦å­¦ä¹ çš„å•è¯ï¼ˆä¼˜å…ˆæ–°å•è¯å’Œéœ€å¤ä¹ çš„ï¼‰
    const needReview = trainingWords.filter(w => w.status === 'new' || w.status === 'learning');
    const wordsToLearn = needReview.length > 0 ? needReview : trainingWords;
    
    // æ‰“ä¹±é¡ºåº
    wordsToLearn.sort(() => Math.random() - 0.5);
    trainingWords = wordsToLearn;
    currentWordIndex = 0;
    
    showTrainingScreen();
}

function showTrainingScreen() {
    console.log('æ˜¾ç¤ºè®­ç»ƒç•Œé¢ï¼Œå½“å‰ç´¢å¼•:', currentWordIndex);
    if (currentWordIndex >= trainingWords.length) {
        endTraining();
        return;
    }
    
    const word = trainingWords[currentWordIndex];
    
    const content = document.getElementById('student-content');
    content.innerHTML = `
        <h3 style="text-align:center;">ğŸ¯ å•è¯è®­ç»ƒ</h3>
        <div style="text-align:center; margin:20px 0;">
            <p>è¿›åº¦ï¼š${currentWordIndex + 1}/${trainingWords.length}</p>
        </div>
        <div class="word-card" id="word-card" onclick="flipCard()">
            <div id="card-front" style="font-size:2em;">${word.english}</div>
            <div id="card-back" style="display:none; color:#2e7d32; font-size:1.5em;">${word.chinese}</div>
        </div>
        <div style="text-align:center; margin-top:30px;">
            <button class="btn" onclick="markWord('mastered')">âœ… å·²æŒæ¡</button>
            <button class="btn btn-blue" onclick="markWord('learning')">ğŸ”„ å­¦ä¹ ä¸­</button>
            <button class="btn" onclick="skipWord()">â­ï¸ è·³è¿‡</button>
        </div>
    `;
}

function flipCard() {
    console.log('ç¿»è½¬å¡ç‰‡');
    const front = document.getElementById('card-front');
    const back = document.getElementById('card-back');
    const card = document.getElementById('word-card');
    
    if (front.style.display !== 'none') {
        front.style.display = 'none';
        back.style.display = 'block';
        card.style.background = '#e8f5e9';
    } else {
        front.style.display = 'block';
        back.style.display = 'none';
        card.style.background = 'white';
    }
}

async function markWord(status) {
    console.log('æ ‡è®°å•è¯çŠ¶æ€:', status);
    const word = trainingWords[currentWordIndex];
    
    try {
        // æ›´æ–°å­¦ä¹ è®°å½•
        await supabase
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', currentUser)
            .eq('english', word.english);
        
        // æ›´æ–°æœ¬åœ°æ•°æ®
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        
        // ä¸‹ä¸€ä¸ªå•è¯
        currentWordIndex++;
        showTrainingScreen();
        
    } catch (error) {
        console.error('æ›´æ–°é”™è¯¯:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

function skipWord() {
    console.log('è·³è¿‡å•è¯');
    currentWordIndex++;
    showTrainingScreen();
}

function endTraining() {
    console.log('è®­ç»ƒç»“æŸ');
    const mastered = trainingWords.filter(w => w.status === 'mastered').length;
    const total = trainingWords.length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    alert(`ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\nå·²å­¦ä¹  ${currentWordIndex} ä¸ªå•è¯\næŒæ¡ç‡ï¼š${progress}%`);
    loadStudentDashboard();
}

function showMyProgress() {
    console.log('æ˜¾ç¤ºæˆ‘çš„è¿›åº¦');
    loadStudentDashboard();
}

// ========== é€€å‡ºç™»å½• ==========
function logout() {
    console.log('é€€å‡ºç™»å½•');
    if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
        currentUser = null;
        isTeacher = false;
        localStorage.removeItem('current_user');
        localStorage.removeItem('user_role');
        showScreen('login-screen');
        document.getElementById('username').value = '';
    }
}

// ========== å…¨å±€å‡½æ•°å¯¼å‡ºï¼ˆç”¨äºonclickï¼‰ ==========
// ç¡®ä¿æ‰€æœ‰å‡½æ•°éƒ½èƒ½åœ¨å…¨å±€ä½œç”¨åŸŸè®¿é—®
window.login = login;
window.testConnection = testConnection;
window.showUploadWords = showUploadWords;
window.showAllStudents = showAllStudents;
window.showStatistics = showStatistics;
window.startLearning = startLearning;
window.showMyProgress = showMyProgress;
window.logout = logout;
window.flipCard = flipCard;
window.markWord = markWord;
window.skipWord = skipWord;
window.uploadWords = uploadWords;
window.loadTeacherDashboard = loadTeacherDashboard;
</script>
</body>
</html>
