<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        
        input[type="text"], textarea, input[type="password"], select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        /* å•è¯å¡ç‰‡ */
        .word-card { 
            background: white; 
            border: 4px solid #4CAF50; 
            border-radius: 20px; 
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px auto; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            max-width: 600px;
            padding: 20px;
            word-wrap: break-word;
            overflow: hidden;
        }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .message-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .message-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .message-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .message-info { background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB; }
        .message-warning { background: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; }
        
        .wechat-badge { background: #07C160; color: white; padding: 14px 28px; border-radius: 25px; display: inline-flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1em; margin: 15px 0; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* å›ºå®šå¤´éƒ¨æ ·å¼ */
        .fixed-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            z-index: 1000; 
            padding: 15px 30px; 
            border-bottom: 2px solid #f0f0f0; 
        }
        
        .content-padding { padding-top: 100px; padding-bottom: 30px; }
        
        /* æ¿€åŠ±æ ·å¼ */
        .celebration-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .continue-options {
            background: #E3F2FD;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .batch-controls { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        
        /* è¿ç»­æ‰“å¡æ ·å¼ */
        .streak-badge {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        /* å¤ä¹ æ—¥æ¨ªå¹… */
        .review-day-banner {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
        }
        
        /* ä»Šæ—¥ç›®æ ‡ */
        .daily-target {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .two-column { grid-template-columns: 1fr; }
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { 
                height: 220px; 
                max-width: 90%;
                margin: 20px auto;
                padding: 15px;
            }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
            .card-grid { grid-template-columns: 1fr 1fr; }
            .content-padding { padding-top: 90px; }
            .fixed-header { padding: 12px 20px; }
        }
        
        @media (max-width: 480px) {
            .word-card { 
                height: 200px; 
                padding: 10px;
            }
            .card-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-bolt"></i> Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">ğŸ‘­å’Œå•è¯åšæœ‹å‹ğŸ§¡</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;"><i class="fas fa-crown"></i> æ•™å¸ˆï¼šKathy | <i class="fab fa-weixin"></i> å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2><i class="fas fa-crown"></i> æ¬¢è¿ä½¿ç”¨å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">ğŸ§¡Kathyé™ªä½ ä¸€èµ·å’Œå•è¯ç©æ¸¸æˆğŸ§¡</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box message-info">
                            æ­£åœ¨è¿æ¥ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">
                                <i class="fas fa-key"></i> ç™»å½•/æ³¨å†Œ
                            </button>
                            <button class="btn btn-blue" onclick="testDatabase()">
                                <i class="fas fa-wrench"></i> æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;"><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;"><i class="fas fa-chalkboard-teacher"></i></div>
                                <div style="font-weight: bold; margin: 10px 0;">æ•™å¸ˆç«¯</div>
                                <div>å…³æ³¨å­¦ä¹ è¿›åº¦</div>
                                <div>ç®¡ç†å•è¯åˆ†ç»„</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;"><i class="fas fa-user-graduate"></i></div>
                                <div style="font-weight: bold; margin: 10px 0;">å­¦ç”Ÿç«¯</div>
                                <div>Kathyå•ç‹¬å‘é€</div>
                                <div>åå­—é¦–å­—æ¯å¤§å†™</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <div class="wechat-badge">
                                <i class="fab fa-weixin"></i>
                                <span>æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            <p style="color: #555; margin-top: 15px;">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-crown"></i> æ•™å¸ˆç®¡ç†é¢æ¿
                        </h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <i class="fas fa-sign-out-alt"></i> é€€å‡º
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="teacher-stats" class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">
                            <i class="fas fa-chart-bar"></i> ç³»ç»Ÿæ¦‚è§ˆ
                        </h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-purple" onclick="showUploadWordsPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-upload"></i>
                                <div>ä¸Šä¼ å•è¯</div>
                            </button>
                            <button class="btn btn-blue" onclick="showGroupManagementPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-users"></i>
                                <div>åˆ†ç»„ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showAllStudentsPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-list"></i>
                                <div>æ‰€æœ‰å­¦ç”Ÿ</div>
                            </button>
                            <button class="btn btn-gold" onclick="showLearningProgressPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-chart-line"></i>
                                <div>å­¦ä¹ è¿›åº¦</div>
                            </button>
                            <button class="btn" onclick="showWordManagementPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-book"></i>
                                <div>å•è¯ç®¡ç†</div>
                            </button>
                            <button class="btn btn-orange" onclick="showAttendanceReport()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-calendar-check"></i>
                                <div>æ‰“å¡ç»Ÿè®¡</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-graduation-cap"></i> æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼
                        </h2>
                        <div style="display: flex; gap: 10px;">
                            <span class="streak-badge" id="streak-badge" style="display: none;">
                                <i class="fas fa-fire"></i>
                                <span id="streak-days">0</span>å¤©
                            </span>
                            <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                                <i class="fas fa-sign-out-alt"></i> é€€å‡º
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-padding">
                    <!-- ä»Šæ—¥å­¦ä¹ æƒ…å†µ -->
                    <div id="today-status" style="margin-bottom: 30px;"></div>
                    
                    <!-- æˆ‘çš„å­¦ä¹ è¿›åº¦ -->
                    <div id="my-progress-summary" class="stats-card" style="margin-bottom: 30px;"></div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-rocket"></i> å¿«é€Ÿå¼€å§‹
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button class="btn" onclick="showTrainingOptions()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-bullseye"></i>
                                <div>å¼€å§‹è®­ç»ƒ</div>
                            </button>
                            <button class="btn btn-blue" onclick="showMyAchievementsPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-trophy"></i>
                                <div>æˆ‘çš„æˆå°±</div>
                            </button>
                            <button class="btn" onclick="showMyWordListPage()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-book"></i>
                                <div>æˆ‘çš„å•è¯æœ¬</div>
                            </button>
                            <button class="btn" onclick="startReviewTraining()" style="height: 80px; font-size: 18px;">
                                <i class="fas fa-redo"></i>
                                <div>å¤ä¹ å¼±é¡¹</div>
                            </button>
                            <button class="btn" onclick="showTodayWordsPage()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <i class="fas fa-calendar-day"></i>
                                <div>ä»Šæ—¥ä»»åŠ¡</div>
                            </button>
                            <button class="btn btn-gold" onclick="manualSyncWords()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <i class="fas fa-sync"></i>
                                <div>ç«‹å³åŒæ­¥</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„åˆ†ç»„è¯¦æƒ… -->
                    <div id="group-details" style="margin-bottom: 30px;"></div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- è®­ç»ƒé€‰æ‹©é¡µé¢ -->
            <div id="training-options-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-bullseye"></i> é€‰æ‹©è®­ç»ƒæ¨¡å¼
                        </h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                            <h3 style="text-align: center; margin-bottom: 30px; color: #333;">é€‰æ‹©è®­ç»ƒå†…å®¹</h3>
                            
                            <div id="daily-training-options" style="margin-bottom: 40px;"></div>
                            
                            <div style="margin-bottom: 40px;">
                                <button class="btn" onclick="startAllWordsTraining()" 
                                        style="width: 100%; padding: 25px; font-size: 18px; margin-bottom: 15px;">
                                    <i class="fas fa-book" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <div style="font-weight: bold; margin-bottom: 5px;">æ‰€æœ‰å•è¯è®­ç»ƒ</div>
                                    <div style="color: #666; font-size: 14px;">è®­ç»ƒæ‰€æœ‰å·²åŒæ­¥çš„å•è¯</div>
                                </button>
                                
                                <button class="btn btn-blue" onclick="startReviewTraining()" 
                                        style="width: 100%; padding: 25px; font-size: 18px;">
                                    <i class="fas fa-redo" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <div style="font-weight: bold; margin-bottom: 5px;">å¤ä¹ å¼±é¡¹</div>
                                    <div style="color: #666; font-size: 14px;">é‡ç‚¹å¤ä¹ æœªæŒæ¡å•è¯</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®­ç»ƒé¡µé¢ -->
            <div id="training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666;">
                            <i class="fas fa-chart-line"></i>
                            è¿›åº¦: <span id="training-progress">0/0</span>
                        </div>
                        <button class="btn btn-red" onclick="cancelTraining()" style="padding: 8px 16px;">
                            <i class="fas fa-flag-checkered"></i> ç»“æŸè®­ç»ƒ
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="training-content" style="max-width: 600px; margin: 0 auto;"></div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿæˆå°±é¡µé¢ -->
            <div id="student-achievements-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-trophy"></i> æˆ‘çš„æˆå°±
                        </h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="achievements-content"></div>
            </div>
            
            <!-- å­¦ç”Ÿå•è¯æœ¬é¡µé¢ -->
            <div id="student-wordlist-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-book"></i> æˆ‘çš„å•è¯æœ¬
                        </h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="wordlist-content"></div>
            </div>
            
            <!-- å­¦ç”Ÿä»Šæ—¥ä»»åŠ¡é¡µé¢ -->
            <div id="student-today-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-calendar-day"></i> ä»Šæ—¥ä»»åŠ¡
                        </h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="today-content"></div>
            </div>
            
            <!-- ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-upload"></i> ä¸Šä¼ å•è¯
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-upload-content"></div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ -->
            <div id="teacher-groups-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-users"></i> åˆ†ç»„ç®¡ç†
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-groups-content"></div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ -->
            <div id="teacher-students-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-list"></i> æ‰€æœ‰å­¦ç”Ÿ
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-students-content"></div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ -->
            <div id="teacher-progress-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-chart-line"></i> å­¦ä¹ è¿›åº¦
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-progress-content"></div>
            </div>
            
            <!-- æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ -->
            <div id="teacher-words-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-book"></i> å•è¯ç®¡ç†
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-words-content"></div>
            </div>
            
            <!-- æ•™å¸ˆæ‰“å¡ç»Ÿè®¡é¡µé¢ -->
            <div id="teacher-attendance-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-calendar-check"></i> æ‰“å¡ç»Ÿè®¡
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-attendance-content"></div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†äº«ç³»ç»Ÿé¡µé¢ -->
            <div id="teacher-share-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">
                            <i class="fas fa-share-alt"></i> åˆ†äº«ç³»ç»Ÿ
                        </h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-share-content"></div>
            </div>
        </div>
    </div>

<script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null,
    
    // æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿé…ç½®
    dailyTarget: 10,
    consecutiveDays: 0,
    lastStudyDate: null,
    attendanceStreak: 0,
    todayStudyCount: 0
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
    window.scrollTo(0, 0);
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
    
    if (type === 'success' || type === 'error') {
        setTimeout(() => {
            el.style.display = 'none';
        }, 3000);
    }
}

function showAlert(message, type = 'info', duration = 3000) {
    const alertBox = document.createElement('div');
    alertBox.className = `message-box message-${type}`;
    alertBox.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        padding: 15px;
        border-radius: 8px;
        animation: fadeIn 0.5s;
    `;
    alertBox.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(alertBox);
    
    setTimeout(() => {
        alertBox.style.opacity = '0';
        alertBox.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            if (alertBox.parentNode) {
                alertBox.parentNode.removeChild(alertBox);
            }
        }, 500);
    }, duration);
}

function showConfirm(message, confirmText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ') {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h3 style="color: #333; margin-bottom: 20px; text-align: center;">æç¤º</h3>
                <p style="color: #666; margin-bottom: 30px; text-align: center;">${message}</p>
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button class="btn btn-red" id="confirm-cancel">${cancelText}</button>
                    <button class="btn" id="confirm-ok">${confirmText}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('confirm-cancel').onclick = () => {
            document.body.removeChild(modal);
            resolve(false);
        };
        
        document.getElementById('confirm-ok').onclick = () => {
            document.body.removeChild(modal);
            resolve(true);
        };
    });
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { error } = await dbClient.from('users').select('count').limit(1);
        if (error) throw error;
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // æ–°ç”¨æˆ·æ³¨å†Œ
            const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: appState.teacherId,
                    created_at: new Date().toISOString(),
                    last_login: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (createError) {
                if (createError.code === '23505') {
                    showMessage('login-message', 'ç”¨æˆ·åå·²å­˜åœ¨', 'error');
                    return;
                }
                throw createError;
            }
            
            appState.currentUser = username;
            appState.isTeacher = isTeacherAccount;
            appState.userId = username;
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
            // å¦‚æœæ˜¯å­¦ç”Ÿï¼ŒåŒæ­¥æ•™å¸ˆå•è¯
            if (!isTeacherAccount) {
                await syncGroupWordsToStudent(username);
            }
            
        } else if (checkError) {
            throw checkError;
        } else {
            // è€ç”¨æˆ·ç™»å½•
            appState.currentUser = username;
            appState.isTeacher = existingUser.is_teacher;
            appState.userId = username;
            
            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            await dbClient
                .from('users')
                .update({ 
                    last_login: new Date().toISOString(),
                    consecutive_days: existingUser.consecutive_days || 0
                })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
            
            // å¦‚æœæ˜¯å­¦ç”Ÿï¼ŒåŒæ­¥æ•™å¸ˆå•è¯
            if (!appState.isTeacher) {
                await syncGroupWordsToStudent(username);
            }
        }
        
        // å¦‚æœæ˜¯æ•™å¸ˆï¼Œåˆå§‹åŒ–åˆ†ç»„ç³»ç»Ÿ
        if (appState.isTeacher) {
            await initializeTeacherGroups();
        } else {
            // è·å–å­¦ç”Ÿè¿ç»­æ‰“å¡ä¿¡æ¯
            const { data: user } = await dbClient
                .from('users')
                .select('consecutive_days, last_study_date')
                .eq('username', username)
                .single();
            
            if (user) {
                appState.attendanceStreak = user.consecutive_days || 0;
                appState.consecutiveDays = user.consecutive_days || 0;
                appState.lastStudyDate = user.last_study_date;
            }
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', appState.isTeacher ? 'teacher' : 'student');
        
        // åŠ è½½ä»Šæ—¥è®­ç»ƒçŠ¶æ€
        if (!appState.isTeacher) {
            await loadDailyTrainingState();
        }
        
        // è·³è½¬åˆ°å¯¹åº”ç•Œé¢
        setTimeout(() => {
            if (appState.isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// åŠ è½½ä»Šæ—¥è®­ç»ƒçŠ¶æ€
async function loadDailyTrainingState() {
    try {
        const today = new Date().toDateString();
        const storedDate = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
        
        if (storedDate === today) {
            const progress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
            appState.dailyTrainingProgress = progress;
            appState.lastTrainingDate = storedDate;
        } else {
            // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è¿›åº¦
            appState.dailyTrainingProgress = 0;
            appState.lastTrainingDate = today;
            localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
            localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0');
        }
    } catch (error) {
        console.error('åŠ è½½è®­ç»ƒçŠ¶æ€é”™è¯¯:', error);
    }
}

// ä¿å­˜ä»Šæ—¥è®­ç»ƒè¿›åº¦
function saveDailyTrainingProgress(wordsStudied) {
    try {
        const today = new Date().toDateString();
        const currentProgress = appState.dailyTrainingProgress + wordsStudied;
        appState.dailyTrainingProgress = currentProgress;
        
        localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
        localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, currentProgress.toString());
        
        return currentProgress;
    } catch (error) {
        console.error('ä¿å­˜è®­ç»ƒè¿›åº¦é”™è¯¯:', error);
        return appState.dailyTrainingProgress;
    }
}

// åˆå§‹åŒ–æ•™å¸ˆåˆ†ç»„ç³»ç»Ÿ
async function initializeTeacherGroups() {
    try {
        // æ£€æŸ¥æ•™å¸ˆæ˜¯å¦æœ‰åˆ†ç»„
        const { data: existingGroups, error } = await dbClient
            .from('groups')
            .select('*')
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        // å¦‚æœæ²¡æœ‰åˆ†ç»„ï¼Œåˆ›å»ºé»˜è®¤åˆ†ç»„
        if (!existingGroups || existingGroups.length === 0) {
            const { data: newGroup, error: createError } = await dbClient
                .from('groups')
                .insert([{
                    name: 'é»˜è®¤åˆ†ç»„',
                    teacher_id: appState.teacherId,
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            console.log('åˆ›å»ºäº†é»˜è®¤åˆ†ç»„');
        }
        
    } catch (error) {
        console.error('åˆå§‹åŒ–åˆ†ç»„é”™è¯¯:', error);
    }
}

// ========== åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ ==========
async function syncGroupWordsToStudent(studentId) {
    try {
        console.log(`å¼€å§‹ä¸º ${studentId} åŒæ­¥åˆ†ç»„å•è¯...`);
        
        // è·å–å­¦ç”Ÿæ‰€åœ¨çš„åˆ†ç»„
        const { data: studentGroups, error: groupsError } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', studentId);
        
        if (groupsError) {
            console.error('è·å–å­¦ç”Ÿåˆ†ç»„é”™è¯¯:', groupsError);
            return 0;
        }
        
        if (!studentGroups || studentGroups.length === 0) {
            console.log(`å­¦ç”Ÿ ${studentId} æ²¡æœ‰åŠ å…¥ä»»ä½•åˆ†ç»„ï¼Œæ— æ³•åŒæ­¥å•è¯`);
            showAlert('æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„ï¼Œè¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­', 'warning');
            return 0;
        }
        
        const groupIds = studentGroups.map(g => g.group_id);
        
        // è·å–åˆ†ç»„å†…çš„å•è¯
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .in('group_id', groupIds)
            .eq('teacher_id', appState.teacherId);
        
        if (wordsError) {
            console.error('è·å–åˆ†ç»„å•è¯é”™è¯¯:', wordsError);
            return 0;
        }
        
        if (!groupWords || groupWords.length === 0) {
            console.log(`å­¦ç”Ÿ ${studentId} çš„åˆ†ç»„ä¸­æ²¡æœ‰å•è¯`);
            showAlert('æ‚¨æ‰€åœ¨çš„åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯ï¼Œè¯·è”ç³»è€å¸ˆä¸Šä¼ å•è¯', 'info');
            return 0;
        }
        
        console.log(`æ‰¾åˆ° ${groupWords.length} ä¸ªåˆ†ç»„å•è¯`);
        
        // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²æœ‰è¿™äº›å•è¯
        const { data: existingRecords, error: checkError } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        if (checkError) {
            console.error('æ£€æŸ¥ç°æœ‰è®°å½•é”™è¯¯:', checkError);
            return 0;
        }
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°å•è¯è®°å½•
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                review_count: 0,
                group_id: word.group_id,
                added_date: new Date().toISOString(),
                last_reviewed: null
            }));
        
        console.log(`éœ€è¦åŒæ­¥ ${newRecords.length} ä¸ªæ–°å•è¯`);
        
        if (newRecords.length > 0) {
            // åˆ†æ‰¹æ’å…¥
            const batchSize = 50;
            let syncedCount = 0;
            
            for (let i = 0; i < newRecords.length; i += batchSize) {
                const batch = newRecords.slice(i, i + batchSize);
                const { error: insertError } = await dbClient
                    .from('study_records')
                    .insert(batch);
                
                if (insertError) {
                    console.error(`æ‰¹é‡æ’å…¥é”™è¯¯:`, insertError);
                    // å°è¯•é€ä¸ªæ’å…¥
                    for (const record of batch) {
                        try {
                            const { error: singleError } = await dbClient
                                .from('study_records')
                                .insert(record);
                            if (!singleError) {
                                syncedCount++;
                            }
                        } catch (err) {
                            console.error('æ’å…¥å¼‚å¸¸:', err);
                        }
                    }
                } else {
                    syncedCount += batch.length;
                }
            }
            
            console.log(`æˆåŠŸä¸º ${studentId} åŒæ­¥äº† ${syncedCount} ä¸ªæ–°å•è¯`);
            
            if (syncedCount > 0) {
                showAlert(`âœ… å·²ä¸ºæ‚¨åŒæ­¥ ${syncedCount} ä¸ªæ–°å•è¯`, 'success');
            }
            
            // æ›´æ–°å­¦ç”Ÿå•è¯åˆ—è¡¨
            if (appState.currentUser === studentId) {
                await loadStudentWords();
            }
            
            return syncedCount;
        } else {
            console.log(`æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–°å•è¯`);
            showAlert('ğŸ“š æ‚¨å·²åŒæ­¥æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
            return 0;
        }
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// åŠ è½½å­¦ç”Ÿå•è¯
async function loadStudentWords() {
    try {
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        appState.userWords = records || [];
        return appState.userWords;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿå•è¯é”™è¯¯:', error);
        appState.userWords = [];
        return [];
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}

async function loadTeacherDashboard() {
    try {
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        const [wordsData, studentsData, recordsData] = await Promise.all([
            dbClient.from('words').select('count').eq('teacher_id', appState.teacherId),
            dbClient.from('users').select('count').eq('is_teacher', false),
            dbClient.from('study_records').select('*')
        ]);
        
        document.getElementById('total-words').textContent = wordsData?.data?.[0]?.count || 0;
        document.getElementById('total-students').textContent = studentsData?.data?.[0]?.count || 0;
        
        const masteredWords = recordsData?.data?.filter(r => r.status === 'mastered').length || 0;
        document.getElementById('mastered-words').textContent = masteredWords;
        
        // è·å–7å¤©å†…æ´»è·ƒå­¦ç”Ÿ
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const { data: activeData } = await dbClient
            .from('study_records')
            .select('student_id')
            .gte('last_reviewed', sevenDaysAgo.toISOString());
        
        const activeStudents = new Set(activeData?.map(r => r.student_id) || []).size;
        document.getElementById('active-students').textContent = activeStudents;
        
        // æ˜¾ç¤ºæ•™å¸ˆä»ªè¡¨æ¿å†…å®¹
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">
                    <i class="fas fa-magic"></i> å¿«é€Ÿæ“ä½œ
                </h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn" onclick="showUploadWordsPage()" style="padding: 12px 24px;">
                        <i class="fas fa-upload"></i> å¿«é€Ÿä¸Šä¼ 
                    </button>
                    <button class="btn btn-blue" onclick="quickStats()" style="padding: 12px 24px;">
                        <i class="fas fa-chart-bar"></i> ä»Šæ—¥æ•°æ®
                    </button>
                    <button class="btn" onclick="showStudentActivity()" style="padding: 12px 24px;">
                        <i class="fas fa-running"></i> å­¦ç”Ÿæ´»è·ƒ
                    </button>
                    <button class="btn btn-orange" onclick="showAttendanceReport()" style="padding: 12px 24px;">
                        <i class="fas fa-calendar-check"></i> æ‰“å¡ç»Ÿè®¡
                    </button>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">
                        <i class="fas fa-lightbulb"></i> ç³»ç»Ÿæç¤º
                    </h4>
                    <p style="color: #666; margin: 5px 0;">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿå·²å¯ç”¨ï¼šå­¦ç”Ÿæ¯å¤©å­¦ä¹ 10ä¸ªæ–°å•è¯
                    </p>
                    <p style="color: #666; margin: 5px 0;">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        æ‰“å¡ç³»ç»Ÿå·²å¯ç”¨ï¼šè¿ç»­7å¤©å­¦ä¹ è·å¾—å¥–åŠ±
                    </p>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        document.getElementById('teacher-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
    }
}

// ========== æ‰“å¡ç³»ç»Ÿ ==========

// è®°å½•æ¯æ—¥æ‰“å¡
async function recordAttendance(studentId, wordCount, newWordCount) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æ‰“å¡
        const { data: existing, error: checkError } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('student_id', studentId)
            .eq('study_date', today)
            .single();
        
        if (checkError && checkError.code !== 'PGRST116') {
            console.error('æ£€æŸ¥æ‰“å¡è®°å½•é”™è¯¯:', checkError);
            return;
        }
        
        // è®¡ç®—å¤ä¹ å•è¯æ•°é‡
        const reviewCount = wordCount - newWordCount;
        
        if (existing) {
            // æ›´æ–°ç°æœ‰è®°å½•
            const { error: updateError } = await dbClient
                .from('attendance_records')
                .update({
                    word_count: wordCount,
                    new_word_count: newWordCount,
                    review_word_count: reviewCount
                })
                .eq('id', existing.id);
            
            if (updateError) throw updateError;
        } else {
            // åˆ›å»ºæ–°è®°å½•
            const { error: insertError } = await dbClient
                .from('attendance_records')
                .insert([{
                    student_id: studentId,
                    study_date: today,
                    word_count: wordCount,
                    new_word_count: newWordCount,
                    review_word_count: reviewCount,
                    status: 'completed'
                }]);
            
            if (insertError) throw insertError;
            
            // æ›´æ–°å­¦ç”Ÿè¿ç»­æ‰“å¡å¤©æ•°
            await updateConsecutiveDays(studentId);
        }
        
        // æ›´æ–°ç”¨æˆ·æœ€åå­¦ä¹ æ—¥æœŸ
        await dbClient
            .from('users')
            .update({
                last_study_date: today,
                consecutive_days: appState.attendanceStreak
            })
            .eq('username', studentId);
        
    } catch (error) {
        console.error('è®°å½•æ‰“å¡é”™è¯¯:', error);
    }
}

// æ›´æ–°è¿ç»­æ‰“å¡å¤©æ•°
async function updateConsecutiveDays(studentId) {
    try {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        // æ£€æŸ¥æ˜¨å¤©æ˜¯å¦æ‰“å¡
        const { data: yesterdayAttendance, error } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('student_id', studentId)
            .eq('study_date', yesterdayStr)
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error('æ£€æŸ¥æ˜¨å¤©æ‰“å¡é”™è¯¯:', error);
            return;
        }
        
        // è·å–ç”¨æˆ·å½“å‰è¿ç»­å¤©æ•°
        const { data: user } = await dbClient
            .from('users')
            .select('consecutive_days')
            .eq('username', studentId)
            .single();
        
        let newStreak = 1; // ä»Šå¤©æ‰“å¡äº†ï¼Œæ‰€ä»¥è‡³å°‘1å¤©
        
        if (yesterdayAttendance) {
            // æ˜¨å¤©æ‰“å¡äº†ï¼Œè¿ç»­å¤©æ•°+1
            newStreak = (user?.consecutive_days || 0) + 1;
        }
        
        appState.attendanceStreak = newStreak;
        appState.consecutiveDays = newStreak;
        
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°7å¤©è¿ç»­æ‰“å¡
        if (appState.attendanceStreak % 7 === 0 && appState.attendanceStreak > 0) {
            await awardConsecutiveBonus(studentId);
        }
        
    } catch (error) {
        console.error('æ›´æ–°è¿ç»­æ‰“å¡é”™è¯¯:', error);
    }
}

// å¥–åŠ±è¿ç»­7å¤©æ‰“å¡
async function awardConsecutiveBonus(studentId) {
    try {
        const streak = appState.attendanceStreak;
        const weeks = Math.floor(streak / 7);
        
        let bonusMessage = '';
        if (weeks === 1) {
            bonusMessage = 'ğŸ‰ æ­å–œï¼æ‚¨å·²è¿ç»­å­¦ä¹ 7å¤©ï¼è·å¾—"åšæŒä¹‹æ˜Ÿ"ç§°å·ï¼';
        } else if (weeks === 2) {
            bonusMessage = 'ğŸ‰ å¤ªæ£’äº†ï¼æ‚¨å·²è¿ç»­å­¦ä¹ 14å¤©ï¼è·å¾—"æ¯…åŠ›ä¹‹æ˜Ÿ"ç§°å·ï¼';
        } else if (weeks === 3) {
            bonusMessage = 'ğŸ‰ äº†ä¸èµ·ï¼æ‚¨å·²è¿ç»­å­¦ä¹ 21å¤©ï¼è·å¾—"å­¦ä¹ ç‹è€…"ç§°å·ï¼';
        } else {
            bonusMessage = `ğŸ‰ æ­å–œï¼æ‚¨å·²è¿ç»­å­¦ä¹ ${streak}å¤©ï¼ç»§ç»­ä¿æŒï¼`;
        }
        
        showAlert(bonusMessage, 'success', 5000);
        
    } catch (error) {
        console.error('å‘æ”¾å¥–åŠ±é”™è¯¯:', error);
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboardSimple();
}

// åŠ è½½ç®€æ´ç‰ˆå­¦ç”Ÿé¢æ¿
async function loadStudentDashboardSimple() {
    try {
        // è®¾ç½®å­¦ç”Ÿå§“å
        document.getElementById('student-name').textContent = appState.currentUser;
        
        // åŠ è½½å­¦ç”Ÿå•è¯
        await loadStudentWords();
        
        // æ›´æ–°è¿ç»­æ‰“å¡æ˜¾ç¤º
        const streakBadge = document.getElementById('streak-badge');
        const streakDays = document.getElementById('streak-days');
        
        if (appState.attendanceStreak > 0) {
            streakBadge.style.display = 'inline-flex';
            streakDays.textContent = appState.attendanceStreak;
        } else {
            streakBadge.style.display = 'none';
        }
        
        // ä»Šæ—¥å­¦ä¹ æƒ…å†µ
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayRecords = appState.userWords.filter(w => 
            w.last_reviewed && new Date(w.last_reviewed) >= today
        ) || [];
        
        const target = appState.dailyTarget;
        const todayProgress = Math.min(todayRecords.length, target);
        const progressPercent = (todayProgress / target) * 100;
        
        // æ˜¾ç¤ºè¿ç»­æ‰“å¡ä¿¡æ¯
        let streakInfo = '';
        if (appState.attendanceStreak > 0) {
            const daysLeft = 7 - (appState.attendanceStreak % 7);
            const currentWeek = Math.ceil(appState.attendanceStreak / 7);
            
            streakInfo = `
                <div class="streak-badge" style="display: inline-flex;">
                    <i class="fas fa-fire"></i>
                    <div>
                        <div>è¿ç»­å­¦ä¹  ${appState.attendanceStreak} å¤©</div>
                        <div style="font-size: 0.8em; font-weight: normal;">
                            ${daysLeft === 0 ? 'ğŸ‰ æ­å–œå®Œæˆæœ¬å‘¨ç›®æ ‡ï¼' : `ç¬¬${currentWeek}å‘¨ Â· è·å¥–åŠ±è¿˜æœ‰ ${daysLeft} å¤©`}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ä»Šæ—¥ç›®æ ‡è¯´æ˜
        const todayTargetInfo = `
            <div class="daily-target">
                <h4 style="margin: 0 0 10px 0; color: #2E7D32;">
                    <i class="fas fa-bullseye"></i> ä»Šæ—¥å­¦ä¹ ç›®æ ‡
                </h4>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>æ–°å•è¯ï¼š</span>
                    <span><strong>${appState.dailyTarget}ä¸ª</strong></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>å­¦ä¹ ä¸­å•è¯å¤ä¹ ï¼š</span>
                    <span><strong>æœ€å¤š5ä¸ª</strong></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>å·²æŒæ¡å•è¯å¤ä¹ ï¼š</span>
                    <span><strong>æœ€å¤š2ä¸ª</strong></span>
                </div>
            </div>
        `;
        
        const todayStatus = document.getElementById('today-status');
        todayStatus.innerHTML = `
            ${streakInfo}
            ${todayTargetInfo}
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">
                    <i class="fas fa-chart-line"></i> ä»Šæ—¥å­¦ä¹ æƒ…å†µ
                </h3>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${todayRecords.length}</div>
                        <div class="label">ä»Šæ—¥å·²å­¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${todayProgress}/${target}</div>
                        <div class="label">æ–°å•è¯è¿›åº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${appState.attendanceStreak}</div>
                        <div class="label">è¿ç»­å¤©æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${todayRecords.filter(r => r.status === 'mastered').length}</div>
                        <div class="label">ä»Šæ—¥æŒæ¡</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">æ–°å•è¯è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayProgress}/${target}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                ${todayProgress >= target ? 
                    '<div class="celebration-banner" style="margin-top: 15px;">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥æ–°å•è¯ç›®æ ‡å·²å®Œæˆï¼</div>' : 
                    '<p style="color: #FF9800; text-align: center; margin-top: 15px; font-weight: bold;">ğŸ’ª ç»§ç»­åŠªåŠ›å®Œæˆä»Šæ—¥ç›®æ ‡ï¼</p>'}
            </div>
        `;
        
        // å­¦ä¹ è¿›åº¦
        const total = appState.userWords.length || 0;
        const mastered = appState.userWords.filter(w => w.status === 'mastered').length || 0;
        const learning = appState.userWords.filter(w => w.status === 'learning').length || 0;
        const review = appState.userWords.filter(w => w.status === 'new').length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        const progressSummary = document.getElementById('my-progress-summary');
        progressSummary.innerHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${total}</div>
                    <div class="label">å•è¯æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${mastered}</div>
                    <div class="label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${learning}</div>
                    <div class="label">å­¦ä¹ ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="number">${review}</div>
                    <div class="label">éœ€å­¦ä¹ </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
        `;
        
        // åˆ†ç»„è¯¦æƒ…
        const { data: studentGroups } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', appState.currentUser);
        
        let groupDetails = '';
        if (studentGroups && studentGroups.length > 0) {
            const groupIds = studentGroups.map(g => g.group_id);
            const { data: groups } = await dbClient
                .from('groups')
                .select('id, name')
                .in('id', groupIds);
            
            for (const group of groups || []) {
                const { data: groupWords } = await dbClient
                    .from('words')
                    .select('count')
                    .eq('group_id', group.id);
                
                const { data: myGroupRecords } = await dbClient
                    .from('study_records')
                    .select('count')
                    .eq('student_id', appState.currentUser)
                    .eq('group_id', group.id);
                
                groupDetails += `
                    <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: #2E7D32;">
                            <i class="fas fa-folder"></i> ${group.name}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            <i class="fas fa-book"></i> åˆ†ç»„å•è¯: ${groupWords?.[0]?.count || 0} | 
                            <i class="fas fa-user"></i> æˆ‘çš„å•è¯: ${myGroupRecords?.[0]?.count || 0}
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('group-details').innerHTML = groupDetails ? `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">
                    <i class="fas fa-folder-open"></i> æˆ‘çš„åˆ†ç»„è¯¦æƒ…
                </h3>
                ${groupDetails}
            </div>
        ` : `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">
                    <i class="fas fa-folder-open"></i> åˆ†ç»„çŠ¶æ€
                </h3>
                <p style="color: #FF9800; text-align: center;">
                    <i class="fas fa-exclamation-triangle"></i>
                    æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„
                </p>
                <p style="color: #666; text-align: center; font-size: 14px;">
                    è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// æ‰‹åŠ¨åŒæ­¥å•è¯
async function manualSyncWords() {
    try {
        showAlert('æ­£åœ¨åŒæ­¥å•è¯...', 'info');
        const syncedCount = await syncGroupWordsToStudent(appState.currentUser);
        
        if (syncedCount > 0) {
            showAlert(`åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥ ${syncedCount} ä¸ªæ–°å•è¯`, 'success');
        } else {
            showAlert('æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
        }
        
        await loadStudentDashboardSimple();
        
    } catch (error) {
        console.error('æ‰‹åŠ¨åŒæ­¥é”™è¯¯:', error);
        showAlert('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
    }
}

// æ˜¾ç¤ºè®­ç»ƒé€‰é¡¹
function showTrainingOptions() {
    showScreen('training-options-screen');
    loadTrainingOptions();
}

// åŠ è½½è®­ç»ƒé€‰é¡¹
async function loadTrainingOptions() {
    const optionsDiv = document.getElementById('daily-training-options');
    
    // æ£€æŸ¥ä»Šæ—¥è®­ç»ƒçŠ¶æ€
    const today = new Date().toDateString();
    const storedDate = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
    const todayProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
    
    if (storedDate === today && todayProgress >= 10) {
        // ä»Šæ—¥å·²å®Œæˆè®­ç»ƒï¼Œæä¾›ç»§ç»­é€‰é¡¹
        optionsDiv.innerHTML = `
            <div class="continue-options">
                <h4 style="color: #1565C0; margin-bottom: 15px;">
                    <i class="fas fa-calendar-day"></i> ä»Šæ—¥è®­ç»ƒ
                </h4>
                <p style="color: #666; margin-bottom: 20px;">
                    æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn" onclick="startNewDailyTraining()" 
                            style="padding: 20px; font-size: 16px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div style="font-weight: bold; margin-bottom: 5px;">æ–°å•è¯è®­ç»ƒ</div>
                        <div style="color: #666; font-size: 14px;">å­¦ä¹ æ–°çš„å•è¯</div>
                    </button>
                    
                    <button class="btn btn-blue" onclick="continueReviewTraining()" 
                            style="padding: 20px; font-size: 16px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">
                            <i class="fas fa-redo"></i>
                        </div>
                        <div style="font-weight: bold; margin-bottom: 5px;">ç»§ç»­å¤ä¹ </div>
                        <div style="color: #666; font-size: 14px;">å¤ä¹ ä»Šæ—¥å­¦è¿‡çš„å•è¯</div>
                </button>
                </div>
                <p style="color: #4CAF50; text-align: center; margin-top: 15px; font-weight: bold;">
                    <i class="fas fa-trophy"></i> å¤ªæ£’äº†ï¼æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€ä»»åŠ¡ï¼
                </p>
            </div>
        `;
    } else {
        // ä»Šæ—¥æœªå®Œæˆè®­ç»ƒ
        optionsDiv.innerHTML = `
            <button class="btn btn-blue" onclick="startDailyTraining()" 
                    style="width: 100%; padding: 25px; font-size: 18px; margin-bottom: 15px;">
                <div style="font-size: 24px; margin-bottom: 10px;">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div style="font-weight: bold; margin-bottom: 5px;">ä»Šæ—¥è®­ç»ƒ</div>
                <div style="color: #666; font-size: 14px;">æ¯å¤©10ä¸ªå•è¯ï¼Œç§‘å­¦è®°å¿†</div>
                ${todayProgress > 0 ? `
                    <div style="color: #4CAF50; margin-top: 5px; font-weight: bold;">
                        ä»Šæ—¥è¿›åº¦: ${todayProgress}/10
                    </div>
                ` : ''}
            </button>
        `;
    }
}

// å¼€å§‹æ–°æ¯æ—¥è®­ç»ƒ
function startNewDailyTraining() {
    // é‡ç½®ä»Šæ—¥è®­ç»ƒçŠ¶æ€
    localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0');
    appState.dailyTrainingProgress = 0;
    startDailyTraining();
}

// ç»§ç»­å¤ä¹ è®­ç»ƒ
async function continueReviewTraining() {
    // ä»ä»Šæ—¥å­¦è¿‡çš„å•è¯ä¸­é€‰æ‹©å¤ä¹ 
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayWords = appState.userWords.filter(word => 
        word.last_reviewed && new Date(word.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        startNewDailyTraining();
        return;
    }
    
    // ä¼˜å…ˆå¤ä¹ ä»Šå¤©å­¦ä¹ ä¸­æˆ–æœªæŒæ¡çš„å•è¯
    const reviewWords = todayWords.sort((a, b) => {
        // æœªæŒæ¡ä¼˜å…ˆ
        if (a.status === 'new' && b.status !== 'new') return -1;
        if (a.status !== 'new' && b.status === 'new') return 1;
        if (a.status === 'learning' && b.status === 'mastered') return -1;
        if (a.status === 'mastered' && b.status === 'learning') return 1;
        
        // å¤ä¹ æ¬¡æ•°å°‘çš„ä¼˜å…ˆ
        return (a.review_count || 0) - (b.review_count || 0);
    }).slice(0, 10);
    
    if (reviewWords.length === 0) {
        showAlert('ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯', 'info');
        startNewDailyTraining();
        return;
    }
    
    reviewWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = reviewWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// å¼€å§‹æ‰€æœ‰å•è¯è®­ç»ƒ
async function startAllWordsTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    // åŠ è½½ä¿å­˜çš„è®­ç»ƒè¿›åº¦
    const savedProgress = localStorage.getItem(`kathy_all_training_${appState.currentUser}`);
    let startIndex = 0;
    
    if (savedProgress) {
        try {
            const progress = JSON.parse(savedProgress);
            const today = new Date().toDateString();
            if (progress.date === today && progress.index > 0) {
                const continueTraining = await showConfirm(
                    `å‘ç°ä¸Šæ¬¡çš„è®­ç»ƒè¿›åº¦ï¼ˆ${progress.index}/${progress.total}ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
                    'ç»§ç»­è®­ç»ƒ',
                    'é‡æ–°å¼€å§‹'
                );
                if (continueTraining) {
                    startIndex = progress.index;
                }
            }
        } catch (e) {
            console.error('è§£æè®­ç»ƒè¿›åº¦é”™è¯¯:', e);
        }
    }
    
    appState.trainingWords = [...appState.userWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = startIndex;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// å¼€å§‹æ¯æ—¥è®­ç»ƒ
async function startDailyTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const todayProgress = appState.dailyTrainingProgress || 0;
    const target = appState.dailyTarget;
    
    // å¦‚æœä»Šæ—¥å·²å®ŒæˆåŸºç¡€è®­ç»ƒï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
    if (todayProgress >= target) {
        const continueTraining = await showConfirm(
            `æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼æ˜¯å¦ç»§ç»­å­¦ä¹ æ›´å¤šå•è¯ï¼Ÿ`,
            'ç»§ç»­å­¦ä¹ ',
            'å–æ¶ˆ'
        );
        if (!continueTraining) {
            showAlert('æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€è®­ç»ƒï¼Œå¾ˆæ£’ï¼', 'success');
            return;
        }
    }
    
    // æ™ºèƒ½é€‰æ‹©ä»Šæ—¥å•è¯
    const newWords = appState.userWords.filter(w => w.status === 'new');
    const learningWords = appState.userWords.filter(w => w.status === 'learning');
    const masteredWords = appState.userWords.filter(w => w.status === 'mastered');
    
    let dailyWords = [];
    const wordsNeeded = Math.max(5, target - todayProgress);
    
    // ä¼˜å…ˆé€‰æ‹©æ–°å•è¯ï¼ˆ50%ï¼‰
    if (newWords.length > 0) {
        const newCount = Math.min(Math.ceil(wordsNeeded * 0.5), newWords.length);
        dailyWords = dailyWords.concat(newWords.slice(0, newCount));
    }
    
    // å…¶æ¬¡æ˜¯å­¦ä¹ ä¸­å•è¯ï¼ˆ30%ï¼‰
    if (learningWords.length > 0 && dailyWords.length < wordsNeeded) {
        const learningCount = Math.min(Math.ceil(wordsNeeded * 0.3), learningWords.length);
        dailyWords = dailyWords.concat(learningWords.slice(0, learningCount));
    }
    
    // æœ€åæ˜¯å·²æŒæ¡å•è¯éœ€è¦å¤ä¹ çš„ï¼ˆ20%ï¼‰
    if (masteredWords.length > 0 && dailyWords.length < wordsNeeded) {
        const reviewCount = wordsNeeded - dailyWords.length;
        // é€‰æ‹©å¤ä¹ æ¬¡æ•°æœ€å°‘æˆ–æœ€ä¹…æ²¡å¤ä¹ çš„å•è¯
        const sortedMastered = masteredWords.sort((a, b) => {
            const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
            const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
            return aDate - bDate;
        });
        dailyWords = dailyWords.concat(sortedMastered.slice(0, reviewCount));
    }
    
    // å¦‚æœè¿˜ä¸å¤Ÿï¼Œéšæœºè¡¥å……
    if (dailyWords.length < wordsNeeded) {
        const allWords = [...appState.userWords];
        const remaining = wordsNeeded - dailyWords.length;
        const usedIds = new Set(dailyWords.map(w => w.id || w.word_id));
        
        for (let i = 0; i < allWords.length && dailyWords.length < wordsNeeded; i++) {
            const word = allWords[i];
            if (!usedIds.has(word.id || word.word_id)) {
                dailyWords.push(word);
            }
        }
    }
    
    dailyWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = dailyWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// å¼€å§‹å¤ä¹ è®­ç»ƒ
function startReviewTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const weakWords = appState.userWords.filter(w => w.status === 'new' || w.status === 'learning');
    
    if (weakWords.length === 0) {
        showAlert('ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰éœ€è¦å¤ä¹ çš„å¼±é¡¹å•è¯ï¼', 'success');
        return;
    }
    
    weakWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = weakWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// å¼€å§‹è®­ç»ƒä¼šè¯
function startTrainingSession() {
    showScreen('training-screen');
    showTrainingScreenSimple();
}

// ç®€æ´ç‰ˆè®­ç»ƒç•Œé¢
function showTrainingScreenSimple() {
    if (appState.currentWordIndex >= appState.trainingWords.length) {
        finishTraining();
        return;
    }
    
    const word = appState.trainingWords[appState.currentWordIndex];
    const total = appState.trainingWords.length;
    const current = appState.currentWordIndex + 1;
    
    document.getElementById('training-progress').textContent = `${current}/${total}`;
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <!-- å•è¯å¡ç‰‡ -->
            <div class="word-card ${appState.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
                <div style="padding: 20px; text-align: center; font-size: ${word.english.length > 15 ? '1.5em' : word.english.length > 25 ? '1.2em' : '2em'};">
                    ${appState.isCardFlipped ? `
                        <div style="color: #2E7D32; word-break: break-word;">
                            ${word.chinese}
                        </div>
                    ` : `
                        <div style="color: #333; word-break: break-word;">
                            ${word.english}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- çŠ¶æ€æŒ‰é’® -->
            <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn" onclick="markTrainingWord('mastered')" 
                        style="padding: 15px; background: #4CAF50;">
                    <div style="font-size: 20px; margin-bottom: 5px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>å·²æŒæ¡</div>
                </button>
                
                <button class="btn btn-blue" onclick="markTrainingWord('learning')" 
                        style="padding: 15px; background: #2196F3;">
                    <div style="font-size: 20px; margin-bottom: 5px;">
                        <i class="fas fa-redo"></i>
                    </div>
                    <div>å­¦ä¹ ä¸­</div>
                </button>
                
                <button class="btn" onclick="markTrainingWord('new')" 
                        style="padding: 15px; background: #FF9800;">
                    <div style="font-size: 20px; margin-bottom: 5px;">
                        <i class="fas fa-book"></i>
                    </div>
                    <div>éœ€å­¦ä¹ </div>
                </button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn" onclick="skipTrainingWord()" 
                        style="flex: 1; padding: 12px; background: #9E9E9E;">
                    <i class="fas fa-forward"></i> è·³è¿‡
                </button>
                
                <button class="btn" onclick="saveTrainingProgress()" 
                        style="flex: 1; padding: 12px; background: #607D8B;">
                    <i class="fas fa-save"></i> ä¿å­˜è¿›åº¦
                </button>
                
                <button class="btn" onclick="showStudentDashboard()" 
                        style="flex: 1; padding: 12px; background: #795548;">
                    <i class="fas fa-home"></i> è¿”å›
                </button>
            </div>
            
            <div style="margin-top: 20px; color: #666; font-size: 14px;">
                <p><i class="fas fa-mouse-pointer"></i> ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
                <p><i class="fas fa-star"></i> é€‰æ‹©é€‚å½“çš„æŒæ¡ç¨‹åº¦</p>
            </div>
        </div>
    `;
}

// ä¿å­˜è®­ç»ƒè¿›åº¦
function saveTrainingProgress() {
    if (appState.trainingWords.length === 0) return;
    
    const progress = {
        date: new Date().toDateString(),
        index: appState.currentWordIndex,
        total: appState.trainingWords.length,
        words: appState.trainingWords.map(w => w.id || w.word_id)
    };
    
    localStorage.setItem(`kathy_all_training_${appState.currentUser}`, JSON.stringify(progress));
    showAlert('è®­ç»ƒè¿›åº¦å·²ä¿å­˜ï¼', 'success');
}

// ç¿»è½¬è®­ç»ƒå¡ç‰‡
function flipTrainingCard() {
    appState.isCardFlipped = !appState.isCardFlipped;
    showTrainingScreenSimple();
}

// æ ‡è®°è®­ç»ƒå•è¯
async function markTrainingWord(status) {
    const word = appState.trainingWords[appState.currentWordIndex];
    
    try {
        // æ›´æ–°æ•°æ®åº“è®°å½•
        const { error } = await dbClient
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', appState.currentUser)
            .eq('word_id', word.word_id || word.id);
        
        if (error) throw error;
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        
        // ç«‹å³æ›´æ–°å…¨å±€çŠ¶æ€
        const globalIndex = appState.userWords.findIndex(w => 
            w.word_id === word.word_id || w.id === word.id
        );
        if (globalIndex !== -1) {
            appState.userWords[globalIndex] = { ...appState.userWords[globalIndex], ...word };
        }
        
        // è®°å½•æ‰“å¡
        await recordAttendance(appState.currentUser, 1, status === 'new' ? 1 : 0);
        
        // æ›´æ–°ä»Šæ—¥è®­ç»ƒè¿›åº¦
        if (status !== 'skip') {
            saveDailyTrainingProgress(1);
        }
        
        // æ˜¾ç¤ºåé¦ˆ
        const statusText = {
            'mastered': 'âœ… å·²æŒæ¡',
            'learning': 'ğŸ”„ å­¦ä¹ ä¸­',
            'new': 'ğŸ“ éœ€å­¦ä¹ '
        }[status];
        
        showAlert(`${statusText}: ${word.english}`, 'success');
        
        // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
        setTimeout(() => {
            appState.currentWordIndex++;
            appState.isCardFlipped = false;
            
            if (appState.currentWordIndex < appState.trainingWords.length) {
                showTrainingScreenSimple();
            } else {
                finishTraining();
            }
        }, 800);
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

// è·³è¿‡è®­ç»ƒå•è¯
function skipTrainingWord() {
    appState.currentWordIndex++;
    appState.isCardFlipped = false;
    
    if (appState.currentWordIndex < appState.trainingWords.length) {
        showTrainingScreenSimple();
    } else {
        finishTraining();
    }
}

// å®Œæˆè®­ç»ƒ
function finishTraining() {
    const total = appState.trainingWords.length;
    const mastered = appState.trainingWords.filter(w => w.status === 'mastered').length;
    const learning = appState.trainingWords.filter(w => w.status === 'learning').length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    // æ¸…é™¤è®­ç»ƒè¿›åº¦
    localStorage.removeItem(`kathy_all_training_${appState.currentUser}`);
    
    // æ›´æ–°å­¦ç”Ÿé¢æ¿æ•°æ®
    loadStudentDashboardSimple();
    
    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em; margin-bottom: 20px; color: #4CAF50;">
                <i class="fas fa-trophy"></i>
            </div>
            <h3 style="color: #333; margin-bottom: 15px;">è®­ç»ƒå®Œæˆï¼</h3>
            <div class="stats-card" style="max-width: 400px; margin: 0 auto;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">è®­ç»ƒå•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">å­¦ä¹ ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progress}%</div>
                        <div class="label">æŒæ¡ç‡</div>
                    </div>
                </div>
            </div>
            ${appState.dailyTrainingProgress >= 10 ? 
                '<div class="celebration-banner" style="margin: 20px auto; max-width: 400px;">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : ''}
            <div style="margin-top: 30px;">
                <button class="btn" onclick="startDailyTraining()" style="margin: 10px;">
                    <i class="fas fa-redo"></i> ç»§ç»­ä»Šæ—¥è®­ç»ƒ
                </button>
                <button class="btn btn-red" onclick="showStudentDashboard()" style="margin: 10px;">
                    <i class="fas fa-home"></i> è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
}

// å–æ¶ˆè®­ç»ƒ
function cancelTraining() {
    const confirmCancel = showConfirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„è®­ç»ƒè¿›åº¦å¯ä»¥ç¨åç»§ç»­ã€‚', 'ç»“æŸè®­ç»ƒ', 'ç»§ç»­å­¦ä¹ ');
    confirmCancel.then(result => {
        if (result) {
            saveTrainingProgress();
            showStudentDashboard();
        }
    });
}

// ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ==========

// æ˜¾ç¤ºä¸Šä¼ å•è¯é¡µé¢
function showUploadWordsPage() {
    showScreen('teacher-upload-screen');
    loadUploadWordsPage();
}

// åŠ è½½ä¸Šä¼ å•è¯é¡µé¢
async function loadUploadWordsPage() {
    const content = document.getElementById('teacher-upload-content');
    content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-upload"></i> ä¸Šä¼ å•è¯
            </h3>
            
            <!-- é€‰æ‹©åˆ†ç»„ -->
            <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #1565C0;">
                    <i class="fas fa-folder"></i> é€‰æ‹©åˆ†ç»„
                </label>
                <div id="group-select-container">
                    <div class="loader"></div>
                </div>
            </div>
            
            <div style="background: #E8F5E9; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                <h4 style="color: #2E7D32; margin-bottom: 15px;">
                    <i class="fas fa-info-circle"></i> ä¸Šä¼ è¯´æ˜
                </h4>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 8px 0; color: #666;">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼š<strong>è‹±æ–‡ ä¸­æ–‡</strong>
                    </p>
                    <p style="margin: 8px 0; color: #666;">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        ç¤ºä¾‹ï¼š<code>hello ä½ å¥½</code>
                    </p>
                    <p style="margin: 8px 0; color: #666;">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        æ”¯æŒçŸ­è¯­ï¼š<code>"good morning" æ—©ä¸Šå¥½</code>
                    </p>
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <textarea id="words-input" 
                          style="width: 100%; height: 300px; font-family: monospace; font-size: 16px; padding: 15px; border: 2px solid #ddd; border-radius: 10px;"
                          placeholder="è¾“å…¥å•è¯åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼š
apple è‹¹æœ
banana é¦™è•‰
"good morning" æ—©ä¸Šå¥½
computer ç”µè„‘"></textarea>
            </div>
            
            <div style="text-align: center; margin-bottom: 25px;">
                <button class="btn btn-blue" onclick="previewUploadWords()" style="margin: 5px;">
                    <i class="fas fa-eye"></i> é¢„è§ˆ
                </button>
                <button class="btn" onclick="submitUploadWords()" style="margin: 5px;">
                    <i class="fas fa-upload"></i> ä¸Šä¼ 
                </button>
                <button class="btn" onclick="loadExampleWords()" style="margin: 5px;">
                    <i class="fas fa-book"></i> ç¤ºä¾‹
                </button>
                <button class="btn btn-red" onclick="clearUploadForm()" style="margin: 5px;">
                    <i class="fas fa-trash"></i> æ¸…ç©º
                </button>
            </div>
            
            <div id="upload-preview" style="display: none;"></div>
            <div id="upload-result"></div>
        </div>
    `;
    
    setTimeout(loadGroupSelector, 100);
}

// åŠ è½½åˆ†ç»„é€‰æ‹©å™¨
async function loadGroupSelector() {
    try {
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (error) throw error;
        
        const container = document.getElementById('group-select-container');
        
        if (!groups || groups.length === 0) {
            container.innerHTML = `
                <p style="color: #666;">è¿˜æ²¡æœ‰åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºåˆ†ç»„</p>
                <button class="btn" onclick="showGroupManagementPage()" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> å»åˆ›å»ºåˆ†ç»„
                </button>
            `;
            return;
        }
        
        const selectedGroupId = appState.selectedGroupId || groups[0].id;
        
        let html = `<select id="selected-group" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">`;
        
        groups.forEach(group => {
            html += `<option value="${group.id}" ${group.id === selectedGroupId ? 'selected' : ''}>
                        ${group.name}
                     </option>`;
        });
        
        html += `</select>`;
        html += `<div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button class="btn" onclick="showGroupManagementPage()" style="padding: 8px 16px;">
                        <i class="fas fa-cog"></i> ç®¡ç†åˆ†ç»„
                    </button>
                    <button class="btn" onclick="createNewGroupFromUpload()" style="padding: 8px 16px;">
                        <i class="fas fa-plus"></i> æ–°å»ºåˆ†ç»„
                    </button>
                 </div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„é€‰æ‹©å™¨é”™è¯¯:', error);
        document.getElementById('group-select-container').innerHTML = 
            '<p style="color: red;">åŠ è½½åˆ†ç»„å¤±è´¥</p>';
    }
}

// é¢„è§ˆä¸Šä¼ å•è¯
function previewUploadWords() {
    const input = document.getElementById('words-input').value.trim();
    if (!input) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const lines = input.split('\n');
    const previewContainer = document.getElementById('upload-preview');
    previewContainer.innerHTML = '';
    
    let validCount = 0;
    let previewHTML = '';
    
    lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        if (trimmed.startsWith('#')) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            
            previewHTML += `
                <tr>
                    <td style="padding: 8px;">
                        <strong>${english}</strong>
                    </td>
                    <td style="padding: 8px;">${chinese}</td>
                    <td style="padding: 8px; color: #4CAF50;">
                        <i class="fas fa-check-circle"></i> æœ‰æ•ˆ
                    </td>
                </tr>
            `;
            validCount++;
        }
    });
    
    if (validCount > 0) {
        previewContainer.innerHTML = `
            <h4><i class="fas fa-eye"></i> é¢„è§ˆï¼ˆ${validCount} ä¸ªå•è¯ï¼‰</h4>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                <table style="width: 100%;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px;">è‹±æ–‡</th>
                            <th style="padding: 10px;">ä¸­æ–‡</th>
                            <th style="padding: 10px;">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>${previewHTML}</tbody>
                </table>
            </div>
        `;
        previewContainer.style.display = 'block';
        
        showAlert(`æ‰¾åˆ° ${validCount} ä¸ªæœ‰æ•ˆå•è¯`, 'success');
    } else {
        showAlert('æœªæ‰¾åˆ°æœ‰æ•ˆå•è¯ï¼Œè¯·æ£€æŸ¥æ ¼å¼', 'error');
    }
}

// æäº¤ä¸Šä¼ å•è¯
async function submitUploadWords() {
    const input = document.getElementById('words-input').value.trim();
    if (!input) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const groupSelect = document.getElementById('selected-group');
    const selectedGroupId = groupSelect ? groupSelect.value : null;
    
    if (!selectedGroupId) {
        showAlert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç»„', 'error');
        return;
    }
    
    const lines = input.split('\n');
    const rawWords = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (trimmed.startsWith('#')) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            rawWords.push({
                english: english,
                chinese: chinese
            });
        }
    });
    
    if (rawWords.length === 0) {
        showAlert('æ²¡æœ‰æœ‰æ•ˆå•è¯å¯ä¸Šä¼ ', 'error');
        return;
    }
    
    try {
        const { data: group, error: groupError } = await dbClient
            .from('groups')
            .select('name')
            .eq('id', selectedGroupId)
            .single();
        
        if (groupError) throw groupError;
        
        // å‡†å¤‡è¦æ’å…¥çš„å•è¯
        const wordsToInsert = rawWords.map(word => ({
            teacher_id: appState.teacherId,
            english: word.english,
            chinese: word.chinese,
            group_id: selectedGroupId
        }));
        
        // åˆ†æ‰¹ä¸Šä¼ 
        const BATCH_SIZE = 50;
        let totalUploaded = 0;
        
        for (let i = 0; i < wordsToInsert.length; i += BATCH_SIZE) {
            const batch = wordsToInsert.slice(i, i + BATCH_SIZE);
            const progress = Math.round(((i + batch.length) / wordsToInsert.length) * 100);
            
            document.getElementById('upload-result').innerHTML = `
                <div class="message-box message-info">
                    <h4><i class="fas fa-upload"></i> æ­£åœ¨ä¸Šä¼ å•è¯</h4>
                    <p>è¿›åº¦: ${progress}% (${Math.min(i + batch.length, wordsToInsert.length)}/${wordsToInsert.length})</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
            
            const { error: wordsError } = await dbClient
                .from('words')
                .insert(batch);
            
            if (wordsError) {
                console.error('æ‰¹é‡æ’å…¥é”™è¯¯:', wordsError);
                // å°è¯•é€ä¸ªæ’å…¥
                for (const word of batch) {
                    try {
                        const { error: singleError } = await dbClient
                            .from('words')
                            .insert(word);
                        if (!singleError) {
                            totalUploaded++;
                        }
                    } catch (err) {
                        console.error('å•ä¸ªæ’å…¥é”™è¯¯:', err);
                    }
                }
            } else {
                totalUploaded += batch.length;
            }
        }
        
        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        document.getElementById('upload-result').innerHTML = `
            <div class="message-box message-success">
                <h4><i class="fas fa-check-circle"></i> ä¸Šä¼ æˆåŠŸï¼</h4>
                <p>æˆåŠŸä¸Šä¼  <strong>${totalUploaded}</strong> ä¸ªæ–°å•è¯åˆ°åˆ†ç»„ <strong>"${group.name}"</strong></p>
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    <strong>æç¤ºï¼š</strong>å­¦ç”Ÿä¸‹æ¬¡ç™»å½•æ—¶ä¼šè‡ªåŠ¨åŒæ­¥è¿™äº›å•è¯
                </p>
            </div>
        `;
        
        document.getElementById('words-input').value = '';
        document.getElementById('upload-preview').style.display = 'none';
        
        setTimeout(() => {
            showTeacherDashboard();
        }, 2000);
        
    } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        document.getElementById('upload-result').innerHTML = `
            <div class="message-box message-error">
                <h4><i class="fas fa-times-circle"></i> ä¸Šä¼ å¤±è´¥</h4>
                <p>é”™è¯¯ï¼š${error.message}</p>
            </div>
        `;
    }
}

// åŠ è½½ç¤ºä¾‹å•è¯
function loadExampleWords() {
    document.getElementById('words-input').value = `hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
book ä¹¦
computer ç”µè„‘
teacher è€å¸ˆ
student å­¦ç”Ÿ
classroom æ•™å®¤
homework ä½œä¸š
exam è€ƒè¯•`;
    previewUploadWords();
}

// æ¸…ç©ºä¸Šä¼ è¡¨å•
function clearUploadForm() {
    document.getElementById('words-input').value = '';
    document.getElementById('upload-preview').style.display = 'none';
    document.getElementById('upload-result').innerHTML = '';
}

// æ˜¾ç¤ºåˆ†ç»„ç®¡ç†é¡µé¢
function showGroupManagementPage() {
    showScreen('teacher-groups-screen');
    loadGroupManagementPage();
}

// åŠ è½½åˆ†ç»„ç®¡ç†é¡µé¢
async function loadGroupManagementPage() {
    const content = document.getElementById('teacher-groups-content');
    content.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">
                <i class="fas fa-users"></i> åˆ†ç»„ç®¡ç†
            </h3>
            
            <div class="two-column">
                <!-- å·¦ä¾§ï¼šåˆ†ç»„åˆ—è¡¨ -->
                <div style="background: #f8f9fa; border-radius: 15px; padding: 25px;">
                    <h4 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-folder"></i> æˆ‘çš„åˆ†ç»„
                    </h4>
                    <div id="group-list">
                        <div class="loader"></div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> åˆ›å»ºæ–°åˆ†ç»„
                        </h4>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-group-name" placeholder="è¾“å…¥åˆ†ç»„åç§°" 
                                   style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <button class="btn" onclick="createNewGroup()">
                                <i class="fas fa-plus"></i> åˆ›å»º
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šåˆ†ç»„è¯¦æƒ… -->
                <div style="background: #f8f9fa; border-radius: 15px; padding: 25px;">
                    <h4 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> åˆ†ç»„è¯¦æƒ…
                    </h4>
                    <div id="group-detail">
                        <p style="text-align: center; color: #666;">é€‰æ‹©ä¸€ä¸ªåˆ†ç»„æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    setTimeout(loadGroupList, 100);
}

// åŠ è½½åˆ†ç»„åˆ—è¡¨
async function loadGroupList() {
    try {
        const { data: groups, error } = await dbClient
            .from('groups')
            .select(`
                *,
                words(count),
                group_students(count)
            `)
            .eq('teacher_id', appState.teacherId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const groupListDiv = document.getElementById('group-list');
        
        if (!groups || groups.length === 0) {
            groupListDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #666;">è¿˜æ²¡æœ‰åˆ›å»ºåˆ†ç»„</p>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
        
        groups.forEach(group => {
            const wordCount = group.words?.[0]?.count || 0;
            const studentCount = group.group_students?.[0]?.count || 0;
            const createdDate = new Date(group.created_at).toLocaleDateString('zh-CN');
            
            html += `
                <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; cursor: pointer;"
                     onclick="showGroupDetail('${group.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0; color: #333; font-size: 1.2em;">
                            <i class="fas fa-folder"></i> ${group.name}
                        </h5>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                    onclick="event.stopPropagation(); renameGroup('${group.id}', '${group.name}')">
                                <i class="fas fa-edit"></i> æ”¹å
                            </button>
                            <button class="btn btn-red" style="padding: 6px 12px; font-size: 14px;" 
                                    onclick="event.stopPropagation(); deleteGroup('${group.id}', '${group.name}')">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; color: #666; font-size: 0.9em;">
                        <div><i class="fas fa-book"></i> å•è¯: <strong>${wordCount}</strong></div>
                        <div><i class="fas fa-user"></i> å­¦ç”Ÿ: <strong>${studentCount}</strong></div>
                    </div>
                    <div style="color: #999; font-size: 0.8em; margin-top: 10px;">
                        <i class="fas fa-calendar"></i> åˆ›å»ºäº: ${createdDate}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        groupListDiv.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨é”™è¯¯:', error);
        document.getElementById('group-list').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// åˆ›å»ºæ–°åˆ†ç»„
async function createNewGroup() {
    const groupNameInput = document.getElementById('new-group-name');
    const groupName = groupNameInput.value.trim();
    
    if (!groupName) {
        showAlert('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error');
        return;
    }
    
    try {
        const { error } = await dbClient
            .from('groups')
            .insert([{
                name: groupName,
                teacher_id: appState.teacherId
            }]);
        
        if (error) throw error;
        
        showAlert(`åˆ†ç»„ "${groupName}" åˆ›å»ºæˆåŠŸ`, 'success');
        groupNameInput.value = '';
        loadGroupList();
        
    } catch (error) {
        console.error('åˆ›å»ºåˆ†ç»„é”™è¯¯:', error);
        showAlert('åˆ›å»ºåˆ†ç»„å¤±è´¥', 'error');
    }
}

// é‡å‘½ååˆ†ç»„
async function renameGroup(groupId, oldName) {
    const newName = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç»„åç§°ï¼š', oldName);
    if (!newName || newName.trim() === '') return;
    
    try {
        const { error } = await dbClient
            .from('groups')
            .update({ name: newName.trim() })
            .eq('id', groupId)
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        showAlert(`åˆ†ç»„å·²é‡å‘½åä¸º "${newName}"`, 'success');
        loadGroupList();
        showGroupDetail(groupId);
        
    } catch (error) {
        console.error('é‡å‘½ååˆ†ç»„é”™è¯¯:', error);
        showAlert('é‡å‘½åå¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºåˆ†ç»„è¯¦æƒ…
async function showGroupDetail(groupId) {
    try {
        // è·å–åˆ†ç»„ä¿¡æ¯
        const { data: group, error: groupError } = await dbClient
            .from('groups')
            .select('*')
            .eq('id', groupId)
            .single();
        
        if (groupError) throw groupError;
        
        // è·å–åˆ†ç»„å­¦ç”Ÿ
        const { data: groupStudents, error: studentsError } = await dbClient
            .from('group_students')
            .select('student_id')
            .eq('group_id', groupId);
        
        if (studentsError) throw studentsError;
        
        // è·å–æ‰€æœ‰å­¦ç”Ÿ
        const { data: allStudents, error: allStudentsError } = await dbClient
            .from('users')
            .select('username, created_at')
            .eq('is_teacher', false)
            .order('username');
        
        if (allStudentsError) throw allStudentsError;
        
        // è·å–åˆ†ç»„å•è¯
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .eq('group_id', groupId)
            .order('created_at', { ascending: false })
            .limit(20);
        
        if (wordsError) throw wordsError;
        
        // å½“å‰åˆ†ç»„ä¸­çš„å­¦ç”ŸIDé›†åˆ
        const groupStudentIds = new Set(groupStudents?.map(gs => gs.student_id) || []);
        
        const detailDiv = document.getElementById('group-detail');
        
        detailDiv.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h4 style="color: #333; margin-bottom: 15px;">
                    <i class="fas fa-folder-open"></i> ${group.name}
                </h4>
                <p style="color: #666;">
                    <i class="fas fa-calendar"></i> åˆ›å»ºäº: ${new Date(group.created_at).toLocaleDateString('zh-CN')}
                </p>
            </div>
            
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h5 style="margin: 0; color: #333;">
                        <i class="fas fa-user-friends"></i> å­¦ç”Ÿç®¡ç†
                    </h5>
                    <button class="btn" onclick="addAllStudentsToGroup('${groupId}')">
                        <i class="fas fa-user-plus"></i> æ·»åŠ æ‰€æœ‰å­¦ç”Ÿ
                    </button>
                </div>
                
                <div style="background: white; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; text-align: left;">å­¦ç”Ÿ</th>
                                <th style="padding: 10px; text-align: left;">æ³¨å†Œæ—¶é—´</th>
                                <th style="padding: 10px; text-align: center;">çŠ¶æ€</th>
                                <th style="padding: 10px; text-align: center;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allStudents.map(student => {
                                const isInGroup = groupStudentIds.has(student.username);
                                return `
                                    <tr>
                                        <td style="padding: 10px;">
                                            <i class="fas fa-user"></i> ${student.username}
                                        </td>
                                        <td style="padding: 10px; color: #666;">
                                            ${new Date(student.created_at).toLocaleDateString('zh-CN')}
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            ${isInGroup ? 
                                                '<span style="color: #4CAF50; font-weight: bold;"><i class="fas fa-check-circle"></i> å·²åŠ å…¥</span>' : 
                                                '<span style="color: #FF9800;"><i class="fas fa-times-circle"></i> æœªåŠ å…¥</span>'}
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            ${isInGroup ? 
                                                `<button class="btn btn-red" style="padding: 4px 8px; font-size: 13px;" 
                                                         onclick="removeStudentFromGroup('${groupId}', '${student.username}')">
                                                    <i class="fas fa-user-minus"></i> ç§»é™¤
                                                </button>` :
                                                `<button class="btn" style="padding: 4px 8px; font-size: 13px;" 
                                                         onclick="addStudentToGroup('${groupId}', '${student.username}')">
                                                    <i class="fas fa-user-plus"></i> æ·»åŠ 
                                                </button>`}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                    å·²é€‰æ‹© ${groupStudentIds.size} åå­¦ç”Ÿ
                </p>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h5 style="margin: 0; color: #333; margin-bottom: 15px;">
                    <i class="fas fa-book"></i> åˆ†ç»„å•è¯ (${groupWords?.length || 0}ä¸ª)
                </h5>
                ${groupWords && groupWords.length > 0 ? `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${groupWords.map(word => `
                            <div style="background: #e8f5e9; border: 1px solid #4CAF50; border-radius: 6px; padding: 8px 12px;">
                                <strong>${word.english}</strong> - ${word.chinese}
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <p style="color: #666; text-align: center;">è¿™ä¸ªåˆ†ç»„è¿˜æ²¡æœ‰å•è¯</p>
                `}
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-blue" onclick="uploadWordsToGroup('${groupId}')">
                    <i class="fas fa-upload"></i> ä¸Šä¼ å•è¯åˆ°è¿™ä¸ªåˆ†ç»„
                </button>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„è¯¦æƒ…é”™è¯¯:', error);
        document.getElementById('group-detail').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// æ·»åŠ å­¦ç”Ÿåˆ°åˆ†ç»„
async function addStudentToGroup(groupId, studentId) {
    try {
        const { error } = await dbClient
            .from('group_students')
            .insert([{
                group_id: groupId,
                student_id: studentId
            }]);
        
        if (error) {
            // å¦‚æœå­¦ç”Ÿå·²ç»åœ¨åˆ†ç»„ä¸­ï¼Œå¿½ç•¥é”™è¯¯
            if (error.code === '23505') {
                showAlert(`${studentId} å·²ç»åœ¨åˆ†ç»„ä¸­`, 'info');
                return;
            }
            throw error;
        }
        
        showAlert(`å·²æ·»åŠ  ${studentId} åˆ°åˆ†ç»„`, 'success');
        
        // ç«‹å³ä¸ºå­¦ç”ŸåŒæ­¥åˆ†ç»„å•è¯
        await syncGroupWordsToStudent(studentId);
        
        showGroupDetail(groupId);
        
    } catch (error) {
        console.error('æ·»åŠ å­¦ç”Ÿé”™è¯¯:', error);
        showAlert('æ·»åŠ å¤±è´¥', 'error');
    }
}

// ä»åˆ†ç»„ä¸­ç§»é™¤å­¦ç”Ÿ
async function removeStudentFromGroup(groupId, studentId) {
    try {
        const { error } = await dbClient
            .from('group_students')
            .delete()
            .eq('group_id', groupId)
            .eq('student_id', studentId);
        
        if (error) throw error;
        
        showAlert(`å·²ä»åˆ†ç»„ä¸­ç§»é™¤ ${studentId}`, 'success');
        showGroupDetail(groupId);
        
    } catch (error) {
        console.error('ç§»é™¤å­¦ç”Ÿé”™è¯¯:', error);
        showAlert('ç§»é™¤å¤±è´¥', 'error');
    }
}

// åˆ é™¤åˆ†ç»„
async function deleteGroup(groupId, groupName) {
    const confirmDelete = await showConfirm(
        `ç¡®å®šè¦åˆ é™¤åˆ†ç»„ "${groupName}" å—ï¼Ÿåˆ†ç»„å†…çš„å•è¯ä¸ä¼šè¢«åˆ é™¤ï¼Œä½†ä¼šç§»å‡ºåˆ†ç»„ã€‚`,
        'ç¡®å®šåˆ é™¤',
        'å–æ¶ˆ'
    );
    
    if (!confirmDelete) {
        return;
    }
    
    try {
        // åˆ é™¤åˆ†ç»„ï¼ˆçº§è”åˆ é™¤group_studentsè®°å½•ï¼‰
        const { error } = await dbClient
            .from('groups')
            .delete()
            .eq('id', groupId);
        
        if (error) throw error;
        
        showAlert(`åˆ†ç»„ "${groupName}" å·²åˆ é™¤`, 'success');
        loadGroupList();
        document.getElementById('group-detail').innerHTML = 
            '<p style="text-align: center; color: #666;">é€‰æ‹©ä¸€ä¸ªåˆ†ç»„æŸ¥çœ‹è¯¦æƒ…</p>';
        
    } catch (error) {
        console.error('åˆ é™¤åˆ†ç»„é”™è¯¯:', error);
        showAlert('åˆ é™¤å¤±è´¥', 'error');
    }
}

// ========== å…¶ä»–æ•™å¸ˆåŠŸèƒ½ ==========

function showAttendanceReport() {
    showScreen('teacher-attendance-screen');
    loadAttendanceReport();
}

async function loadAttendanceReport() {
    try {
        const content = document.getElementById('teacher-attendance-content');
        content.innerHTML = '<div class="loader"></div>';
        
        // è·å–å­¦ç”Ÿåˆ—è¡¨
        const { data: students, error } = await dbClient
            .from('users')
            .select('username, consecutive_days, last_study_date')
            .eq('is_teacher', false);
        
        if (error) throw error;
        
        if (!students || students.length === 0) {
            content.innerHTML = '<p style="text-align: center;">æ²¡æœ‰å­¦ç”Ÿæ•°æ®</p>';
            return;
        }
        
        let html = `
            <h3 style="color: #333; margin-bottom: 20px;">
                <i class="fas fa-calendar-check"></i> å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡
            </h3>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>è¿ç»­å¤©æ•°</th>
                            <th>æœ€åå­¦ä¹ </th>
                            <th>æœ¬å‘¨å­¦ä¹ å¤©æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const student of students) {
            // è·å–æœ¬å‘¨å­¦ä¹ å¤©æ•°
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(startOfWeek.getDate() - 7);
            
            const { data: weeklyAttendance } = await dbClient
                .from('attendance_records')
                .select('study_date')
                .eq('student_id', student.username)
                .gte('study_date', startOfWeek.toISOString().split('T')[0]);
            
            const weeklyDays = weeklyAttendance?.length || 0;
            
            const lastStudy = student.last_study_date ? 
                new Date(student.last_study_date).toLocaleDateString('zh-CN') : 'ä»æœªå­¦ä¹ ';
            
            html += `
                <tr>
                    <td><strong><i class="fas fa-user"></i> ${student.username}</strong></td>
                    <td>
                        ${student.consecutive_days > 0 ? `
                            <div class="streak-badge" style="padding: 5px 10px; font-size: 0.9em; display: inline-flex;">
                                <i class="fas fa-fire"></i> ${student.consecutive_days}å¤©
                            </div>
                        ` : '0å¤©'}
                    </td>
                    <td>${lastStudy}</td>
                    <td>${weeklyDays}å¤©</td>
                </tr>
            `;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡ç»Ÿè®¡é”™è¯¯:', error);
        document.getElementById('teacher-attendance-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// ========== å…¶ä»–åŠŸèƒ½ ==========

function showAllStudentsPage() {
    showScreen('teacher-students-screen');
    loadAllStudentsPage();
}

function showLearningProgressPage() {
    showScreen('teacher-progress-screen');
    loadLearningProgressPage();
}

function showWordManagementPage() {
    showScreen('teacher-words-screen');
    loadWordManagementPage();
}

function showShareSystemPage() {
    showScreen('teacher-share-screen');
    loadShareSystemPage();
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    const confirmLogout = showConfirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'é€€å‡º', 'å–æ¶ˆ');
    confirmLogout.then(result => {
        if (!result) return;
        
        // æ¸…é™¤çŠ¶æ€
        appState.currentUser = null;
        appState.isTeacher = false;
        appState.userId = null;
        appState.userWords = [];
        appState.trainingWords = [];
        appState.selectedGroupId = null;
        appState.selectedWords = [];
        appState.dailyTrainingProgress = 0;
        appState.lastTrainingDate = null;
        appState.consecutiveDays = 0;
        appState.lastStudyDate = null;
        appState.attendanceStreak = 0;
        appState.todayStudyCount = 0;
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        
        // è¿”å›ç™»å½•é¡µé¢
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
    });
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        appState.currentUser = savedUser;
        appState.isTeacher = (savedRole === 'teacher');
        appState.userId = savedUser;
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        await testDatabase();
        
        if (appState.isTeacher) {
            showTeacherDashboard();
        } else {
            showStudentDashboard();
        }
    } else {
        // æ–°ç”¨æˆ·ï¼Œæµ‹è¯•æ•°æ®åº“è¿æ¥
        testDatabase();
    }
};
</script>
</body>
</html>
