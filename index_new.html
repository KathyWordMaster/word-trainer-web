<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯è®­ç»ƒè¥ - åˆ†ç»„ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        
        input[type="text"], textarea, select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        .word-card { background: white; border: 4px solid #4CAF50; border-radius: 20px; height: 280px; display: flex; align-items: center; justify-content: center; margin: 30px auto; cursor: pointer; font-size: 2.8em; font-weight: bold; transition: all 0.3s; max-width: 600px; }
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .group-badge { display: inline-block; background: #E3F2FD; color: #1565C0; padding: 4px 12px; border-radius: 20px; margin: 2px 5px; font-size: 0.9em; }
        
        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { height: 220px; font-size: 2.2em; margin: 20px 10px; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š Kathyå•è¯è®­ç»ƒè¥ - åˆ†ç»„ç³»ç»Ÿ</h1>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151 | ğŸ¯ åˆ†ç»„ç®¡ç†å•è¯</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨åˆ†ç»„å•è¯ç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">æ•™å¸ˆåˆ›å»ºåˆ†ç»„ï¼Œä¸ºä¸åŒå­¦ç”Ÿåˆ†é…ä¸åŒå•è¯</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box" style="padding: 15px; border-radius: 8px; margin: 10px auto; max-width: 500px; background: #D1ECF1; color: #0C5460;">
                            æ­£åœ¨è¿æ¥ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testConnection()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ“± ç³»ç»Ÿç‰¹è‰²</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ‘¥</div>
                                <div style="font-weight: bold; margin: 10px 0;">åˆ†ç»„ç®¡ç†</div>
                                <div>ä¸ºä¸åŒå­¦ç”Ÿåˆ›å»ºä¸åŒåˆ†ç»„</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ¯</div>
                                <div style="font-weight: bold; margin: 10px 0;">ç²¾å‡†åˆ†é…</div>
                                <div>æŒ‡å®šå­¦ç”Ÿå­¦ä¹ çš„å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“Š</div>
                                <div style="font-weight: bold; margin: 10px 0;">è¿›åº¦ç›‘æ§</div>
                                <div>æŸ¥çœ‹æ¯ä¸ªåˆ†ç»„å­¦ä¹ æƒ…å†µ</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ”„</div>
                                <div style="font-weight: bold; margin: 10px 0;">çµæ´»è°ƒæ•´</div>
                                <div>éšæ—¶è°ƒæ•´åˆ†ç»„å’Œå•è¯</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <p><strong>æµ‹è¯•è´¦å·ï¼š</strong></p>
                            <p>â€¢ æ•™å¸ˆï¼škathy151</p>
                            <p>â€¢ å­¦ç”Ÿï¼šä»»æ„è‹±æ–‡åæ³¨å†Œ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘‘ åˆ†ç»„ç®¡ç†ç³»ç»Ÿ</h2>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-purple" onclick="showGroups()">
                            <span>ğŸ‘¥ åˆ†ç»„ç®¡ç†</span>
                        </button>
                        <button class="btn btn-blue" onclick="showGroupWords()">
                            <span>ğŸ“ åˆ†ç»„å•è¯</span>
                        </button>
                        <button class="btn" onclick="showAllStudents()">
                            <span>ğŸ“ å­¦ç”Ÿç®¡ç†</span>
                        </button>
                        <button class="btn btn-gold" onclick="showProgress()">
                            <span>ğŸ“Š å­¦ä¹ è¿›åº¦</span>
                        </button>
                        <button class="btn" onclick="showStats()">
                            <span>ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="handleLogout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
                
                <div id="teacher-content">
                    <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <h2 id="student-welcome" style="text-align: center; margin-bottom: 30px;">ğŸ“ æˆ‘çš„å­¦ä¹ ä¸­å¿ƒ</h2>
                
                <div id="student-stats" class="stats-card">
                    <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š å­¦ä¹ æ¦‚å†µ</h3>
                    <div id="student-stats-content">
                        <!-- åŠ¨æ€åŠ è½½å­¦ç”Ÿç»Ÿè®¡ -->
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn" onclick="startLearning()">
                            <span>ğŸ¯ å¼€å§‹å­¦ä¹ </span>
                        </button>
                        <button class="btn btn-blue" onclick="showMyWords()">
                            <span>ğŸ“– æˆ‘çš„å•è¯</span>
                        </button>
                        <button class="btn" onclick="showMyGroups()">
                            <span>ğŸ‘¥ æˆ‘çš„åˆ†ç»„</span>
                        </button>
                        <button class="btn btn-gold" onclick="reviewWeak()">
                            <span>ğŸ”„ å¤ä¹ å¼±é¡¹</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="handleLogout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
                
                <div id="student-content">
                    <!-- å­¦ç”ŸåŠŸèƒ½å†…å®¹åŒº -->
                </div>
            </div>
        </div>
    </div>

<script>
// ========== é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const app = {
    user: null,
    isTeacher: false,
    userId: null,
    teacherId: 'kathy151',
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    currentGroup: null
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.style.background = type === 'error' ? '#F8D7DA' : 
                         type === 'success' ? '#D4EDDA' : 
                         type === 'warning' ? '#FFF3CD' : '#D1ECF1';
    el.style.color = type === 'error' ? '#721C24' : 
                    type === 'success' ? '#155724' : 
                    type === 'warning' ? '#856404' : '#0C5460';
}

function showAlert(message, type = 'info') {
    alert(`ã€${type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ’¡'}ã€‘${message}`);
}

// ========== æ•°æ®åº“åˆå§‹åŒ– ==========
async function initDatabase() {
    try {
        const { error } = await supabase.from('users').select('count').limit(1);
        if (error) throw error;
        return true;
    } catch (error) {
        console.error('æ•°æ®åº“é”™è¯¯:', error);
        return false;
    }
}

// ========== ç™»å½•ç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // æ–°ç”¨æˆ·æ³¨å†Œ
            const isTeacherAccount = username.toLowerCase() === app.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await supabase
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            app.user = username;
            app.isTeacher = isTeacherAccount;
            app.userId = username;
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
        } else if (checkError) {
            throw checkError;
        } else {
            // è€ç”¨æˆ·ç™»å½•
            app.user = username;
            app.isTeacher = existingUser.is_teacher;
            app.userId = username;
            
            await supabase
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_user', username);
        localStorage.setItem('kathy_role', app.isTeacher ? 'teacher' : 'student');
        
        // è·³è½¬
        setTimeout(() => {
            if (app.isTeacher) {
                showScreen('teacher-screen');
                loadTeacherHome();
            } else {
                showScreen('student-screen');
                document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                loadStudentHome();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function loadTeacherHome() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 20px;">âœ¨ åˆ†ç»„ç®¡ç†ç³»ç»Ÿ</h3>
            <p style="color: #666; margin-bottom: 30px;">åˆ›å»ºåˆ†ç»„ï¼Œä¸ºä¸åŒå­¦ç”Ÿåˆ†é…ä¸åŒçš„å•è¯</p>
            
            <div class="card-grid">
                <div class="stat-card" onclick="showGroups()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ‘¥</div>
                    <div style="font-weight: bold; margin: 15px 0;">åˆ†ç»„ç®¡ç†</div>
                    <div>åˆ›å»ºå’Œç®¡ç†åˆ†ç»„</div>
                </div>
                <div class="stat-card" onclick="showGroupWords()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ“</div>
                    <div style="font-weight: bold; margin: 15px 0;">åˆ†ç»„å•è¯</div>
                    <div>ä¸ºåˆ†ç»„æ·»åŠ å•è¯</div>
                </div>
                <div class="stat-card" onclick="showAllStudents()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ“</div>
                    <div style="font-weight: bold; margin: 15px 0;">å­¦ç”Ÿç®¡ç†</div>
                    <div>ç®¡ç†å­¦ç”Ÿå’Œåˆ†ç»„</div>
                </div>
                <div class="stat-card" onclick="showProgress()" style="cursor: pointer;">
                    <div style="font-size: 2.5em;">ğŸ“Š</div>
                    <div style="font-weight: bold; margin: 15px 0;">å­¦ä¹ è¿›åº¦</div>
                    <div>æŸ¥çœ‹åˆ†ç»„è¿›åº¦</div>
                </div>
            </div>
            
            <div style="margin-top: 40px; background: #f8f9fa; border-radius: 10px; padding: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ä½¿ç”¨æµç¨‹</h4>
                <p style="color: #666; margin: 8px 0;">1. åˆ›å»ºåˆ†ç»„ï¼ˆå¦‚ï¼šåŸºç¡€ç­ã€æé«˜ç­ï¼‰</p>
                <p style="color: #666; margin: 8px 0;">2. ä¸ºåˆ†ç»„æ·»åŠ å•è¯</p>
                <p style="color: #666; margin: 8px 0;">3. å°†å­¦ç”Ÿåˆ†é…åˆ°åˆ†ç»„</p>
                <p style="color: #666; margin: 8px 0;">4. å­¦ç”Ÿå³å¯å­¦ä¹ å¯¹åº”åˆ†ç»„çš„å•è¯</p>
            </div>
        </div>
    `;
}

// åˆ†ç»„ç®¡ç†
async function showGroups() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3 style="color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h3>
                <button class="btn btn-blue" onclick="createNewGroup()">åˆ›å»ºæ–°åˆ†ç»„</button>
            </div>
            
            <div id="groups-list">
                <p style="text-align: center;">åŠ è½½åˆ†ç»„åˆ—è¡¨...</p>
            </div>
        </div>
    `;
    
    loadGroupsList();
}

async function loadGroupsList() {
    try {
        const { data: groups, error } = await supabase
            .from('word_groups')
            .select('*')
            .eq('teacher_id', app.teacherId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('groups-list');
        
        if (!groups || groups.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰åˆ†ç»„</h3>
                    <p style="color: #999; margin-bottom: 25px;">ç‚¹å‡»"åˆ›å»ºæ–°åˆ†ç»„"æŒ‰é’®å¼€å§‹</p>
                    <button class="btn btn-blue" onclick="createNewGroup()">åˆ›å»ºåˆ†ç»„</button>
                </div>
            `;
            return;
        }
        
        // è·å–æ¯ä¸ªåˆ†ç»„çš„å­¦ç”Ÿæ•°é‡å’Œå•è¯æ•°é‡
        const groupsWithStats = await Promise.all(groups.map(async (group) => {
            // è·å–å­¦ç”Ÿæ•°é‡
            const { data: students } = await supabase
                .from('student_group_memberships')
                .select('student_id')
                .eq('group_id', group.id);
            
            // è·å–å•è¯æ•°é‡
            const { data: words } = await supabase
                .from('group_words')
                .select('count')
                .eq('group_id', group.id);
            
            return {
                ...group,
                studentCount: students?.length || 0,
                wordCount: words?.[0]?.count || 0,
                createdDate: new Date(group.created_at).toLocaleDateString('zh-CN')
            };
        }));
        
        let html = `
            <div class="card-grid">
                ${groupsWithStats.map(group => `
                    <div class="stat-card" style="text-align: left; cursor: pointer;" onclick="manageGroup(${group.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 10px;">${group.name}</h4>
                                ${group.description ? `<p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">${group.description}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); editGroup(${group.id})">ç¼–è¾‘</button>
                                <button class="btn btn-red" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); deleteGroup(${group.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #2196F3;">${group.wordCount}</div>
                                <div style="color: #666; font-size: 0.8em;">å•è¯æ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #4CAF50;">${group.studentCount}</div>
                                <div style="color: #666; font-size: 0.8em;">å­¦ç”Ÿæ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; color: #999;">${group.createdDate}</div>
                                <div style="color: #666; font-size: 0.8em;">åˆ›å»ºæ—¶é—´</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn" style="padding: 8px 16px; font-size: 14px; width: 100%;" onclick="event.stopPropagation(); manageGroupWords(${group.id})">ç®¡ç†å•è¯</button>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-red" onclick="loadTeacherHome()">
                    <span>ğŸ”™ è¿”å›ä¸»é¢æ¿</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„é”™è¯¯:', error);
        document.getElementById('groups-list').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function createNewGroup() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 600px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ“ åˆ›å»ºæ–°åˆ†ç»„</h3>
            
            <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ åˆ†ç»„å‘½åå»ºè®®</h4>
                <p style="color: #666; margin: 8px 0;">â€¢ åŸºç¡€ç­ã€æé«˜ç­ã€å†²åˆºç­</p>
                <p style="color: #666; margin: 8px 0;">â€¢ Aç­ã€Bç­ã€Cç­</p>
                <p style="color: #666; margin: 8px 0;">â€¢ æŒ‰ç…§å­¦ç”Ÿæ°´å¹³æˆ–ç­çº§å‘½å</p>
            </div>
            
            <input type="text" id="group-name" placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°ï¼ˆå¦‚ï¼šåŸºç¡€ç­ï¼‰">
            <textarea id="group-desc" placeholder="åˆ†ç»„æè¿°ï¼ˆå¯é€‰ï¼‰ï¼šè¯´æ˜è¿™ä¸ªåˆ†ç»„çš„ç‰¹ç‚¹"></textarea>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-blue" onclick="saveNewGroup()">åˆ›å»ºåˆ†ç»„</button>
                <button class="btn btn-red" onclick="showGroups()">å–æ¶ˆè¿”å›</button>
            </div>
            
            <div id="group-result"></div>
        </div>
    `;
}

async function saveNewGroup() {
    const name = document.getElementById('group-name').value.trim();
    const desc = document.getElementById('group-desc').value.trim();
    
    if (!name) {
        showAlert('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('word_groups')
            .insert([{
                name: name,
                description: desc,
                teacher_id: app.teacherId
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        document.getElementById('group-result').innerHTML = `
            <div style="background: #D4EDDA; color: #155724; padding: 15px; border-radius: 8px; margin-top: 20px;">
                âœ… åˆ†ç»„ "${name}" åˆ›å»ºæˆåŠŸï¼
            </div>
        `;
        
        setTimeout(() => showGroups(), 1500);
        
    } catch (error) {
        console.error('åˆ›å»ºåˆ†ç»„é”™è¯¯:', error);
        document.getElementById('group-result').innerHTML = `
            <div style="background: #F8D7DA; color: #721C24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}
            </div>
        `;
    }
}

async function manageGroup(groupId) {
    app.currentGroup = groupId;
    
    // è·å–åˆ†ç»„ä¿¡æ¯
    const { data: group } = await supabase
        .from('word_groups')
        .select('*')
        .eq('id', groupId)
        .single();
    
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3 style="color: #333;">ğŸ“š åˆ†ç»„ï¼š${group.name}</h3>
                <button class="btn btn-red" onclick="showGroups()">è¿”å›åˆ†ç»„åˆ—è¡¨</button>
            </div>
            
            <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                <button class="btn btn-blue" onclick="manageGroupWords(${groupId})">ğŸ“ ç®¡ç†å•è¯</button>
                <button class="btn" onclick="manageGroupStudents(${groupId})">ğŸ“ ç®¡ç†å­¦ç”Ÿ</button>
                <button class="btn" onclick="viewGroupProgress(${groupId})">ğŸ“Š å­¦ä¹ è¿›åº¦</button>
            </div>
            
            <div id="group-management-content">
                <p style="text-align: center;">åŠ è½½åˆ†ç»„ä¿¡æ¯...</p>
            </div>
        </div>
    `;
    
    loadGroupManagement(groupId, group.name);
}

async function loadGroupManagement(groupId, groupName) {
    try {
        // è·å–åˆ†ç»„ç»Ÿè®¡
        const { data: students } = await supabase
            .from('student_group_memberships')
            .select('student_id')
            .eq('group_id', groupId);
        
        const { data: words } = await supabase
            .from('group_words')
            .select('count')
            .eq('group_id', groupId);
        
        const studentCount = students?.length || 0;
        const wordCount = words?.[0]?.count || 0;
        
        const content = document.getElementById('group-management-content');
        content.innerHTML = `
            <div class="stats-card">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${wordCount}</div>
                        <div class="label">å•è¯æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${studentCount}</div>
                        <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ“‹ å¿«é€Ÿæ“ä½œ</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        <button class="btn" onclick="addWordsToGroup(${groupId})">æ·»åŠ å•è¯</button>
                        <button class="btn btn-blue" onclick="addStudentsToGroup(${groupId})">æ·»åŠ å­¦ç”Ÿ</button>
                        <button class="btn" onclick="viewGroupWords(${groupId})">æŸ¥çœ‹å•è¯</button>
                        <button class="btn" onclick="viewGroupStudents(${groupId})">æŸ¥çœ‹å­¦ç”Ÿ</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ åˆ†ç»„è¯´æ˜</h4>
                <p style="color: #666;">åˆ†ç»„åç§°ï¼š<strong>${groupName}</strong></p>
                <p style="color: #666;">åˆ†ç»„IDï¼š<code>${groupId}</code></p>
                <p style="color: #666;">è¯¥åˆ†ç»„çš„å­¦ç”Ÿå¯ä»¥å­¦ä¹  ${wordCount} ä¸ªå•è¯</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„ç®¡ç†é”™è¯¯:', error);
        document.getElementById('group-management-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// åˆ†ç»„å•è¯ç®¡ç†
async function showGroupWords() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3 style="color: #333;">ğŸ“ åˆ†ç»„å•è¯ç®¡ç†</h3>
                <button class="btn btn-red" onclick="loadTeacherHome()">è¿”å›ä¸»é¢æ¿</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <p style="color: #666; margin-bottom: 15px;">é€‰æ‹©è¦ç®¡ç†çš„åˆ†ç»„ï¼š</p>
                <select id="group-select" style="width: 100%; max-width: 400px; padding: 12px; border-radius: 8px; border: 2px solid #ddd;" onchange="loadSelectedGroupWords()">
                    <option value="">è¯·é€‰æ‹©åˆ†ç»„...</option>
                </select>
            </div>
            
            <div id="group-words-content">
                <p style="text-align: center;">è¯·å…ˆé€‰æ‹©åˆ†ç»„</p>
            </div>
        </div>
    `;
    
    loadGroupSelectOptions();
}

async function loadGroupSelectOptions() {
    try {
        const { data: groups, error } = await supabase
            .from('word_groups')
            .select('id, name')
            .eq('teacher_id', app.teacherId)
            .order('name');
        
        if (error) throw error;
        
        const select = document.getElementById('group-select');
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                select.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„é€‰é¡¹é”™è¯¯:', error);
    }
}

async function loadSelectedGroupWords() {
    const groupId = document.getElementById('group-select').value;
    if (!groupId) return;
    
    app.currentGroup = groupId;
    manageGroupWords(groupId);
}

async function manageGroupWords(groupId) {
    try {
        // è·å–åˆ†ç»„ä¿¡æ¯
        const { data: group } = await supabase
            .from('word_groups')
            .select('name')
            .eq('id', groupId)
            .single();
        
        if (!group) {
            showAlert('åˆ†ç»„ä¸å­˜åœ¨', 'error');
            return;
        }
        
        const content = document.getElementById('teacher-content') || document.getElementById('group-words-content');
        
        content.innerHTML = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h3 style="color: #333;">ğŸ“š åˆ†ç»„ï¼š${group.name} - å•è¯ç®¡ç†</h3>
                    <div>
                        <button class="btn btn-blue" onclick="addWordsToGroup(${groupId})">æ·»åŠ å•è¯</button>
                        <button class="btn btn-red" onclick="showGroupWords()">è¿”å›</button>
                    </div>
                </div>
                
                <div id="group-words-list">
                    <p style="text-align: center;">åŠ è½½å•è¯åˆ—è¡¨...</p>
                </div>
            </div>
        `;
        
        loadGroupWordsList(groupId, group.name);
        
    } catch (error) {
        console.error('ç®¡ç†åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert('åŠ è½½åˆ†ç»„å•è¯å¤±è´¥', 'error');
    }
}

async function loadGroupWordsList(groupId, groupName) {
    try {
        const { data: words, error } = await supabase
            .from('group_words')
            .select('*')
            .eq('group_id', groupId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('group-words-list');
        
        if (!words || words.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“</div>
                    <h3 style="color: #666; margin-bottom: 15px;">åˆ†ç»„è¿˜æ²¡æœ‰å•è¯</h3>
                    <p style="color: #999; margin-bottom: 25px;">ç‚¹å‡»"æ·»åŠ å•è¯"æŒ‰é’®ä¸ºè¯¥åˆ†ç»„æ·»åŠ å•è¯</p>
                    <button class="btn btn-blue" onclick="addWordsToGroup(${groupId})">æ·»åŠ å•è¯</button>
                </div>
            `;
            return;
        }
        
        let html = `
            <div style="margin-bottom: 20px;">
                <p style="color: #666;">åˆ†ç»„ "${groupName}" å…±æœ‰ ${words.length} ä¸ªå•è¯</p>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>æ·»åŠ æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${words.map(word => {
                            const addedTime = new Date(word.created_at).toLocaleDateString('zh-CN');
                            return `
                                <tr>
                                    <td><strong>${word.english}</strong></td>
                                    <td>${word.chinese}</td>
                                    <td>${addedTime}</td>
                                    <td>
                                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                                onclick="removeWordFromGroup(${word.id}, ${groupId})">ç§»é™¤</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="addWordsToGroup(${groupId})">ç»§ç»­æ·»åŠ å•è¯</button>
                <button class="btn btn-red" onclick="showGroupWords()">è¿”å›åˆ†ç»„åˆ—è¡¨</button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„å•è¯åˆ—è¡¨é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function addWordsToGroup(groupId) {
    const content = document.getElementById('teacher-content') || document.getElementById('group-words-list');
    
    content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ ä¸ºåˆ†ç»„æ·»åŠ å•è¯</h3>
            
            <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                <p style="color: #1565C0; font-weight: bold;">ğŸ“‹ ä¸Šä¼ è¯´æ˜ï¼š</p>
                <p style="color: #666; margin: 8px 0;">â€¢ æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼šè‹±æ–‡ ä¸­æ–‡</p>
                <p style="color: #666; margin: 8px 0;">â€¢ ç¤ºä¾‹ï¼šhello ä½ å¥½ï¼Œworld ä¸–ç•Œ</p>
                <p style="color: #666; margin: 8px 0;">â€¢ æ”¯æŒçŸ­è¯­ï¼šå¦‚ "good morning" æ—©ä¸Šå¥½</p>
                <p style="color: #666; margin: 8px 0;">â€¢ æ·»åŠ çš„å•è¯åªä¼šç»™è¯¥åˆ†ç»„çš„å­¦ç”Ÿå­¦ä¹ </p>
            </div>
            
            <textarea id="group-words-input" placeholder="è¾“å…¥å•è¯åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
"good morning" æ—©ä¸Šå¥½
"thank you" è°¢è°¢ä½ "></textarea>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-blue" onclick="saveWordsToGroup(${groupId})">æ·»åŠ åˆ°åˆ†ç»„</button>
                <button class="btn btn-red" onclick="manageGroupWords(${groupId})">å–æ¶ˆè¿”å›</button>
            </div>
            
            <div id="add-words-result"></div>
        </div>
    `;
}

async function saveWordsToGroup(groupId) {
    const input = document.getElementById('group-words-input').value.trim();
    if (!input) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const lines = input.split('\n');
    const wordsToAdd = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (trimmed.startsWith('#')) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            wordsToAdd.push({
                group_id: groupId,
                english: english,
                chinese: chinese
            });
        }
    });
    
    if (wordsToAdd.length === 0) {
        showAlert('æ²¡æœ‰æœ‰æ•ˆå•è¯å¯æ·»åŠ ', 'error');
        return;
    }
    
    try {
        // æ’å…¥å•è¯åˆ°åˆ†ç»„
        const { error: wordsError } = await supabase
            .from('group_words')
            .insert(wordsToAdd);
        
        if (wordsError) throw wordsError;
        
        // ä¸ºåˆ†ç»„çš„æ‰€æœ‰å­¦ç”Ÿåˆ›å»ºå­¦ä¹ è®°å½•
        const { data: students } = await supabase
            .from('student_group_memberships')
            .select('student_id')
            .eq('group_id', groupId);
        
        if (students && students.length > 0) {
            // è·å–åˆšæ’å…¥çš„å•è¯
            const { data: insertedWords } = await supabase
                .from('group_words')
                .select('id, english, chinese')
                .eq('group_id', groupId)
                .order('created_at', { ascending: false })
                .limit(wordsToAdd.length);
            
            if (insertedWords) {
                // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºå­¦ä¹ è®°å½•
                for (const student of students) {
                    const studyRecords = insertedWords.map(word => ({
                        student_id: student.student_id,
                        english: word.english,
                        chinese: word.chinese,
                        status: 'new'
                    }));
                    
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®°å½•
                    for (const record of studyRecords) {
                        const { data: existing } = await supabase
                            .from('study_records')
                            .select('id')
                            .eq('student_id', record.student_id)
                            .eq('english', record.english)
                            .single();
                        
                        if (!existing) {
                            await supabase.from('study_records').insert([record]);
                        }
                    }
                }
            }
        }
        
        document.getElementById('add-words-result').innerHTML = `
            <div style="background: #D4EDDA; color: #155724; padding: 15px; border-radius: 8px; margin-top: 20px;">
                âœ… æˆåŠŸæ·»åŠ  ${wordsToAdd.length} ä¸ªå•è¯åˆ°åˆ†ç»„ï¼
            </div>
        `;
        
        setTimeout(() => manageGroupWords(groupId), 1500);
        
    } catch (error) {
        console.error('æ·»åŠ å•è¯é”™è¯¯:', error);
        document.getElementById('add-words-result').innerHTML = `
            <div style="background: #F8D7DA; color: #721C24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                âŒ æ·»åŠ å¤±è´¥ï¼š${error.message}
            </div>
        `;
    }
}

async function removeWordFromGroup(wordId, groupId) {
    if (!confirm('ç¡®å®šè¦ä»åˆ†ç»„ä¸­ç§»é™¤è¿™ä¸ªå•è¯å—ï¼Ÿå­¦ç”Ÿå°†æ— æ³•å†å­¦ä¹ è¿™ä¸ªå•è¯ã€‚')) {
        return;
    }
    
    try {
        // è·å–å•è¯ä¿¡æ¯
        const { data: word } = await supabase
            .from('group_words')
            .select('english')
            .eq('id', wordId)
            .single();
        
        if (!word) {
            showAlert('å•è¯ä¸å­˜åœ¨', 'error');
            return;
        }
        
        // ä»åˆ†ç»„ä¸­ç§»é™¤å•è¯
        const { error } = await supabase
            .from('group_words')
            .delete()
            .eq('id', wordId);
        
        if (error) throw error;
        
        showAlert('å•è¯å·²ä»åˆ†ç»„ä¸­ç§»é™¤', 'success');
        
        // é‡æ–°åŠ è½½åˆ—è¡¨
        setTimeout(() => manageGroupWords(groupId), 500);
        
    } catch (error) {
        console.error('ç§»é™¤å•è¯é”™è¯¯:', error);
        showAlert('ç§»é™¤å¤±è´¥', 'error');
    }
}

// å­¦ç”Ÿç®¡ç†
async function showAllStudents() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ“ å­¦ç”Ÿç®¡ç†</h3>
            
            <div id="students-management-content">
                <p style="text-align: center;">åŠ è½½å­¦ç”Ÿåˆ—è¡¨...</p>
            </div>
        </div>
    `;
    
    loadAllStudents();
}

async function loadAllStudents() {
    try {
        const { data: students, error } = await supabase
            .from('users')
            .select('*')
            .eq('is_teacher', false)
            .order('username');
        
        if (error) throw error;
        
        const content = document.getElementById('students-management-content');
        
        if (!students || students.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¥</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å­¦ç”Ÿ</h3>
                    <p style="color: #999;">å­¦ç”Ÿæ³¨å†Œåå°±ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                </div>
            `;
            return;
        }
        
        // è·å–æ¯ä¸ªå­¦ç”Ÿçš„åˆ†ç»„ä¿¡æ¯
        const studentsWithGroups = await Promise.all(students.map(async (student) => {
            const { data: memberships } = await supabase
                .from('student_group_memberships')
                .select('group_id')
                .eq('student_id', student.username);
            
            const { data: records } = await supabase
                .from('study_records')
                .select('*')
                .eq('student_id', student.username);
            
            let groups = [];
            if (memberships && memberships.length > 0) {
                const groupIds = memberships.map(m => m.group_id);
                const { data: groupData } = await supabase
                    .from('word_groups')
                    .select('id, name')
                    .in('id', groupIds);
                
                groups = groupData || [];
            }
            
            const totalWords = records?.length || 0;
            const mastered = records?.filter(r => r.status === 'mastered').length || 0;
            const progress = totalWords > 0 ? Math.round((mastered / totalWords) * 100) : 0;
            
            return {
                ...student,
                groups: groups,
                totalWords: totalWords,
                mastered: mastered,
                progress: progress,
                lastLogin: student.last_login ? new Date(student.last_login).toLocaleDateString('zh-CN') : 'ä»æœª'
            };
        }));
        
        let html = `
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>æ‰€å±åˆ†ç»„</th>
                            <th>å•è¯æ•°</th>
                            <th>æŒæ¡æ•°</th>
                            <th>æŒæ¡ç‡</th>
                            <th>æœ€åç™»å½•</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentsWithGroups.map(student => `
                            <tr>
                                <td><strong>${student.username}</strong></td>
                                <td>
                                    ${student.groups.length > 0 ? 
                                        student.groups.map(g => `<span class="group-badge">${g.name}</span>`).join('') : 
                                        '<span style="color: #999;">æœªåˆ†ç»„</span>'}
                                </td>
                                <td>${student.totalWords}</td>
                                <td style="color: #4CAF50;">${student.mastered}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: ${student.progress >= 80 ? '#4CAF50' : student.progress >= 50 ? '#FF9800' : '#F44336'}">
                                            ${student.progress}%
                                        </span>
                                        <div style="flex-grow: 1; height: 6px; background: #e0e0e0; border-radius: 3px;">
                                            <div style="width: ${student.progress}%; height: 100%; background: ${student.progress >= 80 ? '#4CAF50' : student.progress >= 50 ? '#FF9800' : '#F44336'}; border-radius: 3px;"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>${student.lastLogin}</td>
                                <td>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                            onclick="manageStudentGroups('${student.username}')">ç®¡ç†åˆ†ç»„</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-red" onclick="loadTeacherHome()">
                    <span>ğŸ”™ è¿”å›ä¸»é¢æ¿</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function manageStudentGroups(studentId) {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ“‹ ç®¡ç†å­¦ç”Ÿåˆ†ç»„ï¼š${studentId}</h3>
            
            <div id="student-groups-content">
                <p style="text-align: center;">åŠ è½½åˆ†ç»„ä¿¡æ¯...</p>
            </div>
        </div>
    `;
    
    loadStudentGroups(studentId);
}

async function loadStudentGroups(studentId) {
    try {
        // è·å–æ‰€æœ‰åˆ†ç»„
        const { data: allGroups } = await supabase
            .from('word_groups')
            .select('id, name, description')
            .eq('teacher_id', app.teacherId)
            .order('name');
        
        // è·å–å­¦ç”Ÿå½“å‰çš„åˆ†ç»„
        const { data: currentMemberships } = await supabase
            .from('student_group_memberships')
            .select('group_id')
            .eq('student_id', studentId);
        
        const currentGroupIds = new Set(currentMemberships?.map(m => m.group_id) || []);
        
        const content = document.getElementById('student-groups-content');
        
        let html = `
            <div style="margin-bottom: 30px;">
                <h4 style="color: #333; margin-bottom: 15px;">å½“å‰åˆ†ç»„ï¼š</h4>
                ${currentGroupIds.size > 0 ? 
                    Array.from(currentGroupIds).map(groupId => {
                        const group = allGroups?.find(g => g.id === groupId);
                        return group ? `<span class="group-badge" style="background: #4CAF50; color: white;">${group.name}</span>` : '';
                    }).join('') : 
                    '<p style="color: #999;">æœªåŠ å…¥ä»»ä½•åˆ†ç»„</p>'
                }
            </div>
            
            <div>
                <h4 style="color: #333; margin-bottom: 15px;">æ‰€æœ‰å¯ç”¨åˆ†ç»„ï¼š</h4>
                <div class="card-grid">
                    ${allGroups?.map(group => {
                        const isMember = currentGroupIds.has(group.id);
                        return `
                            <div class="stat-card" style="text-align: left; border: 2px solid ${isMember ? '#4CAF50' : '#ddd'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <h5 style="color: #333; margin: 0;">${group.name}</h5>
                                    <span style="color: ${isMember ? '#4CAF50' : '#666'}; font-weight: bold;">
                                        ${isMember ? 'å·²åŠ å…¥' : 'æœªåŠ å…¥'}
                                    </span>
                                </div>
                                
                                ${group.description ? `<p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">${group.description}</p>` : ''}
                                
                                <div style="text-align: center;">
                                    ${isMember ? 
                                        `<button class="btn btn-red" style="width: 100%;" onclick="removeStudentFromGroup('${studentId}', ${group.id})">ç§»å‡ºåˆ†ç»„</button>` :
                                        `<button class="btn" style="width: 100%;" onclick="addStudentToGroup('${studentId}', ${group.id})">åŠ å…¥åˆ†ç»„</button>`
                                    }
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-red" onclick="showAllStudents()">
                    <span>ğŸ”™ è¿”å›å­¦ç”Ÿåˆ—è¡¨</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿåˆ†ç»„é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function addStudentToGroup(studentId, groupId) {
    try {
        const { error } = await supabase
            .from('student_group_memberships')
            .insert([{
                student_id: studentId,
                group_id: groupId
            }]);
        
        if (error) throw error;
        
        // åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ
        await syncGroupWordsToStudent(studentId, groupId);
        
        showAlert('å­¦ç”Ÿå·²æˆåŠŸåŠ å…¥åˆ†ç»„', 'success');
        setTimeout(() => manageStudentGroups(studentId), 500);
        
    } catch (error) {
        console.error('æ·»åŠ å­¦ç”Ÿåˆ°åˆ†ç»„é”™è¯¯:', error);
        showAlert('æ·»åŠ å¤±è´¥', 'error');
    }
}

async function removeStudentFromGroup(studentId, groupId) {
    if (!confirm('ç¡®å®šè¦å°†å­¦ç”Ÿç§»å‡ºè¿™ä¸ªåˆ†ç»„å—ï¼Ÿå­¦ç”Ÿå°†æ— æ³•å†å­¦ä¹ è¯¥åˆ†ç»„çš„å•è¯ã€‚')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('student_group_memberships')
            .delete()
            .eq('student_id', studentId)
            .eq('group_id', groupId);
        
        if (error) throw error;
        
        showAlert('å­¦ç”Ÿå·²ä»åˆ†ç»„ä¸­ç§»é™¤', 'success');
        setTimeout(() => manageStudentGroups(studentId), 500);
        
    } catch (error) {
        console.error('ç§»é™¤å­¦ç”Ÿé”™è¯¯:', error);
        showAlert('ç§»é™¤å¤±è´¥', 'error');
    }
}

// åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ
async function syncGroupWordsToStudent(studentId, groupId) {
    try {
        // è·å–åˆ†ç»„çš„æ‰€æœ‰å•è¯
        const { data: groupWords } = await supabase
            .from('group_words')
            .select('english, chinese')
            .eq('group_id', groupId);
        
        if (!groupWords || groupWords.length === 0) return;
        
        // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²æœ‰è¿™äº›å•è¯
        for (const word of groupWords) {
            const { data: existing } = await supabase
                .from('study_records')
                .select('id')
                .eq('student_id', studentId)
                .eq('english', word.english)
                .single();
            
            if (!existing) {
                // åˆ›å»ºå­¦ä¹ è®°å½•
                await supabase
                    .from('study_records')
                    .insert([{
                        student_id: studentId,
                        english: word.english,
                        chinese: word.chinese,
                        status: 'new'
                    }]);
            }
        }
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
    }
}

// è¿›åº¦æŸ¥çœ‹
async function showProgress() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ“Š åˆ†ç»„å­¦ä¹ è¿›åº¦</h3>
            
            <div id="progress-content">
                <p style="text-align: center;">åŠ è½½è¿›åº¦æ•°æ®...</p>
            </div>
        </div>
    `;
    
    loadGroupProgress();
}

async function loadGroupProgress() {
    try {
        const { data: groups } = await supabase
            .from('word_groups')
            .select('id, name')
            .eq('teacher_id', app.teacherId);
        
        if (!groups || groups.length === 0) {
            document.getElementById('progress-content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“Š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰åˆ†ç»„</h3>
                    <p style="color: #999;">è¯·å…ˆåˆ›å»ºåˆ†ç»„</p>
                </div>
            `;
            return;
        }
        
        // è·å–æ¯ä¸ªåˆ†ç»„çš„è¿›åº¦
        const groupsWithProgress = await Promise.all(groups.map(async (group) => {
            // è·å–åˆ†ç»„çš„å­¦ç”Ÿ
            const { data: memberships } = await supabase
                .from('student_group_memberships')
                .select('student_id')
                .eq('group_id', group.id);
            
            const studentIds = memberships?.map(m => m.student_id) || [];
            
            // è·å–åˆ†ç»„å•è¯
            const { data: groupWords } = await supabase
                .from('group_words')
                .select('english')
                .eq('group_id', group.id);
            
            const wordCount = groupWords?.length || 0;
            
            // è·å–å­¦ç”Ÿçš„å­¦ä¹ è®°å½•
            let totalRecords = 0;
            let masteredRecords = 0;
            
            if (studentIds.length > 0 && wordCount > 0) {
                const { data: records } = await supabase
                    .from('study_records')
                    .select('*')
                    .in('student_id', studentIds)
                    .in('english', groupWords.map(w => w.english));
                
                totalRecords = records?.length || 0;
                masteredRecords = records?.filter(r => r.status === 'mastered').length || 0;
            }
            
            const progress = wordCount > 0 ? Math.round((masteredRecords / (wordCount * studentIds.length)) * 100) : 0;
            
            return {
                ...group,
                studentCount: studentIds.length,
                wordCount: wordCount,
                totalRecords: totalRecords,
                masteredRecords: masteredRecords,
                progress: progress
            };
        }));
        
        let html = `
            <div class="card-grid">
                ${groupsWithProgress.map(group => `
                    <div class="stat-card" onclick="viewGroupProgress(${group.id})" style="cursor: pointer;">
                        <h4 style="color: #333; margin-bottom: 10px;">${group.name}</h4>
                        <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #2196F3;">${group.wordCount}</div>
                                <div style="color: #666; font-size: 0.8em;">å•è¯æ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #4CAF50;">${group.studentCount}</div>
                                <div style="color: #666; font-size: 0.8em;">å­¦ç”Ÿæ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #FF9800;">${group.progress}%</div>
                                <div style="color: #666; font-size: 0.8em;">æŒæ¡ç‡</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #666; font-size: 0.9em;">å­¦ä¹ è¿›åº¦</span>
                                <span style="color: #4CAF50; font-weight: bold;">${group.progress}%</span>
                            </div>
                            <div style="height: 6px; background: #e0e0e0; border-radius: 3px;">
                                <div style="width: ${group.progress}%; height: 100%; background: #4CAF50; border-radius: 3px;"></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-red" onclick="loadTeacherHome()">
                    <span>ğŸ”™ è¿”å›ä¸»é¢æ¿</span>
                </button>
            </div>
        `;
        
        document.getElementById('progress-content').innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½è¿›åº¦é”™è¯¯:', error);
        document.getElementById('progress-content').innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// ç³»ç»Ÿç»Ÿè®¡
async function showStats() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡</h3>
            <div id="system-stats">
                <!-- ç»Ÿè®¡å†…å®¹ -->
            </div>
        </div>
    `;
    
    // ç®€å•ç‰ˆæœ¬ï¼Œè¿”å›ä¸»é¢æ¿
    setTimeout(() => loadTeacherHome(), 100);
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function loadStudentHome() {
    try {
        // è·å–å­¦ç”Ÿæ‰€åœ¨åˆ†ç»„
        const { data: memberships } = await supabase
            .from('student_group_memberships')
            .select('group_id')
            .eq('student_id', app.user);
        
        let groupNames = [];
        if (memberships && memberships.length > 0) {
            const groupIds = memberships.map(m => m.group_id);
            const { data: groups } = await supabase
                .from('word_groups')
                .select('name')
                .in('id', groupIds);
            
            groupNames = groups?.map(g => g.name) || [];
        }
        
        // è·å–å­¦ç”Ÿçš„å­¦ä¹ è®°å½•
        const { data: records } = await supabase
            .from('study_records')
            .select('*')
            .eq('student_id', app.user);
        
        app.userWords = records || [];
        
        const total = records?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const learning = records?.filter(r => r.status === 'learning').length || 0;
        const needReview = records?.filter(r => r.status === 'new').length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        const statsContent = document.getElementById('student-stats-content');
        statsContent.innerHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${total}</div>
                    <div class="label">å•è¯æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${mastered}</div>
                    <div class="label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${learning}</div>
                    <div class="label">å­¦ä¹ ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="number">${needReview}</div>
                    <div class="label">éœ€å­¦ä¹ </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                </div>
                <div class="progress-bar" style="height: 10px;">
                    <div style="height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: ${progress}%; border-radius: 5px;"></div>
                </div>
            </div>
            
            ${groupNames.length > 0 ? `
                <div style="margin-top: 25px;">
                    <p style="color: #666; margin-bottom: 10px;">ğŸ“š æ‰€å±åˆ†ç»„ï¼š</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${groupNames.map(name => `<span class="group-badge">${name}</span>`).join('')}
                    </div>
                </div>
            ` : ''}
        `;
        
        // åŠ è½½å­¦ç”Ÿä¸»ç•Œé¢
        const content = document.getElementById('student-content');
        content.innerHTML = `
            <div style="text-align: center;">
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ å­¦ä¹ å»ºè®®</h4>
                    <p style="color: #666; margin: 8px 0;">â€¢ æ¯å¤©åšæŒå­¦ä¹ æ•ˆæœæœ€å¥½</p>
                    <p style="color: #666; margin: 8px 0;">â€¢ é‡ç‚¹å¤ä¹ "éœ€å­¦ä¹ "çš„å•è¯</p>
                    <p style="color: #666; margin: 8px 0;">â€¢ å·²æŒæ¡çš„å•è¯å®šæœŸå¤ä¹ </p>
                    <p style="color: #666; margin: 8px 0;">â€¢ å½“å‰å·²å­¦ä¹  ${total} ä¸ªå•è¯</p>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                    <button class="btn" style="padding: 12px 24px;" onclick="startDailyPractice()">
                        <span>ğŸ“… ä»Šæ—¥ç»ƒä¹ </span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 24px;" onclick="reviewWeakWords()">
                        <span>ğŸ”„ å¤ä¹ å¼±é¡¹</span>
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        document.getElementById('student-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
    }
}

// å­¦ç”Ÿå¼€å§‹å­¦ä¹ 
function startLearning() {
    if (app.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    // å‡†å¤‡éœ€è¦å­¦ä¹ çš„å•è¯ï¼ˆä¼˜å…ˆæ–°å•è¯ï¼‰
    const needLearn = app.userWords.filter(w => w.status === 'new' || w.status === 'learning');
    const wordsToLearn = needLearn.length > 0 ? needLearn : [...app.userWords];
    
    // æ‰“ä¹±é¡ºåº
    wordsToLearn.sort(() => Math.random() - 0.5);
    app.trainingWords = wordsToLearn;
    app.currentWordIndex = 0;
    app.isCardFlipped = false;
    
    showTrainingInterface();
}

function startDailyPractice() {
    if (app.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    // ä»Šæ—¥å»ºè®®å­¦ä¹ 15ä¸ªå•è¯ï¼Œä¼˜å…ˆæ–°å•è¯
    const newWords = app.userWords.filter(w => w.status === 'new');
    const learningWords = app.userWords.filter(w => w.status === 'learning');
    const reviewWords = app.userWords.filter(w => w.status === 'mastered');
    
    let dailyWords = [];
    if (newWords.length > 0) {
        dailyWords = dailyWords.concat(newWords.slice(0, Math.min(newWords.length, 8)));
    }
    if (learningWords.length > 0 && dailyWords.length < 15) {
        dailyWords = dailyWords.concat(learningWords.slice(0, Math.min(learningWords.length, 15 - dailyWords.length)));
    }
    if (reviewWords.length > 0 && dailyWords.length < 15) {
        dailyWords = dailyWords.concat(reviewWords.slice(0, Math.min(reviewWords.length, 15 - dailyWords.length)));
    }
    
    if (dailyWords.length === 0) {
        dailyWords = app.userWords.slice(0, Math.min(15, app.userWords.length));
    }
    
    // æ‰“ä¹±é¡ºåº
    dailyWords.sort(() => Math.random() - 0.5);
    app.trainingWords = dailyWords;
    app.currentWordIndex = 0;
    app.isCardFlipped = false;
    
    showTrainingInterface();
}

function reviewWeakWords() {
    if (app.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    // åªå¤ä¹ å¼±é¡¹ï¼ˆæ–°å•è¯å’Œå­¦ä¹ ä¸­çš„å•è¯ï¼‰
    const weakWords = app.userWords.filter(w => w.status === 'new' || w.status === 'learning');
    
    if (weakWords.length === 0) {
        showAlert('ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰éœ€è¦å¤ä¹ çš„å¼±é¡¹å•è¯ï¼', 'success');
        return;
    }
    
    // æ‰“ä¹±é¡ºåº
    weakWords.sort(() => Math.random() - 0.5);
    app.trainingWords = weakWords;
    app.currentWordIndex = 0;
    app.isCardFlipped = false;
    
    showTrainingInterface();
}

function showTrainingInterface() {
    if (app.currentWordIndex >= app.trainingWords.length) {
        finishTraining();
        return;
    }
    
    const word = app.trainingWords[app.currentWordIndex];
    const total = app.trainingWords.length;
    const current = app.currentWordIndex + 1;
    const progress = (current / total) * 100;
    
    const content = document.getElementById('student-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #333; margin-bottom: 10px;">ğŸ¯ å•è¯è®­ç»ƒ</h3>
            <p style="color: #666; margin-bottom: 5px;">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
            
            <div style="margin: 20px auto; max-width: 600px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">è¿›åº¦ï¼š${current}/${total}</span>
                    <span style="color: #2196F3; font-weight: bold;">
                        ${word.status === 'new' ? 'ğŸ“ æ–°å•è¯' : word.status === 'learning' ? 'ğŸ”„ å­¦ä¹ ä¸­' : 'âœ… å·²æŒæ¡'}
                    </span>
                </div>
                <div style="height: 10px; background: #e0e0e0; border-radius: 5px;">
                    <div style="width: ${progress}%; height: 100%; background: #4CAF50; border-radius: 5px;"></div>
                </div>
            </div>
            
            <div class="word-card ${app.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
                <div id="card-front" style="font-size: 2.5em;">${word.english}</div>
                <div id="card-back" style="display: ${app.isCardFlipped ? 'block' : 'none'}; color: #2E7D32; font-size: 2em;">${word.chinese}</div>
            </div>
            
            <div style="margin: 35px 0;">
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                    <button class="btn" onclick="markWordAs('mastered')" style="padding: 16px 32px; font-size: 17px;">
                        <span>âœ… å·²æŒæ¡</span>
                    </button>
                    <button class="btn btn-blue" onclick="markWordAs('learning')" style="padding: 16px 32px; font-size: 17px;">
                        <span>ğŸ”„ å­¦ä¹ ä¸­</span>
                    </button>
                    <button class="btn" onclick="skipWord()" style="padding: 16px 32px; font-size: 17px;">
                        <span>â­ï¸ è·³è¿‡</span>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-red" onclick="cancelTraining()">
                    <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                </button>
                <button class="btn" onclick="loadStudentHome()">
                    <span>ğŸ“‹ è¿”å›èœå•</span>
                </button>
            </div>
        </div>
    `;
}

function flipTrainingCard() {
    app.isCardFlipped = !app.isCardFlipped;
    const front = document.getElementById('card-front');
    const back = document.getElementById('card-back');
    
    if (app.isCardFlipped) {
        front.style.display = 'none';
        back.style.display = 'block';
    } else {
        front.style.display = 'block';
        back.style.display = 'none';
    }
}

async function markWordAs(status) {
    const word = app.trainingWords[app.currentWordIndex];
    
    try {
        // æ›´æ–°æ•°æ®åº“
        await supabase
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', app.user)
            .eq('english', word.english);
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        
        // ä¸‹ä¸€ä¸ªå•è¯
        app.currentWordIndex++;
        app.isCardFlipped = false;
        
        if (app.currentWordIndex < app.trainingWords.length) {
            showTrainingInterface();
        } else {
            finishTraining();
        }
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

function skipWord() {
    app.currentWordIndex++;
    app.isCardFlipped = false;
    
    if (app.currentWordIndex < app.trainingWords.length) {
        showTrainingInterface();
    } else {
        finishTraining();
    }
}

function finishTraining() {
    const total = app.trainingWords.length;
    const mastered = app.trainingWords.filter(w => w.status === 'mastered').length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    let message = `ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\n`;
    message += `ğŸ“Š è®­ç»ƒç»Ÿè®¡ï¼š\n`;
    message += `â€¢ è®­ç»ƒå•è¯ï¼š${total} ä¸ª\n`;
    message += `â€¢ æŒæ¡å•è¯ï¼š${mastered} ä¸ª\n`;
    message += `â€¢ æŒæ¡ç‡ï¼š${progress}%\n\n`;
    
    if (progress >= 80) {
        message += `ğŸŒŸ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼`;
    } else if (progress >= 60) {
        message += `ğŸ’ª è¿˜ä¸é”™ï¼Œç»§ç»­åŠ æ²¹ï¼`;
    } else {
        message += `ğŸ“š éœ€è¦å¤šå¤ä¹ ï¼Œç»§ç»­åŠªåŠ›ï¼`;
    }
    
    alert(message);
    
    // é‡æ–°åŠ è½½é¢æ¿
    loadStudentHome();
}

function cancelTraining() {
    if (confirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿ')) {
        loadStudentHome();
    }
}

// å…¶ä»–å­¦ç”ŸåŠŸèƒ½
function showMyWords() {
    const content = document.getElementById('student-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“– æˆ‘çš„å•è¯åˆ—è¡¨</h3>
            <div id="my-words-list">
                <p style="text-align: center;">åŠ è½½å•è¯åˆ—è¡¨...</p>
            </div>
        </div>
    `;
    
    setTimeout(loadMyWords, 100);
}

async function loadMyWords() {
    try {
        const { data: records, error } = await supabase
            .from('study_records')
            .select('*')
            .eq('student_id', app.user)
            .order('last_reviewed', { ascending: false });
        
        if (error) throw error;
        
        app.userWords = records || [];
        
        const content = document.getElementById('my-words-list');
        
        if (!records || records.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å•è¯</h3>
                    <p style="color: #999;">ç­‰å¾…æ•™å¸ˆåˆ†é…å•è¯</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>çŠ¶æ€</th>
                            <th>å¤ä¹ æ¬¡æ•°</th>
                            <th>æœ€åå¤ä¹ </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => {
                            let statusText, statusColor;
                            switch(record.status) {
                                case 'mastered': statusText = 'âœ… å·²æŒæ¡'; statusColor = '#4CAF50'; break;
                                case 'learning': statusText = 'ğŸ”„ å­¦ä¹ ä¸­'; statusColor = '#FF9800'; break;
                                default: statusText = 'ğŸ“ éœ€å­¦ä¹ '; statusColor = '#666';
                            }
                            
                            const lastReview = record.last_reviewed ? 
                                new Date(record.last_reviewed).toLocaleDateString('zh-CN') : 'ä»æœª';
                            
                            return `
                                <tr>
                                    <td><strong>${record.english}</strong></td>
                                    <td>${record.chinese}</td>
                                    <td style="color: ${statusColor};">${statusText}</td>
                                    <td>${record.review_count || 0}</td>
                                    <td>${lastReview}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-red" onclick="loadStudentHome()">
                    <span>ğŸ”™ è¿”å›ä¸»é¢æ¿</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å•è¯åˆ—è¡¨é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function showMyGroups() {
    const content = document.getElementById('student-content');
    content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 30px;">ğŸ‘¥ æˆ‘çš„åˆ†ç»„</h3>
            <div id="my-groups-list">
                <p style="text-align: center;">åŠ è½½åˆ†ç»„ä¿¡æ¯...</p>
            </div>
        </div>
    `;
    
    setTimeout(loadMyGroups, 100);
}

async function loadMyGroups() {
    try {
        // è·å–å­¦ç”Ÿæ‰€åœ¨åˆ†ç»„
        const { data: memberships } = await supabase
            .from('student_group_memberships')
            .select('group_id')
            .eq('student_id', app.user);
        
        let groups = [];
        if (memberships && memberships.length > 0) {
            const groupIds = memberships.map(m => m.group_id);
            const { data: groupData } = await supabase
                .from('word_groups')
                .select('id, name, description')
                .in('id', groupIds);
            
            groups = groupData || [];
        }
        
        const content = document.getElementById('my-groups-list');
        
        if (groups.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¥</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•åˆ†ç»„</h3>
                    <p style="color: #999;">ç­‰å¾…æ•™å¸ˆå°†æ‚¨åˆ†é…åˆ°åˆ†ç»„</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="card-grid">
                ${groups.map(group => `
                    <div class="stat-card">
                        <h4 style="color: #333; margin-bottom: 10px;">${group.name}</h4>
                        ${group.description ? `<p style="color: #666; margin-bottom: 15px;">${group.description}</p>` : ''}
                        <div style="margin-top: 15px; color: #999; font-size: 0.9em;">
                            æ•™å¸ˆä¸ºæ‚¨åˆ†é…çš„å­¦ä¹ åˆ†ç»„
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-red" onclick="loadStudentHome()">
                    <span>ğŸ”™ è¿”å›ä¸»é¢æ¿</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function reviewWeak() {
    reviewWeakWords();
}

// ========== é€šç”¨åŠŸèƒ½ ==========
async function testConnection() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { error } = await supabase.from('users').select('count').limit(1);
        if (error) throw error;
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        app.user = null;
        app.isTeacher = false;
        app.userId = null;
        app.userWords = [];
        app.trainingWords = [];
        
        localStorage.removeItem('kathy_user');
        localStorage.removeItem('kathy_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•ï¼Œè¯·è¾“å…¥ç”¨æˆ·åé‡æ–°ç™»å½•', 'info');
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyåˆ†ç»„å•è¯ç³»ç»Ÿå¯åŠ¨');
    
    // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
    const savedUser = localStorage.getItem('kathy_user');
    const savedRole = localStorage.getItem('kathy_role');
    
    if (savedUser) {
        app.user = savedUser;
        app.isTeacher = (savedRole === 'teacher');
        app.userId = savedUser;
        
        if (app.isTeacher) {
            showScreen('teacher-screen');
            loadTeacherHome();
        } else {
            showScreen('student-screen');
            document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${savedUser}ï¼`;
            loadStudentHome();
        }
    } else {
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        testConnection();
    }
    
    // ç»‘å®šå›è½¦é”®ç™»å½•
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};
</script>
</body>
</html>
