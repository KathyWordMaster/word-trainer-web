<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯è®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .main-content { padding: 30px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; margin: 10px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #45a049; }
        .btn-blue { background: #2196F3; }
        .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #f44336; }
        .btn-red:hover { background: #d32f2f; }
        input[type="text"], textarea { width: 100%; max-width: 400px; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; }
        textarea { height: 150px; }
        .word-card { background: white; border: 3px solid #4CAF50; border-radius: 15px; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; font-size: 2em; font-weight: bold; max-width: 500px; }
        .stats-card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 15px 0; border-left: 5px solid #4CAF50; }
        .progress-bar { width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 10px 0; }
        .progress-fill { height: 100%; background: #4CAF50; width: 0%; }
        .message { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š Kathyå•è¯è®­ç»ƒè¥</h1>
            <p>æ•™å¸ˆï¼šKathy | å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <h2 style="text-align: center; margin-bottom: 30px;">æ¬¢è¿ä½¿ç”¨</h2>
                <div style="text-align: center;">
                    <input type="text" id="username" placeholder="ç”¨æˆ·å">
                    <div id="login-message" class="message info">è¯·è¾“å…¥ç”¨æˆ·å</div>
                    <button class="btn" onclick="userLogin()">ç™»å½•/æ³¨å†Œ</button>
                    <button class="btn btn-blue" onclick="testDb()">æµ‹è¯•è¿æ¥</button>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <p><strong>æµ‹è¯•è´¦å·ï¼š</strong></p>
                    <p>â€¢ æ•™å¸ˆï¼škathy151</p>
                    <p>â€¢ å­¦ç”Ÿï¼štom (æˆ–ä»»æ„è‹±æ–‡åæ³¨å†Œ)</p>
                </div>
            </div>

            <!-- æ•™å¸ˆç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 20px;">ğŸ‘©â€ğŸ« æ•™å¸ˆæ§åˆ¶å°</h2>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="showTeacherUpload()">ä¸Šä¼ å•è¯</button>
                    <button class="btn btn-blue" onclick="showTeacherStudents()">æŸ¥çœ‹å­¦ç”Ÿ</button>
                    <button class="btn" onclick="showTeacherStats()">æŸ¥çœ‹ç»Ÿè®¡</button>
                    <button class="btn btn-red" onclick="userLogout()">é€€å‡º</button>
                </div>
                
                <div id="teacher-content">
                    <!-- å†…å®¹åŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <!-- å­¦ç”Ÿç•Œé¢ -->
            <div id="student-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 20px;" id="student-name">ğŸ“ å­¦ç”Ÿç•Œé¢</h2>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="startStudentLearning()">å¼€å§‹å­¦ä¹ </button>
                    <button class="btn btn-blue" onclick="showStudentProgress()">æˆ‘çš„è¿›åº¦</button>
                    <button class="btn btn-red" onclick="userLogout()">é€€å‡º</button>
                </div>
                
                <div id="student-content">
                    <!-- å†…å®¹åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

<script>
// é…ç½®
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';

// åˆå§‹åŒ–Supabase
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// å…¨å±€å˜é‡
let currentUser = null;
let isTeacher = false;
let studentWords = [];
let currentWordIdx = 0;

// é¡µé¢åˆ‡æ¢
function goToScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMsg(id, text, type = 'info') {
    const el = document.getElementById(id);
    el.textContent = text;
    el.className = `message ${type}`;
}

// æµ‹è¯•è¿æ¥
async function testDb() {
    showMsg('login-message', 'æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
    try {
        const { error } = await db.from('users').select('count').limit(1);
        if (error) throw error;
        showMsg('login-message', 'âœ… è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMsg('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ç™»å½•/æ³¨å†Œ
async function userLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMsg('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMsg('login-message', 'å¤„ç†ä¸­...', 'info');
    
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: user, error } = await db
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (error && error.code === 'PGRST116') {
            // æ–°ç”¨æˆ·æ³¨å†Œ
            const teacherAccount = username.toLowerCase() === 'kathy151';
            
            const { data: newUser, error: createErr } = await db
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: teacherAccount
                }])
                .select()
                .single();
            
            if (createErr) throw createErr;
            
            currentUser = username;
            isTeacher = teacherAccount;
            showMsg('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ·ï¼`, 'success');
            
        } else if (error) {
            throw error;
        } else {
            // è€ç”¨æˆ·ç™»å½•
            currentUser = username;
            isTeacher = user.is_teacher;
            
            await db
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMsg('login-message', `âœ… æ¬¢è¿å›æ¥ï¼`, 'success');
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('user_name', username);
        localStorage.setItem('user_type', isTeacher ? 'teacher' : 'student');
        
        // è·³è½¬
        setTimeout(() => {
            if (isTeacher) {
                goToScreen('teacher-screen');
                loadTeacherHome();
            } else {
                goToScreen('student-screen');
                document.getElementById('student-name').textContent = `ğŸ“ ${username}`;
                loadStudentHome();
            }
        }, 1000);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMsg('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// æ•™å¸ˆé¦–é¡µ
async function loadTeacherHome() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p style="text-align:center;">åŠ è½½ä¸­...</p>';
    
    try {
        const { data: words } = await db.from('words').select('*');
        const { data: students } = await db.from('users').select('*').eq('is_teacher', false);
        const { data: records } = await db.from('study_records').select('*');
        
        const totalWords = words?.length || 0;
        const totalStudents = students?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        
        content.innerHTML = `
            <div class="stats-card">
                <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                <p>å•è¯æ€»æ•°ï¼š${totalWords}</p>
                <p>å­¦ç”Ÿäººæ•°ï¼š${totalStudents}</p>
                <p>å·²æŒæ¡å•è¯ï¼š${mastered}</p>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <p>ğŸ’¡ ä¸Šä¼ å•è¯ç»™å­¦ç”Ÿå­¦ä¹ </p>
            </div>
        `;
    } catch (error) {
        content.innerHTML = '<p style="color:red; text-align:center;">åŠ è½½å¤±è´¥</p>';
    }
}

// æ•™å¸ˆä¸Šä¼ å•è¯
function showTeacherUpload() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = `
        <h3>ğŸ“ ä¸Šä¼ å•è¯</h3>
        <p>æ¯è¡Œï¼šè‹±æ–‡ ä¸­æ–‡</p>
        <textarea id="words-input" placeholder="hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ"></textarea>
        <div style="text-align:center;">
            <button class="btn" onclick="uploadTeacherWords()">ä¸Šä¼ </button>
            <button class="btn" onclick="loadTeacherHome()">è¿”å›</button>
        </div>
        <div id="upload-result"></div>
    `;
}

async function uploadTeacherWords() {
    const input = document.getElementById('words-input').value.trim();
    if (!input) {
        alert('è¯·è¾“å…¥å•è¯');
        return;
    }
    
    const lines = input.split('\n');
    const newWords = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            newWords.push({ teacher_id: 'kathy151', english, chinese });
        }
    });
    
    if (newWords.length === 0) {
        alert('æ²¡æœ‰æœ‰æ•ˆå•è¯');
        return;
    }
    
    try {
        // æ’å…¥å•è¯
        const { error } = await db.from('words').insert(newWords);
        if (error) throw error;
        
        // ä¸ºå­¦ç”Ÿåˆ›å»ºè®°å½•
        const { data: students } = await db
            .from('users')
            .select('username')
            .eq('is_teacher', false);
        
        if (students && students.length > 0) {
            const records = [];
            students.forEach(student => {
                newWords.forEach(word => {
                    records.push({
                        student_id: student.username,
                        english: word.english,
                        chinese: word.chinese,
                        status: 'new'
                    });
                });
            });
            
            await db.from('study_records').insert(records);
        }
        
        document.getElementById('upload-result').innerHTML = 
            `<div class="message success">âœ… ä¸Šä¼  ${newWords.length} ä¸ªå•è¯æˆåŠŸï¼</div>`;
        
        setTimeout(() => loadTeacherHome(), 1500);
        
    } catch (error) {
        document.getElementById('upload-result').innerHTML = 
            `<div class="message error">âŒ ä¸Šä¼ å¤±è´¥ï¼š${error.message}</div>`;
    }
}

// æ•™å¸ˆæŸ¥çœ‹å­¦ç”Ÿ
async function showTeacherStudents() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p>åŠ è½½å­¦ç”Ÿåˆ—è¡¨...</p>';
    
    try {
        const { data: students, error } = await db
            .from('users')
            .select('*')
            .eq('is_teacher', false)
            .order('last_login', { ascending: false });
        
        if (error) throw error;
        
        if (!students || students.length === 0) {
            content.innerHTML = '<p>è¿˜æ²¡æœ‰å­¦ç”Ÿ</p>';
            return;
        }
        
        let html = '<h3>ğŸ‘¥ å­¦ç”Ÿåˆ—è¡¨</h3><table style="width:100%; margin-top:20px;">';
        html += '<tr style="background:#f5f5f5;"><th>å­¦ç”Ÿ</th><th>æœ€åç™»å½•</th></tr>';
        
        students.forEach(student => {
            const lastLogin = student.last_login ? 
                new Date(student.last_login).toLocaleDateString() : 'ä»æœª';
            html += `<tr><td>${student.username}</td><td>${lastLogin}</td></tr>`;
        });
        
        html += '</table>';
        html += '<div style="text-align:center; margin-top:20px;">';
        html += '<button class="btn" onclick="loadTeacherHome()">è¿”å›</button>';
        html += '</div>';
        
        content.innerHTML = html;
    } catch (error) {
        content.innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥</p>`;
    }
}

// æ•™å¸ˆæŸ¥çœ‹ç»Ÿè®¡
async function showTeacherStats() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p>åŠ è½½ç»Ÿè®¡...</p>';
    
    try {
        const { data: records, error } = await db.from('study_records').select('*');
        if (error) throw error;
        
        if (!records || records.length === 0) {
            content.innerHTML = '<p>æ²¡æœ‰å­¦ä¹ è®°å½•</p>';
            return;
        }
        
        const mastered = records.filter(r => r.status === 'mastered').length;
        const learning = records.filter(r => r.status === 'learning').length;
        const total = records.length;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        content.innerHTML = `
            <h3>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h3>
            <div class="stats-card">
                <p>æ€»å­¦ä¹ æ¬¡æ•°ï¼š${total}</p>
                <p>å·²æŒæ¡ï¼š${mastered}</p>
                <p>å­¦ä¹ ä¸­ï¼š${learning}</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn" onclick="loadTeacherHome()">è¿”å›</button>
            </div>
        `;
    } catch (error) {
        content.innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥</p>`;
    }
}

// å­¦ç”Ÿé¦–é¡µ
async function loadStudentHome() {
    const content = document.getElementById('student-content');
    content.innerHTML = '<p style="text-align:center;">åŠ è½½ä¸­...</p>';
    
    try {
        const { data: records, error } = await db
            .from('study_records')
            .select('*')
            .eq('student_id', currentUser);
        
        if (error) throw error;
        
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const learning = records?.filter(r => r.status === 'learning').length || 0;
        const needReview = records?.filter(r => r.status === 'new').length || 0;
        const total = records?.length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        // ä¿å­˜å•è¯
        studentWords = records || [];
        
        content.innerHTML = `
            <div class="stats-card">
                <h3>ğŸ“Š æˆ‘çš„è¿›åº¦</h3>
                <p>æ€»å•è¯æ•°ï¼š${total}</p>
                <p>å·²æŒæ¡ï¼š${mastered}</p>
                <p>å­¦ä¹ ä¸­ï¼š${learning}</p>
                <p>éœ€å­¦ä¹ ï¼š${needReview}</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <p>ğŸ’¡ ç‚¹å‡»å¼€å§‹å­¦ä¹ </p>
            </div>
        `;
    } catch (error) {
        content.innerHTML = `<p style="color:red; text-align:center;">åŠ è½½å¤±è´¥</p>`;
    }
}

// å­¦ç”Ÿå¼€å§‹å­¦ä¹ 
function startStudentLearning() {
    if (studentWords.length === 0) {
        alert('è¿˜æ²¡æœ‰å•è¯');
        return;
    }
    
    // ä¼˜å…ˆæ–°å•è¯
    const needLearn = studentWords.filter(w => w.status === 'new' || w.status === 'learning');
    const words = needLearn.length > 0 ? needLearn : studentWords;
    
    words.sort(() => Math.random() - 0.5);
    studentWords = words;
    currentWordIdx = 0;
    
    showLearningScreen();
}

function showLearningScreen() {
    if (currentWordIdx >= studentWords.length) {
        finishLearning();
        return;
    }
    
    const word = studentWords[currentWordIdx];
    
    const content = document.getElementById('student-content');
    content.innerHTML = `
        <h3 style="text-align:center;">ğŸ¯ å•è¯è®­ç»ƒ</h3>
        <p style="text-align:center;">${currentWordIdx + 1}/${studentWords.length}</p>
        <div class="word-card" onclick="flipWordCard()">
            <div id="card-front">${word.english}</div>
            <div id="card-back" style="display:none; color:#2e7d32;">${word.chinese}</div>
        </div>
        <div style="text-align:center; margin-top:30px;">
            <button class="btn" onclick="markAsMastered()">âœ… å·²æŒæ¡</button>
            <button class="btn btn-blue" onclick="markAsLearning()">ğŸ”„ å­¦ä¹ ä¸­</button>
            <button class="btn" onclick="skipThisWord()">â­ï¸ è·³è¿‡</button>
        </div>
    `;
}

function flipWordCard() {
    const front = document.getElementById('card-front');
    const back = document.getElementById('card-back');
    
    if (front.style.display !== 'none') {
        front.style.display = 'none';
        back.style.display = 'block';
    } else {
        front.style.display = 'block';
        back.style.display = 'none';
    }
}

async function markAsMastered() {
    await updateWordStatus('mastered');
}

async function markAsLearning() {
    await updateWordStatus('learning');
}

async function updateWordStatus(status) {
    const word = studentWords[currentWordIdx];
    
    try {
        await db
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', currentUser)
            .eq('english', word.english);
        
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        
        currentWordIdx++;
        showLearningScreen();
        
    } catch (error) {
        alert('ä¿å­˜å¤±è´¥');
    }
}

function skipThisWord() {
    currentWordIdx++;
    showLearningScreen();
}

function finishLearning() {
    const mastered = studentWords.filter(w => w.status === 'mastered').length;
    const total = studentWords.length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    alert(`ğŸ‰ å®Œæˆï¼\nå­¦ä¹  ${currentWordIdx} ä¸ªå•è¯\næŒæ¡ç‡ï¼š${progress}%`);
    loadStudentHome();
}

function showStudentProgress() {
    loadStudentHome();
}

// é€€å‡ºç™»å½•
function userLogout() {
    if (confirm('ç¡®å®šé€€å‡ºï¼Ÿ')) {
        currentUser = null;
        isTeacher = false;
        localStorage.removeItem('user_name');
        localStorage.removeItem('user_type');
        goToScreen('login-screen');
        document.getElementById('username').value = '';
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
window.onload = function() {
    const savedUser = localStorage.getItem('user_name');
    const savedType = localStorage.getItem('user_type');
    
    if (savedUser) {
        currentUser = savedUser;
        isTeacher = (savedType === 'teacher');
        
        if (isTeacher) {
            goToScreen('teacher-screen');
            loadTeacherHome();
        } else {
            goToScreen('student-screen');
            document.getElementById('student-name').textContent = `ğŸ“ ${savedUser}`;
            loadStudentHome();
        }
    } else {
        testDb();
    }
};

// ç»‘å®šå›è½¦é”®
document.getElementById('username')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') userLogin();
});
</script>
</body>
</html>
