<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ä¼˜åŒ–åçš„CSS - ç²¾ç®€å¹¶ä¿®å¤é—®é¢˜ */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden; 
        }
        
        .header { 
            background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            color: #F1C40F; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .main-content { 
            padding: 30px; 
            min-height: 500px;
        }
        
        .screen { 
            display: none; 
            animation: fadeIn 0.3s ease; 
        }
        
        .screen.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .btn { 
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white; 
            border: none; 
            padding: 14px 28px; 
            margin: 10px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            opacity: 0.95;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-blue { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .btn-red { background: linear-gradient(135deg, #F44336, #D32F2F); }
        .btn-purple { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
        .btn-gold { background: linear-gradient(135deg, #FFC107, #FFA000); color: #333; }
        
        /* è¾“å…¥æ¡†ä¼˜åŒ– */
        input[type="text"], 
        textarea, 
        input[type="password"], 
        select { 
            width: 100%; 
            max-width: 500px; 
            padding: 16px; 
            margin: 12px 0; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            font-size: 16px; 
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, 
        textarea:focus, 
        input[type="password"]:focus, 
        select:focus { 
            border-color: #4CAF50; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        textarea { 
            height: 200px; 
            font-family: 'Consolas', monospace; 
            resize: vertical; 
            line-height: 1.6;
        }
        
        /* å•è¯å¡ç‰‡ä¼˜åŒ– */
        .word-card { 
            background: white; 
            border: 4px solid #4CAF50; 
            border-radius: 20px; 
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px auto; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            max-width: 600px;
            padding: 20px;
            word-wrap: break-word;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .word-card-content {
            width: 100%;
            text-align: center;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´ */
        .font-size-xl { font-size: clamp(1.8em, 5vw, 2.8em); }
        .font-size-lg { font-size: clamp(1.5em, 4vw, 2.2em); }
        .font-size-md { font-size: clamp(1.2em, 3.5vw, 1.8em); }
        .font-size-sm { font-size: clamp(1em, 3vw, 1.5em); }
        .font-size-xs { font-size: clamp(0.9em, 2.5vw, 1.2em); }
        
        .word-card:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); 
        }
        
        .word-card.flipped { 
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9); 
            border-color: #2E7D32; 
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-card { 
            background: #f8f9fa; 
            border-radius: 15px; 
            padding: 25px; 
            margin: 20px 0; 
            border-left: 5px solid #4CAF50; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        .data-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            margin: 20px 0; 
            background: white; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        
        .data-table th { 
            background: #4CAF50; 
            color: white; 
            padding: 15px; 
            text-align: left; 
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table td { 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            transition: background-color 0.2s;
        }
        
        .data-table tr:hover { 
            background: #f5f5f5; 
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container { 
            width: 100%; 
            max-width: 600px; 
            margin: 20px auto; 
        }
        
        .progress-bar { 
            width: 100%; 
            height: 12px; 
            background: #e0e0e0; 
            border-radius: 6px; 
            overflow: hidden; 
            margin: 10px 0; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #4CAF50, #8BC34A); 
            width: 0%; 
            transition: width 0.5s ease; 
            border-radius: 6px;
        }
        
        /* æ¶ˆæ¯æ¡† */
        .message-box { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            text-align: center;
            border: 1px solid transparent;
        }
        
        .message-success { 
            background: #D4EDDA; 
            color: #155724; 
            border-color: #C3E6CB; 
        }
        
        .message-error { 
            background: #F8D7DA; 
            color: #721C24; 
            border-color: #F5C6CB; 
        }
        
        .message-info { 
            background: #D1ECF1; 
            color: #0C5460; 
            border-color: #BEE5EB; 
        }
        
        .message-warning { 
            background: #FFF3CD; 
            color: #856404; 
            border-color: #FFEEBA; 
        }
        
        /* å¾®ä¿¡å¾½ç«  */
        .wechat-badge { 
            background: linear-gradient(135deg, #07C160, #05a84e);
            color: white; 
            padding: 14px 28px; 
            border-radius: 25px; 
            display: inline-flex; 
            align-items: center; 
            gap: 12px; 
            font-weight: bold; 
            font-size: 1.1em; 
            margin: 15px 0; 
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3); 
        }
        
        /* ç½‘æ ¼ç³»ç»Ÿ */
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        
        .stat-card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-card .number { 
            font-size: 2.5em; 
            font-weight: bold; 
            margin: 10px 0; 
            color: #2C3E50;
        }
        
        .stat-card .label { 
            color: #666; 
            font-size: 0.9em; 
        }
        
        .two-column { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
            margin-bottom: 40px; 
        }
        
        /* å›ºå®šå¤´éƒ¨ */
        .fixed-header { 
            position: sticky; 
            top: 0; 
            background: white; 
            z-index: 1000; 
            padding: 15px 30px; 
            border-bottom: 2px solid #f0f0f0; 
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .content-padding { 
            padding-top: 20px; 
            padding-bottom: 30px; 
        }
        
        /* åº†ç¥æ¨ªå¹… */
        .celebration-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 215, 0, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 215, 0, 0.4); }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯é¡µé¢ */
        .error-page {
            text-align: center;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* ç¦»çº¿æ¨ªå¹… */
        .offline-banner {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
            padding: 12px 20px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1500;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container { 
                margin: 10px; 
                border-radius: 15px; 
            }
            
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            
            .main-content { padding: 20px; }
            
            .word-card { 
                height: 220px; 
                max-width: 95%;
                margin: 20px auto;
                padding: 15px;
            }
            
            .two-column { 
                grid-template-columns: 1fr; 
                gap: 20px;
            }
            
            .card-grid { 
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            }
            
            .fixed-header { 
                padding: 12px 20px; 
            }
            
            .btn { 
                padding: 12px 20px; 
                margin: 8px; 
                font-size: 15px; 
            }
        }
        
        @media (max-width: 480px) {
            body { padding: 10px; }
            
            .header h1 { font-size: 1.5em; }
            
            .word-card { 
                height: 200px; 
                padding: 10px;
                border-width: 3px;
            }
            
            .btn { 
                padding: 10px 15px; 
                margin: 5px; 
                font-size: 14px; 
            }
            
            .stat-card .number { font-size: 2em; }
        }
        
        /* æ–°å¢ä¼˜åŒ–æ ·å¼ */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* æ‚¬åœæ•ˆæœ */
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* ç¦ç”¨çŠ¶æ€ */
        .disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        /* éª¨æ¶å± */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="global-loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-message">æ­£åœ¨åŠ è½½...</div>
        <div style="color: #666; margin-top: 10px; font-size: 14px;" id="loading-details"></div>
    </div>

    <!-- ç¦»çº¿æç¤º -->
    <div id="offline-banner" class="offline-banner" style="display: none;">
        âš ï¸ ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...
    </div>

    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white; font-weight: 300; margin-bottom: 10px;">ğŸ‘­ å’Œå•è¯åšæœ‹å‹ ğŸ§¡</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2 style="margin-bottom: 20px;">ğŸ‘‘ æ¬¢è¿ä½¿ç”¨å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px; font-size: 1.1em;">ğŸ§¡ Kathyé™ªä½ ä¸€èµ·å’Œå•è¯ç©æ¸¸æˆ ğŸ§¡</p>
                    
                    <div style="margin: 30px 0; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‹±æ–‡åï¼Œé¦–å­—æ¯å¤§å†™ï¼‰" autofocus>
                        <div id="login-message" class="message-box message-info" style="display: none;">
                            æ­£åœ¨è¿æ¥ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn" onclick="handleLogin()">
                                <span>ğŸ”‘</span>
                                <span>ç™»å½•/æ³¨å†Œ</span>
                            </button>
                            <button class="btn btn-blue" onclick="testDatabase()">
                                <span>ğŸ”§</span>
                                <span>æµ‹è¯•è¿æ¥</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px; text-align: center;">ğŸ“± ä½¿ç”¨è¯´æ˜</h3>
                        <div class="card-grid">
                            <div class="stat-card hover-lift">
                                <div style="font-size: 2em;">ğŸ‘©â€ğŸ«</div>
                                <div style="font-weight: bold; margin: 10px 0;">Kathyæ•™å¸ˆç«¯</div>
                                <div>å…³æ³¨å®ä»¬æ¯å¤©å•è¯è¿›åº¦</div>
                                <div>ä»Šå¤©ä½ å’Œå•è¯ç©æ¸¸æˆäº†ä¹ˆï¼Ÿ</div>
                            </div>
                            <div class="stat-card hover-lift">
                                <div style="font-size: 2em;">ğŸ“</div>
                                <div style="font-weight: bold; margin: 10px 0;">å­¦ç”Ÿè´¦å·</div>
                                <div>Kathyå•ç‹¬å‘é€</div>
                                <div>åå­—é¦–å­—æ¯è¦å¤§å†™å“¦</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center;">
                            <div class="wechat-badge" style="display: inline-flex;">
                                <span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            <p style="color: #555; margin-top: 15px;">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="margin: 0; color: #333;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h2>
                            <p style="color: #666; font-size: 14px; margin-top: 5px;">æ¬¢è¿å›æ¥ï¼ŒKathyè€å¸ˆï¼</p>
                        </div>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª</span>
                            <span>é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="teacher-stats" class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <div class="card-grid">
                            <div class="stat-card hover-lift">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card hover-lift">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card hover-lift">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card hover-lift">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                            <button class="btn btn-purple hover-lift" onclick="showUploadWordsPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“</div>
                                <div>ä¸Šä¼ å•è¯</div>
                            </button>
                            <button class="btn btn-blue hover-lift" onclick="showGroupManagementPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ‘¥</div>
                                <div>åˆ†ç»„ç®¡ç†</div>
                            </button>
                            <button class="btn hover-lift" onclick="showAllStudentsPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“‹</div>
                                <div>æ‰€æœ‰å­¦ç”Ÿ</div>
                            </button>
                            <button class="btn btn-gold hover-lift" onclick="showLearningProgressPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“Š</div>
                                <div>å­¦ä¹ è¿›åº¦</div>
                            </button>
                            <button class="btn hover-lift" onclick="showWordManagementPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“–</div>
                                <div>å•è¯ç®¡ç†</div>
                            </button>
                            <button class="btn hover-lift" onclick="showShareSystemPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ”—</div>
                                <div>åˆ†äº«ç³»ç»Ÿ</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="margin: 0; color: #333;">ğŸ“ æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px; flex-wrap: wrap;">
                                <div id="clock-in-status" style="background: #4CAF50; color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; display: inline-flex; align-items: center; gap: 5px;">
                                    <span>âœ…</span>
                                    <span>ä»Šæ—¥å·²æ‰“å¡</span>
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ”¥ <span id="consecutive-days">0</span> å¤©è¿ç»­å­¦ä¹ 
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª</span>
                            <span>é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <!-- ä»Šæ—¥å­¦ä¹ æƒ…å†µ -->
                    <div id="today-status" style="margin-bottom: 30px;"></div>
                    
                    <!-- æˆ‘çš„å­¦ä¹ è¿›åº¦ -->
                    <div id="my-progress-summary" class="stats-card" style="margin-bottom: 30px;"></div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                        <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <button class="btn hover-lift" onclick="dailyClockIn()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“…</div>
                                <div>æ¯æ—¥æ‰“å¡</div>
                            </button>
                            
                            <button class="btn hover-lift" onclick="showTrainingOptions()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ¯</div>
                                <div>å¼€å§‹è®­ç»ƒ</div>
                            </button>
                            
                            <button class="btn btn-blue hover-lift" onclick="showClockInStats()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“Š</div>
                                <div>å­¦ä¹ ç»Ÿè®¡</div>
                            </button>
                            
                            <button class="btn hover-lift" onclick="showMyWordListPage()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ“–</div>
                                <div>æˆ‘çš„å•è¯æœ¬</div>
                            </button>
                            
                            <button class="btn hover-lift" onclick="startReviewTraining()" style="height: 100px; flex-direction: column;">
                                <div style="font-size: 24px;">ğŸ”„</div>
                                <div>å¤ä¹ å¼±é¡¹</div>
                            </button>
                            
                            <button class="btn btn-gold hover-lift" onclick="manualSyncWords()" style="height: 100px; flex-direction: column; grid-column: span 2;">
                                <div style="font-size: 24px;">ğŸ”„</div>
                                <div>ç«‹å³åŒæ­¥å•è¯</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„åˆ†ç»„è¯¦æƒ… -->
                    <div id="group-details" style="margin-bottom: 30px;"></div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- è®­ç»ƒé€‰æ‹©é¡µé¢ -->
            <div id="training-options-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ é€‰æ‹©è®­ç»ƒæ¨¡å¼</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                            <h3 style="text-align: center; margin-bottom: 30px; color: #333;">é€‰æ‹©è®­ç»ƒå†…å®¹</h3>
                            
                            <div id="daily-training-options" style="margin-bottom: 40px;"></div>
                            
                            <div style="margin-bottom: 40px;">
                                <button class="btn hover-lift" onclick="startAllWordsTraining()" 
                                        style="width: 100%; padding: 25px; font-size: 18px; margin-bottom: 15px; flex-direction: column;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“š</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">æ‰€æœ‰å•è¯è®­ç»ƒ</div>
                                    <div style="color: #666; font-size: 14px;">è®­ç»ƒæ‰€æœ‰å·²åŒæ­¥çš„å•è¯</div>
                                </button>
                                
                                <button class="btn btn-blue hover-lift" onclick="startReviewTraining()" 
                                        style="width: 100%; padding: 25px; font-size: 18px; flex-direction: column;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">å¤ä¹ å¼±é¡¹</div>
                                    <div style="color: #666; font-size: 14px;">é‡ç‚¹å¤ä¹ æœªæŒæ¡å•è¯</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®­ç»ƒé¡µé¢ -->
            <div id="training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="color: #666; display: flex; align-items: center; gap: 10px;">
                            <span>è¿›åº¦:</span>
                            <span id="training-progress">0/0</span>
                        </div>
                        <button class="btn btn-red" onclick="cancelTraining()" style="padding: 8px 16px;">
                            <span>ğŸ</span>
                            <span>ç»“æŸè®­ç»ƒ</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="training-content" style="max-width: 600px; margin: 0 auto;"></div>
                </div>
            </div>
            
            <!-- æ‰“å¡ç»Ÿè®¡é¡µé¢ -->
            <div id="clockin-stats-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 1000px; margin: 0 auto;" id="clockin-stats-content"></div>
                </div>
            </div>
            
            <!-- æ¯æ—¥ä»»åŠ¡é¡µé¢ -->
            <div id="daily-task-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ ä»Šæ—¥å­¦ä¹ ä»»åŠ¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 800px; margin: 0 auto;" id="daily-task-content"></div>
                </div>
            </div>
            
            <!-- å•è¯åˆ—è¡¨é¡µé¢ -->
            <div id="word-categories-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ“š å•è¯åˆ—è¡¨</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 1200px; margin: 0 auto;" id="category-words-content"></div>
                </div>
            </div>
            
            <!-- å¤ä¹ è®¡åˆ’é¡µé¢ -->
            <div id="review-plan-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ”„ æ™ºèƒ½å¤ä¹ è®¡åˆ’</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 1000px; margin: 0 auto;" id="review-plan-content"></div>
                </div>
            </div>
            
            <!-- ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ ä¸Šä¼ å•è¯</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-upload-content"></div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ -->
            <div id="teacher-groups-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-groups-content"></div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ -->
            <div id="teacher-students-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-students-content"></div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ -->
            <div id="teacher-progress-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-progress-content"></div>
            </div>
            
            <!-- æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ -->
            <div id="teacher-words-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– å•è¯ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-words-content"></div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†äº«ç³»ç»Ÿé¡µé¢ -->
            <div id="teacher-share-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; color: #333;">ğŸ”— åˆ†äº«ç³»ç»Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™</span>
                            <span>è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-share-content"></div>
            </div>
        </div>
    </div>

    <script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';

// åˆ›å»ºSupabaseå®¢æˆ·ç«¯
const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null,
    // æ–°å¢ï¼šç¼“å­˜ç³»ç»Ÿ
    cache: {
        students: null,
        groups: null,
        words: null,
        lastUpdated: {}
    }
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) {
        screen.classList.add('active');
        // è§¦å‘é¡µé¢æ˜¾ç¤ºäº‹ä»¶
        setTimeout(() => {
            if (screenId === 'student-screen') loadStudentDashboardSimple();
            else if (screenId === 'teacher-screen') loadTeacherDashboard();
        }, 100);
    }
}

function showLoading(message = 'æ­£åœ¨åŠ è½½', details = '') {
    const loadingEl = document.getElementById('global-loading');
    if (loadingEl) {
        loadingEl.style.display = 'flex';
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-details').textContent = details;
    }
}

function hideLoading() {
    const loadingEl = document.getElementById('global-loading');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
}

function showAlert(message, type = 'info', duration = 3000) {
    // ç§»é™¤æ—§çš„æç¤º
    const oldAlerts = document.querySelectorAll('.custom-alert');
    oldAlerts.forEach(alert => alert.remove());
    
    const alertBox = document.createElement('div');
    alertBox.className = `custom-alert message-box message-${type}`;
    alertBox.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        max-width: 500px;
        width: 90%;
        animation: slideDown 0.3s ease-out;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    `;
    
    alertBox.innerHTML = `
        <div style="flex: 1;">
            ${getAlertIcon(type)} ${message}
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        ">&times;</button>
    `;
    
    document.body.appendChild(alertBox);
    
    if (duration > 0) {
        setTimeout(() => {
            if (alertBox.parentNode) {
                alertBox.style.opacity = '0';
                alertBox.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (alertBox.parentNode) {
                        alertBox.remove();
                    }
                }, 300);
            }
        }, duration);
    }
    
    return alertBox;
}

function getAlertIcon(type) {
    switch(type) {
        case 'success': return 'âœ…';
        case 'error': return 'âŒ';
        case 'warning': return 'âš ï¸';
        case 'info': return 'â„¹ï¸';
        default: return '';
    }
}

// æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´
function getFontSizeClass(text) {
    if (!text) return 'font-size-md';
    const length = text.length;
    if (length <= 8) return 'font-size-xl';
    if (length <= 12) return 'font-size-lg';
    if (length <= 18) return 'font-size-md';
    if (length <= 24) return 'font-size-sm';
    return 'font-size-xs';
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    const messageEl = document.getElementById('login-message');
    if (messageEl) {
        messageEl.textContent = 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...';
        messageEl.className = 'message-box message-warning';
        messageEl.style.display = 'block';
    }
    
    try {
        // ä½¿ç”¨æ›´å¿«çš„æŸ¥è¯¢æ–¹å¼
        const startTime = Date.now();
        const { data, error } = await dbClient
            .from('users')
            .select('count')
            .limit(1)
            .single();
        
        const endTime = Date.now();
        
        if (error) {
            // å°è¯•å¦ä¸€ç§æ–¹å¼
            const { error: error2 } = await dbClient.auth.getSession();
            if (error2) throw error2;
        }
        
        const message = `âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼ (${endTime - startTime}ms)`;
        if (messageEl) {
            messageEl.textContent = message;
            messageEl.className = 'message-box message-success';
        }
        
        // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
        setTimeout(() => {
            if (messageEl) {
                messageEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå¼€å§‹å­¦ä¹ ';
                messageEl.className = 'message-box message-info';
            }
        }, 3000);
        
    } catch (error) {
        console.error('æ•°æ®åº“è¿æ¥é”™è¯¯:', error);
        if (messageEl) {
            messageEl.textContent = `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`;
            messageEl.className = 'message-box message-error';
        }
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const usernameInput = document.getElementById('username');
    const username = usernameInput.value.trim();
    
    if (!username) {
        showAlert('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showLoading('æ­£åœ¨ç™»å½•...');
    
    try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ•™å¸ˆè´¦å·
        const isTeacher = username.toLowerCase() === 'kathy151';
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .maybeSingle();
        
        if (checkError) {
            throw new Error(`æ£€æŸ¥ç”¨æˆ·å¤±è´¥: ${checkError.message}`);
        }
        
        let userData;
        
        if (!existingUser) {
            // æ–°ç”¨æˆ· - æ³¨å†Œ
            const { data: newUser, error: insertError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacher,
                    last_login: new Date().toISOString(),
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (insertError) {
                throw new Error(`æ³¨å†Œå¤±è´¥: ${insertError.message}`);
            }
            
            userData = newUser;
            showAlert(`âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
        } else {
            // ç°æœ‰ç”¨æˆ· - æ›´æ–°æœ€åç™»å½•æ—¶é—´
            const { error: updateError } = await dbClient
                .from('users')
                .update({ 
                    last_login: new Date().toISOString(),
                    login_count: (existingUser.login_count || 0) + 1
                })
                .eq('username', username);
            
            if (updateError) {
                console.warn('æ›´æ–°ç™»å½•æ—¶é—´å¤±è´¥:', updateError);
            }
            
            userData = existingUser;
            showAlert(`âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // è®¾ç½®å…¨å±€çŠ¶æ€
        appState.currentUser = username;
        appState.isTeacher = isTeacher;
        appState.userId = username;
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', isTeacher ? 'teacher' : 'student');
        localStorage.setItem('kathy_last_login', new Date().toISOString());
        
        hideLoading();
        
        // å»¶è¿Ÿååˆ‡æ¢åˆ°ç›¸åº”ç•Œé¢
        setTimeout(() => {
            if (isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 500);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        hideLoading();
        showAlert(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
    }
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        // æ¸…é™¤æ‰€æœ‰çŠ¶æ€
        Object.keys(appState).forEach(key => {
            if (typeof appState[key] === 'object' && appState[key] !== null) {
                if (Array.isArray(appState[key])) {
                    appState[key] = [];
                } else {
                    appState[key] = {};
                }
            } else {
                appState[key] = null;
            }
        });
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        localStorage.removeItem('kathy_last_login');
        
        // è¿”å›ç™»å½•é¡µé¢
        showScreen('login-screen');
        const usernameInput = document.getElementById('username');
        if (usernameInput) {
            usernameInput.value = '';
            usernameInput.focus();
        }
        
        showAlert('å·²é€€å‡ºç™»å½•', 'info');
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboardSimple();
}

async function loadStudentDashboardSimple() {
    showLoading('æ­£åœ¨åŠ è½½å­¦ä¹ æ•°æ®...');
    
    try {
        // è®¾ç½®å­¦ç”Ÿå§“å
        const studentNameEl = document.getElementById('student-name');
        if (studentNameEl) {
            studentNameEl.textContent = appState.currentUser || 'å­¦ç”Ÿ';
        }
        
        // åŒæ­¥å•è¯
        await syncGroupWordsToStudent(appState.currentUser);
        
        // è·å–å­¦ä¹ è®°å½•
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) {
            console.error('è·å–å­¦ä¹ è®°å½•é”™è¯¯:', error);
            appState.userWords = [];
        } else {
            appState.userWords = records || [];
        }
        
        // ä»Šæ—¥å­¦ä¹ æƒ…å†µ
        await loadTodayStatus();
        
        // æˆ‘çš„å­¦ä¹ è¿›åº¦
        await loadMyProgressSummary();
        
        // åˆ†ç»„è¯¦æƒ…
        await loadGroupDetails();
        
        // åŠ è½½æ‰“å¡çŠ¶æ€
        await loadClockInStatus();
        
        hideLoading();
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        hideLoading();
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

async function loadTodayStatus() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayRecords = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today
    );
    
    const target = 10;
    const todayProgress = Math.min(todayRecords.length, target);
    const progressPercent = (todayProgress / target) * 100;

    const todayStatus = document.getElementById('today-status');
    if (!todayStatus) return;
    
    todayStatus.innerHTML = `
        <div class="stats-card">
            <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
            <div class="card-grid">
                <div class="stat-card hover-lift" onclick="showTodayWords()" style="cursor: pointer;">
                    <div class="number" style="color: #2196F3;">${todayRecords.length}</div>
                    <div class="label">ä»Šæ—¥å·²å­¦</div>
                </div>
                
                <div class="stat-card">
                    <div class="number">${Math.max(0, target - todayRecords.length)}</div>
                    <div class="label">å»ºè®®å­¦ä¹ </div>
                </div>
                
                <div class="stat-card hover-lift" onclick="showTodayMasteredWords()" style="cursor: pointer;">
                    <div class="number" style="color: #4CAF50;">${todayRecords.filter(r => r.status === 'mastered').length}</div>
                    <div class="label">ä»Šæ—¥æŒæ¡</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${todayProgress}/${target}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                </div>
            </div>
            ${todayRecords.length >= target ? 
                '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : 
                '<p style="color: #FF9800; text-align: center; margin-top: 15px;">ğŸ’ª ç»§ç»­åŠªåŠ›ï¼</p>'}
        </div>
    `;
}

async function loadMyProgressSummary() {
    const totalWords = appState.userWords.length;
    const learnedWords = appState.userWords.filter(w => w.last_reviewed);
    const unlearnedWords = appState.userWords.filter(w => !w.last_reviewed);
    const masteredWords = learnedWords.filter(w => w.status === 'mastered');
    const learningWords = learnedWords.filter(w => w.status === 'learning');
    const weakWords = learnedWords.filter(w => w.status === 'new');

    const progressSummary = document.getElementById('my-progress-summary');
    if (!progressSummary) return;
    
    progressSummary.innerHTML = `
        <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
        
        <div class="card-grid">
            <div class="stat-card hover-lift" onclick="showAllLearnedWords()" style="cursor: pointer;">
                <div class="number" style="color: #2196F3;">${learnedWords.length}</div>
                <div class="label">å·²å­¦ä¹ </div>
            </div>
            
            <div class="stat-card hover-lift" onclick="showUnlearnedWords()" style="cursor: pointer;">
                <div class="number" style="color: #9C27B0;">${unlearnedWords.length}</div>
                <div class="label">æœªå­¦ä¹ </div>
            </div>
            
            <div class="stat-card hover-lift" onclick="showMasteredWords()" style="cursor: pointer;">
                <div class="number" style="color: #4CAF50;">${masteredWords.length}</div>
                <div class="label">å·²æŒæ¡</div>
            </div>
            
            <div class="stat-card hover-lift" onclick="showLearningWords()" style="cursor: pointer;">
                <div class="number" style="color: #FF9800;">${learningWords.length}</div>
                <div class="label">ç†Ÿæ‚‰</div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                <span style="color: #4CAF50; font-weight: bold;">${totalWords > 0 ? Math.round((masteredWords.length / totalWords) * 100) : 0}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${totalWords > 0 ? Math.round((masteredWords.length / totalWords) * 100) : 0}%"></div>
            </div>
        </div>
    `;
}

async function loadGroupDetails() {
    const groupDetails = document.getElementById('group-details');
    if (!groupDetails) return;
    
    try {
        const { data: studentGroups } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', appState.currentUser);
        
        let groupDetailsHTML = '';
        
        if (studentGroups && studentGroups.length > 0) {
            const groupIds = studentGroups.map(g => g.group_id);
            const { data: groups } = await dbClient
                .from('groups')
                .select('id, name')
                .in('id', groupIds);
            
            for (const group of groups || []) {
                const { data: groupWords } = await dbClient
                    .from('words')
                    .select('*')
                    .eq('group_id', group.id);
                
                const { data: myGroupRecords } = await dbClient
                    .from('study_records')
                    .select('*')
                    .eq('student_id', appState.currentUser)
                    .eq('group_id', group.id);
                
                groupDetailsHTML += `
                    <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: #333;">${group.name}</div>
                        <div style="color: #666; font-size: 14px;">
                            ğŸ“š åˆ†ç»„å•è¯: ${groupWords?.length || 0} | 
                            ğŸ“– æˆ‘çš„å•è¯: ${myGroupRecords?.length || 0}
                        </div>
                    </div>
                `;
            }
        }
        
        groupDetails.innerHTML = groupDetailsHTML ? `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š æˆ‘çš„åˆ†ç»„è¯¦æƒ…</h3>
                ${groupDetailsHTML}
            </div>
        ` : `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š åˆ†ç»„çŠ¶æ€</h3>
                <p style="color: #FF9800; text-align: center;">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„</p>
                <p style="color: #666; text-align: center; font-size: 14px;">è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„è¯¦æƒ…é”™è¯¯:', error);
        groupDetails.innerHTML = `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š åˆ†ç»„çŠ¶æ€</h3>
                <p style="color: #F44336; text-align: center;">åŠ è½½åˆ†ç»„ä¿¡æ¯å¤±è´¥</p>
            </div>
        `;
    }
}

// ========== åŒæ­¥å•è¯ç»™å­¦ç”Ÿ ==========
async function syncGroupWordsToStudent(studentId) {
    if (!studentId) return 0;
    
    showLoading('æ­£åœ¨åŒæ­¥å•è¯...', 'è¯·ç¨å€™');
    
    try {
        console.log(`å¼€å§‹ä¸º ${studentId} åŒæ­¥åˆ†ç»„å•è¯...`);
        
        // è·å–å­¦ç”Ÿæ‰€åœ¨çš„åˆ†ç»„
        const { data: studentGroups, error: groupsError } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', studentId);
        
        if (groupsError) {
            console.error('è·å–å­¦ç”Ÿåˆ†ç»„é”™è¯¯:', groupsError);
            hideLoading();
            return 0;
        }
        
        if (!studentGroups || studentGroups.length === 0) {
            console.log(`å­¦ç”Ÿ ${studentId} æ²¡æœ‰åŠ å…¥ä»»ä½•åˆ†ç»„`);
            hideLoading();
            showAlert('æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„ï¼Œè¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­', 'warning');
            return 0;
        }
        
        const groupIds = studentGroups.map(g => g.group_id);
        console.log(`å­¦ç”Ÿ ${studentId} çš„åˆ†ç»„ID:`, groupIds);
        
        // è·å–åˆ†ç»„ä¿¡æ¯
        const { data: groupInfo, error: groupInfoError } = await dbClient
            .from('groups')
            .select('id, name')
            .in('id', groupIds);
        
        if (groupInfoError) {
            console.error('è·å–åˆ†ç»„ä¿¡æ¯é”™è¯¯:', groupInfoError);
        }
        
        const groupNames = groupInfo?.map(g => g.name) || [];
        console.log(`å­¦ç”Ÿ ${studentId} åœ¨åˆ†ç»„:`, groupNames);
        
        // è·å–åˆ†ç»„å†…çš„å•è¯
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .in('group_id', groupIds)
            .eq('teacher_id', appState.teacherId);
        
        if (wordsError) {
            console.error('è·å–åˆ†ç»„å•è¯é”™è¯¯:', wordsError);
            hideLoading();
            return 0;
        }
        
        if (!groupWords || groupWords.length === 0) {
            console.log(`å­¦ç”Ÿ ${studentId} çš„åˆ†ç»„ä¸­æ²¡æœ‰å•è¯`);
            hideLoading();
            showAlert('æ‚¨æ‰€åœ¨çš„åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯ï¼Œè¯·è”ç³»è€å¸ˆä¸Šä¼ å•è¯', 'info');
            return 0;
        }
        
        console.log(`æ‰¾åˆ° ${groupWords.length} ä¸ªåˆ†ç»„å•è¯`);
        
        // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²æœ‰è¿™äº›å•è¯
        const { data: existingRecords, error: checkError } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        if (checkError) {
            console.error('æ£€æŸ¥ç°æœ‰è®°å½•é”™è¯¯:', checkError);
            hideLoading();
            return 0;
        }
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°å•è¯è®°å½•
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                review_count: 0,
                group_id: word.group_id,
                added_date: new Date().toISOString()
            }));
        
        console.log(`éœ€è¦åŒæ­¥ ${newRecords.length} ä¸ªæ–°å•è¯`);
        
        let syncedCount = 0;
        
        if (newRecords.length > 0) {
            // åˆ†æ‰¹æ’å…¥
            const batchSize = 50;
            for (let i = 0; i < newRecords.length; i += batchSize) {
                const batch = newRecords.slice(i, i + batchSize);
                const { error: insertError } = await dbClient
                    .from('study_records')
                    .insert(batch);
                
                if (insertError) {
                    console.error(`æ‰¹é‡æ’å…¥é”™è¯¯:`, insertError);
                    // å°è¯•é€ä¸ªæ’å…¥
                    for (const record of batch) {
                        try {
                            const { error: singleError } = await dbClient
                                .from('study_records')
                                .insert(record);
                            if (!singleError) syncedCount++;
                        } catch (err) {
                            console.error('æ’å…¥å¼‚å¸¸:', err);
                        }
                    }
                } else {
                    syncedCount += batch.length;
                }
            }
            
            console.log(`æˆåŠŸä¸º ${studentId} åŒæ­¥äº† ${syncedCount} ä¸ªæ–°å•è¯`);
            
            if (syncedCount > 0) {
                showAlert(`âœ… å·²ä¸ºæ‚¨åŒæ­¥ ${syncedCount} ä¸ªæ–°å•è¯\nğŸ“ æ¥è‡ªåˆ†ç»„ï¼š${groupNames.join(', ')}`, 'success');
            }
        } else {
            console.log(`æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–°å•è¯`);
            showAlert(`ğŸ“š æ‚¨å·²åŒæ­¥æ‰€æœ‰åˆ†ç»„å•è¯\nğŸ“ æ‰€åœ¨åˆ†ç»„ï¼š${groupNames.join(', ')}\nğŸ“– å•è¯æ€»æ•°ï¼š${groupWords.length}`, 'info');
        }
        
        hideLoading();
        return syncedCount;
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
        hideLoading();
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// ========== è®­ç»ƒç³»ç»Ÿ ==========
function showTrainingOptions() {
    showScreen('training-options-screen');
    loadTrainingOptions();
}

async function loadTrainingOptions() {
    const optionsDiv = document.getElementById('daily-training-options');
    if (!optionsDiv) return;
    
    const today = new Date().toDateString();
    const storedDate = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
    const todayProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
    
    if (storedDate === today && todayProgress >= 10) {
        optionsDiv.innerHTML = `
            <div class="continue-options">
                <h4 style="color: #1565C0; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥è®­ç»ƒ</h4>
                <p style="color: #666; margin-bottom: 20px;">æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn hover-lift" onclick="startNewDailyTraining()" 
                            style="padding: 20px; font-size: 16px; flex-direction: column;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ†•</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">æ–°å•è¯è®­ç»ƒ</div>
                        <div style="color: #666; font-size: 14px;">å­¦ä¹ æ–°çš„å•è¯</div>
                    </button>
                    
                    <button class="btn btn-blue hover-lift" onclick="continueReviewTraining()" 
                            style="padding: 20px; font-size: 16px; flex-direction: column;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">ç»§ç»­å¤ä¹ </div>
                        <div style="color: #666; font-size: 14px;">å¤ä¹ ä»Šæ—¥å­¦è¿‡çš„å•è¯</div>
                    </button>
                </div>
                <p style="color: #4CAF50; text-align: center; margin-top: 15px; font-weight: bold;">
                    ğŸ‰ å¤ªæ£’äº†ï¼æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€ä»»åŠ¡ï¼
                </p>
            </div>
        `;
    } else {
        optionsDiv.innerHTML = `
            <button class="btn btn-blue hover-lift" onclick="startDailyTraining()" 
                    style="width: 100%; padding: 25px; font-size: 18px; margin-bottom: 15px; flex-direction: column;">
                <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“…</div>
                <div style="font-weight: bold; margin-bottom: 5px;">ä»Šæ—¥è®­ç»ƒ</div>
                <div style="color: #666; font-size: 14px;">æ¯å¤©10ä¸ªå•è¯ï¼Œç§‘å­¦è®°å¿†</div>
                ${todayProgress > 0 ? `<div style="color: #4CAF50; margin-top: 5px;">ä»Šæ—¥è¿›åº¦: ${todayProgress}/10</div>` : ''}
            </button>
        `;
    }
}

function startNewDailyTraining() {
    localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0');
    startDailyTraining();
}

function continueReviewTraining() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayWords = appState.userWords.filter(word => 
        word.last_reviewed && new Date(word.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        startNewDailyTraining();
        return;
    }
    
    const reviewWords = todayWords.sort((a, b) => {
        if (a.status === 'new' && b.status !== 'new') return -1;
        if (a.status !== 'new' && b.status === 'new') return 1;
        if (a.status === 'learning' && b.status === 'mastered') return -1;
        if (a.status === 'mastered' && b.status === 'learning') return 1;
        return (a.review_count || 0) - (b.review_count || 0);
    }).slice(0, 10);
    
    if (reviewWords.length === 0) {
        showAlert('ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯', 'info');
        startNewDailyTraining();
        return;
    }
    
    reviewWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = reviewWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startAllWordsTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const savedProgress = localStorage.getItem(`kathy_all_training_${appState.currentUser}`);
    let startIndex = 0;
    
    if (savedProgress) {
        try {
            const progress = JSON.parse(savedProgress);
            const today = new Date().toDateString();
            if (progress.date === today && progress.index > 0) {
                const continueTraining = confirm(`å‘ç°ä¸Šæ¬¡çš„è®­ç»ƒè¿›åº¦ï¼ˆ${progress.index}/${progress.total}ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`);
                if (continueTraining) {
                    startIndex = progress.index;
                }
            }
        } catch (e) {
            console.error('è§£æè®­ç»ƒè¿›åº¦é”™è¯¯:', e);
        }
    }
    
    appState.trainingWords = [...appState.userWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = startIndex;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startDailyTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const todayProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
    const target = 10;
    
    if (todayProgress >= target) {
        const continueTraining = confirm(`æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼æ˜¯å¦ç»§ç»­å­¦ä¹ æ›´å¤šå•è¯ï¼Ÿ`);
        if (!continueTraining) {
            showAlert('æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€è®­ç»ƒï¼Œå¾ˆæ£’ï¼', 'success');
            return;
        }
    }
    
    const newWords = appState.userWords.filter(w => w.status === 'new');
    const learningWords = appState.userWords.filter(w => w.status === 'learning');
    const masteredWords = appState.userWords.filter(w => w.status === 'mastered');
    
    let dailyWords = [];
    const wordsNeeded = Math.max(5, target - todayProgress);
    
    if (newWords.length > 0) {
        const newCount = Math.min(Math.ceil(wordsNeeded * 0.5), newWords.length);
        dailyWords = dailyWords.concat(newWords.slice(0, newCount));
    }
    
    if (learningWords.length > 0 && dailyWords.length < wordsNeeded) {
        const learningCount = Math.min(Math.ceil(wordsNeeded * 0.3), learningWords.length);
        dailyWords = dailyWords.concat(learningWords.slice(0, learningCount));
    }
    
    if (masteredWords.length > 0 && dailyWords.length < wordsNeeded) {
        const reviewCount = wordsNeeded - dailyWords.length;
        const sortedMastered = masteredWords.sort((a, b) => {
            const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
            const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
            return aDate - bDate;
        });
        dailyWords = dailyWords.concat(sortedMastered.slice(0, reviewCount));
    }
    
    if (dailyWords.length < wordsNeeded) {
        const allWords = [...appState.userWords];
        const remaining = wordsNeeded - dailyWords.length;
        const usedIds = new Set(dailyWords.map(w => w.id || w.word_id));
        
        for (let i = 0; i < allWords.length && dailyWords.length < wordsNeeded; i++) {
            const word = allWords[i];
            if (!usedIds.has(word.id || word.word_id)) {
                dailyWords.push(word);
            }
        }
    }
    
    dailyWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = dailyWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startReviewTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const learnedWords = appState.userWords.filter(w => w.last_reviewed);
    
    if (learnedWords.length === 0) {
        showAlert('ğŸ‰ è¿˜æ²¡æœ‰å·²å­¦ä¹ çš„å•è¯ï¼Œè¯·å…ˆå¼€å§‹å­¦ä¹ æ–°å•è¯ï¼', 'info');
        startDailyTraining();
        return;
    }
    
    const weakWords = learnedWords.filter(w => w.status === 'new' || w.status === 'learning');
    const reviewWords = weakWords.length >= 10 ? 
        weakWords : 
        [...weakWords, ...learnedWords.filter(w => !weakWords.includes(w))];
    
    const shuffledReviewWords = [...reviewWords].sort(() => Math.random() - 0.5);
    appState.trainingWords = shuffledReviewWords.slice(0, 20);
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startTrainingSession() {
    showScreen('training-screen');
    showTrainingScreenSimple();
}

function showTrainingScreenSimple() {
    if (appState.currentWordIndex >= appState.trainingWords.length) {
        finishTraining();
        return;
    }
    
    const word = appState.trainingWords[appState.currentWordIndex];
    const total = appState.trainingWords.length;
    const current = appState.currentWordIndex + 1;
    
    document.getElementById('training-progress').textContent = `${current}/${total}`;
    
    const englishFontSize = getFontSizeClass(word.english);
    const chineseFontSize = getFontSizeClass(word.chinese);
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <!-- å•è¯å¡ç‰‡ -->
            <div class="word-card ${appState.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
                <div class="word-card-content ${appState.isCardFlipped ? chineseFontSize : englishFontSize}">
                    ${appState.isCardFlipped ? `
                        <div style="color: #2E7D32; word-break: break-word;">
                            ${word.chinese}
                        </div>
                    ` : `
                        <div style="color: #333; word-break: break-word;">
                            ${word.english}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- çŠ¶æ€æŒ‰é’® -->
            <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn hover-lift" onclick="markTrainingWord('mastered')" 
                        style="padding: 15px;">
                    <div style="font-size: 20px; margin-bottom: 5px;">âœ…</div>
                    <div>å·²æŒæ¡</div>
                </button>
                
                <button class="btn btn-blue hover-lift" onclick="markTrainingWord('learning')" 
                        style="padding: 15px;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ”„</div>
                    <div>ç†Ÿæ‚‰</div>
                </button>
                
                <button class="btn hover-lift" onclick="markTrainingWord('new')" 
                        style="padding: 15px;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ“</div>
                    <div>æ²¡å°è±¡</div>
                </button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn hover-lift" onclick="skipTrainingWord()" 
                        style="flex: 1; padding: 12px;">
                    <div>â­ï¸ è·³è¿‡</div>
                </button>
                
                <button class="btn hover-lift" onclick="saveTrainingProgress()" 
                        style="flex: 1; padding: 12px;">
                    <div>ğŸ’¾ ä¿å­˜è¿›åº¦</div>
                </button>
                
                <button class="btn hover-lift" onclick="showStudentDashboard()" 
                        style="flex: 1; padding: 12px;">
                    <div>ğŸ“‹ è¿”å›</div>
                </button>
            </div>
            
            <div style="margin-top: 20px; color: #666; font-size: 14px;">
                <p>ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
                <p>é€‰æ‹©é€‚å½“çš„æŒæ¡ç¨‹åº¦</p>
            </div>
        </div>
    `;
}

function flipTrainingCard() {
    const word = appState.trainingWords[appState.currentWordIndex];
    const card = document.querySelector('.word-card');
    const content = card.querySelector('.word-card-content');
    
    if (appState.isCardFlipped) {
        card.classList.remove('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.english);
        content.innerHTML = `
            <div style="color: #333; word-break: break-word;">
                ${word.english}
            </div>
        `;
    } else {
        card.classList.add('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.chinese);
        content.innerHTML = `
            <div style="color: #2E7D32; word-break: break-word;">
                ${word.chinese}
            </div>
        `;
    }
    
    appState.isCardFlipped = !appState.isCardFlipped;
}

async function markTrainingWord(status) {
    const word = appState.trainingWords[appState.currentWordIndex];
    
    try {
        const { error } = await dbClient
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', appState.currentUser)
            .eq('word_id', word.word_id || word.id);
        
        if (error) throw error;
        
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        
        const globalIndex = appState.userWords.findIndex(w => 
            w.word_id === word.word_id || w.id === word.id
        );
        if (globalIndex !== -1) {
            appState.userWords[globalIndex] = { ...appState.userWords[globalIndex], ...word };
        }
        
        localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, 
            (parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0) + 1);
        
        const statusText = {
            'mastered': 'âœ… å·²æŒæ¡',
            'learning': 'ğŸ”„ ç†Ÿæ‚‰',
            'new': 'ğŸ“ æ²¡å°è±¡'
        }[status];
        
        showAlert(`${statusText}: ${word.english}`, 'success');
        
        setTimeout(() => {
            appState.currentWordIndex++;
            appState.isCardFlipped = false;
            
            if (appState.currentWordIndex < appState.trainingWords.length) {
                showTrainingScreenSimple();
            } else {
                finishTraining();
            }
        }, 800);
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

function skipTrainingWord() {
    appState.currentWordIndex++;
    appState.isCardFlipped = false;
    
    if (appState.currentWordIndex < appState.trainingWords.length) {
        showTrainingScreenSimple();
    } else {
        finishTraining();
    }
}

function saveTrainingProgress() {
    if (appState.trainingWords.length === 0) return;
    
    const progress = {
        date: new Date().toDateString(),
        index: appState.currentWordIndex,
        total: appState.trainingWords.length,
        words: appState.trainingWords.map(w => w.id || w.word_id)
    };
    
    localStorage.setItem(`kathy_all_training_${appState.currentUser}`, JSON.stringify(progress));
    showAlert('è®­ç»ƒè¿›åº¦å·²ä¿å­˜ï¼', 'success');
}

function finishTraining() {
    const total = appState.trainingWords.length;
    const mastered = appState.trainingWords.filter(w => w.status === 'mastered').length;
    const learning = appState.trainingWords.filter(w => w.status === 'learning').length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    localStorage.removeItem(`kathy_all_training_${appState.currentUser}`);
    
    const todayProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‰</div>
            <h3 style="color: #333; margin-bottom: 15px;">è®­ç»ƒå®Œæˆï¼</h3>
            <div class="stats-card" style="max-width: 400px; margin: 0 auto;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">è®­ç»ƒå•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">ç†Ÿæ‚‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progress}%</div>
                        <div class="label">æŒæ¡ç‡</div>
                    </div>
                </div>
            </div>
            ${todayProgress >= 10 ? 
                '<div class="celebration-banner" style="margin: 20px auto; max-width: 400px;">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : ''}
            <div style="margin-top: 30px;">
                <button class="btn hover-lift" onclick="startDailyTraining()" style="margin: 10px;">
                    ç»§ç»­ä»Šæ—¥è®­ç»ƒ
                </button>
                <button class="btn btn-red hover-lift" onclick="showStudentDashboard()" style="margin: 10px;">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
}

function cancelTraining() {
    if (confirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„è®­ç»ƒè¿›åº¦å¯ä»¥ç¨åç»§ç»­ã€‚')) {
        saveTrainingProgress();
        showStudentDashboard();
    }
}

// ========== æ‰“å¡ç³»ç»Ÿ ==========
async function loadClockInStatus() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const { data: todayRecord, error } = await dbClient
            .from('clock_in_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('clock_in_date', today)
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error('åŠ è½½æ‰“å¡çŠ¶æ€é”™è¯¯:', error);
            return;
        }
        
        const clockInStatus = document.getElementById('clock-in-status');
        if (clockInStatus) {
            if (todayRecord?.is_clock_in) {
                clockInStatus.innerHTML = '<span>âœ…</span><span>ä»Šæ—¥å·²æ‰“å¡</span>';
                clockInStatus.style.background = '#4CAF50';
            } else {
                clockInStatus.innerHTML = '<span>ğŸ“…</span><span>ä»Šæ—¥æœªæ‰“å¡</span>';
                clockInStatus.style.background = '#FF9800';
            }
        }
        
        await loadConsecutiveDays();
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡çŠ¶æ€é”™è¯¯:', error);
    }
}

async function loadConsecutiveDays() {
    try {
        const { data: records, error } = await dbClient
            .from('clock_in_records')
            .select('clock_in_date')
            .eq('student_id', appState.currentUser)
            .eq('is_clock_in', true)
            .order('clock_in_date', { ascending: false });
        
        if (error) throw error;
        
        let currentStreak = 0;
        
        if (records && records.length > 0) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const hasToday = records.some(r => r.clock_in_date === todayStr);
            
            if (hasToday) {
                currentStreak = 1;
                let expectedDate = new Date(today);
                
                for (let i = 1; i < records.length; i++) {
                    expectedDate.setDate(expectedDate.getDate() - 1);
                    const expectedStr = expectedDate.toISOString().split('T')[0];
                    
                    if (records[i]?.clock_in_date === expectedStr) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
        }
        
        const consecutiveDaysEl = document.getElementById('consecutive-days');
        if (consecutiveDaysEl) {
            consecutiveDaysEl.textContent = currentStreak;
        }
        
    } catch (error) {
        console.error('è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°é”™è¯¯:', error);
    }
}

async function dailyClockIn() {
    const today = new Date().toISOString().split('T')[0];
    
    try {
        const { data: existingRecord, error: checkError } = await dbClient
            .from('clock_in_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('clock_in_date', today)
            .single();
        
        if (existingRecord?.is_clock_in) {
            showAlert('ä»Šå¤©å·²ç»æ‰“è¿‡å¡äº†ï¼', 'info');
            return;
        }
        
        if (checkError && checkError.code !== 'PGRST116') {
            throw checkError;
        }
        
        if (existingRecord) {
            const { error: updateError } = await dbClient
                .from('clock_in_records')
                .update({
                    is_clock_in: true,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingRecord.id);
            
            if (updateError) throw updateError;
        } else {
            const { error: insertError } = await dbClient
                .from('clock_in_records')
                .insert([{
                    student_id: appState.currentUser,
                    clock_in_date: today,
                    is_clock_in: true
                }]);
            
            if (insertError) throw insertError;
        }
        
        showAlert('âœ… æ‰“å¡æˆåŠŸï¼', 'success');
        loadClockInStatus();
        
    } catch (error) {
        console.error('æ‰“å¡é”™è¯¯:', error);
        showAlert('æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

function showClockInStats() {
    showScreen('clockin-stats-screen');
    loadClockInStats();
}

async function loadClockInStats() {
    const content = document.getElementById('clockin-stats-content');
    if (!content) return;
    
    showLoading('æ­£åœ¨åŠ è½½æ‰“å¡ç»Ÿè®¡...');
    
    try {
        const { data: records, error } = await dbClient
            .from('clock_in_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('is_clock_in', true)
            .order('clock_in_date', { ascending: false });
        
        if (error) throw error;
        
        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;
        
        if (records && records.length > 0) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const hasToday = records.some(r => r.clock_in_date === todayStr);
            
            // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
            if (hasToday) {
                currentStreak = 1;
                let expectedDate = new Date(today);
                
                for (let i = 1; i < records.length; i++) {
                    expectedDate.setDate(expectedDate.getDate() - 1);
                    const expectedStr = expectedDate.toISOString().split('T')[0];
                    
                    if (records[i]?.clock_in_date === expectedStr) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            // è®¡ç®—æœ€é•¿è¿ç»­å¤©æ•°
            for (let i = 0; i < records.length - 1; i++) {
                const currentDate = new Date(records[i].clock_in_date);
                const nextDate = new Date(records[i + 1].clock_in_date);
                const diffDays = Math.floor((currentDate - nextDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }
            
            longestStreak = longestStreak + 1;
        }
        
        content.innerHTML = `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“Š æ‰“å¡ç»Ÿè®¡</h3>
                <div class="card-grid">
                    <div class="stat-card hover-lift">
                        <div class="number">${currentStreak}</div>
                        <div class="label">å½“å‰è¿ç»­</div>
                    </div>
                    <div class="stat-card hover-lift">
                        <div class="number">${longestStreak}</div>
                        <div class="label">æœ€é•¿è¿ç»­</div>
                    </div>
                    <div class="stat-card hover-lift">
                        <div class="number">${records?.length || 0}</div>
                        <div class="label">æ€»æ‰“å¡å¤©æ•°</div>
                    </div>
                </div>
            </div>
            
            ${records && records.length > 0 ? `
                <div class="stats-card" style="margin-top: 20px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ“… æœ€è¿‘æ‰“å¡è®°å½•</h4>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.slice(0, 30).map(record => `
                                    <tr>
                                        <td>${record.clock_in_date}</td>
                                        <td style="color: #4CAF50; font-weight: bold;">âœ… å·²æ‰“å¡</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : ''}
        `;
        
        hideLoading();
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡ç»Ÿè®¡é”™è¯¯:', error);
        hideLoading();
        content.innerHTML = `
            <div class="message-box message-error">
                <h4 style="margin-bottom: 10px;">âŒ åŠ è½½å¤±è´¥</h4>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// ========== å•è¯åˆ†ç±»æŸ¥çœ‹ ==========
function showTodayWords() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayWords = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        return;
    }
    
    showWordListPage('ğŸ“… ä»Šæ—¥å·²å­¦å•è¯', todayWords);
}

function showTodayMasteredWords() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayMastered = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today && w.status === 'mastered'
    );
    
    if (todayMastered.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰æŒæ¡ä»»ä½•å•è¯', 'info');
        return;
    }
    
    showWordListPage('âœ… ä»Šæ—¥å·²æŒæ¡å•è¯', todayMastered);
}

function showMasteredWords() {
    const masteredWords = appState.userWords.filter(w => w.status === 'mastered');
    
    if (masteredWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å·²æŒæ¡çš„å•è¯', 'info');
        return;
    }
    
    showWordListPage('âœ… å·²æŒæ¡å•è¯', masteredWords);
}

function showLearningWords() {
    const learningWords = appState.userWords.filter(w => w.status === 'learning');
    
    if (learningWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰ç†Ÿæ‚‰çš„å•è¯', 'info');
        return;
    }
    
    showWordListPage('ğŸ”„ ç†Ÿæ‚‰å•è¯', learningWords);
}

function showAllLearnedWords() {
    const learnedWords = appState.userWords.filter(w => w.last_reviewed);
    
    if (learnedWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å·²å­¦ä¹ çš„å•è¯', 'info');
        return;
    }
    
    showWordListPage('ğŸ“š æ‰€æœ‰å·²å­¦ä¹ å•è¯', learnedWords);
}

function showUnlearnedWords() {
    const unlearnedWords = appState.userWords.filter(w => 
        w.status === 'new' && !w.last_reviewed
    );
    
    if (unlearnedWords.length === 0) {
        showAlert('æ‰€æœ‰å•è¯éƒ½å·²å­¦ä¹ è¿‡', 'info');
        return;
    }
    
    showWordListPage('ğŸ“š æœªå­¦ä¹ å•è¯', unlearnedWords);
}

function showWordListPage(title, words) {
    showScreen('word-categories-screen');
    
    const content = document.getElementById('category-words-content');
    if (!content) return;
    
    words.sort((a, b) => {
        const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
        const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
        return bDate - aDate;
    });
    
    content.innerHTML = `
        <div class="stats-card">
            <h3 style="color: #333; margin-bottom: 10px;">${title}</h3>
            <p style="color: #666; margin-bottom: 20px;">å…± ${words.length} ä¸ªå•è¯</p>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            ${title.includes('æœªå­¦ä¹ ') ? '' : '<th>æœ€åå¤ä¹ </th><th>å¤ä¹ æ¬¡æ•°</th>'}
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${words.map(word => {
                            const lastReview = word.last_reviewed ? 
                                new Date(word.last_reviewed).toLocaleString('zh-CN') : 'ä»æœª';
                            
                            return `
                                <tr>
                                    <td><strong>${word.english}</strong></td>
                                    <td>${word.chinese}</td>
                                    ${title.includes('æœªå­¦ä¹ ') ? '' : 
                                        `<td>${lastReview}</td>
                                         <td>${word.review_count || 0}</td>`}
                                    <td>
                                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                                onclick="practiceSingleWord('${word.english.replace(/'/g, "\\'")}', '${word.chinese.replace(/'/g, "\\'")}')">
                                            ${title.includes('æœªå­¦ä¹ ') ? 'å¼€å§‹å­¦ä¹ ' : 'ç»ƒä¹ '}
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                ${title.includes('ä»Šæ—¥å·²å­¦') ? 
                    `<button class="btn hover-lift" onclick="reviewTodayWords()" style="margin-right: 10px;">
                        ğŸ”„ å¤ä¹ è¿™äº›å•è¯
                    </button>` : ''}
                ${title.includes('æœªå­¦ä¹ ') ? 
                    `<button class="btn hover-lift" onclick="learnUnlearnedWords()" style="margin-right: 10px;">
                        ğŸ“š å­¦ä¹ è¿™äº›å•è¯
                    </button>` : ''}
                <button class="btn hover-lift" onclick="showStudentDashboard()">
                    ğŸ”™ è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
}

function practiceSingleWord(english, chinese) {
    appState.trainingWords = [{ english, chinese, status: 'new' }];
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    startTrainingSession();
}

function reviewTodayWords() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayWords = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        return;
    }
    
    appState.trainingWords = [...todayWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function learnUnlearnedWords() {
    const unlearnedWords = appState.userWords.filter(w => 
        w.status === 'new' && !w.last_reviewed
    );
    
    if (unlearnedWords.length === 0) {
        showAlert('æ²¡æœ‰æœªå­¦ä¹ çš„å•è¯', 'info');
        return;
    }
    
    appState.trainingWords = [...unlearnedWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}

async function loadTeacherDashboard() {
    showLoading('æ­£åœ¨åŠ è½½æ•™å¸ˆé¢æ¿...');
    
    try {
        // è·å–ç»Ÿè®¡ä¿¡æ¯
        let wordsCount = 0;
        let studentsCount = 0;
        let masteredCount = 0;
        let activeStudents = 0;
        
        try {
            // å•è¯æ€»æ•°
            const { count, error: wordsError } = await dbClient
                .from('words')
                .select('*', { count: 'exact', head: true })
                .eq('teacher_id', appState.teacherId);
            
            if (!wordsError) wordsCount = count || 0;
        } catch (e) {
            console.log('è·å–å•è¯æ€»æ•°é”™è¯¯:', e);
        }
        
        try {
            // å­¦ç”Ÿæ€»æ•°
            const { count: studentCount, error: studentsError } = await dbClient
                .from('users')
                .select('*', { count: 'exact', head: true })
                .eq('is_teacher', false);
            
            if (!studentsError) studentsCount = studentCount || 0;
        } catch (e) {
            console.log('è·å–å­¦ç”Ÿæ€»æ•°é”™è¯¯:', e);
        }
        
        try {
            // å·²æŒæ¡å•è¯æ•°
            const { count: masteredWordCount, error: masteredError } = await dbClient
                .from('study_records')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'mastered');
            
            if (!masteredError) masteredCount = masteredWordCount || 0;
        } catch (e) {
            console.log('è·å–å·²æŒæ¡å•è¯æ•°é”™è¯¯:', e);
        }
        
        try {
            // æ´»è·ƒå­¦ç”Ÿï¼ˆæœ€è¿‘7å¤©æœ‰å­¦ä¹ è®°å½•ï¼‰
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const { data: activeData, error: activeError } = await dbClient
                .from('study_records')
                .select('student_id')
                .gte('last_reviewed', sevenDaysAgo.toISOString());
            
            if (!activeError && activeData) {
                const uniqueStudents = new Set(activeData.map(r => r.student_id));
                activeStudents = uniqueStudents.size;
            }
        } catch (e) {
            console.log('è·å–æ´»è·ƒå­¦ç”Ÿé”™è¯¯:', e);
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°å­—
        document.getElementById('total-words').textContent = wordsCount;
        document.getElementById('total-students').textContent = studentsCount;
        document.getElementById('mastered-words').textContent = masteredCount;
        document.getElementById('active-students').textContent = activeStudents;
        
        // æ›´æ–°å†…å®¹
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">âœ¨ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn hover-lift" onclick="showUploadWordsPage()" style="padding: 12px 24px;">
                        <span>ğŸ“¤</span>
                        <span>å¿«é€Ÿä¸Šä¼ </span>
                    </button>
                    <button class="btn btn-blue hover-lift" onclick="quickStats()" style="padding: 12px 24px;">
                        <span>ğŸ“ˆ</span>
                        <span>ä»Šæ—¥æ•°æ®</span>
                    </button>
                    <button class="btn hover-lift" onclick="showStudentActivity()" style="padding: 12px 24px;">
                        <span>ğŸ‘€</span>
                        <span>å­¦ç”Ÿæ´»è·ƒ</span>
                    </button>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ç³»ç»Ÿæç¤º</h4>
                    <p style="color: #666; margin: 5px 0;">â€¢ å·²ä¸Šä¼  ${wordsCount} ä¸ªå•è¯</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å…±æœ‰ ${studentsCount} åå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ æœ€è¿‘7å¤© ${activeStudents} åæ´»è·ƒå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å­¦ç”Ÿå…±æŒæ¡ ${masteredCount} ä¸ªå•è¯</p>
                </div>
            </div>
        `;
        
        hideLoading();
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        hideLoading();
        document.getElementById('teacher-content').innerHTML = 
            '<div class="message-box message-error"><p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p></div>';
    }
}

// ç”±äºä»£ç è¿‡é•¿ï¼Œè¿™é‡Œåªå±•ç¤ºäº†æ ¸å¿ƒä¼˜åŒ–éƒ¨åˆ†ã€‚å®Œæ•´çš„åŠŸèƒ½é¡µé¢ï¼ˆæ•™å¸ˆä¸Šä¼ ã€åˆ†ç»„ç®¡ç†ã€å­¦ç”Ÿåˆ—è¡¨ç­‰ï¼‰
// éœ€è¦æ ¹æ®åŸå§‹ä»£ç è¿›è¡Œç±»ä¼¼çš„ä¼˜åŒ–ï¼Œä½†é™äºç¯‡å¹…æ— æ³•åœ¨æ­¤å…¨éƒ¨å±•ç¤ºã€‚

// åˆå§‹åŒ–å‡½æ•°
async function initializeApp() {
    console.log('ğŸš€ Kathyå•è¯è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    window.addEventListener('online', () => {
        document.getElementById('offline-banner').style.display = 'none';
        showAlert('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
    });
    
    window.addEventListener('offline', () => {
        document.getElementById('offline-banner').style.display = 'block';
        showAlert('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'warning');
    });
    
    // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        showLoading('æ­£åœ¨æ¢å¤ä¸Šæ¬¡ç™»å½•...', 'è¯·ç¨å€™');
        
        setTimeout(async () => {
            appState.currentUser = savedUser;
            appState.isTeacher = (savedRole === 'teacher');
            appState.userId = savedUser;
            
            try {
                const { error } = await dbClient.auth.getSession();
                if (error) {
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥');
                }
                
                showAlert(`âœ… æ¬¢è¿å›æ¥ ${savedUser}ï¼`, 'success');
                
                setTimeout(() => {
                    hideLoading();
                    if (appState.isTeacher) {
                        showTeacherDashboard();
                    } else {
                        showStudentDashboard();
                    }
                }, 500);
                
            } catch (error) {
                hideLoading();
                showAlert(`è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
                localStorage.removeItem('kathy_current_user');
                localStorage.removeItem('kathy_user_role');
            }
        }, 1000);
    } else {
        // æ–°ç”¨æˆ·ï¼Œæµ‹è¯•æ•°æ®åº“è¿æ¥
        setTimeout(() => {
            testDatabase();
        }, 500);
    }
    
    // æ·»åŠ Enteré”®ç™»å½•æ”¯æŒ
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
}

// å¯åŠ¨åº”ç”¨
window.addEventListener('DOMContentLoaded', initializeApp);

// å¯¼å‡ºå¿…è¦å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.testDatabase = testDatabase;
window.showStudentDashboard = showStudentDashboard;
window.showTeacherDashboard = showTeacherDashboard;
window.showTrainingOptions = showTrainingOptions;
window.startAllWordsTraining = startAllWordsTraining;
window.startDailyTraining = startDailyTraining;
window.startReviewTraining = startReviewTraining;
window.manualSyncWords = manualSyncWords;
window.dailyClockIn = dailyClockIn;
window.showClockInStats = showClockInStats;
window.showTodayWords = showTodayWords;
window.showTodayMasteredWords = showTodayMasteredWords;
window.showMasteredWords = showMasteredWords;
window.showLearningWords = showLearningWords;
window.showAllLearnedWords = showAllLearnedWords;
window.showUnlearnedWords = showUnlearnedWords;
window.practiceSingleWord = practiceSingleWord;
window.reviewTodayWords = reviewTodayWords;
window.learnUnlearnedWords = learnUnlearnedWords;
window.flipTrainingCard = flipTrainingCard;
window.markTrainingWord = markTrainingWord;
window.skipTrainingWord = skipTrainingWord;
window.saveTrainingProgress = saveTrainingProgress;
window.cancelTraining = cancelTraining;
window.startNewDailyTraining = startNewDailyTraining;
window.continueReviewTraining = continueReviewTraining;
    </script>
</body>
</html>
