<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - åœ¨çº¿ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        
        input[type="text"], textarea, input[type="password"] { width: 100%; max-width: 400px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        .word-card { background: white; border: 4px solid #4CAF50; border-radius: 20px; height: 280px; display: flex; align-items: center; justify-content: center; margin: 30px auto; cursor: pointer; font-size: 2.8em; font-weight: bold; transition: all 0.3s; max-width: 600px; }
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .status-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .status-loading { background: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; }
        .status-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .status-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        
        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { height: 220px; font-size: 2.2em; margin: 20px 10px; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">æ•™å¸ˆç«¯ç®¡ç†é¢æ¿</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">æ•™å¸ˆä¸Šä¼ å•è¯ï¼Œå­¦ç”Ÿåœ¨çº¿è®­ç»ƒ</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="login()">
                                <span>ğŸ”‘ ç™»å½•</span>
                            </button>
                            <button class="btn btn-blue" onclick="studentRegister()">
                                <span>ğŸ“ å­¦ç”Ÿæ³¨å†Œ</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="login-status" class="status-box status-loading">
                        æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ’¬ ç³»ç»Ÿè¯´æ˜</h3>
                        <p style="color: #555; margin: 10px 0;">â€¢ æ•™å¸ˆè´¦å·ï¼škathy151 (å¯†ç ï¼š123456)</p>
                        <p style="color: #555; margin: 10px 0;">â€¢ å­¦ç”Ÿè¯·ç”¨è‹±æ–‡åæ³¨å†Œ</p>
                        <p style="color: #555; margin: 10px 0;">â€¢ æ•™å¸ˆä¸Šä¼ å•è¯ï¼Œå­¦ç”Ÿåœ¨ä»»ä½•è®¾å¤‡ç™»å½•å­¦ä¹ </p>
                        <p style="color: #555; margin: 10px 0;">â€¢ æ•™å¸ˆå¯æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿå­¦ä¹ è¿›åº¦</p>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»èœå• -->
            <div id="teacher-menu" class="screen">
                <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h2>
                
                <div class="stats-card">
                    <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿç»Ÿè®¡</h3>
                    <div id="teacher-stats">
                        æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-purple" onclick="showUploadWords()">
                            <span>ğŸ“ ä¸Šä¼ å•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="showAllStudents()">
                            <span>ğŸ‘¥ æŸ¥çœ‹å­¦ç”Ÿ</span>
                        </button>
                        <button class="btn" onclick="showWordManagement()">
                            <span>ğŸ“– å•è¯ç®¡ç†</span>
                        </button>
                        <button class="btn btn-gold" onclick="showStudentProgress()">
                            <span>ğŸ“Š å­¦ä¹ è¿›åº¦</span>
                        </button>
                        <button class="btn" onclick="showShareLink()">
                            <span>ğŸ”— åˆ†äº«é“¾æ¥</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="logout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»èœå• -->
            <div id="student-menu" class="screen">
                <h2 id="student-welcome" style="text-align: center; margin-bottom: 30px;">ğŸ“ æ¬¢è¿ï¼Œå­¦ç”Ÿï¼</h2>
                
                <div class="stats-card">
                    <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                    <div id="student-stats">
                        æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn" onclick="startTraining()">
                            <span>ğŸ¯ å¼€å§‹è®­ç»ƒ</span>
                        </button>
                        <button class="btn btn-blue" onclick="showMyWords()">
                            <span>ğŸ“– æˆ‘çš„å•è¯æœ¬</span>
                        </button>
                        <button class="btn" onclick="showReviewWords()">
                            <span>ğŸ”„ å¤ä¹ å¼±é¡¹</span>
                        </button>
                        <button class="btn btn-gold" onclick="showAchievements()">
                            <span>ğŸ† å­¦ä¹ æˆå°±</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="logout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ä¸Šä¼ å•è¯ -->
            <div id="upload-words-screen" class="screen">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ ä¸Šä¼ å•è¯ç»™å­¦ç”Ÿ</h2>
                    
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <p><strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                        <p>â€¢ æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼šè‹±æ–‡ ä¸­æ–‡</p>
                        <p>â€¢ ç¤ºä¾‹ï¼šhello ä½ å¥½ï¼Œworld ä¸–ç•Œ</p>
                        <p>â€¢ æ”¯æŒçŸ­è¯­ï¼šå¦‚ "good morning" æ—©ä¸Šå¥½</p>
                        <p>â€¢ ä¸Šä¼ çš„å•è¯ä¼šè‡ªåŠ¨åŒæ­¥ç»™æ‰€æœ‰å­¦ç”Ÿ</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <textarea id="word-input" placeholder="è¾“å…¥å•è¯åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼š
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
"good morning" æ—©ä¸Šå¥½
"thank you" è°¢è°¢ä½ "></textarea>
                    </div>
                    
                    <div id="upload-preview" style="display: none; margin-bottom: 25px;">
                        <h3>ğŸ‘ï¸ é¢„è§ˆï¼ˆ<span id="preview-count">0</span> ä¸ªå•è¯ï¼‰</h3>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <table style="width: 100%;">
                                <thead><tr><th>è‹±æ–‡</th><th>ä¸­æ–‡</th></tr></thead>
                                <tbody id="preview-table"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="btn" onclick="previewWords()">
                            <span>ğŸ‘ï¸ é¢„è§ˆå•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="uploadWords()">
                            <span>ğŸ“¤ ä¸Šä¼ åˆ°ç³»ç»Ÿ</span>
                        </button>
                        <button class="btn" onclick="loadExample()">
                            <span>ğŸ“š åŠ è½½ç¤ºä¾‹</span>
                        </button>
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                    
                    <div id="upload-result" class="status-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- å•è¯è®­ç»ƒ -->
            <div id="train-screen" class="screen">
                <div style="text-align: center;">
                    <h2 style="margin-bottom: 10px;">ğŸ¯ å•è¯è®­ç»ƒ</h2>
                    <p style="color: #666; margin-bottom: 25px;">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
                    
                    <div class="progress-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span id="progress-text" style="color: #666;">è¿›åº¦: 0/0</span>
                            <span id="mode-text" style="color: #2196F3; font-weight: bold;">è‹±æ–‡ â†’ ä¸­æ–‡</span>
                        </div>
                        <div class="progress-bar">
                            <div id="train-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="word-card" class="word-card" onclick="flipCard()">
                        <div id="card-front">ç‚¹å‡»å¼€å§‹è®­ç»ƒ</div>
                        <div id="card-back" style="display:none; color:#2E7D32;"></div>
                    </div>
                    
                    <div style="margin: 35px 0;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                            <button class="btn" onclick="markWord('mastered')">
                                <span>âœ… å·²æŒæ¡</span>
                            </button>
                            <button class="btn btn-blue" onclick="markWord('learning')">
                                <span>ğŸ”„ å­¦ä¹ ä¸­</span>
                            </button>
                            <button class="btn btn-red" onclick="markWord('reviewing')">
                                <span>âŒ éœ€å¤ä¹ </span>
                            </button>
                            <button class="btn" onclick="skipWord()">
                                <span>â­ï¸ è·³è¿‡</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-red" onclick="endTraining()">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                        <button class="btn" onclick="showStudentMenu()">
                            <span>ğŸ“‹ è¿”å›èœå•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æŸ¥çœ‹å­¦ç”Ÿ -->
            <div id="students-screen" class="screen">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘¥ æ‰€æœ‰å­¦ç”Ÿ</h2>
                    
                    <div id="students-list">
                        æ­£åœ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨...
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- å­¦ä¹ è¿›åº¦ -->
            <div id="progress-screen" class="screen">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“Š å­¦ç”Ÿå­¦ä¹ è¿›åº¦</h2>
                    
                    <div id="progress-list">
                        æ­£åœ¨åŠ è½½å­¦ä¹ è¿›åº¦...
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- åˆ†äº«é“¾æ¥ -->
            <div id="share-screen" class="screen">
                <div style="max-width: 700px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ”— åˆ†äº«ç»™å­¦ç”Ÿ</h2>
                    
                    <div class="stats-card">
                        <h3>å­¦ç”Ÿè®¿é—®é“¾æ¥ï¼š</h3>
                        <div style="background: #f1f3f4; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <input type="text" id="share-url" value="https://kathy-words.vercel.app" readonly 
                                   style="width: 100%; padding: 10px; border: none; background: transparent; font-size: 16px;">
                        </div>
                        <button class="btn" onclick="copyShareLink()">
                            <span>ğŸ“‹ å¤åˆ¶é“¾æ¥</span>
                        </button>
                        
                        <h3 style="margin-top: 40px;">ğŸ“± å­¦ç”Ÿä½¿ç”¨è¯´æ˜ï¼š</h3>
                        <ul style="text-align: left; margin: 20px 0; padding-left: 20px;">
                            <li style="margin: 10px 0;">å­¦ç”Ÿè®¿é—®ä¸Šé¢çš„é“¾æ¥</li>
                            <li style="margin: 10px 0;">ç‚¹å‡»"å­¦ç”Ÿæ³¨å†Œ"æŒ‰é’®</li>
                            <li style="margin: 10px 0;">è¾“å…¥è‹±æ–‡åæ³¨å†Œè´¦å·</li>
                            <li style="margin: 10px 0;">ç™»å½•åå³å¯å¼€å§‹å­¦ä¹ æ‚¨ä¸Šä¼ çš„å•è¯</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== SUPABASE é…ç½® ==========
        const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ========== å…¨å±€é…ç½® ==========
        const TEACHER_ID = 'kathy151';
        
        let appState = {
            currentUser: null,
            isTeacher: false,
            userId: null,
            userWords: [],      // å­¦ç”Ÿçš„å•è¯åˆ—è¡¨
            teacherWords: [],   // æ•™å¸ˆä¸Šä¼ çš„æ‰€æœ‰å•è¯
            trainingWords: [],  // å½“å‰è®­ç»ƒçš„å•è¯
            currentWordIndex: 0,
            cardFlipped: false
        };
        
        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ å•è¯è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
            
            const statusDiv = document.getElementById('login-status');
            statusDiv.className = 'status-box status-loading';
            statusDiv.textContent = 'æ­£åœ¨è¿æ¥ç³»ç»Ÿ...';
            
            try {
                // æµ‹è¯•è¿æ¥
                const { error } = await supabase.from('users').select('count').limit(1);
                
                if (error) {
                    statusDiv.className = 'status-box status-error';
                    statusDiv.innerHTML = 'âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•<br>å¦‚æœæŒç»­å¤±è´¥ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ';
                } else {
                    statusDiv.className = 'status-box status-success';
                    statusDiv.textContent = 'âœ… ç³»ç»Ÿè¿æ¥æˆåŠŸï¼è¯·ç™»å½•';
                    
                    // æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
                    const savedUser = localStorage.getItem('current_user');
                    const savedRole = localStorage.getItem('user_role');
                    
                    if (savedUser) {
                        appState.currentUser = savedUser;
                        appState.isTeacher = (savedRole === 'teacher');
                        appState.userId = savedUser;
                        
                        if (appState.isTeacher) {
                            showTeacherMenu();
                            loadTeacherStats();
                        } else {
                            document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${savedUser}ï¼`;
                            showStudentMenu();
                            loadStudentStats();
                        }
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                statusDiv.className = 'status-box status-error';
                statusDiv.textContent = 'âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥';
            }
        });
        
        // ========== ç™»å½•/æ³¨å†Œ ==========
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showLoginStatus('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }
            
            showLoginStatus('æ­£åœ¨ç™»å½•...', 'loading');
            
            try {
                // æ•™å¸ˆç™»å½•ï¼ˆç®€åŒ–ç‰ˆï¼‰
                if (username === 'kathy151') {
                    if (password === '123456') {
                        // æ£€æŸ¥æ•™å¸ˆè´¦æˆ·æ˜¯å¦å­˜åœ¨
                        const { data: teacher, error } = await supabase
                            .from('users')
                            .select('*')
                            .eq('username', TEACHER_ID)
                            .single();
                        
                        if (error || !teacher) {
                            // åˆ›å»ºæ•™å¸ˆè´¦æˆ·
                            await supabase.from('users').insert([{
                                username: TEACHER_ID,
                                is_teacher: true
                            }]);
                        }
                        
                        appState.currentUser = TEACHER_ID;
                        appState.isTeacher = true;
                        appState.userId = TEACHER_ID;
                        
                        localStorage.setItem('current_user', TEACHER_ID);
                        localStorage.setItem('user_role', 'teacher');
                        
                        showLoginStatus('ç™»å½•æˆåŠŸï¼', 'success');
                        setTimeout(() => {
                            showTeacherMenu();
                            loadTeacherStats();
                        }, 500);
                        
                        return;
                    } else {
                        showLoginStatus('å¯†ç é”™è¯¯', 'error');
                        return;
                    }
                }
                
                // å­¦ç”Ÿç™»å½•
                const { data: student, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (error || !student) {
                    showLoginStatus('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ', 'error');
                    return;
                }
                
                if (student.is_teacher) {
                    showLoginStatus('è¯·ä½¿ç”¨æ•™å¸ˆå¯†ç ç™»å½•', 'error');
                    return;
                }
                
                // æ›´æ–°æœ€åç™»å½•æ—¶é—´
                await supabase
                    .from('users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('username', username);
                
                appState.currentUser = username;
                appState.isTeacher = false;
                appState.userId = username;
                
                localStorage.setItem('current_user', username);
                localStorage.setItem('user_role', 'student');
                
                document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                showLoginStatus('ç™»å½•æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    showStudentMenu();
                    loadStudentStats();
                }, 500);
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showLoginStatus('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function studentRegister() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showLoginStatus('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            if (username.length < 2 || username.length > 20) {
                showLoginStatus('ç”¨æˆ·åé•¿åº¦åº”ä¸º2-20ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            if (username === 'kathy151') {
                showLoginStatus('è¯¥ç”¨æˆ·åä¸å¯ç”¨', 'error');
                return;
            }
            
            showLoginStatus('æ­£åœ¨æ³¨å†Œ...', 'loading');
            
            try {
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (existingUser) {
                    showLoginStatus('ç”¨æˆ·åå·²å­˜åœ¨', 'error');
                    return;
                }
                
                // åˆ›å»ºå­¦ç”Ÿè´¦æˆ·
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{
                        username: username,
                        is_teacher: false,
                        teacher_id: TEACHER_ID
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // åŒæ­¥æ•™å¸ˆå•è¯ç»™å­¦ç”Ÿ
                await syncTeacherWordsToStudent(username);
                
                appState.currentUser = username;
                appState.isTeacher = false;
                appState.userId = username;
                
                localStorage.setItem('current_user', username);
                localStorage.setItem('user_role', 'student');
                
                document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                showLoginStatus('æ³¨å†ŒæˆåŠŸï¼', 'success');
                setTimeout(() => {
                    showStudentMenu();
                    loadStudentStats();
                }, 500);
                
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showLoginStatus('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function syncTeacherWordsToStudent(studentId) {
            try {
                // è·å–æ‰€æœ‰æ•™å¸ˆå•è¯
                const { data: teacherWords } = await supabase
                    .from('teacher_words')
                    .select('*')
                    .eq('teacher_id', TEACHER_ID);
                
                if (!teacherWords || teacherWords.length === 0) return;
                
                // ä¸ºæ¯ä¸ªå•è¯åˆ›å»ºå­¦ä¹ è®°å½•
                const progressRecords = teacherWords.map(word => ({
                    student_id: studentId,
                    word_id: word.id,
                    status: 'new'
                }));
                
                // æ‰¹é‡æ’å…¥
                await supabase.from('student_progress').insert(progressRecords);
                
            } catch (error) {
                console.error('åŒæ­¥å•è¯é”™è¯¯:', error);
            }
        }
        
        function showLoginStatus(message, type) {
            const statusDiv = document.getElementById('login-status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-box';
            
            if (type === 'loading') {
                statusDiv.classList.add('status-loading');
                statusDiv.innerHTML = `â³ ${message}`;
            } else if (type === 'success') {
                statusDiv.classList.add('status-success');
                statusDiv.innerHTML = `âœ… ${message}`;
            } else {
                statusDiv.classList.add('status-error');
                statusDiv.innerHTML = `âŒ ${message}`;
            }
        }
        
        // ========== æ•™å¸ˆåŠŸèƒ½ ==========
        function showTeacherMenu() {
            showScreen('teacher-menu');
        }
        
        async function loadTeacherStats() {
            const statsDiv = document.getElementById('teacher-stats');
            
            try {
                // è·å–å­¦ç”Ÿæ•°é‡
                const { data: students, error: studentsError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_teacher', false);
                
                // è·å–å•è¯æ•°é‡
                const { data: words, error: wordsError } = await supabase
                    .from('teacher_words')
                    .select('*')
                    .eq('teacher_id', TEACHER_ID);
                
                // è·å–å­¦ä¹ è¿›åº¦ç»Ÿè®¡
                const { data: progress, error: progressError } = await supabase
                    .from('student_progress')
                    .select('*')
                    .in('student_id', students?.map(s => s.username) || []);
                
                let mastered = 0, learning = 0, reviewing = 0;
                if (progress) {
                    progress.forEach(p => {
                        if (p.status === 'mastered') mastered++;
                        else if (p.status === 'learning') learning++;
                        else if (p.status === 'reviewing') reviewing++;
                    });
                }
                
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #2196F3; font-weight: bold;">${students?.length || 0}</div>
                            <div style="color: #666; font-size: 0.9em;">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #4CAF50; font-weight: bold;">${words?.length || 0}</div>
                            <div style="color: #666; font-size: 0.9em;">å•è¯æ€»æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #FF9800; font-weight: bold;">${mastered}</div>
                            <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡å•è¯</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #9C27B0; font-weight: bold;">${reviewing}</div>
                            <div style="color: #666; font-size: 0.9em;">éœ€å¤ä¹ å•è¯</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <p style="color: #666;">ğŸ’¡ ç³»ç»Ÿå·²å°±ç»ªï¼Œæ‚¨å¯ä»¥ï¼š</p>
                        <ul style="color: #666; margin-left: 20px; margin-top: 10px;">
                            <li>ä¸Šä¼ å•è¯ç»™å­¦ç”Ÿå­¦ä¹ </li>
                            <li>æŸ¥çœ‹å­¦ç”Ÿå­¦ä¹ è¿›åº¦</li>
                            <li>äº†è§£å­¦ç”ŸæŒæ¡æƒ…å†µ</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                console.error('åŠ è½½æ•™å¸ˆç»Ÿè®¡é”™è¯¯:', error);
                statsDiv.innerHTML = `<p style="color: red;">åŠ è½½æ•°æ®å¤±è´¥</p>`;
            }
        }
        
        function showUploadWords() {
            showScreen('upload-words-screen');
            document.getElementById('upload-result').style.display = 'none';
            document.getElementById('upload-preview').style.display = 'none';
        }
        
        function previewWords() {
            const input = document.getElementById('word-input').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            const lines = input.split('\n');
            const previewTable = document.getElementById('preview-table');
            previewTable.innerHTML = '';
            
            let validWords = 0;
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                const parts = trimmed.split(/\s+/);
                if (parts.length >= 2) {
                    const english = parts.slice(0, -1).join(' ');
                    const chinese = parts[parts.length - 1];
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${english}</strong></td>
                        <td>${chinese}</td>
                    `;
                    previewTable.appendChild(row);
                    validWords++;
                }
            });
            
            document.getElementById('preview-count').textContent = validWords;
            document.getElementById('upload-preview').style.display = 'block';
        }
        
        async function uploadWords() {
            const input = document.getElementById('word-input').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            const lines = input.split('\n');
            const wordsToUpload = [];
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                const parts = trimmed.split(/\s+/);
                if (parts.length >= 2) {
                    const english = parts.slice(0, -1).join(' ');
                    const chinese = parts[parts.length - 1];
                    
                    wordsToUpload.push({
                        teacher_id: TEACHER_ID,
                        english: english,
                        chinese: chinese
                    });
                }
            });
            
            if (wordsToUpload.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯');
                return;
            }
            
            try {
                // æ‰¹é‡æ’å…¥å•è¯
                const { data, error } = await supabase
                    .from('teacher_words')
                    .insert(wordsToUpload);
                
                if (error) throw error;
                
                // åŒæ­¥ç»™æ‰€æœ‰å­¦ç”Ÿ
                await syncNewWordsToAllStudents(wordsToUpload);
                
                const resultDiv = document.getElementById('upload-result');
                resultDiv.className = 'status-box status-success';
                resultDiv.innerHTML = `
                    âœ… æˆåŠŸä¸Šä¼  ${wordsToUpload.length} ä¸ªå•è¯ï¼<br>
                    <small>å•è¯å·²åŒæ­¥ç»™æ‰€æœ‰å­¦ç”Ÿ</small>
                `;
                resultDiv.style.display = 'block';
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('word-input').value = '';
                document.getElementById('upload-preview').style.display = 'none';
                
                // æ›´æ–°ç»Ÿè®¡
                loadTeacherStats();
                
            } catch (error) {
                console.error('ä¸Šä¼ å•è¯é”™è¯¯:', error);
                const resultDiv = document.getElementById('upload-result');
                resultDiv.className = 'status-box status-error';
                resultDiv.innerHTML = 'âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                resultDiv.style.display = 'block';
            }
        }
        
        async function syncNewWordsToAllStudents(newWords) {
            try {
                // è·å–æ‰€æœ‰å­¦ç”Ÿ
                const { data: students } = await supabase
                    .from('users')
                    .select('username')
                    .eq('is_teacher', false);
                
                if (!students || students.length === 0) return;
                
                // è·å–æ–°æ’å…¥å•è¯çš„ID
                const { data: insertedWords } = await supabase
                    .from('teacher_words')
                    .select('id')
                    .eq('teacher_id', TEACHER_ID)
                    .order('created_at', { ascending: false })
                    .limit(newWords.length);
                
                if (!insertedWords) return;
                
                // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºå­¦ä¹ è®°å½•
                const progressRecords = [];
                
                students.forEach(student => {
                    insertedWords.forEach(word => {
                        progressRecords.push({
                            student_id: student.username,
                            word_id: word.id,
                            status: 'new'
                        });
                    });
                });
                
                // æ‰¹é‡æ’å…¥
                await supabase.from('student_progress').insert(progressRecords);
                
            } catch (error) {
                console.error('åŒæ­¥æ–°å•è¯é”™è¯¯:', error);
            }
        }
        
        function loadExample() {
            document.getElementById('word-input').value = `hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
book ä¹¦
computer ç”µè„‘
"good morning" æ—©ä¸Šå¥½
"thank you" è°¢è°¢ä½ 
friend æœ‹å‹
teacher è€å¸ˆ
student å­¦ç”Ÿ`;
            previewWords();
        }
        
        async function showAllStudents() {
            showScreen('students-screen');
            
            try {
                const { data: students, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_teacher', false)
                    .order('last_login', { ascending: false });
                
                if (error) throw error;
                
                const listDiv = document.getElementById('students-list');
                
                if (!students || students.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>';
                    return;
                }
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å­¦ç”Ÿå§“å</th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                                <th>æœ€åç™»å½•</th>
                                <th>å­¦ä¹ å¤©æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                students.forEach(student => {
                    const regDate = new Date(student.created_at).toLocaleDateString('zh-CN');
                    const lastLogin = student.last_login ? 
                        new Date(student.last_login).toLocaleDateString('zh-CN') : 'ä»æœªç™»å½•';
                    
                    // è®¡ç®—å­¦ä¹ å¤©æ•°
                    const created = new Date(student.created_at);
                    const now = new Date();
                    const days = Math.floor((now - created) / (1000 * 60 * 60 * 24)) + 1;
                    
                    html += `
                        <tr>
                            <td><strong>${student.username}</strong></td>
                            <td>${regDate}</td>
                            <td>${lastLogin}</td>
                            <td>${days} å¤©</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
                document.getElementById('students-list').innerHTML = 
                    '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
            }
        }
        
        async function showStudentProgress() {
            showScreen('progress-screen');
            
            try {
                // è·å–æ‰€æœ‰å­¦ç”Ÿ
                const { data: students } = await supabase
                    .from('users')
                    .select('username')
                    .eq('is_teacher', false);
                
                if (!students || students.length === 0) {
                    document.getElementById('progress-list').innerHTML = 
                        '<p style="text-align: center;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>';
                    return;
                }
                
                // è·å–æ‰€æœ‰å•è¯
                const { data: allWords } = await supabase
                    .from('teacher_words')
                    .select('*')
                    .eq('teacher_id', TEACHER_ID);
                
                // è·å–æ‰€æœ‰å­¦ä¹ è¿›åº¦
                const { data: allProgress } = await supabase
                    .from('student_progress')
                    .select('*')
                    .in('student_id', students.map(s => s.username));
                
                let html = '';
                
                students.forEach(student => {
                    const studentProgress = allProgress?.filter(p => p.student_id === student.username) || [];
                    const mastered = studentProgress.filter(p => p.status === 'mastered').length;
                    const learning = studentProgress.filter(p => p.status === 'learning').length;
                    const reviewing = studentProgress.filter(p => p.status === 'reviewing').length;
                    const total = studentProgress.length;
                    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
                    
                    html += `
                        <div class="stats-card" style="margin-bottom: 20px;">
                            <h3>ğŸ‘¤ ${student.username}</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; color: #2196F3; font-weight: bold;">${total}</div>
                                    <div style="color: #666; font-size: 0.9em;">æ€»å•è¯</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${mastered}</div>
                                    <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; color: #FF9800; font-weight: bold;">${learning}</div>
                                    <div style="color: #666; font-size: 0.9em;">å­¦ä¹ ä¸­</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; color: #F44336; font-weight: bold;">${reviewing}</div>
                                    <div style="color: #666; font-size: 0.9em;">éœ€å¤ä¹ </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                                    <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('progress-list').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½è¿›åº¦é”™è¯¯:', error);
                document.getElementById('progress-list').innerHTML = 
                    '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
            }
        }
        
        function showShareLink() {
            showScreen('share-screen');
            const currentUrl = window.location.href;
            document.getElementById('share-url').value = currentUrl;
        }
        
        function copyShareLink() {
            const input = document.getElementById('share-url');
            input.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }
        
        // ========== å­¦ç”ŸåŠŸèƒ½ ==========
        function showStudentMenu() {
            showScreen('student-menu');
        }
        
        async function loadStudentStats() {
            const statsDiv = document.getElementById('student-stats');
            
            try {
                // è·å–å­¦ç”Ÿçš„å•è¯è¿›åº¦
                const { data: progress, error } = await supabase
                    .from('student_progress')
                    .select(`
                        *,
                        teacher_words!inner(english, chinese)
                    `)
                    .eq('student_id', appState.currentUser);
                
                if (error) throw error;
                
                const mastered = progress?.filter(p => p.status === 'mastered').length || 0;
                const learning = progress?.filter(p => p.status === 'learning').length || 0;
                const reviewing = progress?.filter(p => p.status === 'reviewing').length || 0;
                const newWords = progress?.filter(p => p.status === 'new').length || 0;
                const total = progress?.length || 0;
                const progressPercent = total > 0 ? Math.round((mastered / total) * 100) : 0;
                
                // ä¿å­˜åˆ°appState
                appState.userWords = progress?.map(p => ({
                    id: p.word_id,
                    english: p.teacher_words.english,
                    chinese: p.teacher_words.chinese,
                    status: p.status,
                    reviewCount: p.review_count,
                    lastReviewed: p.last_reviewed
                })) || [];
                
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #2196F3; font-weight: bold;">${total}</div>
                            <div style="color: #666; font-size: 0.9em;">æ€»å•è¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #4CAF50; font-weight: bold;">${mastered}</div>
                            <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #FF9800; font-weight: bold;">${learning}</div>
                            <div style="color: #666; font-size: 0.9em;">å­¦ä¹ ä¸­</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #F44336; font-weight: bold;">${reviewing}</div>
                            <div style="color: #666; font-size: 0.9em;">éœ€å¤ä¹ </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                            <span style="color: #4CAF50; font-weight: bold;">${progressPercent}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <p style="color: #666; text-align: center;">
                            ğŸ’¡ å·²å­¦ä¹  ${total} ä¸ªå•è¯ï¼Œç»§ç»­åŠ æ²¹ï¼
                        </p>
                    </div>
                `;
                
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿç»Ÿè®¡é”™è¯¯:', error);
                statsDiv.innerHTML = '<p style="color: red;">åŠ è½½æ•°æ®å¤±è´¥</p>';
            }
        }
        
        function startTraining() {
            if (appState.userWords.length === 0) {
                alert('æš‚æ—¶æ²¡æœ‰å•è¯å¯å­¦ä¹ ');
                return;
            }
            
            // å‡†å¤‡è®­ç»ƒå•è¯ï¼ˆä¼˜å…ˆå¤ä¹ å¼±é¡¹ï¼‰
            const reviewWords = appState.userWords.filter(w => w.status === 'reviewing' || w.status === 'new');
            appState.trainingWords = reviewWords.length > 0 ? reviewWords : [...appState.userWords];
            appState.trainingWords.sort(() => Math.random() - 0.5);
            appState.currentWordIndex = 0;
            appState.cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
        }
        
        function showCurrentWord() {
            if (appState.currentWordIndex >= appState.trainingWords.length) {
                endTraining();
                return;
            }
            
            const word = appState.trainingWords[appState.currentWordIndex];
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            wordCard.classList.remove('flipped');
            appState.cardFlipped = false;
            cardBack.style.display = 'none';
            
            cardFront.textContent = word.english;
            cardBack.textContent = word.chinese;
            
            const progress = ((appState.currentWordIndex + 1) / appState.trainingWords.length) * 100;
            document.getElementById('progress-text').textContent = 
                `è¿›åº¦: ${appState.currentWordIndex + 1}/${appState.trainingWords.length}`;
            document.getElementById('train-progress').style.width = `${progress}%`;
        }
        
        function flipCard() {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            if (!appState.cardFlipped) {
                cardBack.style.display = 'block';
                wordCard.classList.add('flipped');
                appState.cardFlipped = true;
            } else {
                cardBack.style.display = 'none';
                wordCard.classList.remove('flipped');
                appState.cardFlipped = false;
            }
        }
        
        async function markWord(status) {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const word = appState.trainingWords[appState.currentWordIndex];
            
            try {
                // æ›´æ–°å­¦ä¹ è¿›åº¦
                await supabase
                    .from('student_progress')
                    .update({
                        status: status,
                        review_count: (word.reviewCount || 0) + 1,
                        last_reviewed: new Date().toISOString()
                    })
                    .eq('student_id', appState.currentUser)
                    .eq('word_id', word.id);
                
                // æ›´æ–°æœ¬åœ°çŠ¶æ€
                word.status = status;
                word.reviewCount = (word.reviewCount || 0) + 1;
                word.lastReviewed = new Date().toISOString();
                
                // ä¸‹ä¸€ä¸ªå•è¯
                appState.currentWordIndex++;
                appState.cardFlipped = false;
                setTimeout(showCurrentWord, 300);
                
            } catch (error) {
                console.error('æ›´æ–°è¿›åº¦é”™è¯¯:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        }
        
        function skipWord() {
            appState.currentWordIndex++;
            appState.cardFlipped = false;
            showCurrentWord();
        }
        
        function endTraining() {
            const mastered = appState.userWords.filter(w => w.status === 'mastered').length;
            const total = appState.userWords.length;
            const score = total > 0 ? Math.round((mastered / total) * 100) : 0;
            
            let message = `ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\n`;
            message += `ğŸ“Š æœ¬æ¬¡è®­ç»ƒç»Ÿè®¡ï¼š\n`;
            message += `â€¢ å¤ä¹ å•è¯ï¼š${appState.trainingWords.length}\n`;
            message += `â€¢ æŒæ¡ç‡ï¼š${score}%\n\n`;
            
            if (score >= 80) {
                message += `ğŸŒŸ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼`;
            } else if (score >= 60) {
                message += `ğŸ’ª è¿˜ä¸é”™ï¼Œç»§ç»­åŠ æ²¹ï¼`;
            } else {
                message += `ğŸ“š éœ€è¦å¤šå¤ä¹ ï¼Œç»§ç»­åŠªåŠ›ï¼`;
            }
            
            alert(message);
            
            // é‡æ–°åŠ è½½ç»Ÿè®¡
            loadStudentStats();
            showStudentMenu();
        }
        
        // ========== é€šç”¨åŠŸèƒ½ ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }
        
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                appState.currentUser = null;
                appState.isTeacher = false;
                appState.userId = null;
                appState.userWords = [];
                localStorage.removeItem('current_user');
                localStorage.removeItem('user_role');
                showScreen('login-screen');
            }
        }
        
        // å…¶ä»–å ä½å‡½æ•°
        function showWordManagement() { alert('å•è¯ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...'); }
        function showMyWords() { alert('æˆ‘çš„å•è¯æœ¬åŠŸèƒ½å¼€å‘ä¸­...'); }
        function showReviewWords() { startTraining(); }
        function showAchievements() { alert('å­¦ä¹ æˆå°±åŠŸèƒ½å¼€å‘ä¸­...'); }
    </script>
</body>
</html>
