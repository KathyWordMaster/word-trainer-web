<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯è®­ç»ƒè¥ - å…¨çƒåŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 25px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; margin: 8px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        
        input[type="text"], textarea { width: 100%; max-width: 400px; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        textarea { height: 180px; font-family: monospace; resize: vertical; }
        
        .stats-card { background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 15px 0; border-left: 5px solid #4CAF50; }
        .word-card { background: white; border: 3px solid #4CAF50; border-radius: 15px; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; font-size: 2em; font-weight: bold; transition: all 0.3s; max-width: 500px; }
        .word-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .word-card.flipped { background: #E8F5E9; border-color: #2E7D32; }
        
        .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; background: white; border-radius: 8px; overflow: hidden; }
        .data-table th { background: #4CAF50; color: white; padding: 12px; text-align: left; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-bar { width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.6em; }
            .word-card { height: 160px; font-size: 1.6em; margin: 15px 10px; }
            .btn { padding: 10px 20px; margin: 5px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ Kathyå•è¯è®­ç»ƒè¥ - å…¨çƒåŒæ­¥ç‰ˆ</h1>
            <p style="color: #BDC3C7;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151 | ğŸ“Š å®æ—¶ç›‘æ§</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿æ¥åˆ°å…¨çƒåŒæ­¥å•è¯è®­ç»ƒè¥ï¼</h2>
                    <p style="color: #666; margin-bottom: 25px;">æ•°æ®å…¨çƒåŒæ­¥ï¼Œéšæ—¶éšåœ°å­¦ä¹ </p>
                    
                    <div style="margin: 25px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        
                        <div style="margin: 20px 0;">
                            <button class="btn" onclick="login()">
                                <span>ğŸ”‘ ç™»å½•/æ³¨å†Œ</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e8; border-radius: 8px; padding: 12px; margin: 20px auto; max-width: 400px;">
                        <p style="color: #4CAF50; margin: 0;">âœ… å·²è¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“</p>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 25px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 15px;">ğŸ’¬ è”ç³»ä¿¡æ¯</h3>
                        <div style="background: #07C160; color: white; padding: 12px 24px; border-radius: 20px; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; margin-bottom: 15px;">
                            <span>è€å¸ˆå¾®ä¿¡ï¼š</span>
                            <strong>Kathy151</strong>
                        </div>
                        <p style="color: #555; margin-top: 10px; font-size: 0.95em;">
                            ğŸŒ å…¨çƒåŒæ­¥åŠŸèƒ½ï¼šæ‰€æœ‰æ•°æ®å®æ—¶ä¿å­˜åˆ°äº‘ç«¯ï¼Œä»»ä½•è®¾å¤‡éƒ½å¯è®¿é—®
                        </p>
                    </div>
                    
                    <div id="login-status" style="display: none; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-top: 15px;"></div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»èœå• -->
            <div id="teacher-menu" class="screen">
                <h2 style="text-align: center; margin-bottom: 25px;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿ - å…¨çƒç›‘æ§</h2>
                
                <div class="stats-card">
                    <h3 style="color: #9C27B0; margin-bottom: 15px;">ğŸ“Š ç­çº§å®æ—¶ç»Ÿè®¡</h3>
                    <div id="class-stats">
                        <p>æ­£åœ¨ä»äº‘ç«¯åŠ è½½ç­çº§æ•°æ®...</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin: 25px 0;">
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ‘¥</div>
                        <h4 style="color: #1976D2;">å­¦ç”Ÿç®¡ç†</h4>
                        <button class="btn btn-blue" onclick="showAllStudents()" style="width: 100%; margin-top: 10px;">
                            <span>ç®¡ç†å­¦ç”Ÿ</span>
                        </button>
                    </div>
                    
                    <div style="background: #E8F5E9; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ“š</div>
                        <h4 style="color: #2E7D32;">å…±äº«å•è¯åº“</h4>
                        <button class="btn" onclick="showAddPublicWords()" style="width: 100%; margin-top: 10px;">
                            <span>ç®¡ç†å•è¯</span>
                        </button>
                    </div>
                    
                    <div style="background: #FFF3E0; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ“Š</div>
                        <h4 style="color: #EF6C00;">å­¦ä¹ ç›‘æ§</h4>
                        <button class="btn" onclick="showLearningMonitor()" style="width: 100%; margin-top: 10px;">
                            <span>æŸ¥çœ‹ç›‘æ§</span>
                        </button>
                    </div>
                    
                    <div style="background: #F3E5F5; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">âš™ï¸</div>
                        <h4 style="color: #7B1FA2;">ç³»ç»Ÿè®¾ç½®</h4>
                        <button class="btn btn-purple" onclick="showTeacherSettings()" style="width: 100%; margin-top: 10px;">
                            <span>ç³»ç»Ÿè®¾ç½®</span>
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-red" onclick="logout()">
                        <span>ğŸšª é€€å‡ºç™»å½•</span>
                    </button>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»èœå• -->
            <div id="student-menu" class="screen">
                <h2 id="student-welcome" style="text-align: center; margin-bottom: 25px;"></h2>
                
                <div class="stats-card">
                    <h3 style="color: #2196F3; margin-bottom: 15px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦ï¼ˆäº‘ç«¯åŒæ­¥ï¼‰</h3>
                    <div id="student-stats">
                        <p>æ­£åœ¨ä»äº‘ç«¯åŠ è½½å­¦ä¹ æ•°æ®...</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 25px 0;">
                    <div style="background: #E8F5E9; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ“</div>
                        <h4 style="color: #2E7D32;">æ·»åŠ å•è¯</h4>
                        <button class="btn" onclick="showAddWords()" style="width: 100%; margin-top: 10px;">
                            <span>æ·»åŠ å•è¯</span>
                        </button>
                    </div>
                    
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ¯</div>
                        <h4 style="color: #1976D2;">å¼€å§‹è®­ç»ƒ</h4>
                        <button class="btn btn-blue" onclick="startTraining()" style="width: 100%; margin-top: 10px;">
                            <span>å¼€å§‹è®­ç»ƒ</span>
                        </button>
                    </div>
                    
                    <div style="background: #FFF3E0; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ”„</div>
                        <h4 style="color: #EF6C00;">å¤ä¹ å¼±é¡¹</h4>
                        <button class="btn" onclick="showReviewWords()" style="width: 100%; margin-top: 10px;">
                            <span>å¤ä¹ å¼±é¡¹</span>
                        </button>
                    </div>
                    
                    <div style="background: #FCE4EC; border-radius: 10px; padding: 18px; text-align: center;">
                        <div style="font-size: 1.8em; margin-bottom: 12px;">ğŸ“–</div>
                        <h4 style="color: #C2185B;">å…±äº«åº“</h4>
                        <button class="btn btn-purple" onclick="viewSharedWords()" style="width: 100%; margin-top: 10px;">
                            <span>å…±äº«å•è¯</span>
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-red" onclick="logout()">
                        <span>ğŸšª é€€å‡ºç™»å½•</span>
                    </button>
                </div>
            </div>
            
            <!-- æ·»åŠ å•è¯ç•Œé¢ -->
            <div id="add-words-screen" class="screen">
                <div style="max-width: 700px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ æ·»åŠ å•è¯</h2>
                    
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 18px; margin-bottom: 20px;">
                        <p><strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                        <p>æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼šè‹±æ–‡ ä¸­æ–‡</p>
                        <p>ç¤ºä¾‹ï¼šhello ä½ å¥½</p>
                    </div>
                    
                    <textarea id="word-input" placeholder="è¾“å…¥å•è¯ï¼Œæ¯è¡Œä¸€ä¸ªï¼š
ç¤ºä¾‹ï¼š
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
book ä¹¦
computer ç”µè„‘"></textarea>
                    
                    <div style="text-align: center; margin: 25px 0;">
                        <button class="btn" onclick="addWords()">
                            <span>âœ… æ·»åŠ å•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="loadExampleWords()">
                            <span>ğŸ“š åŠ è½½ç¤ºä¾‹</span>
                        </button>
                        <button class="btn btn-red" onclick="showStudentMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                    
                    <div id="add-result" style="display: none; padding: 15px; background: #e8f5e8; border-radius: 8px; margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- å•è¯è®­ç»ƒç•Œé¢ -->
            <div id="train-screen" class="screen">
                <div style="text-align: center;">
                    <h2 style="margin-bottom: 10px;">ğŸ¯ å•è¯è®­ç»ƒ</h2>
                    <p style="color: #666; margin-bottom: 20px;">ç‚¹å‡»å¡ç‰‡ç¿»è½¬ï¼Œæ ¹æ®è®°å¿†ç¨‹åº¦é€‰æ‹©æŒ‰é’®</p>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span id="progress-text" style="color: #666;">è¿›åº¦: 0/0</span>
                            <span id="mode-text" style="color: #2196F3; font-weight: bold;">è‹±æ–‡ â†’ ä¸­æ–‡</span>
                        </div>
                        <div class="progress-bar">
                            <div id="train-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="word-card" class="word-card" onclick="flipCard()">
                        <div id="card-front" class="card-front">ç‚¹å‡»å¼€å§‹è®­ç»ƒ</div>
                        <div id="card-back" class="card-back" style="display:none; color:#2E7D32;"></div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">
                            <button class="btn" onclick="markWord('mastered')" style="padding: 14px 28px;">
                                <span>âœ… è®°å¾—</span>
                            </button>
                            <button class="btn btn-blue" onclick="markWord('learning')" style="padding: 14px 28px;">
                                <span>ğŸ”„ æ¨¡ç³Š</span>
                            </button>
                            <button class="btn btn-red" onclick="markWord('new')" style="padding: 14px 28px;">
                                <span>âŒ å¿˜è®°</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <button class="btn btn-red" onclick="endTraining()">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                        <button class="btn" onclick="showStudentMenu()">
                            <span>ğŸ“‹ è¿”å›èœå•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ -->
            <div id="all-students-screen" class="screen">
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 25px;">ğŸ‘¥ æ‰€æœ‰å­¦ç”Ÿ</h2>
                    
                    <div id="students-list">
                        <p style="text-align: center;">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ·»åŠ å…¬å…±å•è¯ -->
            <div id="add-public-words-screen" class="screen">
                <div style="max-width: 700px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“š æ·»åŠ å…¬å…±å•è¯</h2>
                    
                    <textarea id="public-word-input" placeholder="è¾“å…¥å…¬å…±å•è¯ï¼Œæ¯è¡Œä¸€ä¸ªï¼š
ç¤ºä¾‹ï¼š
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ"></textarea>
                    
                    <div style="text-align: center; margin: 25px 0;">
                        <button class="btn" onclick="addPublicWords()">
                            <span>âœ… æ·»åŠ å…¬å…±å•è¯</span>
                        </button>
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                    
                    <div id="public-add-result" style="display: none; padding: 15px; background: #e8f5e8; border-radius: 8px; margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== SUPABASE é…ç½® ==========
        const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-adGnuLFrSYG3melS6pPqg_XW7RlFzF';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        console.log('ğŸŒ å·²è¿æ¥åˆ°Supabaseæ•°æ®åº“');
        
        // ========== å…¨å±€çŠ¶æ€ ==========
        let appState = {
            currentUser: null,
            isTeacher: false,
            userId: null,
            userWords: [],
            trainingWords: [],
            currentWordIndex: 0,
            trainingMode: 'en_to_cn',
            cardFlipped: false
        };
        
        // ========== é¡µé¢åˆ‡æ¢ ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }
        
        function showTeacherMenu() {
            showScreen('teacher-menu');
            updateClassStats();
        }
        
        function showStudentMenu() {
            showScreen('student-menu');
            updateStudentStats();
        }
        
        // ========== ç™»å½•/æ³¨å†Œ ==========
        async function login() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            const loginStatus = document.getElementById('login-status');
            loginStatus.style.display = 'block';
            loginStatus.innerHTML = '<p>æ­£åœ¨è¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“...</p>';
            
            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                let user;
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingUser) {
                    // ç”¨æˆ·å·²å­˜åœ¨
                    user = existingUser;
                } else {
                    // åˆ›å»ºæ–°ç”¨æˆ·
                    const isTeacher = (username === 'kathy151' || username === 'teacher');
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert([{
                            username: username,
                            is_teacher: isTeacher,
                            created_at: new Date().toISOString(),
                            last_login: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    user = newUser;
                }
                
                // æ›´æ–°åº”ç”¨çŠ¶æ€
                appState.currentUser = username;
                appState.userId = user.id;
                appState.isTeacher = user.is_teacher;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('current_user', username);
                localStorage.setItem('user_id', user.id);
                localStorage.setItem('is_teacher', user.is_teacher);
                
                // åŠ è½½æ•°æ®
                if (user.is_teacher) {
                    await loadAllStudents();
                    showTeacherMenu();
                    loginStatus.innerHTML = '<p style="color: green;">âœ… æ¬¢è¿Kathyè€å¸ˆï¼</p>';
                } else {
                    await loadUserWords();
                    document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                    showStudentMenu();
                    loginStatus.innerHTML = `<p style="color: green;">âœ… ç™»å½•æˆåŠŸï¼</p>`;
                }
                
                setTimeout(() => {
                    loginStatus.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                loginStatus.innerHTML = `<p style="color: red;">âŒ ç™»å½•å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // ========== æ•°æ®åŠ è½½ ==========
        async function loadUserWords() {
            try {
                const { data, error } = await supabase
                    .from('user_words')
                    .select('*')
                    .eq('user_id', appState.userId)
                    .order('added_date', { ascending: false });
                
                if (error) throw error;
                appState.userWords = data || [];
                updateStudentStats();
                
            } catch (error) {
                console.error('åŠ è½½å•è¯é”™è¯¯:', error);
            }
        }
        
        async function loadAllStudents() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_teacher', false)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿé”™è¯¯:', error);
                return [];
            }
        }
        
        // ========== å­¦ç”ŸåŠŸèƒ½ ==========
        function updateStudentStats() {
            const statsDiv = document.getElementById('student-stats');
            const totalWords = appState.userWords.length;
            const mastered = appState.userWords.filter(w => w.status === 'mastered').length;
            const learning = appState.userWords.filter(w => w.status === 'learning').length;
            const newWords = appState.userWords.filter(w => w.status === 'new').length;
            const progress = totalWords > 0 ? Math.round((mastered / totalWords) * 100) : 0;
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 15px 0;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.6em; color: #2196F3; font-weight: bold;">${totalWords}</div>
                        <div style="color: #666; font-size: 0.9em;">å•è¯æ€»æ•°</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.6em; color: #4CAF50; font-weight: bold;">${mastered}</div>
                        <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.6em; color: #FF9800; font-weight: bold;">${learning}</div>
                        <div style="color: #666; font-size: 0.9em;">å­¦ä¹ ä¸­</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.6em; color: #F44336; font-weight: bold;">${newWords}</div>
                        <div style="color: #666; font-size: 0.9em;">æœªå­¦ä¹ </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        }
        
        function showAddWords() {
            showScreen('add-words-screen');
            document.getElementById('add-result').style.display = 'none';
        }
        
        function loadExampleWords() {
            const examples = `hello ä½ å¥½\nworld ä¸–ç•Œ\napple è‹¹æœ\nbook ä¹¦\ncomputer ç”µè„‘`;
            document.getElementById('word-input').value = examples;
        }
        
        async function addWords() {
            const input = document.getElementById('word-input').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            const lines = input.split('\n');
            const words = [];
            let added = 0;
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                const parts = trimmed.split(/\s+/);
                if (parts.length >= 2) {
                    const english = parts[0];
                    const chinese = parts.slice(1).join(' ');
                    
                    words.push({
                        user_id: appState.userId,
                        english: english,
                        chinese: chinese,
                        status: 'new',
                        added_date: new Date().toISOString()
                    });
                    added++;
                }
            }
            
            if (words.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('user_words')
                    .insert(words);
                
                if (error) throw error;
                
                // é‡æ–°åŠ è½½å•è¯
                await loadUserWords();
                
                const resultDiv = document.getElementById('add-result');
                resultDiv.innerHTML = `<p style="color: #4CAF50;">âœ… æˆåŠŸæ·»åŠ  ${added} ä¸ªå•è¯ï¼</p>`;
                resultDiv.style.display = 'block';
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('word-input').value = '';
                
            } catch (error) {
                console.error('æ·»åŠ å•è¯é”™è¯¯:', error);
                alert('æ·»åŠ å•è¯å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function startTraining() {
            if (appState.userWords.length === 0) {
                alert('è¯·å…ˆæ·»åŠ å•è¯');
                return;
            }
            
            appState.trainingWords = [...appState.userWords];
            appState.trainingWords.sort(() => Math.random() - 0.5);
            appState.currentWordIndex = 0;
            appState.cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
        }
        
        function showCurrentWord() {
            if (appState.currentWordIndex >= appState.trainingWords.length) {
                endTraining();
                return;
            }
            
            const word = appState.trainingWords[appState.currentWordIndex];
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            wordCard.classList.remove('flipped');
            appState.cardFlipped = false;
            cardBack.style.display = 'none';
            
            if (appState.trainingMode === 'en_to_cn') {
                cardFront.textContent = word.english;
                cardBack.textContent = word.chinese;
            } else {
                cardFront.textContent = word.chinese;
                cardBack.textContent = word.english;
            }
            
            const progress = ((appState.currentWordIndex + 1) / appState.trainingWords.length) * 100;
            document.getElementById('progress-text').textContent = 
                `è¿›åº¦: ${appState.currentWordIndex + 1}/${appState.trainingWords.length}`;
            document.getElementById('train-progress').style.width = `${progress}%`;
        }
        
        function flipCard() {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            if (!appState.cardFlipped) {
                cardBack.style.display = 'block';
                wordCard.classList.add('flipped');
                appState.cardFlipped = true;
            } else {
                cardBack.style.display = 'none';
                wordCard.classList.remove('flipped');
                appState.cardFlipped = false;
            }
        }
        
        async function markWord(status) {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const word = appState.trainingWords[appState.currentWordIndex];
            
            try {
                const { error } = await supabase
                    .from('user_words')
                    .update({
                        status: status,
                        review_count: word.review_count + 1,
                        last_review: new Date().toISOString()
                    })
                    .eq('id', word.id);
                
                if (error) throw error;
                
                appState.currentWordIndex++;
                appState.cardFlipped = false;
                setTimeout(showCurrentWord, 300);
                
            } catch (error) {
                console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function endTraining() {
            const mastered = appState.userWords.filter(w => w.status === 'mastered').length;
            const total = appState.userWords.length;
            const score = total > 0 ? Math.round((mastered / total) * 100) : 0;
            
            let message = `ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\n`;
            message += `âœ… è®°å¾—ï¼š${appState.userWords.filter(w => w.status === 'mastered').length}\n`;
            message += `ğŸ”„ æ¨¡ç³Šï¼š${appState.userWords.filter(w => w.status === 'learning').length}\n`;
            message += `âŒ å¿˜è®°ï¼š${appState.userWords.filter(w => w.status === 'new').length}\n`;
            message += `ğŸ“ˆ æŒæ¡ç‡ï¼š${score}%\n\n`;
            
            if (score >= 80) {
                message += `ğŸŒŸ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼`;
            } else if (score >= 60) {
                message += `ğŸ’ª è¿˜ä¸é”™ï¼Œç»§ç»­åŠ æ²¹ï¼`;
            } else {
                message += `ğŸ“š éœ€è¦å¤šå¤ä¹ ï¼Œç»§ç»­åŠªåŠ›ï¼`;
            }
            
            alert(message);
            loadUserWords(); // é‡æ–°åŠ è½½æ•°æ®
            showStudentMenu();
        }
        
        function showReviewWords() {
            const reviewWords = appState.userWords.filter(word => 
                word.status === 'new' || word.status === 'learning'
            );
            
            if (reviewWords.length === 0) {
                alert('ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚');
                return;
            }
            
            appState.trainingWords = reviewWords;
            appState.currentWordIndex = 0;
            appState.cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
            alert(`ğŸ“š å¼€å§‹å¤ä¹  ${reviewWords.length} ä¸ªå¼±é¡¹å•è¯`);
        }
        
        async function viewSharedWords() {
            try {
                const { data, error } = await supabase
                    .from('public_words')
                    .select('*')
                    .order('added_date', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                if (data.length === 0) {
                    alert('è€å¸ˆè¿˜æ²¡æœ‰ä¸Šä¼ å…±äº«å•è¯');
                    return;
                }
                
                let message = `ğŸ“š è€å¸ˆå…±äº«çš„å•è¯ï¼ˆå…± ${data.length} ä¸ªï¼‰:\n\n`;
                data.forEach((word, index) => {
                    message += `${index + 1}. ${word.english} - ${word.chinese}\n`;
                });
                
                alert(message);
                
            } catch (error) {
                console.error('è·å–å…±äº«å•è¯é”™è¯¯:', error);
                alert('åŠ è½½å…±äº«å•è¯å¤±è´¥');
            }
        }
        
        // ========== æ•™å¸ˆåŠŸèƒ½ ==========
        async function updateClassStats() {
            const statsDiv = document.getElementById('class-stats');
            
            try {
                const students = await loadAllStudents();
                
                if (students.length === 0) {
                    statsDiv.innerHTML = `<p style="color: #666; text-align: center;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>`;
                    return;
                }
                
                let totalWords = 0;
                let masteredWords = 0;
                let learningWords = 0;
                
                for (const student of students) {
                    totalWords += student.total_words || 0;
                    masteredWords += student.mastered_words || 0;
                    learningWords += student.learning_words || 0;
                }
                
                const avgWords = students.length > 0 ? Math.round(totalWords / students.length) : 0;
                const avgMastered = students.length > 0 ? Math.round(masteredWords / students.length) : 0;
                
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #2196F3; font-weight: bold;">${students.length}</div>
                            <div style="color: #666; font-size: 0.9em;">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #4CAF50; font-weight: bold;">${totalWords}</div>
                            <div style="color: #666; font-size: 0.9em;">æ€»å•è¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #FF9800; font-weight: bold;">${avgWords}</div>
                            <div style="color: #666; font-size: 0.9em;">äººå‡å•è¯</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="font-size: 1.8em; color: #9C27B0; font-weight: bold;">${avgMastered}</div>
                            <div style="color: #666; font-size: 0.9em;">äººå‡æŒæ¡</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('æ›´æ–°ç­çº§ç»Ÿè®¡é”™è¯¯:', error);
                statsDiv.innerHTML = `<p style="color: red;">âŒ åŠ è½½ç­çº§æ•°æ®å¤±è´¥</p>`;
            }
        }
        
        async function showAllStudents() {
            showScreen('all-students-screen');
            
            try {
                const students = await loadAllStudents();
                const studentsList = document.getElementById('students-list');
                
                if (students.length === 0) {
                    studentsList.innerHTML = `<p style="text-align: center; padding: 30px;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>`;
                    return;
                }
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å­¦ç”Ÿå§“å</th>
                                <th>å•è¯æ€»æ•°</th>
                                <th>å·²æŒæ¡</th>
                                <th>å­¦ä¹ ä¸­</th>
                                <th>æœ€åç™»å½•</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                students.forEach(student => {
                    const lastLogin = student.last_login ? 
                        new Date(student.last_login).toLocaleDateString('zh-CN') : 'ä»æœª';
                    
                    html += `
                        <tr>
                            <td><strong>${student.username}</strong></td>
                            <td>${student.total_words || 0}</td>
                            <td style="color: #4CAF50;">${student.mastered_words || 0}</td>
                            <td style="color: #FF9800;">${student.learning_words || 0}</td>
                            <td>${lastLogin}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                studentsList.innerHTML = html;
                
            } catch (error) {
                console.error('æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
                document.getElementById('students-list').innerHTML = 
                    `<p style="color: red; text-align: center;">åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥</p>`;
            }
        }
        
        function showAddPublicWords() {
            showScreen('add-public-words-screen');
            document.getElementById('public-add-result').style.display = 'none';
        }
        
        async function addPublicWords() {
            if (!appState.isTeacher) {
                alert('åªæœ‰è€å¸ˆå¯ä»¥æ·»åŠ å…¬å…±å•è¯');
                return;
            }
            
            const input = document.getElementById('public-word-input').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            const lines = input.split('\n');
            const words = [];
            let added = 0;
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                const parts = trimmed.split(/\s+/);
                if (parts.length >= 2) {
                    words.push({
                        english: parts[0],
                        chinese: parts.slice(1).join(' '),
                        added_by: appState.userId,
                        added_date: new Date().toISOString()
                    });
                    added++;
                }
            }
            
            if (words.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('public_words')
                    .insert(words);
                
                if (error) throw error;
                
                const resultDiv = document.getElementById('public-add-result');
                resultDiv.innerHTML = `<p style="color: #4CAF50;">âœ… æˆåŠŸæ·»åŠ  ${added} ä¸ªå…¬å…±å•è¯ï¼</p>`;
                resultDiv.style.display = 'block';
                
                document.getElementById('public-word-input').value = '';
                
            } catch (error) {
                console.error('æ·»åŠ å…¬å…±å•è¯é”™è¯¯:', error);
                alert('æ·»åŠ å…¬å…±å•è¯å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function showLearningMonitor() {
            alert('å­¦ä¹ ç›‘æ§åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        function showTeacherSettings() {
            alert('ç³»ç»Ÿè®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        // ========== é€€å‡ºç™»å½• ==========
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                appState.currentUser = null;
                appState.isTeacher = false;
                appState.userId = null;
                appState.userWords = [];
                localStorage.clear();
                document.getElementById('username').value = '';
                showScreen('login-screen');
            }
        }
        
        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ Kathyå•è¯è®­ç»ƒè¥å¯åŠ¨');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•ç”¨æˆ·
            const savedUser = localStorage.getItem('current_user');
            const savedUserId = localStorage.getItem('user_id');
            const savedIsTeacher = localStorage.getItem('is_teacher');
            
            if (savedUser && savedUserId) {
                appState.currentUser = savedUser;
                appState.userId = savedUserId;
                appState.isTeacher = (savedIsTeacher === 'true');
                
                if (appState.isTeacher) {
                    await loadAllStudents();
                    showTeacherMenu();
                } else {
                    await loadUserWords();
                    document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${savedUser}ï¼`;
                    showStudentMenu();
                }
            }
            
            // ç»‘å®šå›è½¦é”®ç™»å½•
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
