<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - å¿«æ¥èƒŒå•è¯å§ï¼</title>
    <!-- æ·»åŠ Supabaseæ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* åŸºç¡€æ ·å¼ - å®Œå…¨ä¿æŒåŸæ · */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: #F1C40F;
        }
        
        .main-content {
            padding: 30px;
        }
        
        /* é¡µé¢åˆ‡æ¢ */
        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 14px 28px;
            margin: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-blue { background: #2196F3; }
        .btn-blue:hover { background: #1976D2; }
        
        .btn-red { background: #F44336; }
        .btn-red:hover { background: #D32F2F; }
        
        .btn-purple { background: #9C27B0; }
        .btn-purple:hover { background: #7B1FA2; }
        
        .btn-gold { background: #FFC107; color: #333; }
        .btn-gold:hover { background: #FFA000; }
        
        /* è¾“å…¥æ¡† */
        input[type="text"], textarea {
            width: 100%;
            max-width: 400px;
            padding: 16px;
            margin: 12px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        
        textarea {
            height: 200px;
            font-family: monospace;
            resize: vertical;
        }
        
        /* å•è¯å¡ç‰‡ */
        .word-card {
            background: white;
            border: 4px solid #4CAF50;
            border-radius: 20px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px auto;
            cursor: pointer;
            font-size: 2.8em;
            font-weight: bold;
            transition: all 0.3s;
            max-width: 600px;
        }
        
        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .word-card.flipped {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-color: #2E7D32;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #4CAF50;
        }
        
        /* è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: #4CAF50;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f5f5f5;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.5s;
        }
        
        /* å¾®ä¿¡è”ç³» */
        .wechat-badge {
            background: #07C160;
            color: white;
            padding: 14px 28px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            font-size: 1.1em;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
        }
        
        /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
        .preview-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th {
            background: #2196F3;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }
        
        .preview-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .preview-table tr:nth-child(even) {
            background: #f5f5f5;
        }
        
        .preview-table tr:hover {
            background: #e3f2fd;
        }
        
        /* çŠ¶æ€æ¶ˆæ¯æ ·å¼ */
        .status-message {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        
        .status-loading {
            background: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEEBA;
        }
        
        .status-success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .status-error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        .status-info {
            background: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .word-card {
                height: 220px;
                font-size: 2.2em;
                margin: 20px 10px;
            }
            
            .btn {
                padding: 12px 20px;
                margin: 8px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">è·ŸKathyä¸€èµ·èƒŒå•è¯å§ï¼</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ========== ç™»å½•ç•Œé¢ ========== -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ ä¸€èµ·ç©å•è¯æ¸¸æˆå•¦ï¼</h2>
                    <p style="color: #666; margin-bottom: 30px;">åŠ æ²¹ï¼Kathyä¼šä¸€ç›´é™ªç€ä½ èƒŒå“’ï¼</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="login()">
                                <span>ğŸ”‘ ç™»å½•</span>
                            </button>
                            <button class="btn btn-blue" onclick="register()">
                                <span>ğŸ“ å­¦ç”Ÿæ³¨å†Œ</span>
                            </button>
                            <button class="btn btn-gold" onclick="testDatabaseConnection()" style="padding: 10px 20px; font-size: 14px;">
                                <span>ğŸ› æµ‹è¯•è¿æ¥</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div id="login-status" class="status-message status-info">
                        æ­£åœ¨è¿æ¥åˆ°å­¦ä¹ æ•°æ®åº“...
                    </div>
                    
                    <!-- è”ç³»ä¿¡æ¯ -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ’¬ è”ç³»ä¿¡æ¯</h3>
                        <div class="wechat-badge">
                            <span>è€å¸ˆå¾®ä¿¡ï¼š</span>
                            <strong>Kathy151</strong>
                        </div>
                        <p style="color: #555; margin-top: 15px; font-size: 0.95em;">
                            å­¦ç”Ÿè¯·ç”¨è‹±æ–‡åæ³¨å†Œç™»å½•ï¼Œä¸ç¡®å®šæ‹¼å†™çš„æ‰¾Kathyç¡®è®¤å“¦ï¼
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ========== ä¸»èœå•ï¼ˆæ•™å¸ˆï¼‰ ========== -->
            <div id="teacher-menu" class="screen">
                <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h2>
                
                <div class="stats-card">
                    <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç­çº§æ€»ä½“ç»Ÿè®¡</h3>
                    <div id="class-stats">
                        <p>æ­£åœ¨åŠ è½½ç­çº§æ•°æ®...</p>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-purple" onclick="showAllStudents()">
                            <span>ğŸ‘¥ æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ</span>
                        </button>
                        <button class="btn btn-blue" onclick="showStudentDetails()">
                            <span>ğŸ“‹ å­¦ç”Ÿè¯¦ç»†æ•°æ®</span>
                        </button>
                        <button class="btn" onclick="showWordStatistics()">
                            <span>ğŸ“Š å•è¯å­¦ä¹ ç»Ÿè®¡</span>
                        </button>
                        <button class="btn btn-gold" onclick="exportAllData()">
                            <span>ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æ•°æ®</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="logout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
                
                <!-- è”ç³»ä¿¡æ¯ -->
                <div style="text-align: center; margin-top: 40px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: inline-block;">
                        <p style="color: #666; margin: 0;">
                            ğŸ’¬ æ•™å¸ˆå¾®ä¿¡ï¼š<strong>Kathy151</strong>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ========== ä¸»èœå•ï¼ˆå­¦ç”Ÿï¼‰ ========== -->
            <div id="student-menu" class="screen">
                <h2 id="student-welcome" style="text-align: center; margin-bottom: 30px;"></h2>
                
                <!-- å­¦ä¹ ç»Ÿè®¡ -->
                <div class="stats-card">
                    <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                    <div id="student-stats">
                        <p>æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</p>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn" onclick="showAddWords()">
                            <span>ğŸ“ æ·»åŠ å•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="startTraining()">
                            <span>ğŸ¯ å¼€å§‹è®­ç»ƒ</span>
                        </button>
                        <button class="btn" onclick="showMyWords()">
                            <span>ğŸ“– æˆ‘çš„å•è¯åº“</span>
                        </button>
                        <button class="btn btn-gold" onclick="showReviewWords()">
                            <span>ğŸ”„ å¤ä¹ å¼±é¡¹</span>
                        </button>
                        <button class="btn btn-purple" onclick="showSettings()">
                            <span>âš™ï¸ è®¾ç½®</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-red" onclick="logout()">
                            <span>ğŸšª é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
                
                <!-- è”ç³»ä¿¡æ¯ -->
                <div style="text-align: center; margin-top: 40px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: inline-block;">
                        <p style="color: #666; margin: 0;">
                            ğŸ’¬ éœ€è¦å¸®åŠ©ï¼Ÿå¾®ä¿¡è”ç³»ï¼š<strong>Kathy151</strong>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ========== æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ ========== -->
            <div id="all-students-screen" class="screen">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‘¥ æ‰€æœ‰å­¦ç”Ÿåˆ—è¡¨</h2>
                    
                    <!-- æœç´¢å’Œç­›é€‰ -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px;">
                            <input type="text" id="student-search" placeholder="ğŸ” æœç´¢å­¦ç”Ÿ..." 
                                   style="flex: 1; min-width: 250px; max-width: 400px; padding: 12px; border-radius: 8px; border: 2px solid #ddd;">
                            <button class="btn" onclick="searchStudents()" style="padding: 12px 24px;">
                                <span>æœç´¢</span>
                            </button>
                            <button class="btn btn-blue" onclick="refreshStudents()" style="padding: 12px 24px;">
                                <span>ğŸ”„ åˆ·æ–°</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- å­¦ç”Ÿåˆ—è¡¨ -->
                    <div id="students-list">
                        <p style="text-align: center;">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</p>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”Ÿè¯¦ç»†æ•°æ® ========== -->
            <div id="student-detail-screen" class="screen">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“‹ å­¦ç”Ÿè¯¦ç»†å­¦ä¹ æ•°æ®</h2>
                    
                    <div id="student-detail-content">
                        <p style="text-align: center;">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„å­¦ç”Ÿ...</p>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn" onclick="showAllStudents()">
                            <span>ğŸ‘¥ è¿”å›å­¦ç”Ÿåˆ—è¡¨</span>
                        </button>
                        <button class="btn btn-red" onclick="showTeacherMenu()">
                            <span>ğŸ”™ è¿”å›ä¸»èœå•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ========== æ·»åŠ å•è¯ï¼ˆå­¦ç”Ÿï¼‰ ========== -->
            <div id="add-words-screen" class="screen">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ æ‰¹é‡æ·»åŠ å•è¯</h2>
                    
                    <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <p><strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                        <p>æ¯è¡Œä¸€ä¸ªå•è¯æˆ–çŸ­è¯­ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼š</p>
                        <p><strong>ç®€å•å•è¯ï¼š</strong> hello ä½ å¥½ æˆ– apple:è‹¹æœ æˆ– world=ä¸–ç•Œ</p>
                        <p><strong>çŸ­è¯­ï¼ˆæ¨èç”¨å¼•å·ï¼‰ï¼š</strong> "good morning" æ—©ä¸Šå¥½ æˆ– 'how are you' = ä½ å¥½å—</p>
                        <p><strong>ä¸­æ–‡çŸ­è¯­ï¼š</strong> "æ—©ä¸Šå¥½" good morning</p>
                        <p><strong>åˆ†éš”ç¬¦ï¼š</strong> ç©ºæ ¼ã€å†’å·(:)ã€ç­‰å·(=)ã€é€—å·(,)ã€ä¸­æ–‡å†’å·(ï¼š)ã€ä¸­æ–‡é€—å·(ï¼Œ)</p>
                        <p><strong>ğŸ’¡ æç¤ºï¼š</strong> è¾“å…¥å®Œæˆåç‚¹å‡»"é¢„è§ˆå•è¯"æŸ¥çœ‹æ•ˆæœï¼Œç¡®è®¤æ— è¯¯åå†å¯¼å…¥</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <textarea id="word-input" placeholder="åœ¨è¿™é‡Œç²˜è´´æˆ–è¾“å…¥å•è¯...
ç¤ºä¾‹ï¼š
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
book ä¹¦
computer ç”µè„‘
"good morning" æ—©ä¸Šå¥½
'how are you' = ä½ å¥½å—"></textarea>
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="preview-area" style="display: none;">
                        <h3 style="color: #2196F3; margin-bottom: 15px;">ğŸ‘ï¸ é¢„è§ˆå•è¯ï¼ˆå…± <span id="preview-count">0</span> ä¸ªï¼‰</h3>
                        <div class="preview-container">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th>åºå·</th>
                                        <th>è‹±æ–‡/çŸ­è¯­</th>
                                        <th>ä¸­æ–‡</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-table-body">
                                    <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                </tbody>
                            </table>
                        </div>
                        <div style="text-align: center; margin: 15px 0;">
                            <button class="btn btn-gold" onclick="confirmImport()">
                                <span>âœ… ç¡®è®¤å¯¼å…¥</span>
                            </button>
                            <button class="btn btn-red" onclick="cancelImport()">
                                <span>âŒ å–æ¶ˆå¯¼å…¥</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="btn" onclick="previewWords()">
                            <span>ğŸ‘ï¸ é¢„è§ˆå•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="pasteFromClipboard()">
                            <span>ğŸ“‹ ç²˜è´´å†…å®¹</span>
                        </button>
                        <button class="btn" onclick="loadExampleWords()">
                            <span>ğŸ“š åŠ è½½ç¤ºä¾‹</span>
                        </button>
                        <button class="btn btn-red" onclick="showStudentMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                    
                    <!-- å¯¼å…¥ç»“æœ -->
                    <div id="import-result" style="display: none; padding: 15px; background: #e8f5e8; border-radius: 8px; margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- ========== å•è¯è®­ç»ƒï¼ˆå­¦ç”Ÿï¼‰ ========== -->
            <div id="train-screen" class="screen">
                <div style="text-align: center;">
                    <h2 style="margin-bottom: 10px;">ğŸ¯ å•è¯è®­ç»ƒ</h2>
                    <p style="color: #666; margin-bottom: 25px;">ç‚¹å‡»å¡ç‰‡ç¿»è½¬ï¼Œæ ¹æ®è®°å¿†ç¨‹åº¦é€‰æ‹©æŒ‰é’®</p>
                    
                    <!-- è®­ç»ƒæ§åˆ¶ -->
                    <div style="margin-bottom: 30px;">
                        <div class="progress-container">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span id="progress-text" style="color: #666;">è¿›åº¦: 0/0</span>
                                <span id="mode-text" style="color: #2196F3; font-weight: bold;">è‹±æ–‡ â†’ ä¸­æ–‡</span>
                            </div>
                            <div class="progress-bar">
                                <div id="train-progress" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <button class="btn btn-gold" onclick="toggleTrainingMode()" style="padding: 10px 20px; font-size: 14px;">
                                <span>ğŸ”„ åˆ‡æ¢è®­ç»ƒæ¨¡å¼</span>
                            </button>
                            <button class="btn" onclick="shuffleWords()" style="padding: 10px 20px; font-size: 14px;">
                                <span>ğŸ² é‡æ–°æ´—ç‰Œ</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- å•è¯å¡ç‰‡ -->
                    <div id="word-card" class="word-card" onclick="flipCard()">
                        <div id="card-front" class="card-front">ç‚¹å‡»å¼€å§‹è®­ç»ƒ</div>
                        <div id="card-back" class="card-back" style="display:none; color:#2E7D32;"></div>
                    </div>
                    
                    <!-- è®°å¿†æŒ‰é’® -->
                    <div style="margin: 35px 0;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                            <button class="btn" onclick="markWord('remembered')" style="padding: 16px 32px; font-size: 17px;">
                                <span>âœ… è®°å¾—</span>
                            </button>
                            <button class="btn btn-blue" onclick="markWord('fuzzy')" style="padding: 16px 32px; font-size: 17px;">
                                <span>ğŸ”„ æ¨¡ç³Š</span>
                            </button>
                            <button class="btn btn-red" onclick="markWord('forgot')" style="padding: 16px 32px; font-size: 17px;">
                                <span>âŒ å¿˜è®°</span>
                            </button>
                            <button class="btn" onclick="skipWord()" style="padding: 16px 32px; font-size: 17px;">
                                <span>â­ï¸ è·³è¿‡</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ§åˆ¶æŒ‰é’® -->
                    <div style="margin-top: 30px;">
                        <button class="btn btn-red" onclick="endTraining()">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                        <button class="btn" onclick="showStudentMenu()">
                            <span>ğŸ“‹ è¿”å›èœå•</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ========== æˆ‘çš„å•è¯åº“ï¼ˆå­¦ç”Ÿï¼‰ ========== -->
            <div id="my-words-screen" class="screen">
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 25px;">ğŸ“– æˆ‘çš„å•è¯åº“</h2>
                    
                    <!-- æœç´¢å’Œç­›é€‰ -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px;">
                            <input type="text" id="word-search" placeholder="ğŸ” æœç´¢å•è¯..." 
                                   style="flex: 1; min-width: 250px; max-width: 400px; padding: 12px; border-radius: 8px; border: 2px solid #ddd;">
                            <select id="word-filter" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd;">
                                <option value="all">å…¨éƒ¨å•è¯</option>
                                <option value="remembered">âœ… è®°å¾—çš„</option>
                                <option value="fuzzy">ğŸ”„ æ¨¡ç³Šçš„</option>
                                <option value="forgot">âŒ å¿˜è®°çš„</option>
                                <option value="new">ğŸ†• æœªå­¦ä¹ çš„</option>
                            </select>
                            <button class="btn" onclick="filterWords()" style="padding: 12px 24px;">
                                <span>ç­›é€‰</span>
                            </button>
                        </div>
                        
                        <div style="text-align: center; color: #666; margin-bottom: 20px;">
                            <p>æ‰¾åˆ° <span id="filtered-count" style="font-weight: bold; color: #2196F3;">0</span> ä¸ªå•è¯</p>
                        </div>
                    </div>
                    
                    <!-- å•è¯åˆ—è¡¨ -->
                    <div id="words-list-container">
                        <p style="text-align: center;">æ­£åœ¨åŠ è½½å•è¯...</p>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-red" onclick="showStudentMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ========== è®¾ç½®ç•Œé¢ ========== -->
            <div id="settings-screen" class="screen">
                <div style="max-width: 700px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ è”ç³»ä¿¡æ¯</h3>
                        
                        <div style="text-align: center; margin: 25px 0;">
                            <div class="wechat-badge" style="margin: 0 auto 20px;">
                                <span>å¾®ä¿¡è”ç³»ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            
                            <p style="color: #666; margin-bottom: 15px;">
                                <strong>ğŸ‘©â€ğŸ« æ•™å¸ˆï¼š</strong>Kathyè€å¸ˆ
                            </p>
                            <p style="color: #666;">
                                å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·éšæ—¶è”ç³»è€å¸ˆã€‚
                            </p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-red" onclick="showStudentMenu()">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== SUPABASE é…ç½® ==========
        const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        console.log('âœ… Supabaseå·²åˆå§‹åŒ–');
        
        // ========== å…¨å±€é…ç½® ==========
        const TEACHER_USERNAME = 'kathy151';
        
        let appState = {
            currentUser: null,
            isTeacher: false,
            userId: null,           // æ•°æ®åº“ä¸­çš„ç”¨æˆ·ID
            userWords: [],          // å­¦ç”Ÿçš„å•è¯åº“
            trainingWords: [],      // å½“å‰è®­ç»ƒçš„å•è¯
            currentWordIndex: 0,
            trainingMode: 'en_to_cn', // en_to_cn æˆ– cn_to_en
            cardFlipped: false,
            previewWordsList: []    // é¢„è§ˆå•è¯åˆ—è¡¨
        };
        
        // ========== çŠ¶æ€æ˜¾ç¤ºå‡½æ•° ==========
        function showStatus(message, type) {
            const statusDiv = document.getElementById('login-status');
            if (!statusDiv) return;
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-message';
            
            switch(type) {
                case 'loading':
                    statusDiv.classList.add('status-loading');
                    statusDiv.innerHTML = `â³ ${message}`;
                    break;
                case 'success':
                    statusDiv.classList.add('status-success');
                    statusDiv.innerHTML = `âœ… ${message}`;
                    break;
                case 'error':
                    statusDiv.classList.add('status-error');
                    statusDiv.innerHTML = `âŒ ${message}`;
                    break;
                default:
                    statusDiv.classList.add('status-info');
                    statusDiv.innerHTML = message;
            }
        }
        
        // ========== æ•°æ®åº“æµ‹è¯•å‡½æ•° ==========
        async function testDatabaseConnection() {
            try {
                showStatus('æµ‹è¯•æ•°æ®åº“è¿æ¥ä¸­...', 'loading');
                
                // æµ‹è¯•1ï¼šæ£€æŸ¥supabaseå¯¹è±¡
                if (!supabase) {
                    showStatus('âŒ Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                    return;
                }
                
                // æµ‹è¯•2ï¼šæ£€æŸ¥usersè¡¨
                const { data: usersData, error: usersError } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (usersError) {
                    showStatus(`âŒ Usersè¡¨æŸ¥è¯¢å¤±è´¥: ${usersError.message}`, 'error');
                    return;
                }
                
                // æµ‹è¯•3ï¼šæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡å°è¯•åˆ›å»ºæµ‹è¯•è®°å½•ï¼‰
                const testUsername = `test_${Date.now()}`;
                const { data: testUser, error: createError } = await supabase
                    .from('users')
                    .insert([{
                        username: testUsername,
                        is_teacher: false,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (createError) {
                    // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæä¾›åˆ›å»ºSQL
                    const sql = `
                        CREATE TABLE users (
                            id BIGSERIAL PRIMARY KEY,
                            username TEXT UNIQUE NOT NULL,
                            is_teacher BOOLEAN DEFAULT FALSE,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                            last_login TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                        
                        CREATE TABLE user_words (
                            id BIGSERIAL PRIMARY KEY,
                            user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
                            english TEXT NOT NULL,
                            chinese TEXT NOT NULL,
                            status TEXT DEFAULT '',
                            review_count INTEGER DEFAULT 0,
                            last_review TIMESTAMP WITH TIME ZONE,
                            added_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                            word_type TEXT DEFAULT 'word',
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                        
                        INSERT INTO users (username, is_teacher) 
                        VALUES ('kathy151', true)
                        ON CONFLICT (username) DO NOTHING;
                    `;
                    
                    showStatus(`âŒ æ•°æ®åº“è¡¨æœªåˆ›å»º<br><br>
                        <strong>è¯·åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹SQLï¼š</strong><br>
                        <textarea style="width:100%; height:200px; margin-top:10px; font-family:monospace; font-size:12px;">${sql}</textarea>`, 'error');
                    return;
                }
                
                // æµ‹è¯•4ï¼šåˆ é™¤æµ‹è¯•ç”¨æˆ·
                await supabase
                    .from('users')
                    .delete()
                    .eq('id', testUser.id);
                
                showStatus('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡ï¼', 'success');
                
            } catch (error) {
                console.error('æµ‹è¯•é”™è¯¯:', error);
                showStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ========== æ•°æ®åº“è¾…åŠ©å‡½æ•° ==========
        async function getOrCreateUser(username, isTeacher = false) {
            try {
                // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (checkError && checkError.code === 'PGRST116') {
                    // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
                    console.log('åˆ›å»ºæ–°ç”¨æˆ·:', username);
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert([{
                            username: username,
                            is_teacher: isTeacher,
                            created_at: new Date().toISOString(),
                            last_login: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', createError);
                        throw new Error('æ— æ³•åˆ›å»ºç”¨æˆ·: ' + createError.message);
                    }
                    
                    return newUser;
                } else if (checkError) {
                    console.error('æ£€æŸ¥ç”¨æˆ·é”™è¯¯:', checkError);
                    throw new Error('æ— æ³•æ£€æŸ¥ç”¨æˆ·: ' + checkError.message);
                } else {
                    // ç”¨æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°æœ€åç™»å½•æ—¶é—´
                    await supabase
                        .from('users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('id', existingUser.id);
                    
                    return existingUser;
                }
            } catch (error) {
                console.error('ç”¨æˆ·æ“ä½œé”™è¯¯:', error);
                throw error;
            }
        }
        
        async function loadUserWordsFromDB() {
            try {
                const { data, error } = await supabase
                    .from('user_words')
                    .select('*')
                    .eq('user_id', appState.userId);
                
                if (error) throw error;
                
                // è½¬æ¢æ•°æ®æ ¼å¼ä»¥åŒ¹é…åŸæœ‰appState
                return (data || []).map(word => ({
                    english: word.english,
                    chinese: word.chinese,
                    status: word.status || '',
                    reviewCount: word.review_count || 0,
                    lastReview: word.last_review,
                    addedDate: word.added_date,
                    type: word.word_type || 'word'
                }));
            } catch (error) {
                console.error('åŠ è½½å•è¯é”™è¯¯:', error);
                return [];
            }
        }
        
        async function saveWordToDB(word) {
            try {
                // é¦–å…ˆæ£€æŸ¥å•è¯æ˜¯å¦å·²å­˜åœ¨
                const { data: existingWord, error: checkError } = await supabase
                    .from('user_words')
                    .select('*')
                    .eq('user_id', appState.userId)
                    .eq('english', word.english)
                    .single();
                
                if (checkError && checkError.code === 'PGRST116') {
                    // å•è¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å•è¯
                    const { error: createError } = await supabase
                        .from('user_words')
                        .insert([{
                            user_id: appState.userId,
                            english: word.english,
                            chinese: word.chinese,
                            status: word.status || '',
                            review_count: word.reviewCount || 0,
                            last_review: word.lastReview,
                            added_date: word.addedDate || new Date().toISOString(),
                            word_type: word.type || 'word'
                        }]);
                    
                    if (createError) throw createError;
                    return true;
                } else if (checkError) {
                    throw checkError;
                } else {
                    // å•è¯å·²å­˜åœ¨ï¼Œæ›´æ–°å•è¯
                    const { error: updateError } = await supabase
                        .from('user_words')
                        .update({
                            chinese: word.chinese,
                            status: word.status || existingWord.status,
                            review_count: word.reviewCount || existingWord.review_count,
                            last_review: word.lastReview || existingWord.last_review
                        })
                        .eq('id', existingWord.id);
                    
                    if (updateError) throw updateError;
                    return true;
                }
            } catch (error) {
                console.error('ä¿å­˜å•è¯é”™è¯¯:', error);
                return false;
            }
        }
        
        async function syncWordsToDB(words) {
            try {
                // æ‰¹é‡æ’å…¥å•è¯
                const wordData = words.map(word => ({
                    user_id: appState.userId,
                    english: word.english,
                    chinese: word.chinese,
                    status: word.status || '',
                    review_count: word.reviewCount || 0,
                    last_review: word.lastReview,
                    added_date: word.addedDate || new Date().toISOString(),
                    word_type: word.type || 'word'
                }));
                
                const { error } = await supabase
                    .from('user_words')
                    .insert(wordData);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('æ‰¹é‡åŒæ­¥å•è¯é”™è¯¯:', error);
                return false;
            }
        }
        
        async function getAllStudentsFromDB() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_teacher', false);
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
                return [];
            }
        }
        
        async function getStudentWordsFromDB(studentId) {
            try {
                const { data, error } = await supabase
                    .from('user_words')
                    .select('*')
                    .eq('user_id', studentId);
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿå•è¯é”™è¯¯:', error);
                return [];
            }
        }
        
        // ========== é¡µé¢åˆ‡æ¢å‡½æ•° ==========
        function showScreen(screenId) {
            // éšè—æ‰€æœ‰ç•Œé¢
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡ç•Œé¢
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }
        
        function showTeacherMenu() {
            showScreen('teacher-menu');
            updateClassStats();
        }
        
        function showStudentMenu() {
            showScreen('student-menu');
            updateStudentStats();
        }
        
        function showLogin() {
            showScreen('login-screen');
        }
        
        // ========== ç™»å½•/æ³¨å†ŒåŠŸèƒ½ ==========
        async function login() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showStatus('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showStatus('æ­£åœ¨è¿æ¥æ•°æ®åº“...', 'loading');
                
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                const { data: testData, error: testError } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (testError) {
                    console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', testError);
                    showStatus('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç‚¹å‡»"æµ‹è¯•è¿æ¥"', 'error');
                    return;
                }
                
                showStatus('éªŒè¯ç”¨æˆ·ä¿¡æ¯...', 'loading');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•™å¸ˆè´¦å·
                if (username === TEACHER_USERNAME) {
                    // æ•™å¸ˆç™»å½•
                    const user = await getOrCreateUser(username, true);
                    
                    if (!user) {
                        showStatus('æ•™å¸ˆè´¦æˆ·æ“ä½œå¤±è´¥', 'error');
                        return;
                    }
                    
                    appState.currentUser = username;
                    appState.isTeacher = true;
                    appState.userId = user.id;
                    appState.userWords = [];
                    
                    // ä¿å­˜ç™»å½•çŠ¶æ€
                    localStorage.setItem('current_user', username);
                    localStorage.setItem('user_id', user.id);
                    localStorage.setItem('user_role', 'teacher');
                    
                    showStatus('ç™»å½•æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        showTeacherMenu();
                        alert('ğŸ‘‘ æ¬¢è¿Kathyè€å¸ˆï¼');
                    }, 500);
                    
                } else {
                    // å­¦ç”Ÿç™»å½•
                    const user = await getOrCreateUser(username, false);
                    
                    if (!user) {
                        showStatus('å­¦ç”Ÿè´¦æˆ·æ“ä½œå¤±è´¥', 'error');
                        return;
                    }
                    
                    appState.currentUser = username;
                    appState.isTeacher = false;
                    appState.userId = user.id;
                    
                    // ä»æ•°æ®åº“åŠ è½½å­¦ç”Ÿçš„å•è¯
                    showStatus('åŠ è½½å•è¯æ•°æ®...', 'loading');
                    appState.userWords = await loadUserWordsFromDB();
                    
                    // ä¿å­˜ç™»å½•çŠ¶æ€
                    localStorage.setItem('current_user', username);
                    localStorage.setItem('user_id', user.id);
                    localStorage.setItem('user_role', 'student');
                    
                    document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                    showStatus('ç™»å½•æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        showStudentMenu();
                    }, 500);
                }
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showStatus(`ç™»å½•å¤±è´¥: ${error.message || 'è¯·é‡è¯•æˆ–è”ç³»Kathyè€å¸ˆ'}`, 'error');
            }
        }
        
        async function register() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showStatus('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            if (username.length < 2) {
                showStatus('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ•™å¸ˆç”¨æˆ·å
            if (username.toLowerCase() === TEACHER_USERNAME.toLowerCase()) {
                showStatus('è¯¥ç”¨æˆ·åä¸å¯ç”¨', 'error');
                return;
            }
            
            try {
                showStatus('åˆ›å»ºæ–°è´¦æˆ·...', 'loading');
                
                // åˆ›å»ºæ–°å­¦ç”Ÿ
                const user = await getOrCreateUser(username, false);
                
                if (!user) {
                    showStatus('åˆ›å»ºè´¦æˆ·å¤±è´¥', 'error');
                    return;
                }
                
                appState.currentUser = username;
                appState.isTeacher = false;
                appState.userId = user.id;
                appState.userWords = [];
                
                // ä¿å­˜ç™»å½•çŠ¶æ€
                localStorage.setItem('current_user', username);
                localStorage.setItem('user_id', user.id);
                localStorage.setItem('user_role', 'student');
                
                document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${username}ï¼`;
                showStatus('æ³¨å†ŒæˆåŠŸï¼', 'success');
                setTimeout(() => {
                    showStudentMenu();
                    alert(`âœ… æ¬¢è¿ ${username} åŠ å…¥Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ï¼`);
                }, 500);
                
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showStatus(`æ³¨å†Œå¤±è´¥: ${error.message || 'ç”¨æˆ·åå¯èƒ½å·²å­˜åœ¨'}`, 'error');
            }
        }
        
        // ========== æ•™å¸ˆç›‘æ§åŠŸèƒ½ ==========
        async function updateClassStats() {
            const statsDiv = document.getElementById('class-stats');
            
            try {
                // ä»æ•°æ®åº“è·å–æ‰€æœ‰å­¦ç”Ÿ
                const allStudents = await getAllStudentsFromDB();
                
                if (allStudents.length === 0) {
                    statsDiv.innerHTML = `
                        <p style="color: #666; text-align: center; padding: 30px;">
                            è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œï¼Œè¯·åˆ†äº«é“¾æ¥ç»™å­¦ç”Ÿæ³¨å†Œ
                        </p>
                    `;
                    return;
                }
                
                // è®¡ç®—ç­çº§ç»Ÿè®¡
                let totalStudents = allStudents.length;
                let totalWords = 0;
                let totalRemembered = 0;
                let totalFuzzy = 0;
                let totalForgot = 0;
                
                // ä¸ºæ¯ä¸ªå­¦ç”Ÿè·å–å•è¯æ•°æ®
                for (const student of allStudents) {
                    const words = await getStudentWordsFromDB(student.id);
                    totalWords += words.length;
                    totalRemembered += words.filter(w => w.status === 'remembered').length;
                    totalFuzzy += words.filter(w => w.status === 'fuzzy').length;
                    totalForgot += words.filter(w => w.status === 'forgot' || !w.status).length;
                }
                
                const avgWords = totalStudents > 0 ? Math.round(totalWords / totalStudents) : 0;
                const avgRemembered = totalStudents > 0 ? Math.round(totalRemembered / totalStudents) : 0;
                
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #2196F3; font-weight: bold;">${totalStudents}</div>
                            <div style="color: #666; font-size: 0.9em;">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #4CAF50; font-weight: bold;">${totalWords}</div>
                            <div style="color: #666; font-size: 0.9em;">æ€»å•è¯æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #FF9800; font-weight: bold;">${avgWords}</div>
                            <div style="color: #666; font-size: 0.9em;">äººå‡å•è¯</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="font-size: 2em; color: #9C27B0; font-weight: bold;">${avgRemembered}</div>
                            <div style="color: #666; font-size: 0.9em;">äººå‡æŒæ¡</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px;">ğŸ“ˆ ç­çº§å­¦ä¹ æƒ…å†µåˆ†å¸ƒ</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">å·²æŒæ¡</span>
                            <span style="color: #4CAF50; font-weight: bold;">${totalRemembered}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${totalWords > 0 ? (totalRemembered / totalWords * 100) : 0}%"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin: 15px 0 8px;">
                            <span style="color: #666;">å­¦ä¹ ä¸­</span>
                            <span style="color: #FF9800; font-weight: bold;">${totalFuzzy}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${totalWords > 0 ? (totalFuzzy / totalWords * 100) : 0}%; background: #FF9800;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin: 15px 0 8px;">
                            <span style="color: #666;">éœ€å¤ä¹ </span>
                            <span style="color: #F44336; font-weight: bold;">${totalForgot}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${totalWords > 0 ? (totalForgot / totalWords * 100) : 0}%; background: #F44336;"></div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('æ›´æ–°ç­çº§ç»Ÿè®¡é”™è¯¯:', error);
                statsDiv.innerHTML = `<p style="color: red;">åŠ è½½ç­çº§æ•°æ®å¤±è´¥</p>`;
            }
        }
        
        async function showAllStudents() {
            showScreen('all-students-screen');
            loadStudentsList();
        }
        
        async function loadStudentsList() {
            const studentsList = document.getElementById('students-list');
            
            try {
                const allStudents = await getAllStudentsFromDB();
                
                if (allStudents.length === 0) {
                    studentsList.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¥</div>
                            <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å­¦ç”Ÿ</h3>
                            <p style="color: #999; margin-bottom: 25px;">è¯·åˆ†äº«é“¾æ¥ç»™å­¦ç”Ÿæ³¨å†Œ</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å­¦ç”Ÿå§“å</th>
                                <th>å•è¯æ€»æ•°</th>
                                <th>å·²æŒæ¡</th>
                                <th>å­¦ä¹ ä¸­</th>
                                <th>éœ€å¤ä¹ </th>
                                <th>æœ€åç™»å½•</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // ä¸ºæ¯ä¸ªå­¦ç”Ÿè·å–å•è¯æ•°æ®
                for (const student of allStudents) {
                    const words = await getStudentWordsFromDB(student.id);
                    const remembered = words.filter(w => w.status === 'remembered').length;
                    const fuzzy = words.filter(w => w.status === 'fuzzy').length;
                    const forgot = words.filter(w => w.status === 'forgot' || !w.status).length;
                    
                    // æ ¼å¼åŒ–æ—¶é—´
                    let lastLogin = 'ä»æœª';
                    try {
                        if (student.last_login) {
                            lastLogin = new Date(student.last_login).toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        lastLogin = student.last_login || 'ä»æœª';
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${student.username}</strong></td>
                            <td>${words.length}</td>
                            <td style="color: #4CAF50;">${remembered}</td>
                            <td style="color: #FF9800;">${fuzzy}</td>
                            <td style="color: #F44336;">${forgot}</td>
                            <td>${lastLogin}</td>
                            <td>
                                <button class="btn" style="padding: 6px 12px; font-size: 0.85em;" 
                                        onclick="viewStudentDetail('${student.id}', '${student.username}')">æŸ¥çœ‹è¯¦æƒ…</button>
                            </td>
                        </tr>
                    `;
                }
                
                html += `</tbody></table>`;
                studentsList.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
                studentsList.innerHTML = `<p style="color: red; text-align: center;">åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥</p>`;
            }
        }
        
        async function viewStudentDetail(studentId, username) {
            showScreen('student-detail-screen');
            
            try {
                const words = await getStudentWordsFromDB(studentId);
                const remembered = words.filter(w => w.status === 'remembered').length;
                const fuzzy = words.filter(w => w.status === 'fuzzy').length;
                const forgot = words.filter(w => w.status === 'forgot' || !w.status).length;
                const progress = words.length > 0 ? Math.round((remembered / words.length) * 100) : 0;
                
                let wordsHtml = '';
                if (words.length > 0) {
                    wordsHtml = `
                        <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>è‹±æ–‡</th>
                                        <th>ä¸­æ–‡</th>
                                        <th>çŠ¶æ€</th>
                                        <th>å¤ä¹ æ¬¡æ•°</th>
                                        <th>æœ€åå¤ä¹ </th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    words.forEach(word => {
                        let statusText, statusColor;
                        switch(word.status) {
                            case 'remembered':
                                statusText = 'âœ… è®°å¾—';
                                statusColor = '#4CAF50';
                                break;
                            case 'fuzzy':
                                statusText = 'ğŸ”„ æ¨¡ç³Š';
                                statusColor = '#FF9800';
                                break;
                            case 'forgot':
                                statusText = 'âŒ å¿˜è®°';
                                statusColor = '#F44336';
                                break;
                            default:
                                statusText = 'ğŸ“ æœªå­¦ä¹ ';
                                statusColor = '#666';
                        }
                        
                        let lastReview = 'ä»æœª';
                        try {
                            if (word.last_review) {
                                lastReview = new Date(word.last_review).toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            lastReview = word.last_review || 'ä»æœª';
                        }
                        
                        wordsHtml += `
                            <tr>
                                <td>${word.english}</td>
                                <td>${word.chinese}</td>
                                <td style="color: ${statusColor};">${statusText}</td>
                                <td>${word.review_count || 0}</td>
                                <td>${lastReview}</td>
                            </tr>
                        `;
                    });
                    
                    wordsHtml += `</tbody></table></div>`;
                } else {
                    wordsHtml = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                            <h3 style="color: #666; margin-bottom: 15px;">è¯¥å­¦ç”Ÿè¿˜æ²¡æœ‰å•è¯</h3>
                        </div>
                    `;
                }
                
                document.getElementById('student-detail-content').innerHTML = `
                    <div class="stats-card">
                        <h3 style="color: #333; margin-bottom: 20px;">å­¦ç”Ÿï¼š${username}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                                <div style="font-size: 1.8em; color: #2196F3; font-weight: bold;">${words.length}</div>
                                <div style="color: #666; font-size: 0.9em;">å•è¯æ€»æ•°</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                                <div style="font-size: 1.8em; color: #4CAF50; font-weight: bold;">${remembered}</div>
                                <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                                <div style="font-size: 1.8em; color: #FF9800; font-weight: bold;">${fuzzy}</div>
                                <div style="color: #666; font-size: 0.9em;">å­¦ä¹ ä¸­</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                                <div style="font-size: 1.8em; color: #F44336; font-weight: bold;">${forgot}</div>
                                <div style="color: #666; font-size: 0.9em;">éœ€å¤ä¹ </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                                <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="color: #333; margin-bottom: 15px;">ğŸ“– å•è¯è¯¦æƒ…</h4>
                            ${wordsHtml}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…é”™è¯¯:', error);
                document.getElementById('student-detail-content').innerHTML = 
                    `<p style="color: red; text-align: center;">åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥</p>`;
            }
        }
        
        function searchStudents() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æœç´¢åŠŸèƒ½
            loadStudentsList();
        }
        
        function refreshStudents() {
            loadStudentsList();
        }
        
        function showStudentDetails() {
            showScreen('student-detail-screen');
            document.getElementById('student-detail-content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¥</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¯·ä»å­¦ç”Ÿåˆ—è¡¨ä¸­é€‰æ‹©å­¦ç”ŸæŸ¥çœ‹è¯¦æƒ…</h3>
                    <button class="btn btn-blue" onclick="showAllStudents()">
                        <span>æŸ¥çœ‹å­¦ç”Ÿåˆ—è¡¨</span>
                    </button>
                </div>
            `;
        }
        
        function showWordStatistics() {
            alert('å•è¯å­¦ä¹ ç»Ÿè®¡åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        async function exportAllData() {
            try {
                const allStudents = await getAllStudentsFromDB();
                let exportData = [];
                
                for (const student of allStudents) {
                    const words = await getStudentWordsFromDB(student.id);
                    const studentInfo = student;
                    
                    exportData.push({
                        å­¦ç”Ÿ: student.username,
                        æ³¨å†Œæ—¶é—´: new Date(student.created_at).toLocaleString('zh-CN'),
                        æœ€åç™»å½•: new Date(student.last_login).toLocaleString('zh-CN'),
                        å•è¯æ€»æ•°: words.length,
                        å·²æŒæ¡: words.filter(w => w.status === 'remembered').length,
                        å­¦ä¹ ä¸­: words.filter(w => w.status === 'fuzzy').length,
                        éœ€å¤ä¹ : words.filter(w => w.status === 'forgot' || !w.status).length
                    });
                }
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                let csv = 'å­¦ç”Ÿ,æ³¨å†Œæ—¶é—´,æœ€åç™»å½•,å•è¯æ€»æ•°,å·²æŒæ¡,å­¦ä¹ ä¸­,éœ€å¤ä¹ \n';
                exportData.forEach(row => {
                    csv += `${row.å­¦ç”Ÿ},${row.æ³¨å†Œæ—¶é—´},${row.æœ€åç™»å½•},${row.å•è¯æ€»æ•°},${row.å·²æŒæ¡},${row.å­¦ä¹ ä¸­},${row.éœ€å¤ä¹ }\n`;
                });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kathyç­çº§æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`âœ… å·²å¯¼å‡º ${allStudents.length} ä¸ªå­¦ç”Ÿçš„æ•°æ®`);
                
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®é”™è¯¯:', error);
                alert('âŒ å¯¼å‡ºæ•°æ®å¤±è´¥');
            }
        }
        
        // ========== å­¦ç”ŸåŠŸèƒ½ ==========
        function updateStudentStats() {
            const statsDiv = document.getElementById('student-stats');
            
            const totalWords = appState.userWords.length;
            const remembered = appState.userWords.filter(w => w.status === 'remembered').length;
            const fuzzy = appState.userWords.filter(w => w.status === 'fuzzy').length;
            const forgot = appState.userWords.filter(w => w.status === 'forgot' || !w.status).length;
            const progress = totalWords > 0 ? Math.round((remembered / totalWords) * 100) : 0;
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #2196F3; font-weight: bold;">${totalWords}</div>
                        <div style="color: #666; font-size: 0.9em;">å•è¯æ€»æ•°</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #4CAF50; font-weight: bold;">${remembered}</div>
                        <div style="color: #666; font-size: 0.9em;">å·²æŒæ¡</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #FF9800; font-weight: bold;">${fuzzy}</div>
                        <div style="color: #666; font-size: 0.9em;">å­¦ä¹ ä¸­</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 1.8em; color: #F44336; font-weight: bold;">${forgot}</div>
                        <div style="color: #666; font-size: 0.9em;">éœ€å¤ä¹ </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        }
        
        function showAddWords() {
            showScreen('add-words-screen');
            // é‡ç½®é¢„è§ˆåŒºåŸŸ
            document.getElementById('preview-area').style.display = 'none';
            document.getElementById('import-result').style.display = 'none';
        }
        
        function pasteFromClipboard() {
            if (navigator.clipboard) {
                navigator.clipboard.readText()
                    .then(text => {
                        document.getElementById('word-input').value = text;
                        // è‡ªåŠ¨é¢„è§ˆ
                        setTimeout(() => {
                            previewWords();
                        }, 100);
                    })
                    .catch(err => {
                        alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´');
                    });
            } else {
                alert('æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿è®¿é—®');
            }
        }
        
        function loadExampleWords() {
            const examples = `# ç®€å•å•è¯
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ

# çŸ­è¯­ï¼ˆæ¨èä½¿ç”¨å¼•å·ï¼‰
"good morning" æ—©ä¸Šå¥½
'how are you' = ä½ å¥½å—
"thank you" è°¢è°¢ä½ 

# ä¸­è‹±æ··åˆ
"æ—©ä¸Šå¥½" good morning
"å†è§" goodbye

# å…¶ä»–æ ¼å¼
computer ç”µè„‘
book:ä¹¦
water=æ°´`;
            
            document.getElementById('word-input').value = examples;
            alert('ğŸ“š å·²åŠ è½½ç¤ºä¾‹å•è¯å’ŒçŸ­è¯­');
        }
        
        function previewWords() {
            const input = document.getElementById('word-input').value.trim();
            
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯æˆ–çŸ­è¯­');
                return;
            }
            
            const lines = input.split('\n');
            appState.previewWordsList = [];
            let errors = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // è·³è¿‡æ³¨é‡Šè¡Œï¼ˆä»¥#å¼€å¤´ï¼‰
                if (trimmed.startsWith('#')) continue;
                
                let english = '', chinese = '';
                
                // æ–¹æ¡ˆ1ï¼šå°è¯•åŒ¹é…å¸¦å¼•å·çš„çŸ­è¯­æ ¼å¼
                // æ”¯æŒè‹±æ–‡åŒå¼•å·ã€å•å¼•å·ã€ä¸­æ–‡å¼•å·
                const quoteMatch = trimmed.match(/^(["'ã€Œ])(.+?)\1\s*([:=\sï¼Œ,])\s*(.+)$/);
                
                if (quoteMatch) {
                    // å¦‚æœä½¿ç”¨å¼•å·æ ¼å¼
                    english = quoteMatch[2].trim();
                    chinese = quoteMatch[4].trim();
                } else {
                    // æ–¹æ¡ˆ2ï¼šå°è¯•åŒ¹é…å¸¸è§åˆ†éš”ç¬¦
                    const separators = [' ', ':', '=', ',', 'ï¼š', 'ï¼Œ'];
                    let foundSeparator = false;
                    
                    for (const sep of separators) {
                        // æŸ¥æ‰¾åˆ†éš”ç¬¦çš„ä½ç½®
                        const sepIndex = trimmed.indexOf(sep);
                        if (sepIndex > 0) {
                            english = trimmed.substring(0, sepIndex).trim();
                            chinese = trimmed.substring(sepIndex + sep.length).trim();
                            foundSeparator = true;
                            break;
                        }
                    }
                    
                    // æ–¹æ¡ˆ3ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œå°è¯•æŒ‰ç©ºæ ¼åˆ†å‰²ï¼ˆç®€å•å•è¯ï¼‰
                    if (!foundSeparator) {
                        const parts = trimmed.split(/\s+/);
                        if (parts.length >= 2) {
                            english = parts[0];
                            chinese = parts.slice(1).join(' ');
                        }
                    }
                }
                
                // æ¸…ç†ä¸­è‹±æ–‡ä¸¤ä¾§å¯èƒ½çš„å¤šä½™ç©ºæ ¼å’Œå¼•å·
                english = english.replace(/^["'`ã€Œã€]+|["'`ã€Œã€]+$/g, '').trim();
                chinese = chinese.replace(/^["'`ã€Œã€]+|["'`ã€Œã€]+$/g, '').trim();
                
                if (english && chinese) {
                    appState.previewWordsList.push({
                        english: english,
                        chinese: chinese,
                        lineNumber: i + 1,
                        isValid: true
                    });
                } else {
                    errors.push(`ç¬¬${i+1}è¡Œ: ${trimmed}`);
                }
            }
            
            // æ˜¾ç¤ºé¢„è§ˆç»“æœ
            if (appState.previewWordsList.length > 0) {
                displayPreview();
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯/çŸ­è¯­ã€‚è¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚');
            }
            
            // å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (errors.length > 0) {
                const errorMsg = `ä»¥ä¸‹è¡Œæ ¼å¼é”™è¯¯ï¼Œå·²å¿½ç•¥ï¼š\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    errorMsg += `\n... è¿˜æœ‰ ${errors.length - 5} ä¸ªé”™è¯¯`;
                }
                alert(errorMsg);
            }
        }
        
        function displayPreview() {
            const previewArea = document.getElementById('preview-area');
            const previewCount = document.getElementById('preview-count');
            const previewTableBody = document.getElementById('preview-table-body');
            
            // æ›´æ–°è®¡æ•°
            previewCount.textContent = appState.previewWordsList.length;
            
            // æ¸…ç©ºè¡¨æ ¼
            previewTableBody.innerHTML = '';
            
            // å¡«å……è¡¨æ ¼
            appState.previewWordsList.forEach((word, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${word.english}</strong></td>
                    <td>${word.chinese}</td>
                    <td style="color: #4CAF50;">âœ… æœ‰æ•ˆ</td>
                `;
                previewTableBody.appendChild(row);
            });
            
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            previewArea.style.display = 'block';
            
            // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
            previewArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function confirmImport() {
            if (appState.previewWordsList.length === 0) {
                alert('æ²¡æœ‰è¦å¯¼å…¥çš„å•è¯');
                return;
            }
            
            let added = 0;
            let duplicates = 0;
            
            // å…ˆæ£€æŸ¥å“ªäº›å•è¯å·²ç»å­˜åœ¨
            const existingWords = appState.userWords.map(w => w.english.toLowerCase());
            
            // å‡†å¤‡è¦æ·»åŠ çš„å•è¯
            const wordsToAdd = [];
            
            appState.previewWordsList.forEach(word => {
                // æ£€æŸ¥æ˜¯å¦é‡å¤ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                const exists = existingWords.includes(word.english.toLowerCase());
                
                if (!exists) {
                    const newWord = {
                        english: word.english,
                        chinese: word.chinese,
                        status: '',
                        reviewCount: 0,
                        addedDate: new Date().toISOString(),
                        type: (word.english.includes(' ') || word.english.length > 15) ? 'phrase' : 'word'
                    };
                    
                    appState.userWords.push(newWord);
                    wordsToAdd.push(newWord);
                    added++;
                } else {
                    duplicates++;
                }
            });
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            if (wordsToAdd.length > 0) {
                const success = await syncWordsToDB(wordsToAdd);
                if (!success) {
                    alert('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œä½†å•è¯å·²æ·»åŠ åˆ°æœ¬åœ°');
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateStudentStats();
            
            // æ˜¾ç¤ºç»“æœ
            const resultDiv = document.getElementById('import-result');
            let resultHTML = `<h4>ğŸ“¥ å¯¼å…¥ç»“æœ</h4>`;
            resultHTML += `<p>âœ… æˆåŠŸå¯¼å…¥: <strong>${added}</strong> ä¸ªæ–°å•è¯/çŸ­è¯­</p>`;
            
            if (duplicates > 0) {
                resultHTML += `<p>âš ï¸ è·³è¿‡é‡å¤: <strong>${duplicates}</strong> ä¸ª</p>`;
            }
            
            resultHTML += `<p>ğŸ“Š å½“å‰æ€»æ•°: <strong>${appState.userWords.length}</strong></p>`;
            
            if (added > 0) {
                resultHTML += `<p style="color: #4CAF50;">ğŸ’¡ å¯¼å…¥æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹è®­ç»ƒäº†ï¼</p>`;
                // æ¸…ç©ºè¾“å…¥æ¡†å’Œé¢„è§ˆåŒºåŸŸ
                document.getElementById('word-input').value = '';
                document.getElementById('preview-area').style.display = 'none';
            }
            
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
            
            // é‡ç½®é¢„è§ˆåˆ—è¡¨
            appState.previewWordsList = [];
        }
        
        function cancelImport() {
            // éšè—é¢„è§ˆåŒºåŸŸ
            document.getElementById('preview-area').style.display = 'none';
            // é‡ç½®é¢„è§ˆåˆ—è¡¨
            appState.previewWordsList = [];
            alert('âŒ å·²å–æ¶ˆå¯¼å…¥');
        }
        
        function startTraining() {
            if (appState.userWords.length === 0) {
                alert('è¯·å…ˆæ·»åŠ å•è¯ï¼Œç„¶åå¼€å§‹è®­ç»ƒ');
                return;
            }
            
            // å‡†å¤‡è®­ç»ƒå•è¯
            appState.trainingWords = [...appState.userWords];
            appState.trainingWords.sort(() => Math.random() - 0.5);
            appState.currentWordIndex = 0;
            appState.trainingMode = 'en_to_cn';
            appState.cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
        }
        
        function showCurrentWord() {
            if (appState.currentWordIndex >= appState.trainingWords.length) {
                endTraining();
                return;
            }
            
            const word = appState.trainingWords[appState.currentWordIndex];
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            // é‡ç½®å¡ç‰‡çŠ¶æ€
            wordCard.classList.remove('flipped');
            appState.cardFlipped = false;
            cardBack.style.display = 'none';
            
            // æ ¹æ®è®­ç»ƒæ¨¡å¼æ˜¾ç¤ºå†…å®¹
            if (appState.trainingMode === 'en_to_cn') {
                cardFront.textContent = word.english;
                cardBack.textContent = word.chinese;
                document.getElementById('mode-text').textContent = 'è‹±æ–‡ â†’ ä¸­æ–‡';
            } else {
                cardFront.textContent = word.chinese;
                cardBack.textContent = word.english;
                document.getElementById('mode-text').textContent = 'ä¸­æ–‡ â†’ è‹±æ–‡';
            }
            
            // æ›´æ–°è¿›åº¦
            const progress = ((appState.currentWordIndex + 1) / appState.trainingWords.length) * 100;
            document.getElementById('progress-text').textContent = 
                `è¿›åº¦: ${appState.currentWordIndex + 1}/${appState.trainingWords.length}`;
            document.getElementById('train-progress').style.width = `${progress}%`;
        }
        
        function flipCard() {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            if (!appState.cardFlipped) {
                cardBack.style.display = 'block';
                wordCard.classList.add('flipped');
                appState.cardFlipped = true;
            } else {
                cardBack.style.display = 'none';
                wordCard.classList.remove('flipped');
                appState.cardFlipped = false;
            }
        }
        
        function toggleTrainingMode() {
            appState.trainingMode = appState.trainingMode === 'en_to_cn' ? 'cn_to_en' : 'en_to_cn';
            appState.cardFlipped = false;
            showCurrentWord();
        }
        
        function shuffleWords() {
            // éšæœºæ‰“ä¹±å‰©ä½™å•è¯
            const remainingWords = appState.trainingWords.slice(appState.currentWordIndex);
            for (let i = remainingWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [remainingWords[i], remainingWords[j]] = [remainingWords[j], remainingWords[i]];
            }
            
            appState.trainingWords = [
                ...appState.trainingWords.slice(0, appState.currentWordIndex),
                ...remainingWords
            ];
            
            showCurrentWord();
            alert('ğŸ² å•è¯é¡ºåºå·²é‡æ–°æ‰“ä¹±');
        }
        
        async function markWord(status) {
            if (appState.currentWordIndex >= appState.trainingWords.length) return;
            
            const word = appState.trainingWords[appState.currentWordIndex];
            
            // æ›´æ–°å•è¯çŠ¶æ€
            word.status = status;
            word.reviewCount = (word.reviewCount || 0) + 1;
            word.lastReview = new Date().toISOString();
            
            // æ›´æ–°åŸå§‹æ•°æ®
            const index = appState.userWords.findIndex(w => w.english === word.english);
            if (index !== -1) {
                appState.userWords[index] = word;
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await saveWordToDB(word);
            
            // ä¸‹ä¸€ä¸ªå•è¯
            appState.currentWordIndex++;
            appState.cardFlipped = false;
            
            // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºä¸‹ä¸€ä¸ªå•è¯
            setTimeout(showCurrentWord, 300);
        }
        
        function skipWord() {
            appState.currentWordIndex++;
            appState.cardFlipped = false;
            showCurrentWord();
        }
        
        function endTraining() {
            const remembered = appState.userWords.filter(w => w.status === 'remembered').length;
            const total = appState.userWords.length;
            const score = total > 0 ? Math.round((remembered / total) * 100) : 0;
            
            let message = `ğŸ‰ è®­ç»ƒå®Œæˆï¼\n\n`;
            message += `ğŸ“Š è®­ç»ƒç»Ÿè®¡ï¼š\n`;
            message += `âœ… è®°å¾—ï¼š${appState.userWords.filter(w => w.status === 'remembered').length}\n`;
            message += `ğŸ”„ æ¨¡ç³Šï¼š${appState.userWords.filter(w => w.status === 'fuzzy').length}\n`;
            message += `âŒ å¿˜è®°ï¼š${appState.userWords.filter(w => w.status === 'forgot' || !w.status).length}\n`;
            message += `ğŸ“ˆ æŒæ¡ç‡ï¼š${score}%\n\n`;
            
            if (score >= 80) {
                message += `ğŸŒŸ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼`;
            } else if (score >= 60) {
                message += `ğŸ’ª è¿˜ä¸é”™ï¼Œç»§ç»­åŠ æ²¹ï¼`;
            } else {
                message += `ğŸ“š éœ€è¦å¤šå¤ä¹ ï¼Œç»§ç»­åŠªåŠ›ï¼`;
            }
            
            alert(message);
            showStudentMenu();
        }
        
        function showMyWords() {
            showScreen('my-words-screen');
            loadMyWordsList();
        }
        
        function loadMyWordsList() {
            const container = document.getElementById('words-list-container');
            
            if (appState.userWords.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                        <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å•è¯</h3>
                        <p style="color: #999; margin-bottom: 25px;">å¿«å»æ·»åŠ ä¸€äº›å•è¯å¼€å§‹å­¦ä¹ å§ï¼</p>
                        <button class="btn btn-blue" onclick="showAddWords()">
                            <span>ğŸ“ å»æ·»åŠ å•è¯</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            // åº”ç”¨ç­›é€‰
            const searchTerm = document.getElementById('word-search')?.value.toLowerCase() || '';
            const filterType = document.getElementById('word-filter')?.value || 'all';
            
            let filteredWords = appState.userWords.filter(word => {
                // æœç´¢ç­›é€‰
                const matchesSearch = word.english.toLowerCase().includes(searchTerm) || 
                                     word.chinese.toLowerCase().includes(searchTerm);
                
                // çŠ¶æ€ç­›é€‰
                let matchesFilter = true;
                switch(filterType) {
                    case 'remembered':
                        matchesFilter = word.status === 'remembered';
                        break;
                    case 'fuzzy':
                        matchesFilter = word.status === 'fuzzy';
                        break;
                    case 'forgot':
                        matchesFilter = word.status === 'forgot';
                        break;
                    case 'new':
                        matchesFilter = !word.status;
                        break;
                }
                
                return matchesSearch && matchesFilter;
            });
            
            // æ›´æ–°è®¡æ•°
            document.getElementById('filtered-count').textContent = filteredWords.length;
            
            // ç”Ÿæˆè¡¨æ ¼
            let html = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>è‹±æ–‡</th>
                                <th>ä¸­æ–‡</th>
                                <th>çŠ¶æ€</th>
                                <th>å¤ä¹ æ¬¡æ•°</th>
                                <th>æœ€åå¤ä¹ </th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredWords.forEach((word) => {
                // è·å–çŠ¶æ€æ˜¾ç¤º
                let statusText, statusColor;
                switch(word.status) {
                    case 'remembered':
                        statusText = 'âœ… è®°å¾—';
                        statusColor = '#4CAF50';
                        break;
                    case 'fuzzy':
                        statusText = 'ğŸ”„ æ¨¡ç³Š';
                        statusColor = '#FF9800';
                        break;
                    case 'forgot':
                        statusText = 'âŒ å¿˜è®°';
                        statusColor = '#F44336';
                        break;
                    default:
                        statusText = 'ğŸ“ æœªå­¦ä¹ ';
                        statusColor = '#666';
                }
                
                let lastReview = 'ä»æœª';
                try {
                    if (word.lastReview) {
                        lastReview = new Date(word.lastReview).toLocaleDateString('zh-CN');
                    }
                } catch (e) {
                    lastReview = word.lastReview || 'ä»æœª';
                }
                
                html += `
                    <tr>
                        <td><strong>${word.english}</strong></td>
                        <td>${word.chinese}</td>
                        <td style="color: ${statusColor};">${statusText}</td>
                        <td>${word.reviewCount || 0}</td>
                        <td>${lastReview}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }
        
        function filterWords() {
            loadMyWordsList();
        }
        
        function showReviewWords() {
            // è·å–éœ€è¦å¤ä¹ çš„å•è¯ï¼ˆå¿˜è®°çš„æˆ–æ¨¡ç³Šçš„ï¼‰
            const reviewWords = appState.userWords.filter(word => 
                word.status === 'forgot' || word.status === 'fuzzy' || !word.status
            );
            
            if (reviewWords.length === 0) {
                alert('ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚');
                return;
            }
            
            appState.trainingWords = reviewWords;
            appState.currentWordIndex = 0;
            appState.trainingMode = 'en_to_cn';
            appState.cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
            
            alert(`ğŸ“š å¼€å§‹å¤ä¹  ${reviewWords.length} ä¸ªå¼±é¡¹å•è¯`);
        }
        
        function showSettings() {
            showScreen('settings-screen');
        }
        
        // ========== é€€å‡ºç™»å½• ==========
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                appState.currentUser = null;
                appState.isTeacher = false;
                appState.userId = null;
                appState.userWords = [];
                localStorage.removeItem('current_user');
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_role');
                document.getElementById('username').value = '';
                showLogin();
            }
        }
        
        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥å¯åŠ¨');
            
            // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
            showStatus('æ­£åœ¨è¿æ¥åˆ°å­¦ä¹ æ•°æ®åº“...', 'loading');
            
            try {
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                const { error: testError } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (testError) {
                    console.error('æ•°æ®åº“è¿æ¥å¤±è´¥:', testError);
                    showStatus(`æ•°æ®åº“è¿æ¥å¤±è´¥: ${testError.message}<br>è¯·ç‚¹å‡»"æµ‹è¯•è¿æ¥"æ£€æŸ¥æ•°æ®åº“é…ç½®`, 'error');
                } else {
                    showStatus('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼è¯·è¾“å…¥ç”¨æˆ·åç™»å½•', 'success');
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•ç”¨æˆ·
                    const savedUser = localStorage.getItem('current_user');
                    const savedUserId = localStorage.getItem('user_id');
                    const savedRole = localStorage.getItem('user_role');
                    
                    if (savedUser && savedUserId) {
                        appState.currentUser = savedUser;
                        appState.userId = savedUserId;
                        appState.isTeacher = (savedRole === 'teacher');
                        
                        if (appState.isTeacher) {
                            showTeacherMenu();
                        } else {
                            // ä»æ•°æ®åº“åŠ è½½å­¦ç”Ÿçš„å•è¯
                            appState.userWords = await loadUserWordsFromDB();
                            document.getElementById('student-welcome').textContent = `ğŸ“ æ¬¢è¿ï¼Œ${savedUser}ï¼`;
                            showStudentMenu();
                        }
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                showStatus(`ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
            
            // ç»‘å®šå›è½¦é”®
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
