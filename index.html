<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        
        /* é¡µé¢åˆ‡æ¢ */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            margin: 10px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: all 0.3s;
        }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn-blue { background: #2196F3; }
        .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; }
        .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; }
        .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; }
        .btn-gold:hover { background: #FFA000; }
        
        /* è¾“å…¥æ¡† */
        .login-form input, textarea { 
            width: 100%; 
            max-width: 400px;
            padding: 15px; 
            margin: 10px 0; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
        }
        textarea { 
            height: 200px; 
            font-family: monospace;
        }
        
        /* å•è¯å¡ç‰‡ */
        .word-card {
            background: white;
            border: 3px solid #4CAF50;
            border-radius: 15px;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            cursor: pointer;
            font-size: 2.5em;
            font-weight: bold;
            transition: all 0.3s;
        }
        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .word-card.flipped {
            background: #E8F5E9;
            border-color: #2E7D32;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s;
        }
        
        /* è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        .data-table th {
            background: #4CAF50;
            color: white;
        }
        .data-table tr:hover {
            background: #f5f5f5;
        }
        
        /* å¾®ä¿¡è”ç³» */
        .wechat-contact {
            background: #07C160;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            margin: 20px 0;
            font-size: 1.1em;
        }
        
        /* åŠŸèƒ½ç‰¹ç‚¹ */
        .features {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .feature {
            background: #E3F2FD;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #90CAF9;
            font-size: 0.9em;
            color: #1565C0;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .container { margin: 5px; }
            .word-card { height: 200px; font-size: 2em; }
            .btn { padding: 10px 20px; margin: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">å¿«æ¥èƒŒå•è¯ï¼</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">æ™ºèƒ½è®°å¿† Â· æ•™å¸ˆç›‘æ§ Â· é«˜æ•ˆå­¦ä¹ </p>
        </div>
        
        <div class="main-content">
            <!-- ========== ç™»å½•ç•Œé¢ ========== -->
            <div id="login-screen" class="screen active">
                <div class="login-form" style="text-align: center;">
                    <h2>ç”¨æˆ·ç™»å½• / æ³¨å†Œ</h2>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn" onclick="login()">ç™»å½•</button>
                        <button class="btn btn-blue" onclick="createUser()">æ–°ç”¨æˆ·æ³¨å†Œ</button>
                    </div>
                    
                    <div class="features">
                        <div class="feature">ğŸ“š æ™ºèƒ½é—ªå¡è®°å¿†</div>
                        <div class="feature">ğŸ“ˆ è¿›åº¦è¿½è¸ª</div>
                        <div class="feature">ğŸ‘¥ å¤šç”¨æˆ·</div>
                        <div class="feature">ğŸ‘‘ æ•™å¸ˆç›‘ç®¡</div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <div class="wechat-contact">
                            ğŸ’¬ å¾®ä¿¡è”ç³»ï¼š<strong>Kathy151</strong>
                        </div>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                            å­¦ç”Ÿç›´æ¥æ³¨å†Œï¼Œæ•™å¸ˆè´¦å·ï¼škathy151
                        </p>
                    </div>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div id="login-status" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: none;"></div>
                </div>
            </div>
            
            <!-- ========== ä¸»èœå• ========== -->
            <div id="menu-screen" class="screen">
                <h2 id="welcome-message">æ¬¢è¿</h2>
                
                <!-- æ•™å¸ˆé¢æ¿ -->
                <div id="teacher-panel" class="stats-card" style="display: none;">
                    <h3>ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h3>
                    <p style="color: #666; margin-bottom: 15px;">æ•™å¸ˆï¼šKathyè€å¸ˆ | å¾®ä¿¡ï¼šKathy151</p>
                    <button class="btn btn-purple" onclick="showStudentStats()">æŸ¥çœ‹å­¦ç”Ÿå­¦ä¹ æƒ…å†µ</button>
                    <button class="btn btn-blue" onclick="showAllWords()">æŸ¥çœ‹æ‰€æœ‰å•è¯</button>
                </div>
                
                <!-- å­¦ç”Ÿé¢æ¿ -->
                <div id="student-panel" class="stats-card" style="display: none;">
                    <h3>ğŸ“ æˆ‘çš„å­¦ä¹ é¢æ¿</h3>
                    <div id="user-stats">
                        <p>æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="showBatchAdd()">ğŸ“ æ‰¹é‡æ·»åŠ å•è¯</button>
                        <button class="btn btn-blue" onclick="startTraining()">ğŸ¯ å¼€å§‹è®­ç»ƒ</button>
                        <button class="btn" onclick="showMyWords()">ğŸ“– æˆ‘çš„å•è¯åº“</button>
                    </div>
                </div>
                
                <!-- é€šç”¨åŠŸèƒ½ -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-gold" onclick="showSettings()">âš™ï¸ è®¾ç½®</button>
                    <button class="btn btn-red" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            
            <!-- ========== å•è¯è®­ç»ƒ ========== -->
            <div id="train-screen" class="screen">
                <h2>å•è¯è®­ç»ƒ</h2>
                
                <div style="text-align: center;">
                    <div class="progress-bar">
                        <div id="train-progress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="progress-text">è¿›åº¦: 0/0</p>
                </div>
                
                <div id="word-card" class="word-card" onclick="flipCard()">
                    <div id="card-front">ç‚¹å‡»å¼€å§‹</div>
                    <div id="card-back" style="display: none; color: #2E7D32;"></div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn" onclick="markWord('remembered')">âœ… è®°å¾—</button>
                    <button class="btn btn-blue" onclick="markWord('fuzzy')">ğŸ”„ æ¨¡ç³Š</button>
                    <button class="btn btn-red" onclick="markWord('forgot')">âŒ å¿˜è®°</button>
                    <button class="btn" onclick="nextWord()">è·³è¿‡</button>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-gold" onclick="toggleMode()">åˆ‡æ¢æ¨¡å¼</button>
                    <button class="btn btn-red" onclick="showMenu()">ç»“æŸè®­ç»ƒ</button>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666;">
                    <p>æ¨¡å¼ï¼š<span id="train-mode">è‹±æ–‡ â†’ ä¸­æ–‡</span></p>
                    <p id="word-hint">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
                </div>
            </div>
            
            <!-- ========== æ‰¹é‡æ·»åŠ  ========== -->
            <div id="batch-screen" class="screen">
                <h2>æ‰¹é‡æ·»åŠ å•è¯</h2>
                <p>æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªå•è¯ï¼Œè‹±æ–‡å’Œä¸­æ–‡ç”¨ç©ºæ ¼æˆ–å†’å·åˆ†éš”</p>
                <p>ç¤ºä¾‹ï¼šhello ä½ å¥½ æˆ– apple:è‹¹æœ æˆ– world=ä¸–ç•Œ</p>
                
                <textarea id="batch-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥å•è¯..."></textarea>
                
                <div style="text-align: center;">
                    <button class="btn" onclick="addBatchWords()">å¯¼å…¥å•è¯</button>
                    <button class="btn btn-blue" onclick="pasteFromClipboard()">ç²˜è´´</button>
                    <button class="btn btn-red" onclick="showMenu()">è¿”å›</button>
                </div>
                
                <div id="batch-result" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- ========== æˆ‘çš„å•è¯åº“ ========== -->
            <div id="words-screen" class="screen">
                <h2>æˆ‘çš„å•è¯åº“</h2>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="search-input" placeholder="æœç´¢å•è¯..." 
                           style="width:100%; padding:10px; border-radius:5px; border:1px solid #ddd;"
                           oninput="filterWords()">
                </div>
                
                <div id="words-list">
                    <p>æ­£åœ¨åŠ è½½å•è¯...</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-red" onclick="showMenu()">è¿”å›</button>
                </div>
            </div>
            
            <!-- ========== å­¦ç”Ÿç»Ÿè®¡ï¼ˆæ•™å¸ˆç”¨ï¼‰ ========== -->
            <div id="stats-screen" class="screen">
                <h2>ğŸ‘‘ å­¦ç”Ÿå­¦ä¹ æƒ…å†µ</h2>
                <p style="color: #666; margin-bottom: 20px;">æ•™å¸ˆï¼šKathyè€å¸ˆ | å¾®ä¿¡ï¼šKathy151</p>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="loadAllStudents()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    <button class="btn btn-red" onclick="showMenu()">è¿”å›</button>
                </div>
                
                <div id="students-data">
                    <p>æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</p>
                </div>
            </div>
            
            <!-- ========== è®¾ç½®é¡µé¢ ========== -->
            <div id="settings-screen" class="screen">
                <h2>è®¾ç½®</h2>
                
                <div class="stats-card">
                    <h3>è®­ç»ƒè®¾ç½®</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="auto-flip" checked> è‡ªåŠ¨ç¿»ç‰Œï¼ˆ3ç§’åæ˜¾ç¤ºç­”æ¡ˆï¼‰
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="sound-effect" checked> å¯ç”¨éŸ³æ•ˆ
                        </label>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>è”ç³»ä¿¡æ¯</h3>
                    <div class="wechat-contact" style="margin: 15px 0;">
                        ğŸ’¬ å¾®ä¿¡ï¼š<strong>Kathy151</strong>
                    </div>
                    <p style="color: #666;">å¦‚æœ‰é—®é¢˜è¯·è”ç³»è€å¸ˆ</p>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-blue" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn btn-red" onclick="showMenu()">è¿”å›</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€å˜é‡ ==========
        const SUPABASE_CONFIG = {
            url: 'https://lctdyhtydcqhloibogyj.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM'
        };
        
        const TEACHER_USERNAME = 'kathy151';
        
        let supabase = null;
        let currentUser = null;
        let isTeacher = false;
        let myWords = [];
        let trainingWords = [];
        let currentWordIndex = 0;
        let trainingMode = 'en_to_cn'; // en_to_cn æˆ– cn_to_en
        let cardFlipped = false;
        
        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // åˆå§‹åŒ–Supabase
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                console.log('âœ… Supabaseåˆå§‹åŒ–æˆåŠŸ');
                
                // æ£€æŸ¥æœ¬åœ°ä¿å­˜çš„ç”¨æˆ·
                const savedUser = localStorage.getItem('word_trainer_user');
                if (savedUser) {
                    currentUser = savedUser;
                    isTeacher = (currentUser === TEACHER_USERNAME);
                    
                    if (isTeacher) {
                        showMenu();
                    } else {
                        await loadUserData();
                        showMenu();
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('login-status', 'âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        });
        
        // ========== é¡µé¢åˆ‡æ¢å‡½æ•° ==========
        function showScreen(screenId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const target = document.getElementById(screenId);
            if (target) {
                target.classList.add('active');
                
                // é¡µé¢ç‰¹å®šåˆå§‹åŒ–
                if (screenId === 'menu-screen') {
                    updateMenu();
                } else if (screenId === 'words-screen') {
                    showWordsList();
                } else if (screenId === 'stats-screen' && isTeacher) {
                    loadAllStudents();
                }
            }
        }
        
        function showMenu() {
            showScreen('menu-screen');
        }
        
        function showLogin() {
            showScreen('login-screen');
        }
        
        // ========== ç”¨æˆ·ç›¸å…³å‡½æ•° ==========
        async function login() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            showMessage('login-status', 'ğŸ”„ æ­£åœ¨ç™»å½•...');
            
            try {
                currentUser = username;
                isTeacher = (username === TEACHER_USERNAME);
                
                if (isTeacher) {
                    // æ•™å¸ˆç™»å½•
                    localStorage.setItem('word_trainer_user', username);
                    showMenu();
                    showMessage('login-status', 'âœ… æ•™å¸ˆç™»å½•æˆåŠŸ');
                } else {
                    // å­¦ç”Ÿç™»å½•
                    const { data, error } = await supabase
                        .from('users')
                        .select('username')
                        .eq('username', username)
                        .single();
                    
                    if (error || !data) {
                        // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦åˆ›å»º
                        if (confirm(`ç”¨æˆ·"${username}"ä¸å­˜åœ¨ï¼Œæ˜¯å¦åˆ›å»ºæ–°ç”¨æˆ·ï¼Ÿ`)) {
                            await createUser();
                            return;
                        } else {
                            currentUser = null;
                            showMessage('login-status', 'âŒ ç”¨æˆ·ä¸å­˜åœ¨');
                            return;
                        }
                    }
                    
                    // ç™»å½•æˆåŠŸ
                    localStorage.setItem('word_trainer_user', username);
                    await loadUserData();
                    showMenu();
                    showMessage('login-status', 'âœ… ç™»å½•æˆåŠŸ');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showMessage('login-status', 'âŒ ç™»å½•å¤±è´¥: ' + error.message);
            }
        }
        
        async function createUser() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            if (username.length < 2) {
                alert('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
                return;
            }
            
            if (username.toLowerCase() === TEACHER_USERNAME.toLowerCase()) {
                alert('è¯¥ç”¨æˆ·åä¸å¯ç”¨');
                return;
            }
            
            showMessage('login-status', 'ğŸ”„ æ­£åœ¨åˆ›å»ºç”¨æˆ·...');
            
            try {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const { data: existing } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();
                
                if (existing) {
                    alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•');
                    showMessage('login-status', 'âŒ ç”¨æˆ·åå·²å­˜åœ¨');
                    return;
                }
                
                // åˆ›å»ºç”¨æˆ·
                const newUser = {
                    username: username,
                    created_at: new Date().toISOString(),
                    total_words: 0,
                    learned_words: 0,
                    reviewing_words: 0,
                    new_words: 0,
                    last_login: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('users')
                    .insert([newUser]);
                
                if (error) throw error;
                
                // åˆå§‹åŒ–å•è¯æ•°æ®
                try {
                    await supabase
                        .from('user_words')
                        .insert([{
                            username: username,
                            words: [],
                            updated_at: new Date().toISOString()
                        }]);
                } catch (wordsError) {
                    console.log('åˆå§‹åŒ–å•è¯è¡¨å¯èƒ½ä¸å­˜åœ¨:', wordsError);
                }
                
                // ç™»å½•æ–°ç”¨æˆ·
                currentUser = username;
                isTeacher = false;
                localStorage.setItem('word_trainer_user', username);
                
                alert(`âœ… æ¬¢è¿ ${username} åŠ å…¥Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ï¼`);
                showMenu();
                showMessage('login-status', 'âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
                
            } catch (error) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
                showMessage('login-status', 'âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
                
                // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæç¤ºåˆ›å»ºè¡¨
                if (error.code === '42P01') {
                    if (confirm('æ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼Œæ˜¯å¦å°è¯•åˆ›å»ºè¡¨ï¼Ÿ')) {
                        await createDatabaseTables();
                    }
                }
            }
        }
        
        async function createDatabaseTables() {
            const sql = `
-- 1. åˆ›å»ºusersè¡¨
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    total_words INTEGER DEFAULT 0,
    learned_words INTEGER DEFAULT 0,
    reviewing_words INTEGER DEFAULT 0,
    new_words INTEGER DEFAULT 0,
    last_login TIMESTAMP
);

-- 2. åˆ›å»ºuser_wordsè¡¨
CREATE TABLE IF NOT EXISTS user_words (
    id SERIAL PRIMARY KEY,
    username TEXT NOT NULL,
    words JSONB DEFAULT '[]',
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 3. å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_words ENABLE ROW LEVEL SECURITY;

-- 4. åˆ›å»ºè®¿é—®ç­–ç•¥
CREATE POLICY "å…è®¸æ‰€æœ‰äººè®¿é—®usersè¡¨" ON users
    FOR ALL USING (true);

CREATE POLICY "å…è®¸æ‰€æœ‰äººè®¿é—®user_wordsè¡¨" ON user_words
    FOR ALL USING (true);
            `;
            
            alert(`è¯·ç™»å½•Supabaseï¼Œåœ¨SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

${sql}

æ‰§è¡Œååˆ·æ–°é¡µé¢å³å¯ä½¿ç”¨ã€‚`);
        }
        
        async function loadUserData() {
            if (!currentUser || isTeacher) return;
            
            try {
                // åŠ è½½å•è¯æ•°æ®
                const { data, error } = await supabase
                    .from('user_words')
                    .select('words')
                    .eq('username', currentUser)
                    .single();
                
                if (error) {
                    console.log('åŠ è½½å•è¯æ•°æ®å¤±è´¥ï¼Œå¯èƒ½è¡¨ä¸å­˜åœ¨:', error);
                    myWords = [];
                } else {
                    myWords = data?.words || [];
                }
                
                // æ›´æ–°æœ€åç™»å½•æ—¶é—´
                await supabase
                    .from('users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('username', currentUser);
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                myWords = [];
            }
        }
        
        async function saveUserData() {
            if (!currentUser || isTeacher) return;
            
            try {
                const { error } = await supabase
                    .from('user_words')
                    .upsert([{
                        username: currentUser,
                        words: myWords,
                        updated_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const stats = {
                    total_words: myWords.length,
                    learned_words: myWords.filter(w => w.status === 'remembered').length,
                    reviewing_words: myWords.filter(w => w.status === 'fuzzy').length,
                    new_words: myWords.filter(w => !w.status || w.status === 'forgot').length
                };
                
                await supabase
                    .from('users')
                    .update(stats)
                    .eq('username', currentUser);
                
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }
        
        function updateMenu() {
            const welcomeMsg = document.getElementById('welcome-message');
            const teacherPanel = document.getElementById('teacher-panel');
            const studentPanel = document.getElementById('student-panel');
            const statsDiv = document.getElementById('user-stats');
            
            if (isTeacher) {
                welcomeMsg.textContent = `ğŸ‘‘ æ¬¢è¿ï¼ŒKathyè€å¸ˆï¼`;
                teacherPanel.style.display = 'block';
                studentPanel.style.display = 'none';
            } else {
                welcomeMsg.textContent = `ğŸ“ æ¬¢è¿ï¼Œ${currentUser}ï¼`;
                teacherPanel.style.display = 'none';
                studentPanel.style.display = 'block';
                
                // æ›´æ–°å­¦ç”Ÿç»Ÿè®¡
                const total = myWords.length;
                const remembered = myWords.filter(w => w.status === 'remembered').length;
                const fuzzy = myWords.filter(w => w.status === 'fuzzy').length;
                const progress = total > 0 ? Math.round((remembered / total) * 100) : 0;
                
                statsDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-around; margin: 15px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; color: #2196F3;">${total}</div>
                            <div style="font-size: 0.8em;">å•è¯æ€»æ•°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; color: #4CAF50;">${remembered}</div>
                            <div style="font-size: 0.8em;">å·²æŒæ¡</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; color: #FF9800;">${progress}%</div>
                            <div style="font-size: 0.8em;">æŒæ¡è¿›åº¦</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // ========== å•è¯è®­ç»ƒåŠŸèƒ½ ==========
        function startTraining() {
            if (myWords.length === 0) {
                alert('è¯·å…ˆæ·»åŠ å•è¯');
                return;
            }
            
            trainingWords = [...myWords];
            if (trainingWords.length === 0) {
                alert('æ²¡æœ‰å¯è®­ç»ƒçš„å•è¯');
                return;
            }
            
            // éšæœºæ’åº
            trainingWords.sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
            trainingMode = 'en_to_cn';
            cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
        }
        
        function showCurrentWord() {
            if (currentWordIndex >= trainingWords.length) {
                // è®­ç»ƒå®Œæˆ
                document.getElementById('card-front').textContent = 'ğŸ‰ è®­ç»ƒå®Œæˆï¼';
                document.getElementById('card-back').style.display = 'none';
                document.getElementById('word-card').classList.remove('flipped');
                document.getElementById('progress-text').textContent = 'è®­ç»ƒå®Œæˆï¼';
                document.getElementById('train-progress').style.width = '100%';
                return;
            }
            
            const word = trainingWords[currentWordIndex];
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            // é‡ç½®å¡ç‰‡çŠ¶æ€
            wordCard.classList.remove('flipped');
            cardFlipped = false;
            cardBack.style.display = 'none';
            
            // æ ¹æ®æ¨¡å¼æ˜¾ç¤º
            if (trainingMode === 'en_to_cn') {
                cardFront.textContent = word.english;
                cardBack.textContent = word.chinese;
                document.getElementById('train-mode').textContent = 'è‹±æ–‡ â†’ ä¸­æ–‡';
                document.getElementById('word-hint').textContent = 'ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€';
            } else {
                cardFront.textContent = word.chinese;
                cardBack.textContent = word.english;
                document.getElementById('train-mode').textContent = 'ä¸­æ–‡ â†’ è‹±æ–‡';
                document.getElementById('word-hint').textContent = 'ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è‹±æ–‡å•è¯';
            }
            
            // æ›´æ–°è¿›åº¦
            const progress = ((currentWordIndex + 1) / trainingWords.length) * 100;
            document.getElementById('progress-text').textContent = 
                `è¿›åº¦: ${currentWordIndex + 1}/${trainingWords.length}`;
            document.getElementById('train-progress').style.width = `${progress}%`;
        }
        
        function flipCard() {
            if (currentWordIndex >= trainingWords.length) return;
            
            const cardBack = document.getElementById('card-back');
            const wordCard = document.getElementById('word-card');
            
            if (!cardFlipped) {
                cardBack.style.display = 'block';
                wordCard.classList.add('flipped');
                cardFlipped = true;
            } else {
                cardBack.style.display = 'none';
                wordCard.classList.remove('flipped');
                cardFlipped = false;
            }
        }
        
        function toggleMode() {
            trainingMode = trainingMode === 'en_to_cn' ? 'cn_to_en' : 'en_to_cn';
            cardFlipped = false;
            showCurrentWord();
        }
        
        async function markWord(status) {
            if (currentWordIndex >= trainingWords.length) return;
            
            const word = trainingWords[currentWordIndex];
            word.status = status;
            word.reviewCount = (word.reviewCount || 0) + 1;
            word.lastReview = new Date().toISOString();
            
            // æ›´æ–°åŸå§‹æ•°æ®
            const index = myWords.findIndex(w => w.english === word.english);
            if (index !== -1) {
                myWords[index] = word;
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await saveUserData();
            
            // ä¸‹ä¸€ä¸ªå•è¯
            currentWordIndex++;
            cardFlipped = false;
            setTimeout(showCurrentWord, 300);
        }
        
        function nextWord() {
            currentWordIndex++;
            cardFlipped = false;
            showCurrentWord();
        }
        
        // ========== æ‰¹é‡æ·»åŠ å•è¯ ==========
        function showBatchAdd() {
            document.getElementById('batch-input').value = '';
            document.getElementById('batch-result').style.display = 'none';
            showScreen('batch-screen');
        }
        
        function pasteFromClipboard() {
            if (navigator.clipboard) {
                navigator.clipboard.readText()
                    .then(text => {
                        document.getElementById('batch-input').value = text;
                    })
                    .catch(() => {
                        alert('æ— æ³•è®¿é—®å‰ªè´´æ¿');
                    });
            } else {
                alert('æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿è®¿é—®');
            }
        }
        
        async function addBatchWords() {
            const input = document.getElementById('batch-input').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            const lines = input.split('\n');
            let added = 0;
            let errors = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // è§£æå•è¯
                let english = '', chinese = '';
                const separators = [' ', ':', '=', ',', '\t'];
                
                for (const sep of separators) {
                    if (trimmed.includes(sep)) {
                        const parts = trimmed.split(sep);
                        if (parts.length >= 2) {
                            english = parts[0].trim();
                            chinese = parts.slice(1).join(sep).trim();
                            break;
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰åˆ†éš”ç¬¦ï¼Œå°è¯•æŒ‰ç©ºæ ¼åˆ†å‰²
                if (!english || !chinese) {
                    const parts = trimmed.split(/\s+/);
                    if (parts.length >= 2) {
                        english = parts[0];
                        chinese = parts.slice(1).join(' ');
                    }
                }
                
                if (english && chinese) {
                    // æ£€æŸ¥æ˜¯å¦é‡å¤
                    const exists = myWords.some(w => 
                        w.english.toLowerCase() === english.toLowerCase());
                    
                    if (!exists) {
                        myWords.push({
                            english: english,
                            chinese: chinese,
                            status: 'forgot',
                            reviewCount: 0,
                            lastReview: null,
                            addedDate: new Date().toISOString()
                        });
                        added++;
                    }
                } else {
                    errors.push(trimmed);
                }
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await saveUserData();
            
            // æ˜¾ç¤ºç»“æœ
            const resultDiv = document.getElementById('batch-result');
            resultDiv.innerHTML = `
                <h4>ğŸ“¥ å¯¼å…¥ç»“æœ</h4>
                <p>âœ… æˆåŠŸæ·»åŠ : ${added} ä¸ªæ–°å•è¯</p>
                ${errors.length > 0 ? `<p>âŒ æ ¼å¼é”™è¯¯: ${errors.length} è¡Œ</p>` : ''}
                <p>ğŸ“Š å½“å‰å•è¯æ€»æ•°: ${myWords.length}</p>
                ${added > 0 ? '<p>ğŸ’¡ ç°åœ¨å¯ä»¥å¼€å§‹è®­ç»ƒäº†ï¼</p>' : ''}
            `;
            resultDiv.style.display = 'block';
            
            if (added > 0) {
                updateMenu();
                document.getElementById('batch-input').value = '';
            }
        }
        
        // ========== å•è¯åº“ç®¡ç† ==========
        async function showMyWords() {
            await loadUserData();
            showScreen('words-screen');
        }
        
        function showWordsList() {
            const wordsList = document.getElementById('words-list');
            
            if (myWords.length === 0) {
                wordsList.innerHTML = '<p>è¿˜æ²¡æœ‰æ·»åŠ å•è¯ï¼Œå¿«å»æ‰¹é‡æ·»åŠ å§ï¼</p>';
                return;
            }
            
            let html = `
                <p>ğŸ“š å…± ${myWords.length} ä¸ªå•è¯</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>çŠ¶æ€</th>
                            <th>å¤ä¹ æ¬¡æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            myWords.forEach((word, index) => {
                const statusText = {
                    'remembered': '<span style="color:#4CAF50">âœ… è®°å¾—</span>',
                    'fuzzy': '<span style="color:#FF9800">ğŸ”„ æ¨¡ç³Š</span>',
                    'forgot': '<span style="color:#F44336">âŒ å¿˜è®°</span>'
                }[word.status] || '<span style="color:#666">æœªå­¦ä¹ </span>';
                
                html += `
                    <tr>
                        <td><strong>${word.english}</strong></td>
                        <td>${word.chinese}</td>
                        <td>${statusText}</td>
                        <td>${word.reviewCount || 0}</td>
                        <td>
                            <button class="btn" style="padding:5px 10px; font-size:0.8em;" 
                                    onclick="deleteWord(${index})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            wordsList.innerHTML = html;
        }
        
        async function deleteWord(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) {
                myWords.splice(index, 1);
                await saveUserData();
                showWordsList();
            }
        }
        
        function filterWords() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#words-list tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // ========== æ•™å¸ˆåŠŸèƒ½ ==========
        async function showStudentStats() {
            if (!isTeacher) return;
            showScreen('stats-screen');
        }
        
        async function loadAllStudents() {
            if (!isTeacher) return;
            
            try {
                const { data: students, error } = await supabase
                    .from('users')
                    .select('*')
                    .neq('username', TEACHER_USERNAME)
                    .order('last_login', { ascending: false });
                
                if (error) throw error;
                
                const studentsDiv = document.getElementById('students-data');
                
                if (!students || students.length === 0) {
                    studentsDiv.innerHTML = '<p>è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>';
                    return;
                }
                
                let html = '<table class="data-table">';
                html += `
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>å•è¯æ•°</th>
                            <th>å·²æŒæ¡</th>
                            <th>å­¦ä¹ ä¸­</th>
                            <th>æœªæŒæ¡</th>
                            <th>æœ€åç™»å½•</th>
                            <th>è¯¦æƒ…</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                for (const student of students) {
                    // è·å–å­¦ç”Ÿçš„å•è¯æ•°æ®
                    let wordCount = 0;
                    try {
                        const { data: wordData } = await supabase
                            .from('user_words')
                            .select('words')
                            .eq('username', student.username)
                            .single();
                        
                        if (wordData && wordData.words) {
                            const words = wordData.words;
                            wordCount = words.length;
                            const remembered = words.filter(w => w.status === 'remembered').length;
                            const fuzzy = words.filter(w => w.status === 'fuzzy').length;
                            const forgot = words.filter(w => !w.status || w.status === 'forgot').length;
                            
                            html += `
                                <tr>
                                    <td><strong>${student.username}</strong></td>
                                    <td>${wordCount}</td>
                                    <td style="color:#4CAF50">${remembered}</td>
                                    <td style="color:#FF9800">${fuzzy}</td>
                                    <td style="color:#F44336">${forgot}</td>
                                    <td>${student.last_login ? new Date(student.last_login).toLocaleDateString() : 'ä»æœª'}</td>
                                    <td>
                                        <button class="btn" style="padding:5px 10px; font-size:0.8em;"
                                                onclick="viewStudentDetail('${student.username}')">æŸ¥çœ‹</button>
                                    </td>
                                </tr>
                            `;
                        }
                    } catch (e) {
                        console.log(`è·å–å­¦ç”Ÿ${student.username}æ•°æ®å¤±è´¥:`, e);
                    }
                }
                
                html += '</tbody></table>';
                studentsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
                document.getElementById('students-data').innerHTML = 
                    `<p style="color:red">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        async function viewStudentDetail(username) {
            try {
                const { data } = await supabase
                    .from('user_words')
                    .select('words')
                    .eq('username', username)
                    .single();
                
                const words = data?.words || [];
                
                let detailHtml = `<h3>${username} çš„å•è¯è¯¦æƒ…ï¼ˆ${words.length}ä¸ªï¼‰</h3>`;
                
                if (words.length > 0) {
                    detailHtml += '<div style="max-height: 300px; overflow-y: auto;">';
                    detailHtml += '<table class="data-table">';
                    detailHtml += `
                        <thead>
                            <tr>
                                <th>è‹±æ–‡</th>
                                <th>ä¸­æ–‡</th>
                                <th>çŠ¶æ€</th>
                                <th>å¤ä¹ æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    words.forEach(word => {
                        const statusText = {
                            'remembered': '<span style="color:#4CAF50">âœ… è®°å¾—</span>',
                            'fuzzy': '<span style="color:#FF9800">ğŸ”„ æ¨¡ç³Š</span>',
                            'forgot': '<span style="color:#F44336">âŒ å¿˜è®°</span>'
                        }[word.status] || '<span style="color:#666">æœªå­¦ä¹ </span>';
                        
                        detailHtml += `
                            <tr>
                                <td>${word.english}</td>
                                <td>${word.chinese}</td>
                                <td>${statusText}</td>
                                <td>${word.reviewCount || 0}</td>
                            </tr>
                        `;
                    });
                    
                    detailHtml += '</tbody></table></div>';
                } else {
                    detailHtml += '<p>è¯¥å­¦ç”Ÿè¿˜æ²¡æœ‰æ·»åŠ å•è¯</p>';
                }
                
                detailHtml += '<button class="btn btn-red" onclick="loadAllStudents()" style="margin-top:20px;">è¿”å›åˆ—è¡¨</button>';
                
                document.getElementById('students-data').innerHTML = detailHtml;
                
            } catch (error) {
                console.error('æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…å¤±è´¥:', error);
            }
        }
        
        // ========== å…¶ä»–åŠŸèƒ½ ==========
        function showSettings() {
            showScreen('settings-screen');
        }
        
        function saveSettings() {
            alert('è®¾ç½®å·²ä¿å­˜');
            showMenu();
        }
        
        function showAllWords() {
            // æ•™å¸ˆæŸ¥çœ‹æ‰€æœ‰å•è¯çš„åŠŸèƒ½
            alert('æ­¤åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        function logout() {
            currentUser = null;
            isTeacher = false;
            myWords = [];
            localStorage.removeItem('word_trainer_user');
            document.getElementById('username').value = '';
            showLogin();
        }
        
        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                element.innerHTML = message;
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }
        }
        
        // ç»‘å®šå›è½¦é”®
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
