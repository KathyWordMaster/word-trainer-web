<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - æ™ºèƒ½è‹±è¯­å­¦ä¹ ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        .login-form { text-align: center; }
        .login-form input { width: 300px; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; margin: 10px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #45a049; }
        .btn-blue { background: #2196F3; }
        .btn-red { background: #F44336; }
        .btn-purple { background: #9C27B0; }
        .btn-gold { background: #F1C40F; color: #2C3E50; }
        
        .word-card { 
            background: white; 
            border: 3px solid #4CAF50; 
            border-radius: 15px; 
            height: 200px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px 0; 
            cursor: pointer; 
            font-size: 2em;
            transition: all 0.3s;
        }
        
        .word-card.flipped {
            background: #E8F5E9;
            border-color: #2E7D32;
        }
        
        .admin-panel { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .stats-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .stats-table th { background: #4CAF50; color: white; }
        .stats-table tr:hover { background: #f5f5f5; }
        
        .batch-textarea { width: 100%; height: 200px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; margin: 20px 0; font-family: monospace; }
        
        /* è”ç³»ä¿¡æ¯æ ·å¼ */
        .contact-info {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
            border-left: 5px solid #F1C40F;
        }
        
        .contact-info h3 {
            color: #2C3E50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .wechat-contact {
            background: #07C160;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
        }
        
        .teacher-contact {
            background: #FF9800;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin: 5px 0;
            font-weight: bold;
        }
        
        .features {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .feature {
            background: #E3F2FD;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #90CAF9;
            font-size: 0.9em;
            color: #1565C0;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }
        
        /* å•è¯ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 600px) {
            .login-form input { width: 100%; }
            .container { margin: 10px; }
            .features { flex-direction: column; }
            .word-card { height: 150px; font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">å¿«æ¥èƒŒå•è¯ï¼</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">æ™ºèƒ½è®°å¿†ç³»ç»Ÿ Â· æ•™å¸ˆç›‘æ§ Â· é«˜æ•ˆå­¦ä¹ </p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div class="login-form">
                    <h2>ç”¨æˆ·ç™»å½• / æ³¨å†Œ</h2>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" autofocus>
                    <div style="margin: 20px 0;">
                        <button class="btn" onclick="login()">ç™»å½•</button>
                        <button class="btn btn-blue" onclick="createUser()">æ–°ç”¨æˆ·æ³¨å†Œ</button>
                    </div>
                    
                    <!-- åŠŸèƒ½ç‰¹ç‚¹å±•ç¤º -->
                    <div class="features">
                        <div class="feature">ğŸ“š æ™ºèƒ½é—ªå¡è®°å¿†</div>
                        <div class="feature">ğŸ“ˆ å­¦ä¹ è¿›åº¦è¿½è¸ª</div>
                        <div class="feature">ğŸ‘¥ å¤šç”¨æˆ·æ”¯æŒ</div>
                        <div class="feature">ğŸ‘‘ æ•™å¸ˆç›‘ç®¡</div>
                    </div>
                    
                    <!-- è”ç³»ä¿¡æ¯ -->
                    <div class="contact-info">
                        <h3>ğŸ“ è”ç³»æˆ‘ä»¬</h3>
                        <p style="color: #555; margin-bottom: 15px;">å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·è”ç³»ï¼š</p>
                        
                        <div class="wechat-contact">
                            <span>å¾®ä¿¡è”ç³»ï¼š</span>
                            <strong>Kathy151</strong>
                        </div>
                        
                        <div class="teacher-contact">
                            ğŸ‘©â€ğŸ« Kathyè€å¸ˆä¸“å±è®­ç»ƒç³»ç»Ÿ
                        </div>
                    </div>
                    
                    <p style="color: #666; margin-top: 20px; font-size: 0.9em;">
                        å­¦ç”Ÿè¯·è¾“å…¥ç”¨æˆ·åæ³¨å†Œï¼Œæ•™å¸ˆè¯·ä½¿ç”¨ä¸“å±è´¦å·ç™»å½•
                    </p>
                </div>
            </div>
            
            <!-- ä¸»èœå• -->
            <div id="menu-screen" class="screen">
                <h2 id="welcome-message"></h2>
                
                <!-- æ•™å¸ˆç®¡ç†å…¥å£ -->
                <div id="teacher-section" style="display: none;" class="admin-panel">
                    <h3>ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h3>
                    <button class="btn btn-purple" onclick="showTeacherPanel()">æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿå­¦ä¹ æƒ…å†µ</button>
                    <button class="btn btn-blue" onclick="showTeacherStats()">æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡</button>
                    <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        <p>ğŸ‘©â€ğŸ« æ•™å¸ˆï¼šKathyè€å¸ˆ</p>
                        <p>ğŸ“ è”ç³»æ–¹å¼ï¼šå¾®ä¿¡ Kathy151</p>
                    </div>
                </div>
                
                <!-- å­¦ç”ŸåŠŸèƒ½ -->
                <div id="student-section" style="display: none;">
                    <!-- å­¦ä¹ ç»Ÿè®¡ -->
                    <div id="learning-stats" class="stats-card" style="margin-bottom: 20px;">
                        <h3>ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                        <div id="stats-content">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="btn" onclick="showBatchAdd()">ğŸ“ æ‰¹é‡æ·»åŠ å•è¯</button>
                        <button class="btn btn-blue" onclick="startTraining()">ğŸ¯ å¼€å§‹è®­ç»ƒ</button>
                        <button class="btn" onclick="showMyWords()">ğŸ“– æˆ‘çš„å•è¯åº“</button>
                        <button class="btn btn-red" onclick="logout()">é€€å‡º</button>
                    </div>
                    
                    <!-- å­¦ç”Ÿè”ç³»ä¿¡æ¯ -->
                    <div class="contact-info">
                        <h3>ğŸ’¡ å­¦ä¹ å¸®åŠ©</h3>
                        <p>å­¦ä¹ ä¸­é‡åˆ°é—®é¢˜ï¼Ÿéœ€è¦æ›´å¤šå•è¯åº“ï¼Ÿ</p>
                        <div class="wechat-contact">
                            è”ç³»è€å¸ˆå¾®ä¿¡ï¼š<strong>Kathy151</strong>
                        </div>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                            æ·»åŠ æ—¶è¯·å¤‡æ³¨ï¼šå•è¯è®­ç»ƒè¥ + æ‚¨çš„ç”¨æˆ·å
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆç›‘ç®¡é¢æ¿ -->
            <div id="teacher-screen" class="screen">
                <h2>ğŸ‘‘ å­¦ç”Ÿå­¦ä¹ æƒ…å†µç›‘ç®¡</h2>
                <div style="color: #666; margin-bottom: 20px;">
                    <p>ğŸ‘©â€ğŸ« æ•™å¸ˆï¼šKathyè€å¸ˆ | ğŸ“ å¾®ä¿¡ï¼šKathy151</p>
                </div>
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="loadStudentStats()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    <button class="btn btn-red" onclick="showMenu()">è¿”å›ä¸»èœå•</button>
                </div>
                <div id="students-data">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            </div>
            
            <!-- æ‰¹é‡æ·»åŠ  -->
            <div id="batch-screen" class="screen">
                <h2>æ‰¹é‡æ·»åŠ å•è¯</h2>
                <p>æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªå•è¯ï¼Œè‹±æ–‡å’Œä¸­æ–‡ç”¨ç©ºæ ¼ã€å†’å·æˆ–ç­‰å·åˆ†éš”</p>
                <p>ç¤ºä¾‹ï¼šhello ä½ å¥½ æˆ– apple:è‹¹æœ æˆ– world=ä¸–ç•Œ</p>
                <textarea id="batch-input" class="batch-textarea" placeholder="åœ¨è¿™é‡Œç²˜è´´æˆ–è¾“å…¥å•è¯..."></textarea>
                <div>
                    <button class="btn" onclick="addBatchWords()">å¯¼å…¥å•è¯</button>
                    <button class="btn btn-blue" onclick="pasteText()">ç²˜è´´</button>
                    <button class="btn btn-red" onclick="showMenu()">è¿”å›</button>
                </div>
                <div id="batch-result" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- è®­ç»ƒç•Œé¢ -->
            <div id="train-screen" class="screen">
                <h2>å•è¯è®­ç»ƒ</h2>
                <div style="text-align: center; color: #666; margin: 10px 0;" id="progress"></div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="word-card" class="word-card" onclick="flipCard()">
                    <div id="card-front">ç‚¹å‡»å¼€å§‹è®­ç»ƒ</div>
                    <div id="card-back" style="display: none;"></div>
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn" onclick="markWord('remembered')">âœ… è®°å¾—</button>
                    <button class="btn btn-blue" onclick="markWord('fuzzy')">ğŸ”„ æ¨¡ç³Š</button>
                    <button class="btn btn-red" onclick="markWord('forgot')">âŒ å¿˜è®°</button>
                    <button class="btn" onclick="nextWord()">è·³è¿‡</button>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-gold" onclick="toggleTrainMode()">ğŸ” åˆ‡æ¢æ¨¡å¼</button>
                    <button class="btn btn-red" onclick="showMenu()">ç»“æŸè®­ç»ƒ</button>
                </div>
                <div style="margin-top: 20px; color: #666; font-size: 0.9em;">
                    æ¨¡å¼ï¼š<span id="train-mode">è‹±æ–‡ â†’ ä¸­æ–‡</span> | 
                    å•è¯æ€»æ•°ï¼š<span id="total-words">0</span>
                </div>
            </div>
            
            <!-- æˆ‘çš„å•è¯åº“ -->
            <div id="words-screen" class="screen">
                <h2>æˆ‘çš„å•è¯åº“</h2>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="search-word" placeholder="æœç´¢å•è¯..." style="width: 100%; padding: 10px;" oninput="searchWords()">
                </div>
                <div id="my-words-list">æ­£åœ¨åŠ è½½...</div>
                <button class="btn btn-red" onclick="showMenu()" style="margin-top: 20px;">è¿”å›</button>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ ã€é‡è¦ã€‘Supabaseé…ç½® âš ï¸
        const SUPABASE_CONFIG = {
            url: 'https://lctdyhtydcqhloibogyj.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM'
        };
        
        // ğŸ‘‘ æ•™å¸ˆé…ç½®
        const TEACHER_CONFIG = {
            username: 'kathy151',
            password: '',
            displayName: 'Kathyè€å¸ˆ',
            contactWeChat: 'Kathy151'
        };
        
        // åˆå§‹åŒ–å˜é‡
        let supabase = null;
        let currentUser = null;
        let isTeacher = false;
        let myWords = []; // å•è¯æ•°ç»„
        let trainingWords = []; // è®­ç»ƒä¸­çš„å•è¯
        let currentWordIndex = 0;
        let trainMode = 'en_to_cn'; // è®­ç»ƒæ¨¡å¼ï¼šen_to_cnï¼ˆè‹±æ–‡åˆ°ä¸­æ–‡ï¼‰æˆ– cn_to_enï¼ˆä¸­æ–‡åˆ°è‹±æ–‡ï¼‰
        let cardFlipped = false;
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        async function initApp() {
            try {
                // åˆå§‹åŒ–Supabaseè¿æ¥
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
                
                // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·
                const savedUser = localStorage.getItem('word_trainer_user');
                if (savedUser) {
                    currentUser = savedUser;
                    isTeacher = (currentUser === TEACHER_CONFIG.username);
                    await loadUserData();
                    showMenu();
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // ç™»å½•å‡½æ•°
        async function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            currentUser = username;
            isTeacher = (username === TEACHER_CONFIG.username);
            
            try {
                if (isTeacher) {
                    // æ•™å¸ˆç™»å½•
                    if (TEACHER_CONFIG.password) {
                        const password = prompt('ğŸ” è¯·è¾“å…¥æ•™å¸ˆå¯†ç ï¼š');
                        if (password !== TEACHER_CONFIG.password) {
                            alert('âŒ å¯†ç é”™è¯¯');
                            currentUser = null;
                            isTeacher = false;
                            document.getElementById('username').value = '';
                            return;
                        }
                    }
                    
                    localStorage.setItem('word_trainer_user', username);
                    showMenu();
                    
                } else {
                    // å­¦ç”Ÿç™»å½•
                    const { data: existing, error } = await supabase
                        .from('users')
                        .select('username')
                        .eq('username', username)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') { // PGRST116è¡¨ç¤ºæ²¡æ‰¾åˆ°è®°å½•
                        alert('ç™»å½•å¤±è´¥: ' + error.message);
                        return;
                    }
                    
                    if (!existing) {
                        alert('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');
                        return;
                    }
                    
                    localStorage.setItem('word_trainer_user', username);
                    await loadUserData();
                    showMenu();
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                console.error('ç™»å½•é”™è¯¯:', error);
            }
        }
        
        // åˆ›å»ºç”¨æˆ·
        async function createUser() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            if (username.length < 2) {
                alert('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¿ç•™ç”¨æˆ·å
            if (['teacher', 'admin', 'kathy'].includes(username.toLowerCase())) {
                alert('âš ï¸ è¯¥ç”¨æˆ·åä¸å¯ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å');
                return;
            }
            
            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                const { data: existing } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();
                
                if (existing) {
                    alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•');
                    return;
                }
                
                // åˆ›å»ºæ–°ç”¨æˆ·
                const newUser = {
                    username: username,
                    created_at: new Date().toISOString(),
                    total_words: 0,
                    learned_words: 0,
                    reviewing_words: 0,
                    new_words: 0,
                    last_login: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('users')
                    .insert([newUser]);
                
                if (error) throw error;
                
                // åˆå§‹åŒ–å•è¯æ•°æ®
                const { error: wordsError } = await supabase
                    .from('user_words')
                    .insert([{
                        username: username,
                        words: [],
                        updated_at: new Date().toISOString()
                    }]);
                
                if (wordsError) console.error('åˆå§‹åŒ–å•è¯æ•°æ®å¤±è´¥:', wordsError);
                
                currentUser = username;
                isTeacher = false;
                localStorage.setItem('word_trainer_user', username);
                
                alert(`âœ… æ¬¢è¿ ${username} åŠ å…¥Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ï¼`);
                showMenu();
                
            } catch (error) {
                alert('åˆ›å»ºç”¨æˆ·å¤±è´¥: ' + error.message);
                console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', error);
            }
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            if (!currentUser || isTeacher) return;
            
            try {
                // åŠ è½½å•è¯æ•°æ®
                const { data, error } = await supabase
                    .from('user_words')
                    .select('words')
                    .eq('username', currentUser)
                    .single();
                
                if (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    myWords = [];
                } else {
                    myWords = data?.words || [];
                    updateLearningStats();
                }
                
                // æ›´æ–°æœ€åç™»å½•æ—¶é—´
                await supabase
                    .from('users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('username', currentUser);
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                myWords = [];
            }
        }
        
        // æ›´æ–°å­¦ä¹ ç»Ÿè®¡
        function updateLearningStats() {
            if (isTeacher) return;
            
            const total = myWords.length;
            const remembered = myWords.filter(w => w.status === 'remembered').length;
            const fuzzy = myWords.filter(w => w.status === 'fuzzy').length;
            const forgot = myWords.filter(w => w.status === 'forgot' || !w.status).length;
            
            const rememberedPercent = total > 0 ? Math.round((remembered / total) * 100) : 0;
            
            const statsHtml = `
                <div style="display: flex; justify-content: space-around; margin: 15px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; color: #2196F3; font-weight: bold;">${total}</div>
                        <div style="font-size: 0.8em;">å•è¯æ€»æ•°</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; color: #4CAF50; font-weight: bold;">${remembered}</div>
                        <div style="font-size: 0.8em;">å·²æŒæ¡</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; color: #FF9800; font-weight: bold;">${fuzzy}</div>
                        <div style="font-size: 0.8em;">å­¦ä¹ ä¸­</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${rememberedPercent}%"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #666;">
                    æŒæ¡è¿›åº¦ï¼š${rememberedPercent}%
                </div>
            `;
            
            const statsElement = document.getElementById('stats-content');
            if (statsElement) {
                statsElement.innerHTML = statsHtml;
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
        async function saveData() {
            if (!currentUser || isTeacher) return;
            
            try {
                const { error } = await supabase
                    .from('user_words')
                    .upsert([{
                        username: currentUser,
                        words: myWords,
                        updated_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const stats = {
                    total_words: myWords.length,
                    learned_words: myWords.filter(w => w.status === 'remembered').length,
                    reviewing_words: myWords.filter(w => w.status === 'fuzzy').length,
                    new_words: myWords.filter(w => w.status === 'forgot' || !w.status).length
                };
                
                await supabase
                    .from('users')
                    .update(stats)
                    .eq('username', currentUser);
                
                updateLearningStats();
                
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ˜¾ç¤ºç•Œé¢
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'menu-screen') {
                updateMenu();
            }
        }
        
        function showMenu() {
            showScreen('menu-screen');
        }
        
        function updateMenu() {
            if (isTeacher) {
                document.getElementById('welcome-message').textContent = 
                    `ğŸ‘‘ æ¬¢è¿ï¼Œ${TEACHER_CONFIG.displayName}ï¼`;
                document.getElementById('teacher-section').style.display = 'block';
                document.getElementById('student-section').style.display = 'none';
            } else {
                document.getElementById('welcome-message').textContent = 
                    `ğŸ“ æ¬¢è¿ï¼Œ${currentUser}ï¼`;
                document.getElementById('teacher-section').style.display = 'none';
                document.getElementById('student-section').style.display = 'block';
            }
        }
        
        // å¼€å§‹è®­ç»ƒ
        async function startTraining() {
            if (myWords.length === 0) {
                alert('è¯·å…ˆæ·»åŠ å•è¯ï¼Œç„¶åå¼€å§‹è®­ç»ƒ');
                return;
            }
            
            // å‡†å¤‡è®­ç»ƒå•è¯
            trainingWords = [...myWords];
            trainingWords.sort(() => Math.random() - 0.5);
            
            currentWordIndex = 0;
            trainMode = 'en_to_cn';
            cardFlipped = false;
            
            showScreen('train-screen');
            showCurrentWord();
        }
        
        function showCurrentWord() {
            if (currentWordIndex >= trainingWords.length) {
                // è®­ç»ƒå®Œæˆ
                document.getElementById('card-front').textContent = 'ğŸ‰ è®­ç»ƒå®Œæˆï¼';
                document.getElementById('word-card').style.backgroundColor = '#E8F5E9';
                document.getElementById('progress').textContent = 'æ‰€æœ‰å•è¯è®­ç»ƒå®Œæˆ';
                document.getElementById('progress-fill').style.width = '100%';
                return;
            }
            
            const word = trainingWords[currentWordIndex];
            const card = document.getElementById('word-card');
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            
            // é‡ç½®å¡ç‰‡çŠ¶æ€
            card.classList.remove('flipped');
            cardFlipped = false;
            cardBack.style.display = 'none';
            
            // æ ¹æ®è®­ç»ƒæ¨¡å¼æ˜¾ç¤ºå†…å®¹
            if (trainMode === 'en_to_cn') {
                cardFront.textContent = word.english;
                cardBack.textContent = word.chinese;
                document.getElementById('train-mode').textContent = 'è‹±æ–‡ â†’ ä¸­æ–‡';
            } else {
                cardFront.textContent = word.chinese;
                cardBack.textContent = word.english;
                document.getElementById('train-mode').textContent = 'ä¸­æ–‡ â†’ è‹±æ–‡';
            }
            
            // æ›´æ–°è¿›åº¦
            const progress = ((currentWordIndex + 1) / trainingWords.length) * 100;
            document.getElementById('progress').textContent = 
                `è¿›åº¦: ${currentWordIndex + 1}/${trainingWords.length}`;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('total-words').textContent = trainingWords.length;
            
            // é‡ç½®å¡ç‰‡èƒŒæ™¯
            card.style.backgroundColor = 'white';
        }
        
        function flipCard() {
            if (currentWordIndex >= trainingWords.length) return;
            
            const card = document.getElementById('word-card');
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            
            if (!cardFlipped) {
                // ç¿»è½¬å¡ç‰‡
                card.classList.add('flipped');
                cardFront.style.display = 'none';
                cardBack.style.display = 'block';
                cardFlipped = true;
            } else {
                // ç¿»è½¬å›æ¥
                card.classList.remove('flipped');
                cardFront.style.display = 'block';
                cardBack.style.display = 'none';
                cardFlipped = false;
            }
        }
        
        function toggleTrainMode() {
            trainMode = trainMode === 'en_to_cn' ? 'cn_to_en' : 'en_to_cn';
            cardFlipped = false;
            showCurrentWord();
        }
        
        async function markWord(status) {
            if (currentWordIndex >= trainingWords.length) return;
            
            const word = trainingWords[currentWordIndex];
            
            // æ›´æ–°å•è¯çŠ¶æ€
            word.status = status;
            word.reviewCount = (word.reviewCount || 0) + 1;
            word.lastReview = new Date().toISOString();
            
            // æ›´æ–°åŸå§‹æ•°æ®
            const indexInMyWords = myWords.findIndex(w => w.english === word.english);
            if (indexInMyWords !== -1) {
                myWords[indexInMyWords] = word;
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await saveData();
            
            // ä¸‹ä¸€ä¸ªå•è¯
            currentWordIndex++;
            cardFlipped = false;
            setTimeout(showCurrentWord, 300);
        }
        
        function nextWord() {
            currentWordIndex++;
            cardFlipped = false;
            showCurrentWord();
        }
        
        // æ‰¹é‡æ·»åŠ å•è¯
        function showBatchAdd() {
            document.getElementById('batch-input').value = '';
            document.getElementById('batch-result').style.display = 'none';
            showScreen('batch-screen');
        }
        
        function pasteText() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('batch-input').value = text;
                })
                .catch(err => {
                    alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´');
                });
        }
        
        async function addBatchWords() {
            const input = document.getElementById('batch-input').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            const lines = input.split('\n');
            let added = 0;
            let errors = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // è§£æå•è¯
                let english = '', chinese = '';
                const separators = [' ', ':', '=', ',', '\t', 'ï¼š'];
                
                for (const sep of separators) {
                    if (trimmed.includes(sep)) {
                        const parts = trimmed.split(sep);
                        if (parts.length >= 2) {
                            english = parts[0].trim();
                            chinese = parts.slice(1).join(sep).trim();
                            break;
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰åˆ†éš”ç¬¦ï¼Œå°è¯•æŒ‰ç©ºæ ¼åˆ†å‰²
                if (!english && !chinese) {
                    const parts = trimmed.split(/\s+/);
                    if (parts.length >= 2) {
                        english = parts[0];
                        chinese = parts.slice(1).join(' ');
                    }
                }
                
                if (english && chinese) {
                    // æ£€æŸ¥æ˜¯å¦é‡å¤
                    const exists = myWords.some(w => w.english.toLowerCase() === english.toLowerCase());
                    if (!exists) {
                        myWords.push({
                            english: english,
                            chinese: chinese,
                            status: 'forgot',
                            reviewCount: 0,
                            lastReview: null,
                            addedDate: new Date().toISOString()
                        });
                        added++;
                    }
                } else {
                    errors.push(line);
                }
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await saveData();
            
            // æ˜¾ç¤ºç»“æœ
            const resultDiv = document.getElementById('batch-result');
            resultDiv.innerHTML = `
                <h4>ğŸ“¥ å¯¼å…¥ç»“æœ</h4>
                <p>âœ… æˆåŠŸæ·»åŠ : ${added} ä¸ªæ–°å•è¯</p>
                ${errors.length > 0 ? `<p>âŒ æ ¼å¼é”™è¯¯: ${errors.length} è¡Œï¼Œå·²å¿½ç•¥</p>` : ''}
                <p>ğŸ“Š å½“å‰å•è¯æ€»æ•°: ${myWords.length}</p>
                ${added > 0 ? '<p>ğŸ’¡ æç¤ºï¼šç°åœ¨å¯ä»¥å¼€å§‹è®­ç»ƒäº†ï¼</p>' : ''}
            `;
            resultDiv.style.display = 'block';
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            if (added > 0) {
                document.getElementById('batch-input').value = '';
            }
        }
        
        // æŸ¥çœ‹æˆ‘çš„å•è¯åº“
        async function showMyWords() {
            await loadUserData();
            
            let html = `<p>ğŸ“š æ‚¨å…±æœ‰ ${myWords.length} ä¸ªå•è¯</p>`;
            
            if (myWords.length > 0) {
                // ç»Ÿè®¡
                const remembered = myWords.filter(w => w.status === 'remembered').length;
                const fuzzy = myWords.filter(w => w.status === 'fuzzy').length;
                const forgot = myWords.filter(w => w.status === 'forgot' || !w.status).length;
                
                html += `
                    <div style="display: flex; justify-content: space-around; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; color: #4CAF50;">${remembered}</div>
                            <div style="font-size: 0.8em;">å·²æŒæ¡</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; color: #FF9800;">${fuzzy}</div>
                            <div style="font-size: 0.8em;">å­¦ä¹ ä¸­</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; color: #F44336;">${forgot}</div>
                            <div style="font-size: 0.8em;">æœªæŒæ¡</div>
                        </div>
                    </div>
                `;
                
                html += '<div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">';
                html += '<table class="stats-table">';
                html += `
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>çŠ¶æ€</th>
                            <th>å¤ä¹ æ¬¡æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                myWords.forEach((word, index) => {
                    const statusText = {
                        'remembered': 'âœ… è®°å¾—',
                        'fuzzy': 'ğŸ”„ æ¨¡ç³Š',
                        'forgot': 'âŒ å¿˜è®°'
                    }[word.status] || 'æœªå­¦ä¹ ';
                    
                    const statusColor = {
                        'remembered': '#4CAF50',
                        'fuzzy': '#FF9800',
                        'forgot': '#F44336'
                    }[word.status] || '#666';
                    
                    html += `
                        <tr>
                            <td>${word.english}</td>
                            <td>${word.chinese}</td>
                            <td style="color: ${statusColor};">${statusText}</td>
                            <td>${word.reviewCount || 0}</td>
                            <td><button class="btn" onclick="deleteWord(${index})" style="padding: 5px 10px; font-size: 0.8em;">åˆ é™¤</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                html += '</div>';
            }
            
            document.getElementById('my-words-list').innerHTML = html;
            showScreen('words-screen');
        }
        
        function searchWords() {
            const searchTerm = document.getElementById('search-word').value.toLowerCase();
            const rows = document.querySelectorAll('#my-words-list tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        async function deleteWord(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) {
                myWords.splice(index, 1);
                await saveData();
                showMyWords();
            }
        }
        
        // æ•™å¸ˆåŠŸèƒ½
        async function showTeacherPanel() {
            showScreen('teacher-screen');
            await loadStudentStats();
        }
        
        async function loadStudentStats() {
            try {
                const { data: students, error } = await supabase
                    .from('users')
                    .select('*')
                    .neq('username', TEACHER_CONFIG.username)
                    .order('last_login', { ascending: false });
                
                if (error) throw error;
                
                if (students.length === 0) {
                    document.getElementById('students-data').innerHTML = 
                        '<div style="text-align: center; padding: 40px; color: #666;">' +
                        '<h3>ğŸ“Š æš‚æ— å­¦ç”Ÿæ•°æ®</h3>' +
                        '<p>è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œå­¦ä¹ </p>' +
                        '</div>';
                    return;
                }
                
                let html = '<table class="stats-table">';
                html += `
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>å•è¯æ•°</th>
                            <th>å·²æŒæ¡</th>
                            <th>å­¦ä¹ ä¸­</th>
                            <th>æœªæŒæ¡</th>
                            <th>æœ€åç™»å½•</th>
                            <th>è¯¦æƒ…</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                for (const student of students) {
                    // è·å–å­¦ç”Ÿçš„å…·ä½“å•è¯æ•°æ®
                    const { data: wordData } = await supabase
                        .from('user_words')
                        .select('words')
                        .eq('username', student.username)
                        .single();
                    
                    const words = wordData?.words || [];
                    
                    html += `
                        <tr>
                            <td><strong>${student.username}</strong></td>
                            <td>${words.length}</td>
                            <td style="color: #4CAF50;">${words.filter(w => w.status === 'remembered').length}</td>
                            <td style="color: #FF9800;">${words.filter(w => w.status === 'fuzzy').length}</td>
                            <td style="color: #F44336;">${words.filter(w => w.status === 'forgot' || !w.status).length}</td>
                            <td>${student.last_login ? new Date(student.last_login).toLocaleDateString() : 'ä»æœª'}</td>
                            <td><button class="btn" onclick="viewStudentDetail('${student.username}')" style="padding: 5px 10px;">æŸ¥çœ‹</button></td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table>';
                
                document.getElementById('students-data').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
                document.getElementById('students-data').innerHTML = 
                    '<p style="color: red;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
            }
        }
        
        // æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…
        async function viewStudentDetail(username) {
            const { data } = await supabase
                .from('user_words')
                .select('words')
                .eq('username', username)
                .single();
            
            const words = data?.words || [];
            
            let detailHtml = `<h3>${username} çš„å•è¯è¯¦æƒ…ï¼ˆ${words.length}ä¸ªï¼‰</h3>`;
            detailHtml += '<div style="max-height: 300px; overflow-y: auto; margin: 20px 0;">';
            
            if (words.length === 0) {
                detailHtml += '<p>è¯¥å­¦ç”Ÿè¿˜æ²¡æœ‰æ·»åŠ å•è¯</p>';
            } else {
                detailHtml += '<table class="stats-table">';
                detailHtml += `
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>çŠ¶æ€</th>
                            <th>å¤ä¹ æ¬¡æ•°</th>
                            <th>æœ€åå¤ä¹ </th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                words.forEach(word => {
                    const statusText = {
                        'remembered': 'âœ… è®°å¾—',
                        'fuzzy': 'ğŸ”„ æ¨¡ç³Š',
                        'forgot': 'âŒ å¿˜è®°'
                    }[word.status] || 'æœªå­¦ä¹ ';
                    
                    detailHtml += `
                        <tr>
                            <td>${word.english || ''}</td>
                            <td>${word.chinese || ''}</td>
                            <td>${statusText}</td>
                            <td>${word.reviewCount || 0}</td>
                            <td>${word.lastReview ? new Date(word.lastReview).toLocaleDateString() : 'ä»æœª'}</td>
                        </tr>
                    `;
                });
                
                detailHtml += '</tbody></table>';
            }
            
            detailHtml += '</div>';
            detailHtml += '<button class="btn btn-red" onclick="loadStudentStats()">è¿”å›åˆ—è¡¨</button>';
            
            document.getElementById('students-data').innerHTML = detailHtml;
        }
        
        // é€€å‡º
        function logout() {
            currentUser = null;
            isTeacher = false;
            localStorage.removeItem('word_trainer_user');
            document.getElementById('username').value = '';
            showScreen('login-screen');
        }
        
        // ç»‘å®šå›è½¦é”®
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
