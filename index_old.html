<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        .btn { 
            background: #4CAF50; color: white; border: none; padding: 14px 28px; 
            margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; 
            font-weight: bold; transition: all 0.3s; 
        }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn-blue { background: #2196F3; } 
        .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } 
        .btn-red:hover { background: #D32F2F; }
        
        input[type="text"], textarea, select { 
            width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; 
            border: 2px solid #ddd; border-radius: 10px; font-size: 16px; 
        }
        
        .message-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .message-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .message-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .message-info { background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .data-table { 
            width: 100%; border-collapse: collapse; margin: 20px 0; 
            background: white; border-radius: 10px; overflow: hidden; 
        }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .fixed-header { 
            position: sticky; top: 0; background: white; z-index: 1000; 
            padding: 15px 30px; border-bottom: 2px solid #f0f0f0; 
        }
        
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .btn { padding: 12px 20px; margin: 8px; }
            .card-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">ğŸ§  æ™ºèƒ½è®°å¿†ç³»ç»Ÿ ğŸ”¥</h2>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box message-info">
                            è¯·è¾“å…¥ç”¨æˆ·åç™»å½•
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testDatabase()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h2>
                        <button class="btn btn-red" onclick="handleLogout()">
                            ğŸšª é€€å‡º
                        </button>
                    </div>
                </div>
                
                <div style="padding-top: 80px;">
                    <div class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-blue" onclick="showUploadWordsPage()">
                                ğŸ“ ä¸Šä¼ å•è¯
                            </button>
                            <button class="btn" onclick="showAllStudentsPage()">
                                ğŸ‘¥ å­¦ç”Ÿç®¡ç†
                            </button>
                            <button class="btn" onclick="showAttendanceReport()">
                                ğŸ“… æ‰“å¡ç»Ÿè®¡
                            </button>
                            <button class="btn" onclick="showWordManagementPage()">
                                ğŸ“– å•è¯ç®¡ç†
                            </button>
                            <button class="btn" onclick="showLearningProgressPage()">
                                ğŸ“Š å­¦ä¹ è¿›åº¦
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
                        <button class="btn btn-red" onclick="handleLogout()">
                            ğŸšª é€€å‡º
                        </button>
                    </div>
                </div>
                
                <div style="padding-top: 80px;">
                    <div id="today-status">
                        <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥æ•°æ® -->
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="btn" onclick="startStandardTraining()">
                            ğŸ“š å¼€å§‹å­¦ä¹ 
                        </button>
                        <button class="btn btn-blue" onclick="showMyWordListPage()">
                            ğŸ“– æˆ‘çš„å•è¯æœ¬
                        </button>
                        <button class="btn" onclick="manualSyncWords()">
                            ğŸ”„ åŒæ­¥å•è¯
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆåŠŸèƒ½é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <h2 style="margin: 0; color: #333;">ğŸ“ ä¸Šä¼ å•è¯</h2>
                </div>
                <div style="padding-top: 80px; padding: 30px;">
                    <button class="btn" onclick="showTeacherDashboard()">â† è¿”å›</button>
                    <div id="teacher-upload-content">
                        <h3>ä¸Šä¼ å•è¯åŠŸèƒ½</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';

// åˆ›å»ºSupabaseå®¢æˆ·ç«¯
let dbClient;
try {
    dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
} catch (error) {
    console.error('âŒ åˆ›å»ºSupabaseå®¢æˆ·ç«¯å¤±è´¥:', error);
}

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    teacherId: 'kathy151'
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
}

function showAlert(message, type = 'info') {
    alert(`${type.toUpperCase()}: ${message}`);
}

// ========== æ•°æ®åº“æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { data, error } = await dbClient.from('users').select('count').limit(1);
        if (error) {
            showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
            return false;
        }
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
        return true;
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¼‚å¸¸ï¼š${error.message}`, 'error');
        return false;
    }
}

// ========== ç™»å½•ç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        // é¦–å…ˆæµ‹è¯•æ•°æ®åº“è¿æ¥
        const dbConnected = await testDatabase();
        if (!dbConnected) {
            showMessage('login-message', 'æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            return;
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
            const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', createError);
                showMessage('login-message', `åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼š${createError.message}`, 'error');
                return;
            }
            
            appState.currentUser = username;
            appState.isTeacher = isTeacherAccount;
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
        } else if (checkError) {
            throw checkError;
        } else {
            // ç”¨æˆ·å·²å­˜åœ¨
            appState.currentUser = username;
            appState.isTeacher = existingUser.is_teacher;
            
            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            await dbClient
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', appState.isTeacher ? 'teacher' : 'student');
        
        // è·³è½¬åˆ°ç›¸åº”ç•Œé¢
        setTimeout(() => {
            if (appState.isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆä»ªè¡¨æ¿ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}

async function loadTeacherDashboard() {
    try {
        // è·å–ç»Ÿè®¡æ•°æ®
        const [wordsCount, studentsCount, studyData] = await Promise.all([
            dbClient.from('words').select('count', { count: 'exact' }).eq('teacher_id', appState.teacherId),
            dbClient.from('users').select('count', { count: 'exact' }).eq('is_teacher', false),
            dbClient.from('study_records').select('status')
        ]);
        
        // è®¡ç®—å·²æŒæ¡å•è¯æ•°
        const masteredWords = studyData.data?.filter(r => r.status === 'mastered').length || 0;
        
        // è®¡ç®—æ´»è·ƒå­¦ç”Ÿï¼ˆæœ€è¿‘7å¤©æœ‰å­¦ä¹ çš„ï¼‰
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        const { data: activeStudentsData } = await dbClient
            .from('study_records')
            .select('student_id')
            .gte('last_reviewed', sevenDaysAgo.toISOString());
        
        const activeStudents = new Set(activeStudentsData?.map(r => r.student_id) || []).size;
        
        // æ›´æ–°ç•Œé¢
        document.getElementById('total-words').textContent = wordsCount.count || 0;
        document.getElementById('total-students').textContent = studentsCount.count || 0;
        document.getElementById('mastered-words').textContent = masteredWords;
        document.getElementById('active-students').textContent = activeStudents;
        
        // åŠ è½½æ•™å¸ˆé¢æ¿å†…å®¹
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">âœ¨ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn" onclick="showUploadWordsPage()">
                        ä¸Šä¼ å•è¯
                    </button>
                    <button class="btn btn-blue" onclick="showAllStudentsPage()">
                        æŸ¥çœ‹å­¦ç”Ÿ
                    </button>
                    <button class="btn" onclick="showWordManagementPage()">
                        ç®¡ç†å•è¯
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        document.getElementById('teacher-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
    }
}

// ========== å­¦ç”Ÿä»ªè¡¨æ¿ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboard();
}

async function loadStudentDashboard() {
    try {
        document.getElementById('student-name').textContent = appState.currentUser;
        
        // åŒæ­¥å•è¯
        await syncGroupWordsToStudent(appState.currentUser);
        
        // è·å–å­¦ä¹ è®°å½•
        const { data: studyRecords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) {
            console.error('è·å–å­¦ä¹ è®°å½•é”™è¯¯:', error);
            showAlert('è·å–æ•°æ®å¤±è´¥', 'error');
            return;
        }
        
        appState.userWords = studyRecords || [];
        
        // è·å–ä»Šæ—¥æ‰“å¡æ•°æ®
        const today = new Date().toISOString().split('T')[0];
        const { data: todayAttendance } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('study_date', today)
            .single();
        
        const todayWords = todayAttendance?.word_count || 0;
        const dailyTarget = 10;
        const progressPercent = Math.min(100, (todayWords / dailyTarget) * 100);
        
        // æ›´æ–°ç•Œé¢
        const todayStatus = document.getElementById('today-status');
        todayStatus.innerHTML = `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${todayWords}</div>
                        <div class="label">ä»Šæ—¥å·²å­¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${studyRecords?.length || 0}</div>
                        <div class="label">å•è¯æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${studyRecords?.filter(r => r.status === 'mastered').length || 0}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayWords}/${dailyTarget}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// ========== åŒæ­¥å•è¯ ==========
async function syncGroupWordsToStudent(studentId) {
    try {
        // è·å–å­¦ç”Ÿæ‰€åœ¨åˆ†ç»„
        const { data: studentGroups, error: groupsError } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', studentId);
        
        if (groupsError) {
            console.error('è·å–åˆ†ç»„é”™è¯¯:', groupsError);
            return 0;
        }
        
        // å¦‚æœå­¦ç”Ÿæ²¡æœ‰åˆ†ç»„ï¼ŒåŠ å…¥é»˜è®¤åˆ†ç»„
        if (!studentGroups || studentGroups.length === 0) {
            // è·å–æˆ–åˆ›å»ºé»˜è®¤åˆ†ç»„
            let { data: defaultGroup } = await dbClient
                .from('groups')
                .select('id')
                .eq('teacher_id', appState.teacherId)
                .eq('name', 'é»˜è®¤åˆ†ç»„')
                .single();
            
            if (!defaultGroup) {
                const { data: newGroup } = await dbClient
                    .from('groups')
                    .insert([{
                        name: 'é»˜è®¤åˆ†ç»„',
                        teacher_id: appState.teacherId,
                        description: 'ç³»ç»Ÿé»˜è®¤åˆ†ç»„'
                    }])
                    .select()
                    .single();
                defaultGroup = newGroup;
            }
            
            // å°†å­¦ç”ŸåŠ å…¥é»˜è®¤åˆ†ç»„
            await dbClient
                .from('group_students')
                .insert([{
                    group_id: defaultGroup.id,
                    student_id: studentId
                }])
                .onConflict(['group_id', 'student_id'])
                .ignore();
            
            studentGroups = [{ group_id: defaultGroup.id }];
        }
        
        // åŒæ­¥åˆ†ç»„å•è¯
        const groupIds = studentGroups.map(g => g.group_id);
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .in('group_id', groupIds);
        
        if (wordsError) {
            console.error('è·å–åˆ†ç»„å•è¯é”™è¯¯:', wordsError);
            return 0;
        }
        
        if (!groupWords || groupWords.length === 0) {
            showAlert('åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯ï¼Œè¯·è”ç³»è€å¸ˆä¸Šä¼ å•è¯', 'info');
            return 0;
        }
        
        // è·å–å­¦ç”Ÿå·²æœ‰è®°å½•
        const { data: existingRecords } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°å•è¯è®°å½•
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                group_id: word.group_id
            }));
        
        if (newRecords.length > 0) {
            // æ‰¹é‡æ’å…¥æ–°è®°å½•
            const { error: insertError } = await dbClient
                .from('study_records')
                .insert(newRecords);
            
            if (insertError) {
                console.error('æ’å…¥è®°å½•é”™è¯¯:', insertError);
                return 0;
            }
            
            showAlert(`åŒæ­¥æˆåŠŸï¼æ–°å¢ ${newRecords.length} ä¸ªå•è¯`, 'success');
            return newRecords.length;
        } else {
            showAlert('æ‚¨å·²åŒæ­¥æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
            return 0;
        }
        
    } catch (error) {
        console.error('åŒæ­¥å•è¯é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ==========
function showUploadWordsPage() {
    showScreen('teacher-upload-screen');
    loadUploadWordsPage();
}

async function loadUploadWordsPage() {
    try {
        // è·å–æ•™å¸ˆçš„åˆ†ç»„
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (error) throw error;
        
        let groupsOptions = '<option value="">é€‰æ‹©åˆ†ç»„...</option>';
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                groupsOptions += `<option value="${group.id}">${group.name}</option>`;
            });
        }
        
        const content = document.getElementById('teacher-upload-content');
        content.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ ä¸Šä¼ å•è¯</h3>
                
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">é€‰æ‹©åˆ†ç»„</label>
                    <select id="upload-group" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd;">
                        ${groupsOptions}
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <textarea id="words-input" placeholder="è¾“å…¥æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªå•è¯ï¼‰ï¼š
hello,ä½ å¥½
world,ä¸–ç•Œ
apple,è‹¹æœ" 
                              style="width: 100%; height: 200px; padding: 15px; border-radius: 8px; border: 2px solid #ddd;"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button class="btn" onclick="uploadWords()" style="flex: 1;">
                        ä¸Šä¼ å•è¯
                    </button>
                    <button class="btn" onclick="showTeacherDashboard()" style="flex: 1;">
                        è¿”å›
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½ä¸Šä¼ é¡µé¢é”™è¯¯:', error);
        content.innerHTML = `<p style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
    }
}

async function uploadWords() {
    const text = document.getElementById('words-input').value.trim();
    const groupId = document.getElementById('upload-group').value;
    
    if (!groupId) {
        showAlert('è¯·é€‰æ‹©åˆ†ç»„', 'error');
        return;
    }
    
    if (!text) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    const words = [];
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        const parts = line.split(',').map(part => part.trim());
        if (parts.length >= 2) {
            words.push({
                teacher_id: appState.teacherId,
                english: parts[0].toLowerCase(),
                chinese: parts[1],
                group_id: groupId
            });
        }
    }
    
    if (words.length === 0) {
        showAlert('æ²¡æœ‰æœ‰æ•ˆçš„å•è¯æ ¼å¼', 'error');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨ä¸Šä¼ å•è¯...', 'info');
        
        const { data, error } = await dbClient
            .from('words')
            .insert(words)
            .select();
        
        if (error) {
            console.error('ä¸Šä¼ å•è¯é”™è¯¯:', error);
            showAlert(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            return;
        }
        
        showAlert(`æˆåŠŸä¸Šä¼  ${data.length} ä¸ªå•è¯ï¼`, 'success');
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('words-input').value = '';
        
        // æ›´æ–°æ•™å¸ˆé¢æ¿
        setTimeout(() => {
            showTeacherDashboard();
        }, 1500);
        
    } catch (error) {
        console.error('ä¸Šä¼ å•è¯å¼‚å¸¸:', error);
        showAlert(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
}

// ========== å…¶ä»–æ•™å¸ˆé¡µé¢å‡½æ•° ==========
function showAllStudentsPage() {
    showScreen('teacher-upload-screen');
    document.getElementById('teacher-upload-content').innerHTML = `
        <h3>å­¦ç”Ÿç®¡ç†é¡µé¢</h3>
        <p>åŠŸèƒ½å¼€å‘ä¸­...</p>
        <button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>
    `;
}

function showAttendanceReport() {
    showScreen('teacher-upload-screen');
    document.getElementById('teacher-upload-content').innerHTML = `
        <h3>æ‰“å¡ç»Ÿè®¡é¡µé¢</h3>
        <p>åŠŸèƒ½å¼€å‘ä¸­...</p>
        <button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>
    `;
}

function showWordManagementPage() {
    showScreen('teacher-upload-screen');
    document.getElementById('teacher-upload-content').innerHTML = `
        <h3>å•è¯ç®¡ç†é¡µé¢</h3>
        <p>åŠŸèƒ½å¼€å‘ä¸­...</p>
        <button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>
    `;
}

function showLearningProgressPage() {
    showScreen('teacher-upload-screen');
    document.getElementById('teacher-upload-content').innerHTML = `
        <h3>å­¦ä¹ è¿›åº¦é¡µé¢</h3>
        <p>åŠŸèƒ½å¼€å‘ä¸­...</p>
        <button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>
    `;
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
function startStandardTraining() {
    showAlert('å¼€å§‹å­¦ä¹ åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function showMyWordListPage() {
    showAlert('å•è¯æœ¬åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

async function manualSyncWords() {
    showAlert('æ­£åœ¨åŒæ­¥å•è¯...', 'info');
    await syncGroupWordsToStudent(appState.currentUser);
    await loadStudentDashboard();
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        appState.currentUser = null;
        appState.isTeacher = false;
        
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯æ™ºèƒ½è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    await testDatabase();
    
    // æ£€æŸ¥å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        appState.currentUser = savedUser;
        appState.isTeacher = (savedRole === 'teacher');
        
        if (appState.isTeacher) {
            showTeacherDashboard();
        } else {
            showStudentDashboard();
        }
    }
    
    // æ·»åŠ å›è½¦ç™»å½•
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};
</script>
</body>
</html>
