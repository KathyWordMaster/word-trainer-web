<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - æ™ºèƒ½è®°å¿†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        
        input[type="text"], textarea, input[type="password"], select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°å•è¯æ¡† */
        .word-card { 
            background: white; 
            border: 4px solid #4CAF50; 
            border-radius: 20px; 
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px auto; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            max-width: 600px;
            padding: 20px;
            word-wrap: break-word;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .word-card-content {
            width: 100%;
            text-align: center;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´ */
        .font-size-xl { font-size: 2.8em; }
        .font-size-lg { font-size: 2.2em; }
        .font-size-md { font-size: 1.8em; }
        .font-size-sm { font-size: 1.5em; }
        .font-size-xs { font-size: 1.2em; }
        
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .message-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .message-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .message-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .message-info { background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB; }
        .message-warning { background: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; }
        
        .wechat-badge { background: #07C160; color: white; padding: 14px 28px; border-radius: 25px; display: inline-flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1em; margin: 15px 0; box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3); }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* å›ºå®šå¤´éƒ¨æ ·å¼ */
        .fixed-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            z-index: 1000; 
            padding: 15px 30px; 
            border-bottom: 2px solid #f0f0f0; 
        }
        
        .content-padding { padding-top: 100px; padding-bottom: 30px; }
        
        /* ä»Šæ—¥å®Œæˆæ¿€åŠ±æ ·å¼ */
        .celebration-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* å­¦ä¹ æ¨¡å¼æ ‡ç­¾ */
        .mode-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .mode-standard { background: #E8F5E9; color: #2E7D32; }
        .mode-extra-new { background: #E3F2FD; color: #1565C0; }
        .mode-intensive { background: #FFF3E0; color: #EF6C00; }
        .mode-memory { background: #F3E5F5; color: #7B1FA2; }
        
        /* è®°å¿†å¼ºåº¦æŒ‡ç¤ºå™¨ */
        .memory-strength-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .memory-strength-fill {
            height: 100%;
            transition: width 0.5s;
        }
        .strength-high { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .strength-medium { background: linear-gradient(90deg, #FF9800, #FFB74D); }
        .strength-low { background: linear-gradient(90deg, #F44336, #EF5350); }
        
        /* è¿ç»­æ‰“å¡æ ·å¼ */
        .streak-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        .streak-day {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #ddd;
        }
        .streak-day.completed {
            background: #4CAF50;
            color: white;
            border-color: #2E7D32;
        }
        .streak-day.today {
            background: #2196F3;
            color: white;
            border-color: #1976D2;
        }
        .streak-day.missed {
            background: #f5f5f5;
            color: #999;
        }
        
        .batch-controls { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        
        @media (max-width: 768px) {
            .two-column { grid-template-columns: 1fr; }
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { 
                height: 220px; 
                max-width: 90%;
                margin: 20px auto;
                padding: 15px;
            }
            .font-size-xl { font-size: 2.2em; }
            .font-size-lg { font-size: 1.8em; }
            .font-size-md { font-size: 1.5em; }
            .font-size-sm { font-size: 1.3em; }
            .font-size-xs { font-size: 1.1em; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
            .card-grid { grid-template-columns: 1fr 1fr; }
            .content-padding { padding-top: 90px; }
            .fixed-header { padding: 12px 20px; }
            .streak-day { width: 35px; height: 35px; font-size: 12px; }
        }
        
        @media (max-width: 480px) {
            .word-card { 
                height: 200px; 
                padding: 10px;
            }
            .font-size-xl { font-size: 1.8em; }
            .font-size-lg { font-size: 1.5em; }
            .font-size-md { font-size: 1.3em; }
            .font-size-sm { font-size: 1.1em; }
            .font-size-xs { font-size: 0.9em; }
            .card-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">ğŸ§  æ™ºèƒ½è®°å¿†ç³»ç»Ÿ ğŸ”¥</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151 | ğŸ“š åŸºäºè®°å¿†æ›²çº¿ç§‘å­¦å­¦ä¹ </p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">ğŸ§¡ åŸºäºè®°å¿†æ›²çº¿çš„ç§‘å­¦å­¦ä¹ ï¼Œè®©å•è¯è®°å¾—æ›´ç‰¢ï¼</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box message-info">
                            æ­£åœ¨è¿æ¥æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testDatabase()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">âœ¨ ç³»ç»Ÿç‰¹è‰²åŠŸèƒ½</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“ˆ</div>
                                <div style="font-weight: bold; margin: 10px 0;">æ™ºèƒ½è®°å¿†æ›²çº¿</div>
                                <div>åŸºäºè‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿</div>
                                <div>ç§‘å­¦å®‰æ’å¤ä¹ æ—¶é—´</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ¯</div>
                                <div style="font-weight: bold; margin: 10px 0;">ä¸ªæ€§åŒ–å­¦ä¹ </div>
                                <div>æ¯æ—¥10ä¸ªæ–°å•è¯</div>
                                <div>å¯è‡ªä¸»é€‰æ‹©åŠ é‡å­¦ä¹ </div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ”¥</div>
                                <div style="font-weight: bold; margin: 10px 0;">é‡ç‚¹å¼ºåŒ–å¤ä¹ </div>
                                <div>å­¦ä¹ ä¸­å•è¯ä¼˜å…ˆå¤ä¹ </div>
                                <div>å¼ºåŒ–è–„å¼±ç¯èŠ‚</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“…</div>
                                <div style="font-weight: bold; margin: 10px 0;">è¿ç»­æ‰“å¡æ¿€åŠ±</div>
                                <div>è¿ç»­7å¤©å­¦ä¹ æœ‰å¥–åŠ±</div>
                                <div>åŸ¹å…»è‰¯å¥½å­¦ä¹ ä¹ æƒ¯</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <div class="wechat-badge">
                                <span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            <p style="color: #555; margin-top: 15px;">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘‘ æ•™å¸ˆæ™ºèƒ½ç®¡ç†é¢æ¿</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="teacher-stats" class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-purple" onclick="showUploadWordsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“</div>
                                <div>ä¸Šä¼ å•è¯</div>
                            </button>
                            <button class="btn btn-blue" onclick="showGroupManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ‘¥</div>
                                <div>åˆ†ç»„ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showAllStudentsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“‹</div>
                                <div>æ‰€æœ‰å­¦ç”Ÿ</div>
                            </button>
                            <button class="btn btn-gold" onclick="showLearningProgressPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“Š</div>
                                <div>å­¦ä¹ è¿›åº¦</div>
                            </button>
                            <button class="btn" onclick="showWordManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>å•è¯ç®¡ç†</div>
                            </button>
                            <button class="btn btn-orange" onclick="showAttendanceReport()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“…</div>
                                <div>æ‰“å¡ç»Ÿè®¡</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <!-- ä»Šæ—¥å­¦ä¹ æƒ…å†µ -->
                    <div id="today-status" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥æ•°æ® -->
                    </div>
                    
                    <!-- è¿ç»­æ‰“å¡å±•ç¤º -->
                    <div id="streak-display" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½è¿ç»­æ‰“å¡ -->
                    </div>
                    
                    <!-- æˆ‘çš„å­¦ä¹ è¿›åº¦ -->
                    <div id="my-progress-summary" class="stats-card" style="margin-bottom: 30px;">
                        <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                        <!-- åŠ¨æ€åŠ è½½è¿›åº¦æ•°æ® -->
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button class="btn" onclick="startStandardDailyTraining()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“…</div>
                                <div>ä»Šæ—¥è®­ç»ƒ</div>
                            </button>
                            <button class="btn btn-blue" onclick="showStudentOptions()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ¯</div>
                                <div>è‡ªä¸»é€‰æ‹©</div>
                            </button>
                            <button class="btn" onclick="showMyWordListPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>æˆ‘çš„å•è¯æœ¬</div>
                            </button>
                            <button class="btn" onclick="startIntensiveReview()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ”¥</div>
                                <div>å¼ºåŒ–å¤ä¹ </div>
                            </button>
                            <button class="btn" onclick="showMyAchievementsPage()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ†</div>
                                <div>æˆ‘çš„æˆå°±</div>
                            </button>
                            <button class="btn btn-gold" onclick="manualSyncWords()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ”„</div>
                                <div>ç«‹å³åŒæ­¥</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„åˆ†ç»„è¯¦æƒ… -->
                    <div id="group-details" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½åˆ†ç»„è¯¦æƒ… -->
                    </div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- è‡ªä¸»é€‰æ‹©é¡µé¢ -->
            <div id="student-options-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ è‡ªä¸»é€‰æ‹©å­¦ä¹ æ¨¡å¼</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding" id="student-options-content">
                    <!-- åŠ¨æ€åŠ è½½é€‰æ‹©ç•Œé¢ -->
                </div>
            </div>
            
            <!-- è®­ç»ƒé¡µé¢ -->
            <div id="training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666;">
                            è¿›åº¦: <span id="training-progress">0/0</span>
                        </div>
                        <button class="btn btn-red" onclick="cancelTraining()" style="padding: 8px 16px;">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="training-content" style="max-width: 600px; margin: 0 auto;">
                        <!-- åŠ¨æ€åŠ è½½è®­ç»ƒå†…å®¹ -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿæˆå°±é¡µé¢ -->
            <div id="student-achievements-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ† æˆ‘çš„æˆå°±</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="achievements-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿå•è¯æœ¬é¡µé¢ -->
            <div id="student-wordlist-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– æˆ‘çš„å•è¯æœ¬</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="wordlist-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä»Šæ—¥ä»»åŠ¡é¡µé¢ -->
            <div id="student-today-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“… ä»Šæ—¥ä»»åŠ¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="today-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ ä¸Šä¼ å•è¯</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-upload-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ -->
            <div id="teacher-groups-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-groups-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ -->
            <div id="teacher-students-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-students-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ -->
            <div id="teacher-progress-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-progress-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ -->
            <div id="teacher-words-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– å•è¯ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-words-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆæ‰“å¡ç»Ÿè®¡é¡µé¢ -->
            <div id="teacher-attendance-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“… æ‰“å¡ç»Ÿè®¡</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-attendance-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

<script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null,
    
    // æ–°å¢ï¼šæ™ºèƒ½å­¦ä¹ é…ç½®
    dailyTarget: 10,
    reviewSettings: {
        mastered: { maxPerDay: 2, weight: 15 },
        learning: { maxPerDay: 8, weight: 50 },
        new: { maxPerDay: 10, weight: 35 }
    },
    consecutiveDays: 0,
    lastStudyDate: null,
    reviewDay: false,
    weeklySchedule: {
        day1: { newWords: 10, review: true },
        day2: { newWords: 10, review: true },
        day3: { newWords: 10, review: true },
        day4: { newWords: 10, review: true },
        day5: { newWords: 10, review: true },
        day6: { newWords: 10, review: true },
        day7: { newWords: 0, review: true, isReviewDay: true }
    },
    todayWordsToReview: [],
    
    // è®°å¿†æ›²çº¿é…ç½®
    memoryCurve: [1, 2, 4, 7, 15, 30],
    
    // å­¦ç”Ÿè‡ªä¸»é€‰é¡¹
    studentOptions: {
        extraNewWords: 10,
        extraReviewWords: 15,
        maxDailyWords: 50
    }
};

// ========== è®°å¿†æ›²çº¿ç®—æ³• ==========
class MemoryCurveReview {
    constructor() {
        this.intervals = [1, 2, 4, 7, 15, 30];
    }
    
    shouldReviewToday(word) {
        if (!word.last_reviewed) return true;
        
        const lastReview = new Date(word.last_reviewed);
        const today = new Date();
        const daysSinceReview = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
        const reviewCount = word.review_count || 0;
        
        let interval = 30;
        if (reviewCount < this.intervals.length) {
            interval = this.intervals[reviewCount];
        }
        
        return daysSinceReview >= interval;
    }
    
    getWordsForMemoryCurve(words) {
        return words.filter(word => this.shouldReviewToday(word));
    }
    
    calculateMemoryStrength(word) {
        if (!word.last_reviewed) return 0;
        
        const lastReview = new Date(word.last_reviewed);
        const today = new Date();
        const daysSinceReview = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
        const reviewCount = word.review_count || 0;
        
        let forgettingRate = 0.56;
        if (reviewCount > 0) {
            forgettingRate = Math.max(0.05, 0.56 / Math.pow(2, reviewCount));
        }
        
        let strength = Math.exp(-forgettingRate * daysSinceReview);
        
        switch(word.status) {
            case 'mastered':
                strength *= 0.9;
                break;
            case 'learning':
                strength *= 0.7;
                break;
            case 'new':
                strength *= 0.5;
                break;
        }
        
        return Math.max(0, Math.min(1, strength));
    }
    
    // è·å–è®°å¿†æ›²çº¿æé†’
    getMemoryCurveReminder(word) {
        if (!word.last_reviewed) return "ä»æœªå¤ä¹ ";
        
        const strength = this.calculateMemoryStrength(word);
        const lastReview = new Date(word.last_reviewed);
        const today = new Date();
        const daysSinceReview = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
        const reviewCount = word.review_count || 0;
        
        let nextReviewIn = this.intervals[reviewCount] || 30;
        let daysToNextReview = Math.max(0, nextReviewIn - daysSinceReview);
        
        if (strength < 0.3) return "è®°å¿†è–„å¼±ï¼Œæ€¥éœ€å¤ä¹ ";
        if (strength < 0.6) return "è®°å¿†ä¸€èˆ¬ï¼Œå»ºè®®å¤ä¹ ";
        if (strength < 0.8) return "è®°å¿†è‰¯å¥½ï¼Œå¯ç¨åå¤ä¹ ";
        return "è®°å¿†ç‰¢å›ºï¼Œæ— éœ€ç«‹å³å¤ä¹ ";
    }
}

const memoryCurve = new MemoryCurveReview();

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
}

function showAlert(message, type = 'info') {
    const alertBox = document.createElement('div');
    alertBox.className = `message-box message-${type}`;
    alertBox.style.position = 'fixed';
    alertBox.style.top = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.zIndex = '1000';
    alertBox.style.maxWidth = '500px';
    alertBox.textContent = message;
    
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
}

function getFontSizeClass(text) {
    const length = text.length;
    if (length <= 10) return 'font-size-xl';
    if (length <= 15) return 'font-size-lg';
    if (length <= 20) return 'font-size-md';
    if (length <= 25) return 'font-size-sm';
    return 'font-size-xs';
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { error } = await dbClient.from('users').select('count').limit(1);
        if (error) throw error;
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            appState.currentUser = username;
            appState.isTeacher = isTeacherAccount;
            appState.userId = username;
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
            if (!isTeacherAccount) {
                await syncGroupWordsToStudent(username);
            }
            
        } else if (checkError) {
            throw checkError;
        } else {
            appState.currentUser = username;
            appState.isTeacher = existingUser.is_teacher;
            appState.userId = username;
            
            await dbClient
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        if (appState.isTeacher) {
            await initializeTeacherGroups();
        }
        
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', appState.isTeacher ? 'teacher' : 'student');
        
        if (!appState.isTeacher) {
            await loadDailyTrainingState();
        }
        
        setTimeout(() => {
            if (appState.isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

async function loadDailyTrainingState() {
    try {
        const today = new Date().toDateString();
        const storedDate = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
        
        if (storedDate === today) {
            const progress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
            appState.dailyTrainingProgress = progress;
            appState.lastTrainingDate = storedDate;
        } else {
            appState.dailyTrainingProgress = 0;
            appState.lastTrainingDate = today;
            localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
            localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0');
        }
    } catch (error) {
        console.error('åŠ è½½è®­ç»ƒçŠ¶æ€é”™è¯¯:', error);
    }
}

function saveDailyTrainingProgress(wordsStudied) {
    try {
        const today = new Date().toDateString();
        const currentProgress = appState.dailyTrainingProgress + wordsStudied;
        appState.dailyTrainingProgress = currentProgress;
        
        localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
        localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, currentProgress.toString());
        
        return currentProgress;
    } catch (error) {
        console.error('ä¿å­˜è®­ç»ƒè¿›åº¦é”™è¯¯:', error);
        return appState.dailyTrainingProgress;
    }
}

async function initializeTeacherGroups() {
    try {
        const { data: existingGroups, error } = await dbClient
            .from('groups')
            .select('*')
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        if (!existingGroups || existingGroups.length === 0) {
            const { data: newGroup, error: createError } = await dbClient
                .from('groups')
                .insert([{
                    name: 'é»˜è®¤åˆ†ç»„',
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            await dbClient
                .from('words')
                .update({ group_id: newGroup.id })
                .eq('teacher_id', appState.teacherId);
        }
        
    } catch (error) {
        console.error('åˆå§‹åŒ–åˆ†ç»„é”™è¯¯:', error);
    }
}

// ========== åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ ==========
async function syncGroupWordsToStudent(studentId) {
    try {
        const { data: studentGroups, error: groupsError } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', studentId);
        
        if (groupsError) {
            console.error('è·å–å­¦ç”Ÿåˆ†ç»„é”™è¯¯:', groupsError);
            return 0;
        }
        
        if (!studentGroups || studentGroups.length === 0) {
            showAlert('æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„ï¼Œè¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­', 'warning');
            return 0;
        }
        
        const groupIds = studentGroups.map(g => g.group_id);
        
        const { data: groupInfo, error: groupInfoError } = await dbClient
            .from('groups')
            .select('id, name')
            .in('id', groupIds);
        
        const groupNames = groupInfo?.map(g => g.name) || [];
        
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .in('group_id', groupIds)
            .eq('teacher_id', appState.teacherId);
        
        if (wordsError) {
            console.error('è·å–åˆ†ç»„å•è¯é”™è¯¯:', wordsError);
            return 0;
        }
        
        if (!groupWords || groupWords.length === 0) {
            showAlert('æ‚¨æ‰€åœ¨çš„åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯ï¼Œè¯·è”ç³»è€å¸ˆä¸Šä¼ å•è¯', 'info');
            return 0;
        }
        
        const { data: existingRecords, error: checkError } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        if (checkError) {
            console.error('æ£€æŸ¥ç°æœ‰è®°å½•é”™è¯¯:', checkError);
            return 0;
        }
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                review_count: 0,
                group_id: word.group_id,
                added_date: new Date().toISOString()
            }));
        
        if (newRecords.length > 0) {
            const batchSize = 50;
            for (let i = 0; i < newRecords.length; i += batchSize) {
                const batch = newRecords.slice(i, i + batchSize);
                const { error: insertError } = await dbClient
                    .from('study_records')
                    .insert(batch);
                
                if (insertError) {
                    console.error(`æ‰¹é‡æ’å…¥é”™è¯¯:`, insertError);
                    for (const record of batch) {
                        try {
                            const { error: singleError } = await dbClient
                                .from('study_records')
                                .insert(record);
                            if (singleError && !singleError.message.includes('duplicate key')) {
                                console.error(`å•ä¸ªæ’å…¥é”™è¯¯:`, singleError);
                            }
                        } catch (err) {
                            console.error('æ’å…¥å¼‚å¸¸:', err);
                        }
                    }
                }
            }
            
            if (newRecords.length > 0) {
                const message = `âœ… å·²ä¸ºæ‚¨åŒæ­¥ ${newRecords.length} ä¸ªæ–°å•è¯\nğŸ“ æ¥è‡ªåˆ†ç»„ï¼š${groupNames.join(', ')}`;
                showAlert(message, 'success');
            }
            
            return newRecords.length;
        } else {
            const message = `ğŸ“š æ‚¨å·²åŒæ­¥æ‰€æœ‰åˆ†ç»„å•è¯\nğŸ“ æ‰€åœ¨åˆ†ç»„ï¼š${groupNames.join(', ')}\nğŸ“– å•è¯æ€»æ•°ï¼š${groupWords.length}`;
            showAlert(message, 'info');
            return 0;
        }
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}

async function loadTeacherDashboard() {
    try {
        const { data: wordsData } = await dbClient
            .from('words')
            .select('count')
            .eq('teacher_id', appState.teacherId);
        
        const { data: studentsData } = await dbClient
            .from('users')
            .select('count')
            .eq('is_teacher', false);
        
        const { data: recordsData } = await dbClient
            .from('study_records')
            .select('*');
        
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const { data: activeData } = await dbClient
            .from('study_records')
            .select('student_id')
            .gte('last_reviewed', sevenDaysAgo.toISOString());
        
        document.getElementById('total-words').textContent = wordsData?.[0]?.count || 0;
        document.getElementById('total-students').textContent = studentsData?.[0]?.count || 0;
        
        const masteredWords = recordsData?.filter(r => r.status === 'mastered').length || 0;
        document.getElementById('mastered-words').textContent = masteredWords;
        
        const activeStudents = new Set(activeData?.map(r => r.student_id) || []).size;
        document.getElementById('active-students').textContent = activeStudents;
        
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">âœ¨ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn" style="padding: 12px 24px;" onclick="showUploadWordsPage()">
                        <span>ğŸ“¤ å¿«é€Ÿä¸Šä¼ </span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 24px;" onclick="quickStats()">
                        <span>ğŸ“ˆ ä»Šæ—¥æ•°æ®</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px;" onclick="showStudentActivity()">
                        <span>ğŸ‘€ å­¦ç”Ÿæ´»è·ƒ</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px; background: #FF9800;" onclick="showAttendanceReport()">
                        <span>ğŸ“… æ‰“å¡ç»Ÿè®¡</span>
                    </button>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ç³»ç»Ÿæç¤º</h4>
                    <p style="color: #666; margin: 5px 0;">â€¢ å·²ä¸Šä¼  ${wordsData?.[0]?.count || 0} ä¸ªå•è¯</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å…±æœ‰ ${studentsData?.[0]?.count || 0} åå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ æœ€è¿‘7å¤© ${activeStudents} åæ´»è·ƒå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å­¦ç”Ÿå…±æŒæ¡ ${masteredWords} ä¸ªå•è¯</p>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        document.getElementById('teacher-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
    }
}

// ========== æ™ºèƒ½æ¯æ—¥ä»»åŠ¡ç”Ÿæˆ ==========
async function generateEnhancedDailyTasks() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const studentId = appState.currentUser;
        
        const isReviewDay = await checkIfReviewDay(studentId);
        appState.reviewDay = isReviewDay;
        
        const { data: studyRecords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', studentId);
        
        if (error) throw error;
        
        const recordsWithStrength = studyRecords.map(record => ({
            ...record,
            memory_strength: memoryCurve.calculateMemoryStrength(record)
        }));
        
        const newWords = recordsWithStrength.filter(w => w.status === 'new') || [];
        const learningWords = recordsWithStrength.filter(w => w.status === 'learning') || [];
        const masteredWords = recordsWithStrength.filter(w => w.status === 'mastered') || [];
        
        newWords.sort((a, b) => a.memory_strength - b.memory_strength);
        learningWords.sort((a, b) => a.memory_strength - b.memory_strength);
        masteredWords.sort((a, b) => a.memory_strength - b.memory_strength);
        
        let todaysWords = [];
        
        if (isReviewDay) {
            todaysWords = await generateReviewDayWordsEnhanced(
                newWords, learningWords, masteredWords
            );
        } else {
            todaysWords = await generateNormalDayWordsEnhanced(
                newWords, learningWords, masteredWords
            );
        }
        
        appState.todayWordsToReview = todaysWords;
        
        await recordAttendance(studentId, todaysWords.length);
        
        return todaysWords;
        
    } catch (error) {
        console.error('ç”Ÿæˆæ¯æ—¥ä»»åŠ¡é”™è¯¯:', error);
        return [];
    }
}

async function generateNormalDayWordsEnhanced(newWords, learningWords, masteredWords) {
    const todaysWords = [];
    const target = appState.dailyTarget;
    
    const newToLearn = newWords.slice(0, Math.min(target, newWords.length));
    todaysWords.push(...newToLearn);
    
    const learningToReview = learningWords.slice(0, Math.min(8, learningWords.length));
    todaysWords.push(...learningToReview);
    
    const newToReview = newWords.slice(target, target + 5);
    todaysWords.push(...newToReview);
    
    const masteredToReview = masteredWords.slice(0, Math.min(2, masteredWords.length));
    todaysWords.push(...masteredToReview);
    
    const allWords = [...newWords, ...learningWords, ...masteredWords];
    const memoryCurveWords = memoryCurve.getWordsForMemoryCurve(allWords);
    
    const selectedIds = new Set(todaysWords.map(w => w.id || w.word_id));
    const additionalWords = memoryCurveWords
        .filter(w => !selectedIds.has(w.id || w.word_id))
        .slice(0, 10);
    
    todaysWords.push(...additionalWords);
    
    return deduplicateWords(todaysWords);
}

async function generateReviewDayWordsEnhanced(newWords, learningWords, masteredWords) {
    const todaysWords = [];
    
    const reviewWeights = {
        new: 35,
        learning: 50,
        mastered: 15
    };
    
    const totalReview = 30;
    
    const newCount = Math.ceil(totalReview * (reviewWeights.new / 100));
    const learningCount = Math.ceil(totalReview * (reviewWeights.learning / 100));
    const masteredCount = Math.ceil(totalReview * (reviewWeights.mastered / 100));
    
    const newToReview = newWords.slice(0, Math.min(newCount, newWords.length));
    const learningToReview = learningWords.slice(0, Math.min(learningCount, learningWords.length));
    const masteredToReview = masteredWords.slice(0, Math.min(masteredCount, masteredWords.length));
    
    todaysWords.push(...newToReview, ...learningToReview, ...masteredToReview);
    
    const allWords = [...newWords, ...learningWords, ...masteredWords];
    const memoryCurveWords = memoryCurve.getWordsForMemoryCurve(allWords);
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const longTermWords = memoryCurveWords.filter(w => {
        if (!w.last_reviewed) return false;
        return new Date(w.last_reviewed) < thirtyDaysAgo;
    }).slice(0, 10);
    
    todaysWords.push(...longTermWords);
    
    return deduplicateWords(todaysWords);
}

function deduplicateWords(words) {
    const seen = new Set();
    const result = [];
    
    for (const word of words) {
        const id = word.id || word.word_id;
        if (!seen.has(id)) {
            seen.add(id);
            result.push(word);
        }
    }
    
    const newWords = result.filter(w => w.status === 'new');
    const otherWords = result.filter(w => w.status !== 'new');
    
    return [
        ...newWords.sort(() => Math.random() - 0.5),
        ...otherWords.sort(() => Math.random() - 0.5)
    ];
}

// ========== æ£€æŸ¥å¤ä¹ æ—¥å’Œè¿ç»­æ‰“å¡ ==========
async function checkIfReviewDay(studentId) {
    try {
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', studentId)
            .order('study_date', { ascending: false })
            .limit(7);
        
        if (error) throw error;
        
        let consecutiveDays = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            const hasStudy = attendance?.some(record => 
                record.study_date === dateStr
            );
            
            if (hasStudy) {
                consecutiveDays++;
            } else {
                break;
            }
        }
        
        appState.consecutiveDays = consecutiveDays;
        
        return consecutiveDays % 7 === 0 && consecutiveDays > 0;
        
    } catch (error) {
        console.error('æ£€æŸ¥å¤ä¹ æ—¥é”™è¯¯:', error);
        return false;
    }
}

async function checkConsecutiveDays(studentId) {
    try {
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', studentId)
            .order('study_date', { ascending: false });
        
        if (error) throw error;
        
        let consecutiveDays = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayStr = today.toISOString().split('T')[0];
        const todayAttendance = attendance?.find(a => a.study_date === todayStr);
        
        if (!todayAttendance) {
            appState.consecutiveDays = 0;
            return;
        }
        
        let currentDate = today;
        for (let i = 0; i < 30; i++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const hasStudy = attendance?.some(record => record.study_date === dateStr);
            
            if (hasStudy) {
                consecutiveDays++;
                currentDate.setDate(currentDate.getDate() - 1);
            } else {
                break;
            }
        }
        
        appState.consecutiveDays = consecutiveDays;
        
        if (consecutiveDays === 7) {
            await awardConsecutiveBonus(studentId);
        }
        
    } catch (error) {
        console.error('æ£€æŸ¥è¿ç»­æ‰“å¡é”™è¯¯:', error);
    }
}

// ========== è®°å½•æ‰“å¡å’Œå¥–åŠ± ==========
async function recordAttendance(studentId, wordCount) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const { data: existing, error: checkError } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('student_id', studentId)
            .eq('study_date', today)
            .single();
        
        if (checkError && checkError.code !== 'PGRST116') {
            console.error('æ£€æŸ¥æ‰“å¡è®°å½•é”™è¯¯:', checkError);
            return;
        }
        
        const newWordsCount = appState.todayWordsToReview
            .filter(w => w.status === 'new').length;
        const reviewCount = wordCount - newWordsCount;
        
        if (existing) {
            const { error: updateError } = await dbClient
                .from('attendance_records')
                .update({
                    word_count: existing.word_count + wordCount,
                    new_word_count: existing.new_word_count + newWordsCount,
                    review_word_count: existing.review_word_count + reviewCount,
                    status: 'completed'
                })
                .eq('id', existing.id);
            
            if (updateError) throw updateError;
        } else {
            const { error: insertError } = await dbClient
                .from('attendance_records')
                .insert([{
                    student_id: studentId,
                    study_date: today,
                    word_count: wordCount,
                    new_word_count: newWordsCount,
                    review_word_count: reviewCount,
                    status: 'completed'
                }]);
            
            if (insertError) throw insertError;
            
            await checkConsecutiveDays(studentId);
        }
        
    } catch (error) {
        console.error('è®°å½•æ‰“å¡é”™è¯¯:', error);
    }
}

async function awardConsecutiveBonus(studentId) {
    try {
        showAlert('ğŸ‰ æ­å–œï¼æ‚¨å·²è¿ç»­å­¦ä¹ 7å¤©ï¼è·å¾—"åšæŒä¹‹æ˜Ÿ"ç§°å·ï¼', 'success');
        
        const { error } = await dbClient
            .from('achievements')
            .insert([{
                student_id: studentId,
                achievement_type: 'consecutive_7_days',
                awarded_date: new Date().toISOString(),
                description: 'è¿ç»­å­¦ä¹ 7å¤©å¥–åŠ±'
            }]);
        
        if (error && error.code !== '42P01') {
            console.error('è®°å½•å¥–åŠ±é”™è¯¯:', error);
        }
        
        await notifyTeacher(studentId, 'è¿ç»­7å¤©æ‰“å¡');
        
    } catch (error) {
        console.error('å‘æ”¾å¥–åŠ±é”™è¯¯:', error);
    }
}

async function notifyTeacher(studentId, message) {
    try {
        const { error } = await dbClient
            .from('teacher_notifications')
            .insert([{
                teacher_id: appState.teacherId,
                student_id: studentId,
                message: `${studentId} ${message}`,
                read: false,
                created_at: new Date().toISOString()
            }]);
        
        if (error && error.code !== '42P01') {
            console.error('é€šçŸ¥æ•™å¸ˆé”™è¯¯:', error);
        }
    } catch (error) {
        console.error('é€šçŸ¥æ•™å¸ˆé”™è¯¯:', error);
    }
}

// ========== å­¦ç”Ÿä»ªè¡¨æ¿ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboardSimple();
}

async function loadStudentDashboardSimple() {
    try {
        document.getElementById('student-name').textContent = appState.currentUser;
        
        await syncGroupWordsToStudent(appState.currentUser);
        
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        appState.userWords = records || [];
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayRecords = records?.filter(r => 
            r.last_reviewed && new Date(r.last_reviewed) >= today
        ) || [];
        
        const target = 10;
        const todayProgress = Math.min(todayRecords.length, target);
        const progressPercent = (todayProgress / target) * 100;
        
        await checkConsecutiveDays(appState.currentUser);
        
        const todayStatus = document.getElementById('today-status');
        
        let reviewDayNotice = '';
        if (appState.reviewDay) {
            reviewDayNotice = `
                <div class="celebration-banner" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white;">
                    ğŸ“… ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼ä¸å­¦æ–°å•è¯ï¼Œé‡ç‚¹å¤ä¹ å·²å­¦å†…å®¹
                </div>
            `;
        }
        
        const streakHTML = await generateStreakDisplay();
        
        todayStatus.innerHTML = `
            ${reviewDayNotice}
            ${streakHTML}
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${todayRecords.length}</div>
                        <div class="label">ä»Šæ—¥å·²å­¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${Math.max(0, target - todayRecords.length)}</div>
                        <div class="label">å»ºè®®å­¦ä¹ </div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${todayRecords.filter(r => r.status === 'mastered').length}</div>
                        <div class="label">ä»Šæ—¥æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${appState.consecutiveDays}</div>
                        <div class="label">è¿ç»­å¤©æ•°</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayProgress}/${target}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                ${todayRecords.length >= target ? 
                    '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : 
                    '<p style="color: #FF9800; text-align: center; margin-top: 15px;">ğŸ’ª ç»§ç»­åŠªåŠ›ï¼</p>'}
            </div>
        `;
        
        const total = records?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const learning = records?.filter(r => r.status === 'learning').length || 0;
        const review = records?.filter(r => r.status === 'new').length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        const progressSummary = document.getElementById('my-progress-summary');
        progressSummary.innerHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${total}</div>
                    <div class="label">å•è¯æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${mastered}</div>
                    <div class="label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${learning}</div>
                    <div class="label">å­¦ä¹ ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="number">${review}</div>
                    <div class="label">éœ€å­¦ä¹ </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
        `;
        
        const { data: studentGroups } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', appState.currentUser);
        
        let groupDetails = '';
        if (studentGroups && studentGroups.length > 0) {
            const groupIds = studentGroups.map(g => g.group_id);
            const { data: groups } = await dbClient
                .from('groups')
                .select('id, name')
                .in('id', groupIds);
            
            for (const group of groups || []) {
                const { data: groupWords } = await dbClient
                    .from('words')
                    .select('count')
                    .eq('group_id', group.id);
                
                const { data: myGroupRecords } = await dbClient
                    .from('study_records')
                    .select('count')
                    .eq('student_id', appState.currentUser)
                    .eq('group_id', group.id);
                
                groupDetails += `
                    <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${group.name}</div>
                        <div style="color: #666; font-size: 14px;">
                            åˆ†ç»„å•è¯: ${groupWords?.[0]?.count || 0} | 
                            æˆ‘çš„å•è¯: ${myGroupRecords?.[0]?.count || 0}
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('group-details').innerHTML = groupDetails ? `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š æˆ‘çš„åˆ†ç»„è¯¦æƒ…</h3>
                ${groupDetails}
            </div>
        ` : `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š åˆ†ç»„çŠ¶æ€</h3>
                <p style="color: #FF9800; text-align: center;">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„</p>
                <p style="color: #666; text-align: center; font-size: 14px;">è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­</p>
            </div>
        `;
        
        // æ·»åŠ è‡ªä¸»é€‰æ‹©åŒºåŸŸ
        const groupDetailsDiv = document.getElementById('group-details');
        const quickActionsHTML = `
            <div style="background: #FFF3CD; border-radius: 15px; padding: 25px; margin: 30px 0; border: 2px solid #FFC107;">
                <h3 style="color: #856404; margin-bottom: 15px; text-align: center;">ğŸš€ è¿›é˜¶å­¦ä¹ é€‰é¡¹</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <button class="btn" onclick="showStudentOptions()" 
                            style="background: #FFC107; color: #333; height: 90px; font-size: 16px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">ğŸ¯</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">è‡ªä¸»é€‰æ‹©</div>
                        <div style="color: #666; font-size: 12px;">è‡ªå®šä¹‰å­¦ä¹ å†…å®¹</div>
                    </button>
                    
                    <button class="btn btn-blue" onclick="startExtraNewWordsTraining()" 
                            style="height: 90px; font-size: 16px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">ğŸ†•</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">é¢å¤–æ–°è¯</div>
                        <div style="color: #666; font-size: 12px;">å†å­¦10ä¸ªæ–°å•è¯</div>
                    </button>
                </div>
                <p style="color: #856404; text-align: center; margin-top: 15px; font-size: 14px;">
                    ğŸ’¡ æƒ³è¦å­¦æ›´å¤šï¼Ÿè¯•è¯•è¿™äº›é€‰é¡¹ï¼
                </p>
            </div>
        `;
        
        if (groupDetailsDiv) {
            groupDetailsDiv.insertAdjacentHTML('beforebegin', quickActionsHTML);
        }
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

async function generateStreakDisplay() {
    try {
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', appState.currentUser)
            .order('study_date', { ascending: false })
            .limit(30);
        
        if (error) throw error;
        
        const streakDays = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const attendanceSet = new Set(attendance?.map(a => a.study_date) || []);
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            streakDays.push({
                date: date,
                dateStr: dateStr,
                completed: attendanceSet.has(dateStr),
                isToday: i === 0
            });
        }
        
        const completedCount = streakDays.filter(d => d.completed).length;
        const todayCompleted = streakDays[6].completed;
        
        let streakHTML = `
            <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 24px;">ğŸ”¥</span>
                    <div>
                        <div style="font-weight: bold; color: #2E7D32;">è¿ç»­å­¦ä¹  ${appState.consecutiveDays} å¤©</div>
                        <div style="color: #666; font-size: 14px;">
                            ${appState.consecutiveDays % 7 === 0 && appState.consecutiveDays > 0 ? 
                              'ğŸ‰ ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼' : 
                              `å†åšæŒ ${7 - (appState.consecutiveDays % 7)} å¤©å¯è·å¾—å¥–åŠ±`}
                        </div>
                    </div>
                </div>
                
                <div class="streak-container">
        `;
        
        streakDays.forEach((day, index) => {
            let className = 'streak-day';
            if (day.completed) className += ' completed';
            if (day.isToday) className += ' today';
            if (!day.completed && !day.isToday) className += ' missed';
            
            streakHTML += `
                <div class="${className}" title="${day.dateStr}">
                    ${day.date.getDate()}
                </div>
            `;
        });
        
        streakHTML += `
                </div>
                <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                    ${todayCompleted ? 'âœ… ä»Šå¤©å·²å®Œæˆå­¦ä¹ ' : 'â° ä»Šå¤©è¿˜æœªå­¦ä¹ '}
                </div>
            </div>
        `;
        
        return streakHTML;
        
    } catch (error) {
        console.error('ç”Ÿæˆè¿ç»­æ‰“å¡æ˜¾ç¤ºé”™è¯¯:', error);
        return '';
    }
}

// ========== å­¦ç”Ÿè‡ªä¸»é€‰æ‹©åŠŸèƒ½ ==========
function showStudentOptions() {
    showScreen('student-options-screen');
    
    const content = document.getElementById('student-options-content');
    content.innerHTML = `
        <div style="max-width: 700px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ¯ è‡ªä¸»é€‰æ‹©å­¦ä¹ æ¨¡å¼</h3>
            
            <div style="background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ“š å­¦ä¹ æ¨¡å¼é€‰æ‹©</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- æ ‡å‡†æ¨¡å¼ -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #4CAF50;"
                         onclick="startStandardDailyTraining()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ“…</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">æ ‡å‡†æ¨¡å¼</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ 10ä¸ªæ–°å•è¯<br>
                            â€¢ æ™ºèƒ½å¤ä¹ å·²å­¦<br>
                            â€¢ é€‚åˆæ—¥å¸¸å­¦ä¹ 
                        </div>
                        <div style="color: #4CAF50; font-weight: bold;">æ¨è</div>
                    </div>
                    
                    <!-- ä¸“æ³¨æ–°è¯æ¨¡å¼ -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #2196F3;"
                         onclick="startExtraNewWordsTraining()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ†•</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">ä¸“æ³¨æ–°è¯</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ é¢å¤–10ä¸ªæ–°å•è¯<br>
                            â€¢ å¿«é€Ÿæ‰©å……è¯æ±‡é‡<br>
                            â€¢ æŒ‘æˆ˜è‡ªæˆ‘
                        </div>
                        <div style="color: #2196F3;">è¿›é˜¶é€‰æ‹©</div>
                    </div>
                </div>
            </div>
            
            <div style="background: #E3F2FD; border-radius: 15px; padding: 30px; margin-bottom: 20px;">
                <h4 style="color: #1565C0; margin-bottom: 15px;">ğŸ”„ å¤ä¹ æ¨¡å¼é€‰æ‹©</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- å¼ºåŒ–å¤ä¹ æ¨¡å¼ -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #FF9800;"
                         onclick="startIntensiveReview()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ”¥</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">å¼ºåŒ–å¤ä¹ </div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ é‡ç‚¹å¤ä¹ å¼±é¡¹<br>
                            â€¢ å¼ºåŒ–å­¦ä¹ ä¸­å•è¯<br>
                            â€¢ å¿«é€Ÿæå‡
                        </div>
                        <div style="color: #FF9800;">é«˜æ•ˆæåˆ†</div>
                    </div>
                    
                    <!-- è®°å¿†æ›²çº¿å¤ä¹  -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #9C27B0;"
                         onclick="startMemoryCurveReview()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ“ˆ</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">è®°å¿†æ›²çº¿</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ æŒ‰è®°å¿†è§„å¾‹å¤ä¹ <br>
                            â€¢ è¦†ç›–è¿œæœŸå•è¯<br>
                            â€¢ ç§‘å­¦è®°å¿†
                        </div>
                        <div style="color: #9C27B0;">ç§‘å­¦æ–¹æ³•</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    `;
}

async function startStandardDailyTraining() {
    const todaysWords = await generateEnhancedDailyTasks();
    
    if (todaysWords.length === 0) {
        showAlert('æš‚æ—¶æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'info');
        return;
    }
    
    if (appState.reviewDay) {
        const confirmMsg = `ğŸ“… ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼\n\nä¸å­¦ä¹ æ–°å•è¯ï¼Œä¸“æ³¨å¤ä¹ å·²å­¦å†…å®¹ã€‚\n\nä»Šæ—¥å¤ä¹ ä»»åŠ¡ï¼š${todaysWords.length}ä¸ªå•è¯\n\næ˜¯å¦å¼€å§‹å¤ä¹ ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;
    } else {
        const newWordsCount = todaysWords.filter(w => w.status === 'new').length;
        const reviewWordsCount = todaysWords.length - newWordsCount;
        
        const confirmMsg = `ä»Šæ—¥å­¦ä¹ ä»»åŠ¡ï¼š\n\næ–°å•è¯ï¼š${newWordsCount}ä¸ª\nå¤ä¹ å•è¯ï¼š${reviewWordsCount}ä¸ª\n\næ€»å•è¯æ•°ï¼š${todaysWords.length}ä¸ª\n\næ˜¯å¦å¼€å§‹å­¦ä¹ ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;
    }
    
    appState.trainingWords = todaysWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

async function startExtraNewWordsTraining() {
    try {
        const { data: studyRecords } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('status', 'new');
        
        if (!studyRecords || studyRecords.length === 0) {
            showAlert('å·²ç»æ²¡æœ‰æ–°å•è¯å¯ä»¥å­¦ä¹ äº†', 'info');
            return;
        }
        
        const extraWords = studyRecords.slice(0, appState.studentOptions.extraNewWords);
        
        if (extraWords.length === 0) {
            showAlert('æ²¡æœ‰æ›´å¤šæ–°å•è¯äº†', 'info');
            return;
        }
        
        const confirmMsg = `æ‚¨é€‰æ‹©äº†é¢å¤–å­¦ä¹  ${extraWords.length} ä¸ªæ–°å•è¯ã€‚ç¡®å®šå¼€å§‹å—ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;
        
        appState.trainingWords = extraWords.sort(() => Math.random() - 0.5);
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        
        startTrainingSession();
        
    } catch (error) {
        console.error('é¢å¤–å­¦ä¹ é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

async function startIntensiveReview() {
    try {
        const { data: studyRecords } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (!studyRecords || studyRecords.length === 0) {
            showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å¤ä¹ ', 'info');
            return;
        }
        
        const learningWords = studyRecords
            .filter(w => w.status === 'learning')
            .map(w => ({
                ...w,
                memory_strength: memoryCurve.calculateMemoryStrength(w)
            }))
            .sort((a, b) => a.memory_strength - b.memory_strength);
        
        const newWords = studyRecords
            .filter(w => w.status === 'new')
            .map(w => ({
                ...w,
                memory_strength: memoryCurve.calculateMemoryStrength(w)
            }))
            .sort((a, b) => a.memory_strength - b.memory_strength);
        
        const learningCount = Math.min(15, learningWords.length);
        const newCount = Math.min(5, newWords.length);
        
        const reviewWords = [
            ...learningWords.slice(0, learningCount),
            ...newWords.slice(0, newCount)
        ];
        
        if (reviewWords.length === 0) {
            showAlert('æ²¡æœ‰éœ€è¦å¼ºåŒ–å¤ä¹ çš„å•è¯', 'info');
            return;
        }
        
        const confirmMsg = `å¼ºåŒ–å¤ä¹ æ¨¡å¼ï¼š\n\nå­¦ä¹ ä¸­å•è¯ï¼š${learningCount}ä¸ªï¼ˆé‡ç‚¹å¤ä¹ ï¼‰\néœ€å­¦ä¹ å•è¯ï¼š${newCount}ä¸ª\n\næ€»å•è¯æ•°ï¼š${reviewWords.length}ä¸ª\n\nç¡®å®šå¼€å§‹å—ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;
        
        appState.trainingWords = reviewWords.sort(() => Math.random() - 0.5);
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        
        startTrainingSession();
        
    } catch (error) {
        console.error('å¼ºåŒ–å¤ä¹ é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

async function startMemoryCurveReview() {
    try {
        const { data: studyRecords } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (!studyRecords || studyRecords.length === 0) {
            showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å¤ä¹ ', 'info');
            return;
        }
        
        const wordsWithStrength = studyRecords.map(w => ({
            ...w,
            memory_strength: memoryCurve.calculateMemoryStrength(w),
            should_review: memoryCurve.shouldReviewToday(w)
        }));
        
        let memoryCurveWords = wordsWithStrength
            .filter(w => w.should_review)
            .sort((a, b) => a.memory_strength - b.memory_strength);
        
        if (memoryCurveWords.length === 0) {
            memoryCurveWords = wordsWithStrength
                .sort((a, b) => a.memory_strength - b.memory_strength)
                .slice(0, 20);
        }
        
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const longTermWords = memoryCurveWords.filter(w => {
            if (!w.last_reviewed) return false;
            return new Date(w.last_reviewed) < thirtyDaysAgo;
        });
        
        const selectedWords = [
            ...longTermWords.slice(0, 10),
            ...memoryCurveWords.slice(0, 20)
        ];
        
        if (selectedWords.length === 0) {
            showAlert('æ²¡æœ‰éœ€è¦è®°å¿†æ›²çº¿å¤ä¹ çš„å•è¯', 'info');
            return;
        }
        
        const confirmMsg = `è®°å¿†æ›²çº¿å¤ä¹ ï¼š\n\nå°†å¤ä¹  ${selectedWords.length} ä¸ªå•è¯\nåŒ…å« ${longTermWords.length} ä¸ªè¿œæœŸå•è¯ï¼ˆ30å¤©å‰ï¼‰\n\næ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ç§‘å­¦å¤ä¹ `;
        if (!confirm(confirmMsg)) return;
        
        appState.trainingWords = [...new Set(selectedWords)]
            .sort(() => Math.random() - 0.5);
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        
        startTrainingSession();
        
    } catch (error) {
        console.error('è®°å¿†æ›²çº¿å¤ä¹ é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// ========== è®­ç»ƒç³»ç»Ÿ ==========
function startTrainingSession() {
    showScreen('training-screen');
    showTrainingScreenEnhanced();
}

function showTrainingScreenEnhanced() {
    if (appState.currentWordIndex >= appState.trainingWords.length) {
        finishTrainingEnhanced();
        return;
    }
    
    const word = appState.trainingWords[appState.currentWordIndex];
    const total = appState.trainingWords.length;
    const current = appState.currentWordIndex + 1;
    
    document.getElementById('training-progress').textContent = `${current}/${total}`;
    
    const learningMode = detectLearningMode();
    const modeInfo = getModeInfo(learningMode);
    
    const englishFontSize = getFontSizeClass(word.english);
    const chineseFontSize = getFontSizeClass(word.chinese);
    
    const memoryStrength = memoryCurve.calculateMemoryStrength(word);
    const memoryReminder = memoryCurve.getMemoryCurveReminder(word);
    
    let strengthClass = 'strength-high';
    if (memoryStrength < 0.4) strengthClass = 'strength-low';
    else if (memoryStrength < 0.7) strengthClass = 'strength-medium';
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <!-- æ¨¡å¼ä¿¡æ¯ -->
            <div style="background: ${modeInfo.color}; color: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; display: inline-block;">
                <span style="font-weight: bold;">${modeInfo.icon} ${modeInfo.name}</span>
            </div>
            
            <!-- å•è¯å¡ç‰‡ -->
            <div class="word-card ${appState.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
                <div class="word-card-content ${appState.isCardFlipped ? chineseFontSize : englishFontSize}">
                    ${appState.isCardFlipped ? `
                        <div style="color: #2E7D32; word-break: break-word;">
                            ${word.chinese}
                        </div>
                    ` : `
                        <div style="color: #333; word-break: break-word;">
                            ${word.english}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- å•è¯çŠ¶æ€ä¿¡æ¯ -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
                    <div>
                        <div style="color: #666; font-size: 12px;">çŠ¶æ€</div>
                        <div style="font-weight: bold; color: ${getStatusColor(word.status)}">
                            ${getStatusText(word.status)}
                        </div>
                    </div>
                    <div>
                        <div style="color: #666; font-size: 12px;">å¤ä¹ æ¬¡æ•°</div>
                        <div style="font-weight: bold;">${word.review_count || 0}æ¬¡</div>
                    </div>
                    <div>
                        <div style="color: #666; font-size: 12px;">è®°å¿†å¼ºåº¦</div>
                        <div style="font-weight: bold;">
                            ${Math.round(memoryStrength * 100)}%
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666; font-size: 12px;">${memoryReminder}</span>
                        <span style="color: #666; font-size: 12px;">${Math.round(memoryStrength * 100)}%</span>
                    </div>
                    <div class="memory-strength-bar">
                        <div class="memory-strength-fill ${strengthClass}" style="width: ${memoryStrength * 100}%"></div>
                    </div>
                </div>
                
                ${word.last_reviewed ? `
                    <div style="color: #666; font-size: 12px; text-align: center; margin-top: 10px;">
                        ä¸Šæ¬¡å¤ä¹ : ${new Date(word.last_reviewed).toLocaleDateString('zh-CN')}
                    </div>
                ` : ''}
            </div>
            
            <!-- çŠ¶æ€æŒ‰é’® -->
            <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn" onclick="markTrainingWordEnhanced('mastered')" 
                        style="padding: 15px; background: #4CAF50;">
                    <div style="font-size: 20px; margin-bottom: 5px;">âœ…</div>
                    <div>å·²æŒæ¡</div>
                </button>
                
                <button class="btn btn-blue" onclick="markTrainingWordEnhanced('learning')" 
                        style="padding: 15px; background: #2196F3;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ”„</div>
                    <div>å­¦ä¹ ä¸­</div>
                </button>
                
                <button class="btn" onclick="markTrainingWordEnhanced('new')" 
                        style="padding: 15px; background: #FF9800;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ“</div>
                    <div>éœ€å­¦ä¹ </div>
                </button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn" onclick="skipTrainingWord()" 
                        style="flex: 1; padding: 12px; background: #9E9E9E;">
                    <div>â­ï¸ è·³è¿‡</div>
                </button>
                
                <button class="btn" onclick="saveTrainingProgress()" 
                        style="flex: 1; padding: 12px; background: #607D8B;">
                    <div>ğŸ’¾ ä¿å­˜è¿›åº¦</div>
                </button>
                
                <button class="btn" onclick="showStudentDashboard()" 
                        style="flex: 1; padding: 12px; background: #795548;">
                    <div>ğŸ“‹ è¿”å›</div>
                </button>
            </div>
        </div>
    `;
}

function detectLearningMode() {
    const words = appState.trainingWords;
    if (!words || words.length === 0) return 'standard';
    
    const newWordsCount = words.filter(w => w.status === 'new').length;
    const learningWordsCount = words.filter(w => w.status === 'learning').length;
    const totalWords = words.length;
    
    if (newWordsCount >= 10 && learningWordsCount <= 5) {
        return 'extra_new_words';
    } else if (learningWordsCount >= 10) {
        return 'intensive_review';
    } else if (totalWords > 30) {
        return 'memory_curve';
    } else {
        return 'standard';
    }
}

function getModeInfo(mode) {
    const modes = {
        'standard': { name: 'æ ‡å‡†æ¨¡å¼', icon: 'ğŸ“…', color: '#4CAF50' },
        'extra_new_words': { name: 'é¢å¤–æ–°è¯', icon: 'ğŸ†•', color: '#2196F3' },
        'intensive_review': { name: 'å¼ºåŒ–å¤ä¹ ', icon: 'ğŸ”¥', color: '#FF9800' },
        'memory_curve': { name: 'è®°å¿†æ›²çº¿', icon: 'ğŸ“ˆ', color: '#9C27B0' }
    };
    return modes[mode] || modes['standard'];
}

function getStatusColor(status) {
    const colors = {
        'mastered': '#4CAF50',
        'learning': '#2196F3',
        'new': '#FF9800'
    };
    return colors[status] || '#666';
}

function getStatusText(status) {
    const texts = {
        'mastered': 'âœ… å·²æŒæ¡',
        'learning': 'ğŸ”„ å­¦ä¹ ä¸­',
        'new': 'ğŸ“ éœ€å­¦ä¹ '
    };
    return texts[status] || status;
}

async function markTrainingWordEnhanced(status) {
    const word = appState.trainingWords[appState.currentWordIndex];
    const learningMode = detectLearningMode();
    
    try {
        const { error } = await dbClient
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString(),
                learning_mode: learningMode,
                learned_today: new Date().toDateString()
            })
            .eq('student_id', appState.currentUser)
            .eq('word_id', word.word_id || word.id);
        
        if (error) throw error;
        
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        word.learning_mode = learningMode;
        
        const feedback = {
            'standard': 'åšæŒæ¯æ—¥å­¦ä¹ ï¼Œå¾ˆæ£’ï¼',
            'extra_new_words': 'é¢å¤–å­¦ä¹ ï¼Œè¶…é¢å®Œæˆï¼',
            'intensive_review': 'é‡ç‚¹å¤ä¹ ï¼Œæ•ˆæœåŠ å€ï¼',
            'memory_curve': 'ç§‘å­¦è®°å¿†ï¼Œé•¿ä¹…ä¸å¿˜ï¼'
        }[learningMode];
        
        showAlert(`${getStatusText(status)}: ${word.english}\n${feedback}`, 'success');
        
        setTimeout(() => {
            appState.currentWordIndex++;
            appState.isCardFlipped = false;
            
            if (appState.currentWordIndex < appState.trainingWords.length) {
                showTrainingScreenEnhanced();
            } else {
                finishTrainingEnhanced();
            }
        }, 800);
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

function flipTrainingCard() {
    const word = appState.trainingWords[appState.currentWordIndex];
    const card = document.querySelector('.word-card');
    const content = card.querySelector('.word-card-content');
    
    if (appState.isCardFlipped) {
        card.classList.remove('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.english);
        content.innerHTML = `
            <div style="color: #333; word-break: break-word;">
                ${word.english}
            </div>
        `;
    } else {
        card.classList.add('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.chinese);
        content.innerHTML = `
            <div style="color: #2E7D32; word-break: break-word;">
                ${word.chinese}
            </div>
        `;
    }
    
    appState.isCardFlipped = !appState.isCardFlipped;
}

function skipTrainingWord() {
    appState.currentWordIndex++;
    appState.isCardFlipped = false;
    
    if (appState.currentWordIndex < appState.trainingWords.length) {
        showTrainingScreenEnhanced();
    } else {
        finishTrainingEnhanced();
    }
}

function saveTrainingProgress() {
    if (appState.trainingWords.length === 0) return;
    
    const progress = {
        date: new Date().toDateString(),
        index: appState.currentWordIndex,
        total: appState.trainingWords.length,
        words: appState.trainingWords.map(w => w.id || w.word_id)
    };
    
    localStorage.setItem(`kathy_all_training_${appState.currentUser}`, JSON.stringify(progress));
    showAlert('è®­ç»ƒè¿›åº¦å·²ä¿å­˜ï¼', 'success');
}

function finishTrainingEnhanced() {
    const total = appState.trainingWords.length;
    const mastered = appState.trainingWords.filter(w => w.status === 'mastered').length;
    const learning = appState.trainingWords.filter(w => w.status === 'learning').length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    const learningMode = detectLearningMode();
    const modeInfo = getModeInfo(learningMode);
    
    localStorage.removeItem(`kathy_all_training_${appState.currentUser}`);
    
    loadStudentDashboardSimple();
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em; margin-bottom: 20px;">${modeInfo.icon}</div>
            <h3 style="color: #333; margin-bottom: 15px;">${modeInfo.name} è®­ç»ƒå®Œæˆï¼</h3>
            
            <div style="background: ${modeInfo.color}; color: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; display: inline-block;">
                <span style="font-weight: bold;">å­¦ä¹ æ¨¡å¼ï¼š${modeInfo.name}</span>
            </div>
            
            <div class="stats-card" style="max-width: 400px; margin: 0 auto;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">è®­ç»ƒå•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">å­¦ä¹ ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progress}%</div>
                        <div class="label">æŒæ¡ç‡</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h4 style="color: #333; margin-bottom: 10px;">ğŸ“Š å­¦ä¹ æˆæœåˆ†æ</h4>
                <p style="color: #666;">
                    ${
                        mastered >= total * 0.8 ? 
                        'ğŸ‰ å¤ªæ£’äº†ï¼ç»å¤§å¤šæ•°å•è¯éƒ½å·²æŒæ¡ï¼' :
                        mastered >= total * 0.5 ?
                        'ğŸ‘ ä¸é”™ï¼è¶…è¿‡ä¸€åŠå•è¯å·²ç»æŒæ¡ï¼' :
                        'ğŸ’ª ç»§ç»­åŠªåŠ›ï¼æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼'
                    }
                </p>
                <p style="color: #666; font-size: 14px;">
                    å­¦ä¹ ä¸­å•è¯ï¼š<strong>${learning}</strong>ä¸ªï¼ˆè¿™äº›å•è¯éœ€è¦é‡ç‚¹å¤ä¹ ï¼‰
                </p>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn" onclick="showStudentOptions()" style="margin: 10px;">
                    é€‰æ‹©å…¶ä»–æ¨¡å¼
                </button>
                <button class="btn btn-blue" onclick="startStandardDailyTraining()" style="margin: 10px;">
                    ç»§ç»­æ ‡å‡†å­¦ä¹ 
                </button>
                <button class="btn btn-red" onclick="showStudentDashboard()" style="margin: 10px;">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
}

function cancelTraining() {
    if (confirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„è®­ç»ƒè¿›åº¦å¯ä»¥ç¨åç»§ç»­ã€‚')) {
        saveTrainingProgress();
        showStudentDashboard();
    }
}

// ========== æ•™å¸ˆæ‰“å¡ç»Ÿè®¡åŠŸèƒ½ ==========
function showAttendanceReport() {
    showScreen('teacher-attendance-screen');
    loadAttendanceReport();
}

async function loadAttendanceReport() {
    const content = document.getElementById('teacher-attendance-content');
    content.innerHTML = `
        <div style="max-width: 1000px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“… å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡ç³»ç»Ÿ</h3>
            <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                <button class="btn" onclick="loadDailyAttendance()">ä»Šæ—¥æ‰“å¡</button>
                <button class="btn btn-blue" onclick="loadWeeklyAttendance()">æœ¬å‘¨ç»Ÿè®¡</button>
                <button class="btn" onclick="loadMonthlyAttendance()">æœ¬æœˆç»Ÿè®¡</button>
                <button class="btn btn-gold" onclick="loadConsecutiveAchievements()">è¿ç»­æ‰“å¡æ¦œ</button>
            </div>
            <div id="attendance-data">
                <p style="text-align: center;">é€‰æ‹©ç»Ÿè®¡èŒƒå›´</p>
            </div>
        </div>
    `;
}

async function loadDailyAttendance() {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('study_date', today);
        
        if (error) throw error;
        
        const content = document.getElementById('attendance-data');
        if (!attendance || attendance.length === 0) {
            content.innerHTML = '<p style="text-align: center;">ä»Šæ—¥è¿˜æ²¡æœ‰å­¦ç”Ÿæ‰“å¡</p>';
            return;
        }
        
        let html = `
            <h4 style="color: #333; margin-bottom: 15px;">ä»Šæ—¥æ‰“å¡ (${attendance.length}äºº)</h4>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>æ€»å•è¯æ•°</th>
                            <th>æ–°å•è¯</th>
                            <th>å¤ä¹ å•è¯</th>
                            <th>å­¦ä¹ æ¨¡å¼</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const record of attendance) {
            const { data: recentRecords } = await dbClient
                .from('study_records')
                .select('learning_mode')
                .eq('student_id', record.student_id)
                .gte('last_reviewed', today + 'T00:00:00')
                .limit(1);
            
            const learningMode = recentRecords?.[0]?.learning_mode || 'æ ‡å‡†æ¨¡å¼';
            const modeText = {
                'standard': 'æ ‡å‡†æ¨¡å¼',
                'extra_new_words': 'é¢å¤–æ–°è¯',
                'intensive_review': 'å¼ºåŒ–å¤ä¹ ',
                'memory_curve': 'è®°å¿†æ›²çº¿'
            }[learningMode] || learningMode;
            
            html += `
                <tr>
                    <td><strong>${record.student_id}</strong></td>
                    <td>${record.word_count}</td>
                    <td>${record.new_word_count}</td>
                    <td>${record.review_word_count}</td>
                    <td>${modeText}</td>
                    <td><span style="color: #4CAF50;">âœ… å·²å®Œæˆ</span></td>
                </tr>
            `;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½æ¯æ—¥æ‰“å¡é”™è¯¯:', error);
        document.getElementById('attendance-data').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function loadWeeklyAttendance() {
    try {
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - 7);
        
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('*')
            .gte('study_date', startOfWeek.toISOString().split('T')[0])
            .order('student_id')
            .order('study_date', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('attendance-data');
        if (!attendance || attendance.length === 0) {
            content.innerHTML = '<p style="text-align: center;">æœ¬å‘¨æ²¡æœ‰æ‰“å¡æ•°æ®</p>';
            return;
        }
        
        const studentStats = {};
        attendance.forEach(record => {
            if (!studentStats[record.student_id]) {
                studentStats[record.student_id] = {
                    totalDays: 0,
                    totalWords: 0,
                    totalNewWords: 0,
                    totalReviewWords: 0
                };
            }
            
            studentStats[record.student_id].totalDays++;
            studentStats[record.student_id].totalWords += record.word_count;
            studentStats[record.student_id].totalNewWords += record.new_word_count;
            studentStats[record.student_id].totalReviewWords += record.review_word_count;
        });
        
        let html = `
            <h4 style="color: #333; margin-bottom: 15px;">æœ¬å‘¨å­¦ä¹ ç»Ÿè®¡</h4>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>æ‰“å¡å¤©æ•°</th>
                            <th>æ€»å•è¯æ•°</th>
                            <th>æ–°å•è¯æ•°</th>
                            <th>å¤ä¹ å•è¯æ•°</th>
                            <th>å¹³å‡æ¯æ—¥</th>
                            <th>è¿ç»­å¤©æ•°</th>
                            <th>å­¦ä¹ æ•ˆç‡</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const [student, stats] of Object.entries(studentStats)) {
            const avgPerDay = Math.round(stats.totalWords / stats.totalDays);
            const consecutiveDays = await getConsecutiveDays(student);
            
            let efficiency = 'è‰¯å¥½';
            if (stats.totalWords >= 100) efficiency = 'ä¼˜ç§€';
            else if (stats.totalWords >= 50) efficiency = 'è‰¯å¥½';
            else efficiency = 'ä¸€èˆ¬';
            
            html += `
                <tr>
                    <td><strong>${student}</strong></td>
                    <td>${stats.totalDays}</td>
                    <td>${stats.totalWords}</td>
                    <td>${stats.totalNewWords}</td>
                    <td>${stats.totalReviewWords}</td>
                    <td>${avgPerDay}</td>
                    <td>${consecutiveDays}</td>
                    <td style="color: ${efficiency === 'ä¼˜ç§€' ? '#4CAF50' : efficiency === 'è‰¯å¥½' ? '#2196F3' : '#FF9800'}">
                        ${efficiency}
                    </td>
                </tr>
            `;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½æœ¬å‘¨ç»Ÿè®¡é”™è¯¯:', error);
        document.getElementById('attendance-data').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function getConsecutiveDays(studentId) {
    try {
        const { data: attendance } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', studentId)
            .order('study_date', { ascending: false })
            .limit(7);
        
        if (!attendance || attendance.length === 0) return 0;
        
        let consecutiveDays = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            const hasStudy = attendance.some(record => 
                record.study_date === dateStr
            );
            
            if (hasStudy) {
                consecutiveDays++;
            } else {
                break;
            }
        }
        
        return consecutiveDays;
        
    } catch (error) {
        return 0;
    }
}

async function loadMonthlyAttendance() {
    try {
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('*')
            .gte('study_date', startOfMonth.toISOString().split('T')[0])
            .order('student_id')
            .order('study_date', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('attendance-data');
        if (!attendance || attendance.length === 0) {
            content.innerHTML = '<p style="text-align: center;">æœ¬æœˆæ²¡æœ‰æ‰“å¡æ•°æ®</p>';
            return;
        }
        
        const studentStats = {};
        attendance.forEach(record => {
            if (!studentStats[record.student_id]) {
                studentStats[record.student_id] = {
                    totalDays: 0,
                    totalWords: 0,
                    totalNewWords: 0,
                    totalReviewWords: 0,
                    studyDates: new Set()
                };
            }
            
            studentStats[record.student_id].totalDays++;
            studentStats[record.student_id].totalWords += record.word_count;
            studentStats[record.student_id].totalNewWords += record.new_word_count;
            studentStats[record.student_id].totalReviewWords += record.review_word_count;
            studentStats[record.student_id].studyDates.add(record.study_date);
        });
        
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        
        let html = `
            <h4 style="color: #333; margin-bottom: 15px;">æœ¬æœˆå­¦ä¹ ç»Ÿè®¡ï¼ˆå…±${daysInMonth}å¤©ï¼‰</h4>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿ</th>
                            <th>å­¦ä¹ å¤©æ•°</th>
                            <th>å‡ºå‹¤ç‡</th>
                            <th>æ€»å•è¯æ•°</th>
                            <th>æ—¥å‡å•è¯</th>
                            <th>æ–°å•è¯</th>
                            <th>å¤ä¹ å•è¯</th>
                            <th>æŒæ¡ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const [student, stats] of Object.entries(studentStats)) {
            const attendanceRate = Math.round((stats.totalDays / daysInMonth) * 100);
            const avgPerDay = Math.round(stats.totalWords / stats.totalDays);
            
            const { data: studyStats } = await dbClient
                .from('study_records')
                .select('status')
                .eq('student_id', student);
            
            const totalWords = studyStats?.length || 0;
            const masteredWords = studyStats?.filter(s => s.status === 'mastered').length || 0;
            const masteryRate = totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0;
            
            html += `
                <tr>
                    <td><strong>${student}</strong></td>
                    <td>${stats.totalDays}</td>
                    <td style="color: ${attendanceRate >= 80 ? '#4CAF50' : attendanceRate >= 60 ? '#2196F3' : '#FF9800'}">
                        ${attendanceRate}%
                    </td>
                    <td>${stats.totalWords}</td>
                    <td>${avgPerDay}</td>
                    <td>${stats.totalNewWords}</td>
                    <td>${stats.totalReviewWords}</td>
                    <td style="color: ${masteryRate >= 70 ? '#4CAF50' : masteryRate >= 50 ? '#2196F3' : '#FF9800'}">
                        ${masteryRate}%
                    </td>
                </tr>
            `;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½æœ¬æœˆç»Ÿè®¡é”™è¯¯:', error);
        document.getElementById('attendance-data').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function loadConsecutiveAchievements() {
    try {
        const { data: achievements, error } = await dbClient
            .from('achievements')
            .select('*')
            .eq('achievement_type', 'consecutive_7_days')
            .order('awarded_date', { ascending: false })
            .limit(20);
        
        if (error) throw error;
        
        const content = document.getElementById('attendance-data');
        
        if (!achievements || achievements.length === 0) {
            content.innerHTML = '<p style="text-align: center;">è¿˜æ²¡æœ‰å­¦ç”Ÿè·å¾—è¿ç»­æ‰“å¡æˆå°±</p>';
            return;
        }
        
        let html = `
            <h4 style="color: #333; margin-bottom: 15px;">ğŸ† è¿ç»­æ‰“å¡æˆå°±æ¦œ</h4>
            <p style="color: #666; margin-bottom: 20px;">ä»¥ä¸‹å­¦ç”Ÿè·å¾—äº†è¿ç»­7å¤©å­¦ä¹ æˆå°±ï¼š</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
        `;
        
        for (const achievement of achievements) {
            const awardDate = new Date(achievement.awarded_date).toLocaleDateString('zh-CN');
            
            html += `
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 10px; padding: 20px; text-align: center;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ†</div>
                    <div style="font-weight: bold; margin-bottom: 10px;">${achievement.student_id}</div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">è¿ç»­å­¦ä¹ 7å¤©</div>
                    <div style="color: #666; font-size: 12px;">è·å¾—æ—¶é—´: ${awardDate}</div>
                </div>
            `;
        }
        
        html += `</div>`;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½è¿ç»­æ‰“å¡æˆå°±é”™è¯¯:', error);
        document.getElementById('attendance-data').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// ========== å…¶ä»–å­¦ç”ŸåŠŸèƒ½ ==========
async function manualSyncWords() {
    try {
        showAlert('æ­£åœ¨åŒæ­¥å•è¯...', 'info');
        const syncedCount = await syncGroupWordsToStudent(appState.currentUser);
        
        if (syncedCount > 0) {
            showAlert(`åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥ ${syncedCount} ä¸ªæ–°å•è¯`, 'success');
        } else {
            showAlert('æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
        }
        
        await loadStudentDashboardSimple();
        
    } catch (error) {
        console.error('æ‰‹åŠ¨åŒæ­¥é”™è¯¯:', error);
        showAlert('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
    }
}

function showMyAchievementsPage() {
    showScreen('student-achievements-screen');
    loadStudentAchievements();
}

async function loadStudentAchievements() {
    try {
        const total = appState.userWords.length;
        const mastered = appState.userWords.filter(w => w.status === 'mastered').length;
        const totalReviews = appState.userWords.reduce((sum, word) => sum + (word.review_count || 0), 0);
        const learningWords = appState.userWords.filter(w => w.status === 'learning').length;
        
        const achievements = [];
        
        if (total >= 100) achievements.push({type: 'total_words_100', text: 'ğŸ† å•è¯å¤§å¸ˆï¼šå­¦ä¹ 100ä¸ªå•è¯', earned: true});
        else if (total >= 50) achievements.push({type: 'total_words_50', text: 'â­ å•è¯èƒ½æ‰‹ï¼šå­¦ä¹ 50ä¸ªå•è¯', earned: true});
        else if (total >= 10) achievements.push({type: 'total_words_10', text: 'âœ… å•è¯æ–°æ‰‹ï¼šå­¦ä¹ 10ä¸ªå•è¯', earned: true});
        else achievements.push({type: 'total_words_10', text: 'âœ… å•è¯æ–°æ‰‹ï¼šå­¦ä¹ 10ä¸ªå•è¯', earned: false});
        
        if (mastered >= 50) achievements.push({type: 'mastered_50', text: 'ğŸ¯ æŒæ¡å¤§å¸ˆï¼šæŒæ¡50ä¸ªå•è¯', earned: true});
        else if (mastered >= 20) achievements.push({type: 'mastered_20', text: 'ğŸ“š æŒæ¡èƒ½æ‰‹ï¼šæŒæ¡20ä¸ªå•è¯', earned: true});
        else achievements.push({type: 'mastered_20', text: 'ğŸ“š æŒæ¡èƒ½æ‰‹ï¼šæŒæ¡20ä¸ªå•è¯', earned: false});
        
        if (totalReviews >= 100) achievements.push({type: 'review_100', text: 'ğŸ”„ å¤ä¹ è¾¾äººï¼šæ€»å¤ä¹ 100æ¬¡', earned: true});
        else if (totalReviews >= 50) achievements.push({type: 'review_50', text: 'ğŸ“– å¤ä¹ èƒ½æ‰‹ï¼šæ€»å¤ä¹ 50æ¬¡', earned: true});
        else achievements.push({type: 'review_50', text: 'ğŸ“– å¤ä¹ èƒ½æ‰‹ï¼šæ€»å¤ä¹ 50æ¬¡', earned: false});
        
        if (appState.consecutiveDays >= 7) achievements.push({type: 'streak_7', text: 'ğŸ”¥ åšæŒä¹‹æ˜Ÿï¼šè¿ç»­å­¦ä¹ 7å¤©', earned: true});
        else if (appState.consecutiveDays >= 3) achievements.push({type: 'streak_3', text: 'ğŸ’ª åšæŒèƒ½æ‰‹ï¼šè¿ç»­å­¦ä¹ 3å¤©', earned: true});
        else achievements.push({type: 'streak_3', text: 'ğŸ’ª åšæŒèƒ½æ‰‹ï¼šè¿ç»­å­¦ä¹ 3å¤©', earned: false});
        
        if (learningWords >= 20) achievements.push({type: 'learning_20', text: 'ğŸš€ å­¦ä¹ å…ˆé”‹ï¼š20ä¸ªå•è¯æ­£åœ¨å­¦ä¹ ä¸­', earned: true});
        else if (learningWords >= 10) achievements.push({type: 'learning_10', text: 'ğŸ“ˆ å­¦ä¹ æ–°æ˜Ÿï¼š10ä¸ªå•è¯æ­£åœ¨å­¦ä¹ ä¸­', earned: true});
        else achievements.push({type: 'learning_10', text: 'ğŸ“ˆ å­¦ä¹ æ–°æ˜Ÿï¼š10ä¸ªå•è¯æ­£åœ¨å­¦ä¹ ä¸­', earned: false});
        
        const { data: dbAchievements, error } = await dbClient
            .from('achievements')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (!error && dbAchievements) {
            dbAchievements.forEach(achievement => {
                if (!achievements.some(a => a.type === achievement.achievement_type)) {
                    achievements.push({
                        type: achievement.achievement_type,
                        text: achievement.description,
                        earned: true
                    });
                }
            });
        }
        
        const earnedCount = achievements.filter(a => a.earned).length;
        const totalCount = achievements.length;
        
        const content = document.getElementById('achievements-content');
        content.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ† æˆ‘çš„å­¦ä¹ æˆå°±</h3>
                
                <div class="stats-card">
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${total}</div>
                            <div class="label">å•è¯æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${mastered}</div>
                            <div class="label">å·²æŒæ¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${totalReviews}</div>
                            <div class="label">æ€»å¤ä¹ æ¬¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${appState.consecutiveDays}</div>
                            <div class="label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">ğŸ–ï¸ æˆå°±è¿›åº¦ (${earnedCount}/${totalCount})</h4>
                        <div class="progress-bar" style="width: 200px;">
                            <div class="progress-fill" style="width: ${(earnedCount/totalCount)*100}%"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        ${achievements.map(achievement => `
                            <div style="background: ${achievement.earned ? '#E8F5E9' : '#f5f5f5'}; 
                                 border: 2px solid ${achievement.earned ? '#4CAF50' : '#ddd'}; 
                                 border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 24px;">
                                    ${achievement.earned ? 'âœ…' : 'â³'}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: ${achievement.earned ? '#333' : '#999'}">
                                        ${achievement.text}
                                    </div>
                                    <div style="color: ${achievement.earned ? '#4CAF50' : '#999'}; font-size: 12px; margin-top: 5px;">
                                        ${achievement.earned ? 'å·²è·å¾—' : 'æœªè·å¾—'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æˆå°±é”™è¯¯:', error);
        document.getElementById('achievements-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function showMyWordListPage() {
    showScreen('student-wordlist-screen');
    loadStudentWordList();
}

async function loadStudentWordList() {
    try {
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .order('last_reviewed', { ascending: false });
        
        if (error) throw error;
        
        appState.userWords = records || [];
        
        const content = document.getElementById('wordlist-content');
        
        if (!records || records.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å•è¯</h3>
                    <p style="color: #999;">ç­‰å¾…æ•™å¸ˆä¸Šä¼ å•è¯</p>
                </div>
            `;
            return;
        }
        
        const total = records.length;
        const mastered = records.filter(r => r.status === 'mastered').length;
        const learning = records.filter(r => r.status === 'learning').length;
        const review = records.filter(r => r.status === 'new').length;
        
        const recordsWithStrength = records.map(record => ({
            ...record,
            memory_strength: memoryCurve.calculateMemoryStrength(record),
            should_review: memoryCurve.shouldReviewToday(record)
        }));
        
        let html = `
            <div style="margin-bottom: 20px;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">å•è¯æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">å­¦ä¹ ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${review}</div>
                        <div class="label">éœ€å­¦ä¹ </div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <select id="word-filter" style="padding: 10px; border-radius: 5px; border: 2px solid #ddd; font-size: 16px;" onchange="filterMyWords()">
                    <option value="all">æ‰€æœ‰å•è¯</option>
                    <option value="mastered">å·²æŒæ¡</option>
                    <option value="learning">å­¦ä¹ ä¸­ï¼ˆé‡ç‚¹ï¼‰</option>
                    <option value="new">éœ€å­¦ä¹ </option>
                    <option value="need_review">éœ€æŒ‰è®°å¿†æ›²çº¿å¤ä¹ </option>
                    <option value="long_term">è¿œæœŸå•è¯ï¼ˆ30å¤©å‰ï¼‰</option>
                </select>
                <input type="text" id="word-search" placeholder="ğŸ” æœç´¢è‹±æ–‡æˆ–ä¸­æ–‡..." 
                       style="padding: 10px; border-radius: 5px; border: 2px solid #ddd; font-size: 16px; margin-left: 10px;"
                       oninput="filterMyWords()">
            </div>
            
            <div style="overflow-x: auto; max-height: 500px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>çŠ¶æ€</th>
                            <th>è®°å¿†å¼ºåº¦</th>
                            <th>å¤ä¹ æ¬¡æ•°</th>
                            <th>æœ€åå¤ä¹ </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="words-table-body">
        `;
        
        recordsWithStrength.forEach(record => {
            const memoryStrength = record.memory_strength;
            const memoryReminder = memoryCurve.getMemoryCurveReminder(record);
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const isLongTerm = record.last_reviewed && new Date(record.last_reviewed) < thirtyDaysAgo;
            
            let statusText, statusColor;
            switch(record.status) {
                case 'mastered': statusText = 'âœ… å·²æŒæ¡'; statusColor = '#4CAF50'; break;
                case 'learning': statusText = 'ğŸ”„ å­¦ä¹ ä¸­'; statusColor = '#2196F3'; break;
                default: statusText = 'ğŸ“ éœ€å­¦ä¹ '; statusColor = '#FF9800';
            }
            
            const lastReview = record.last_reviewed ? 
                new Date(record.last_reviewed).toLocaleDateString('zh-CN') : 'ä»æœª';
            
            let strengthClass = 'strength-high';
            if (memoryStrength < 0.4) strengthClass = 'strength-low';
            else if (memoryStrength < 0.7) strengthClass = 'strength-medium';
            
            html += `
                <tr data-status="${record.status}" 
                    data-english="${record.english.toLowerCase()}" 
                    data-chinese="${record.chinese}"
                    data-should-review="${record.should_review}"
                    data-long-term="${isLongTerm}">
                    <td><strong>${record.english}</strong></td>
                    <td>${record.chinese}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 60px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                                <div class="${strengthClass}" style="width: ${memoryStrength * 100}%; height: 100%;"></div>
                            </div>
                            <span style="font-size: 12px; color: #666;">${Math.round(memoryStrength * 100)}%</span>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">${memoryReminder}</div>
                    </td>
                    <td>${record.review_count || 0}</td>
                    <td>${lastReview}</td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                onclick="practiceSingleWord('${record.english}', '${record.chinese}')">ç»ƒä¹ </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-red" onclick="showStudentDashboard()">
                    <span>ğŸ”™ è¿”å›ä¸»é¡µ</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å•è¯åˆ—è¡¨é”™è¯¯:', error);
        document.getElementById('wordlist-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function filterMyWords() {
    const filter = document.getElementById('word-filter').value;
    const search = document.getElementById('word-search').value.toLowerCase();
    const rows = document.querySelectorAll('#words-table-body tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const english = row.getAttribute('data-english');
        const chinese = row.getAttribute('data-chinese');
        const shouldReview = row.getAttribute('data-should-review') === 'true';
        const longTerm = row.getAttribute('data-long-term') === 'true';
        
        let statusMatch = true;
        if (filter !== 'all') {
            if (filter === 'need_review') {
                statusMatch = shouldReview;
            } else if (filter === 'long_term') {
                statusMatch = longTerm;
            } else {
                statusMatch = (filter === status);
            }
        }
        
        const searchMatch = !search || 
                           english.includes(search) || 
                           chinese.includes(search);
        
        row.style.display = (statusMatch && searchMatch) ? '' : 'none';
    });
}

function practiceSingleWord(english, chinese) {
    appState.trainingWords = [{ english, chinese, status: 'new' }];
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    startTrainingSession();
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        appState.currentUser = null;
        appState.isTeacher = false;
        appState.userId = null;
        appState.userWords = [];
        appState.trainingWords = [];
        appState.selectedGroupId = null;
        appState.selectedWords = [];
        appState.dailyTrainingProgress = 0;
        appState.lastTrainingDate = null;
        appState.consecutiveDays = 0;
        appState.reviewDay = false;
        appState.todayWordsToReview = [];
        
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯æ™ºèƒ½è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        appState.currentUser = savedUser;
        appState.isTeacher = (savedRole === 'teacher');
        appState.userId = savedUser;
        
        if (appState.isTeacher) {
            showTeacherDashboard();
        } else {
            showStudentDashboard();
        }
    } else {
        testDatabase();
    }
    
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};
</script>
</body>
</html>
