<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        
        input[type="text"], textarea, input[type="password"], select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°å•è¯æ¡† */
        .word-card { 
            background: white; 
            border: 4px solid #4CAF50; 
            border-radius: 20px; 
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px auto; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            max-width: 600px;
            padding: 20px;
            word-wrap: break-word;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .word-card-content {
            width: 100%;
            text-align: center;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        /* æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´ */
        .font-size-xl { font-size: 2.8em; }
        .font-size-lg { font-size: 2.2em; }
        .font-size-md { font-size: 1.8em; }
        .font-size-sm { font-size: 1.5em; }
        .font-size-xs { font-size: 1.2em; }
        
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .message-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .message-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .message-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .message-info { background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB; }
        .message-warning { background: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; }
        
        .wechat-badge { background: #07C160; color: white; padding: 14px 28px; border-radius: 25px; display: inline-flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1em; margin: 15px 0; box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3); }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* å›ºå®šå¤´éƒ¨æ ·å¼ */
        .fixed-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            z-index: 1000; 
            padding: 15px 30px; 
            border-bottom: 2px solid #f0f0f0; 
        }
        
        .content-padding { padding-top: 100px; padding-bottom: 30px; }
        
        /* ä»Šæ—¥å®Œæˆæ¿€åŠ±æ ·å¼ */
        .celebration-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* ç»§ç»­è®­ç»ƒé€‰é¡¹ */
        .continue-options {
            background: #E3F2FD;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .batch-controls { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        
        /* æ–°å¢æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-page {
            text-align: center;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .error-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .error-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .offline-banner {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
            padding: 12px 20px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1500;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .two-column { grid-template-columns: 1fr; }
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { 
                height: 220px; 
                max-width: 90%;
                margin: 20px auto;
                padding: 15px;
            }
            .font-size-xl { font-size: 2.2em; }
            .font-size-lg { font-size: 1.8em; }
            .font-size-md { font-size: 1.5em; }
            .font-size-sm { font-size: 1.3em; }
            .font-size-xs { font-size: 1.1em; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
            .card-grid { grid-template-columns: 1fr 1fr; }
            .content-padding { padding-top: 90px; }
            .fixed-header { padding: 12px 20px; }
        }
        
        @media (max-width: 480px) {
            .word-card { 
                height: 200px; 
                padding: 10px;
            }
            .font-size-xl { font-size: 1.8em; }
            .font-size-lg { font-size: 1.5em; }
            .font-size-md { font-size: 1.3em; }
            .font-size-sm { font-size: 1.1em; }
            .font-size-xs { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="global-loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-message">æ­£åœ¨åŠ è½½...</div>
        <div style="color: #666; margin-top: 10px;" id="loading-details"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">ğŸ‘­å’Œå•è¯åšæœ‹å‹ğŸ§¡</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151</p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">ğŸ§¡Kathyé™ªä½ ä¸€èµ·å’Œå•è¯ç©æ¸¸æˆğŸ§¡</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box message-info">
                            æ­£åœ¨è¿æ¥ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testDatabase()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">ğŸ“± ä½¿ç”¨è¯´æ˜</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ‘©â€ğŸ«</div>
                                <div style="font-weight: bold; margin: 10px 0;">Kathyæ•™å¸ˆç«¯</div>
                                <div>å…³æ³¨å®ä»¬æ¯å¤©å•è¯è¿›åº¦</div>
                                <div>ä»Šå¤©ä½ å’Œå•è¯ç©æ¸¸æˆäº†ä¹ˆï¼Ÿ</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“</div>
                                <div style="font-weight: bold; margin: 10px 0;">å­¦ç”Ÿè´¦å·</div>
                                <div>Kathyå•ç‹¬å‘é€</div>
                                <div>åå­—é¦–å­—æ¯è¦å¤§å†™å“¦</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <div class="wechat-badge">
                                <span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            <p style="color: #555; margin-top: 15px;">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘‘ æ•™å¸ˆç®¡ç†é¢æ¿</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="teacher-stats" class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-purple" onclick="showUploadWordsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“</div>
                                <div>ä¸Šä¼ å•è¯</div>
                            </button>
                            <button class="btn btn-blue" onclick="showGroupManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ‘¥</div>
                                <div>åˆ†ç»„ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showAllStudentsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“‹</div>
                                <div>æ‰€æœ‰å­¦ç”Ÿ</div>
                            </button>
                            <button class="btn btn-gold" onclick="showLearningProgressPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“Š</div>
                                <div>å­¦ä¹ è¿›åº¦</div>
                            </button>
                            <button class="btn" onclick="showWordManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>å•è¯ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showShareSystemPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ”—</div>
                                <div>åˆ†äº«ç³»ç»Ÿ</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; color: #333;">ğŸ“ æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px;">
                                <div id="clock-in-status" style="background: #4CAF50; color: white; padding: 5px 10px; border-radius: 15px; font-size: 14px;">
                                    âœ… ä»Šæ—¥å·²æ‰“å¡
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    <span id="consecutive-days">0</span> å¤©è¿ç»­å­¦ä¹ 
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <!-- ä»Šæ—¥å­¦ä¹ æƒ…å†µ -->
                    <div id="today-status" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥æ•°æ® -->
                    </div>
                    
                    <!-- æˆ‘çš„å­¦ä¹ è¿›åº¦ -->
                    <div id="my-progress-summary" class="stats-card" style="margin-bottom: 30px;">
                        <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                        <!-- åŠ¨æ€åŠ è½½è¿›åº¦æ•°æ® -->
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button class="btn" onclick="dailyClockIn()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“…</div>
                                <div>æ¯æ—¥æ‰“å¡</div>
                            </button>
                            
                            <button class="btn" onclick="showTrainingOptions()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ¯</div>
                                <div>å¼€å§‹è®­ç»ƒ</div>
                            </button>
                            
                            <button class="btn btn-blue" onclick="showClockInStats()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“Š</div>
                                <div>å­¦ä¹ ç»Ÿè®¡</div>
                            </button>
                            
                            <button class="btn" onclick="showMyWordListPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>æˆ‘çš„å•è¯æœ¬</div>
                            </button>
                            
                            <button class="btn" onclick="startReviewTraining()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ”„</div>
                                <div>å¤ä¹ å¼±é¡¹</div>
                            </button>
                            
                            <button class="btn" onclick="showReviewPlan()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ“‹</div>
                                <div>æ™ºèƒ½å¤ä¹ </div>
                            </button>
                            
                            <button class="btn btn-gold" onclick="manualSyncWords()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ”„</div>
                                <div>ç«‹å³åŒæ­¥</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„åˆ†ç»„è¯¦æƒ… -->
                    <div id="group-details" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½åˆ†ç»„è¯¦æƒ… -->
                    </div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- è®­ç»ƒé€‰æ‹©é¡µé¢ -->
            <div id="training-options-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ é€‰æ‹©è®­ç»ƒæ¨¡å¼</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                            <h3 style="text-align: center; margin-bottom: 30px; color: #333;">é€‰æ‹©è®­ç»ƒå†…å®¹</h3>
                            
                            <div id="daily-training-options" style="margin-bottom: 40px;">
                                <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥è®­ç»ƒé€‰é¡¹ -->
                            </div>
                            
                            <div style="margin-bottom: 40px;">
                                <button class="btn" onclick="startAllWordsTraining()" 
                                        style="width: 100%; padding: 25px; font-size: 18px; margin-bottom: 15px;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“š</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">æ‰€æœ‰å•è¯è®­ç»ƒ</div>
                                    <div style="color: #666; font-size: 14px;">è®­ç»ƒæ‰€æœ‰å·²åŒæ­¥çš„å•è¯</div>
                                </button>
                                
                                <button class="btn btn-blue" onclick="startReviewTraining()" 
                                        style="width: 100%; padding: 25px; font-size: 18px;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">å¤ä¹ å¼±é¡¹</div>
                                    <div style="color: #666; font-size: 14px;">é‡ç‚¹å¤ä¹ æœªæŒæ¡å•è¯</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®­ç»ƒé¡µé¢ -->
            <div id="training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666;">
                            è¿›åº¦: <span id="training-progress">0/0</span>
                        </div>
                        <button class="btn btn-red" onclick="cancelTraining()" style="padding: 8px 16px;">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="training-content" style="max-width: 600px; margin: 0 auto;">
                        <!-- åŠ¨æ€åŠ è½½è®­ç»ƒå†…å®¹ -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿæˆå°±é¡µé¢ -->
            <div id="student-achievements-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ† æˆ‘çš„æˆå°±</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="achievements-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿå•è¯æœ¬é¡µé¢ -->
            <div id="student-wordlist-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– æˆ‘çš„å•è¯æœ¬</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="wordlist-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä»Šæ—¥ä»»åŠ¡é¡µé¢ -->
            <div id="student-today-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“… ä»Šæ—¥ä»»åŠ¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="today-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ ä¸Šä¼ å•è¯</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-upload-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ -->
            <div id="teacher-groups-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-groups-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ -->
            <div id="teacher-students-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-students-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ -->
            <div id="teacher-progress-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-progress-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ -->
            <div id="teacher-words-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– å•è¯ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-words-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†äº«ç³»ç»Ÿé¡µé¢ -->
            <div id="teacher-share-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ”— åˆ†äº«ç³»ç»Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-share-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šæ‰“å¡ç»Ÿè®¡é¡µé¢ -->
            <div id="clockin-stats-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <!-- è¿ç»­æ‰“å¡ç»Ÿè®¡ -->
                        <div class="stats-card">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ”¥ è¿ç»­æ‰“å¡è®°å½•</h3>
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 2.5em; font-weight: bold; color: #4CAF50;" id="current-streak">0</div>
                                    <div style="color: #666;">å½“å‰è¿ç»­æ‰“å¡</div>
                                </div>
                                <div>
                                    <div style="font-size: 2.5em; font-weight: bold; color: #2196F3;" id="longest-streak">0</div>
                                    <div style="color: #666;">æœ€é•¿è¿ç»­æ‰“å¡</div>
                                </div>
                                <div>
                                    <div style="font-size: 2.5em; font-weight: bold; color: #9C27B0;" id="total-days">0</div>
                                    <div style="color: #666;">æ€»æ‰“å¡å¤©æ•°</div>
                                </div>
                            </div>
                            
                            <!-- æ‰“å¡æ—¥å† -->
                            <div id="clockin-calendar">
                                <h4 style="color: #333; margin-bottom: 15px;">ğŸ“… æ‰“å¡æ—¥å†</h4>
                                <div id="calendar-container"></div>
                            </div>
                        </div>
                        
                        <!-- æœˆåº¦ç»Ÿè®¡ -->
                        <div class="stats-card" style="margin-top: 20px;">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ˆ æœˆåº¦å­¦ä¹ æ•°æ®</h3>
                            <div id="month-stats-content">
                                <!-- åŠ¨æ€åŠ è½½æœˆåº¦ç»Ÿè®¡ -->
                            </div>
                        </div>
                        
                        <!-- å­¦ä¹ è¶‹åŠ¿ -->
                        <div class="stats-card" style="margin-top: 20px;">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“Š å­¦ä¹ è¶‹åŠ¿</h3>
                            <div id="study-trend" style="height: 300px;">
                                <!-- å¯ä»¥æ”¾ç½®å›¾è¡¨ -->
                            </div>
                        </div>
                        
                        <!-- å¥–åŠ±è®°å½• -->
                        <div class="stats-card" style="margin-top: 20px;">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ† å­¦ä¹ å¥–åŠ±</h3>
                            <div id="rewards-list">
                                <!-- åŠ¨æ€åŠ è½½å¥–åŠ± -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šæ¯æ—¥ä»»åŠ¡ç”Ÿæˆé¡µé¢ -->
            <div id="daily-task-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ ä»Šæ—¥å­¦ä¹ ä»»åŠ¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <!-- ä»»åŠ¡æ¨¡å¼é€‰æ‹© -->
                        <div class="stats-card">
                            <h3 style="color: #333; margin-bottom: 15px;">ğŸ“ é€‰æ‹©å­¦ä¹ æ¨¡å¼</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                <button class="btn" onclick="selectTaskMode(0)" id="mode-standard" style="padding: 20px;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“š</div>
                                    <div style="font-weight: bold;">æ ‡å‡†æ¨¡å¼</div>
                                    <div style="color: #666; font-size: 14px; margin-top: 5px;">10æ–°è¯+10å¤ä¹ </div>
                                </button>
                                
                                <button class="btn btn-blue" onclick="selectTaskMode(1)" id="mode-review" style="padding: 20px;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
                                    <div style="font-weight: bold;">å¤ä¹ æ¨¡å¼</div>
                                    <div style="color: #666; font-size: 14px; margin-top: 5px;">å¤ä¹ 20ä¸ªå•è¯</div>
                                </button>
                                
                                <button class="btn" onclick="selectTaskMode(2)" id="mode-extra" style="padding: 20px;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">âœ¨</div>
                                    <div style="font-weight: bold;">é¢å¤–æ–°è¯</div>
                                    <div style="color: #666; font-size: 14px; margin-top: 5px;">å­¦ä¹ 20ä¸ªæ–°è¯</div>
                                </button>
                            </div>
                            
                            <div style="text-align: center; color: #666; font-size: 14px;">
                                <p>ğŸ“… è¿ç»­å­¦ä¹  <span id="consecutive-task-days">0</span> å¤©</p>
                                <p id="review-day-notice" style="display: none; color: #FF9800; font-weight: bold;">ğŸ‰ ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼ä¸»è¦å¤ä¹ å·²å­¦å•è¯</p>
                            </div>
                        </div>
                        
                        <!-- ä»Šæ—¥ä»»åŠ¡è¯¦æƒ… -->
                        <div id="task-details" style="margin-top: 30px;">
                            <!-- åŠ¨æ€åŠ è½½ä»»åŠ¡è¯¦æƒ… -->
                        </div>
                        
                        <!-- å¼€å§‹å­¦ä¹ æŒ‰é’® -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn" onclick="startDailyTask()" id="start-task-btn" style="padding: 15px 40px; font-size: 18px;">
                                å¼€å§‹å­¦ä¹ 
                            </button>
                        </div>
                    </div>
                </div>
            </div>
<!-- æ–°å¢ï¼šå•è¯åˆ†ç±»æŸ¥çœ‹é¡µé¢ -->
<div id="word-categories-screen" class="screen">
    <div class="fixed-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #333;">ğŸ“š å•è¯åˆ—è¡¨</h2>
            <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                <span>ğŸ”™ è¿”å›</span>
            </button>
        </div>
    </div>
    
    <div class="content-padding">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div id="category-words-content">
                <!-- è¿™é‡Œä¼šåŠ¨æ€æ˜¾ç¤ºå•è¯åˆ—è¡¨ -->
            </div>
        </div>
    </div>
</div>
            


            <!-- æ–°å¢ï¼šå¤ä¹ è®¡åˆ’é¡µé¢ -->
            <div id="review-plan-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ”„ æ™ºèƒ½å¤ä¹ è®¡åˆ’</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <!-- å¤ä¹ ç»Ÿè®¡ -->
                        <div class="stats-card">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“Š å¤ä¹ æ¦‚å†µ</h3>
                            <div class="card-grid">
                                <div class="stat-card">
                                    <div class="number" id="due-reviews">0</div>
                                    <div class="label">ä»Šæ—¥éœ€å¤ä¹ </div>
                                </div>
                                <div class="stat-card">
                                    <div class="number" id="weak-words">0</div>
                                    <div class="label">å¼±é¡¹å•è¯</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number" id="medium-words">0</div>
                                    <div class="label">ä¸­ç­‰æŒæ¡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number" id="strong-words">0</div>
                                    <div class="label">ç‰¢å›ºæŒæ¡</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¤ä¹ æ—¶é—´è¡¨ -->
                        <div class="stats-card" style="margin-top: 20px;">
                            <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’</h3>
                            <div id="ebbinghaus-schedule">
                                <!-- åŠ¨æ€åŠ è½½å¤ä¹ æ—¶é—´è¡¨ -->
                            </div>
                        </div>
                        
                        <!-- æ™ºèƒ½å¤ä¹ é€‰é¡¹ -->
                        <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 20px;">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ¯ é€‰æ‹©å¤ä¹ æ–¹å¼</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <button class="btn" onclick="startSmartReview('due')" style="height: 100px; font-size: 18px;">
                                    <div style="font-size: 28px; margin-bottom: 10px;">ğŸ“…</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">ä»Šæ—¥åˆ°æœŸå¤ä¹ </div>
                                    <div style="color: #666; font-size: 14px;">å¤ä¹ ä»Šæ—¥åˆ°æœŸçš„å•è¯</div>
                                </button>
                                
                                <button class="btn btn-blue" onclick="startSmartReview('weak')" style="height: 100px; font-size: 18px;">
                                    <div style="font-size: 28px; margin-bottom: 10px;">âš ï¸</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">å¼±é¡¹é‡ç‚¹å¤ä¹ </div>
                                    <div style="color: #666; font-size: 14px;">é‡ç‚¹å¤ä¹ è®°å¿†è–„å¼±å•è¯</div>
                                </button>
                                
                                <button class="btn" onclick="startSmartReview('random')" style="height: 100px; font-size: 18px;">
                                    <div style="font-size: 28px; margin-bottom: 10px;">ğŸ²</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">éšæœºå¤ä¹ </div>
                                    <div style="color: #666; font-size: 14px;">éšæœºå¤ä¹ æ‰€æœ‰å•è¯</div>
                                </button>
                                
                                <button class="btn" onclick="startSmartReview('urgent')" style="height: 100px; font-size: 18px;">
                                    <div style="font-size: 28px; margin-bottom: 10px;">ğŸ”¥</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">ç´§æ€¥å¤ä¹ </div>
                                    <div style="color: #666; font-size: 14px;">å¤ä¹ å³å°†åˆ°æœŸçš„å•è¯</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null
};

// ========== æ–°å¢ï¼šè¿æ¥çŠ¶æ€å’Œé…ç½® ==========
const connectionState = {
    isOnline: navigator.onLine,
    retryCount: 0,
    maxRetries: 3,
    retryDelay: 2000,
    isLoading: false,
    lastError: null,
    isOfflineMode: false,
    connectionCheckInterval: null
};

// ========== æ–°å¢ï¼šæ‰“å¡ç³»ç»Ÿç›¸å…³å˜é‡ ==========
const clockInSystem = {
    currentStreak: 0,
    longestStreak: 0,
    totalDays: 0,
    todayClockedIn: false,
    selectedTaskMode: 0, // 0=æ ‡å‡†æ¨¡å¼, 1=å¤ä¹ æ¨¡å¼, 2=é¢å¤–æ–°è¯æ¨¡å¼
    isReviewDay: false,
    dailyTask: null,
    reviewPlans: []
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

// ========== æ–°å¢ï¼šåŠ è½½åŠ¨ç”»æ§åˆ¶ ==========
function showLoading(message = 'æ­£åœ¨åŠ è½½', details = '') {
    connectionState.isLoading = true;
    const loadingEl = document.getElementById('global-loading');
    if (loadingEl) {
        loadingEl.style.display = 'flex';
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-details').textContent = details;
    }
}

function hideLoading() {
    connectionState.isLoading = false;
    const loadingEl = document.getElementById('global-loading');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
}

function updateLoadingMessage(message) {
    const messageEl = document.getElementById('loading-message');
    if (messageEl) {
        messageEl.textContent = message;
    }
}

// ========== ä¿®æ”¹ï¼šshowMessageå‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰ ==========
function showMessage(elementId, message, type = 'info', duration = 0) {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
    
    // è‡ªåŠ¨éšè—
    if (duration > 0) {
        setTimeout(() => {
            el.style.display = 'none';
        }, duration);
    }
}

// ========== ä¿®æ”¹ï¼šshowAlertå‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰ ==========
function showAlert(message, type = 'info', duration = 3000) {
    const alertBox = document.createElement('div');
    alertBox.className = `message-box message-${type}`;
    alertBox.style.position = 'fixed';
    alertBox.style.top = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.zIndex = '1000';
    alertBox.style.maxWidth = '500px';
    alertBox.style.animation = 'slideDown 0.3s ease-out';
    alertBox.textContent = message;

   // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('span');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.cssText = `
        position: absolute;
        right: 10px;
        top: 10px;
        cursor: pointer;
        font-size: 20px;
        color: inherit;
        opacity: 0.7;
    `;
    closeBtn.onclick = () => alertBox.remove();
    
    alertBox.appendChild(closeBtn);
    document.body.appendChild(alertBox);
    
    // è‡ªåŠ¨ç§»é™¤
    if (duration > 0) {
        setTimeout(() => {
            if (alertBox.parentNode) {
                alertBox.style.opacity = '0';
                alertBox.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (alertBox.parentNode) {
                        alertBox.remove();
                    }
                }, 300);
            }
        }, duration);
    }
    
    return alertBox;
}

// ========== æ™ºèƒ½å­—ä½“å¤§å°è°ƒæ•´ ==========
function getFontSizeClass(text) {
    const length = text.length;
    if (length <= 10) return 'font-size-xl';
    if (length <= 15) return 'font-size-lg';
    if (length <= 20) return 'font-size-md';
    if (length <= 25) return 'font-size-sm';
    return 'font-size-xs';
}

// ========== æ–°å¢ï¼šæ‰“å¡ç³»ç»Ÿæ ¸å¿ƒå‡½æ•° ==========

// åŠ è½½æ‰“å¡çŠ¶æ€
async function loadClockInStatus() {
    try {
        // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
        const today = new Date().toISOString().split('T')[0];
        const { data: todayRecord, error } = await dbClient
            .from('clock_in_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('clock_in_date', today)
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error('åŠ è½½æ‰“å¡çŠ¶æ€é”™è¯¯:', error);
            return;
        }
        
        clockInSystem.todayClockedIn = !!todayRecord?.is_clock_in;
        
        // æ›´æ–°UIæ˜¾ç¤º
        updateClockInUI();
        
        // è·å–è¿ç»­æ‰“å¡å¤©æ•°
        await loadConsecutiveDays();
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡çŠ¶æ€é”™è¯¯:', error);
    }
}

// æ›´æ–°æ‰“å¡UI
function updateClockInUI() {
    const clockInStatus = document.getElementById('clock-in-status');
    if (!clockInStatus) return;
    
    if (clockInSystem.todayClockedIn) {
        clockInStatus.innerHTML = 'âœ… ä»Šæ—¥å·²æ‰“å¡';
        clockInStatus.style.background = '#4CAF50';
    } else {
        clockInStatus.innerHTML = 'ğŸ“… ä»Šæ—¥æœªæ‰“å¡';
        clockInStatus.style.background = '#FF9800';
    }
    
    // æ›´æ–°è¿ç»­å¤©æ•°æ˜¾ç¤º
    const consecutiveDaysEl = document.getElementById('consecutive-days');
    if (consecutiveDaysEl) {
        consecutiveDaysEl.textContent = clockInSystem.currentStreak;
    }
}

// åŠ è½½è¿ç»­æ‰“å¡å¤©æ•°
async function loadConsecutiveDays() {
    try {
        // è·å–æ‰€æœ‰æ‰“å¡è®°å½•
        const { data: records, error } = await dbClient
            .from('clock_in_records')
            .select('clock_in_date')
            .eq('student_id', appState.currentUser)
            .eq('is_clock_in', true)
            .order('clock_in_date', { ascending: false });
        
        if (error) throw error;
        
        if (!records || records.length === 0) {
            clockInSystem.currentStreak = 0;
            clockInSystem.totalDays = 0;
            updateClockInUI();
            return;
        }
        
        // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦æ‰“å¡
        const todayStr = today.toISOString().split('T')[0];
        const hasToday = records.some(r => r.clock_in_date === todayStr);
        
        // è®¡ç®—æœ€é•¿è¿ç»­å¤©æ•°
        for (let i = 0; i < records.length - 1; i++) {
            const currentDate = new Date(records[i].clock_in_date);
            const nextDate = new Date(records[i + 1].clock_in_date);
            const diffDays = Math.floor((currentDate - nextDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                tempStreak++;
                longestStreak = Math.max(longestStreak, tempStreak);
            } else {
                tempStreak = 0;
            }
        }
        
        // è®¡ç®—å½“å‰è¿ç»­å¤©æ•°
        if (hasToday) {
            currentStreak = 1;
            let expectedDate = new Date(today);
            
            for (let i = 1; i < records.length; i++) {
                expectedDate.setDate(expectedDate.getDate() - 1);
                const expectedStr = expectedDate.toISOString().split('T')[0];
                
                if (records[i]?.clock_in_date === expectedStr) {
                    currentStreak++;
                } else {
                    break;
                }
            }
        }
        
        clockInSystem.currentStreak = currentStreak;
        clockInSystem.longestStreak = longestStreak + 1; // åŠ 1å› ä¸ºèµ·å§‹ä¸º0
        clockInSystem.totalDays = records.length;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬7å¤©ï¼ˆå¤ä¹ æ—¥ï¼‰
        clockInSystem.isReviewDay = (currentStreak % 7 === 0);
        
        updateClockInUI();
        
    } catch (error) {
        console.error('è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°é”™è¯¯:', error);
    }
}

// æ¯æ—¥æ‰“å¡
async function dailyClockIn() {
    if (clockInSystem.todayClockedIn) {
        showAlert('ä»Šå¤©å·²ç»æ‰“è¿‡å¡äº†ï¼', 'info');
        return;
    }
    
    showAlert('æ­£åœ¨ç”Ÿæˆä»Šæ—¥ä»»åŠ¡...', 'info');
    
    // æ˜¾ç¤ºä»»åŠ¡é€‰æ‹©é¡µé¢
    showDailyTaskPage();
}

// æ˜¾ç¤ºæ¯æ—¥ä»»åŠ¡é¡µé¢
function showDailyTaskPage() {
    showScreen('daily-task-screen');
    loadDailyTaskPage();
}

// åŠ è½½æ¯æ—¥ä»»åŠ¡é¡µé¢
function loadDailyTaskPage() {
    // æ›´æ–°è¿ç»­å¤©æ•°æ˜¾ç¤º
    const consecutiveTaskDaysEl = document.getElementById('consecutive-task-days');
    if (consecutiveTaskDaysEl) {
        consecutiveTaskDaysEl.textContent = clockInSystem.currentStreak;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å¤ä¹ æ—¥
    const reviewDayNotice = document.getElementById('review-day-notice');
    if (reviewDayNotice) {
        reviewDayNotice.style.display = clockInSystem.isReviewDay ? 'block' : 'none';
    }
    
    // é‡ç½®æ¨¡å¼é€‰æ‹©
    clockInSystem.selectedTaskMode = 0;
    selectTaskMode(0);
    
    // ç”Ÿæˆä»»åŠ¡é¢„è§ˆ
    generateTaskPreview();
}

// é€‰æ‹©ä»»åŠ¡æ¨¡å¼
function selectTaskMode(mode) {
    clockInSystem.selectedTaskMode = mode;
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    ['mode-standard', 'mode-review', 'mode-extra'].forEach((id, index) => {
        const btn = document.getElementById(id);
        if (btn) {
            if (index === mode) {
                btn.style.border = '3px solid #4CAF50';
                btn.style.background = '#E8F5E9';
            } else {
                btn.style.border = '2px solid #ddd';
                btn.style.background = '';
            }
        }
    });
    
    generateTaskPreview();
}

// ç”Ÿæˆä»»åŠ¡é¢„è§ˆ
async function generateTaskPreview() {
    const taskDetails = document.getElementById('task-details');
    if (!taskDetails) return;
    
    // æ ¹æ®æ¨¡å¼ç”Ÿæˆä»»åŠ¡æè¿°
    let newWords = 0;
    let reviewWords = 0;
    let description = '';
    
    if (clockInSystem.isReviewDay) {
        // å¤ä¹ æ—¥ï¼Œä¸å­¦æ–°å•è¯
        newWords = 0;
        reviewWords = 20;
        description = 'ğŸ“… ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼ä¸“æ³¨å¤ä¹ å·²å­¦å•è¯';
    } else {
        switch (clockInSystem.selectedTaskMode) {
            case 0: // æ ‡å‡†æ¨¡å¼
                newWords = 10;
                reviewWords = 10;
                description = 'ğŸ“š æ ‡å‡†å­¦ä¹ ï¼šå‡è¡¡æ–°è¯ä¸å¤ä¹ ';
                break;
            case 1: // å¤ä¹ æ¨¡å¼
                newWords = 0;
                reviewWords = 20;
                description = 'ğŸ”„ ä¸“æ³¨å¤ä¹ ï¼šå·©å›ºå·²å­¦å•è¯';
                break;
            case 2: // é¢å¤–æ–°è¯æ¨¡å¼
                newWords = 20;
                reviewWords = 0;
                description = 'âœ¨ æ‹“å±•æ–°è¯ï¼šå¿«é€Ÿæ‰©å……è¯æ±‡é‡';
                break;
        }
    }
    
    // æ™ºèƒ½é€‰æ‹©å•è¯
    const taskWords = await selectSmartWords(newWords, reviewWords);
    
    // ä¿å­˜ä»»åŠ¡
    clockInSystem.dailyTask = {
        mode: clockInSystem.selectedTaskMode,
        newWords: newWords,
        reviewWords: reviewWords,
        isReviewDay: clockInSystem.isReviewDay,
        words: taskWords,
        description: description
    };
    
    // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
    taskDetails.innerHTML = `
        <div class="stats-card">
            <h4 style="color: #333; margin-bottom: 15px;">${description}</h4>
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${newWords}</div>
                    <div class="label">æ–°å•è¯</div>
                </div>
                <div class="stat-card">
                    <div class="number">${reviewWords}</div>
                    <div class="label">å¤ä¹ å•è¯</div>
                </div>
                <div class="stat-card">
                    <div class="number">${newWords + reviewWords}</div>
                    <div class="label">æ€»è®¡</div>
                </div>
            </div>
            
            ${taskWords.newWords.length > 0 ? `
                <div style="margin-top: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px;">ğŸ“– æ–°å•è¯åˆ—è¡¨</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${taskWords.newWords.slice(0, 5).map(word => `
                            <div style="background: #E3F2FD; padding: 8px 12px; border-radius: 8px; font-size: 14px;">
                                ${word.english}
                            </div>
                        `).join('')}
                        ${taskWords.newWords.length > 5 ? `<div style="color: #666; padding: 8px;">...ç­‰ ${taskWords.newWords.length} ä¸ªå•è¯</div>` : ''}
                    </div>
                </div>
            ` : ''}
            
            ${taskWords.reviewWords.length > 0 ? `
                <div style="margin-top: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px;">ğŸ”„ å¤ä¹ å•è¯åˆ—è¡¨</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${taskWords.reviewWords.slice(0, 5).map(word => `
                            <div style="background: #E8F5E9; padding: 8px 12px; border-radius: 8px; font-size: 14px;">
                                ${word.english}
                            </div>
                        `).join('')}
                        ${taskWords.reviewWords.length > 5 ? `<div style="color: #666; padding: 8px;">...ç­‰ ${taskWords.reviewWords.length} ä¸ªå•è¯</div>` : ''}
                    </div>
                </div>
            ` : ''}
            
            <div style="margin-top: 20px; padding: 15px; background: #FFF3CD; border-radius: 10px;">
                <p style="color: #856404; margin: 0;">
                    ğŸ’¡ æç¤ºï¼šå®Œæˆä»Šæ—¥ä»»åŠ¡å¯è·å¾— ${clockInSystem.currentStreak + 1} å¤©è¿ç»­æ‰“å¡è®°å½•ï¼
                    ${clockInSystem.currentStreak + 1 >= 7 ? 'ğŸ‰ å³å°†è·å¾—7å¤©å¥–åŠ±ï¼' : ''}
                </p>
            </div>
        </div>
    `;
}

// æ™ºèƒ½é€‰æ‹©å•è¯
async function selectSmartWords(newWordCount, reviewWordCount) {
    try {
        const result = {
            newWords: [],
            reviewWords: []
        };
        
        // è·å–å­¦ç”Ÿå•è¯
        const { data: allWords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        if (!allWords || allWords.length === 0) {
            return result;
        }
        
        // æŒ‰çŠ¶æ€åˆ†ç±»å•è¯
        const newWords = allWords.filter(w => w.status === 'new');
        const learningWords = allWords.filter(w => w.status === 'learning');
        const masteredWords = allWords.filter(w => w.status === 'mastered');
        
        // é€‰æ‹©æ–°å•è¯ï¼ˆä»æœªå­¦è¿‡çš„ï¼‰
        if (newWordCount > 0) {
            // éšæœºé€‰æ‹©æ–°å•è¯
            const shuffledNew = [...newWords].sort(() => Math.random() - 0.5);
            result.newWords = shuffledNew.slice(0, newWordCount);
        }
        
        // é€‰æ‹©å¤ä¹ å•è¯
        if (reviewWordCount > 0) {
            let reviewCandidates = [];
            
            // å¦‚æœå•è¯æ€»æ•°è¶…è¿‡100ï¼Œé™åˆ¶ç†Ÿæ‚‰å•è¯æ•°é‡
            const maxLearningReview = allWords.length > 100 ? 8 : 20;
            
            // æ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿é€‰æ‹©
            if (clockInSystem.isReviewDay) {
                // å¤ä¹ æ—¥ï¼šæŒ‰æƒé‡é€‰æ‹©
                // æ²¡å°è±¡ï¼ˆ45%ï¼‰ã€ç†Ÿæ‚‰ï¼ˆ40%ï¼‰ã€å·²æŒæ¡ï¼ˆ15%ï¼‰
                const needReview = Math.floor(reviewWordCount * 0.45);
                const learningReview = Math.floor(reviewWordCount * 0.40);
                const masteredReview = reviewWordCount - needReview - learningReview;
                
                // æ²¡å°è±¡å•è¯
                const shuffledNeed = [...newWords].sort(() => Math.random() - 0.5);
                reviewCandidates = reviewCandidates.concat(shuffledNeed.slice(0, needReview));
                
                // ç†Ÿæ‚‰å•è¯
                const shuffledLearning = [...learningWords].sort(() => Math.random() - 0.5);
                reviewCandidates = reviewCandidates.concat(shuffledLearning.slice(0, Math.min(learningReview, maxLearningReview)));
                
                // å·²æŒæ¡å•è¯ï¼ˆé€‰æ‹©æœ€è¿‘å­¦ä¹ çš„ï¼‰
                const recentMastered = [...masteredWords]
                    .sort((a, b) => new Date(b.last_reviewed || 0) - new Date(a.last_reviewed || 0))
                    .slice(0, masteredReview);
                reviewCandidates = reviewCandidates.concat(recentMastered);
                
            } else {
                // æ™®é€šæ—¥ï¼šä¼˜å…ˆå¤ä¹ æœ€è¿‘å­¦ä¹ çš„å’Œè®°å¿†è–„å¼±çš„
                // ç»„åˆå„ç§çŠ¶æ€çš„å•è¯
                const allForReview = [...learningWords, ...masteredWords, ...newWords];
                
                // æ™ºèƒ½æ’åºï¼šæ ¹æ®å¤ä¹ æ¬¡æ•°ã€æœ€åå¤ä¹ æ—¶é—´ã€çŠ¶æ€
                allForReview.sort((a, b) => {
                    // æœªæŒæ¡çš„ä¼˜å…ˆ
                    if (a.status === 'new' && b.status !== 'new') return -1;
                    if (a.status !== 'new' && b.status === 'new') return 1;
                    
                    // å¤ä¹ æ¬¡æ•°å°‘çš„ä¼˜å…ˆ
                    if ((a.review_count || 0) !== (b.review_count || 0)) {
                        return (a.review_count || 0) - (b.review_count || 0);
                    }
                    
                    // æœ€åå¤ä¹ æ—¶é—´æ—©çš„ä¼˜å…ˆ
                    const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
                    const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
                    return aDate - bDate;
                });
                
                // é™åˆ¶ç†Ÿæ‚‰å•è¯æ•°é‡
                const learningSelected = allForReview.filter(w => w.status === 'learning').slice(0, maxLearningReview);
                const others = allForReview.filter(w => w.status !== 'learning');
                const combined = [...learningSelected, ...others];
                
                reviewCandidates = combined.slice(0, reviewWordCount);
            }
            
            // å»é‡
            const seenIds = new Set();
            result.reviewWords = reviewCandidates.filter(word => {
                const id = word.id || word.word_id;
                if (!seenIds.has(id)) {
                    seenIds.add(id);
                    return true;
                }
                return false;
            }).slice(0, reviewWordCount);
        }
        
        return result;
        
    } catch (error) {
        console.error('æ™ºèƒ½é€‰æ‹©å•è¯é”™è¯¯:', error);
        return { newWords: [], reviewWords: [] };
    }
}

// å¼€å§‹æ¯æ—¥ä»»åŠ¡
function startDailyTask() {
    if (!clockInSystem.dailyTask || !clockInSystem.dailyTask.words) {
        showAlert('è¯·å…ˆç”Ÿæˆä»»åŠ¡', 'error');
        return;
    }
    
    // åˆå¹¶æ‰€æœ‰å•è¯å¼€å§‹è®­ç»ƒ
    const allWords = [
        ...clockInSystem.dailyTask.words.newWords,
        ...clockInSystem.dailyTask.words.reviewWords
    ];
    
    if (allWords.length === 0) {
        showAlert('æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å•è¯è¿›è¡Œè®­ç»ƒ', 'info');
        return;
    }
    
    // æ‰“ä¹±é¡ºåº
    const shuffledWords = [...allWords].sort(() => Math.random() - 0.5);
    
    // è®¾ç½®è®­ç»ƒçŠ¶æ€
    appState.trainingWords = shuffledWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    // å¼€å§‹è®­ç»ƒ
    startTrainingSession();
}

// å®Œæˆè®­ç»ƒåçš„æ‰“å¡è®°å½•
async function recordClockInAfterTraining() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const totalWords = appState.trainingWords.length;
        
        // ç»Ÿè®¡æ–°å•è¯å’Œå¤ä¹ å•è¯æ•°é‡
        let newWordCount = 0;
        let reviewWordCount = 0;
        
        // è¿™é‡Œç®€åŒ–ç»Ÿè®¡ï¼Œå®é™…åº”è¯¥æ ¹æ®å•è¯çŠ¶æ€å˜åŒ–æ¥ç»Ÿè®¡
        if (clockInSystem.dailyTask) {
            newWordCount = clockInSystem.dailyTask.newWords;
            reviewWordCount = clockInSystem.dailyTask.reviewWords;
        } else {
            // å¦‚æœæ²¡æœ‰ä»»åŠ¡ä¿¡æ¯ï¼Œç®€å•ä¼°ç®—
            newWordCount = Math.floor(totalWords * 0.5);
            reviewWordCount = totalWords - newWordCount;
        }
        
        // åˆ›å»ºæˆ–æ›´æ–°æ‰“å¡è®°å½•
        const { data: existingRecord, error: checkError } = await dbClient
            .from('clock_in_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('clock_in_date', today)
            .single();
        
        if (checkError && checkError.code !== 'PGRST116') {
            throw checkError;
        }
        
        if (existingRecord) {
            // æ›´æ–°ç°æœ‰è®°å½•
            const { error: updateError } = await dbClient
                .from('clock_in_records')
                .update({
                    is_clock_in: true,
                    study_mode: clockInSystem.selectedTaskMode,
                    new_word_count: newWordCount,
                    review_word_count: reviewWordCount,
                    total_study_time: 30, // å‡è®¾å­¦ä¹ 30åˆ†é’Ÿ
                    study_summary: 'å®Œæˆæ¯æ—¥ä»»åŠ¡',
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingRecord.id);
            
            if (updateError) throw updateError;
            
        } else {
            // åˆ›å»ºæ–°è®°å½•
            const { error: insertError } = await dbClient
                .from('clock_in_records')
                .insert([{
                    student_id: appState.currentUser,
                    clock_in_date: today,
                    is_clock_in: true,
                    study_mode: clockInSystem.selectedTaskMode,
                    new_word_count: newWordCount,
                    review_word_count: reviewWordCount,
                    total_study_time: 30,
                    study_summary: 'å®Œæˆæ¯æ—¥ä»»åŠ¡'
                }]);
            
            if (insertError) throw insertError;
        }
        
        // æ›´æ–°å­¦ä¹ ç»Ÿè®¡
        await updateStudyStatistics(totalWords, newWordCount);
        
        // æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘æ”¾å¥–åŠ±
        await checkAndAwardReward();
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        clockInSystem.todayClockedIn = true;
        clockInSystem.currentStreak++;
        
        // æ›´æ–°UI
        updateClockInUI();
        
        showAlert('âœ… æ‰“å¡æˆåŠŸï¼å­¦ä¹ è®°å½•å·²ä¿å­˜', 'success');
        
    } catch (error) {
        console.error('è®°å½•æ‰“å¡é”™è¯¯:', error);
        showAlert('æ‰“å¡è®°å½•å¤±è´¥ï¼Œä½†å­¦ä¹ å·²å®Œæˆ', 'warning');
    }
}

// æ›´æ–°å­¦ä¹ ç»Ÿè®¡
async function updateStudyStatistics(totalWords, newWords) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        // è·å–æˆ–åˆ›å»ºä»Šæ—¥ç»Ÿè®¡
        const { data: existingStats, error: checkError } = await dbClient
            .from('study_statistics')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('stat_date', today)
            .single();
        
        if (checkError && checkError.code !== 'PGRST116') {
            throw checkError;
        }
        
        const consecutiveDays = clockInSystem.currentStreak;
        
        if (existingStats) {
            // æ›´æ–°ç°æœ‰ç»Ÿè®¡
            const { error: updateError } = await dbClient
                .from('study_statistics')
                .update({
                    new_words_learned: (existingStats.new_words_learned || 0) + newWords,
                    words_reviewed: (existingStats.words_reviewed || 0) + (totalWords - newWords),
                    total_study_time: (existingStats.total_study_time || 0) + 30,
                    consecutive_days: consecutiveDays,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingStats.id);
            
            if (updateError) throw updateError;
            
        } else {
            // åˆ›å»ºæ–°ç»Ÿè®¡
            const { error: insertError } = await dbClient
                .from('study_statistics')
                .insert([{
                    student_id: appState.currentUser,
                    stat_date: today,
                    new_words_learned: newWords,
                    words_reviewed: totalWords - newWords,
                    total_study_time: 30,
                    consecutive_days: consecutiveDays,
                    has_reward: false,
                    month_absence: 0
                }]);
            
            if (insertError) throw insertError;
        }
        
    } catch (error) {
        console.error('æ›´æ–°å­¦ä¹ ç»Ÿè®¡é”™è¯¯:', error);
    }
}

// æ£€æŸ¥å¹¶å‘æ”¾å¥–åŠ±
async function checkAndAwardReward() {
    if (clockInSystem.currentStreak >= 7 && clockInSystem.currentStreak % 7 === 0) {
        try {
            // æ›´æ–°ç»Ÿè®¡è¡¨ä¸­çš„å¥–åŠ±çŠ¶æ€
            const today = new Date().toISOString().split('T')[0];
            
            const { error: updateError } = await dbClient
                .from('study_statistics')
                .update({
                    has_reward: true
                })
                .eq('student_id', appState.currentUser)
                .eq('stat_date', today);
            
            if (updateError) throw updateError;
            
            // æ˜¾ç¤ºå¥–åŠ±æ¶ˆæ¯
            showAlert(`ğŸ‰ æ­å–œæ‚¨è¿ç»­å­¦ä¹ 7å¤©ï¼è·å¾—è¯­è¨€å­¦ä¹ å¥–åŠ±ï¼`, 'success');
            
        } catch (error) {
            console.error('å‘æ”¾å¥–åŠ±é”™è¯¯:', error);
        }
    }
}

// æ˜¾ç¤ºæ‰“å¡ç»Ÿè®¡
function showClockInStats() {
    showScreen('clockin-stats-screen');
    loadClockInStats();
}

// åŠ è½½æ‰“å¡ç»Ÿè®¡
async function loadClockInStats() {
    try {
        // æ›´æ–°ç»Ÿè®¡æ•°å­—
        document.getElementById('current-streak').textContent = clockInSystem.currentStreak;
        document.getElementById('longest-streak').textContent = clockInSystem.longestStreak;
        document.getElementById('total-days').textContent = clockInSystem.totalDays;
        
        // åŠ è½½æœˆåº¦ç»Ÿè®¡
        await loadMonthStats();
        
        // åŠ è½½æ‰“å¡æ—¥å†
        await loadClockInCalendar();
        
        // åŠ è½½å¥–åŠ±è®°å½•
        await loadRewards();
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡ç»Ÿè®¡é”™è¯¯:', error);
    }
}

// åŠ è½½æœˆåº¦ç»Ÿè®¡
async function loadMonthStats() {
    try {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        const { data: monthStats, error } = await dbClient
            .from('study_statistics')
            .select('*')
            .eq('student_id', appState.currentUser)
            .gte('stat_date', firstDay.toISOString().split('T')[0])
            .lte('stat_date', lastDay.toISOString().split('T')[0])
            .order('stat_date');
        
        if (error) throw error;
        
        const container = document.getElementById('month-stats-content');
        
        if (!monthStats || monthStats.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center;">æœ¬æœˆè¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</p>';
            return;
        }
        
        // è®¡ç®—æœˆåº¦æ€»è®¡
        let totalNewWords = 0;
        let totalReviews = 0;
        let totalStudyTime = 0;
        let absenceDays = 0;
        
        monthStats.forEach(stat => {
            totalNewWords += stat.new_words_learned || 0;
            totalReviews += stat.words_reviewed || 0;
            totalStudyTime += stat.total_study_time || 0;
            
            if (!stat.new_words_learned && !stat.words_reviewed) {
                absenceDays++;
            }
        });
        
        const daysInMonth = lastDay.getDate();
        const studyDays = monthStats.length;
        const avgDailyWords = studyDays > 0 ? Math.round((totalNewWords + totalReviews) / studyDays) : 0;
        
        container.innerHTML = `
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${studyDays}</div>
                    <div class="label">å­¦ä¹ å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${totalNewWords}</div>
                    <div class="label">æ–°å­¦å•è¯</div>
                </div>
                <div class="stat-card">
                    <div class="number">${totalReviews}</div>
                    <div class="label">å¤ä¹ å•è¯</div>
                </div>
                <div class="stat-card">
                    <div class="number">${avgDailyWords}</div>
                    <div class="label">æ—¥å‡å•è¯</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æœ¬æœˆå­¦ä¹ å¤©æ•°</span>
                    <span style="color: #4CAF50; font-weight: bold;">${studyDays}/${daysInMonth}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${(studyDays / daysInMonth) * 100}%"></div>
                </div>
            </div>
            
            <div style="margin-top: 15px; color: #666; font-size: 14px;">
                <p>ğŸ“Š å­¦ä¹ æ€»æ—¶é•¿ï¼š${totalStudyTime} åˆ†é’Ÿ</p>
                <p>ğŸ“… ç¼ºå¡å¤©æ•°ï¼š${absenceDays} å¤©</p>
                <p>ğŸ“ˆ å­¦ä¹ é¢‘ç‡ï¼š${(studyDays / daysInMonth * 100).toFixed(1)}%</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æœˆåº¦ç»Ÿè®¡é”™è¯¯:', error);
    }
}

// åŠ è½½æ‰“å¡æ—¥å†
async function loadClockInCalendar() {
    try {
        const { data: records, error } = await dbClient
            .from('clock_in_records')
            .select('clock_in_date')
            .eq('student_id', appState.currentUser)
            .eq('is_clock_in', true)
            .order('clock_in_date', { ascending: false })
            .limit(90); // æœ€è¿‘90å¤©
        
        if (error) throw error;
        
        const container = document.getElementById('calendar-container');
        if (!container) return;
        
        // åˆ›å»ºæ‰“å¡æ—¥æœŸé›†åˆ
        const clockedDates = new Set();
        if (records) {
            records.forEach(record => {
                clockedDates.add(record.clock_in_date);
            });
        }
        
        // ç”Ÿæˆæœ€è¿‘30å¤©çš„æ—¥å†
        const today = new Date();
        const calendarDays = [];
        
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            calendarDays.push({
                date: dateStr,
                day: date.getDate(),
                isClocked: clockedDates.has(dateStr),
                isToday: i === 0
            });
        }
        
        // æŒ‰å‘¨åˆ†ç»„
        const weeks = [];
        let currentWeek = [];
        
        calendarDays.forEach((day, index) => {
            currentWeek.push(day);
            
            if ((index + 1) % 7 === 0 || index === calendarDays.length - 1) {
                weeks.push([...currentWeek]);
                currentWeek = [];
            }
        });
        
        // ç”Ÿæˆæ—¥å†HTML
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        
        let calendarHTML = `
            <div style="overflow-x: auto;">
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; min-width: 300px;">
                    ${weekdays.map(day => `
                        <div style="text-align: center; padding: 8px; background: #f5f5f5; border-radius: 5px; font-weight: bold; color: #666;">
                            ${day}
                        </div>
                    `).join('')}
        `;
        
        // å¡«å……æ—¥æœŸ
        weeks.forEach(week => {
            week.forEach(day => {
                let className = 'calendar-day';
                let title = day.date;
                
                if (day.isToday) {
                    className += ' today';
                    title += ' (ä»Šå¤©)';
                }
                
                if (day.isClocked) {
                    className += ' clocked';
                    title += ' âœ“ å·²æ‰“å¡';
                }
                
                calendarHTML += `
                    <div style="text-align: center; padding: 10px; border-radius: 5px; background: ${day.isClocked ? '#4CAF50' : '#f5f5f5'}; 
                          color: ${day.isClocked ? 'white' : '#666'}; ${day.isToday ? 'border: 2px solid #2196F3;' : ''}"
                          title="${title}">
                        ${day.day}
                        ${day.isClocked ? '<br><span style="font-size: 10px;">âœ“</span>' : ''}
                    </div>
                `;
            });
        });
        
        calendarHTML += `
                </div>
            </div>
            <p style="color: #666; text-align: center; margin-top: 10px; font-size: 14px;">
                âœ… è¡¨ç¤ºå·²æ‰“å¡çš„æ—¥å­ | è“è‰²è¾¹æ¡†è¡¨ç¤ºä»Šå¤©
            </p>
        `;
        
        container.innerHTML = calendarHTML;
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡æ—¥å†é”™è¯¯:', error);
    }
}

// åŠ è½½å¥–åŠ±è®°å½•
async function loadRewards() {
    try {
        const { data: stats, error } = await dbClient
            .from('study_statistics')
            .select('stat_date, consecutive_days, has_reward')
            .eq('student_id', appState.currentUser)
            .eq('has_reward', true)
            .order('stat_date', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('rewards-list');
        
        if (!stats || stats.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center;">è¿˜æ²¡æœ‰è·å¾—å¥–åŠ±</p>';
            return;
        }
        
        let rewardsHTML = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
        
        stats.forEach(stat => {
            const date = new Date(stat.stat_date).toLocaleDateString('zh-CN');
            const streak = stat.consecutive_days;
            
            // æ ¹æ®è¿ç»­å¤©æ•°å†³å®šå¥–åŠ±ç­‰çº§
            let rewardTitle = '';
            let rewardDesc = '';
            let icon = 'ğŸ†';
            
            if (streak >= 30) {
                rewardTitle = 'ğŸ… æœˆåº¦å­¦ä¹ ä¹‹æ˜Ÿ';
                rewardDesc = 'è¿ç»­å­¦ä¹ 30å¤©';
                icon = 'ğŸŒŸ';
            } else if (streak >= 14) {
                rewardTitle = 'ğŸ¥ˆ åŒå‘¨å­¦ä¹ è¾¾äºº';
                rewardDesc = 'è¿ç»­å­¦ä¹ 14å¤©';
                icon = 'â­';
            } else if (streak >= 7) {
                rewardTitle = 'ğŸ¥‰ å‘¨å­¦ä¹ æ ‡å…µ';
                rewardDesc = 'è¿ç»­å­¦ä¹ 7å¤©';
                icon = 'ğŸ–ï¸';
            }
            
            rewardsHTML += `
                <div style="background: #FFF3CD; border: 2px solid #FFC107; border-radius: 10px; padding: 15px; min-width: 200px;">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 10px;">${icon}</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 5px;">${rewardTitle}</div>
                    <div style="color: #666; text-align: center; font-size: 14px;">${rewardDesc}</div>
                    <div style="color: #999; text-align: center; font-size: 12px; margin-top: 10px;">${date}</div>
                </div>
            `;
        });
        
        rewardsHTML += '</div>';
        container.innerHTML = rewardsHTML;
        
    } catch (error) {
        console.error('åŠ è½½å¥–åŠ±è®°å½•é”™è¯¯:', error);
    }
}

// æ˜¾ç¤ºå¤ä¹ è®¡åˆ’é¡µé¢
function showReviewPlan() {
    showScreen('review-plan-screen');
    loadReviewPlan();
}

// åŠ è½½å¤ä¹ è®¡åˆ’
async function loadReviewPlan() {
    try {
        // è·å–å­¦ç”Ÿçš„æ‰€æœ‰å•è¯
        const { data: allWords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        if (!allWords || allWords.length === 0) {
            // å¦‚æœæ²¡æœ‰å•è¯ï¼Œæ˜¾ç¤ºæç¤º
            document.getElementById('due-reviews').textContent = '0';
            document.getElementById('weak-words').textContent = '0';
            document.getElementById('medium-words').textContent = '0';
            document.getElementById('strong-words').textContent = '0';
            
            document.getElementById('ebbinghaus-schedule').innerHTML = `
                <p style="color: #666; text-align: center;">è¿˜æ²¡æœ‰å•è¯å¯ä»¥å¤ä¹ </p>
            `;
            return;
        }
        
        // æ ¹æ®çŠ¶æ€å’Œå¤ä¹ æ¬¡æ•°åˆ†ç±»å•è¯
        const weakWords = allWords.filter(w => 
            w.status === 'new' || 
            (w.review_count || 0) <= 1
        );
        
        const mediumWords = allWords.filter(w => 
            w.status === 'learning' && 
            (w.review_count || 0) > 1 && 
            (w.review_count || 0) <= 3
        );
        
        const strongWords = allWords.filter(w => 
            w.status === 'mastered' || 
            (w.review_count || 0) > 3
        );
        
        // æ›´æ–°ç»Ÿè®¡æ•°å­—
        document.getElementById('due-reviews').textContent = weakWords.length;
        document.getElementById('weak-words').textContent = weakWords.length;
        document.getElementById('medium-words').textContent = mediumWords.length;
        document.getElementById('strong-words').textContent = strongWords.length;
        
        // ç”Ÿæˆè‰¾å®¾æµ©æ–¯å¤ä¹ æ—¶é—´è¡¨
        generateEbbinghausSchedule();
        
    } catch (error) {
        console.error('åŠ è½½å¤ä¹ è®¡åˆ’é”™è¯¯:', error);
    }
}

// ç”Ÿæˆè‰¾å®¾æµ©æ–¯å¤ä¹ æ—¶é—´è¡¨
function generateEbbinghausSchedule() {
    const today = new Date();
    const schedule = [
        { days: 1, label: 'ç¬¬ä¸€æ¬¡å¤ä¹ ', date: addDays(today, 1) },
        { days: 2, label: 'ç¬¬äºŒæ¬¡å¤ä¹ ', date: addDays(today, 2) },
        { days: 4, label: 'ç¬¬ä¸‰æ¬¡å¤ä¹ ', date: addDays(today, 4) },
        { days: 7, label: 'ç¬¬å››æ¬¡å¤ä¹ ', date: addDays(today, 7) },
        { days: 15, label: 'ç¬¬äº”æ¬¡å¤ä¹ ', date: addDays(today, 15) },
        { days: 30, label: 'ç¬¬å…­æ¬¡å¤ä¹ ', date: addDays(today, 30) }
    ];
    
    const scheduleHTML = `
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            ${schedule.map(item => `
                <div style="background: ${item.days <= 2 ? '#E8F5E9' : '#E3F2FD'}; border: 2px solid ${item.days <= 2 ? '#4CAF50' : '#2196F3'}; 
                      border-radius: 10px; padding: 15px; flex: 1; min-width: 150px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${item.label}</div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">${item.days}å¤©å</div>
                    <div style="color: #999; font-size: 12px;">${item.date.toLocaleDateString('zh-CN')}</div>
                </div>
            `).join('')}
        </div>
        <p style="color: #666; margin-top: 15px; font-size: 14px;">
            ğŸ’¡ æ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿è®¾è®¡çš„å¤ä¹ è®¡åˆ’ï¼Œç§‘å­¦è®°å¿†ï¼Œé«˜æ•ˆå­¦ä¹ 
        </p>
    `;
    
    document.getElementById('ebbinghaus-schedule').innerHTML = scheduleHTML;
}

// æ·»åŠ å¤©æ•°è¾…åŠ©å‡½æ•°
function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

// æ™ºèƒ½å¤ä¹ 
async function startSmartReview(type) {
    try {
        const { data: allWords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) throw error;
        
        if (!allWords || allWords.length === 0) {
            showAlert('æ²¡æœ‰å•è¯å¯ä»¥å¤ä¹ ', 'info');
            return;
        }
        
        let reviewWords = [];
        
        switch (type) {
            case 'due':
                // ä»Šæ—¥åˆ°æœŸå¤ä¹ ï¼šå¤ä¹ æ¬¡æ•°å°‘æˆ–çŠ¶æ€ä¸ºnewçš„å•è¯
                reviewWords = allWords
                    .sort((a, b) => {
                        // çŠ¶æ€ä¼˜å…ˆçº§ï¼šnew > learning > mastered
                        const statusOrder = { 'new': 0, 'learning': 1, 'mastered': 2 };
                        if (statusOrder[a.status] !== statusOrder[b.status]) {
                            return statusOrder[a.status] - statusOrder[b.status];
                        }
                        // å¤ä¹ æ¬¡æ•°å°‘çš„ä¼˜å…ˆ
                        return (a.review_count || 0) - (b.review_count || 0);
                    })
                    .slice(0, 20);
                break;
                
            case 'weak':
                // å¼±é¡¹å¤ä¹ ï¼šçŠ¶æ€ä¸ºnewæˆ–å¤ä¹ æ¬¡æ•°<=1çš„å•è¯
                reviewWords = allWords
                    .filter(w => w.status === 'new' || (w.review_count || 0) <= 1)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 20);
                break;
                
            case 'random':
                // éšæœºå¤ä¹ ï¼šæ‰€æœ‰å•è¯éšæœºé€‰æ‹©
                reviewWords = [...allWords]
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 20);
                break;
                
            case 'urgent':
                // ç´§æ€¥å¤ä¹ ï¼šå¾ˆä¹…æ²¡å¤ä¹ çš„å•è¯
                reviewWords = allWords
                    .sort((a, b) => {
                        const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
                        const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
                        return aDate - bDate; // æ—¶é—´æ—©çš„åœ¨å‰
                    })
                    .slice(0, 20);
                break;
        }
        
        if (reviewWords.length === 0) {
            showAlert('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å•è¯', 'info');
            return;
        }
        
        // å¼€å§‹è®­ç»ƒ
        appState.trainingWords = reviewWords;
        appState.currentWordIndex = 0;
        appState.isCardFlipped = false;
        
        startTrainingSession();
        
    } catch (error) {
        console.error('æ™ºèƒ½å¤ä¹ é”™è¯¯:', error);
        showAlert('åŠ è½½å¤ä¹ å•è¯å¤±è´¥', 'error');
    }
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        // ä½¿ç”¨æ›´å¿«çš„æŸ¥è¯¢æ–¹å¼
        const { error } = await dbClient
            .from('users')
            .select('*', { count: 'exact', head: true })
            .limit(1);
        
        if (error) {
            // å°è¯•å¦ä¸€ç§æ–¹å¼
            const { error: error2 } = await dbClient.auth.getSession();
            if (error2) throw error2;
        }
        
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
        
        // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
        setTimeout(() => {
            showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·åå¼€å§‹å­¦ä¹ ', 'info');
        }, 3000);
        
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// åŠ è½½ä»Šæ—¥è®­ç»ƒçŠ¶æ€
async function loadDailyTrainingState() {
    try {
        const today = new Date().toDateString();
        const storedDate = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
        
        if (storedDate === today) {
            const progress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
            appState.dailyTrainingProgress = progress;
            appState.lastTrainingDate = storedDate;
        } else {
            // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è¿›åº¦
            appState.dailyTrainingProgress = 0;
            appState.lastTrainingDate = today;
            localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
            localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0');
        }
    } catch (error) {
        console.error('åŠ è½½è®­ç»ƒçŠ¶æ€é”™è¯¯:', error);
    }
}

// ä¿å­˜ä»Šæ—¥è®­ç»ƒè¿›åº¦
function saveDailyTrainingProgress(wordsStudied) {
    try {
        const today = new Date().toDateString();
        const currentProgress = appState.dailyTrainingProgress + wordsStudied;
        appState.dailyTrainingProgress = currentProgress;
        
        localStorage.setItem(`kathy_daily_date_${appState.currentUser}`, today);
        localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, currentProgress.toString());
        
        return currentProgress;
    } catch (error) {
        console.error('ä¿å­˜è®­ç»ƒè¿›åº¦é”™è¯¯:', error);
        return appState.dailyTrainingProgress;
    }
}

// åˆå§‹åŒ–æ•™å¸ˆåˆ†ç»„ç³»ç»Ÿ
async function initializeTeacherGroups() {
    try {
        // æ£€æŸ¥æ•™å¸ˆæ˜¯å¦æœ‰åˆ†ç»„
        const { data: existingGroups, error } = await dbClient
            .from('groups')
            .select('*')
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        // å¦‚æœæ²¡æœ‰åˆ†ç»„ï¼Œåˆ›å»ºé»˜è®¤åˆ†ç»„
        if (!existingGroups || existingGroups.length === 0) {
            const { data: newGroup, error: createError } = await dbClient
                .from('groups')
                .insert([{
                    name: 'é»˜è®¤åˆ†ç»„',
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            // æ›´æ–°ç°æœ‰å•è¯çš„åˆ†ç»„ID
            await dbClient
                .from('words')
                .update({ group_id: newGroup.id })
                .eq('teacher_id', appState.teacherId);
            
            console.log('åˆ›å»ºäº†é»˜è®¤åˆ†ç»„å¹¶æ›´æ–°äº†å•è¯');
        }
        
    } catch (error) {
        console.error('åˆå§‹åŒ–åˆ†ç»„é”™è¯¯:', error);
    }
}

// ==================== åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ ====================
async function syncGroupWordsToStudent(studentId) {
    try {
        console.log(`å¼€å§‹ä¸º ${studentId} åŒæ­¥åˆ†ç»„å•è¯...`);
        
        // è·å–å­¦ç”Ÿæ‰€åœ¨çš„åˆ†ç»„
        const { data: studentGroups, error: groupsError } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', studentId);
        
        if (groupsError) {
            console.error('è·å–å­¦ç”Ÿåˆ†ç»„é”™è¯¯:', groupsError);
            return 0;
        }
        
        if (!studentGroups || studentGroups.length === 0) {
            console.log(`å­¦ç”Ÿ ${studentId} æ²¡æœ‰åŠ å…¥ä»»ä½•åˆ†ç»„ï¼Œæ— æ³•åŒæ­¥å•è¯`);
            showAlert('æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„ï¼Œè¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­', 'warning');
            return 0;
        }
        
        const groupIds = studentGroups.map(g => g.group_id);
        console.log(`å­¦ç”Ÿ ${studentId} çš„åˆ†ç»„ID:`, groupIds);
        
        // è·å–åˆ†ç»„ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        const { data: groupInfo, error: groupInfoError } = await dbClient
            .from('groups')
            .select('id, name')
            .in('id', groupIds);
        
        if (groupInfoError) {
            console.error('è·å–åˆ†ç»„ä¿¡æ¯é”™è¯¯:', groupInfoError);
        }
        
        const groupNames = groupInfo?.map(g => g.name) || [];
        console.log(`å­¦ç”Ÿ ${studentId} åœ¨åˆ†ç»„:`, groupNames);
        
        // è·å–åˆ†ç»„å†…çš„å•è¯ï¼ˆä»…é™å­¦ç”Ÿæ‰€åœ¨çš„åˆ†ç»„ï¼‰
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .in('group_id', groupIds)
            .eq('teacher_id', appState.teacherId);
        
        if (wordsError) {
            console.error('è·å–åˆ†ç»„å•è¯é”™è¯¯:', wordsError);
            return 0;
        }
        
        if (!groupWords || groupWords.length === 0) {
            console.log(`å­¦ç”Ÿ ${studentId} çš„åˆ†ç»„ä¸­æ²¡æœ‰å•è¯`);
            showAlert('æ‚¨æ‰€åœ¨çš„åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯ï¼Œè¯·è”ç³»è€å¸ˆä¸Šä¼ å•è¯', 'info');
            return 0;
        }
        
        console.log(`æ‰¾åˆ° ${groupWords.length} ä¸ªåˆ†ç»„å•è¯`);
        
        // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²æœ‰è¿™äº›å•è¯ï¼ˆåŸºäºword_idï¼‰
        const { data: existingRecords, error: checkError } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        if (checkError) {
            console.error('æ£€æŸ¥ç°æœ‰è®°å½•é”™è¯¯:', checkError);
            return 0;
        }
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°å•è¯è®°å½•ï¼ˆåªåŒ…æ‹¬å­¦ç”Ÿæ‰€åœ¨åˆ†ç»„çš„å•è¯ï¼‰
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                review_count: 0,
                group_id: word.group_id,
                added_date: new Date().toISOString()
            }));
        
        console.log(`éœ€è¦åŒæ­¥ ${newRecords.length} ä¸ªæ–°å•è¯`);
        
        if (newRecords.length > 0) {
            // åˆ†æ‰¹æ’å…¥ï¼Œé¿å…è¶…é™
            const batchSize = 50;
            for (let i = 0; i < newRecords.length; i += batchSize) {
                const batch = newRecords.slice(i, i + batchSize);
                const { error: insertError } = await dbClient
                    .from('study_records')
                    .insert(batch);
                
                if (insertError) {
                    console.error(`æ‰¹é‡æ’å…¥é”™è¯¯ (æ‰¹æ¬¡ ${Math.floor(i/batchSize) + 1}):`, insertError);
                    // å¦‚æœæ‰¹é‡æ’å…¥å¤±è´¥ï¼Œå°è¯•é€ä¸ªæ’å…¥
                    for (const record of batch) {
                        try {
                            const { error: singleError } = await dbClient
                                .from('study_records')
                                .insert(record);
                            if (singleError && !singleError.message.includes('duplicate key')) {
                                console.error(`å•ä¸ªæ’å…¥é”™è¯¯:`, singleError);
                            }
                        } catch (err) {
                            console.error('æ’å…¥å¼‚å¸¸:', err);
                        }
                    }
                }
            }
            
            console.log(`æˆåŠŸä¸º ${studentId} åŒæ­¥äº† ${newRecords.length} ä¸ªæ–°å•è¯ï¼Œæ¥è‡ªåˆ†ç»„: ${groupNames.join(', ')}`);
            
            // æ˜¾ç¤ºåŒæ­¥æˆåŠŸçš„æ¶ˆæ¯
            if (newRecords.length > 0) {
                const message = `âœ… å·²ä¸ºæ‚¨åŒæ­¥ ${newRecords.length} ä¸ªæ–°å•è¯\nğŸ“ æ¥è‡ªåˆ†ç»„ï¼š${groupNames.join(', ')}`;
                showAlert(message, 'success');
            }
            
            return newRecords.length;
        } else {
            console.log(`æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–°å•è¯`);
            // æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯
            const message = `ğŸ“š æ‚¨å·²åŒæ­¥æ‰€æœ‰åˆ†ç»„å•è¯\nğŸ“ æ‰€åœ¨åˆ†ç»„ï¼š${groupNames.join(', ')}\nğŸ“– å•è¯æ€»æ•°ï¼š${groupWords.length}`;
            showAlert(message, 'info');
            return 0;
        }
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const usernameInput = document.getElementById('username');
    const username = usernameInput.value.trim();
    
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨ç™»å½•...', 'warning');
    
    try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ•™å¸ˆè´¦å·
        const isTeacher = username.toLowerCase() === 'kathy151';
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .maybeSingle();
        
        if (checkError) {
            showMessage('login-message', `æ£€æŸ¥ç”¨æˆ·å¤±è´¥: ${checkError.message}`, 'error');
            return;
        }
        
        if (!existingUser) {
            // æ–°ç”¨æˆ· - æ³¨å†Œ
            const { data: newUser, error: insertError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacher,
                    last_login: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (insertError) {
                showMessage('login-message', `æ³¨å†Œå¤±è´¥: ${insertError.message}`, 'error');
                return;
            }
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
        } else {
            // ç°æœ‰ç”¨æˆ· - æ›´æ–°æœ€åç™»å½•æ—¶é—´
            await dbClient
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // è®¾ç½®å…¨å±€çŠ¶æ€
        appState.currentUser = username;
        appState.isTeacher = isTeacher;
        appState.userId = username;
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', isTeacher ? 'teacher' : 'student');
        
        // å»¶è¿Ÿååˆ‡æ¢åˆ°ç›¸åº”ç•Œé¢
        setTimeout(() => {
            showMessage('login-message', '', 'info');
            if (isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 1000);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥: ${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}


async function loadTeacherDashboard() {
    try {
        // ä¿®æ”¹å•è¯æ€»æ•°æŸ¥è¯¢ï¼Œä½¿ç”¨countè·å–å‡†ç¡®æ•°é‡
        const { count: wordsCount, error: wordsError } = await dbClient
            .from('words')
            .select('*', { count: 'exact', head: true })
            .eq('teacher_id', appState.teacherId);
        
        const { count: studentsCount, error: studentsError } = await dbClient
            .from('users')
            .select('*', { count: 'exact', head: true })
            .eq('is_teacher', false);
        
        // è·å–å­¦ä¹ è®°å½•æ•°é‡
        const { count: recordsCount, error: recordsError } = await dbClient
            .from('study_records')
            .select('*', { count: 'exact', head: true });
        
        const { count: masteredCount, error: masteredError } = await dbClient
            .from('study_records')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'mastered');
        
        // è·å–æ´»è·ƒå­¦ç”Ÿï¼ˆæœ€è¿‘7å¤©æœ‰å­¦ä¹ è®°å½•ï¼‰
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        const { data: activeData, error: activeError } = await dbClient
            .from('study_records')
            .select('student_id')
            .gte('last_reviewed', sevenDaysAgo.toISOString());
        
        document.getElementById('total-words').textContent = wordsCount || 0;
        document.getElementById('total-students').textContent = studentsCount || 0;
        document.getElementById('mastered-words').textContent = masteredCount || 0;
        
        const activeStudents = new Set(activeData?.map(r => r.student_id) || []).size;
        document.getElementById('active-students').textContent = activeStudents;
        
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">âœ¨ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn" style="padding: 12px 24px;" onclick="showUploadWordsPage()">
                        <span>ğŸ“¤ å¿«é€Ÿä¸Šä¼ </span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 24px;" onclick="quickStats()">
                        <span>ğŸ“ˆ ä»Šæ—¥æ•°æ®</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px;" onclick="showStudentActivity()">
                        <span>ğŸ‘€ å­¦ç”Ÿæ´»è·ƒ</span>
                    </button>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ç³»ç»Ÿæç¤º</h4>
                    <p style="color: #666; margin: 5px 0;">â€¢ å·²ä¸Šä¼  ${wordsData?.[0]?.count || 0} ä¸ªå•è¯</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å…±æœ‰ ${studentsData?.[0]?.count || 0} åå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ æœ€è¿‘7å¤© ${activeStudents} åæ´»è·ƒå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å­¦ç”Ÿå…±æŒæ¡ ${masteredWords} ä¸ªå•è¯</p>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        document.getElementById('teacher-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
    }
}

// ========== æ•™å¸ˆé¡µé¢åŠŸèƒ½ ==========
function showUploadWordsPage() {
    showScreen('teacher-upload-screen');
    loadUploadWordsPage();
}

async function loadUploadWordsPage() {
    const content = document.getElementById('teacher-upload-content');
    content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸ“ ä¸Šä¼ å•è¯</h3>
            
            <!-- é€‰æ‹©åˆ†ç»„ -->
            <div style="background: #E3F2FD; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #1565C0;">
                    ğŸ“ é€‰æ‹©åˆ†ç»„
                </label>
                <div id="group-select-container">
                    <p>æ­£åœ¨åŠ è½½åˆ†ç»„...</p>
                </div>
            </div>
            
            <div style="background: #E8F5E9; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                <h4 style="color: #2E7D32; margin-bottom: 15px;">ğŸ“‹ ä¸Šä¼ è¯´æ˜</h4>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 8px 0; color: #666;">â€¢ æ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæ ¼å¼ï¼š<strong>è‹±æ–‡ ä¸­æ–‡</strong></p>
                    <p style="margin: 8px 0; color: #666;">â€¢ ç¤ºä¾‹ï¼š<code>hello ä½ å¥½</code></p>
                    <p style="margin: 8px 0; color: #666;">â€¢ æ”¯æŒçŸ­è¯­ï¼š<code>"good morning" æ—©ä¸Šå¥½</code></p>
                    <p style="margin: 8px 0; color: #666;">â€¢ æ¯è¡Œä¸è¦è¶…è¿‡200ä¸ªå­—ç¬¦</p>
                    <p style="margin: 8px 0; color: #666;">â€¢ ä¸€æ¬¡æœ€å¤šä¸Šä¼ 500ä¸ªå•è¯</p>
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <textarea id="words-input" 
                          style="width: 100%; height: 300px; font-family: monospace; font-size: 16px; padding: 15px; border: 2px solid #ddd; border-radius: 10px;"
                          placeholder="è¾“å…¥å•è¯åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼š
apple è‹¹æœ
banana é¦™è•‰
"good morning" æ—©ä¸Šå¥½
computer ç”µè„‘"></textarea>
            </div>
            
            <div style="text-align: center; margin-bottom: 25px;">
                <button class="btn btn-blue" onclick="previewUploadWordsStable()" style="margin: 5px;">
                    ğŸ‘ï¸ é¢„è§ˆ
                </button>
                <button class="btn" onclick="submitUploadWordsStable()" style="margin: 5px;">
                    ğŸ“¤ ä¸Šä¼ 
                </button>
                <button class="btn" onclick="loadExampleWordsStable()" style="margin: 5px;">
                    ğŸ“š ç¤ºä¾‹
                </button>
                <button class="btn btn-red" onclick="clearUploadForm()" style="margin: 5px;">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
            </div>
            
            <div id="upload-preview-stable" style="display: none;">
                <!-- é¢„è§ˆå†…å®¹ -->
            </div>
            
            <div id="upload-result-stable">
                <!-- ä¸Šä¼ ç»“æœ -->
            </div>
        </div>
    `;
    
    setTimeout(loadGroupSelectorStable, 100);
}

async function loadGroupSelectorStable() {
    try {
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (error) throw error;
        
        const container = document.getElementById('group-select-container');
        
        if (!groups || groups.length === 0) {
            container.innerHTML = `
                <p style="color: #666;">è¿˜æ²¡æœ‰åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºåˆ†ç»„</p>
                <button class="btn" onclick="showGroupManagementPage()" style="margin-top: 10px;">
                    å»åˆ›å»ºåˆ†ç»„
                </button>
            `;
            return;
        }
        
        const selectedGroupId = appState.selectedGroupId || groups[0].id;
        
        let html = `<select id="selected-group" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">`;
        
        groups.forEach(group => {
            html += `<option value="${group.id}" ${group.id === selectedGroupId ? 'selected' : ''}>
                        ${group.name}
                     </option>`;
        });
        
        html += `</select>`;
        html += `<div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button class="btn" onclick="showGroupManagementPage()" style="padding: 8px 16px;">
                        ç®¡ç†åˆ†ç»„
                    </button>
                    <button class="btn" onclick="createNewGroupFromUpload()" style="padding: 8px 16px;">
                        æ–°å»ºåˆ†ç»„
                    </button>
                 </div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„é€‰æ‹©å™¨é”™è¯¯:', error);
        document.getElementById('group-select-container').innerHTML = 
            '<p style="color: red;">åŠ è½½åˆ†ç»„å¤±è´¥</p>';
    }
}

function createNewGroupFromUpload() {
    const groupName = prompt('è¯·è¾“å…¥æ–°åˆ†ç»„åç§°ï¼š');
    if (!groupName) return;
    
    createNewGroupDirectly(groupName);
}

async function createNewGroupDirectly(groupName) {
    try {
        const { data: newGroup, error } = await dbClient
            .from('groups')
            .insert([{
                name: groupName,
                teacher_id: appState.teacherId
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        loadGroupSelectorStable();
        appState.selectedGroupId = newGroup.id;
        
        showAlert(`åˆ†ç»„ "${groupName}" åˆ›å»ºæˆåŠŸ`, 'success');
        
    } catch (error) {
        console.error('åˆ›å»ºåˆ†ç»„é”™è¯¯:', error);
        showAlert('åˆ›å»ºåˆ†ç»„å¤±è´¥', 'error');
    }
}

function previewUploadWordsStable() {
    const input = document.getElementById('words-input').value.trim();
    if (!input) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const lines = input.split('\n');
    const previewContainer = document.getElementById('upload-preview-stable');
    previewContainer.innerHTML = '';
    
    let validCount = 0;
    let duplicateCount = 0;
    const seenWords = new Set();
    let previewHTML = '';
    
    lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        if (trimmed.startsWith('#')) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            const englishLower = english.toLowerCase();
            
            const isDuplicate = seenWords.has(englishLower);
            if (isDuplicate) {
                duplicateCount++;
            } else {
                seenWords.add(englishLower);
            }
            
            previewHTML += `
                <tr>
                    <td style="padding: 8px;">
                        <strong>${english}</strong>
                        ${isDuplicate ? '<span style="color: #F44336; margin-left: 10px;">(é‡å¤)</span>' : ''}
                    </td>
                    <td style="padding: 8px;">${chinese}</td>
                    <td style="padding: 8px; color: ${isDuplicate ? '#F44336' : '#4CAF50'}">
                        ${isDuplicate ? 'âŒ é‡å¤' : 'âœ… æœ‰æ•ˆ'}
                    </td>
                </tr>
            `;
            validCount++;
        }
    });
    
    if (validCount > 0) {
        previewContainer.innerHTML = `
            <h4>ğŸ‘ï¸ é¢„è§ˆï¼ˆ${validCount} ä¸ªå•è¯ï¼Œ${duplicateCount} ä¸ªé‡å¤ï¼‰</h4>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                <table style="width: 100%;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px;">è‹±æ–‡</th>
                            <th style="padding: 10px;">ä¸­æ–‡</th>
                            <th style="padding: 10px;">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>${previewHTML}</tbody>
                </table>
            </div>
        `;
        previewContainer.style.display = 'block';
        
        let message = `æ‰¾åˆ° ${validCount} ä¸ªæœ‰æ•ˆå•è¯`;
        if (duplicateCount > 0) {
            message += `ï¼Œå…¶ä¸­ ${duplicateCount} ä¸ªé‡å¤ï¼ˆä¸Šä¼ æ—¶ä¼šè‡ªåŠ¨è·³è¿‡ï¼‰`;
        }
        showAlert(message, duplicateCount > 0 ? 'warning' : 'success');
    } else {
        showAlert('æœªæ‰¾åˆ°æœ‰æ•ˆå•è¯ï¼Œè¯·æ£€æŸ¥æ ¼å¼', 'error');
    }
}

async function submitUploadWordsStable() {
    const input = document.getElementById('words-input').value.trim();
    if (!input) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const groupSelect = document.getElementById('selected-group');
    const selectedGroupId = groupSelect ? groupSelect.value : null;
    
    if (!selectedGroupId) {
        showAlert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç»„', 'error');
        return;
    }
    
    const lines = input.split('\n');
    const rawWords = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (trimmed.startsWith('#')) return;
        
        const parts = trimmed.split(/\s+/);
        if (parts.length >= 2) {
            const english = parts.slice(0, -1).join(' ');
            const chinese = parts[parts.length - 1];
            rawWords.push({
                english: english,
                chinese: chinese
            });
        }
    });
    
    if (rawWords.length === 0) {
        showAlert('æ²¡æœ‰æœ‰æ•ˆå•è¯å¯ä¸Šä¼ ', 'error');
        return;
    }
    
    try {
        const { data: group, error: groupError } = await dbClient
            .from('groups')
            .select('name')
            .eq('id', selectedGroupId)
            .single();
        
        if (groupError) throw groupError;
        
        // è·å–è¯¥åˆ†ç»„ä¸­å·²å­˜åœ¨çš„å•è¯
        const { data: existingWords, error: fetchError } = await dbClient
            .from('words')
            .select('english')
            .eq('teacher_id', appState.teacherId)
            .eq('group_id', selectedGroupId); 

        
        if (fetchError) throw fetchError;
        
        const existingWordSet = new Set();
        if (existingWords) {
            existingWords.forEach(word => {
                existingWordSet.add(word.english.toLowerCase());
            });
        }
        
        // ç­›é€‰å‡ºæ–°çš„ã€ä¸é‡å¤çš„å•è¯
        const uniqueNewWords = [];
        const duplicateWords = [];
        const seenInThisBatch = new Set();
        
        rawWords.forEach(word => {
            const englishLower = word.english.toLowerCase();
            
            if (seenInThisBatch.has(englishLower)) {
                duplicateWords.push(word.english);
                return;
            }
            
            if (existingWordSet.has(englishLower)) {
                duplicateWords.push(word.english);
                return;
            }
            
            uniqueNewWords.push({
                teacher_id: appState.teacherId,
                english: word.english,
                chinese: word.chinese,
                group_id: selectedGroupId
            });
            
            seenInThisBatch.add(englishLower);
        });
        
        console.log(`æ€»å•è¯æ•°: ${rawWords.length}`);
        console.log(`æ–°å•è¯æ•°: ${uniqueNewWords.length}`);
        console.log(`é‡å¤å•è¯æ•°: ${duplicateWords.length}`);
        
        if (uniqueNewWords.length === 0) {
            if (duplicateWords.length > 0) {
                const message = `æ‰€æœ‰ ${duplicateWords.length} ä¸ªå•è¯éƒ½å·²ç»å­˜åœ¨äºåˆ†ç»„ "${group.name}" ä¸­\n\né‡å¤çš„å•è¯ï¼š\n${duplicateWords.slice(0, 20).join(', ')}${duplicateWords.length > 20 ? `\n...ç­‰ ${duplicateWords.length} ä¸ªå•è¯` : ''}`;
                showAlert(message, 'warning');
            }
            return;
        }
        
        // åˆ†æ‰¹ä¸Šä¼ 
        const BATCH_SIZE = 100;
        let totalUploaded = 0;
        let uploadResult = '';
        
        for (let i = 0; i < uniqueNewWords.length; i += BATCH_SIZE) {
            const batch = uniqueNewWords.slice(i, i + BATCH_SIZE);
            const progress = Math.round(((i + batch.length) / uniqueNewWords.length) * 100);
            uploadResult = `æ­£åœ¨ä¸Šä¼ ... ${progress}% (${Math.min(i + batch.length, uniqueNewWords.length)}/${uniqueNewWords.length})`;
            
            document.getElementById('upload-result-stable').innerHTML = `
                <div class="message-box message-info">
                    <h4>ğŸ“¤ æ­£åœ¨ä¸Šä¼ å•è¯</h4>
                    <p>${uploadResult}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
            
            const { data: insertedWords, error: wordsError } = await dbClient
                .from('words')
                .insert(batch)
                .select('id, english, chinese');
            
            if (wordsError) {
                if (wordsError.code === '23505') {
                    console.warn('æ‰¹é‡æ’å…¥æœ‰é‡å¤ï¼Œæ”¹ä¸ºé€ä¸ªæ’å…¥...');
                    for (const word of batch) {
                        try {
                            const { error: singleError } = await dbClient
                                .from('words')
                                .insert(word);
                            if (!singleError || singleError.code === '23505') {
                                totalUploaded++;
                            }
                        } catch (err) {
                            console.error('å•ä¸ªæ’å…¥é”™è¯¯:', err);
                        }
                    }
                } else {
                    throw wordsError;
                }
            } else {
                totalUploaded += insertedWords?.length || 0;
            }
        }
        
        // è·å–åˆ†ç»„å­¦ç”Ÿå¹¶åˆ›å»ºå­¦ä¹ è®°å½•
        const { data: groupStudents, error: studentsError } = await dbClient
            .from('group_students')
            .select('student_id')
            .eq('group_id', selectedGroupId);
        
        let createdRecords = 0;
        if (groupStudents && groupStudents.length > 0 && totalUploaded > 0) {
            const { data: allNewWords, error: fetchNewError } = await dbClient
                .from('words')
                .select('id, english, chinese')
                .eq('teacher_id', appState.teacherId)
                .eq('group_id', selectedGroupId)
                .order('created_at', { ascending: false })
                .limit(totalUploaded);
            
            if (!fetchNewError && allNewWords) {
                console.log(`ä¸º ${groupStudents.length} åå­¦ç”Ÿåˆ›å»ºå­¦ä¹ è®°å½•...`);
                
                for (const student of groupStudents) {
                    const studyRecords = allNewWords.map(word => ({
                        student_id: student.student_id,
                        word_id: word.id,
                        english: word.english,
                        chinese: word.chinese,
                        status: 'new',
                        review_count: 0,
                        group_id: selectedGroupId,
                        added_date: new Date().toISOString()
                    }));
                    
                    const { data: existingRecords } = await dbClient
                        .from('study_records')
                        .select('word_id')
                        .eq('student_id', student.student_id);
                    
                    const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
                    const newRecords = studyRecords.filter(record => !existingWordIds.has(record.word_id));
                    
                    if (newRecords.length > 0) {
                        const STUDY_BATCH_SIZE = 50;
                        for (let j = 0; j < newRecords.length; j += STUDY_BATCH_SIZE) {
                            const studyBatch = newRecords.slice(j, j + STUDY_BATCH_SIZE);
                            const { error: insertError } = await dbClient
                                .from('study_records')
                                .insert(studyBatch);
                            
                            if (!insertError) {
                                createdRecords += studyBatch.length;
                            }
                        }
                    }
                }
            }
        }
        
        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        let resultHtml = `
            <div class="message-box message-success">
                <h4>âœ… ä¸Šä¼ æˆåŠŸï¼</h4>
                <p>æˆåŠŸä¸Šä¼  <strong>${totalUploaded}</strong> ä¸ªæ–°å•è¯åˆ°åˆ†ç»„ <strong>"${group.name}"</strong></p>
        `;
        
        if (duplicateWords.length > 0) {
            resultHtml += `
                <p>è‡ªåŠ¨è·³è¿‡äº† <strong>${duplicateWords.length}</strong> ä¸ªé‡å¤å•è¯</p>
                <details style="margin-top: 10px;">
                    <summary>æŸ¥çœ‹é‡å¤å•è¯åˆ—è¡¨ï¼ˆå‰20ä¸ªï¼‰</summary>
                    <div style="max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        ${duplicateWords.slice(0, 20).map(word => `<div>${word}</div>`).join('')}
                        ${duplicateWords.length > 20 ? `<div>...ç­‰ ${duplicateWords.length} ä¸ªé‡å¤å•è¯</div>` : ''}
                    </div>
                </details>
            `;
        }
        
        if (createdRecords > 0) {
            resultHtml += `<p>å·²ä¸º ${groupStudents?.length || 0} ååˆ†ç»„å­¦ç”Ÿåˆ›å»ºäº† ${createdRecords} æ¡å­¦ä¹ è®°å½•</p>`;
        }
        
        resultHtml += `
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    <strong>æç¤ºï¼š</strong>å­¦ç”Ÿä¸‹æ¬¡ç™»å½•æ—¶ä¼šè‡ªåŠ¨çœ‹åˆ°è¿™äº›å•è¯ï¼Œæˆ–ç‚¹å‡»"ğŸ”„ ç«‹å³åŒæ­¥"æŒ‰é’®
                </p>
            </div>
        `;
        
        document.getElementById('upload-result-stable').innerHTML = resultHtml;
        
        document.getElementById('words-input').value = '';
        document.getElementById('upload-preview-stable').style.display = 'none';
        
        setTimeout(() => {
            showTeacherDashboard();
        }, 2000);
        
    } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        document.getElementById('upload-result-stable').innerHTML = `
            <div class="message-box message-error">
                <h4>âŒ ä¸Šä¼ å¤±è´¥</h4>
                <p>é”™è¯¯ï¼š${error.message}</p>
                ${error.code === '23505' ? '<p>åŸå› ï¼šæœ‰é‡å¤çš„è‹±æ–‡å•è¯</p>' : ''}
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    å»ºè®®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å•è¯ï¼Œæˆ–åˆ†æ‰¹ä¸Šä¼ 
                </p>
            </div>
        `;
    }
}

function loadExampleWordsStable() {
    document.getElementById('words-input').value = `# åŸºç¡€å•è¯
hello ä½ å¥½
world ä¸–ç•Œ
apple è‹¹æœ
book ä¹¦
computer ç”µè„‘

# æ—¥å¸¸çŸ­è¯­
"good morning" æ—©ä¸Šå¥½
"thank you" è°¢è°¢ä½ 
"how are you" ä½ å¥½å—
"good bye" å†è§

# å­¦ä¹ ç›¸å…³
teacher è€å¸ˆ
student å­¦ç”Ÿ
classroom æ•™å®¤
homework ä½œä¸š
exam è€ƒè¯•`;
    previewUploadWordsStable();
}

function clearUploadForm() {
    document.getElementById('words-input').value = '';
    document.getElementById('upload-preview-stable').style.display = 'none';
    document.getElementById('upload-result-stable').innerHTML = '';
}

function showGroupManagementPage() {
    showScreen('teacher-groups-screen');
    loadGroupManagementPage();
}

// ä¿®å¤åˆ†ç»„ç®¡ç†é¡µé¢åŠ è½½
async function loadGroupManagementPage() {
    try {
        showLoading('æ­£åœ¨åŠ è½½åˆ†ç»„ç®¡ç†...');
        
        const content = document.getElementById('teacher-groups-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 30px;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h3>
                
                <div class="two-column">
                    <!-- å·¦ä¾§ï¼šåˆ†ç»„åˆ—è¡¨ -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="color: #333; margin: 0;">ğŸ“ æˆ‘çš„åˆ†ç»„</h4>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="refreshGroupList()" style="padding: 8px 16px;">
                                    ğŸ”„ åˆ·æ–°åˆ—è¡¨
                                </button>
                                <button class="btn btn-blue" onclick="refreshAllGroupData()" style="padding: 8px 16px;">
                                    ğŸ”„ åˆ·æ–°æ‰€æœ‰æ•°æ®
                                </button>
                            </div>
                        </div>
                        <div id="group-list">
                            <div style="text-align: center; padding: 40px;">
                                <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div>
                                <p style="color: #666; margin-top: 15px;">æ­£åœ¨åŠ è½½åˆ†ç»„åˆ—è¡¨...</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                            <h4 style="color: #333; margin-bottom: 15px;">â• åˆ›å»ºæ–°åˆ†ç»„</h4>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="new-group-name" placeholder="è¾“å…¥åˆ†ç»„åç§°" 
                                       style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                                       onkeypress="if(event.key === 'Enter') createNewGroupFixed()">
                                <button class="btn" onclick="createNewGroupFixed()" id="create-group-btn">
                                    <span>åˆ›å»ºåˆ†ç»„</span>
                                </button>
                            </div>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                ğŸ’¡ åˆ›å»ºåˆ†ç»„åï¼Œå¯ä»¥å°†å­¦ç”Ÿæ·»åŠ åˆ°åˆ†ç»„ä¸­ç®¡ç†
                            </p>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šåˆ†ç»„è¯¦æƒ… -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px;">
                        <h4 style="color: #333; margin-bottom: 20px;">ğŸ“‹ åˆ†ç»„è¯¦æƒ…</h4>
                        <div id="group-detail">
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                                <p style="color: #666;">é€‰æ‹©ä¸€ä¸ªåˆ†ç»„æŸ¥çœ‹è¯¦æƒ…</p>
                                <p style="color: #999; font-size: 14px; margin-top: 10px;">ç‚¹å‡»å·¦ä¾§çš„åˆ†ç»„å³å¯æŸ¥çœ‹è¯¦æƒ…</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // åŠ è½½åˆ†ç»„åˆ—è¡¨
        await loadGroupListFixed();
        
        hideLoading();
        
    } catch (error) {
        hideLoading();
        console.error('åŠ è½½åˆ†ç»„ç®¡ç†é¡µé¢é”™è¯¯:', error);
        showAlert('åŠ è½½åˆ†ç»„ç®¡ç†é¡µé¢å¤±è´¥', 'error');
    }
}

// åˆ·æ–°åˆ†ç»„åˆ—è¡¨
function refreshGroupList() {
    loadGroupListFixed();
}

// ä¿®å¤çš„åˆ†ç»„åˆ—è¡¨åŠ è½½å‡½æ•°
async function loadGroupListFixed() {
    try {
        console.log('å¼€å§‹åŠ è½½åˆ†ç»„åˆ—è¡¨...');
        
        const groupListDiv = document.getElementById('group-list');
        groupListDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                <p style="color: #666; margin-top: 10px;">æ­£åœ¨åŠ è½½...</p>
            </div>
        `;
        
        // 1. é¦–å…ˆè·å–æ‰€æœ‰åˆ†ç»„
        const { data: groups, error: groupsError } = await dbClient
            .from('groups')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .order('created_at', { ascending: false });
        
        if (groupsError) {
            console.error('æŸ¥è¯¢åˆ†ç»„é”™è¯¯:', groupsError);
            throw groupsError;
        }
        
        console.log('æŸ¥è¯¢åˆ°çš„åˆ†ç»„æ•°æ®:', groups);
        
        // å¦‚æœæ²¡æœ‰åˆ†ç»„ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (!groups || groups.length === 0) {
            groupListDiv.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 4em; margin-bottom: 20px; color: #ddd;">ğŸ“</div>
                    <h4 style="color: #666; margin-bottom: 10px;">è¿˜æ²¡æœ‰åˆ†ç»„</h4>
                    <p style="color: #999; margin-bottom: 20px;">åˆ›å»ºä¸€ä¸ªåˆ†ç»„æ¥å¼€å§‹ç®¡ç†å­¦ç”Ÿ</p>
                </div>
            `;
            return;
        }
        
        // 2. ä½¿ç”¨ Promise.all å¹¶è¡Œè·å–æ‰€æœ‰åˆ†ç»„çš„ç»Ÿè®¡æ•°æ®
        const groupsWithStats = await Promise.all(groups.map(async (group) => {
            try {
                // è·å–åˆ†ç»„å•è¯æ•° - ä½¿ç”¨æ­£ç¡®çš„è®¡æ•°æ–¹æ³•
                const { count: wordCount, error: wordsError } = await dbClient
                    .from('words')
                    .select('*', { count: 'exact', head: true })
                    .eq('group_id', group.id)
                    .eq('teacher_id', appState.teacherId);
                
                // è·å–åˆ†ç»„å­¦ç”Ÿæ•° - ä½¿ç”¨æ­£ç¡®çš„è®¡æ•°æ–¹æ³•
                const { count: studentCount, error: studentsError } = await dbClient
                    .from('group_students')
                    .select('*', { count: 'exact', head: true })
                    .eq('group_id', group.id);
                
                return {
                    ...group,
                    wordCount: wordCount || 0,
                    studentCount: studentCount || 0
                };
            } catch (error) {
                console.error(`è·å–åˆ†ç»„ ${group.id} ç»Ÿè®¡æ•°æ®é”™è¯¯:`, error);
                return {
                    ...group,
                    wordCount: 0,
                    studentCount: 0
                };
            }
        }));
        
        // 3. æ˜¾ç¤ºåˆ†ç»„åˆ—è¡¨
        displayGroupListFixed(groupsWithStats);
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨é”™è¯¯:', error);
        const groupListDiv = document.getElementById('group-list');
        
        let errorMessage = error.message;
        if (error.message.includes('does not exist')) {
            errorMessage = 'åˆ†ç»„è¡¨ä¸å­˜åœ¨ï¼Œè¯·åˆå§‹åŒ–æ•°æ®åº“';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
        }
        
        groupListDiv.innerHTML = `
            <div class="message-box message-error">
                <h4 style="margin-bottom: 10px;">âŒ åŠ è½½å¤±è´¥</h4>
                <p style="margin-bottom: 15px;">${errorMessage}</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="loadGroupListFixed()" style="padding: 8px 16px;">
                        é‡è¯•åŠ è½½
                    </button>
                    <button class="btn btn-blue" onclick="createDefaultGroupFixed()" style="padding: 8px 16px;">
                        åˆ›å»ºé»˜è®¤åˆ†ç»„
                    </button>
                </div>
            </div>
        `;
    }
}

// ä¿®å¤åˆ†ç»„åˆ—è¡¨æ˜¾ç¤ºå‡½æ•°
function displayGroupListFixed(groups) {
    const groupListDiv = document.getElementById('group-list');
    
    let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
    
    groups.forEach(group => {
        const createdDate = new Date(group.created_at).toLocaleDateString('zh-CN');
        const teacherId = group.teacher_id || 'æœªæŒ‡å®šæ•™å¸ˆ';
        
        html += `
            <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s;"
                 onclick="showGroupDetailFixed('${group.id}')"
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <h5 style="margin: 0; color: #333; font-size: 1.2em; margin-bottom: 5px;">${group.name}</h5>
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">æ•™å¸ˆ: ${teacherId}</div>
                    </div>
                    <button class="btn btn-red" style="padding: 6px 12px; font-size: 14px;" 
                            onclick="event.stopPropagation(); deleteGroupFixed('${group.id}', '${group.name}')">
                        åˆ é™¤
                    </button>
                </div>
                <div style="display: flex; gap: 20px; color: #666; font-size: 0.9em; margin-bottom: 5px;">
                    <div>ğŸ“š å•è¯: <strong>${group.wordCount}</strong></div>
                    <div>ğŸ‘¥ å­¦ç”Ÿ: <strong>${group.studentCount}</strong></div>
                </div>
                <div style="color: #999; font-size: 0.8em; margin-top: 10px;">
                    åˆ›å»ºäº: ${createdDate}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    groupListDiv.innerHTML = html;
}

// åˆ›å»ºé»˜è®¤åˆ†ç»„
async function createDefaultGroupFixed() {
    try {
        showAlert('æ­£åœ¨åˆ›å»ºé»˜è®¤åˆ†ç»„...', 'info');
        
        const { data: existingGroup, error: checkError } = await dbClient
            .from('groups')
            .select('id')
            .eq('name', 'é»˜è®¤åˆ†ç»„')
            .maybeSingle();
        
        if (existingGroup) {
            showAlert('é»˜è®¤åˆ†ç»„å·²å­˜åœ¨', 'info');
            loadGroupListFixed();
            return;
        }
        
        const { data: newGroup, error } = await dbClient
            .from('groups')
            .insert([{
                name: 'é»˜è®¤åˆ†ç»„',
                teacher_id: appState.teacherId || 'kathy151'
            }])
            .select()
            .single();
        
        if (error) {
            // å°è¯•ä¸åŠ  teacher_id
            const { data: newGroup2, error: error2 } = await dbClient
                .from('groups')
                .insert([{
                    name: 'é»˜è®¤åˆ†ç»„'
                }])
                .select()
                .single();
            
            if (error2) throw error2;
            
            showAlert('é»˜è®¤åˆ†ç»„åˆ›å»ºæˆåŠŸï¼', 'success');
            loadGroupListFixed();
        } else {
            showAlert('é»˜è®¤åˆ†ç»„åˆ›å»ºæˆåŠŸï¼', 'success');
            loadGroupListFixed();
        }
        
    } catch (error) {
        console.error('åˆ›å»ºé»˜è®¤åˆ†ç»„é”™è¯¯:', error);
        showAlert(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
    }
}

// åˆ›å»ºæ–°åˆ†ç»„
async function createNewGroupFixed() {
    const groupNameInput = document.getElementById('new-group-name');
    const groupName = groupNameInput.value.trim();
    const createBtn = document.getElementById('create-group-btn');
    
    if (!groupName) {
        showAlert('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error');
        return;
    }
    
    try {
        createBtn.disabled = true;
        createBtn.innerHTML = '<span>åˆ›å»ºä¸­...</span>';
        
        // æ£€æŸ¥æ˜¯å¦é‡å
        const { data: existingGroup, error: checkError } = await dbClient
            .from('groups')
            .select('id')
            .eq('name', groupName)
            .maybeSingle();
        
        if (existingGroup) {
            showAlert('åˆ†ç»„åç§°å·²å­˜åœ¨', 'error');
            return;
        }
        
        // åˆ›å»ºåˆ†ç»„
        const { data: newGroup, error } = await dbClient
            .from('groups')
            .insert([{
                name: groupName,
                teacher_id: appState.teacherId || 'kathy151'
            }])
            .select()
            .single();
        
        if (error) {
            // å°è¯•å…¶ä»–æ–¹å¼
            const { data: newGroup2, error: error2 } = await dbClient
                .from('groups')
                .insert([{
                    name: groupName
                }])
                .select()
                .single();
            
            if (error2) throw error2;
            
            showAlert(`åˆ†ç»„ "${groupName}" åˆ›å»ºæˆåŠŸï¼`, 'success');
            groupNameInput.value = '';
            loadGroupListFixed();
        } else {
            showAlert(`åˆ†ç»„ "${groupName}" åˆ›å»ºæˆåŠŸï¼`, 'success');
            groupNameInput.value = '';
            loadGroupListFixed();
        }
        
    } catch (error) {
        console.error('åˆ›å»ºåˆ†ç»„é”™è¯¯:', error);
        showAlert(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
    } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = '<span>åˆ›å»ºåˆ†ç»„</span>';
    }
}

// æ˜¾ç¤ºåˆ†ç»„è¯¦æƒ…
async function showGroupDetailFixed(groupId) {
    try {
        const detailDiv = document.getElementById('group-detail');
        detailDiv.innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div>
                <p style="color: #666; margin-top: 15px;">æ­£åœ¨åŠ è½½åˆ†ç»„è¯¦æƒ…...</p>
            </div>
        `;
        
        // ä½¿ç”¨ Promise.all å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
        const [
            groupResult,
            wordsResult,
            studentsResult,
            groupStudentsResult
        ] = await Promise.all([
            // è·å–åˆ†ç»„ä¿¡æ¯
            dbClient.from('groups').select('*').eq('id', groupId).single(),
            
            // è·å–åˆ†ç»„å•è¯ï¼ˆå‰10ä¸ªï¼‰å’Œæ€»æ•°
            Promise.all([
                dbClient.from('words')
                    .select('english, chinese')
                    .eq('group_id', groupId)
                    .order('created_at', { ascending: false })
                    .limit(10),
                dbClient.from('words')
                    .select('*', { count: 'exact', head: true })
                    .eq('group_id', groupId)
                    .eq('teacher_id', appState.teacherId)
            ]),
            
            // è·å–æ‰€æœ‰å­¦ç”Ÿ
            dbClient.from('users')
                .select('username, created_at')
                .eq('is_teacher', false)
                .order('username'),
            
            // è·å–åˆ†ç»„å­¦ç”Ÿ
            dbClient.from('group_students')
                .select('student_id')
                .eq('group_id', groupId)
        ]);
        
        // å¤„ç†åˆ†ç»„ä¿¡æ¯
        if (groupResult.error || !groupResult.data) {
            throw new Error('åˆ†ç»„ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
        }
        const group = groupResult.data;
        
        // å¤„ç†å•è¯æ•°æ®
        const groupWords = wordsResult[0].data || [];
        const totalWords = wordsResult[1].count || 0;
        
        // å¤„ç†å­¦ç”Ÿæ•°æ®
        const allStudents = studentsResult.data || [];
        
        // å¤„ç†åˆ†ç»„å­¦ç”Ÿ
        const groupStudentIds = new Set((groupStudentsResult.data || []).map(gs => gs.student_id));
        
        // æ¸²æŸ“åˆ†ç»„è¯¦æƒ…
        detailDiv.innerHTML = `
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #333; margin: 0;">ğŸ“ ${group.name}</h4>
                    <div style="color: #666; font-size: 14px;">ID: ${group.id}</div>
                </div>
                <div style="color: #666; margin-bottom: 10px;">åˆ›å»ºæ—¶é—´: ${new Date(group.created_at).toLocaleString('zh-CN')}</div>
                <div style="color: #666;">æ•™å¸ˆID: ${group.teacher_id || 'æœªæŒ‡å®š'}</div>
            </div>
            
            <div class="stats-card" style="margin-bottom: 30px;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${totalWords}</div>
                        <div class="label">åˆ†ç»„å•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${groupStudentIds.size}</div>
                        <div class="label">åˆ†ç»„å­¦ç”Ÿ</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h5 style="margin: 0; color: #333;">ğŸ‘¥ å­¦ç”Ÿç®¡ç†</h5>
                    <div>
                        <button class="btn" onclick="addAllStudentsToGroupFixed('${groupId}')" style="margin-right: 10px; padding: 8px 16px;">
                            æ·»åŠ æ‰€æœ‰å­¦ç”Ÿ
                        </button>
                        <button class="btn btn-blue" onclick="refreshGroupDetail('${groupId}')" style="padding: 8px 16px;">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; border: 2px solid #f0f0f0;">
                    ${allStudents.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; position: sticky; top: 0;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">å­¦ç”Ÿç”¨æˆ·å</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">æ³¨å†Œæ—¶é—´</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">çŠ¶æ€</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allStudents.map(student => {
                                    const isInGroup = groupStudentIds.has(student.username);
                                    const regDate = new Date(student.created_at).toLocaleDateString('zh-CN');
                                    return `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 12px;">
                                                <div style="font-weight: bold;">${student.username}</div>
                                            </td>
                                            <td style="padding: 12px; color: #666;">${regDate}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; 
                                                      background: ${isInGroup ? '#e8f5e9' : '#fff3cd'}; 
                                                      color: ${isInGroup ? '#2e7d32' : '#856404'}; 
                                                      border: 1px solid ${isInGroup ? '#c8e6c9' : '#ffeaa7'}">
                                                    ${isInGroup ? 'âœ“ å·²åŠ å…¥' : 'å¾…åŠ å…¥'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                ${isInGroup ? 
                                                    `<button class="btn" style="padding: 6px 12px; font-size: 13px; background: #f8d7da; color: #721c24;" 
                                                             onclick="removeStudentFromGroupFixed('${groupId}', '${student.username}')">
                                                        âœ— ç§»é™¤
                                                    </button>` :
                                                    `<button class="btn" style="padding: 6px 12px; font-size: 13px; background: #d4edda; color: #155724;" 
                                                             onclick="addStudentToGroupFixed('${groupId}', '${student.username}')">
                                                        ï¼‹ æ·»åŠ 
                                                    </button>`}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div style="color: #666; font-size: 14px; margin-top: 10px; text-align: right;">
                            æ€»è®¡: ${allStudents.length} åå­¦ç”Ÿ | å·²åŠ å…¥: ${groupStudentIds.size} å
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 3em; margin-bottom: 10px; color: #ddd;">ğŸ‘¥</div>
                            <p style="color: #666;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</p>
                            <p style="color: #999; font-size: 14px; margin-top: 5px;">å­¦ç”Ÿæ³¨å†Œåæ‰ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                    `}
                </div>
            </div>
            
            ${groupWords.length > 0 ? `
                <div style="margin-bottom: 30px;">
                    <h5 style="margin: 0; color: #333; margin-bottom: 15px;">ğŸ“ åˆ†ç»„å•è¯é¢„è§ˆ</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        ${groupWords.map(word => `
                            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border: 2px solid #4CAF50; border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #2E7D32;">${word.english}</div>
                                <div style="color: #666; font-size: 14px;">${word.chinese}</div>
                            </div>
                        `).join('')}
                    </div>
                    ${totalWords > 10 ? `
                        <div style="text-align: center; margin-top: 15px;">
                            <span style="color: #666;">è¿˜æœ‰ ${totalWords - 10} ä¸ªå•è¯æœªæ˜¾ç¤º</span>
                        </div>
                    ` : ''}
                </div>
            ` : `
                <div style="margin-bottom: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <div style="font-size: 3em; margin-bottom: 10px; color: #ddd;">ğŸ“š</div>
                    <p style="color: #666;">è¿™ä¸ªåˆ†ç»„è¿˜æ²¡æœ‰å•è¯</p>
                    <p style="color: #999; font-size: 14px; margin-top: 5px;">ä¸Šä¼ å•è¯åï¼Œå­¦ç”Ÿä¼šè‡ªåŠ¨åŒæ­¥</p>
                </div>
            `}
            
            <div style="text-align: center; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                <button class="btn btn-blue" onclick="uploadWordsToGroupFixed('${groupId}')" style="padding: 12px 30px; font-size: 16px; margin-right: 10px;">
                    ğŸ“¤ ä¸Šä¼ å•è¯
                </button>
                <button class="btn" onclick="manageGroupWords('${groupId}')" style="padding: 12px 30px; font-size: 16px;">
                    ğŸ“– ç®¡ç†å•è¯
                </button>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„è¯¦æƒ…é”™è¯¯:', error);
        document.getElementById('group-detail').innerHTML = `
            <div class="message-box message-error">
                <h4 style="margin-bottom: 10px;">âŒ åŠ è½½å¤±è´¥</h4>
                <p style="margin-bottom: 15px;">${error.message}</p>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn" onclick="loadGroupListFixed()" style="margin-right: 10px;">
                        è¿”å›åˆ—è¡¨
                    </button>
                    <button class="btn" onclick="showGroupDetailFixed('${groupId}')">
                        é‡è¯•åŠ è½½
                    </button>
                </div>
            </div>
        `;
    }
}

// åˆ·æ–°åˆ†ç»„è¯¦æƒ…
function refreshGroupDetail(groupId) {
    showGroupDetailFixed(groupId);
}

// æ·»åŠ å­¦ç”Ÿåˆ°åˆ†ç»„
async function addStudentToGroupFixed(groupId, studentId) {
    try {
        showAlert(`æ­£åœ¨æ·»åŠ  ${studentId} åˆ°åˆ†ç»„...`, 'info');
        
        const { error } = await dbClient
            .from('group_students')
            .insert([{
                group_id: groupId,
                student_id: studentId,
                created_at: new Date().toISOString()
            }], { onConflict: 'group_id,student_id' });
        
        if (error) {
            if (error.code === '23505') {
                showAlert(`${studentId} å·²ç»åœ¨åˆ†ç»„ä¸­`, 'warning');
            } else {
                throw error;
            }
        } else {
            showAlert(`âœ… ${studentId} å·²æˆåŠŸæ·»åŠ åˆ°åˆ†ç»„`, 'success');
        }
        
        // åˆ·æ–°åˆ†ç»„åˆ—è¡¨ç»Ÿè®¡
        loadGroupListFixed();
        
        // åˆ·æ–°åˆ†ç»„è¯¦æƒ…
        showGroupDetailFixed(groupId);
        
        // åŒæ­¥å•è¯ç»™å­¦ç”Ÿ
        await syncWordsToStudentAfterJoiningGroup(studentId, groupId);
        
    } catch (error) {
        console.error('æ·»åŠ å­¦ç”Ÿé”™è¯¯:', error);
        showAlert(`æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
    }
}

// æ–°å¢ï¼šå­¦ç”ŸåŠ å…¥åˆ†ç»„ååŒæ­¥å•è¯
async function syncWordsToStudentAfterJoiningGroup(studentId, groupId) {
    try {
        console.log(`ä¸ºå­¦ç”Ÿ ${studentId} åŒæ­¥åˆ†ç»„ ${groupId} çš„å•è¯...`);
        
        // è·å–åˆ†ç»„æ‰€æœ‰å•è¯
        const { data: groupWords, error } = await dbClient
            .from('words')
            .select('*')
            .eq('group_id', groupId)
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        if (!groupWords || groupWords.length === 0) {
            console.log(`åˆ†ç»„ ${groupId} æ²¡æœ‰å•è¯å¯ä»¥åŒæ­¥`);
            return 0;
        }
        
        console.log(`æ‰¾åˆ° ${groupWords.length} ä¸ªåˆ†ç»„å•è¯`);
        
        // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²æœ‰è¿™äº›å•è¯
        const { data: existingRecords } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°å•è¯è®°å½•
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                review_count: 0,
                group_id: groupId,
                added_date: new Date().toISOString()
            }));
        
        console.log(`éœ€è¦åŒæ­¥ ${newRecords.length} ä¸ªæ–°å•è¯`);
        
        if (newRecords.length > 0) {
            // åˆ†æ‰¹æ’å…¥
            const batchSize = 50;
            for (let i = 0; i < newRecords.length; i += batchSize) {
                const batch = newRecords.slice(i, i + batchSize);
                await dbClient
                    .from('study_records')
                    .insert(batch);
            }
            
            console.log(`ä¸º ${studentId} åŒæ­¥äº† ${newRecords.length} ä¸ªå•è¯`);
            showAlert(`âœ… å·²ä¸ºå­¦ç”Ÿ ${studentId} åŒæ­¥ ${newRecords.length} ä¸ªåˆ†ç»„å•è¯`, 'success');
            return newRecords.length;
        }
        
        return 0;
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿé”™è¯¯:', error);
        showAlert(`å•è¯åŒæ­¥å¤±è´¥: ${error.message}`, 'warning');
        return 0;
    }
}

// ç§»é™¤å­¦ç”Ÿä»åˆ†ç»„
async function removeStudentFromGroupFixed(groupId, studentId) {
    if (!confirm(`ç¡®å®šè¦ä»åˆ†ç»„ä¸­ç§»é™¤ ${studentId} å—ï¼Ÿ\n\nâš ï¸ ç§»é™¤åï¼Œè¯¥å­¦ç”Ÿåœ¨æ­¤åˆ†ç»„ä¸‹çš„æœªå­¦ä¹ å•è¯å°†è¢«åˆ é™¤ï¼`)) {
        return;
    }
    
    try {
        showAlert(`æ­£åœ¨ç§»é™¤ ${studentId}...`, 'info');
        
        // 1. åˆ é™¤åˆ†ç»„å­¦ç”Ÿå…³è”
        const { error: deleteError } = await dbClient
            .from('group_students')
            .delete()
            .eq('group_id', groupId)
            .eq('student_id', studentId);
        
        if (deleteError) throw deleteError;
        
        // 2. è·å–è¯¥å­¦ç”Ÿåœ¨å½“å‰åˆ†ç»„ä¸‹çš„å­¦ä¹ è®°å½•
        const { data: groupRecords, error: recordsError } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', studentId)
            .eq('group_id', groupId);
        
        if (recordsError) throw recordsError;
        
        // 3. åªåˆ é™¤æœªå­¦ä¹ çš„å•è¯ï¼ˆstatus='new'ä¸”last_reviewedä¸ºnullï¼‰
        if (groupRecords && groupRecords.length > 0) {
            const unlearnedRecords = groupRecords.filter(record => 
                record.status === 'new' && !record.last_reviewed
            );
            
            if (unlearnedRecords.length > 0) {
                for (const record of unlearnedRecords) {
                    await dbClient
                        .from('study_records')
                        .delete()
                        .eq('id', record.id);
                }
                console.log(`åˆ é™¤äº† ${unlearnedRecords.length} ä¸ªæœªå­¦ä¹ å•è¯`);
            }
            
            // å¯¹äºå·²ç»å­¦ä¹ è¿‡çš„å•è¯ï¼Œä¿ç•™è®°å½•ä½†ç§»é™¤åˆ†ç»„IDï¼ˆè®¾ç½®ä¸ºnullï¼‰
            const learnedRecords = groupRecords.filter(record => 
                record.status !== 'new' || record.last_reviewed
            );
            
            if (learnedRecords.length > 0) {
                const learnedIds = learnedRecords.map(r => r.id);
                await dbClient
                    .from('study_records')
                    .update({ group_id: null })
                    .in('id', learnedIds);
                console.log(`ç§»é™¤äº† ${learnedRecords.length} ä¸ªå·²å­¦ä¹ å•è¯çš„åˆ†ç»„å…³è”`);
            }
        }
        
        showAlert(`âœ… ${studentId} å·²ä»åˆ†ç»„ä¸­ç§»é™¤\nğŸ“š æœªå­¦ä¹ å•è¯å·²åˆ é™¤\nâœ… å·²å­¦ä¹ å•è¯ä¿ç•™åœ¨åŸåˆ†ç»„`, 'success');
        
        // åˆ·æ–°åˆ†ç»„åˆ—è¡¨ç»Ÿè®¡
        loadGroupListFixed();
        
        // åˆ·æ–°åˆ†ç»„è¯¦æƒ…
        showGroupDetailFixed(groupId);
        
        // å¦‚æœè¯¥å­¦ç”Ÿå½“å‰åœ¨çº¿ï¼Œåˆ·æ–°å…¶ä¸»é¡µ
        if (appState.currentUser === studentId) {
            setTimeout(() => {
                loadStudentDashboardSimple();
                showAlert('æ‚¨çš„åˆ†ç»„å·²æ›´æ–°ï¼Œæœªå­¦ä¹ å•è¯å·²ç§»é™¤', 'info');
            }, 1000);
        }
        
    } catch (error) {
        console.error('ç§»é™¤å­¦ç”Ÿé”™è¯¯:', error);
        showAlert(`ç§»é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

// åˆ é™¤åˆ†ç»„
async function deleteGroupFixed(groupId, groupName) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ "${groupName}" å—ï¼Ÿ\n\nâš ï¸ åˆ é™¤åï¼š\nâ€¢ åˆ†ç»„ä¿¡æ¯å°†è¢«æ°¸ä¹…åˆ é™¤\nâ€¢ åˆ†ç»„ä¸å­¦ç”Ÿçš„å…³è”å°†è¢«ç§»é™¤\nâ€¢ åˆ†ç»„å†…çš„å•è¯å°†ä¿ç•™ï¼ˆä½†ä¸å†å±äºä»»ä½•åˆ†ç»„ï¼‰`)) {
        return;
    }
    
    try {
        showAlert(`æ­£åœ¨åˆ é™¤åˆ†ç»„ "${groupName}"...`, 'warning');
        
        // 1. å…ˆåˆ é™¤åˆ†ç»„å­¦ç”Ÿå…³è”
        const { error: deleteStudentsError } = await dbClient
            .from('group_students')
            .delete()
            .eq('group_id', groupId);
        
        if (deleteStudentsError) throw deleteStudentsError;
        
        // 2. æ›´æ–°å•è¯ï¼Œç§»é™¤åˆ†ç»„IDï¼ˆè€Œä¸æ˜¯åˆ é™¤å•è¯ï¼‰
        const { error: updateWordsError } = await dbClient
            .from('words')
            .update({ group_id: null })
            .eq('group_id', groupId)
            .eq('teacher_id', appState.teacherId);
        
        if (updateWordsError) throw updateWordsError;
        
        // 3. åˆ é™¤åˆ†ç»„æœ¬èº«
        const { error: deleteGroupError } = await dbClient
            .from('groups')
            .delete()
            .eq('id', groupId);
        
        if (deleteGroupError) throw deleteGroupError;
        
        showAlert(`âœ… åˆ†ç»„ "${groupName}" å·²æˆåŠŸåˆ é™¤`, 'success');
        
        // 4. é‡æ–°åŠ è½½åˆ†ç»„åˆ—è¡¨
        loadGroupListFixed();
        
        // 5. æ¸…ç©ºåˆ†ç»„è¯¦æƒ…åŒºåŸŸ
        document.getElementById('group-detail').innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                <p style="color: #666;">åˆ†ç»„å·²åˆ é™¤</p>
                <p style="color: #999; font-size: 14px; margin-top: 10px;">è¯·é€‰æ‹©å…¶ä»–åˆ†ç»„æˆ–åˆ›å»ºæ–°åˆ†ç»„</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åˆ é™¤åˆ†ç»„é”™è¯¯:', error);
        showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

// ä¸Šä¼ å•è¯åˆ°åˆ†ç»„
function uploadWordsToGroupFixed(groupId) {
    appState.selectedGroupId = groupId;
    showUploadWordsPage();
}

// ç®¡ç†åˆ†ç»„å•è¯
function manageGroupWords(groupId) {
    appState.selectedGroupId = groupId;
    showWordManagementPage();
}

// æ·»åŠ æ‰€æœ‰å­¦ç”Ÿåˆ°åˆ†ç»„
async function addAllStudentsToGroupFixed(groupId) {
    try {
        // è·å–æ‰€æœ‰å­¦ç”Ÿ
        const { data: allStudents, error: studentsError } = await dbClient
            .from('users')
            .select('username')
            .eq('is_teacher', false);
        
        if (studentsError) throw studentsError;
        
        if (!allStudents || allStudents.length === 0) {
            showAlert('æ²¡æœ‰å­¦ç”Ÿå¯ä»¥æ·»åŠ ', 'info');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦å°†æ‰€æœ‰ ${allStudents.length} åå­¦ç”Ÿæ·»åŠ åˆ°è¿™ä¸ªåˆ†ç»„å—ï¼Ÿ`)) {
            return;
        }
        
        showAlert(`æ­£åœ¨æ·»åŠ  ${allStudents.length} åå­¦ç”Ÿåˆ°åˆ†ç»„...`, 'info');
        
        // å‡†å¤‡æ‰¹é‡æ’å…¥æ•°æ®
        const studentsToAdd = allStudents.map(student => ({
            group_id: groupId,
            student_id: student.username,
            created_at: new Date().toISOString()
        }));
        
        // æ‰¹é‡æ’å…¥ï¼ˆä½¿ç”¨onConflictå¿½ç•¥é‡å¤ï¼‰
        const { error } = await dbClient
            .from('group_students')
            .insert(studentsToAdd, { onConflict: 'group_id,student_id' });
        
        if (error) {
            // å¿½ç•¥é‡å¤é”®é”™è¯¯
            if (!error.message.includes('duplicate key')) {
                throw error;
            }
        }
        
        showAlert(`âœ… å·²æˆåŠŸæ·»åŠ æ‰€æœ‰ ${allStudents.length} åå­¦ç”Ÿåˆ°åˆ†ç»„`, 'success');
        
        // åˆ·æ–°åˆ†ç»„è¯¦æƒ…
        showGroupDetailFixed(groupId);
        
    } catch (error) {
        console.error('æ·»åŠ æ‰€æœ‰å­¦ç”Ÿé”™è¯¯:', error);
        showAlert(`æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
    }
}

// åˆ·æ–°æ‰€æœ‰åˆ†ç»„æ•°æ®å‡½æ•°
function refreshAllGroupData() {
    showAlert('æ­£åœ¨åˆ·æ–°æ‰€æœ‰åˆ†ç»„æ•°æ®...', 'info');
    // åˆ·æ–°åˆ†ç»„åˆ—è¡¨
    loadGroupListFixed();
    // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„åˆ†ç»„ï¼Œä¹Ÿåˆ·æ–°è¯¥åˆ†ç»„çš„è¯¦æƒ…
    if (appState.selectedGroupId) {
        showGroupDetailFixed(appState.selectedGroupId);
    }
}

function showAllStudentsPage() {
    showScreen('teacher-students-screen');
    loadAllStudentsPage();
}

async function loadAllStudentsPage() {
    const content = document.getElementById('teacher-students-content');
    content.innerHTML = '<p style="text-align: center;">åŠ è½½å­¦ç”Ÿåˆ—è¡¨...</p>';
    
    try {
        const { data: students, error } = await dbClient
            .from('users')
            .select('*')
            .eq('is_teacher', false)
            .order('last_login', { ascending: false });
        
        if (error) throw error;
        
        if (!students || students.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¥</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ³¨å†Œ</h3>
                    <p style="color: #999;">åˆ†äº«é“¾æ¥ç»™å­¦ç”Ÿæ³¨å†Œ</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿåˆ—è¡¨ï¼ˆå…± ${students.length} äººï¼‰</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿå§“å</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æœ€åç™»å½•</th>
                            <th>å•è¯æ€»æ•°</th>
                            <th>å·²æŒæ¡</th>
                            <th>ç†Ÿæ‚‰</th>
                            <th>éœ€å¤ä¹ </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const student of students) {
            const { data: records } = await dbClient
                .from('study_records')
                .select('*')
                .eq('student_id', student.username);
            
            const total = records?.length || 0;
            const mastered = records?.filter(r => r.status === 'mastered').length || 0;
            const learning = records?.filter(r => r.status === 'learning').length || 0;
            const review = records?.filter(r => r.status === 'new').length || 0;
            
            const regDate = new Date(student.created_at).toLocaleDateString('zh-CN');
            const lastLogin = student.last_login ? 
                new Date(student.last_login).toLocaleDateString('zh-CN') : 'ä»æœªç™»å½•';
            
            html += `
                <tr>
                    <td><strong>${student.username}</strong></td>
                    <td>${regDate}</td>
                    <td>${lastLogin}</td>
                    <td>${total}</td>
                    <td style="color: #4CAF50;">${mastered}</td>
                    <td style="color: #FF9800;">${learning}</td>
                    <td style="color: #F44336;">${review}</td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                onclick="viewStudentDetail('${student.username}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-red" style="padding: 6px 12px; font-size: 14px; margin-left: 5px;" 
                                onclick="deleteStudent('${student.username}')">åˆ é™¤</button>
                    </td>
                </tr>
            `;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function viewStudentDetail(studentId) {
    const content = document.getElementById('teacher-students-content');
    content.innerHTML = `<p style="text-align: center;">åŠ è½½ ${studentId} çš„å­¦ä¹ æ•°æ®...</p>`;
    
    try {
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', studentId)
            .order('last_reviewed', { ascending: false });
        
        if (error) throw error;
        
        const total = records?.length || 0;
        const mastered = records?.filter(r => r.status === 'mastered').length || 0;
        const learning = records?.filter(r => r.status === 'learning').length || 0;
        const review = records?.filter(r => r.status === 'new').length || 0;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        let detailHtml = '';
        if (records && records.length > 0) {
            detailHtml = `
                <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ“– è¯¦ç»†å­¦ä¹ è®°å½•</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>è‹±æ–‡</th>
                                <th>ä¸­æ–‡</th>
                                <th>çŠ¶æ€</th>
                                <th>å¤ä¹ æ¬¡æ•°</th>
                                <th>æœ€åå¤ä¹ </th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            records.forEach(record => {
                let statusText, statusColor;
                switch(record.status) {
                    case 'mastered': statusText = 'âœ… å·²æŒæ¡'; statusColor = '#4CAF50'; break;
                    case 'learning': statusText = 'ğŸ”„ ç†Ÿæ‚‰'; statusColor = '#FF9800'; break;
                    default: statusText = 'ğŸ“ æ²¡å°è±¡'; statusColor = '#666';
                }
                
                const lastReview = record.last_reviewed ? 
                    new Date(record.last_reviewed).toLocaleDateString('zh-CN') : 'ä»æœª';
                
                detailHtml += `
                    <tr>
                        <td><strong>${record.english}</strong></td>
                        <td>${record.chinese}</td>
                        <td style="color: ${statusColor};">${statusText}</td>
                        <td>${record.review_count || 0}</td>
                        <td>${lastReview}</td>
                    </tr>
                `;
            });
            
            detailHtml += `</tbody></table></div>`;
        }
        
        content.innerHTML = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h3 style="color: #333;">ğŸ‘¤ å­¦ç”Ÿï¼š${studentId}</h3>
                    <button class="btn" onclick="showAllStudentsPage()">ğŸ”™ è¿”å›åˆ—è¡¨</button>
                </div>
                
                <div class="stats-card">
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${total}</div>
                            <div class="label">å•è¯æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${mastered}</div>
                            <div class="label">å·²æŒæ¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${learning}</div>
                            <div class="label">ç†Ÿæ‚‰</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${review}</div>
                            <div class="label">éœ€å¤ä¹ </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                            <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
                
                ${detailHtml}
            </div>
        `;
        
    } catch (error) {
        console.error('æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function deleteStudent(studentId) {
    if (studentId === appState.currentUser) {
        showAlert('ä¸èƒ½åˆ é™¤å½“å‰ç™»å½•çš„ç”¨æˆ·', 'error');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿ "${studentId}" å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åï¼Œè¯¥å­¦ç”Ÿçš„å­¦ä¹ è®°å½•ã€åˆ†ç»„å…³è”ç­‰æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
        return;
    }
    
    try {
        const { error } = await dbClient
            .from('users')
            .delete()
            .eq('username', studentId)
            .eq('is_teacher', false);
        
        if (error) throw error;
        
        showAlert(`å­¦ç”Ÿ "${studentId}" å·²æˆåŠŸåˆ é™¤ï¼`, 'success');
        showAllStudentsPage();
        
    } catch (error) {
        console.error('åˆ é™¤å­¦ç”Ÿé”™è¯¯:', error);
        showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

function showLearningProgressPage() {
    showScreen('teacher-progress-screen');
    loadLearningProgressPage();
}

async function loadLearningProgressPage() {
    const content = document.getElementById('teacher-progress-content');
    content.innerHTML = '<p style="text-align: center;">åŠ è½½å­¦ä¹ è¿›åº¦...</p>';
    
    try {
        const { data: students } = await dbClient
            .from('users')
            .select('username')
            .eq('is_teacher', false);
        
        if (!students || students.length === 0) {
            content.innerHTML = '<p style="text-align: center;">è¿˜æ²¡æœ‰å­¦ç”Ÿæ•°æ®</p>';
            return;
        }
        
        let allRecords = [];
        for (const student of students) {
            const { data: records } = await dbClient
                .from('study_records')
                .select('*')
                .eq('student_id', student.username);
            
            if (records) {
                allRecords = [...allRecords, ...records];
            }
        }
        
        const total = allRecords.length;
        const mastered = allRecords.filter(r => r.status === 'mastered').length;
        const learning = allRecords.filter(r => r.status === 'learning').length;
        const review = allRecords.filter(r => r.status === 'new').length;
        const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
        
        const wordStats = {};
        allRecords.forEach(record => {
            if (!wordStats[record.english]) {
                wordStats[record.english] = { total: 0, mastered: 0, chinese: record.chinese };
            }
            wordStats[record.english].total++;
            if (record.status === 'mastered') {
                wordStats[record.english].mastered++;
            }
        });
        
        const difficultWords = Object.entries(wordStats)
            .map(([english, stats]) => ({
                english,
                chinese: stats.chinese,
                mastered: stats.mastered,
                total: stats.total,
                rate: stats.total > 0 ? Math.round((stats.mastered / stats.total) * 100) : 0
            }))
            .sort((a, b) => a.rate - b.rate)
            .slice(0, 10);
        
        content.innerHTML = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 30px;">ğŸ“Š ç­çº§å­¦ä¹ è¿›åº¦æ€»è§ˆ</h3>
                
                <div class="stats-card">
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${students.length}</div>
                            <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${total}</div>
                            <div class="label">æ€»å­¦ä¹ æ¬¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${mastered}</div>
                            <div class="label">å·²æŒæ¡æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${progress}%</div>
                            <div class="label">æ•´ä½“æŒæ¡ç‡</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">æŒæ¡è¿›åº¦</span>
                            <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
                
                ${difficultWords.length > 0 ? `
                <div class="stats-card" style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 20px;">âš ï¸ éœ€è¦é‡ç‚¹å…³æ³¨çš„å•è¯</h4>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>è‹±æ–‡</th>
                                    <th>ä¸­æ–‡</th>
                                    <th>å­¦ä¹ äººæ•°</th>
                                    <th>æŒæ¡äººæ•°</th>
                                    <th>æŒæ¡ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${difficultWords.map(word => `
                                    <tr>
                                        <td><strong>${word.english}</strong></td>
                                        <td>${word.chinese}</td>
                                        <td>${word.total}</td>
                                        <td>${word.mastered}</td>
                                        <td style="color: ${word.rate < 50 ? '#F44336' : word.rate < 80 ? '#FF9800' : '#4CAF50'}">
                                            ${word.rate}%
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ä¹ è¿›åº¦é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function showWordManagementPage() {
    showScreen('teacher-words-screen');
    loadWordManagementPage();
}

async function loadWordManagementPage() {
    const content = document.getElementById('teacher-words-content');
    content.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“– å•è¯ç®¡ç†</h3>
            
            <!-- æ–°å¢ï¼šåˆ†ç»„ç­›é€‰å’Œæ’åºæ§åˆ¶ -->
            <div class="batch-controls" style="margin-bottom: 15px; padding: 15px; background: #E3F2FD;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: bold; color: #1565C0; margin-right: 5px;">åˆ†ç»„ç­›é€‰:</label>
                        <select id="group-filter" style="padding: 8px; border-radius: 5px; border: 2px solid #2196F3; min-width: 150px;">
                            <option value="all">æ‰€æœ‰åˆ†ç»„</option>
                            <!-- åˆ†ç»„é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    
                    <div>
                        <label style="font-weight: bold; color: #1565C0; margin-right: 5px;">æ’åºæ–¹å¼:</label>
                        <select id="sort-order" style="padding: 8px; border-radius: 5px; border: 2px solid #2196F3; min-width: 150px;">
                            <option value="created_desc">ä¸Šä¼ æ—¶é—´ï¼ˆæ–°åˆ°æ—§ï¼‰</option>
                            <option value="created_asc">ä¸Šä¼ æ—¶é—´ï¼ˆæ—§åˆ°æ–°ï¼‰</option>
                            <option value="english_asc">A-Zï¼ˆè‹±æ–‡ï¼‰</option>
                            <option value="english_desc">Z-Aï¼ˆè‹±æ–‡ï¼‰</option>
                            <option value="chinese_asc">A-Zï¼ˆä¸­æ–‡ï¼‰</option>
                            <option value="chinese_desc">Z-Aï¼ˆä¸­æ–‡ï¼‰</option>
                        </select>
                    </div>
                    
                    <div>
                        <button class="btn" onclick="applyWordFilter()" style="padding: 8px 16px;">
                            ğŸ”„ åº”ç”¨ç­›é€‰
                        </button>
                    </div>
                    
                    <div style="margin-left: auto;">
                        <input type="text" id="word-search" placeholder="ğŸ” æœç´¢å•è¯..." 
                               style="padding: 8px; border-radius: 5px; border: 2px solid #ddd; min-width: 200px;">
                    </div>
                </div>
            </div>
            
            <!-- æ‰¹é‡æ“ä½œæ§åˆ¶ -->
            <div class="batch-controls">
                <button class="btn" onclick="selectAllWords()">
                    <span>ğŸ“‹ å…¨é€‰</span>
                </button>
                <button class="btn" onclick="deselectAllWords()">
                    <span>ğŸ“‹ å…¨ä¸é€‰</span>
                </button>
                <button class="btn btn-red" onclick="batchDeleteWords()" id="batch-delete-btn" disabled>
                    <span>ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (0)</span>
                </button>
                <button class="btn" onclick="deleteAllWordsInGroup()" id="group-delete-btn" disabled>
                    <span>ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„æ‰€æœ‰å•è¯</span>
                </button>
                <span style="margin-left: auto; color: #666;" id="selected-count">å·²é€‰æ‹© 0 ä¸ªå•è¯</span>
            </div>
            
            <div id="word-management-content">
                <p style="text-align: center;">åŠ è½½å•è¯åˆ—è¡¨...</p>
            </div>
        </div>
    `;
    
    appState.selectedWords = [];
    
    // åŠ è½½åˆ†ç»„ç­›é€‰é€‰é¡¹
    setTimeout(() => loadGroupFilterOptions(), 100);
    
    // åˆå§‹åŠ è½½å•è¯åˆ—è¡¨
    setTimeout(() => loadWordManagementList('all', 'created_desc', ''), 200);
}

async function loadWordManagementList() {
    try {
        const { data: words, error } = await dbClient
            .from('words')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('word-management-content');
        
        if (!words || words.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å•è¯</h3>
                    <p style="color: #999;">è¯·å…ˆä¸Šä¼ å•è¯</p>
                </div>
            `;
            return;
        }
        
        const { data: groups } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId);
        
        const groupMap = {};
        if (groups) {
            groups.forEach(group => {
                groupMap[group.id] = group.name;
            });
        }
        
        let html = `
            <div style="margin-bottom: 20px;">
                <p>å…± ${words.length} ä¸ªå•è¯</p>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>åˆ†ç»„</th>
                            <th>ä¸Šä¼ æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        words.forEach(word => {
            const uploadTime = new Date(word.created_at).toLocaleDateString('zh-CN');
            const groupName = word.group_id ? (groupMap[word.group_id] || 'æœªçŸ¥åˆ†ç»„') : 'æœªåˆ†ç»„';
            const isSelected = appState.selectedWords.includes(word.id);
            
            html += `
                <tr id="word-row-${word.id}" ${isSelected ? 'style="background-color: #e8f5e9;"' : ''}>
                    <td>
                        <input type="checkbox" class="word-checkbox" value="${word.id}" 
                               onchange="toggleWordSelection('${word.id}', this.checked)"
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td><strong>${word.english}</strong></td>
                    <td>${word.chinese}</td>
                    <td>${groupName}</td>
                    <td>${uploadTime}</td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                onclick="editWord('${word.id}', '${word.english}', '${word.chinese}')">ç¼–è¾‘</button>
                        <button class="btn btn-red" style="padding: 6px 12px; font-size: 14px; margin-left: 5px;" 
                                onclick="deleteWord('${word.id}', '${word.english}')">åˆ é™¤</button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        updateSelectionCount();
        
        // å¦‚æœæœ‰åˆ†ç»„ï¼Œå¯ç”¨åˆ†ç»„åˆ é™¤æŒ‰é’®
        if (groups && groups.length > 0) {
            document.getElementById('group-delete-btn').disabled = false;
        }
        
    } catch (error) {
        console.error('åŠ è½½å•è¯åº“é”™è¯¯:', error);
        document.getElementById('word-management-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function toggleWordSelection(wordId, isSelected) {
    if (isSelected) {
        if (!appState.selectedWords.includes(wordId)) {
            appState.selectedWords.push(wordId);
        }
    } else {
        appState.selectedWords = appState.selectedWords.filter(id => id !== wordId);
    }
    updateSelectionCount();
}

function selectAllWords() {
    const checkboxes = document.querySelectorAll('.word-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        const wordId = checkbox.value;
        if (!appState.selectedWords.includes(wordId)) {
            appState.selectedWords.push(wordId);
        }
    });
    updateSelectionCount();
}

function deselectAllWords() {
    const checkboxes = document.querySelectorAll('.word-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    appState.selectedWords = [];
    updateSelectionCount();
}

function toggleSelectAll(isChecked) {
    if (isChecked) {
        selectAllWords();
    } else {
        deselectAllWords();
    }
}

function updateSelectionCount() {
    const count = appState.selectedWords.length;
    const selectedCountElement = document.getElementById('selected-count');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    
    if (selectedCountElement) {
        selectedCountElement.textContent = `å·²é€‰æ‹© ${count} ä¸ªå•è¯`;
    }
    
    if (batchDeleteBtn) {
        batchDeleteBtn.disabled = count === 0;
        batchDeleteBtn.innerHTML = `<span>ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (${count})</span>`;
    }
    
    const checkboxes = document.querySelectorAll('.word-checkbox');
    checkboxes.forEach(checkbox => {
        const wordId = checkbox.value;
        const row = document.getElementById(`word-row-${wordId}`);
        if (row) {
            if (checkbox.checked) {
                row.style.backgroundColor = '#e8f5e9';
            } else {
                row.style.backgroundColor = '';
            }
        }
    });
}

async function batchDeleteWords() {
    const count = appState.selectedWords.length;
    if (count === 0) {
        showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å•è¯', 'error');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦æ‰¹é‡åˆ é™¤ ${count} ä¸ªå•è¯å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åï¼Œæ‰€æœ‰å­¦ç”Ÿå­¦ä¹ è¿™äº›å•è¯çš„è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
        return;
    }
    
    try {
        const { data: studyRecords, error: checkError } = await dbClient
            .from('study_records')
            .select('word_id')
            .in('word_id', appState.selectedWords);
        
        if (checkError) throw checkError;
        
        const studentCount = studyRecords?.length || 0;
        
        if (studentCount > 0) {
            if (!confirm(`âš ï¸ æœ‰ ${studentCount} æ¡å­¦ç”Ÿå­¦ä¹ è®°å½•å…³è”åˆ°è¿™äº›å•è¯ï¼\n\nåˆ é™¤åï¼Œè¿™äº›å­¦ä¹ è®°å½•å°†å…¨éƒ¨ä¸¢å¤±ã€‚\n\nç¡®å®šè¦ç»§ç»­åˆ é™¤å—ï¼Ÿ`)) {
                return;
            }
        }
        
        let deletedCount = 0;
        const batchSize = 50;
        
        for (let i = 0; i < appState.selectedWords.length; i += batchSize) {
            const batch = appState.selectedWords.slice(i, i + batchSize);
            const { error } = await dbClient
                .from('words')
                .delete()
                .in('id', batch)
                .eq('teacher_id', appState.teacherId);
            
            if (error) {
                console.error(`æ‰¹é‡åˆ é™¤é”™è¯¯ (æ‰¹æ¬¡ ${Math.floor(i/batchSize) + 1}):`, error);
                for (const wordId of batch) {
                    try {
                        await dbClient
                            .from('words')
                            .delete()
                            .eq('id', wordId)
                            .eq('teacher_id', appState.teacherId);
                        deletedCount++;
                    } catch (err) {
                        console.error(`åˆ é™¤å•è¯ ${wordId} å¤±è´¥:`, err);
                    }
                }
            } else {
                deletedCount += batch.length;
            }
        }
        
        showAlert(`æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªå•è¯ï¼`, 'success');
        appState.selectedWords = [];
        loadWordManagementList();
        
    } catch (error) {
        console.error('æ‰¹é‡åˆ é™¤å•è¯é”™è¯¯:', error);
        showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

async function deleteAllWordsInGroup() {
    try {
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        if (!groups || groups.length === 0) {
            showAlert('æ²¡æœ‰åˆ†ç»„', 'error');
            return;
        }
        
        let groupOptions = '';
        groups.forEach(group => {
            groupOptions += `<option value="${group.id}">${group.name}</option>`;
        });
        
        const groupSelect = `
            <div style="margin-bottom: 15px;">
                <label>é€‰æ‹©è¦åˆ é™¤çš„åˆ†ç»„ï¼š</label>
                <select id="delete-group-select" style="width: 100%; padding: 10px; margin-top: 5px;">
                    ${groupOptions}
                </select>
            </div>
        `;
        
        // åˆ›å»ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        `;
        
        dialog.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h3 style="color: #333; margin-bottom: 20px;">åˆ é™¤åˆ†ç»„æ‰€æœ‰å•è¯</h3>
                <div style="margin-bottom: 20px;">
                    <p>ç¡®å®šè¦åˆ é™¤è¯¥åˆ†ç»„çš„æ‰€æœ‰å•è¯å—ï¼Ÿ</p>
                    <p style="color: #F44336; font-weight: bold;">âš ï¸ è­¦å‘Šï¼šåˆ é™¤åï¼Œæ‰€æœ‰å­¦ç”Ÿå­¦ä¹ è¿™äº›å•è¯çš„è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼Œä¸”æ— æ³•æ¢å¤ï¼</p>
                    ${groupSelect}
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="btn" onclick="this.parentElement.parentElement.parentElement.remove()">å–æ¶ˆ</button>
                    <button class="btn btn-red" id="confirm-group-delete">ç¡®å®šåˆ é™¤</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        
        document.getElementById('confirm-group-delete').onclick = async () => {
            const groupId = document.getElementById('delete-group-select').value;
            const groupName = groups.find(g => g.id === groupId).name;
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ç”Ÿå­¦ä¹ è¿™äº›å•è¯
                const { data: groupWords } = await dbClient
                    .from('words')
                    .select('id')
                    .eq('group_id', groupId)
                    .eq('teacher_id', appState.teacherId);
                
                if (!groupWords || groupWords.length === 0) {
                    showAlert(`åˆ†ç»„ "${groupName}" ä¸­æ²¡æœ‰å•è¯`, 'info');
                    dialog.remove();
                    return;
                }
                
                const wordIds = groupWords.map(w => w.id);
                
                const { data: studyRecords } = await dbClient
                    .from('study_records')
                    .select('word_id')
                    .in('word_id', wordIds);
                
                const studentCount = studyRecords?.length || 0;
                
                if (studentCount > 0) {
                    const finalConfirm = confirm(`âš ï¸ æœ‰ ${studentCount} æ¡å­¦ç”Ÿå­¦ä¹ è®°å½•å…³è”åˆ°è¿™äº›å•è¯ï¼\n\nåˆ é™¤åï¼Œè¿™äº›å­¦ä¹ è®°å½•å°†å…¨éƒ¨ä¸¢å¤±ã€‚\n\nç¡®å®šè¦ç»§ç»­åˆ é™¤åˆ†ç»„ "${groupName}" çš„æ‰€æœ‰ ${wordIds.length} ä¸ªå•è¯å—ï¼Ÿ`);
                    if (!finalConfirm) {
                        dialog.remove();
                        return;
                    }
                }
                
                // åˆ é™¤å•è¯
                const { error } = await dbClient
                    .from('words')
                    .delete()
                    .eq('group_id', groupId)
                    .eq('teacher_id', appState.teacherId);
                
                if (error) throw error;
                
                showAlert(`æˆåŠŸåˆ é™¤åˆ†ç»„ "${groupName}" çš„æ‰€æœ‰å•è¯ï¼`, 'success');
                dialog.remove();
                loadWordManagementList();
                
            } catch (error) {
                console.error('åˆ é™¤åˆ†ç»„å•è¯é”™è¯¯:', error);
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                dialog.remove();
            }
        };
        
    } catch (error) {
        console.error('å‡†å¤‡åˆ é™¤åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`æ“ä½œå¤±è´¥: ${error.message}`, 'error');
    }
}

function editWord(wordId, english, chinese) {
    const newEnglish = prompt('ä¿®æ”¹è‹±æ–‡å•è¯ï¼š', english);
    if (newEnglish === null) return;
    
    const newChinese = prompt('ä¿®æ”¹ä¸­æ–‡æ„æ€ï¼š', chinese);
    if (newChinese === null) return;
    
    if (!newEnglish.trim() || !newChinese.trim()) {
        showAlert('è‹±æ–‡å’Œä¸­æ–‡éƒ½ä¸èƒ½ä¸ºç©º', 'error');
        return;
    }
    
    updateWord(wordId, newEnglish.trim(), newChinese.trim());
}

async function updateWord(wordId, english, chinese) {
    try {
        const { error } = await dbClient
            .from('words')
            .update({
                english: english,
                chinese: chinese
            })
            .eq('id', wordId)
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        await dbClient
            .from('study_records')
            .update({
                english: english,
                chinese: chinese
            })
            .eq('word_id', wordId);
        
        showAlert(`å•è¯ "${english}" å·²æ›´æ–°ï¼`, 'success');
        loadWordManagementList();
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯é”™è¯¯:', error);
        showAlert(`æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
    }
}

async function deleteWord(wordId, englishWord) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å•è¯ "${englishWord}" å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åï¼Œæ‰€æœ‰å­¦ç”Ÿå­¦ä¹ è¯¥å•è¯çš„è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
        return;
    }
    
    try {
        const { data: studyRecords, error: checkError } = await dbClient
            .from('study_records')
            .select('student_id')
            .eq('word_id', wordId);
        
        if (checkError) throw checkError;
        
        const studentCount = studyRecords?.length || 0;
        
        if (studentCount > 0) {
            if (!confirm(`âš ï¸ æœ‰ ${studentCount} åå­¦ç”Ÿåœ¨å­¦ä¹ è¿™ä¸ªå•è¯ï¼\n\nåˆ é™¤åï¼Œè¿™äº›å­¦ç”Ÿçš„å­¦ä¹ è®°å½•å°†å…¨éƒ¨ä¸¢å¤±ã€‚\n\nç¡®å®šè¦ç»§ç»­åˆ é™¤å—ï¼Ÿ`)) {
                return;
            }
        }
        
        const { error } = await dbClient
            .from('words')
            .delete()
            .eq('id', wordId)
            .eq('teacher_id', appState.teacherId);
        
        if (error) throw error;
        
        const row = document.getElementById(`word-row-${wordId}`);
        if (row) {
            row.style.backgroundColor = '#f8d7da';
            row.style.transition = 'opacity 0.5s';
            row.style.opacity = '0.5';
            
            setTimeout(() => {
                row.remove();
                showAlert(`å•è¯ "${englishWord}" å·²æˆåŠŸåˆ é™¤ï¼`, 'success');
            }, 500);
        } else {
            showAlert(`å•è¯ "${englishWord}" å·²æˆåŠŸåˆ é™¤ï¼`, 'success');
            loadWordManagementList();
        }
        
    } catch (error) {
        console.error('åˆ é™¤å•è¯é”™è¯¯:', error);
        showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

function showShareSystemPage() {
    showScreen('teacher-share-screen');
    loadShareSystemPage();
}

function loadShareSystemPage() {
    const currentUrl = window.location.href;
    
    const content = document.getElementById('teacher-share-content');
    content.innerHTML = `
        <div style="max-width: 700px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ”— åˆ†äº«ç³»ç»Ÿç»™å­¦ç”Ÿ</h3>
            
            <div class="stats-card">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ“± å­¦ç”Ÿè®¿é—®é“¾æ¥</h4>
                <div style="background: #f1f3f4; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <input type="text" id="share-url" value="${currentUrl}" readonly 
                           style="width: 100%; padding: 10px; border: none; background: transparent; font-size: 16px;">
                </div>
                <button class="btn" onclick="copyShareLink()">
                    <span>ğŸ“‹ å¤åˆ¶é“¾æ¥</span>
                </button>
                
                <h4 style="margin-top: 40px; color: #333;">ğŸ¯ å­¦ç”Ÿä½¿ç”¨è¯´æ˜</h4>
                <div style="text-align: left; margin: 20px 0;">
                    <div style="display: flex; align-items: start; margin: 15px 0;">
                        <div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">1</div>
                        <div>è®¿é—®ä¸Šé¢çš„é“¾æ¥</div>
                    </div>
                    <div style="display: flex; align-items: start; margin: 15px 0;">
                        <div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">2</div>
                        <div>è¾“å…¥è‹±æ–‡åæ³¨å†Œè´¦å·</div>
                    </div>
                    <div style="display: flex; align-items: start; margin: 15px 0;">
                        <div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">3</div>
                        <div>ç™»å½•åå³å¯å¼€å§‹å­¦ä¹ æ‚¨ä¸Šä¼ çš„å•è¯</div>
                    </div>
                    <div style="display: flex; align-items: start; margin: 15px 0;">
                        <div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">4</div>
                        <div>æ•™å¸ˆå¯ä»¥åœ¨åå°æŸ¥çœ‹å­¦ä¹ è¿›åº¦</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <div class="wechat-badge">
                        <span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                        <strong>Kathy151</strong>
                    </div>
                    <p style="color: #666; margin-top: 15px;">å¦‚æœ‰é—®é¢˜è¯·éšæ—¶è”ç³»</p>
                </div>
            </div>
        </div>
    `;
}

function copyShareLink() {
    const input = document.getElementById('share-url');
    input.select();
    document.execCommand('copy');
    showAlert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
}

async function quickStats() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    try {
        const { data: todayRecords } = await dbClient
            .from('study_records')
            .select('*')
            .gte('last_reviewed', today.toISOString());
        
        const todayCount = todayRecords?.length || 0;
        const todayStudents = new Set(todayRecords?.map(r => r.student_id) || []).size;
        const todayMastered = todayRecords?.filter(r => r.status === 'mastered').length || 0;
        
        showAlert(`ä»Šæ—¥æ•°æ®ï¼š${todayStudents}åå­¦ç”Ÿå­¦ä¹ äº†${todayCount}æ¬¡ï¼ŒæŒæ¡äº†${todayMastered}ä¸ªå•è¯`, 'success');
    } catch (error) {
        showAlert('è·å–ä»Šæ—¥æ•°æ®å¤±è´¥', 'error');
    }
}

async function showStudentActivity() {
    const content = document.getElementById('teacher-content');
    content.innerHTML = '<p style="text-align: center;">åŠ è½½å­¦ç”Ÿæ´»è·ƒåº¦...</p>';
    
    try {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        const { data: recentRecords } = await dbClient
            .from('study_records')
            .select('student_id, last_reviewed')
            .gte('last_reviewed', sevenDaysAgo.toISOString());
        
        if (!recentRecords || recentRecords.length === 0) {
            content.innerHTML = '<p style="text-align: center;">æœ€è¿‘7å¤©æ²¡æœ‰å­¦ä¹ è®°å½•</p>';
            return;
        }
        
        const studentActivity = {};
        recentRecords.forEach(record => {
            if (!studentActivity[record.student_id]) {
                studentActivity[record.student_id] = 0;
            }
            studentActivity[record.student_id]++;
        });
        
        const activityArray = Object.entries(studentActivity)
            .map(([student, count]) => ({ student, count }))
            .sort((a, b) => b.count - a.count);
        
        let html = `
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ˆ æœ€è¿‘7å¤©å­¦ç”Ÿæ´»è·ƒåº¦</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å­¦ç”Ÿ</th>
                            <th>å­¦ä¹ æ¬¡æ•°</th>
                            <th>æ´»è·ƒåº¦</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        activityArray.forEach((item, index) => {
            const level = item.count >= 50 ? 'ğŸ”¥ éå¸¸æ´»è·ƒ' : 
                         item.count >= 20 ? 'â­ æ´»è·ƒ' : 
                         item.count >= 5 ? 'âœ… ä¸€èˆ¬' : 'ğŸ“ è¾ƒå°‘';
            const color = item.count >= 50 ? '#F44336' : 
                         item.count >= 20 ? '#FF9800' : 
                         item.count >= 5 ? '#4CAF50' : '#666';
            
            html += `
                <tr>
                    <td>#${index + 1}</td>
                    <td><strong>${item.student}</strong></td>
                    <td>${item.count}</td>
                    <td style="color: ${color}; font-weight: bold;">${level}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½æ´»è·ƒåº¦é”™è¯¯:', error);
        content.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboardSimple();
}

// åŠ è½½ç®€æ´ç‰ˆå­¦ç”Ÿé¢æ¿
async function loadStudentDashboardSimple() {
    try {
        // è®¾ç½®å­¦ç”Ÿå§“å
        document.getElementById('student-name').textContent = appState.currentUser;
        
        // åŠ è½½æ‰“å¡çŠ¶æ€
        await loadClockInStatus();
        
        // åŒæ­¥å•è¯
        await syncGroupWordsToStudent(appState.currentUser);
        
        // è·å–å­¦ä¹ è®°å½• - æ·»åŠ æ’åº
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .order('last_reviewed', { ascending: false });
        
        if (error) throw error;
        
        appState.userWords = records || [];
        
// ä»Šæ—¥å­¦ä¹ æƒ…å†µ
const today = new Date();
today.setHours(0, 0, 0, 0);
const todayRecords = records?.filter(r => 
    r.last_reviewed && new Date(r.last_reviewed) >= today
) || [];

const target = 10; // æ¯æ—¥ç›®æ ‡å•è¯æ•°
const todayProgress = Math.min(todayRecords.length, target);
const progressPercent = (todayProgress / target) * 100;

const todayStatus = document.getElementById('today-status');
todayStatus.innerHTML = `
    <div class="stats-card">
        <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
        <div class="card-grid">
            <div class="stat-card" onclick="showTodayWords()" style="cursor: pointer;">
                <div class="number" style="color: #2196F3; text-decoration: underline;">${todayRecords.length}</div>
                <div class="label">ä»Šæ—¥å·²å­¦</div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹</div>
            </div>
            
            <div class="stat-card">
                <div class="number">${Math.max(0, target - todayRecords.length)}</div>
                <div class="label">å»ºè®®å­¦ä¹ </div>
            </div>
            
            <div class="stat-card" onclick="showTodayMasteredWords()" style="cursor: pointer;">
                <div class="number" style="color: #4CAF50; text-decoration: underline;">${todayRecords.filter(r => r.status === 'mastered').length}</div>
                <div class="label">ä»Šæ—¥æŒæ¡</div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹</div>
            </div>
        </div>

                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayProgress}/${target}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                ${todayRecords.length >= target ? 
                    '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : 
                    '<p style="color: #FF9800; text-align: center; margin-top: 15px;">ğŸ’ª ç»§ç»­åŠªåŠ›ï¼</p>'}
            </div>
        `;
        
// å­¦ä¹ è¿›åº¦
const total = records?.length || 0;
const mastered = records?.filter(r => r.status === 'mastered').length || 0;
const learning = records?.filter(r => r.status === 'learning').length || 0;
const review = records?.filter(r => r.status === 'new').length || 0;
const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;

// è®¡ç®—æœªå­¦ä¹ å•è¯
const unlearnedWords = records?.filter(r => 
    r.status === 'new' && !r.last_reviewed
) || [];
const unlearned = unlearnedWords.length;

const progressSummary = document.getElementById('my-progress-summary');
progressSummary.innerHTML = `
    <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
    <div class="card-grid">
        <div class="stat-card">
            <div class="number">${total}</div>
            <div class="label">å•è¯æ€»æ•°</div>
        </div>
        
        <div class="stat-card" onclick="showMasteredWords()" style="cursor: pointer;">
            <div class="number" style="color: #4CAF50; text-decoration: underline;">${mastered}</div>
            <div class="label">å·²æŒæ¡</div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹</div>
        </div>
        
        <div class="stat-card" onclick="showLearningWords()" style="cursor: pointer;">
            <div class="number" style="color: #FF9800; text-decoration: underline;">${learning}</div>
            <div class="label">ç†Ÿæ‚‰</div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹</div>
        </div>
        
        <div class="stat-card" onclick="showNewLearnedWords()" style="cursor: pointer;">
            <div class="number" style="color: #F44336; text-decoration: underline;">${review}</div>
            <div class="label">æ²¡å°è±¡</div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹</div>
        </div>
        
        <div class="stat-card" onclick="showUnlearnedWords()" style="cursor: pointer;">
            <div class="number" style="color: #9C27B0; text-decoration: underline;">${unlearned}</div>
            <div class="label">æœªå­¦ä¹ </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹</div>
        </div>
    </div>            </div>
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>
        `;
        
        // åˆ†ç»„è¯¦æƒ…
        const { data: studentGroups } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', appState.currentUser);
        
        let groupDetails = '';
        if (studentGroups && studentGroups.length > 0) {
            const groupIds = studentGroups.map(g => g.group_id);
            const { data: groups } = await dbClient
                .from('groups')
                .select('id, name')
                .in('id', groupIds);
            
            for (const group of groups || []) {
                const { data: groupWords } = await dbClient
                    .from('words')
                    .select('count')
                    .eq('group_id', group.id);
                
                const { data: myGroupRecords } = await dbClient
                    .from('study_records')
                    .select('count')
                    .eq('student_id', appState.currentUser)
                    .eq('group_id', group.id);
                
                groupDetails += `
                    <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${group.name}</div>
                        <div style="color: #666; font-size: 14px;">
                            åˆ†ç»„å•è¯: ${groupWords?.[0]?.count || 0} | 
                            æˆ‘çš„å•è¯: ${myGroupRecords?.[0]?.count || 0}
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('group-details').innerHTML = groupDetails ? `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š æˆ‘çš„åˆ†ç»„è¯¦æƒ…</h3>
                ${groupDetails}
            </div>
        ` : `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š åˆ†ç»„çŠ¶æ€</h3>
                <p style="color: #FF9800; text-align: center;">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„</p>
                <p style="color: #666; text-align: center; font-size: 14px;">è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

async function manualSyncWords() {
    try {
        showAlert('æ­£åœ¨åŒæ­¥å•è¯...', 'info');
        const syncedCount = await syncGroupWordsToStudent(appState.currentUser);
        
        if (syncedCount > 0) {
            showAlert(`åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥ ${syncedCount} ä¸ªæ–°å•è¯`, 'success');
        } else {
            showAlert('æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
        }
        
        await loadStudentDashboardSimple();
        
    } catch (error) {
        console.error('æ‰‹åŠ¨åŒæ­¥é”™è¯¯:', error);
        showAlert('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
    }
}

function showTrainingOptions() {
    showScreen('training-options-screen');
    loadTrainingOptions();
}

// åŠ è½½è®­ç»ƒé€‰é¡¹
async function loadTrainingOptions() {
    const optionsDiv = document.getElementById('daily-training-options');
    
    // æ£€æŸ¥ä»Šæ—¥è®­ç»ƒçŠ¶æ€
    const today = new Date().toDateString();
    const storedDate = localStorage.getItem(`kathy_daily_date_${appState.currentUser}`);
    const todayProgress = parseInt(localStorage.getItem(`kathy_daily_progress_${appState.currentUser}`)) || 0;
    
    if (storedDate === today && todayProgress >= 10) {
        // ä»Šæ—¥å·²å®Œæˆè®­ç»ƒï¼Œæä¾›ç»§ç»­é€‰é¡¹
        optionsDiv.innerHTML = `
            <div class="continue-options">
                <h4 style="color: #1565C0; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥è®­ç»ƒ</h4>
                <p style="color: #666; margin-bottom: 20px;">æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn" onclick="startNewDailyTraining()" 
                            style="padding: 20px; font-size: 16px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ†•</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">æ–°å•è¯è®­ç»ƒ</div>
                        <div style="color: #666; font-size: 14px;">å­¦ä¹ æ–°çš„å•è¯</div>
                    </button>
                    
                    <button class="btn btn-blue" onclick="continueReviewTraining()" 
                            style="padding: 20px; font-size: 16px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">ç»§ç»­å¤ä¹ </div>
                        <div style="color: #666; font-size: 14px;">å¤ä¹ ä»Šæ—¥å­¦è¿‡çš„å•è¯</div>
                    </button>
                </div>
                <p style="color: #4CAF50; text-align: center; margin-top: 15px; font-weight: bold;">
                    ğŸ‰ å¤ªæ£’äº†ï¼æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€ä»»åŠ¡ï¼
                </p>
            </div>
        `;
    } else {
        // ä»Šæ—¥æœªå®Œæˆè®­ç»ƒ
        optionsDiv.innerHTML = `
            <button class="btn btn-blue" onclick="startDailyTraining()" 
                    style="width: 100%; padding: 25px; font-size: 18px; margin-bottom: 15px;">
                <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“…</div>
                <div style="font-weight: bold; margin-bottom: 5px;">ä»Šæ—¥è®­ç»ƒ</div>
                <div style="color: #666; font-size: 14px;">æ¯å¤©10ä¸ªå•è¯ï¼Œç§‘å­¦è®°å¿†</div>
                ${todayProgress > 0 ? `<div style="color: #4CAF50; margin-top: 5px;">ä»Šæ—¥è¿›åº¦: ${todayProgress}/10</div>` : ''}
            </button>
        `;
    }
}

function startNewDailyTraining() {
    // é‡ç½®ä»Šæ—¥è®­ç»ƒçŠ¶æ€
    localStorage.setItem(`kathy_daily_progress_${appState.currentUser}`, '0');
    startDailyTraining();
}

function continueReviewTraining() {
    // ä»ä»Šæ—¥å­¦è¿‡çš„å•è¯ä¸­é€‰æ‹©å¤ä¹ 
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayWords = appState.userWords.filter(word => 
        word.last_reviewed && new Date(word.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        startNewDailyTraining();
        return;
    }
    
    // ä¼˜å…ˆå¤ä¹ ä»Šå¤©ç†Ÿæ‚‰æˆ–æœªæŒæ¡çš„å•è¯
    const reviewWords = todayWords.sort((a, b) => {
        // æœªæŒæ¡ä¼˜å…ˆ
        if (a.status === 'new' && b.status !== 'new') return -1;
        if (a.status !== 'new' && b.status === 'new') return 1;
        if (a.status === 'learning' && b.status === 'mastered') return -1;
        if (a.status === 'mastered' && b.status === 'learning') return 1;
        
        // å¤ä¹ æ¬¡æ•°å°‘çš„ä¼˜å…ˆ
        return (a.review_count || 0) - (b.review_count || 0);
    }).slice(0, 10);
    
    if (reviewWords.length === 0) {
        showAlert('ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯', 'info');
        startNewDailyTraining();
        return;
    }
    
    reviewWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = reviewWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startAllWordsTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    // åŠ è½½ä¿å­˜çš„è®­ç»ƒè¿›åº¦
    const savedProgress = localStorage.getItem(`kathy_all_training_${appState.currentUser}`);
    let startIndex = 0;
    
    if (savedProgress) {
        try {
            const progress = JSON.parse(savedProgress);
            const today = new Date().toDateString();
            if (progress.date === today && progress.index > 0) {
                const continueTraining = confirm(`å‘ç°ä¸Šæ¬¡çš„è®­ç»ƒè¿›åº¦ï¼ˆ${progress.index}/${progress.total}ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`);
                if (continueTraining) {
                    startIndex = progress.index;
                }
            }
        } catch (e) {
            console.error('è§£æè®­ç»ƒè¿›åº¦é”™è¯¯:', e);
        }
    }
    
    appState.trainingWords = [...appState.userWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = startIndex;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startDailyTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const todayProgress = appState.dailyTrainingProgress || 0;
    const target = 10;
    
    // å¦‚æœä»Šæ—¥å·²å®ŒæˆåŸºç¡€è®­ç»ƒï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
    if (todayProgress >= target) {
        const continueTraining = confirm(`æ‚¨ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayProgress} ä¸ªå•è¯ï¼æ˜¯å¦ç»§ç»­å­¦ä¹ æ›´å¤šå•è¯ï¼Ÿ`);
        if (!continueTraining) {
            showAlert('æ‚¨å·²ç»å®Œæˆä»Šæ—¥åŸºç¡€è®­ç»ƒï¼Œå¾ˆæ£’ï¼', 'success');
            return;
        }
    }
    
    // æ™ºèƒ½é€‰æ‹©ä»Šæ—¥å•è¯
    const newWords = appState.userWords.filter(w => w.status === 'new');
    const learningWords = appState.userWords.filter(w => w.status === 'learning');
    const masteredWords = appState.userWords.filter(w => w.status === 'mastered');
    
    let dailyWords = [];
    const wordsNeeded = Math.max(5, target - todayProgress);
    
    // ä¼˜å…ˆé€‰æ‹©æ–°å•è¯ï¼ˆ50%ï¼‰
    if (newWords.length > 0) {
        const newCount = Math.min(Math.ceil(wordsNeeded * 0.5), newWords.length);
        dailyWords = dailyWords.concat(newWords.slice(0, newCount));
    }
    
    // å…¶æ¬¡æ˜¯ç†Ÿæ‚‰å•è¯ï¼ˆ30%ï¼‰
    if (learningWords.length > 0 && dailyWords.length < wordsNeeded) {
        const learningCount = Math.min(Math.ceil(wordsNeeded * 0.3), learningWords.length);
        dailyWords = dailyWords.concat(learningWords.slice(0, learningCount));
    }
    
    // æœ€åæ˜¯å·²æŒæ¡å•è¯éœ€è¦å¤ä¹ çš„ï¼ˆ20%ï¼‰
    if (masteredWords.length > 0 && dailyWords.length < wordsNeeded) {
        const reviewCount = wordsNeeded - dailyWords.length;
        // é€‰æ‹©å¤ä¹ æ¬¡æ•°æœ€å°‘æˆ–æœ€ä¹…æ²¡å¤ä¹ çš„å•è¯
        const sortedMastered = masteredWords.sort((a, b) => {
            const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
            const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
            return aDate - bDate;
        });
        dailyWords = dailyWords.concat(sortedMastered.slice(0, reviewCount));
    }
    
    // å¦‚æœè¿˜ä¸å¤Ÿï¼Œéšæœºè¡¥å……
    if (dailyWords.length < wordsNeeded) {
        const allWords = [...appState.userWords];
        const remaining = wordsNeeded - dailyWords.length;
        const usedIds = new Set(dailyWords.map(w => w.id || w.word_id));
        
        for (let i = 0; i < allWords.length && dailyWords.length < wordsNeeded; i++) {
            const word = allWords[i];
            if (!usedIds.has(word.id || word.word_id)) {
                dailyWords.push(word);
            }
        }
    }
    
    dailyWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = dailyWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startReviewTraining() {
    if (appState.userWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å•è¯å¯ä»¥å­¦ä¹ ', 'error');
        return;
    }
    
    const weakWords = appState.userWords.filter(w => w.status === 'new' || w.status === 'learning');
    
    if (weakWords.length === 0) {
        showAlert('ğŸ‰ å¤ªæ£’äº†ï¼æ²¡æœ‰éœ€è¦å¤ä¹ çš„å¼±é¡¹å•è¯ï¼', 'success');
        return;
    }
    
    weakWords.sort(() => Math.random() - 0.5);
    appState.trainingWords = weakWords;
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

function startTrainingSession() {
    showScreen('training-screen');
    showTrainingScreenSimple();
}

// ç®€æ´ç‰ˆè®­ç»ƒç•Œé¢
function showTrainingScreenSimple() {
    if (appState.currentWordIndex >= appState.trainingWords.length) {
        finishTraining();
        return;
    }
    
    const word = appState.trainingWords[appState.currentWordIndex];
    const total = appState.trainingWords.length;
    const current = appState.currentWordIndex + 1;
    
    document.getElementById('training-progress').textContent = `${current}/${total}`;
    
    // æ™ºèƒ½è°ƒæ•´å­—ä½“å¤§å°
    const englishFontSize = getFontSizeClass(word.english);
    const chineseFontSize = getFontSizeClass(word.chinese);
    
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center;">
            <!-- å•è¯å¡ç‰‡ -->
            <div class="word-card ${appState.isCardFlipped ? 'flipped' : ''}" onclick="flipTrainingCard()">
                <div class="word-card-content ${appState.isCardFlipped ? chineseFontSize : englishFontSize}">
                    ${appState.isCardFlipped ? `
                        <div style="color: #2E7D32; word-break: break-word;">
                            ${word.chinese}
                        </div>
                    ` : `
                        <div style="color: #333; word-break: break-word;">
                            ${word.english}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- çŠ¶æ€æŒ‰é’® -->
            <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn" onclick="markTrainingWord('mastered')" 
                        style="padding: 15px; background: #4CAF50;">
                    <div style="font-size: 20px; margin-bottom: 5px;">âœ…</div>
                    <div>å·²æŒæ¡</div>
                </button>
                
                <button class="btn btn-blue" onclick="markTrainingWord('learning')" 
                        style="padding: 15px; background: #2196F3;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ”„</div>
                    <div>ç†Ÿæ‚‰</div>
                </button>
                
                <button class="btn" onclick="markTrainingWord('new')" 
                        style="padding: 15px; background: #FF9800;">
                    <div style="font-size: 20px; margin-bottom: 5px;">ğŸ“</div>
                    <div>æ²¡å°è±¡</div>
                </button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn" onclick="skipTrainingWord()" 
                        style="flex: 1; padding: 12px; background: #9E9E9E;">
                    <div>â­ï¸ è·³è¿‡</div>
                </button>
                
                <button class="btn" onclick="saveTrainingProgress()" 
                        style="flex: 1; padding: 12px; background: #607D8B;">
                    <div>ğŸ’¾ ä¿å­˜è¿›åº¦</div>
                </button>
                
                <button class="btn" onclick="showStudentDashboard()" 
                        style="flex: 1; padding: 12px; background: #795548;">
                    <div>ğŸ“‹ è¿”å›</div>
                </button>
            </div>
            
            <div style="margin-top: 20px; color: #666; font-size: 14px;">
                <p>ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€</p>
                <p>é€‰æ‹©é€‚å½“çš„æŒæ¡ç¨‹åº¦</p>
            </div>
        </div>
    `;
}

// ä¿å­˜è®­ç»ƒè¿›åº¦
function saveTrainingProgress() {
    if (appState.trainingWords.length === 0) return;
    
    const progress = {
        date: new Date().toDateString(),
        index: appState.currentWordIndex,
        total: appState.trainingWords.length,
        words: appState.trainingWords.map(w => w.id || w.word_id)
    };
    
    localStorage.setItem(`kathy_all_training_${appState.currentUser}`, JSON.stringify(progress));
    showAlert('è®­ç»ƒè¿›åº¦å·²ä¿å­˜ï¼', 'success');
}

function flipTrainingCard() {
    const word = appState.trainingWords[appState.currentWordIndex];
    const card = document.querySelector('.word-card');
    const content = card.querySelector('.word-card-content');
    
    if (appState.isCardFlipped) {
        card.classList.remove('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.english);
        content.innerHTML = `
            <div style="color: #333; word-break: break-word;">
                ${word.english}
            </div>
        `;
    } else {
        card.classList.add('flipped');
        content.className = 'word-card-content ' + getFontSizeClass(word.chinese);
        content.innerHTML = `
            <div style="color: #2E7D32; word-break: break-word;">
                ${word.chinese}
            </div>
        `;
    }
    
    appState.isCardFlipped = !appState.isCardFlipped;
}

// ==================== ä¿®å¤è®­ç»ƒåŠŸèƒ½ ====================
async function markTrainingWord(status) {
    const word = appState.trainingWords[appState.currentWordIndex];
    
    try {
        // æ›´æ–°æ•°æ®åº“è®°å½•
        const { error } = await dbClient
            .from('study_records')
            .update({
                status: status,
                review_count: (word.review_count || 0) + 1,
                last_reviewed: new Date().toISOString()
            })
            .eq('student_id', appState.currentUser)
            .eq('word_id', word.word_id || word.id);
        
        if (error) throw error;
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        word.status = status;
        word.review_count = (word.review_count || 0) + 1;
        word.last_reviewed = new Date().toISOString();
        
        // ç«‹å³æ›´æ–°å…¨å±€çŠ¶æ€
        const globalIndex = appState.userWords.findIndex(w => 
            w.word_id === word.word_id || w.id === word.id
        );
        if (globalIndex !== -1) {
            appState.userWords[globalIndex] = { ...appState.userWords[globalIndex], ...word };
        }
        
        // æ›´æ–°ä»Šæ—¥è®­ç»ƒè¿›åº¦ï¼ˆä»…é™æ¯æ—¥è®­ç»ƒï¼‰
        if (status !== 'skip') {
            saveDailyTrainingProgress(1);
        }
        
        // æ˜¾ç¤ºåé¦ˆ
        const statusText = {
            'mastered': 'âœ… å·²æŒæ¡',
            'learning': 'ğŸ”„ ç†Ÿæ‚‰',
            'new': 'ğŸ“ æ²¡å°è±¡'
        }[status];
        
        showAlert(`${statusText}: ${word.english}`, 'success');
        
        // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
        setTimeout(() => {
            appState.currentWordIndex++;
            appState.isCardFlipped = false;
            
            if (appState.currentWordIndex < appState.trainingWords.length) {
                showTrainingScreenSimple();
            } else {
                finishTraining();
            }
        }, 800);
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯çŠ¶æ€é”™è¯¯:', error);
        showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

function skipTrainingWord() {
    appState.currentWordIndex++;
    appState.isCardFlipped = false;
    
    if (appState.currentWordIndex < appState.trainingWords.length) {
        showTrainingScreenSimple();
    } else {
        finishTraining();
    }
}

function finishTraining() {
    const total = appState.trainingWords.length;
    const mastered = appState.trainingWords.filter(w => w.status === 'mastered').length;
    const learning = appState.trainingWords.filter(w => w.status === 'learning').length;
    const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;
    
    // è®°å½•æ‰“å¡
    recordClockInAfterTraining();
    
    // æ¸…é™¤è®­ç»ƒè¿›åº¦
    localStorage.removeItem(`kathy_all_training_${appState.currentUser}`);
    
    // æ›´æ–°å­¦ç”Ÿé¢æ¿æ•°æ®
    loadStudentDashboardSimple();
    
    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
    const content = document.getElementById('training-content');
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‰</div>
            <h3 style="color: #333; margin-bottom: 15px;">è®­ç»ƒå®Œæˆï¼</h3>
            <div class="stats-card" style="max-width: 400px; margin: 0 auto;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">è®­ç»ƒå•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">ç†Ÿæ‚‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progress}%</div>
                        <div class="label">æŒæ¡ç‡</div>
                    </div>
                </div>
            </div>
            ${appState.dailyTrainingProgress >= 10 ? 
                '<div class="celebration-banner" style="margin: 20px auto; max-width: 400px;">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : ''}
            <div style="margin-top: 30px;">
                <button class="btn" onclick="startDailyTraining()" style="margin: 10px;">
                    ç»§ç»­ä»Šæ—¥è®­ç»ƒ
                </button>
                <button class="btn btn-red" onclick="showStudentDashboard()" style="margin: 10px;">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
}

function cancelTraining() {
    if (confirm('ç¡®å®šè¦ç»“æŸè®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„è®­ç»ƒè¿›åº¦å¯ä»¥ç¨åç»§ç»­ã€‚')) {
        saveTrainingProgress();
        showStudentDashboard();
    }
}

function showMyAchievementsPage() {
    showScreen('student-achievements-screen');
    loadStudentAchievements();
}

async function loadStudentAchievements() {
    const total = appState.userWords.length;
    const mastered = appState.userWords.filter(w => w.status === 'mastered').length;
    const totalReviews = appState.userWords.reduce((sum, word) => sum + (word.review_count || 0), 0);
    
    let consecutiveDays = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const dates = appState.userWords
        .map(w => w.last_reviewed ? new Date(w.last_reviewed).setHours(0, 0, 0, 0) : null)
        .filter(date => date)
        .sort((a, b) => b - a);
    
    if (dates.length > 0) {
        let currentDate = today.getTime();
        for (let i = 0; i < dates.length; i++) {
            if (dates[i] === currentDate) {
                consecutiveDays++;
                currentDate -= 24 * 60 * 60 * 1000;
            } else {
                break;
            }
        }
    }
    
    const achievements = [];
    if (total >= 100) achievements.push('ğŸ† å•è¯å¤§å¸ˆï¼šå­¦ä¹ 100ä¸ªå•è¯');
    else if (total >= 50) achievements.push('â­ å•è¯èƒ½æ‰‹ï¼šå­¦ä¹ 50ä¸ªå•è¯');
    else if (total >= 10) achievements.push('âœ… å•è¯æ–°æ‰‹ï¼šå­¦ä¹ 10ä¸ªå•è¯');
    
    if (mastered >= 50) achievements.push('ğŸ¯ æŒæ¡å¤§å¸ˆï¼šæŒæ¡50ä¸ªå•è¯');
    else if (mastered >= 20) achievements.push('ğŸ“š æŒæ¡èƒ½æ‰‹ï¼šæŒæ¡20ä¸ªå•è¯');
    
    if (totalReviews >= 100) achievements.push('ğŸ”„ å¤ä¹ è¾¾äººï¼šæ€»å¤ä¹ 100æ¬¡');
    else if (totalReviews >= 50) achievements.push('ğŸ“– å¤ä¹ èƒ½æ‰‹ï¼šæ€»å¤ä¹ 50æ¬¡');
    
    if (consecutiveDays >= 7) achievements.push('ğŸ”¥ åšæŒä¹‹æ˜Ÿï¼šè¿ç»­å­¦ä¹ 7å¤©');
    else if (consecutiveDays >= 3) achievements.push('ğŸ’ª åšæŒèƒ½æ‰‹ï¼šè¿ç»­å­¦ä¹ 3å¤©');
    
    const content = document.getElementById('achievements-content');
    content.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ† æˆ‘çš„å­¦ä¹ æˆå°±</h3>
            
            <div class="stats-card">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">å•è¯æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${totalReviews}</div>
                        <div class="label">æ€»å¤ä¹ æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${consecutiveDays}</div>
                        <div class="label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-card" style="margin-top: 30px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ–ï¸ å·²è·å¾—æˆå°±</h4>
                ${achievements.length > 0 ? `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${achievements.map(achievement => `
                            <div style="background: #FFF3CD; border: 2px solid #FFC107; border-radius: 8px; padding: 10px 15px; display: inline-block;">
                                ${achievement}
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <p style="color: #666; text-align: center;">è¿˜æ²¡æœ‰è·å¾—æˆå°±ï¼Œç»§ç»­åŠªåŠ›ï¼</p>
                `}
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    `;
}

function showMyWordListPage() {
    showScreen('student-wordlist-screen');
    loadStudentWordList();
}

async function loadStudentWordList() {
    try {
        const { data: records, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .order('last_reviewed', { ascending: false });
        
        if (error) throw error;
        
        appState.userWords = records || [];
        
        const content = document.getElementById('wordlist-content');
        
        if (!records || records.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å•è¯</h3>
                    <p style="color: #999;">ç­‰å¾…æ•™å¸ˆä¸Šä¼ å•è¯</p>
                </div>
            `;
            return;
        }
        
        const total = records.length;
        const mastered = records.filter(r => r.status === 'mastered').length;
        const learning = records.filter(r => r.status === 'learning').length;
        const review = records.filter(r => r.status === 'new').length;
        
        let html = `
            <div style="margin-bottom: 20px;">
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${total}</div>
                        <div class="label">å•è¯æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mastered}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${learning}</div>
                        <div class="label">ç†Ÿæ‚‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${review}</div>
                        <div class="label">æ²¡å°è±¡</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <select id="word-filter" style="padding: 10px; border-radius: 5px; border: 2px solid #ddd; font-size: 16px;" onchange="filterMyWords()">
                    <option value="all">æ‰€æœ‰å•è¯</option>
                    <option value="mastered">å·²æŒæ¡</option>
                    <option value="learning">ç†Ÿæ‚‰</option>
                    <option value="new">æ²¡å°è±¡</option>
                    <option value="recent">æœ€è¿‘å­¦ä¹ </option>
                </select>
                <input type="text" id="word-search" placeholder="ğŸ” æœç´¢å•è¯..." 
                       style="padding: 10px; border-radius: 5px; border: 2px solid #ddd; font-size: 16px; margin-left: 10px;"
                       oninput="filterMyWords()">
            </div>
            
            <div style="overflow-x: auto; max-height: 500px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>çŠ¶æ€</th>
                            <th>å¤ä¹ æ¬¡æ•°</th>
                            <th>æœ€åå¤ä¹ </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="words-table-body">
        `;
        
        records.forEach(record => {
            let statusText, statusColor;
            switch(record.status) {
                case 'mastered': statusText = 'âœ… å·²æŒæ¡'; statusColor = '#4CAF50'; break;
                case 'learning': statusText = 'ğŸ”„ ç†Ÿæ‚‰'; statusColor = '#FF9800'; break;
                default: statusText = 'ğŸ“ æ²¡å°è±¡'; statusColor = '#666';
            }
            
            const lastReview = record.last_reviewed ? 
                new Date(record.last_reviewed).toLocaleDateString('zh-CN') : 'ä»æœª';
            
            html += `
                <tr data-status="${record.status}" data-english="${record.english.toLowerCase()}" data-chinese="${record.chinese}">
                    <td><strong>${record.english}</strong></td>
                    <td>${record.chinese}</td>
                    <td style="color: ${statusColor};">${statusText}</td>
                    <td>${record.review_count || 0}</td>
                    <td>${lastReview}</td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                onclick="practiceSingleWord('${record.english}', '${record.chinese}')">ç»ƒä¹ </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-red" onclick="showStudentDashboard()">
                    <span>ğŸ”™ è¿”å›ä¸»é¡µ</span>
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å•è¯åˆ—è¡¨é”™è¯¯:', error);
        document.getElementById('wordlist-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function filterMyWords() {
    const filter = document.getElementById('word-filter').value;
    const search = document.getElementById('word-search').value.toLowerCase();
    const rows = document.querySelectorAll('#words-table-body tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const english = row.getAttribute('data-english');
        const chinese = row.getAttribute('data-chinese');
        
        let statusMatch = true;
        if (filter !== 'all') {
            statusMatch = (filter === status) || 
                         (filter === 'recent' && row.cells[4].textContent !== 'ä»æœª');
        }
        
        const searchMatch = !search || 
                           english.includes(search) || 
                           chinese.includes(search);
        
        row.style.display = (statusMatch && searchMatch) ? '' : 'none';
    });
}

function practiceSingleWord(english, chinese) {
    appState.trainingWords = [{ english, chinese, status: 'new' }];
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    startTrainingSession();
}

function showTodayWordsPage() {
    showScreen('student-today-screen');
    loadTodayWordsPage();
}

function loadTodayWordsPage() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayWords = appState.userWords.filter(word => 
        word.last_reviewed && new Date(word.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        document.getElementById('today-content').innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“…</div>
                <h3 style="color: #333; margin-bottom: 15px;">ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ å•è¯</h3>
                <p style="color: #666; margin-bottom: 20px;">å¿«å»å¼€å§‹ä»Šæ—¥è®­ç»ƒå§ï¼</p>
                <button class="btn btn-blue" onclick="startDailyTraining()" style="margin: 10px;">
                    å¼€å§‹ä»Šæ—¥è®­ç»ƒ
                </button>
                <button class="btn" onclick="showStudentDashboard()" style="margin: 10px;">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        `;
        return;
    }
    
    const content = document.getElementById('today-content');
    let html = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“… ä»Šæ—¥å·²å­¦ä¹ å•è¯</h3>
            <p style="color: #666; margin-bottom: 20px;">ä»Šå¤©å·²ç»å­¦ä¹ äº† ${todayWords.length} ä¸ªå•è¯ï¼š</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
    `;
    
    todayWords.forEach(word => {
        html += `
            <div style="background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; text-align: center;">
                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px; word-break: break-word;">${word.english}</div>
                <div style="color: #2E7D32; font-size: 1.2em; word-break: break-word;">${word.chinese}</div>
                <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                    ${word.status === 'mastered' ? 'âœ… å·²æŒæ¡' : word.status === 'learning' ? 'ğŸ”„ ç†Ÿæ‚‰' : 'ğŸ“ æ²¡å°è±¡'}
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-blue" onclick="startDailyTraining()">ç»§ç»­ä»Šæ—¥å­¦ä¹ </button>
                <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        appState.currentUser = null;
        appState.isTeacher = false;
        appState.userId = null;
        appState.userWords = [];
        appState.trainingWords = [];
        appState.selectedGroupId = null;
        appState.selectedWords = [];
        appState.dailyTrainingProgress = 0;
        appState.lastTrainingDate = null;
        
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
    }
}
// ========== å•è¯åˆ†ç±»æŸ¥çœ‹å‡½æ•° ==========

// æ˜¾ç¤ºä»Šæ—¥å·²å­¦å•è¯
function showTodayWords() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayWords = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        return;
    }
    
    showWordListPage('ğŸ“… ä»Šæ—¥å·²å­¦å•è¯', todayWords);
}

// æ˜¾ç¤ºä»Šæ—¥å·²æŒæ¡å•è¯
function showTodayMasteredWords() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayMastered = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today && w.status === 'mastered'
    );
    
    if (todayMastered.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰æŒæ¡ä»»ä½•å•è¯', 'info');
        return;
    }
    
    showWordListPage('âœ… ä»Šæ—¥å·²æŒæ¡å•è¯', todayMastered);
}

// æ˜¾ç¤ºå·²æŒæ¡å•è¯
function showMasteredWords() {
    const masteredWords = appState.userWords.filter(w => w.status === 'mastered');
    
    if (masteredWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰å·²æŒæ¡çš„å•è¯', 'info');
        return;
    }
    
    showWordListPage('âœ… å·²æŒæ¡å•è¯', masteredWords);
}

// æ˜¾ç¤ºç†Ÿæ‚‰å•è¯
function showLearningWords() {
    const learningWords = appState.userWords.filter(w => w.status === 'learning');
    
    if (learningWords.length === 0) {
        showAlert('è¿˜æ²¡æœ‰ç†Ÿæ‚‰çš„å•è¯', 'info');
        return;
    }
    
    showWordListPage('ğŸ”„ ç†Ÿæ‚‰å•è¯', learningWords);
}

// æ˜¾ç¤ºæ²¡å°è±¡å•è¯
function showNewLearnedWords() {
    const newLearnedWords = appState.userWords.filter(w => 
        w.status === 'new' && w.last_reviewed
    );
    
    if (newLearnedWords.length === 0) {
        showAlert('æ²¡æœ‰æ²¡å°è±¡çš„å•è¯', 'info');
        return;
    }
    
    showWordListPage('ğŸ“ æ²¡å°è±¡å•è¯', newLearnedWords);
}

// æ˜¾ç¤ºæœªå­¦ä¹ å•è¯
function showUnlearnedWords() {
    const unlearnedWords = appState.userWords.filter(w => 
        w.status === 'new' && !w.last_reviewed
    );
    
    if (unlearnedWords.length === 0) {
        showAlert('æ‰€æœ‰å•è¯éƒ½å·²å­¦ä¹ è¿‡', 'info');
        return;
    }
    
    showWordListPage('ğŸ“š æœªå­¦ä¹ å•è¯', unlearnedWords);
}

// é€šç”¨å•è¯åˆ—è¡¨æ˜¾ç¤ºå‡½æ•°
function showWordListPage(title, words) {
    // æ˜¾ç¤ºå•è¯åˆ—è¡¨é¡µé¢
    showScreen('word-categories-screen');
    
    const content = document.getElementById('category-words-content');
    
    // æŒ‰æœ€åå¤ä¹ æ—¶é—´æ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
    words.sort((a, b) => {
        const aDate = a.last_reviewed ? new Date(a.last_reviewed) : new Date(0);
        const bDate = b.last_reviewed ? new Date(b.last_reviewed) : new Date(0);
        return bDate - aDate;
    });
    
    let html = `
        <div class="stats-card">
            <h3 style="color: #333; margin-bottom: 10px;">${title}</h3>
            <p style="color: #666; margin-bottom: 20px;">å…± ${words.length} ä¸ªå•è¯</p>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            ${title.includes('æœªå­¦ä¹ ') ? '' : '<th>æœ€åå¤ä¹ </th><th>å¤ä¹ æ¬¡æ•°</th>'}
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    words.forEach(word => {
        const lastReview = word.last_reviewed ? 
            new Date(word.last_reviewed).toLocaleString('zh-CN') : 'ä»æœª';
        
        html += `
            <tr>
                <td><strong>${word.english}</strong></td>
                <td>${word.chinese}</td>
                ${title.includes('æœªå­¦ä¹ ') ? '' : 
                    `<td>${lastReview}</td>
                     <td>${word.review_count || 0}</td>`}
                <td>
                    <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                            onclick="practiceSingleWord('${word.english.replace(/'/g, "\\'")}', '${word.chinese.replace(/'/g, "\\'")}')">
                        ${title.includes('æœªå­¦ä¹ ') ? 'å¼€å§‹å­¦ä¹ ' : 'ç»ƒä¹ '}
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                ${title.includes('ä»Šæ—¥å·²å­¦') ? 
                    `<button class="btn" onclick="reviewTodayWords()" style="margin-right: 10px;">
                        ğŸ”„ å¤ä¹ è¿™äº›å•è¯
                    </button>` : ''}
                ${title.includes('æœªå­¦ä¹ ') ? 
                    `<button class="btn" onclick="learnUnlearnedWords()" style="margin-right: 10px;">
                        ğŸ“š å­¦ä¹ è¿™äº›å•è¯
                    </button>` : ''}
                <button class="btn" onclick="showStudentDashboard()">
                    ğŸ”™ è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

// å¤ä¹ ä»Šæ—¥å•è¯
function reviewTodayWords() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayWords = appState.userWords.filter(w => 
        w.last_reviewed && new Date(w.last_reviewed) >= today
    );
    
    if (todayWords.length === 0) {
        showAlert('ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯', 'info');
        return;
    }
    
    appState.trainingWords = [...todayWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// å­¦ä¹ æœªå­¦ä¹ å•è¯
function learnUnlearnedWords() {
    const unlearnedWords = appState.userWords.filter(w => 
        w.status === 'new' && !w.last_reviewed
    );
    
    if (unlearnedWords.length === 0) {
        showAlert('æ²¡æœ‰æœªå­¦ä¹ çš„å•è¯', 'info');
        return;
    }
    
    appState.trainingWords = [...unlearnedWords].sort(() => Math.random() - 0.5);
    appState.currentWordIndex = 0;
    appState.isCardFlipped = false;
    
    startTrainingSession();
}

// ========== å•è¯ç®¡ç†å¢å¼ºåŠŸèƒ½ ==========

// åŠ è½½åˆ†ç»„ç­›é€‰é€‰é¡¹
async function loadGroupFilterOptions() {
    try {
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (error) throw error;
        
        const groupFilter = document.getElementById('group-filter');
        if (groupFilter && groups) {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†"æ‰€æœ‰åˆ†ç»„"ï¼‰
            while (groupFilter.options.length > 1) {
                groupFilter.remove(1);
            }
            
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„ç­›é€‰é€‰é¡¹é”™è¯¯:', error);
    }
}

// åº”ç”¨ç­›é€‰
function applyWordFilter() {
    const groupFilter = document.getElementById('group-filter');
    const sortOrder = document.getElementById('sort-order');
    const searchInput = document.getElementById('word-search');
    
    const selectedGroup = groupFilter ? groupFilter.value : 'all';
    const selectedSort = sortOrder ? sortOrder.value : 'created_desc';
    const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
    
    loadWordManagementList(selectedGroup, selectedSort, searchTerm);
}

// ä¿®æ”¹åçš„å•è¯åˆ—è¡¨åŠ è½½å‡½æ•°
async function loadWordManagementList(groupId = 'all', sortOrder = 'created_desc', searchTerm = '') {
    try {
        // æ„å»ºæŸ¥è¯¢
        let query = dbClient
            .from('words')
            .select('*')
            .eq('teacher_id', appState.teacherId);
        
        // åˆ†ç»„ç­›é€‰
        if (groupId && groupId !== 'all') {
            query = query.eq('group_id', groupId);
        }
        
        // æœç´¢ç­›é€‰
        if (searchTerm) {
            // æœç´¢è‹±æ–‡æˆ–ä¸­æ–‡
            query = query.or(`english.ilike.%${searchTerm}%,chinese.ilike.%${searchTerm}%`);
        }
        
        // åº”ç”¨æ’åº
        let sortField = 'created_at';
        let sortDirection = { ascending: false };
        
        switch(sortOrder) {
            case 'created_desc':
                sortField = 'created_at';
                sortDirection = { ascending: false };
                break;
            case 'created_asc':
                sortField = 'created_at';
                sortDirection = { ascending: true };
                break;
            case 'english_asc':
                sortField = 'english';
                sortDirection = { ascending: true };
                break;
            case 'english_desc':
                sortField = 'english';
                sortDirection = { ascending: false };
                break;
            case 'chinese_asc':
                sortField = 'chinese';
                sortDirection = { ascending: true };
                break;
            case 'chinese_desc':
                sortField = 'chinese';
                sortDirection = { ascending: false };
                break;
        }
        
        query = query.order(sortField, sortDirection);
        
        const { data: words, error } = await query;
        
        if (error) throw error;
        
        const content = document.getElementById('word-management-content');
        
        if (!words || words.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">æ²¡æœ‰æ‰¾åˆ°å•è¯</h3>
                    <p style="color: #999;">${searchTerm ? 'æ²¡æœ‰åŒ¹é…çš„å•è¯' : 'è¯·å…ˆä¸Šä¼ å•è¯'}</p>
                </div>
            `;
            return;
        }
        
        // è·å–åˆ†ç»„ä¿¡æ¯ç”¨äºæ˜¾ç¤ºåˆ†ç»„åç§°
        const { data: groups } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId);
        
        const groupMap = {};
        if (groups) {
            groups.forEach(group => {
                groupMap[group.id] = group.name;
            });
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å•è¯ï¼ˆå½“å‰åˆ†ç»„å†…ï¼‰
        const duplicateInfo = {};
        if (groupId && groupId !== 'all') {
            const englishSet = new Set();
            words.forEach(word => {
                const englishLower = word.english.toLowerCase();
                if (englishSet.has(englishLower)) {
                    if (!duplicateInfo[englishLower]) {
                        duplicateInfo[englishLower] = 1;
                    }
                    duplicateInfo[englishLower]++;
                } else {
                    englishSet.add(englishLower);
                }
            });
        }
        
        // ç»Ÿè®¡ä¿¡æ¯
        const statsHtml = `
            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-weight: bold; color: #333;">å…± ${words.length} ä¸ªå•è¯</span>
                        ${groupId && groupId !== 'all' && Object.keys(duplicateInfo).length > 0 ? 
                            `<span style="color: #F44336; margin-left: 15px;">âš ï¸ æœ¬ç»„æœ‰ ${Object.keys(duplicateInfo).length} ä¸ªé‡å¤å•è¯</span>` : ''}
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        ${groupId === 'all' ? 'æ‰€æœ‰åˆ†ç»„' : `å½“å‰åˆ†ç»„: ${groupMap[groupId] || 'æœªçŸ¥'}`} | 
                        æ’åº: ${getSortOrderText(sortOrder)}
                    </div>
                </div>
            </div>
        `;
        
        let html = statsHtml + `
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th>è‹±æ–‡</th>
                            <th>ä¸­æ–‡</th>
                            <th>åˆ†ç»„</th>
                            <th>ä¸Šä¼ æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        words.forEach(word => {
            const uploadTime = new Date(word.created_at).toLocaleDateString('zh-CN') + ' ' + 
                              new Date(word.created_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const groupName = word.group_id ? (groupMap[word.group_id] || 'æœªçŸ¥åˆ†ç»„') : 'æœªåˆ†ç»„';
            const isSelected = appState.selectedWords.includes(word.id);
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤
            const englishLower = word.english.toLowerCase();
            const isDuplicate = duplicateInfo[englishLower] > 1;
            
            html += `
                <tr id="word-row-${word.id}" ${isSelected ? 'style="background-color: #e8f5e9;"' : ''}>
                    <td>
                        <input type="checkbox" class="word-checkbox" value="${word.id}" 
                               onchange="toggleWordSelection('${word.id}', this.checked)"
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>
                        <strong>${word.english}</strong>
                        ${isDuplicate ? '<span style="color: #F44336; margin-left: 5px; font-size: 12px;">(é‡å¤)</span>' : ''}
                    </td>
                    <td>${word.chinese}</td>
                    <td>
                        <div style="display: inline-block; padding: 4px 8px; background: #E3F2FD; border-radius: 4px; font-size: 12px;">
                            ${groupName}
                        </div>
                    </td>
                    <td>${uploadTime}</td>
                    <td>
                        ${isDuplicate ? 
                            '<span style="color: #F44336; font-weight: bold;">âš ï¸ é‡å¤</span>' : 
                            '<span style="color: #4CAF50; font-weight: bold;">âœ“ æ­£å¸¸</span>'}
                    </td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                onclick="editWord('${word.id}', '${word.english}', '${word.chinese}')">ç¼–è¾‘</button>
                        <button class="btn btn-red" style="padding: 6px 12px; font-size: 14px; margin-left: 5px;" 
                                onclick="deleteWord('${word.id}', '${word.english}')">åˆ é™¤</button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        // æ·»åŠ é‡å¤å•è¯æç¤º
        if (Object.keys(duplicateInfo).length > 0) {
            html += `
                <div style="background: #FFF3CD; border: 2px solid #FFC107; border-radius: 10px; padding: 15px; margin-top: 20px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ é‡å¤å•è¯æç¤º</h4>
                    <p style="color: #856404; margin-bottom: 10px;">
                        æœ¬åˆ†ç»„å†…å‘ç°é‡å¤å•è¯ã€‚è™½ç„¶ç»„é—´å¯ä»¥é‡å¤ï¼Œä½†åŒä¸€åˆ†ç»„å†…çš„é‡å¤å•è¯å¯èƒ½ä¼šå½±å“å­¦ä¹ æ•ˆæœã€‚
                    </p>
                    <div style="color: #856404;">
                        <strong>é‡å¤å•è¯ï¼š</strong>
                        ${Object.keys(duplicateInfo).map(word => `${word} (${duplicateInfo[word]}æ¬¡)`).join(', ')}
                    </div>
                    <button class="btn" onclick="removeDuplicateWords('${groupId}')" style="margin-top: 10px; padding: 8px 16px; background: #FF9800; color: white;">
                        ğŸ—‘ï¸ æ¸…ç†é‡å¤å•è¯
                    </button>
                </div>
            `;
        }
        
        content.innerHTML = html;
        updateSelectionCount();
        
        // å¦‚æœæœ‰åˆ†ç»„ï¼Œå¯ç”¨åˆ†ç»„åˆ é™¤æŒ‰é’®
        if (groups && groups.length > 0) {
            document.getElementById('group-delete-btn').disabled = false;
        }
        
    } catch (error) {
        console.error('åŠ è½½å•è¯åº“é”™è¯¯:', error);
        document.getElementById('word-management-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

// è·å–æ’åºæ–¹å¼æ–‡æœ¬
function getSortOrderText(sortOrder) {
    switch(sortOrder) {
        case 'created_desc': return 'ä¸Šä¼ æ—¶é—´ï¼ˆæ–°â†’æ—§ï¼‰';
        case 'created_asc': return 'ä¸Šä¼ æ—¶é—´ï¼ˆæ—§â†’æ–°ï¼‰';
        case 'english_asc': return 'A-Zï¼ˆè‹±æ–‡ï¼‰';
        case 'english_desc': return 'Z-Aï¼ˆè‹±æ–‡ï¼‰';
        case 'chinese_asc': return 'A-Zï¼ˆä¸­æ–‡ï¼‰';
        case 'chinese_desc': return 'Z-Aï¼ˆä¸­æ–‡ï¼‰';
        default: return 'é»˜è®¤æ’åº';
    }
}

// æ¸…ç†é‡å¤å•è¯
async function removeDuplicateWords(groupId) {
    if (!confirm('ç¡®å®šè¦æ¸…ç†é‡å¤å•è¯å—ï¼Ÿ\n\nâš ï¸ è¿™å°†åˆ é™¤åŒä¸€åˆ†ç»„å†…çš„é‡å¤å•è¯ï¼Œåªä¿ç•™æœ€æ—©ä¸Šä¼ çš„é‚£ä¸ªã€‚')) {
        return;
    }
    
    try {
        showAlert('æ­£åœ¨æ¸…ç†é‡å¤å•è¯...', 'info');
        
        // è·å–è¯¥åˆ†ç»„çš„æ‰€æœ‰å•è¯
        const { data: words, error } = await dbClient
            .from('words')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .eq('group_id', groupId)
            .order('created_at', { ascending: true }); // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ—©çš„åœ¨å‰
        
        if (error) throw error;
        
        if (!words || words.length === 0) {
            showAlert('æ²¡æœ‰æ‰¾åˆ°å•è¯', 'info');
            return;
        }
        
        const seenWords = new Set();
        const duplicatesToDelete = [];
        
        // æ‰¾å‡ºé‡å¤çš„å•è¯ï¼ˆä¿ç•™æœ€æ—©çš„ï¼‰
        words.forEach(word => {
            const englishLower = word.english.toLowerCase();
            if (seenWords.has(englishLower)) {
                // è¿™æ˜¯é‡å¤çš„ï¼Œæ ‡è®°ä¸ºåˆ é™¤
                duplicatesToDelete.push(word.id);
            } else {
                seenWords.add(englishLower);
            }
        });
        
        if (duplicatesToDelete.length === 0) {
            showAlert('æ²¡æœ‰å‘ç°é‡å¤å•è¯', 'info');
            return;
        }
        
        // æ‰¹é‡åˆ é™¤é‡å¤å•è¯
        const batchSize = 50;
        let deletedCount = 0;
        
        for (let i = 0; i < duplicatesToDelete.length; i += batchSize) {
            const batch = duplicatesToDelete.slice(i, i + batchSize);
            const { error: deleteError } = await dbClient
                .from('words')
                .delete()
                .in('id', batch);
            
            if (deleteError) {
                console.error('æ‰¹é‡åˆ é™¤é”™è¯¯:', deleteError);
                // å°è¯•é€ä¸ªåˆ é™¤
                for (const wordId of batch) {
                    try {
                        await dbClient
                            .from('words')
                            .delete()
                            .eq('id', wordId);
                        deletedCount++;
                    } catch (err) {
                        console.error('åˆ é™¤å•ä¸ªå•è¯å¤±è´¥:', err);
                    }
                }
            } else {
                deletedCount += batch.length;
            }
        }
        
        showAlert(`âœ… æˆåŠŸæ¸…ç† ${deletedCount} ä¸ªé‡å¤å•è¯`, 'success');
        
        // é‡æ–°åŠ è½½å•è¯åˆ—è¡¨
        const groupFilter = document.getElementById('group-filter');
        const selectedGroup = groupFilter ? groupFilter.value : 'all';
        loadWordManagementList(selectedGroup);
        
    } catch (error) {
        console.error('æ¸…ç†é‡å¤å•è¯é”™è¯¯:', error);
        showAlert(`æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
    }
}

// æœç´¢åŠŸèƒ½ç›‘å¬
function initWordSearch() {
    setTimeout(() => {
        const searchInput = document.getElementById('word-search');
        if (searchInput) {
            // å›è½¦é”®æœç´¢
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    applyWordFilter();
                }
            });
            
            // è¾“å…¥é˜²æŠ–æœç´¢
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyWordFilter();
                }, 500);
            });
        }
    }, 1000);
}

// åœ¨loadWordManagementPageå‡½æ•°æœ«å°¾è°ƒç”¨initWordSearch
// ä¿®æ”¹loadWordManagementPageå‡½æ•°æœ€åä¸€è¡Œ
setTimeout(() => {
    loadGroupFilterOptions();
    initWordSearch();
}, 100);


// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    // ç«‹å³æ˜¾ç¤ºè¿æ¥çŠ¶æ€
    showMessage('login-message', 'æ­£åœ¨è¿æ¥ç³»ç»Ÿ...', 'info');
    
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        // å¦‚æœæ˜¯å·²ä¿å­˜çš„ç”¨æˆ·ï¼Œç›´æ¥æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œç„¶åè‡ªåŠ¨ç™»å½•
        showMessage('login-message', 'æ­£åœ¨æ¢å¤ä¸Šæ¬¡ç™»å½•...', 'warning');
        
        // å»¶è¿Ÿæ‰§è¡Œè‡ªåŠ¨ç™»å½•ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯
        setTimeout(async () => {
            appState.currentUser = savedUser;
            appState.isTeacher = (savedRole === 'teacher');
            appState.userId = savedUser;
            
            try {
                // å¿«é€Ÿæµ‹è¯•è¿æ¥
                const { error } = await dbClient.auth.getSession();
                if (error) {
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥');
                }
                
                showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${savedUser}ï¼`, 'success');
                
                setTimeout(() => {
                    showMessage('login-message', '', 'info');
                    if (appState.isTeacher) {
                        showTeacherDashboard();
                    } else {
                        showStudentDashboard();
                    }
                }, 1000);
                
            } catch (error) {
                showMessage('login-message', `è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
                // æ¸…é™¤ä¿å­˜çš„ç™»å½•çŠ¶æ€
                localStorage.removeItem('kathy_current_user');
                localStorage.removeItem('kathy_user_role');
            }
        }, 1000);
    } else {
        // æ–°ç”¨æˆ·ï¼Œç«‹å³æµ‹è¯•æ•°æ®åº“è¿æ¥
        testDatabase();
    }

    // æ·»åŠ Enteré”®ç™»å½•æ”¯æŒ
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};
    </script>
</body>
</html>
