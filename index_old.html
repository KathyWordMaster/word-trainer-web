<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - æ™ºèƒ½è®°å¿†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ */
        /* ... åŸæœ‰çš„æ‰€æœ‰CSSæ ·å¼ ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTMLç»“æ„ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ -->
        <!-- ... åŸæœ‰çš„æ‰€æœ‰HTMLç»“æ„ ... -->
    </div>

<script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';
const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null,
    
    // æ™ºèƒ½å­¦ä¹ é…ç½®
    dailyTarget: 10,
    consecutiveDays: 0,
    lastStudyDate: null,
    reviewDay: false,
    todayWordsToReview: [],
    
    // è®°å¿†æ›²çº¿é…ç½®
    memoryCurve: [1, 2, 4, 7, 15, 30],
    
    // å­¦ç”Ÿè‡ªä¸»é€‰é¡¹
    studentOptions: {
        extraNewWords: 10,
        extraReviewWords: 15,
        maxDailyWords: 50
    },
    
    // æ–°å¢ï¼šæ•™å¸ˆåŠŸèƒ½çŠ¶æ€
    teacherGroups: [],
    teacherStudents: [],
    teacherWords: [],
    currentGroup: null
};

// ========== è®°å¿†æ›²çº¿ç®—æ³• ==========
class MemoryCurveReview {
    constructor() {
        this.intervals = [1, 2, 4, 7, 15, 30];
    }
    
    shouldReviewToday(word) {
        if (!word.last_reviewed) return true;
        
        const lastReview = new Date(word.last_reviewed);
        const today = new Date();
        const daysSinceReview = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
        const reviewCount = word.review_count || 0;
        
        let interval = 30;
        if (reviewCount < this.intervals.length) {
            interval = this.intervals[reviewCount];
        }
        
        return daysSinceReview >= interval;
    }
    
    calculateMemoryStrength(word) {
        if (!word.last_reviewed) return 0.5;
        
        const lastReview = new Date(word.last_reviewed);
        const today = new Date();
        const daysSinceReview = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
        const reviewCount = word.review_count || 0;
        
        let forgettingRate = 0.56;
        if (reviewCount > 0) {
            forgettingRate = Math.max(0.05, 0.56 / Math.pow(2, reviewCount));
        }
        
        let strength = Math.exp(-forgettingRate * daysSinceReview);
        
        switch(word.status) {
            case 'mastered':
                strength *= 0.9;
                break;
            case 'learning':
                strength *= 0.7;
                break;
            case 'new':
                strength *= 0.5;
                break;
        }
        
        return Math.max(0.1, Math.min(0.95, strength));
    }
    
    getMemoryCurveReminder(word) {
        if (!word.last_reviewed) return "ä»æœªå¤ä¹ ";
        
        const strength = this.calculateMemoryStrength(word);
        const lastReview = new Date(word.last_reviewed);
        const today = new Date();
        const daysSinceReview = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));
        const reviewCount = word.review_count || 0;
        
        let nextReviewIn = this.intervals[reviewCount] || 30;
        let daysToNextReview = Math.max(0, nextReviewIn - daysSinceReview);
        
        if (strength < 0.3) return "è®°å¿†è–„å¼±ï¼Œæ€¥éœ€å¤ä¹ ";
        if (strength < 0.6) return "è®°å¿†ä¸€èˆ¬ï¼Œå»ºè®®å¤ä¹ ";
        if (strength < 0.8) return "è®°å¿†è‰¯å¥½ï¼Œå¯ç¨åå¤ä¹ ";
        return "è®°å¿†ç‰¢å›ºï¼Œæ— éœ€ç«‹å³å¤ä¹ ";
    }
}

const memoryCurve = new MemoryCurveReview();

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
}

function showAlert(message, type = 'info') {
    const alertBox = document.createElement('div');
    alertBox.className = `message-box message-${type}`;
    alertBox.style.position = 'fixed';
    alertBox.style.top = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.zIndex = '1000';
    alertBox.style.maxWidth = '500px';
    alertBox.textContent = message;
    
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
}

function getFontSizeClass(text) {
    const length = text.length;
    if (length <= 10) return 'font-size-xl';
    if (length <= 15) return 'font-size-lg';
    if (length <= 20) return 'font-size-md';
    if (length <= 25) return 'font-size-sm';
    return 'font-size-xs';
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { error } = await dbClient.from('users').select('count').limit(1);
        if (error) throw error;
        showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) throw createError;
            
            appState.currentUser = username;
            appState.isTeacher = isTeacherAccount;
            appState.userId = username;
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
        } else if (checkError) {
            throw checkError;
        } else {
            appState.currentUser = username;
            appState.isTeacher = existingUser.is_teacher;
            appState.userId = username;
            
            await dbClient
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        localStorage.setItem('kathy_current_user', username);
        localStorage.setItem('kathy_user_role', appState.isTeacher ? 'teacher' : 'student');
        
        if (!appState.isTeacher) {
            await syncGroupWordsToStudent(username);
        }
        
        setTimeout(() => {
            if (appState.isTeacher) {
                showTeacherDashboard();
            } else {
                showStudentDashboard();
            }
        }, 800);
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆåŠŸèƒ½ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}

async function loadTeacherDashboard() {
    try {
        // è·å–æ•™å¸ˆç»Ÿè®¡æ•°æ®
        const { data: dashboardData, error: dashboardError } = await dbClient
            .from('teacher_dashboard_view')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .single();
        
        if (dashboardError) throw dashboardError;
        
        // æ›´æ–°ç»Ÿè®¡æ•°å­—
        document.getElementById('total-words').textContent = dashboardData?.word_count || 0;
        document.getElementById('total-students').textContent = dashboardData?.student_count || 0;
        document.getElementById('active-students').textContent = dashboardData?.active_students_7d || 0;
        
        // è·å–å·²æŒæ¡å•è¯æ•°
        const { data: studyData } = await dbClient
            .from('study_records')
            .select('status')
            .eq('student_id', (await dbClient
                .from('users')
                .select('username')
                .eq('is_teacher', false)
                .limit(1)
            )?.data?.[0]?.username || '');
        
        const masteredWords = studyData?.filter(r => r.status === 'mastered').length || 0;
        document.getElementById('mastered-words').textContent = masteredWords;
        
        // åŠ è½½æ•™å¸ˆåŠŸèƒ½é¢æ¿
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">âœ¨ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn" style="padding: 12px 24px;" onclick="showUploadWordsPage()">
                        <span>ğŸ“¤ å¿«é€Ÿä¸Šä¼ </span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 24px;" onclick="showTeacherStats()">
                        <span>ğŸ“ˆ ä»Šæ—¥æ•°æ®</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px;" onclick="showAllStudentsPage()">
                        <span>ğŸ‘€ æŸ¥çœ‹å­¦ç”Ÿ</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px; background: #FF9800;" onclick="showAttendanceReport()">
                        <span>ğŸ“… æ‰“å¡ç»Ÿè®¡</span>
                    </button>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ç³»ç»Ÿç»Ÿè®¡</h4>
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${dashboardData?.group_count || 0}</div>
                            <div class="label">åˆ†ç»„æ•°é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${dashboardData?.total_words_studied_7d || 0}</div>
                            <div class="label">æœ¬å‘¨å­¦ä¹ é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${dashboardData?.active_students_7d || 0}</div>
                            <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${dashboardData?.student_count || 0}</div>
                            <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        document.getElementById('teacher-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
    }
}

// ========== æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ ==========
function showUploadWordsPage() {
    showScreen('teacher-upload-screen');
    loadUploadWordsPage();
}

async function loadUploadWordsPage() {
    try {
        // è·å–æ•™å¸ˆçš„åˆ†ç»„
        const { data: groups, error: groupsError } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (groupsError) throw groupsError;
        
        let groupsOptions = '';
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                groupsOptions += `<option value="${group.id}">${group.name}</option>`;
            });
        }
        
        const content = document.getElementById('teacher-upload-content');
        content.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ ä¸Šä¼ å•è¯</h3>
                
                <div class="stats-card" style="margin-bottom: 30px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">é€‰æ‹©åˆ†ç»„</label>
                        <select id="upload-group" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            <option value="">è¯·é€‰æ‹©åˆ†ç»„...</option>
                            ${groupsOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">å•è¯åˆ†ç±»</label>
                        <input type="text" id="word-category" placeholder="è¾“å…¥åˆ†ç±»ï¼ˆå¦‚ï¼šåŸºç¡€è¯æ±‡ã€ç§‘æŠ€è¯æ±‡ç­‰ï¼‰" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #333; margin-bottom: 15px;">æ‰¹é‡ä¸Šä¼ æ ¼å¼</h4>
                    <textarea id="words-input" placeholder="è¾“å…¥æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªå•è¯ï¼Œè‹±æ–‡å’Œä¸­æ–‡ç”¨é€—å·åˆ†éš”ï¼‰ï¼š
hello,ä½ å¥½
world,ä¸–ç•Œ
apple,è‹¹æœ
book,ä¹¦

å¯é€‰ï¼šè‹±æ–‡,ä¸­æ–‡,åˆ†ç±»ï¼ˆå¦‚ï¼šcomputer,ç”µè„‘,ç§‘æŠ€ï¼‰" 
                              style="width: 100%; height: 200px; font-family: 'Courier New', monospace; padding: 15px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px; line-height: 1.5;"></textarea>
                    
                    <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="btn" onclick="parseAndPreviewWords()" style="padding: 15px; font-size: 16px;">
                            <span>ğŸ‘ï¸ é¢„è§ˆå•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="uploadWordsBatch()" style="padding: 15px; font-size: 16px;">
                            <span>ğŸ“¤ ä¸Šä¼ å•è¯</span>
                        </button>
                    </div>
                </div>
                
                <div id="upload-preview" style="margin-top: 30px;"></div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½ä¸Šä¼ é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-upload-content').innerHTML = 
            `<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
    }
}

async function parseAndPreviewWords() {
    const text = document.getElementById('words-input').value.trim();
    const groupId = document.getElementById('upload-group').value;
    const category = document.getElementById('word-category').value || 'é€šç”¨';
    
    if (!groupId) {
        showAlert('è¯·å…ˆé€‰æ‹©åˆ†ç»„', 'error');
        return;
    }
    
    if (!text) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    const words = [];
    let validCount = 0;
    let errorCount = 0;
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        const parts = line.split(',').map(part => part.trim());
        
        if (parts.length >= 2) {
            const english = parts[0];
            const chinese = parts[1];
            const wordCategory = parts[2] || category;
            
            if (english && chinese) {
                words.push({
                    english: english.toLowerCase(),
                    chinese: chinese,
                    category: wordCategory
                });
                validCount++;
            } else {
                errorCount++;
            }
        } else {
            errorCount++;
        }
    }
    
    const previewDiv = document.getElementById('upload-preview');
    previewDiv.innerHTML = `
        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h4 style="color: #333; margin-bottom: 15px;">é¢„è§ˆ (${validCount}ä¸ªæœ‰æ•ˆå•è¯)</h4>
            ${errorCount > 0 ? `<p style="color: #FF9800; margin-bottom: 15px;">âš ï¸ ${errorCount} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼Œå·²å¿½ç•¥</p>` : ''}
            
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">è‹±æ–‡</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ä¸­æ–‡</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">åˆ†ç±»</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${words.map(word => `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>${word.english}</strong></td>
                                <td style="padding: 10px;">${word.chinese}</td>
                                <td style="padding: 10px;"><span style="background: #E8F5E9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${word.category}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-blue" onclick="confirmUploadWords()" style="padding: 12px 30px; font-size: 16px;">
                    âœ… ç¡®è®¤ä¸Šä¼  ${validCount} ä¸ªå•è¯
                </button>
            </div>
        </div>
    `;
    
    // ä¿å­˜é¢„è§ˆæ•°æ®åˆ°å…¨å±€çŠ¶æ€
    appState.previewWords = {
        words: words,
        groupId: groupId,
        category: category
    };
}

async function confirmUploadWords() {
    if (!appState.previewWords || !appState.previewWords.words.length) {
        showAlert('æ²¡æœ‰å¯ä¸Šä¼ çš„å•è¯', 'error');
        return;
    }
    
    const { words, groupId, category } = appState.previewWords;
    
    try {
        showAlert('æ­£åœ¨ä¸Šä¼ å•è¯...', 'info');
        
        // å‡†å¤‡è¦æ’å…¥çš„å•è¯æ•°æ®
        const wordData = words.map(word => ({
            teacher_id: appState.teacherId,
            english: word.english,
            chinese: word.chinese,
            category: word.category || category,
            group_id: groupId
        }));
        
        // æ‰¹é‡æ’å…¥å•è¯
        const { data, error } = await dbClient
            .from('words')
            .insert(wordData)
            .select();
        
        if (error) {
            // å¦‚æœæ‰¹é‡æ’å…¥å¤±è´¥ï¼Œå°è¯•å•ä¸ªæ’å…¥
            console.error('æ‰¹é‡æ’å…¥å¤±è´¥ï¼Œå°è¯•å•ä¸ªæ’å…¥:', error);
            let successCount = 0;
            let failedWords = [];
            
            for (const word of wordData) {
                try {
                    const { error: singleError } = await dbClient
                        .from('words')
                        .insert(word)
                        .select();
                    
                    if (!singleError) {
                        successCount++;
                    } else {
                        failedWords.push(word.english);
                    }
                } catch (err) {
                    failedWords.push(word.english);
                }
            }
            
            if (successCount > 0) {
                showAlert(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªå•è¯${failedWords.length > 0 ? `ï¼Œå¤±è´¥ ${failedWords.length} ä¸ª` : ''}`, 'success');
            } else {
                showAlert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
            
        } else {
            showAlert(`æˆåŠŸä¸Šä¼  ${data.length} ä¸ªå•è¯ï¼`, 'success');
        }
        
        // æ¸…ç©ºè¾“å…¥å’Œé¢„è§ˆ
        document.getElementById('words-input').value = '';
        document.getElementById('upload-preview').innerHTML = '';
        appState.previewWords = null;
        
        // æ›´æ–°å•è¯ç®¡ç†é¡µé¢
        await loadTeacherDashboard();
        
    } catch (error) {
        console.error('ä¸Šä¼ å•è¯é”™è¯¯:', error);
        showAlert(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
}

function uploadWordsBatch() {
    if (!appState.previewWords) {
        parseAndPreviewWords();
    } else {
        confirmUploadWords();
    }
}

// ========== æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ ==========
function showGroupManagementPage() {
    showScreen('teacher-groups-screen');
    loadGroupManagementPage();
}

async function loadGroupManagementPage() {
    try {
        // è·å–æ•™å¸ˆçš„åˆ†ç»„å’Œå­¦ç”Ÿæ•°æ®
        const [groupsResponse, studentsResponse] = await Promise.all([
            dbClient
                .from('group_stats_view')
                .select('*')
                .eq('teacher_id', appState.teacherId)
                .order('group_name'),
            
            dbClient
                .from('users')
                .select('username')
                .eq('is_teacher', false)
                .eq('teacher_id', appState.teacherId)
        ]);
        
        if (groupsResponse.error) throw groupsResponse.error;
        if (studentsResponse.error) throw studentsResponse.error;
        
        appState.teacherGroups = groupsResponse.data || [];
        appState.teacherStudents = studentsResponse.data || [];
        
        const content = document.getElementById('teacher-groups-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="btn" onclick="showCreateGroupModal()" style="padding: 12px 24px;">
                        <span>â• åˆ›å»ºæ–°åˆ†ç»„</span>
                    </button>
                    <button class="btn btn-blue" onclick="showAddStudentsModal()" style="padding: 12px 24px;">
                        <span>ğŸ‘¥ æ·»åŠ å­¦ç”Ÿåˆ°åˆ†ç»„</span>
                    </button>
                    <button class="btn" onclick="showManageGroupWords()" style="padding: 12px 24px;">
                        <span>ğŸ“– ç®¡ç†åˆ†ç»„å•è¯</span>
                    </button>
                </div>
                
                <div id="groups-list" style="margin-top: 20px;">
                    ${appState.teacherGroups.length === 0 ? 
                        '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç»„</p>' :
                        renderGroupsList(appState.teacherGroups)
                    }
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„ç®¡ç†é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-groups-content').innerHTML = 
            `<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
    }
}

function renderGroupsList(groups) {
    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
            ${groups.map(group => `
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #4CAF50;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0; color: #333; font-size: 18px;">${group.group_name}</h4>
                            ${group.description ? `<p style="color: #666; margin: 5px 0; font-size: 14px;">${group.description}</p>` : ''}
                        </div>
                        <button class="btn" onclick="editGroup('${group.group_id}')" style="padding: 6px 12px; font-size: 14px;">
                            âœï¸ ç¼–è¾‘
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${group.word_count || 0}</div>
                                <div style="color: #666; font-size: 12px;">å•è¯æ•°é‡</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${group.student_count || 0}</div>
                                <div style="color: #666; font-size: 12px;">å­¦ç”Ÿæ•°é‡</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-blue" onclick="manageGroupStudents('${group.group_id}')" 
                                style="flex: 1; padding: 8px; font-size: 14px;">
                            ç®¡ç†å­¦ç”Ÿ
                        </button>
                        <button class="btn" onclick="deleteGroup('${group.group_id}')" 
                                style="flex: 1; padding: 8px; font-size: 14px; background: #F44336;">
                            åˆ é™¤åˆ†ç»„
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// ========== æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ ==========
function showAllStudentsPage() {
    showScreen('teacher-students-screen');
    loadAllStudentsPage();
}

async function loadAllStudentsPage() {
    try {
        // è·å–æ‰€æœ‰å­¦ç”ŸåŠå…¶è¿›åº¦æ•°æ®
        const { data: students, error } = await dbClient
            .from('student_progress_view')
            .select('*')
            .order('last_study_date', { ascending: false });
        
        if (error) throw error;
        
        const content = document.getElementById('teacher-students-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ (${students?.length || 0}äºº)</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                    <div style="flex: 1;">
                        <input type="text" id="student-search" placeholder="ğŸ” æœç´¢å­¦ç”Ÿ..." 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;"
                               oninput="filterStudents()">
                    </div>
                    <button class="btn" onclick="exportStudentData()" style="padding: 12px 24px;">
                        ğŸ“Š å¯¼å‡ºæ•°æ®
                    </button>
                </div>
                
                <div id="students-list" style="margin-top: 20px;">
                    ${renderStudentsList(students || [])}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
        document.getElementById('teacher-students-content').innerHTML = 
            `<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
    }
}

function renderStudentsList(students) {
    if (students.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— å­¦ç”Ÿæ•°æ®</p>';
    }
    
    return `
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>å­¦ç”Ÿ</th>
                        <th>å•è¯æ€»æ•°</th>
                        <th>å·²æŒæ¡</th>
                        <th>å­¦ä¹ ä¸­</th>
                        <th>éœ€å­¦ä¹ </th>
                        <th>å¤ä¹ æ¬¡æ•°</th>
                        <th>è®°å¿†å¼ºåº¦</th>
                        <th>æœ€åå­¦ä¹ </th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => {
                        const lastStudy = student.last_study_date ? 
                            new Date(student.last_study_date).toLocaleDateString('zh-CN') : 'ä»æœªå­¦ä¹ ';
                        
                        return `
                            <tr>
                                <td><strong>${student.student_id}</strong></td>
                                <td>${student.total_words}</td>
                                <td style="color: #4CAF50;">${student.mastered_words}</td>
                                <td style="color: #2196F3;">${student.learning_words}</td>
                                <td style="color: #FF9800;">${student.new_words}</td>
                                <td>${student.total_reviews}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 60px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                                            <div style="width: ${student.avg_memory_strength}%; height: 100%; 
                                                 background: ${student.avg_memory_strength >= 70 ? '#4CAF50' : 
                                                               student.avg_memory_strength >= 50 ? '#FF9800' : '#F44336'};"></div>
                                        </div>
                                        <span style="font-size: 12px; color: #666;">${student.avg_memory_strength}%</span>
                                    </div>
                                </td>
                                <td>${lastStudy}</td>
                                <td>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                            onclick="viewStudentDetails('${student.student_id}')">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ========== æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ ==========
function showLearningProgressPage() {
    showScreen('teacher-progress-screen');
    loadLearningProgressPage();
}

async function loadLearningProgressPage() {
    const content = document.getElementById('teacher-progress-content');
    content.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“Š å­¦ä¹ è¿›åº¦åˆ†æ</h3>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="btn" onclick="showOverallProgress()" style="padding: 12px 24px;">
                    ğŸ“ˆ æ•´ä½“è¿›åº¦
                </button>
                <button class="btn btn-blue" onclick="showGroupProgress()" style="padding: 12px 24px;">
                    ğŸ‘¥ åˆ†ç»„å¯¹æ¯”
                </button>
                <button class="btn" onclick="showStudentProgress()" style="padding: 12px 24px;">
                    ğŸ¯ å­¦ç”Ÿè¯¦æƒ…
                </button>
                <button class="btn" onclick="showWeakWordsAnalysis()" style="padding: 12px 24px;">
                    âš ï¸ å¼±é¡¹åˆ†æ
                </button>
                <button class="btn btn-gold" onclick="showAttendanceAnalysis()" style="padding: 12px 24px;">
                    ğŸ“… æ‰“å¡åˆ†æ
                </button>
            </div>
            
            <div id="progress-data" style="margin-top: 20px;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                    <h4 style="color: #666;">é€‰æ‹©åˆ†æç±»å‹å¼€å§‹</h4>
                    <p style="color: #999;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹ä¸åŒç»´åº¦çš„å­¦ä¹ è¿›åº¦åˆ†æ</p>
                </div>
            </div>
        </div>
    `;
}

// ========== æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ ==========
function showWordManagementPage() {
    showScreen('teacher-words-screen');
    loadWordManagementPage();
}

async function loadWordManagementPage() {
    try {
        // è·å–æ•™å¸ˆçš„åˆ†ç»„
        const { data: groups, error: groupsError } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (groupsError) throw groupsError;
        
        // è·å–æ‰€æœ‰å•è¯åŠæŒæ¡æƒ…å†µ
        const { data: words, error: wordsError } = await dbClient
            .from('word_mastery_view')
            .select('*')
            .eq('teacher_id', appState.teacherId)
            .order('mastery_rate', { ascending: true })
            .limit(100);
        
        if (wordsError) throw wordsError;
        
        appState.teacherWords = words || [];
        
        let groupsOptions = '<option value="all">å…¨éƒ¨åˆ†ç»„</option>';
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                groupsOptions += `<option value="${group.id}">${group.name}</option>`;
            });
        }
        
        const content = document.getElementById('teacher-words-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“– å•è¯ç®¡ç† (${words?.length || 0}ä¸ª)</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <select id="words-group-filter" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            ${groupsOptions}
                        </select>
                    </div>
                    <div style="flex: 2; min-width: 300px;">
                        <input type="text" id="words-search" placeholder="ğŸ” æœç´¢è‹±æ–‡æˆ–ä¸­æ–‡..." 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;"
                               oninput="filterTeacherWords()">
                    </div>
                    <button class="btn" onclick="searchTeacherWords()" style="padding: 12px 24px;">
                        æœç´¢
                    </button>
                    <button class="btn btn-blue" onclick="showAddSingleWordModal()" style="padding: 12px 24px;">
                        â• æ·»åŠ å•è¯
                    </button>
                </div>
                
                <div id="words-list" style="margin-top: 20px;">
                    ${renderTeacherWordsList(appState.teacherWords)}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å•è¯ç®¡ç†é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-words-content').innerHTML = 
            `<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
    }
}

function renderTeacherWordsList(words) {
    if (words.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— å•è¯æ•°æ®</p>';
    }
    
    return `
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>è‹±æ–‡</th>
                        <th>ä¸­æ–‡</th>
                        <th>åˆ†ç±»</th>
                        <th>å­¦ä¹ å­¦ç”Ÿ</th>
                        <th>æŒæ¡å­¦ç”Ÿ</th>
                        <th>æŒæ¡ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${words.map(word => {
                        const masteryRate = word.mastery_rate || 0;
                        let masteryColor = '#4CAF50';
                        if (masteryRate < 30) masteryColor = '#F44336';
                        else if (masteryRate < 60) masteryColor = '#FF9800';
                        
                        return `
                            <tr data-group-id="${word.group_id}">
                                <td><strong>${word.english}</strong></td>
                                <td>${word.chinese}</td>
                                <td><span style="background: #E8F5E9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${word.category || 'é€šç”¨'}</span></td>
                                <td>${word.total_students || 0}</td>
                                <td>${word.mastered_students || 0}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 80px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${masteryRate}%; height: 100%; background: ${masteryColor};"></div>
                                        </div>
                                        <span style="color: ${masteryColor}; font-weight: bold;">${masteryRate}%</span>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;" 
                                            onclick="editWord('${word.word_id}')">
                                        ç¼–è¾‘
                                    </button>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px; background: #F44336;" 
                                            onclick="deleteWord('${word.word_id}')">
                                        åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        ${words.length >= 100 ? `
            <div style="text-align: center; margin-top: 20px; color: #666;">
                æ˜¾ç¤ºå‰100ä¸ªå•è¯ï¼Œä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥çœ‹æ›´å¤š
            </div>
        ` : ''}
    `;
}

// ========== æ•™å¸ˆæ‰“å¡ç»Ÿè®¡é¡µé¢ ==========
function showAttendanceReport() {
    showScreen('teacher-attendance-screen');
    loadAttendanceReport();
}

async function loadAttendanceReport() {
    const content = document.getElementById('teacher-attendance-content');
    content.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“… å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡ç³»ç»Ÿ</h3>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="btn" onclick="loadDailyAttendance()" style="padding: 12px 24px;">
                    ä»Šæ—¥æ‰“å¡
                </button>
                <button class="btn btn-blue" onclick="loadWeeklyAttendance()" style="padding: 12px 24px;">
                    æœ¬å‘¨ç»Ÿè®¡
                </button>
                <button class="btn" onclick="loadMonthlyAttendance()" style="padding: 12px 24px;">
                    æœ¬æœˆç»Ÿè®¡
                </button>
                <button class="btn" onclick="loadConsecutiveAchievements()" style="padding: 12px 24px; background: #FF9800;">
                    è¿ç»­æ‰“å¡æ¦œ
                </button>
                <button class="btn btn-gold" onclick="loadAttendanceTrend()" style="padding: 12px 24px;">
                    è¶‹åŠ¿åˆ†æ
                </button>
            </div>
            
            <div id="attendance-data" style="margin-top: 20px;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“…</div>
                    <h4 style="color: #666;">é€‰æ‹©ç»Ÿè®¡èŒƒå›´</h4>
                    <p style="color: #999;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹ä¸åŒæ—¶é—´ç»´åº¦çš„æ‰“å¡æ•°æ®</p>
                </div>
            </div>
        </div>
    `;
}

// ========== åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ ==========
async function syncGroupWordsToStudent(studentId) {
    try {
        // è°ƒç”¨æ•°æ®åº“å‡½æ•°åŒæ­¥å•è¯
        const { data, error } = await dbClient.rpc('sync_group_words_to_student', {
            p_student_id: studentId,
            p_teacher_id: appState.teacherId
        });
        
        if (error) {
            console.error('åŒæ­¥å•è¯é”™è¯¯:', error);
            return 0;
        }
        
        const result = data || { synced_count: 0, group_name: 'é»˜è®¤åˆ†ç»„' };
        
        if (result.synced_count > 0) {
            showAlert(`âœ… åŒæ­¥æˆåŠŸï¼\nğŸ“ åˆ†ç»„ï¼š${result.group_name}\nğŸ“– æ–°å•è¯ï¼š${result.synced_count}ä¸ª`, 'success');
        } else {
            showAlert(`ğŸ“š æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯\nğŸ“ åˆ†ç»„ï¼š${result.group_name}`, 'info');
        }
        
        return result.synced_count;
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboardSimple();
}

async function loadStudentDashboardSimple() {
    try {
        document.getElementById('student-name').textContent = appState.currentUser;
        
        // è·å–å­¦ç”Ÿæ•°æ®
        const { data: progressData, error: progressError } = await dbClient
            .from('student_progress_view')
            .select('*')
            .eq('student_id', appState.currentUser)
            .single();
        
        if (progressError && progressError.code !== 'PGRST116') {
            console.error('è·å–å­¦ç”Ÿè¿›åº¦é”™è¯¯:', progressError);
        }
        
        // è·å–ä»Šæ—¥æ‰“å¡æ•°æ®
        const today = new Date().toISOString().split('T')[0];
        const { data: todayAttendance, error: attendanceError } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('study_date', today)
            .single();
        
        // è·å–è¿ç»­æ‰“å¡å¤©æ•°
        const { data: attendanceRecords } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', appState.currentUser)
            .order('study_date', { ascending: false })
            .limit(30);
        
        let consecutiveDays = 0;
        if (attendanceRecords && attendanceRecords.length > 0) {
            const todayDate = new Date(today);
            let currentDate = todayDate;
            
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const hasStudy = attendanceRecords.some(record => record.study_date === dateStr);
                
                if (hasStudy) {
                    consecutiveDays++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
        }
        
        appState.consecutiveDays = consecutiveDays;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¤ä¹ æ—¥
        const isReviewDay = consecutiveDays % 7 === 0 && consecutiveDays > 0;
        appState.reviewDay = isReviewDay;
        
        // è·å–åˆ†ç»„ä¿¡æ¯
        const { data: studentGroups } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', appState.currentUser);
        
        // æ›´æ–°ç•Œé¢
        const todayStatus = document.getElementById('today-status');
        const todayWords = todayAttendance?.word_count || 0;
        const newWords = todayAttendance?.new_word_count || 0;
        const reviewWords = todayAttendance?.review_word_count || 0;
        
        let reviewDayNotice = '';
        if (isReviewDay) {
            reviewDayNotice = `
                <div class="celebration-banner" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white;">
                    ğŸ“… ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼é‡ç‚¹å¤ä¹ å·²å­¦å†…å®¹ï¼Œä¸å­¦ä¹ æ–°å•è¯
                </div>
            `;
        }
        
        // ç”Ÿæˆè¿ç»­æ‰“å¡æ˜¾ç¤º
        const streakHTML = await generateStreakDisplay();
        
        todayStatus.innerHTML = `
            ${reviewDayNotice}
            ${streakHTML}
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${todayWords}</div>
                        <div class="label">ä»Šæ—¥å·²å­¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${newWords}</div>
                        <div class="label">æ–°å•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${reviewWords}</div>
                        <div class="label">å¤ä¹ å•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${appState.consecutiveDays}</div>
                        <div class="label">è¿ç»­å¤©æ•°</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayWords}/${appState.dailyTarget}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(100, (todayWords/appState.dailyTarget)*100)}%"></div>
                    </div>
                </div>
                ${todayWords >= appState.dailyTarget ? 
                    '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : 
                    '<p style="color: #FF9800; text-align: center; margin-top: 15px;">ğŸ’ª ç»§ç»­åŠªåŠ›ï¼</p>'}
            </div>
        `;
        
        // æ›´æ–°å­¦ä¹ è¿›åº¦
        const progressSummary = document.getElementById('my-progress-summary');
        if (progressData) {
            const progress = progressData.total_words > 0 ? 
                Math.round((progressData.mastered_words / progressData.total_words) * 100) : 0;
            
            progressSummary.innerHTML = `
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${progressData.total_words}</div>
                        <div class="label">å•è¯æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progressData.mastered_words}</div>
                        <div class="label">å·²æŒæ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progressData.learning_words}</div>
                        <div class="label">å­¦ä¹ ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${progressData.new_words}</div>
                        <div class="label">éœ€å­¦ä¹ </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                        è®°å¿†å¼ºåº¦: ${progressData.avg_memory_strength || 0}%
                    </div>
                </div>
            `;
        }
        
        // æ›´æ–°åˆ†ç»„è¯¦æƒ…
        let groupDetails = '';
        if (studentGroups && studentGroups.length > 0) {
            for (const group of studentGroups) {
                const { data: groupInfo } = await dbClient
                    .from('groups')
                    .select('name')
                    .eq('id', group.group_id)
                    .single();
                
                if (groupInfo) {
                    groupDetails += `
                        <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${groupInfo.name}</div>
                            <div style="color: #666; font-size: 14px;">
                                åŒæ­¥æ—¶é—´: ${new Date().toLocaleDateString('zh-CN')}
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        document.getElementById('group-details').innerHTML = groupDetails ? `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š æˆ‘çš„åˆ†ç»„è¯¦æƒ…</h3>
                ${groupDetails}
            </div>
        ` : `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š åˆ†ç»„çŠ¶æ€</h3>
                <p style="color: #FF9800; text-align: center;">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„</p>
                <p style="color: #666; text-align: center; font-size: 14px;">è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// ========== å…¶ä»–è¾…åŠ©å‡½æ•° ==========
async function generateStreakDisplay() {
    try {
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', appState.currentUser)
            .order('study_date', { ascending: false })
            .limit(30);
        
        if (error) throw error;
        
        const streakDays = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const attendanceSet = new Set(attendance?.map(a => a.study_date) || []);
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            streakDays.push({
                date: date,
                dateStr: dateStr,
                completed: attendanceSet.has(dateStr),
                isToday: i === 0
            });
        }
        
        const completedCount = streakDays.filter(d => d.completed).length;
        const todayCompleted = streakDays[6].completed;
        
        let streakHTML = `
            <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 24px;">ğŸ”¥</span>
                    <div>
                        <div style="font-weight: bold; color: #2E7D32;">è¿ç»­å­¦ä¹  ${appState.consecutiveDays} å¤©</div>
                        <div style="color: #666; font-size: 14px;">
                            ${appState.consecutiveDays % 7 === 0 && appState.consecutiveDays > 0 ? 
                              'ğŸ‰ ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼' : 
                              `å†åšæŒ ${7 - (appState.consecutiveDays % 7)} å¤©å¯è·å¾—å¥–åŠ±`}
                        </div>
                    </div>
                </div>
                
                <div class="streak-container">
        `;
        
        streakDays.forEach((day, index) => {
            let className = 'streak-day';
            if (day.completed) className += ' completed';
            if (day.isToday) className += ' today';
            if (!day.completed && !day.isToday) className += ' missed';
            
            streakHTML += `
                <div class="${className}" title="${day.dateStr}">
                    ${day.date.getDate()}
                </div>
            `;
        });
        
        streakHTML += `
                </div>
                <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                    ${todayCompleted ? 'âœ… ä»Šå¤©å·²å®Œæˆå­¦ä¹ ' : 'â° ä»Šå¤©è¿˜æœªå­¦ä¹ '}
                </div>
            </div>
        `;
        
        return streakHTML;
        
    } catch (error) {
        console.error('ç”Ÿæˆè¿ç»­æ‰“å¡æ˜¾ç¤ºé”™è¯¯:', error);
        return '';
    }
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        appState.currentUser = null;
        appState.isTeacher = false;
        appState.userId = null;
        appState.userWords = [];
        appState.trainingWords = [];
        appState.selectedGroupId = null;
        appState.selectedWords = [];
        appState.dailyTrainingProgress = 0;
        appState.lastTrainingDate = null;
        appState.consecutiveDays = 0;
        appState.reviewDay = false;
        appState.todayWordsToReview = [];
        appState.teacherGroups = [];
        appState.teacherStudents = [];
        appState.teacherWords = [];
        appState.currentGroup = null;
        
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯æ™ºèƒ½è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        appState.currentUser = savedUser;
        appState.isTeacher = (savedRole === 'teacher');
        appState.userId = savedUser;
        
        if (appState.isTeacher) {
            showTeacherDashboard();
        } else {
            showStudentDashboard();
        }
    } else {
        testDatabase();
    }
    
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
};
</script>
</body>
</html>
