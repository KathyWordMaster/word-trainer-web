<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥ - æ™ºèƒ½è®°å¿†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* è¿™é‡Œæ˜¯æ‚¨åŸæ¥çš„æ‰€æœ‰CSSæ ·å¼ï¼Œå®Œå…¨ä¿ç•™ */
        /* ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œæˆ‘å‡è®¾æ‚¨å·²æœ‰çš„CSSéƒ½åœ¨è¿™é‡Œ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2C3E50 0%, #4A6491 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #F1C40F; }
        .main-content { padding: 30px; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 14px 28px; margin: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-blue { background: #2196F3; } .btn-blue:hover { background: #1976D2; }
        .btn-red { background: #F44336; } .btn-red:hover { background: #D32F2F; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gold { background: #FFC107; color: #333; } .btn-gold:hover { background: #FFA000; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        
        input[type="text"], textarea, input[type="password"], select { width: 100%; max-width: 500px; padding: 16px; margin: 12px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        textarea { height: 200px; font-family: monospace; resize: vertical; }
        
        .word-card { 
            background: white; 
            border: 4px solid #4CAF50; 
            border-radius: 20px; 
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 30px auto; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            max-width: 600px;
            padding: 20px;
            word-wrap: break-word;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .word-card-content {
            width: 100%;
            text-align: center;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .font-size-xl { font-size: 2.8em; }
        .font-size-lg { font-size: 2.2em; }
        .font-size-md { font-size: 1.8em; }
        .font-size-sm { font-size: 1.5em; }
        .font-size-xs { font-size: 1.2em; }
        
        .word-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .word-card.flipped { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-color: #2E7D32; }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #4CAF50; }
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table th { background: #4CAF50; color: white; padding: 15px; text-align: left; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #f5f5f5; }
        
        .progress-container { width: 100%; max-width: 600px; margin: 20px auto; }
        .progress-bar { width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        
        .message-box { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .message-success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .message-error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .message-info { background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB; }
        .message-warning { background: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; }
        
        .wechat-badge { background: #07C160; color: white; padding: 14px 28px; border-radius: 25px; display: inline-flex; align-items: center; gap: 12px; font-weight: bold; font-size: 1.1em; margin: 15px 0; box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3); }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { color: #666; font-size: 0.9em; }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        
        .fixed-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            z-index: 1000; 
            padding: 15px 30px; 
            border-bottom: 2px solid #f0f0f0; 
        }
        
        .content-padding { padding-top: 100px; padding-bottom: 30px; }
        
        .celebration-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .mode-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .mode-standard { background: #E8F5E9; color: #2E7D32; }
        .mode-extra-new { background: #E3F2FD; color: #1565C0; }
        .mode-intensive { background: #FFF3E0; color: #EF6C00; }
        .mode-memory { background: #F3E5F5; color: #7B1FA2; }
        
        .memory-strength-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .memory-strength-fill {
            height: 100%;
            transition: width 0.5s;
        }
        .strength-high { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .strength-medium { background: linear-gradient(90deg, #FF9800, #FFB74D); }
        .strength-low { background: linear-gradient(90deg, #F44336, #EF5350); }
        
        .streak-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        .streak-day {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #ddd;
        }
        .streak-day.completed {
            background: #4CAF50;
            color: white;
            border-color: #2E7D32;
        }
        .streak-day.today {
            background: #2196F3;
            color: white;
            border-color: #1976D32;
        }
        .streak-day.missed {
            background: #f5f5f5;
            color: #999;
        }
        
        .batch-controls { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        
        @media (max-width: 768px) {
            .two-column { grid-template-columns: 1fr; }
            .container { margin: 10px; border-radius: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .word-card { 
                height: 220px; 
                max-width: 90%;
                margin: 20px auto;
                padding: 15px;
            }
            .font-size-xl { font-size: 2.2em; }
            .font-size-lg { font-size: 1.8em; }
            .font-size-md { font-size: 1.5em; }
            .font-size-sm { font-size: 1.3em; }
            .font-size-xs { font-size: 1.1em; }
            .btn { padding: 12px 20px; margin: 8px; font-size: 15px; }
            .card-grid { grid-template-columns: 1fr 1fr; }
            .content-padding { padding-top: 90px; }
            .fixed-header { padding: 12px 20px; }
            .streak-day { width: 35px; height: 35px; font-size: 12px; }
        }
        
        @media (max-width: 480px) {
            .word-card { 
                height: 200px; 
                padding: 10px;
            }
            .font-size-xl { font-size: 1.8em; }
            .font-size-lg { font-size: 1.5em; }
            .font-size-md { font-size: 1.3em; }
            .font-size-sm { font-size: 1.1em; }
            .font-size-xs { font-size: 0.9em; }
            .card-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Kathyå•è¯å¤§å¸ˆè®­ç»ƒè¥</h1>
            <h2 style="color: white;">ğŸ§  æ™ºèƒ½è®°å¿†ç³»ç»Ÿ ğŸ”¥</h2>
            <p style="color: #BDC3C7; font-size: 0.9em;">ğŸ‘‘ æ•™å¸ˆï¼šKathy | ğŸ’¬ å¾®ä¿¡ï¼šKathy151 | ğŸ“š åŸºäºè®°å¿†æ›²çº¿ç§‘å­¦å­¦ä¹ </p>
        </div>
        
        <div class="main-content">
            <!-- ç™»å½•ç•Œé¢ -->
            <div id="login-screen" class="screen active">
                <div style="text-align: center;">
                    <h2>ğŸ‘‘ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å•è¯è®­ç»ƒç³»ç»Ÿ</h2>
                    <p style="color: #666; margin-bottom: 30px;">ğŸ§¡ åŸºäºè®°å¿†æ›²çº¿çš„ç§‘å­¦å­¦ä¹ ï¼Œè®©å•è¯è®°å¾—æ›´ç‰¢ï¼</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autofocus>
                        <div id="login-message" class="message-box message-info">
                            æ­£åœ¨è¿æ¥æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ...
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <button class="btn" onclick="handleLogin()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
                            <button class="btn btn-blue" onclick="testDatabase()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 30px 0;">
                        <h3 style="color: #2C3E50; margin-bottom: 20px;">âœ¨ ç³»ç»Ÿç‰¹è‰²åŠŸèƒ½</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“ˆ</div>
                                <div style="font-weight: bold; margin: 10px 0;">æ™ºèƒ½è®°å¿†æ›²çº¿</div>
                                <div>åŸºäºè‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿</div>
                                <div>ç§‘å­¦å®‰æ’å¤ä¹ æ—¶é—´</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ¯</div>
                                <div style="font-weight: bold; margin: 10px 0;">ä¸ªæ€§åŒ–å­¦ä¹ </div>
                                <div>æ¯æ—¥10ä¸ªæ–°å•è¯</div>
                                <div>å¯è‡ªä¸»é€‰æ‹©åŠ é‡å­¦ä¹ </div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ”¥</div>
                                <div style="font-weight: bold; margin: 10px 0;">é‡ç‚¹å¼ºåŒ–å¤ä¹ </div>
                                <div>å­¦ä¹ ä¸­å•è¯ä¼˜å…ˆå¤ä¹ </div>
                                <div>å¼ºåŒ–è–„å¼±ç¯èŠ‚</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 2em;">ğŸ“…</div>
                                <div style="font-weight: bold; margin: 10px 0;">è¿ç»­æ‰“å¡æ¿€åŠ±</div>
                                <div>è¿ç»­7å¤©å­¦ä¹ æœ‰å¥–åŠ±</div>
                                <div>åŸ¹å…»è‰¯å¥½å­¦ä¹ ä¹ æƒ¯</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <div class="wechat-badge">
                                <span>ğŸ“ æ•™å¸ˆå¾®ä¿¡ï¼š</span>
                                <strong>Kathy151</strong>
                            </div>
                            <p style="color: #555; margin-top: 15px;">æœ‰ä»»ä½•é—®é¢˜è¯·éšæ—¶è”ç³»è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•™å¸ˆä¸»ç•Œé¢ -->
            <div id="teacher-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘‘ æ•™å¸ˆæ™ºèƒ½ç®¡ç†é¢æ¿</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="teacher-stats" class="stats-card">
                        <h3 style="color: #9C27B0; margin-bottom: 20px;">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <div class="card-grid">
                            <div class="stat-card">
                                <div class="number" id="total-words">0</div>
                                <div class="label">å•è¯æ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="total-students">0</div>
                                <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="mastered-words">0</div>
                                <div class="label">å·²æŒæ¡å•è¯</div>
                            </div>
                            <div class="stat-card">
                                <div class="number" id="active-students">0</div>
                                <div class="label">æ´»è·ƒå­¦ç”Ÿ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button class="btn btn-purple" onclick="showUploadWordsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“</div>
                                <div>ä¸Šä¼ å•è¯</div>
                            </button>
                            <button class="btn btn-blue" onclick="showGroupManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ‘¥</div>
                                <div>åˆ†ç»„ç®¡ç†</div>
                            </button>
                            <button class="btn" onclick="showAllStudentsPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“‹</div>
                                <div>æ‰€æœ‰å­¦ç”Ÿ</div>
                            </button>
                            <button class="btn btn-gold" onclick="showLearningProgressPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“Š</div>
                                <div>å­¦ä¹ è¿›åº¦</div>
                            </button>
                            <button class="btn" onclick="showWordManagementPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>å•è¯ç®¡ç†</div>
                            </button>
                            <button class="btn btn-orange" onclick="showAttendanceReport()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“…</div>
                                <div>æ‰“å¡ç»Ÿè®¡</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="teacher-content">
                        <!-- æ•™å¸ˆåŠŸèƒ½å†…å®¹åŒº -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä¸»ç•Œé¢ -->
            <div id="student-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ æ¬¢è¿ï¼Œ<span id="student-name"></span>ï¼</h2>
                        <button class="btn btn-red" onclick="handleLogout()" style="padding: 8px 16px;">
                            <span>ğŸšª é€€å‡º</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <!-- ä»Šæ—¥å­¦ä¹ æƒ…å†µ -->
                    <div id="today-status" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½ä»Šæ—¥æ•°æ® -->
                    </div>
                    
                    <!-- è¿ç»­æ‰“å¡å±•ç¤º -->
                    <div id="streak-display" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½è¿ç»­æ‰“å¡ -->
                    </div>
                    
                    <!-- æˆ‘çš„å­¦ä¹ è¿›åº¦ -->
                    <div id="my-progress-summary" class="stats-card" style="margin-bottom: 30px;">
                        <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
                        <!-- åŠ¨æ€åŠ è½½è¿›åº¦æ•°æ® -->
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button class="btn" onclick="startStandardDailyTraining()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“…</div>
                                <div>ä»Šæ—¥è®­ç»ƒ</div>
                            </button>
                            <button class="btn btn-blue" onclick="showStudentOptions()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ¯</div>
                                <div>è‡ªä¸»é€‰æ‹©</div>
                            </button>
                            <button class="btn" onclick="showMyWordListPage()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ“–</div>
                                <div>æˆ‘çš„å•è¯æœ¬</div>
                            </button>
                            <button class="btn" onclick="startIntensiveReview()" style="height: 80px; font-size: 18px;">
                                <div>ğŸ”¥</div>
                                <div>å¼ºåŒ–å¤ä¹ </div>
                            </button>
                            <button class="btn" onclick="showMyAchievementsPage()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ†</div>
                                <div>æˆ‘çš„æˆå°±</div>
                            </button>
                            <button class="btn btn-gold" onclick="manualSyncWords()" style="height: 80px; font-size: 18px; grid-column: span 2;">
                                <div>ğŸ”„</div>
                                <div>ç«‹å³åŒæ­¥</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æˆ‘çš„åˆ†ç»„è¯¦æƒ… -->
                    <div id="group-details" style="margin-bottom: 30px;">
                        <!-- åŠ¨æ€åŠ è½½åˆ†ç»„è¯¦æƒ… -->
                    </div>
                </div>
            </div>
            
            <!-- ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- è‡ªä¸»é€‰æ‹©é¡µé¢ -->
            <div id="student-options-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ è‡ªä¸»é€‰æ‹©å­¦ä¹ æ¨¡å¼</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding" id="student-options-content">
                    <!-- åŠ¨æ€åŠ è½½é€‰æ‹©ç•Œé¢ -->
                </div>
            </div>
            
            <!-- è®­ç»ƒé¡µé¢ -->
            <div id="training-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666;">
                            è¿›åº¦: <span id="training-progress">0/0</span>
                        </div>
                        <button class="btn btn-red" onclick="cancelTraining()" style="padding: 8px 16px;">
                            <span>ğŸ ç»“æŸè®­ç»ƒ</span>
                        </button>
                    </div>
                </div>
                
                <div class="content-padding">
                    <div id="training-content" style="max-width: 600px; margin: 0 auto;">
                        <!-- åŠ¨æ€åŠ è½½è®­ç»ƒå†…å®¹ -->
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç”Ÿæˆå°±é¡µé¢ -->
            <div id="student-achievements-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ† æˆ‘çš„æˆå°±</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="achievements-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿå•è¯æœ¬é¡µé¢ -->
            <div id="student-wordlist-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– æˆ‘çš„å•è¯æœ¬</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="wordlist-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- å­¦ç”Ÿä»Šæ—¥ä»»åŠ¡é¡µé¢ -->
            <div id="student-today-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“… ä»Šæ—¥ä»»åŠ¡</h2>
                        <button class="btn" onclick="showStudentDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="today-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- ========== æ•™å¸ˆåŠŸèƒ½é¡µé¢ ========== -->
            
            <!-- æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ -->
            <div id="teacher-upload-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“ ä¸Šä¼ å•è¯</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-upload-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ -->
            <div id="teacher-groups-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-groups-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ -->
            <div id="teacher-students-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-students-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ -->
            <div id="teacher-progress-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-progress-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ -->
            <div id="teacher-words-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“– å•è¯ç®¡ç†</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-words-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <!-- æ•™å¸ˆæ‰“å¡ç»Ÿè®¡é¡µé¢ -->
            <div id="teacher-attendance-screen" class="screen">
                <div class="fixed-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #333;">ğŸ“… æ‰“å¡ç»Ÿè®¡</h2>
                        <button class="btn" onclick="showTeacherDashboard()" style="padding: 8px 16px;">
                            <span>ğŸ”™ è¿”å›</span>
                        </button>
                    </div>
                </div>
                <div class="content-padding" id="teacher-attendance-content">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

<script>
// ========== æ•°æ®åº“é…ç½® ==========
const SUPABASE_URL = 'https://lctdyhtydcqhloibogyj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjdGR5aHR5ZGNxaGxvaWJvZ3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTM1NTksImV4cCI6MjA4NDM4OTU1OX0.enKrwAeSpQ1QHIUZbU-2rTdDI-ALLXkq3YCdvvQO3lM';

// åˆ›å»ºSupabaseå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨å®‰å…¨çš„æ–¹å¼ï¼‰
let dbClient;
try {
    if (typeof supabase !== 'undefined') {
        dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
    } else {
        throw new Error('Supabaseåº“æœªåŠ è½½');
    }
} catch (error) {
    console.error('âŒ åˆ›å»ºSupabaseå®¢æˆ·ç«¯å¤±è´¥:', error);
    // åˆ›å»ºå…¨å±€å˜é‡ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
    window.supabase = {
        createClient: function(url, key) {
            return {
                from: function() {
                    return {
                        select: function() { return Promise.resolve({ data: [], error: null }); },
                        insert: function() { return Promise.resolve({ data: [], error: null }); },
                        update: function() { return Promise.resolve({ data: [], error: null }); },
                        delete: function() { return Promise.resolve({ data: [], error: null }); }
                    };
                },
                rpc: function() { return Promise.resolve({ data: [], error: null }); }
            };
        }
    };
    dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// ========== å…¨å±€çŠ¶æ€ ==========
const appState = {
    currentUser: null,
    isTeacher: false,
    userId: null,
    userWords: [],
    trainingWords: [],
    currentWordIndex: 0,
    isCardFlipped: false,
    teacherId: 'kathy151',
    selectedGroupId: null,
    selectedWords: [],
    dailyTrainingProgress: 0,
    lastTrainingDate: null,
    
    // æ™ºèƒ½å­¦ä¹ é…ç½®
    dailyTarget: 10,
    reviewSettings: {
        mastered: { maxPerDay: 2, weight: 15 },
        learning: { maxPerDay: 8, weight: 50 },
        new: { maxPerDay: 10, weight: 35 }
    },
    consecutiveDays: 0,
    lastStudyDate: null,
    reviewDay: false,
    weeklySchedule: {
        day1: { newWords: 10, review: true },
        day2: { newWords: 10, review: true },
        day3: { newWords: 10, review: true },
        day4: { newWords: 10, review: true },
        day5: { newWords: 10, review: true },
        day6: { newWords: 10, review: true },
        day7: { newWords: 0, review: true, isReviewDay: true }
    },
    todayWordsToReview: [],
    
    // è®°å¿†æ›²çº¿é…ç½®
    memoryCurve: [1, 2, 4, 7, 15, 30],
    
    // å­¦ç”Ÿè‡ªä¸»é€‰é¡¹
    studentOptions: {
        extraNewWords: 10,
        extraReviewWords: 15,
        maxDailyWords: 50
    },
    
    // æ•™å¸ˆåŠŸèƒ½çŠ¶æ€
    teacherGroups: [],
    teacherStudents: [],
    teacherWords: [],
    currentGroup: null
};

// ========== å·¥å…·å‡½æ•° ==========
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
    window.scrollTo(0, 0);
}

function showMessage(elementId, message, type = 'info') {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    el.textContent = message;
    el.className = `message-box message-${type}`;
    el.style.display = 'block';
}

function showAlert(message, type = 'info', duration = 3000) {
    // ç§»é™¤ç°æœ‰çš„alert
    const existingAlert = document.querySelector('.alert-message');
    if (existingAlert) existingAlert.remove();
    
    const alertBox = document.createElement('div');
    alertBox.className = `message-box message-${type} alert-message`;
    alertBox.style.position = 'fixed';
    alertBox.style.top = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.zIndex = '9999';
    alertBox.style.maxWidth = '500px';
    alertBox.style.width = '90%';
    alertBox.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';
    alertBox.textContent = message;
    
    document.body.appendChild(alertBox);
    setTimeout(() => {
        if (alertBox.parentNode) {
            alertBox.style.opacity = '0';
            alertBox.style.transition = 'opacity 0.5s';
            setTimeout(() => alertBox.remove(), 500);
        }
    }, duration);
}

function getFontSizeClass(text) {
    if (!text) return 'font-size-md';
    const length = text.length;
    if (length <= 10) return 'font-size-xl';
    if (length <= 15) return 'font-size-lg';
    if (length <= 20) return 'font-size-md';
    if (length <= 25) return 'font-size-sm';
    return 'font-size-xs';
}

function formatDate(date) {
    if (!date) return 'ä»æœª';
    const d = new Date(date);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// ========== æ•°æ®åº“è¿æ¥æµ‹è¯• ==========
async function testDatabase() {
    showMessage('login-message', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'warning');
    try {
        const { data, error } = await dbClient.from('users').select('count').limit(1);
        if (error) {
            if (error.message.includes('relation "users" does not exist')) {
                showMessage('login-message', 'æ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡ŒSQLåˆå§‹åŒ–', 'warning');
            } else {
                throw error;
            }
        } else {
            showMessage('login-message', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
        }
    } catch (error) {
        console.error('æ•°æ®åº“è¿æ¥é”™è¯¯:', error);
        showMessage('login-message', `âŒ è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== ç™»å½•/æ³¨å†Œç³»ç»Ÿ ==========
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        showMessage('login-message', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    showMessage('login-message', 'æ­£åœ¨å¤„ç†...', 'warning');
    
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        const { data: existingUser, error: checkError } = await dbClient
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (checkError && checkError.code === 'PGRST116') {
            // æ–°ç”¨æˆ·æ³¨å†Œ
            const isTeacherAccount = username.toLowerCase() === appState.teacherId.toLowerCase();
            
            const { data: newUser, error: createError } = await dbClient
                .from('users')
                .insert([{
                    username: username,
                    is_teacher: isTeacherAccount,
                    teacher_id: appState.teacherId
                }])
                .select()
                .single();
            
            if (createError) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', createError);
                // å°è¯•å†æ¬¡æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è¢«åˆ›å»º
                const { data: userCheck } = await dbClient
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (userCheck) {
                    appState.currentUser = username;
                    appState.isTeacher = userCheck.is_teacher;
                } else {
                    throw createError;
                }
            } else {
                appState.currentUser = username;
                appState.isTeacher = isTeacherAccount;
            }
            
            showMessage('login-message', `âœ… æ¬¢è¿æ–°ç”¨æˆ· ${username}ï¼`, 'success');
            
        } else if (checkError) {
            throw checkError;
        } else {
            // ç”¨æˆ·å·²å­˜åœ¨
            appState.currentUser = username;
            appState.isTeacher = existingUser.is_teacher;
            
            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            await dbClient
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('username', username);
            
            showMessage('login-message', `âœ… æ¬¢è¿å›æ¥ ${username}ï¼`, 'success');
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('kathy_current_user', appState.currentUser);
        localStorage.setItem('kathy_user_role', appState.isTeacher ? 'teacher' : 'student');
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        if (appState.isTeacher) {
            await initializeTeacher();
            setTimeout(() => showTeacherDashboard(), 500);
        } else {
            await syncGroupWordsToStudent(appState.currentUser);
            setTimeout(() => showStudentDashboard(), 500);
        }
        
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showMessage('login-message', `ç™»å½•å¤±è´¥ï¼š${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆåˆå§‹åŒ– ==========
async function initializeTeacher() {
    try {
        // æ£€æŸ¥æ˜¯å¦æœ‰é»˜è®¤åˆ†ç»„
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('id')
            .eq('teacher_id', appState.teacherId)
            .eq('name', 'é»˜è®¤åˆ†ç»„');
        
        if (error) throw error;
        
        if (!groups || groups.length === 0) {
            // åˆ›å»ºé»˜è®¤åˆ†ç»„
            const { data: newGroup, error: createError } = await dbClient
                .from('groups')
                .insert([{
                    name: 'é»˜è®¤åˆ†ç»„',
                    teacher_id: appState.teacherId,
                    description: 'ç³»ç»Ÿé»˜è®¤åˆ†ç»„'
                }])
                .select()
                .single();
            
            if (createError && !createError.message.includes('duplicate')) {
                console.error('åˆ›å»ºé»˜è®¤åˆ†ç»„å¤±è´¥:', createError);
            }
        }
    } catch (error) {
        console.error('æ•™å¸ˆåˆå§‹åŒ–é”™è¯¯:', error);
    }
}

// ========== æ•™å¸ˆä»ªè¡¨æ¿ ==========
async function showTeacherDashboard() {
    showScreen('teacher-screen');
    await loadTeacherDashboard();
}

async function loadTeacherDashboard() {
    try {
        // è·å–ç»Ÿè®¡æ•°æ®
        const [
            wordsResponse,
            studentsResponse,
            studyResponse,
            attendanceResponse
        ] = await Promise.all([
            dbClient.from('words').select('count', { count: 'exact' }).eq('teacher_id', appState.teacherId),
            dbClient.from('users').select('count', { count: 'exact' }).eq('is_teacher', false),
            dbClient.from('study_records').select('status'),
            dbClient.from('attendance_records')
                .select('student_id, study_date')
                .gte('study_date', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
        ]);
        
        // å¤„ç†æ•°æ®
        const totalWords = wordsResponse.count || 0;
        const totalStudents = studentsResponse.count || 0;
        const masteredWords = studyResponse.data?.filter(r => r.status === 'mastered').length || 0;
        
        // è®¡ç®—æ´»è·ƒå­¦ç”Ÿï¼ˆæœ€è¿‘7å¤©æœ‰æ‰“å¡çš„ï¼‰
        const activeStudents = new Set();
        if (attendanceResponse.data) {
            attendanceResponse.data.forEach(record => {
                activeStudents.add(record.student_id);
            });
        }
        
        // æ›´æ–°UI
        document.getElementById('total-words').textContent = totalWords;
        document.getElementById('total-students').textContent = totalStudents;
        document.getElementById('mastered-words').textContent = masteredWords;
        document.getElementById('active-students').textContent = activeStudents.size;
        
        // åŠ è½½æ•™å¸ˆé¢æ¿å†…å®¹
        const content = document.getElementById('teacher-content');
        content.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">âœ¨ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;">
                    <button class="btn" style="padding: 12px 24px;" onclick="showUploadWordsPage()">
                        <span>ğŸ“¤ å¿«é€Ÿä¸Šä¼ </span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 24px;" onclick="quickStats()">
                        <span>ğŸ“ˆ ä»Šæ—¥æ•°æ®</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px;" onclick="showAllStudentsPage()">
                        <span>ğŸ‘€ æŸ¥çœ‹å­¦ç”Ÿ</span>
                    </button>
                    <button class="btn" style="padding: 12px 24px; background: #FF9800;" onclick="showAttendanceReport()">
                        <span>ğŸ“… æ‰“å¡ç»Ÿè®¡</span>
                    </button>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ’¡ ç³»ç»Ÿæç¤º</h4>
                    <p style="color: #666; margin: 5px 0;">â€¢ å·²ä¸Šä¼  ${totalWords} ä¸ªå•è¯</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å…±æœ‰ ${totalStudents} åå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ æœ€è¿‘7å¤© ${activeStudents.size} åæ´»è·ƒå­¦ç”Ÿ</p>
                    <p style="color: #666; margin: 5px 0;">â€¢ å­¦ç”Ÿå…±æŒæ¡ ${masteredWords} ä¸ªå•è¯</p>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ•™å¸ˆé¢æ¿é”™è¯¯:', error);
        document.getElementById('teacher-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>' +
            '<p style="color: #666; font-size: 14px;">é”™è¯¯ä¿¡æ¯: ' + error.message + '</p>' +
            '<button class="btn" onclick="loadTeacherDashboard()">é‡è¯•</button>' +
            '</div>';
    }
}

// ========== æ•™å¸ˆä¸Šä¼ å•è¯é¡µé¢ ==========
function showUploadWordsPage() {
    showScreen('teacher-upload-screen');
    loadUploadWordsPage();
}

async function loadUploadWordsPage() {
    try {
        // è·å–æ•™å¸ˆçš„åˆ†ç»„
        const { data: groups, error } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (error) throw error;
        
        let groupsOptions = '<option value="">é€‰æ‹©åˆ†ç»„...</option>';
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                groupsOptions += `<option value="${group.id}">${group.name}</option>`;
            });
        }
        
        const content = document.getElementById('teacher-upload-content');
        content.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ ä¸Šä¼ å•è¯</h3>
                
                <div class="stats-card" style="margin-bottom: 30px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">é€‰æ‹©åˆ†ç»„</label>
                        <select id="upload-group" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            ${groupsOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">å•è¯åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="word-category" placeholder="è¾“å…¥åˆ†ç±»ï¼ˆå¦‚ï¼šåŸºç¡€è¯æ±‡ã€ç§‘æŠ€è¯æ±‡ç­‰ï¼‰" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #333; margin-bottom: 15px;">æ‰¹é‡ä¸Šä¼ æ ¼å¼</h4>
                    <textarea id="words-input" placeholder="è¾“å…¥æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªå•è¯ï¼Œè‹±æ–‡å’Œä¸­æ–‡ç”¨é€—å·åˆ†éš”ï¼‰ï¼š
hello,ä½ å¥½
world,ä¸–ç•Œ
apple,è‹¹æœ
book,ä¹¦

å¯é€‰ï¼šè‹±æ–‡,ä¸­æ–‡,åˆ†ç±»ï¼ˆå¦‚ï¼šcomputer,ç”µè„‘,ç§‘æŠ€ï¼‰" 
                              style="width: 100%; height: 250px; font-family: 'Courier New', monospace; padding: 15px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px; line-height: 1.5;"></textarea>
                    
                    <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="btn" onclick="parseAndPreviewWords()" style="padding: 15px; font-size: 16px;">
                            <span>ğŸ‘ï¸ é¢„è§ˆå•è¯</span>
                        </button>
                        <button class="btn btn-blue" onclick="uploadWordsBatch()" style="padding: 15px; font-size: 16px;">
                            <span>ğŸ“¤ ä¸Šä¼ å•è¯</span>
                        </button>
                    </div>
                </div>
                
                <div id="upload-preview" style="margin-top: 30px;"></div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½ä¸Šä¼ é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-upload-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>' +
            '<button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>' +
            '</div>';
    }
}

async function parseAndPreviewWords() {
    const text = document.getElementById('words-input').value.trim();
    const groupId = document.getElementById('upload-group').value;
    const category = document.getElementById('word-category').value || 'é€šç”¨';
    
    if (!groupId) {
        showAlert('è¯·å…ˆé€‰æ‹©åˆ†ç»„', 'error');
        return;
    }
    
    if (!text) {
        showAlert('è¯·è¾“å…¥å•è¯å†…å®¹', 'error');
        return;
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    const words = [];
    let validCount = 0;
    let errorCount = 0;
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        const parts = line.split(',').map(part => part.trim());
        
        if (parts.length >= 2) {
            const english = parts[0];
            const chinese = parts[1];
            const wordCategory = parts[2] || category;
            
            if (english && chinese) {
                words.push({
                    english: english.toLowerCase(),
                    chinese: chinese,
                    category: wordCategory
                });
                validCount++;
            } else {
                errorCount++;
            }
        } else {
            errorCount++;
        }
    }
    
    if (validCount === 0) {
        showAlert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ ¼å¼', 'error');
        return;
    }
    
    const previewDiv = document.getElementById('upload-preview');
    previewDiv.innerHTML = `
        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h4 style="color: #333; margin-bottom: 15px;">é¢„è§ˆ (${validCount}ä¸ªæœ‰æ•ˆå•è¯)</h4>
            ${errorCount > 0 ? `<p style="color: #FF9800; margin-bottom: 15px;">âš ï¸ ${errorCount} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼Œå·²å¿½ç•¥</p>` : ''}
            
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">è‹±æ–‡</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ä¸­æ–‡</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">åˆ†ç±»</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${words.map(word => `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>${word.english}</strong></td>
                                <td style="padding: 10px;">${word.chinese}</td>
                                <td style="padding: 10px;"><span style="background: #E8F5E9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${word.category}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-blue" onclick="confirmUploadWords()" style="padding: 12px 30px; font-size: 16px;">
                    âœ… ç¡®è®¤ä¸Šä¼  ${validCount} ä¸ªå•è¯
                </button>
            </div>
        </div>
    `;
    
    // ä¿å­˜é¢„è§ˆæ•°æ®åˆ°å…¨å±€çŠ¶æ€
    appState.previewWords = {
        words: words,
        groupId: groupId,
        category: category
    };
}

async function confirmUploadWords() {
    if (!appState.previewWords || !appState.previewWords.words.length) {
        showAlert('æ²¡æœ‰å¯ä¸Šä¼ çš„å•è¯', 'error');
        return;
    }
    
    const { words, groupId, category } = appState.previewWords;
    
    try {
        showAlert('æ­£åœ¨ä¸Šä¼ å•è¯...', 'info');
        
        // å‡†å¤‡è¦æ’å…¥çš„å•è¯æ•°æ®
        const wordData = words.map(word => ({
            teacher_id: appState.teacherId,
            english: word.english,
            chinese: word.chinese,
            category: word.category || category,
            group_id: groupId
        }));
        
        // æ‰¹é‡æ’å…¥å•è¯
        const { data, error } = await dbClient
            .from('words')
            .insert(wordData)
            .select();
        
        if (error) {
            console.error('ä¸Šä¼ å•è¯é”™è¯¯:', error);
            
            // å¦‚æœæ‰¹é‡æ’å…¥å¤±è´¥ï¼Œå°è¯•å•ä¸ªæ’å…¥
            let successCount = 0;
            const errors = [];
            
            for (const word of wordData) {
                try {
                    const { error: singleError } = await dbClient
                        .from('words')
                        .insert(word);
                    
                    if (!singleError) {
                        successCount++;
                    } else {
                        errors.push(`${word.english}: ${singleError.message}`);
                    }
                } catch (err) {
                    errors.push(`${word.english}: ${err.message}`);
                }
            }
            
            if (successCount > 0) {
                showAlert(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªå•è¯${errors.length > 0 ? `ï¼Œå¤±è´¥ ${errors.length} ä¸ª` : ''}`, 'success');
                // è‡ªåŠ¨åŒæ­¥ç»™åˆ†ç»„å­¦ç”Ÿ
                await syncWordsToGroupStudents(groupId, successCount);
            } else {
                showAlert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å•è¯æ ¼å¼', 'error');
            }
            
        } else {
            showAlert(`æˆåŠŸä¸Šä¼  ${data.length} ä¸ªå•è¯ï¼`, 'success');
            // è‡ªåŠ¨åŒæ­¥ç»™åˆ†ç»„å­¦ç”Ÿ
            await syncWordsToGroupStudents(groupId, data.length);
        }
        
        // æ¸…ç©ºè¾“å…¥å’Œé¢„è§ˆ
        document.getElementById('words-input').value = '';
        document.getElementById('upload-preview').innerHTML = '';
        appState.previewWords = null;
        
        // 3ç§’åè¿”å›æ•™å¸ˆé¢æ¿
        setTimeout(() => {
            showTeacherDashboard();
        }, 3000);
        
    } catch (error) {
        console.error('ä¸Šä¼ å•è¯é”™è¯¯:', error);
        showAlert(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
}

async function syncWordsToGroupStudents(groupId, wordCount) {
    try {
        showAlert('æ­£åœ¨å°†æ–°å•è¯åŒæ­¥ç»™åˆ†ç»„å­¦ç”Ÿ...', 'info');
        
        // è·å–åˆ†ç»„ä¸­çš„æ‰€æœ‰å­¦ç”Ÿ
        const { data: students, error } = await dbClient
            .from('group_students')
            .select('student_id')
            .eq('group_id', groupId);
        
        if (error || !students || students.length === 0) {
            console.log('åˆ†ç»„ä¸­æ²¡æœ‰å­¦ç”Ÿï¼Œè·³è¿‡åŒæ­¥');
            return;
        }
        
        // è·å–åˆšä¸Šä¼ çš„å•è¯
        const { data: newWords } = await dbClient
            .from('words')
            .select('id, english, chinese')
            .eq('group_id', groupId)
            .order('created_at', { ascending: false })
            .limit(wordCount);
        
        if (!newWords || newWords.length === 0) return;
        
        let totalSynced = 0;
        
        // ä¸ºæ¯ä¸ªå­¦ç”ŸåŒæ­¥å•è¯
        for (const student of students) {
            const studentId = student.student_id;
            
            // è·å–å­¦ç”Ÿå·²æœ‰å•è¯
            const { data: existingRecords } = await dbClient
                .from('study_records')
                .select('word_id')
                .eq('student_id', studentId);
            
            const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
            
            // å‡†å¤‡æ–°è®°å½•
            const newRecords = newWords
                .filter(word => !existingWordIds.has(word.id))
                .map(word => ({
                    student_id: studentId,
                    word_id: word.id,
                    english: word.english,
                    chinese: word.chinese,
                    status: 'new',
                    group_id: groupId
                }));
            
            if (newRecords.length > 0) {
                const { error: insertError } = await dbClient
                    .from('study_records')
                    .insert(newRecords);
                
                if (!insertError) {
                    totalSynced += newRecords.length;
                }
            }
        }
        
        if (totalSynced > 0) {
            showAlert(`å·²å°†æ–°å•è¯åŒæ­¥ç»™ ${students.length} åå­¦ç”Ÿï¼Œå…±è®¡ ${totalSynced} æ¡è®°å½•`, 'success');
        }
        
    } catch (error) {
        console.error('åŒæ­¥å•è¯ç»™å­¦ç”Ÿé”™è¯¯:', error);
    }
}

function uploadWordsBatch() {
    if (!appState.previewWords) {
        parseAndPreviewWords();
    } else {
        confirmUploadWords();
    }
}

// ========== æ•™å¸ˆåˆ†ç»„ç®¡ç†é¡µé¢ ==========
function showGroupManagementPage() {
    showScreen('teacher-groups-screen');
    loadGroupManagementPage();
}

async function loadGroupManagementPage() {
    try {
        // è·å–åˆ†ç»„æ•°æ®
        const { data: groups, error } = await dbClient
            .from('groups')
            .select(`
                id,
                name,
                description,
                created_at,
                group_students (student_id),
                words (id)
            `)
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (error) throw error;
        
        const content = document.getElementById('teacher-groups-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="btn" onclick="createNewGroup()" style="padding: 12px 24px;">
                        <span>â• åˆ›å»ºæ–°åˆ†ç»„</span>
                    </button>
                    <button class="btn btn-blue" onclick="manageAllStudents()" style="padding: 12px 24px;">
                        <span>ğŸ‘¥ ç®¡ç†æ‰€æœ‰å­¦ç”Ÿ</span>
                    </button>
                </div>
                
                <div id="groups-list" style="margin-top: 20px;">
                    ${renderGroupsList(groups || [])}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„ç®¡ç†é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-groups-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>' +
            '<button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>' +
            '</div>';
    }
}

function renderGroupsList(groups) {
    if (groups.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç»„</p>';
    }
    
    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
            ${groups.map(group => {
                const studentCount = group.group_students?.length || 0;
                const wordCount = group.words?.length || 0;
                const createdDate = formatDate(group.created_at);
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #4CAF50;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: #333; font-size: 18px;">${group.name}</h4>
                                ${group.description ? `<p style="color: #666; margin: 5px 0; font-size: 14px;">${group.description}</p>` : ''}
                                <p style="color: #999; font-size: 12px; margin-top: 5px;">åˆ›å»ºäº: ${createdDate}</p>
                            </div>
                            <button class="btn" onclick="editGroup('${group.id}')" style="padding: 6px 12px; font-size: 14px;">
                                âœï¸ ç¼–è¾‘
                            </button>
                        </div>
                        
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${wordCount}</div>
                                    <div style="color: #666; font-size: 12px;">å•è¯æ•°é‡</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${studentCount}</div>
                                    <div style="color: #666; font-size: 12px;">å­¦ç”Ÿæ•°é‡</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-blue" onclick="manageGroupStudents('${group.id}')" 
                                    style="flex: 1; padding: 8px; font-size: 14px;">
                                ç®¡ç†å­¦ç”Ÿ
                            </button>
                            <button class="btn" onclick="viewGroupWords('${group.id}')" 
                                    style="flex: 1; padding: 8px; font-size: 14px;">
                                æŸ¥çœ‹å•è¯
                            </button>
                            <button class="btn" onclick="deleteGroup('${group.id}')" 
                                    style="flex: 1; padding: 8px; font-size: 14px; background: #F44336;">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

async function createNewGroup() {
    const groupName = prompt('è¯·è¾“å…¥æ–°åˆ†ç»„åç§°ï¼š');
    if (!groupName) return;
    
    try {
        const { data, error } = await dbClient
            .from('groups')
            .insert([{
                name: groupName,
                teacher_id: appState.teacherId,
                description: prompt('è¯·è¾“å…¥åˆ†ç»„æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š') || ''
            }])
            .select();
        
        if (error) {
            if (error.code === '23505') {
                showAlert('åˆ†ç»„åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°', 'error');
            } else {
                throw error;
            }
        } else {
            showAlert(`åˆ†ç»„ "${groupName}" åˆ›å»ºæˆåŠŸï¼`, 'success');
            await loadGroupManagementPage();
        }
    } catch (error) {
        console.error('åˆ›å»ºåˆ†ç»„é”™è¯¯:', error);
        showAlert(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
    }
}

async function manageGroupStudents(groupId) {
    try {
        // è·å–åˆ†ç»„ä¿¡æ¯
        const { data: group, error: groupError } = await dbClient
            .from('groups')
            .select('name')
            .eq('id', groupId)
            .single();
        
        if (groupError) throw groupError;
        
        // è·å–åˆ†ç»„ä¸­çš„å­¦ç”Ÿ
        const { data: groupStudents, error: studentsError } = await dbClient
            .from('group_students')
            .select('student_id')
            .eq('group_id', groupId);
        
        if (studentsError) throw studentsError;
        
        // è·å–æ‰€æœ‰å­¦ç”Ÿ
        const { data: allStudents, error: allError } = await dbClient
            .from('users')
            .select('username')
            .eq('is_teacher', false)
            .eq('teacher_id', appState.teacherId)
            .order('username');
        
        if (allError) throw allError;
        
        const currentStudents = new Set(groupStudents?.map(s => s.student_id) || []);
        
        // åˆ›å»ºç®¡ç†ç•Œé¢
        const content = document.getElementById('teacher-groups-content');
        content.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="loadGroupManagementPage()" style="padding: 8px 16px;">
                        â† è¿”å›
                    </button>
                    <h3 style="margin: 0; color: #333;">ç®¡ç†åˆ†ç»„: ${group.name}</h3>
                </div>
                
                <div class="stats-card">
                    <h4 style="color: #333; margin-bottom: 15px;">ğŸ‘¥ å­¦ç”Ÿç®¡ç†</h4>
                    <p style="color: #666; margin-bottom: 15px;">å½“å‰åˆ†ç»„æœ‰ ${currentStudents.size} åå­¦ç”Ÿ</p>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">å­¦ç”Ÿ</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">çŠ¶æ€</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allStudents.map(student => {
                                    const isInGroup = currentStudents.has(student.username);
                                    return `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 10px;"><strong>${student.username}</strong></td>
                                            <td style="padding: 10px;">
                                                <span style="background: ${isInGroup ? '#E8F5E9' : '#FFF3CD'}; color: ${isInGroup ? '#2E7D32' : '#856404'}; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                                    ${isInGroup ? 'âœ… å·²åœ¨åˆ†ç»„' : 'â³ æœªåœ¨åˆ†ç»„'}
                                                </span>
                                            </td>
                                            <td style="padding: 10px;">
                                                <button class="btn" onclick="toggleStudentInGroup('${groupId}', '${student.username}', ${isInGroup})" 
                                                        style="padding: 6px 12px; font-size: 14px; background: ${isInGroup ? '#F44336' : '#4CAF50'}">
                                                    ${isInGroup ? 'ç§»é™¤' : 'æ·»åŠ '}
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-blue" onclick="syncAllWordsToGroup('${groupId}')" style="margin-right: 10px;">
                            åŒæ­¥æ‰€æœ‰å•è¯ç»™æœ¬ç»„å­¦ç”Ÿ
                        </button>
                        <button class="btn" onclick="loadGroupManagementPage()">
                            å®Œæˆ
                        </button>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('ç®¡ç†åˆ†ç»„å­¦ç”Ÿé”™è¯¯:', error);
        showAlert(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        loadGroupManagementPage();
    }
}

async function toggleStudentInGroup(groupId, studentId, isInGroup) {
    try {
        if (isInGroup) {
            // ä»åˆ†ç»„ä¸­ç§»é™¤å­¦ç”Ÿ
            const { error } = await dbClient
                .from('group_students')
                .delete()
                .eq('group_id', groupId)
                .eq('student_id', studentId);
            
            if (error) throw error;
            showAlert(`å·²å°†å­¦ç”Ÿ ${studentId} ä»åˆ†ç»„ä¸­ç§»é™¤`, 'success');
        } else {
            // æ·»åŠ åˆ°åˆ†ç»„
            const { error } = await dbClient
                .from('group_students')
                .insert([{
                    group_id: groupId,
                    student_id: studentId
                }]);
            
            if (error) throw error;
            showAlert(`å·²å°†å­¦ç”Ÿ ${studentId} æ·»åŠ åˆ°åˆ†ç»„`, 'success');
            
            // åŒæ­¥åˆ†ç»„å•è¯ç»™å­¦ç”Ÿ
            await syncGroupWordsToStudent(studentId);
        }
        
        // åˆ·æ–°ç•Œé¢
        await manageGroupStudents(groupId);
        
    } catch (error) {
        console.error('åˆ‡æ¢å­¦ç”Ÿåˆ†ç»„çŠ¶æ€é”™è¯¯:', error);
        showAlert(`æ“ä½œå¤±è´¥: ${error.message}`, 'error');
    }
}

async function syncAllWordsToGroup(groupId) {
    try {
        showAlert('æ­£åœ¨åŒæ­¥å•è¯ç»™æœ¬ç»„æ‰€æœ‰å­¦ç”Ÿ...', 'info');
        
        // è·å–åˆ†ç»„ä¸­çš„æ‰€æœ‰å­¦ç”Ÿ
        const { data: students, error: studentsError } = await dbClient
            .from('group_students')
            .select('student_id')
            .eq('group_id', groupId);
        
        if (studentsError) throw studentsError;
        
        if (!students || students.length === 0) {
            showAlert('åˆ†ç»„ä¸­æ²¡æœ‰å­¦ç”Ÿ', 'warning');
            return;
        }
        
        // è·å–åˆ†ç»„ä¸­çš„æ‰€æœ‰å•è¯
        const { data: words, error: wordsError } = await dbClient
            .from('words')
            .select('id, english, chinese')
            .eq('group_id', groupId);
        
        if (wordsError) throw wordsError;
        
        if (!words || words.length === 0) {
            showAlert('åˆ†ç»„ä¸­æ²¡æœ‰å•è¯', 'warning');
            return;
        }
        
        let totalSynced = 0;
        
        // ä¸ºæ¯ä¸ªå­¦ç”ŸåŒæ­¥å•è¯
        for (const student of students) {
            const synced = await syncWordsToStudent(student.student_id, words);
            totalSynced += synced;
        }
        
        showAlert(`å·²ä¸º ${students.length} åå­¦ç”ŸåŒæ­¥äº†å•è¯ï¼Œå…±è®¡ ${totalSynced} æ¡è®°å½•`, 'success');
        
    } catch (error) {
        console.error('åŒæ­¥å•è¯ç»™åˆ†ç»„é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
    }
}

async function syncWordsToStudent(studentId, words) {
    try {
        // è·å–å­¦ç”Ÿå·²æœ‰å•è¯
        const { data: existingRecords } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°è®°å½•
        const newRecords = words
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                group_id: words[0].group_id
            }));
        
        if (newRecords.length === 0) return 0;
        
        const { error } = await dbClient
            .from('study_records')
            .insert(newRecords);
        
        if (error) {
            console.error(`ä¸ºå­¦ç”Ÿ ${studentId} åŒæ­¥å•è¯å¤±è´¥:`, error);
            return 0;
        }
        
        return newRecords.length;
        
    } catch (error) {
        console.error(`åŒæ­¥å•è¯ç»™å­¦ç”Ÿ ${studentId} é”™è¯¯:`, error);
        return 0;
    }
}

async function viewGroupWords(groupId) {
    try {
        // è·å–åˆ†ç»„ä¿¡æ¯
        const { data: group, error: groupError } = await dbClient
            .from('groups')
            .select('name')
            .eq('id', groupId)
            .single();
        
        if (groupError) throw groupError;
        
        // è·å–åˆ†ç»„å•è¯
        const { data: words, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .eq('group_id', groupId)
            .order('english');
        
        if (wordsError) throw wordsError;
        
        const content = document.getElementById('teacher-groups-content');
        content.innerHTML = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="loadGroupManagementPage()" style="padding: 8px 16px;">
                        â† è¿”å›
                    </button>
                    <h3 style="margin: 0; color: #333;">åˆ†ç»„å•è¯: ${group.name} (${words?.length || 0}ä¸ª)</h3>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>è‹±æ–‡</th>
                                <th>ä¸­æ–‡</th>
                                <th>åˆ†ç±»</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${words?.map(word => `
                                <tr>
                                    <td><strong>${word.english}</strong></td>
                                    <td>${word.chinese}</td>
                                    <td><span style="background: #E8F5E9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${word.category || 'é€šç”¨'}</span></td>
                                    <td>${formatDate(word.created_at)}</td>
                                    <td>
                                        <button class="btn" onclick="editWord('${word.id}')" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;">
                                            ç¼–è¾‘
                                        </button>
                                        <button class="btn" onclick="deleteWord('${word.id}')" style="padding: 6px 12px; font-size: 14px; background: #F44336;">
                                            åˆ é™¤
                                        </button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="5" style="text-align: center; padding: 20px;">æš‚æ— å•è¯</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-blue" onclick="addWordToGroup('${groupId}')">
                        â• æ·»åŠ å•è¯
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('æŸ¥çœ‹åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        loadGroupManagementPage();
    }
}

async function deleteGroup(groupId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç»„å—ï¼Ÿåˆ†ç»„ä¸­çš„å­¦ç”Ÿå°†ä¸ä¼šè¢«åˆ é™¤ï¼Œä½†ä¼šå¤±å»ä¸åˆ†ç»„å•è¯çš„å…³è”ã€‚')) {
        return;
    }
    
    try {
        const { error } = await dbClient
            .from('groups')
            .delete()
            .eq('id', groupId);
        
        if (error) throw error;
        
        showAlert('åˆ†ç»„åˆ é™¤æˆåŠŸï¼', 'success');
        await loadGroupManagementPage();
        
    } catch (error) {
        console.error('åˆ é™¤åˆ†ç»„é”™è¯¯:', error);
        showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨é¡µé¢ ==========
function showAllStudentsPage() {
    showScreen('teacher-students-screen');
    loadAllStudentsPage();
}

async function loadAllStudentsPage() {
    try {
        // è·å–æ‰€æœ‰å­¦ç”ŸåŠå…¶å­¦ä¹ æ•°æ®
        const { data: students, error } = await dbClient
            .from('users')
            .select(`
                username,
                created_at,
                last_login,
                study_records (
                    status,
                    last_reviewed,
                    review_count
                ),
                attendance_records (
                    study_date,
                    word_count
                )
            `)
            .eq('is_teacher', false)
            .eq('teacher_id', appState.teacherId)
            .order('username');
        
        if (error) throw error;
        
        // å¤„ç†å­¦ç”Ÿæ•°æ®
        const studentData = students?.map(student => {
            const studyRecords = student.study_records || [];
            const attendanceRecords = student.attendance_records || [];
            
            const totalWords = studyRecords.length;
            const masteredWords = studyRecords.filter(r => r.status === 'mastered').length;
            const learningWords = studyRecords.filter(r => r.status === 'learning').length;
            const newWords = studyRecords.filter(r => r.status === 'new').length;
            const totalReviews = studyRecords.reduce((sum, r) => sum + (r.review_count || 0), 0);
            
            // è®¡ç®—æœ€è¿‘7å¤©å­¦ä¹ å¤©æ•°
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recentStudyDays = attendanceRecords
                .filter(r => new Date(r.study_date) >= sevenDaysAgo)
                .length;
            
            // æœ€åå­¦ä¹ æ—¥æœŸ
            const lastStudy = studyRecords
                .filter(r => r.last_reviewed)
                .sort((a, b) => new Date(b.last_reviewed) - new Date(a.last_reviewed))[0];
            
            return {
                username: student.username,
                created_at: student.created_at,
                last_login: student.last_login,
                totalWords,
                masteredWords,
                learningWords,
                newWords,
                totalReviews,
                recentStudyDays,
                lastStudyDate: lastStudy?.last_reviewed,
                masteryRate: totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0
            };
        }) || [];
        
        const content = document.getElementById('teacher-students-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿ (${studentData.length}äºº)</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                    <div style="flex: 1;">
                        <input type="text" id="student-search" placeholder="ğŸ” æœç´¢å­¦ç”Ÿ..." 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;"
                               oninput="filterStudents()">
                    </div>
                    <button class="btn" onclick="exportStudentData()" style="padding: 12px 24px;">
                        ğŸ“Š å¯¼å‡ºæ•°æ®
                    </button>
                </div>
                
                <div id="students-list">
                    ${renderStudentsList(studentData)}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
        document.getElementById('teacher-students-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>' +
            '<button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>' +
            '</div>';
    }
}

function renderStudentsList(students) {
    if (students.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— å­¦ç”Ÿæ•°æ®</p>';
    }
    
    return `
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>å­¦ç”Ÿ</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æœ€åç™»å½•</th>
                        <th>å•è¯æ€»æ•°</th>
                        <th>å·²æŒæ¡</th>
                        <th>å­¦ä¹ ä¸­</th>
                        <th>éœ€å­¦ä¹ </th>
                        <th>æŒæ¡ç‡</th>
                        <th>æœ€è¿‘7å¤©</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => {
                        const lastLogin = student.last_login ? formatDate(student.last_login) : 'ä»æœª';
                        const lastStudy = student.lastStudyDate ? formatDate(student.lastStudyDate) : 'ä»æœªå­¦ä¹ ';
                        const createdDate = formatDate(student.created_at);
                        
                        return `
                            <tr>
                                <td><strong>${student.username}</strong></td>
                                <td>${createdDate}</td>
                                <td>${lastLogin}</td>
                                <td>${student.totalWords}</td>
                                <td style="color: #4CAF50;">${student.masteredWords}</td>
                                <td style="color: #2196F3;">${student.learningWords}</td>
                                <td style="color: #FF9800;">${student.newWords}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 60px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                                            <div style="width: ${student.masteryRate}%; height: 100%; 
                                                 background: ${student.masteryRate >= 70 ? '#4CAF50' : 
                                                               student.masteryRate >= 50 ? '#FF9800' : '#F44336'};"></div>
                                        </div>
                                        <span style="font-size: 12px; color: #666;">${student.masteryRate}%</span>
                                    </div>
                                </td>
                                <td>${student.recentStudyDays}å¤©</td>
                                <td>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                            onclick="viewStudentDetails('${student.username}')">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ========== æ•™å¸ˆå­¦ä¹ è¿›åº¦é¡µé¢ ==========
function showLearningProgressPage() {
    showScreen('teacher-progress-screen');
    loadLearningProgressPage();
}

async function loadLearningProgressPage() {
    try {
        // è·å–æ€»ä½“ç»Ÿè®¡æ•°æ®
        const [
            wordsResponse,
            studentsResponse,
            studyResponse,
            attendanceResponse
        ] = await Promise.all([
            dbClient.from('words').select('count', { count: 'exact' }).eq('teacher_id', appState.teacherId),
            dbClient.from('users').select('count', { count: 'exact' }).eq('is_teacher', false),
            dbClient.from('study_records')
                .select('status, student_id, last_reviewed')
                .eq('student_id', (await dbClient
                    .from('users')
                    .select('username')
                    .eq('is_teacher', false)
                    .limit(1)
                )?.data?.[0]?.username || ''),
            dbClient.from('attendance_records')
                .select('study_date, word_count, student_id')
                .gte('study_date', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
        ]);
        
        const totalWords = wordsResponse.count || 0;
        const totalStudents = studentsResponse.count || 0;
        const masteredWords = studyResponse.data?.filter(r => r.status === 'mastered').length || 0;
        
        // è®¡ç®—æ´»è·ƒå­¦ç”Ÿï¼ˆæœ€è¿‘7å¤©ï¼‰
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const activeStudents = new Set();
        if (attendanceResponse.data) {
            attendanceResponse.data.forEach(record => {
                if (new Date(record.study_date) >= sevenDaysAgo) {
                    activeStudents.add(record.student_id);
                }
            });
        }
        
        // è®¡ç®—æœˆåº¦å­¦ä¹ è¶‹åŠ¿
        const monthlyTrend = {};
        if (attendanceResponse.data) {
            attendanceResponse.data.forEach(record => {
                const month = record.study_date.substring(0, 7); // YYYY-MM
                if (!monthlyTrend[month]) {
                    monthlyTrend[month] = { wordCount: 0, studyDays: 0 };
                }
                monthlyTrend[month].wordCount += record.word_count;
                monthlyTrend[month].studyDays++;
            });
        }
        
        const content = document.getElementById('teacher-progress-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“Š å­¦ä¹ è¿›åº¦åˆ†æ</h3>
                
                <div class="stats-card">
                    <h4 style="color: #333; margin-bottom: 20px;">ğŸ“ˆ æ€»ä½“ç»Ÿè®¡æ•°æ®</h4>
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${totalStudents}</div>
                            <div class="label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${activeStudents.size}</div>
                            <div class="label">æ´»è·ƒå­¦ç”Ÿ(7å¤©)</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${totalWords}</div>
                            <div class="label">å•è¯æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${masteredWords}</div>
                            <div class="label">å·²æŒæ¡å•è¯</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div class="stats-card">
                        <h4 style="color: #333; margin-bottom: 15px;">ğŸ“… æœˆåº¦å­¦ä¹ è¶‹åŠ¿</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${Object.entries(monthlyTrend).map(([month, data]) => `
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-weight: bold;">${month}</span>
                                        <span style="color: #4CAF50;">${data.wordCount} å•è¯</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #666;">
                                        <span>å­¦ä¹ å¤©æ•°: ${data.studyDays}</span>
                                        <span>æ—¥å‡: ${Math.round(data.wordCount / data.studyDays)}</span>
                                    </div>
                                </div>
                            `).join('')}
                            ${Object.keys(monthlyTrend).length === 0 ? 
                                '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— å­¦ä¹ æ•°æ®</p>' : ''}
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h4 style="color: #333; margin-bottom: 15px;">ğŸš€ å¿«é€Ÿåˆ†æ</h4>
                        <div style="margin-bottom: 15px;">
                            <p style="color: #666; margin-bottom: 10px;">å­¦ç”Ÿå¹³å‡æŒæ¡ç‡:</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0}%"></div>
                            </div>
                            <div style="text-align: center; margin-top: 5px; color: #4CAF50; font-weight: bold;">
                                ${totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0}%
                            </div>
                        </div>
                        
                        <div>
                            <p style="color: #666; margin-bottom: 10px;">å­¦ç”Ÿæ´»è·ƒåº¦:</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${totalStudents > 0 ? Math.round((activeStudents.size / totalStudents) * 100) : 0}%"></div>
                            </div>
                            <div style="text-align: center; margin-top: 5px; color: #2196F3; font-weight: bold;">
                                ${totalStudents > 0 ? Math.round((activeStudents.size / totalStudents) * 100) : 0}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showTeacherDashboard()" style="margin-right: 10px;">
                        è¿”å›
                    </button>
                    <button class="btn btn-blue" onclick="refreshProgressData()">
                        åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å­¦ä¹ è¿›åº¦é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-progress-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>' +
            '<button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>' +
            '</div>';
    }
}

// ========== æ•™å¸ˆå•è¯ç®¡ç†é¡µé¢ ==========
function showWordManagementPage() {
    showScreen('teacher-words-screen');
    loadWordManagementPage();
}

async function loadWordManagementPage() {
    try {
        // è·å–æ‰€æœ‰å•è¯
        const { data: words, error } = await dbClient
            .from('words')
            .select(`
                *,
                groups (name),
                study_records (status)
            `)
            .eq('teacher_id', appState.teacherId)
            .order('created_at', { ascending: false })
            .limit(100);
        
        if (error) throw error;
        
        // å¤„ç†å•è¯æ•°æ®
        const wordData = words?.map(word => {
            const studyRecords = word.study_records || [];
            const totalStudents = studyRecords.length;
            const masteredStudents = studyRecords.filter(r => r.status === 'mastered').length;
            const learningStudents = studyRecords.filter(r => r.status === 'learning').length;
            const newStudents = studyRecords.filter(r => r.status === 'new').length;
            
            const masteryRate = totalStudents > 0 ? Math.round((masteredStudents / totalStudents) * 100) : 0;
            
            return {
                ...word,
                group_name: word.groups?.name || 'æœªåˆ†ç»„',
                totalStudents,
                masteredStudents,
                learningStudents,
                newStudents,
                masteryRate
            };
        }) || [];
        
        const content = document.getElementById('teacher-words-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“– å•è¯ç®¡ç† (${wordData.length}ä¸ª)</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <select id="words-group-filter" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;"
                                onchange="filterTeacherWords()">
                            <option value="all">å…¨éƒ¨åˆ†ç»„</option>
                            ${getGroupOptions()}
                        </select>
                    </div>
                    <div style="flex: 2; min-width: 300px;">
                        <input type="text" id="words-search" placeholder="ğŸ” æœç´¢è‹±æ–‡æˆ–ä¸­æ–‡..." 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;"
                               oninput="filterTeacherWords()">
                    </div>
                    <button class="btn btn-blue" onclick="showAddSingleWordModal()" style="padding: 12px 24px;">
                        â• æ·»åŠ å•è¯
                    </button>
                </div>
                
                <div id="words-list">
                    ${renderTeacherWordsList(wordData)}
                </div>
            </div>
        `;
        
        // ä¿å­˜å•è¯æ•°æ®åˆ°å…¨å±€çŠ¶æ€
        appState.teacherWords = wordData;
        
    } catch (error) {
        console.error('åŠ è½½å•è¯ç®¡ç†é¡µé¢é”™è¯¯:', error);
        document.getElementById('teacher-words-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>' +
            '<button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>' +
            '</div>';
    }
}

async function getGroupOptions() {
    try {
        const { data: groups } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        if (!groups || groups.length === 0) return '';
        
        return groups.map(group => `<option value="${group.id}">${group.name}</option>`).join('');
    } catch (error) {
        console.error('è·å–åˆ†ç»„é€‰é¡¹é”™è¯¯:', error);
        return '';
    }
}

function renderTeacherWordsList(words) {
    if (words.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— å•è¯æ•°æ®</p>';
    }
    
    return `
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>è‹±æ–‡</th>
                        <th>ä¸­æ–‡</th>
                        <th>åˆ†ç»„</th>
                        <th>åˆ†ç±»</th>
                        <th>å­¦ä¹ å­¦ç”Ÿ</th>
                        <th>æŒæ¡å­¦ç”Ÿ</th>
                        <th>æŒæ¡ç‡</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${words.map(word => {
                        const masteryRate = word.masteryRate || 0;
                        let masteryColor = '#4CAF50';
                        if (masteryRate < 30) masteryColor = '#F44336';
                        else if (masteryRate < 60) masteryColor = '#FF9800';
                        
                        return `
                            <tr data-group-id="${word.group_id}" data-english="${word.english.toLowerCase()}" data-chinese="${word.chinese}">
                                <td><strong>${word.english}</strong></td>
                                <td>${word.chinese}</td>
                                <td><span style="background: #E3F2FD; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${word.group_name}</span></td>
                                <td><span style="background: #E8F5E9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${word.category || 'é€šç”¨'}</span></td>
                                <td>${word.totalStudents}</td>
                                <td>${word.masteredStudents}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 80px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${masteryRate}%; height: 100%; background: ${masteryColor};"></div>
                                        </div>
                                        <span style="color: ${masteryColor}; font-weight: bold;">${masteryRate}%</span>
                                    </div>
                                </td>
                                <td>${formatDate(word.created_at)}</td>
                                <td>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;" 
                                            onclick="editWord('${word.id}')">
                                        ç¼–è¾‘
                                    </button>
                                    <button class="btn" style="padding: 6px 12px; font-size: 14px; background: #F44336;" 
                                            onclick="deleteWord('${word.id}')">
                                        åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        ${words.length >= 100 ? `
            <div style="text-align: center; margin-top: 20px; color: #666;">
                æ˜¾ç¤ºå‰100ä¸ªå•è¯ï¼Œä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥çœ‹æ›´å¤š
            </div>
        ` : ''}
    `;
}

function filterTeacherWords() {
    const filter = document.getElementById('words-group-filter').value;
    const search = document.getElementById('words-search').value.toLowerCase();
    const rows = document.querySelectorAll('#words-list tr[data-group-id]');
    
    rows.forEach(row => {
        const groupId = row.getAttribute('data-group-id');
        const english = row.getAttribute('data-english');
        const chinese = row.getAttribute('data-chinese');
        
        let groupMatch = true;
        if (filter !== 'all' && filter !== groupId) {
            groupMatch = false;
        }
        
        const searchMatch = !search || 
                           english.includes(search) || 
                           chinese.includes(search);
        
        row.style.display = (groupMatch && searchMatch) ? '' : 'none';
    });
}

async function showAddSingleWordModal() {
    try {
        // è·å–åˆ†ç»„é€‰é¡¹
        const { data: groups } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        let groupsOptions = '<option value="">é€‰æ‹©åˆ†ç»„...</option>';
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                groupsOptions += `<option value="${group.id}">${group.name}</option>`;
            });
        }
        
        const modalHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="color: #333; margin-bottom: 20px;">â• æ·»åŠ å•è¯</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">è‹±æ–‡</label>
                        <input type="text" id="new-word-english" placeholder="è¾“å…¥è‹±æ–‡" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ä¸­æ–‡</label>
                        <input type="text" id="new-word-chinese" placeholder="è¾“å…¥ä¸­æ–‡" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="new-word-category" placeholder="è¾“å…¥åˆ†ç±»" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">åˆ†ç»„</label>
                        <select id="new-word-group" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            ${groupsOptions}
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" onclick="closeModal()" style="flex: 1;">
                            å–æ¶ˆ
                        </button>
                        <button class="btn btn-blue" onclick="saveNewWord()" style="flex: 1;">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.innerHTML = modalHTML;
        modal.id = 'add-word-modal';
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('æ˜¾ç¤ºæ·»åŠ å•è¯æ¨¡æ€æ¡†é”™è¯¯:', error);
        showAlert(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
    }
}

function closeModal() {
    const modal = document.getElementById('add-word-modal');
    if (modal) modal.remove();
}

async function saveNewWord() {
    const english = document.getElementById('new-word-english').value.trim();
    const chinese = document.getElementById('new-word-chinese').value.trim();
    const category = document.getElementById('new-word-category').value.trim() || 'é€šç”¨';
    const groupId = document.getElementById('new-word-group').value;
    
    if (!english || !chinese) {
        showAlert('è¯·å¡«å†™è‹±æ–‡å’Œä¸­æ–‡', 'error');
        return;
    }
    
    if (!groupId) {
        showAlert('è¯·é€‰æ‹©åˆ†ç»„', 'error');
        return;
    }
    
    try {
        const { data, error } = await dbClient
            .from('words')
            .insert([{
                teacher_id: appState.teacherId,
                english: english.toLowerCase(),
                chinese: chinese,
                category: category,
                group_id: groupId
            }])
            .select();
        
        if (error) {
            if (error.code === '23505') {
                showAlert('å•è¯å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ', 'error');
            } else {
                throw error;
            }
        } else {
            showAlert('å•è¯æ·»åŠ æˆåŠŸï¼', 'success');
            closeModal();
            await loadWordManagementPage();
        }
        
    } catch (error) {
        console.error('ä¿å­˜å•è¯é”™è¯¯:', error);
        showAlert(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
    }
}

async function editWord(wordId) {
    try {
        // è·å–å•è¯ä¿¡æ¯
        const { data: word, error } = await dbClient
            .from('words')
            .select('*')
            .eq('id', wordId)
            .single();
        
        if (error) throw error;
        
        // è·å–åˆ†ç»„é€‰é¡¹
        const { data: groups } = await dbClient
            .from('groups')
            .select('id, name')
            .eq('teacher_id', appState.teacherId)
            .order('name');
        
        let groupsOptions = '';
        if (groups && groups.length > 0) {
            groups.forEach(group => {
                groupsOptions += `<option value="${group.id}" ${group.id === word.group_id ? 'selected' : ''}>${group.name}</option>`;
            });
        }
        
        const modalHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="color: #333; margin-bottom: 20px;">âœï¸ ç¼–è¾‘å•è¯</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">è‹±æ–‡</label>
                        <input type="text" id="edit-word-english" value="${word.english}" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ä¸­æ–‡</label>
                        <input type="text" id="edit-word-chinese" value="${word.chinese}" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">åˆ†ç±»</label>
                        <input type="text" id="edit-word-category" value="${word.category || ''}" 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">åˆ†ç»„</label>
                        <select id="edit-word-group" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            ${groupsOptions}
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" onclick="closeEditModal()" style="flex: 1;">
                            å–æ¶ˆ
                        </button>
                        <button class="btn btn-blue" onclick="saveEditedWord('${wordId}')" style="flex: 1;">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.innerHTML = modalHTML;
        modal.id = 'edit-word-modal';
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('ç¼–è¾‘å•è¯é”™è¯¯:', error);
        showAlert(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
    }
}

function closeEditModal() {
    const modal = document.getElementById('edit-word-modal');
    if (modal) modal.remove();
}

async function saveEditedWord(wordId) {
    const english = document.getElementById('edit-word-english').value.trim();
    const chinese = document.getElementById('edit-word-chinese').value.trim();
    const category = document.getElementById('edit-word-category').value.trim() || 'é€šç”¨';
    const groupId = document.getElementById('edit-word-group').value;
    
    if (!english || !chinese) {
        showAlert('è¯·å¡«å†™è‹±æ–‡å’Œä¸­æ–‡', 'error');
        return;
    }
    
    if (!groupId) {
        showAlert('è¯·é€‰æ‹©åˆ†ç»„', 'error');
        return;
    }
    
    try {
        const { error } = await dbClient
            .from('words')
            .update({
                english: english.toLowerCase(),
                chinese: chinese,
                category: category,
                group_id: groupId
            })
            .eq('id', wordId);
        
        if (error) throw error;
        
        showAlert('å•è¯æ›´æ–°æˆåŠŸï¼', 'success');
        closeEditModal();
        await loadWordManagementPage();
        
    } catch (error) {
        console.error('æ›´æ–°å•è¯é”™è¯¯:', error);
        showAlert(`æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
    }
}

async function deleteWord(wordId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰å­¦ç”Ÿçš„å­¦ä¹ è®°å½•ã€‚')) {
        return;
    }
    
    try {
        const { error } = await dbClient
            .from('words')
            .delete()
            .eq('id', wordId);
        
        if (error) throw error;
        
        showAlert('å•è¯åˆ é™¤æˆåŠŸï¼', 'success');
        await loadWordManagementPage();
        
    } catch (error) {
        console.error('åˆ é™¤å•è¯é”™è¯¯:', error);
        showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

// ========== æ•™å¸ˆæ‰“å¡ç»Ÿè®¡é¡µé¢ ==========
function showAttendanceReport() {
    showScreen('teacher-attendance-screen');
    loadAttendanceReport();
}

async function loadAttendanceReport() {
    try {
        // è·å–æœ€è¿‘30å¤©çš„æ‰“å¡æ•°æ®
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const { data: attendance, error } = await dbClient
            .from('attendance_records')
            .select('*')
            .gte('study_date', thirtyDaysAgo)
            .order('study_date', { ascending: false });
        
        if (error) throw error;
        
        // æŒ‰æ—¥æœŸç»Ÿè®¡
        const dailyStats = {};
        attendance?.forEach(record => {
            const date = record.study_date;
            if (!dailyStats[date]) {
                dailyStats[date] = {
                    studentCount: 0,
                    totalWords: 0,
                    newWords: 0,
                    reviewWords: 0
                };
            }
            dailyStats[date].studentCount++;
            dailyStats[date].totalWords += record.word_count;
            dailyStats[date].newWords += record.new_word_count;
            dailyStats[date].reviewWords += record.review_word_count;
        });
        
        // æŒ‰å­¦ç”Ÿç»Ÿè®¡
        const studentStats = {};
        attendance?.forEach(record => {
            const studentId = record.student_id;
            if (!studentStats[studentId]) {
                studentStats[studentId] = {
                    totalDays: 0,
                    totalWords: 0,
                    newWords: 0,
                    reviewWords: 0,
                    lastStudy: record.study_date
                };
            }
            studentStats[studentId].totalDays++;
            studentStats[studentId].totalWords += record.word_count;
            studentStats[studentId].newWords += record.new_word_count;
            studentStats[studentId].reviewWords += record.review_word_count;
            if (record.study_date > studentStats[studentId].lastStudy) {
                studentStats[studentId].lastStudy = record.study_date;
            }
        });
        
        const content = document.getElementById('teacher-attendance-content');
        content.innerHTML = `
            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“… æ‰“å¡ç»Ÿè®¡ (æœ€è¿‘30å¤©)</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="btn" onclick="loadDailyAttendance()" style="padding: 12px 24px;">
                        æ¯æ—¥ç»Ÿè®¡
                    </button>
                    <button class="btn btn-blue" onclick="loadWeeklyAttendance()" style="padding: 12px 24px;">
                        æ¯å‘¨ç»Ÿè®¡
                    </button>
                    <button class="btn" onclick="loadStudentRanking()" style="padding: 12px 24px;">
                        å­¦ç”Ÿæ’å
                    </button>
                    <button class="btn" onclick="loadConsecutiveAchievements()" style="padding: 12px 24px; background: #FF9800;">
                        è¿ç»­æ‰“å¡
                    </button>
                </div>
                
                <div id="attendance-data">
                    ${renderAttendanceSummary(dailyStats, studentStats)}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æ‰“å¡ç»Ÿè®¡é”™è¯¯:', error);
        document.getElementById('teacher-attendance-content').innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
            '<p style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>' +
            '<button class="btn" onclick="showTeacherDashboard()">è¿”å›</button>' +
            '</div>';
    }
}

function renderAttendanceSummary(dailyStats, studentStats) {
    const totalDays = Object.keys(dailyStats).length;
    const totalStudents = Object.keys(studentStats).length;
    const totalWords = Object.values(dailyStats).reduce((sum, day) => sum + day.totalWords, 0);
    const avgWordsPerDay = totalDays > 0 ? Math.round(totalWords / totalDays) : 0;
    
    // è®¡ç®—è¿ç»­æ‰“å¡
    const consecutiveRanking = Object.entries(studentStats)
        .map(([studentId, stats]) => ({
            studentId,
            consecutiveDays: calculateConsecutiveDays(studentId, dailyStats),
            ...stats
        }))
        .sort((a, b) => b.consecutiveDays - a.consecutiveDays)
        .slice(0, 10);
    
    return `
        <div class="stats-card">
            <h4 style="color: #333; margin-bottom: 20px;">ğŸ“Š æ‰“å¡æ€»è§ˆ</h4>
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${totalDays}</div>
                    <div class="label">æœ‰å­¦ä¹ å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${totalStudents}</div>
                    <div class="label">å­¦ä¹ å­¦ç”Ÿæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${totalWords}</div>
                    <div class="label">æ€»å•è¯é‡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${avgWordsPerDay}</div>
                    <div class="label">æ—¥å‡å•è¯</div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h4 style="color: #333; margin-bottom: 15px;">ğŸ† è¿ç»­æ‰“å¡æ’è¡Œæ¦œ</h4>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å­¦ç”Ÿ</th>
                            <th>è¿ç»­å¤©æ•°</th>
                            <th>å­¦ä¹ å¤©æ•°</th>
                            <th>æ€»å•è¯</th>
                            <th>æœ€åå­¦ä¹ </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${consecutiveRanking.map((student, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td><strong>${student.studentId}</strong></td>
                                <td>
                                    <span style="background: ${student.consecutiveDays >= 7 ? '#FFD700' : student.consecutiveDays >= 3 ? '#C0C0C0' : '#CD7F32'}; 
                                          color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                        ${student.consecutiveDays}å¤©
                                    </span>
                                </td>
                                <td>${student.totalDays}</td>
                                <td>${student.totalWords}</td>
                                <td>${student.lastStudy}</td>
                            </tr>
                        `).join('')}
                        ${consecutiveRanking.length === 0 ? 
                            '<tr><td colspan="6" style="text-align: center; padding: 20px;">æš‚æ— æ‰“å¡æ•°æ®</td></tr>' : ''}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="showTeacherDashboard()">
                è¿”å›
            </button>
        </div>
    `;
}

function calculateConsecutiveDays(studentId, dailyStats) {
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æŸ¥è¯¢æ•°æ®åº“è·å–å­¦ç”Ÿçš„è¿ç»­æ‰“å¡å¤©æ•°
    const dates = Object.keys(dailyStats).sort().reverse();
    let consecutiveDays = 0;
    let currentDate = new Date();
    
    for (let i = 0; i < 30; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        if (dates.includes(dateStr)) {
            consecutiveDays++;
        } else {
            break;
        }
        currentDate.setDate(currentDate.getDate() - 1);
    }
    
    return consecutiveDays;
}

// ========== åŒæ­¥å•è¯ç»™å­¦ç”Ÿ ==========
async function syncGroupWordsToStudent(studentId) {
    try {
        showAlert('æ­£åœ¨åŒæ­¥å•è¯...', 'info');
        
        // è·å–å­¦ç”Ÿæ‰€åœ¨åˆ†ç»„
        const { data: studentGroups, error: groupsError } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', studentId);
        
        if (groupsError) {
            console.error('è·å–å­¦ç”Ÿåˆ†ç»„é”™è¯¯:', groupsError);
            return 0;
        }
        
        if (!studentGroups || studentGroups.length === 0) {
            // å°†å­¦ç”ŸåŠ å…¥é»˜è®¤åˆ†ç»„
            const { data: defaultGroup } = await dbClient
                .from('groups')
                .select('id')
                .eq('teacher_id', appState.teacherId)
                .eq('name', 'é»˜è®¤åˆ†ç»„')
                .single();
            
            if (defaultGroup) {
                await dbClient
                    .from('group_students')
                    .insert([{
                        group_id: defaultGroup.id,
                        student_id: studentId
                    }])
                    .onConflict(['group_id', 'student_id'])
                    .ignore();
                
                studentGroups = [{ group_id: defaultGroup.id }];
            } else {
                showAlert('ç³»ç»Ÿé”™è¯¯ï¼šé»˜è®¤åˆ†ç»„ä¸å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                return 0;
            }
        }
        
        const groupIds = studentGroups.map(g => g.group_id);
        
        // è·å–åˆ†ç»„å•è¯
        const { data: groupWords, error: wordsError } = await dbClient
            .from('words')
            .select('*')
            .in('group_id', groupIds);
        
        if (wordsError) {
            console.error('è·å–åˆ†ç»„å•è¯é”™è¯¯:', wordsError);
            return 0;
        }
        
        if (!groupWords || groupWords.length === 0) {
            showAlert('æ‚¨æ‰€åœ¨çš„åˆ†ç»„ä¸­è¿˜æ²¡æœ‰å•è¯ï¼Œè¯·è”ç³»è€å¸ˆä¸Šä¼ å•è¯', 'info');
            return 0;
        }
        
        // è·å–å­¦ç”Ÿå·²æœ‰è®°å½•
        const { data: existingRecords } = await dbClient
            .from('study_records')
            .select('word_id')
            .eq('student_id', studentId);
        
        const existingWordIds = new Set(existingRecords?.map(r => r.word_id) || []);
        
        // å‡†å¤‡æ–°è®°å½•
        const newRecords = groupWords
            .filter(word => !existingWordIds.has(word.id))
            .map(word => ({
                student_id: studentId,
                word_id: word.id,
                english: word.english,
                chinese: word.chinese,
                status: 'new',
                group_id: word.group_id
            }));
        
        if (newRecords.length === 0) {
            showAlert('æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
            return 0;
        }
        
        // æ’å…¥æ–°è®°å½•
        const { error: insertError } = await dbClient
            .from('study_records')
            .insert(newRecords);
        
        if (insertError) {
            console.error('æ’å…¥å­¦ä¹ è®°å½•é”™è¯¯:', insertError);
            showAlert('åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            return 0;
        }
        
        showAlert(`åŒæ­¥æˆåŠŸï¼æ–°å¢ ${newRecords.length} ä¸ªå•è¯`, 'success');
        return newRecords.length;
        
    } catch (error) {
        console.error('åŒæ­¥åˆ†ç»„å•è¯é”™è¯¯:', error);
        showAlert(`åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
        return 0;
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½ ==========
async function showStudentDashboard() {
    showScreen('student-screen');
    await loadStudentDashboardSimple();
}

async function loadStudentDashboardSimple() {
    try {
        document.getElementById('student-name').textContent = appState.currentUser;
        
        // è·å–å­¦ç”Ÿå­¦ä¹ æ•°æ®
        const { data: studyRecords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        if (error) {
            console.error('è·å–å­¦ä¹ è®°å½•é”™è¯¯:', error);
            showAlert('è·å–æ•°æ®å¤±è´¥', 'error');
            return;
        }
        
        appState.userWords = studyRecords || [];
        
        // è·å–ä»Šæ—¥æ‰“å¡æ•°æ®
        const today = new Date().toISOString().split('T')[0];
        const { data: todayAttendance } = await dbClient
            .from('attendance_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .eq('study_date', today)
            .single();
        
        const todayWords = todayAttendance?.word_count || 0;
        const newWords = todayAttendance?.new_word_count || 0;
        const reviewWords = todayAttendance?.review_word_count || 0;
        const dailyTarget = 10;
        const progressPercent = Math.min(100, (todayWords / dailyTarget) * 100);
        
        // è·å–è¿ç»­æ‰“å¡
        const { data: attendanceRecords } = await dbClient
            .from('attendance_records')
            .select('study_date')
            .eq('student_id', appState.currentUser)
            .order('study_date', { ascending: false })
            .limit(7);
        
        let consecutiveDays = 0;
        const todayDate = new Date(today);
        let currentDate = new Date(todayDate);
        
        for (let i = 0; i < 7; i++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const hasStudy = attendanceRecords?.some(r => r.study_date === dateStr);
            
            if (hasStudy) {
                consecutiveDays++;
                currentDate.setDate(currentDate.getDate() - 1);
            } else {
                break;
            }
        }
        
        appState.consecutiveDays = consecutiveDays;
        
        // æ›´æ–°ç•Œé¢
        const todayStatus = document.getElementById('today-status');
        const streakDisplay = document.getElementById('streak-display');
        const progressSummary = document.getElementById('my-progress-summary');
        
        // ä»Šæ—¥çŠ¶æ€
        todayStatus.innerHTML = `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“… ä»Šæ—¥å­¦ä¹ æƒ…å†µ</h3>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="number">${todayWords}</div>
                        <div class="label">ä»Šæ—¥å·²å­¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${newWords}</div>
                        <div class="label">æ–°å•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${reviewWords}</div>
                        <div class="label">å¤ä¹ å•è¯</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${consecutiveDays}</div>
                        <div class="label">è¿ç»­å¤©æ•°</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">ä»Šæ—¥è¿›åº¦</span>
                        <span style="color: #4CAF50; font-weight: bold;">${todayWords}/${dailyTarget}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                ${todayWords >= dailyTarget ? 
                    '<div class="celebration-banner">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼æ˜å¤©å†æ¥ç»§ç»­å­¦ä¹ å§ï¼</div>' : 
                    '<p style="color: #FF9800; text-align: center; margin-top: 15px;">ğŸ’ª ç»§ç»­åŠªåŠ›ï¼</p>'}
            </div>
        `;
        
        // è¿ç»­æ‰“å¡æ˜¾ç¤º
        streakDisplay.innerHTML = generateStreakHTML(attendanceRecords, consecutiveDays);
        
        // å­¦ä¹ è¿›åº¦
        const totalWords = studyRecords?.length || 0;
        const masteredWords = studyRecords?.filter(r => r.status === 'mastered').length || 0;
        const learningWords = studyRecords?.filter(r => r.status === 'learning').length || 0;
        const newWordCount = studyRecords?.filter(r => r.status === 'new').length || 0;
        const masteryRate = totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0;
        
        progressSummary.innerHTML = `
            <h3 style="color: #2196F3; margin-bottom: 20px;">ğŸ“Š æˆ‘çš„å­¦ä¹ è¿›åº¦</h3>
            <div class="card-grid">
                <div class="stat-card">
                    <div class="number">${totalWords}</div>
                    <div class="label">å•è¯æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${masteredWords}</div>
                    <div class="label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="number">${learningWords}</div>
                    <div class="label">å­¦ä¹ ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="number">${newWordCount}</div>
                    <div class="label">éœ€å­¦ä¹ </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #666;">æ•´ä½“æŒæ¡è¿›åº¦</span>
                    <span style="color: #4CAF50; font-weight: bold;">${masteryRate}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${masteryRate}%"></div>
                </div>
            </div>
        `;
        
        // åˆ†ç»„è¯¦æƒ…
        await loadGroupDetails();
        
    } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿé¢æ¿é”™è¯¯:', error);
        showAlert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

function generateStreakHTML(attendanceRecords, consecutiveDays) {
    const streakDays = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const attendanceSet = new Set(attendanceRecords?.map(r => r.study_date) || []);
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        streakDays.push({
            date: date,
            dateStr: dateStr,
            completed: attendanceSet.has(dateStr),
            isToday: i === 0
        });
    }
    
    const todayCompleted = streakDays[6].completed;
    
    return `
        <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin: 15px 0;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <span style="font-size: 24px;">ğŸ”¥</span>
                <div>
                    <div style="font-weight: bold; color: #2E7D32;">è¿ç»­å­¦ä¹  ${consecutiveDays} å¤©</div>
                    <div style="color: #666; font-size: 14px;">
                        ${consecutiveDays % 7 === 0 && consecutiveDays > 0 ? 
                          'ğŸ‰ ä»Šå¤©æ˜¯å¤ä¹ æ—¥ï¼' : 
                          `å†åšæŒ ${7 - (consecutiveDays % 7)} å¤©å¯è·å¾—å¥–åŠ±`}
                    </div>
                </div>
            </div>
            
            <div class="streak-container">
                ${streakDays.map((day, index) => {
                    let className = 'streak-day';
                    if (day.completed) className += ' completed';
                    if (day.isToday) className += ' today';
                    if (!day.completed && !day.isToday) className += ' missed';
                    
                    return `
                        <div class="${className}" title="${day.dateStr}">
                            ${day.date.getDate()}
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                ${todayCompleted ? 'âœ… ä»Šå¤©å·²å®Œæˆå­¦ä¹ ' : 'â° ä»Šå¤©è¿˜æœªå­¦ä¹ '}
            </div>
        </div>
    `;
}

async function loadGroupDetails() {
    try {
        const { data: studentGroups } = await dbClient
            .from('group_students')
            .select('group_id')
            .eq('student_id', appState.currentUser);
        
        let groupDetails = '';
        if (studentGroups && studentGroups.length > 0) {
            for (const group of studentGroups) {
                const { data: groupInfo } = await dbClient
                    .from('groups')
                    .select('name')
                    .eq('id', group.group_id)
                    .single();
                
                if (groupInfo) {
                    groupDetails += `
                        <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${groupInfo.name}</div>
                            <div style="color: #666; font-size: 14px;">
                                åŒæ­¥æ—¶é—´: ${new Date().toLocaleDateString('zh-CN')}
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        const groupDetailsDiv = document.getElementById('group-details');
        groupDetailsDiv.innerHTML = groupDetails ? `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š æˆ‘çš„åˆ†ç»„è¯¦æƒ…</h3>
                ${groupDetails}
            </div>
        ` : `
            <div class="stats-card">
                <h3 style="color: #333; margin-bottom: 15px;">ğŸ“š åˆ†ç»„çŠ¶æ€</h3>
                <p style="color: #FF9800; text-align: center;">æ‚¨è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°ä»»ä½•åˆ†ç»„</p>
                <p style="color: #666; text-align: center; font-size: 14px;">è¯·è”ç³»è€å¸ˆå°†æ‚¨æ·»åŠ åˆ°åˆ†ç»„ä¸­</p>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç»„è¯¦æƒ…é”™è¯¯:', error);
    }
}

// ========== å­¦ç”ŸåŠŸèƒ½é¡µé¢ ==========
function showStudentOptions() {
    showScreen('student-options-screen');
    loadStudentOptions();
}

async function loadStudentOptions() {
    const content = document.getElementById('student-options-content');
    content.innerHTML = `
        <div style="max-width: 700px; margin: 0 auto;">
            <h3 style="color: #333; margin-bottom: 20px;">ğŸ¯ è‡ªä¸»é€‰æ‹©å­¦ä¹ æ¨¡å¼</h3>
            
            <div style="background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">ğŸ“š å­¦ä¹ æ¨¡å¼é€‰æ‹©</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- æ ‡å‡†æ¨¡å¼ -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #4CAF50;"
                         onclick="startStandardDailyTraining()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ“…</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">æ ‡å‡†æ¨¡å¼</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ 10ä¸ªæ–°å•è¯<br>
                            â€¢ æ™ºèƒ½å¤ä¹ å·²å­¦<br>
                            â€¢ é€‚åˆæ—¥å¸¸å­¦ä¹ 
                        </div>
                        <div style="color: #4CAF50; font-weight: bold;">æ¨è</div>
                    </div>
                    
                    <!-- ä¸“æ³¨æ–°è¯æ¨¡å¼ -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #2196F3;"
                         onclick="startExtraNewWordsTraining()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ†•</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">ä¸“æ³¨æ–°è¯</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ é¢å¤–10ä¸ªæ–°å•è¯<br>
                            â€¢ å¿«é€Ÿæ‰©å……è¯æ±‡é‡<br>
                            â€¢ æŒ‘æˆ˜è‡ªæˆ‘
                        </div>
                        <div style="color: #2196F3;">è¿›é˜¶é€‰æ‹©</div>
                    </div>
                </div>
            </div>
            
            <div style="background: #E3F2FD; border-radius: 15px; padding: 30px; margin-bottom: 20px;">
                <h4 style="color: #1565C0; margin-bottom: 15px;">ğŸ”„ å¤ä¹ æ¨¡å¼é€‰æ‹©</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- å¼ºåŒ–å¤ä¹ æ¨¡å¼ -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #FF9800;"
                         onclick="startIntensiveReview()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ”¥</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">å¼ºåŒ–å¤ä¹ </div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ é‡ç‚¹å¤ä¹ å¼±é¡¹<br>
                            â€¢ å¼ºåŒ–å­¦ä¹ ä¸­å•è¯<br>
                            â€¢ å¿«é€Ÿæå‡
                        </div>
                        <div style="color: #FF9800;">é«˜æ•ˆæåˆ†</div>
                    </div>
                    
                    <!-- è®°å¿†æ›²çº¿å¤ä¹  -->
                    <div style="background: white; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #9C27B0;"
                         onclick="startMemoryCurveReview()">
                        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ“ˆ</div>
                        <div style="font-weight: bold; margin-bottom: 10px;">è®°å¿†æ›²çº¿</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            â€¢ æŒ‰è®°å¿†è§„å¾‹å¤ä¹ <br>
                            â€¢ è¦†ç›–è¿œæœŸå•è¯<br>
                            â€¢ ç§‘å­¦è®°å¿†
                        </div>
                        <div style="color: #9C27B0;">ç§‘å­¦æ–¹æ³•</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    `;
}

function startStandardDailyTraining() {
    showAlert('å¼€å§‹å­¦ä¹ åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function startExtraNewWordsTraining() {
    showAlert('é¢å¤–æ–°è¯åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function startIntensiveReview() {
    showAlert('å¼ºåŒ–å¤ä¹ åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function startMemoryCurveReview() {
    showAlert('è®°å¿†æ›²çº¿åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function showMyWordListPage() {
    showScreen('student-wordlist-screen');
    loadStudentWordList();
}

async function loadStudentWordList() {
    try {
        const { data: studyRecords, error } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser)
            .order('last_reviewed', { ascending: false });
        
        if (error) throw error;
        
        appState.userWords = studyRecords || [];
        
        const content = document.getElementById('wordlist-content');
        
        if (!studyRecords || studyRecords.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“š</div>
                    <h3 style="color: #666; margin-bottom: 15px;">è¿˜æ²¡æœ‰å•è¯</h3>
                    <p style="color: #999;">è¯·å…ˆåŒæ­¥å•è¯æˆ–ç­‰å¾…æ•™å¸ˆä¸Šä¼ å•è¯</p>
                    <button class="btn" onclick="manualSyncWords()" style="margin-top: 20px;">
                        ğŸ”„ åŒæ­¥å•è¯
                    </button>
                </div>
            `;
            return;
        }
        
        const total = studyRecords.length;
        const mastered = studyRecords.filter(r => r.status === 'mastered').length;
        const learning = studyRecords.filter(r => r.status === 'learning').length;
        const newWords = studyRecords.filter(r => r.status === 'new').length;
        
        content.innerHTML = `
            <div style="max-width: 1000px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ“– æˆ‘çš„å•è¯æœ¬ (${total}ä¸ª)</h3>
                
                <div style="margin-bottom: 20px;">
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${total}</div>
                            <div class="label">å•è¯æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${mastered}</div>
                            <div class="label">å·²æŒæ¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${learning}</div>
                            <div class="label">å­¦ä¹ ä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${newWords}</div>
                            <div class="label">éœ€å­¦ä¹ </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <select id="word-filter" style="padding: 10px; border-radius: 5px; border: 2px solid #ddd; font-size: 16px;" onchange="filterMyWords()">
                        <option value="all">æ‰€æœ‰å•è¯</option>
                        <option value="mastered">å·²æŒæ¡</option>
                        <option value="learning">å­¦ä¹ ä¸­</option>
                        <option value="new">éœ€å­¦ä¹ </option>
                    </select>
                    <input type="text" id="word-search" placeholder="ğŸ” æœç´¢è‹±æ–‡æˆ–ä¸­æ–‡..." 
                           style="padding: 10px; border-radius: 5px; border: 2px solid #ddd; font-size: 16px; margin-left: 10px;"
                           oninput="filterMyWords()">
                </div>
                
                <div style="overflow-x: auto; max-height: 500px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>è‹±æ–‡</th>
                                <th>ä¸­æ–‡</th>
                                <th>çŠ¶æ€</th>
                                <th>å¤ä¹ æ¬¡æ•°</th>
                                <th>æœ€åå¤ä¹ </th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="words-table-body">
                            ${studyRecords.map(record => {
                                let statusText, statusColor;
                                switch(record.status) {
                                    case 'mastered': statusText = 'âœ… å·²æŒæ¡'; statusColor = '#4CAF50'; break;
                                    case 'learning': statusText = 'ğŸ”„ å­¦ä¹ ä¸­'; statusColor = '#2196F3'; break;
                                    default: statusText = 'ğŸ“ éœ€å­¦ä¹ '; statusColor = '#FF9800';
                                }
                                
                                const lastReview = record.last_reviewed ? 
                                    formatDate(record.last_reviewed) : 'ä»æœª';
                                
                                return `
                                    <tr data-status="${record.status}" data-english="${record.english.toLowerCase()}" data-chinese="${record.chinese}">
                                        <td><strong>${record.english}</strong></td>
                                        <td>${record.chinese}</td>
                                        <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                                        <td>${record.review_count || 0}</td>
                                        <td>${lastReview}</td>
                                        <td>
                                            <button class="btn" style="padding: 6px 12px; font-size: 14px;" 
                                                    onclick="practiceSingleWord('${record.english}', '${record.chinese}')">ç»ƒä¹ </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-red" onclick="showStudentDashboard()">
                        <span>ğŸ”™ è¿”å›ä¸»é¡µ</span>
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½å•è¯åˆ—è¡¨é”™è¯¯:', error);
        document.getElementById('wordlist-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

function filterMyWords() {
    const filter = document.getElementById('word-filter').value;
    const search = document.getElementById('word-search').value.toLowerCase();
    const rows = document.querySelectorAll('#words-table-body tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const english = row.getAttribute('data-english');
        const chinese = row.getAttribute('data-chinese');
        
        let statusMatch = true;
        if (filter !== 'all' && filter !== status) {
            statusMatch = false;
        }
        
        const searchMatch = !search || 
                           english.includes(search) || 
                           chinese.includes(search);
        
        row.style.display = (statusMatch && searchMatch) ? '' : 'none';
    });
}

function practiceSingleWord(english, chinese) {
    showAlert(`å¼€å§‹ç»ƒä¹ : ${english} - ${chinese}`, 'info');
    // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°å•è¯ç»ƒä¹ é¡µé¢
}

function showMyAchievementsPage() {
    showScreen('student-achievements-screen');
    loadStudentAchievements();
}

async function loadStudentAchievements() {
    try {
        const { data: studyRecords } = await dbClient
            .from('study_records')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        const { data: achievements } = await dbClient
            .from('achievements')
            .select('*')
            .eq('student_id', appState.currentUser);
        
        const total = studyRecords?.length || 0;
        const mastered = studyRecords?.filter(r => r.status === 'mastered').length || 0;
        const totalReviews = studyRecords?.reduce((sum, r) => sum + (r.review_count || 0), 0) || 0;
        const learningWords = studyRecords?.filter(r => r.status === 'learning').length || 0;
        
        // æ¨¡æ‹Ÿæˆå°±æ•°æ®
        const allAchievements = [
            { type: 'total_words_10', text: 'âœ… å•è¯æ–°æ‰‹ï¼šå­¦ä¹ 10ä¸ªå•è¯', earned: total >= 10 },
            { type: 'total_words_50', text: 'â­ å•è¯èƒ½æ‰‹ï¼šå­¦ä¹ 50ä¸ªå•è¯', earned: total >= 50 },
            { type: 'total_words_100', text: 'ğŸ† å•è¯å¤§å¸ˆï¼šå­¦ä¹ 100ä¸ªå•è¯', earned: total >= 100 },
            { type: 'mastered_20', text: 'ğŸ“š æŒæ¡èƒ½æ‰‹ï¼šæŒæ¡20ä¸ªå•è¯', earned: mastered >= 20 },
            { type: 'mastered_50', text: 'ğŸ¯ æŒæ¡å¤§å¸ˆï¼šæŒæ¡50ä¸ªå•è¯', earned: mastered >= 50 },
            { type: 'review_50', text: 'ğŸ“– å¤ä¹ èƒ½æ‰‹ï¼šæ€»å¤ä¹ 50æ¬¡', earned: totalReviews >= 50 },
            { type: 'review_100', text: 'ğŸ”„ å¤ä¹ è¾¾äººï¼šæ€»å¤ä¹ 100æ¬¡', earned: totalReviews >= 100 },
            { type: 'streak_3', text: 'ğŸ’ª åšæŒèƒ½æ‰‹ï¼šè¿ç»­å­¦ä¹ 3å¤©', earned: appState.consecutiveDays >= 3 },
            { type: 'streak_7', text: 'ğŸ”¥ åšæŒä¹‹æ˜Ÿï¼šè¿ç»­å­¦ä¹ 7å¤©', earned: appState.consecutiveDays >= 7 },
            { type: 'learning_10', text: 'ğŸ“ˆ å­¦ä¹ æ–°æ˜Ÿï¼š10ä¸ªå•è¯æ­£åœ¨å­¦ä¹ ä¸­', earned: learningWords >= 10 },
            { type: 'learning_20', text: 'ğŸš€ å­¦ä¹ å…ˆé”‹ï¼š20ä¸ªå•è¯æ­£åœ¨å­¦ä¹ ä¸­', earned: learningWords >= 20 }
        ];
        
        // æ·»åŠ æ•°æ®åº“ä¸­çš„æˆå°±
        if (achievements) {
            achievements.forEach(achievement => {
                if (!allAchievements.some(a => a.type === achievement.achievement_type)) {
                    allAchievements.push({
                        type: achievement.achievement_type,
                        text: achievement.description || achievement.achievement_type,
                        earned: true
                    });
                }
            });
        }
        
        const earnedCount = allAchievements.filter(a => a.earned).length;
        const totalCount = allAchievements.length;
        
        const content = document.getElementById('achievements-content');
        content.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="color: #333; margin-bottom: 20px;">ğŸ† æˆ‘çš„å­¦ä¹ æˆå°±</h3>
                
                <div class="stats-card">
                    <div class="card-grid">
                        <div class="stat-card">
                            <div class="number">${total}</div>
                            <div class="label">å•è¯æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${mastered}</div>
                            <div class="label">å·²æŒæ¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${totalReviews}</div>
                            <div class="label">æ€»å¤ä¹ æ¬¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${appState.consecutiveDays}</div>
                            <div class="label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">ğŸ–ï¸ æˆå°±è¿›åº¦ (${earnedCount}/${totalCount})</h4>
                        <div class="progress-bar" style="width: 200px;">
                            <div class="progress-fill" style="width: ${(earnedCount/totalCount)*100}%"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        ${allAchievements.map(achievement => `
                            <div style="background: ${achievement.earned ? '#E8F5E9' : '#f5f5f5'}; 
                                 border: 2px solid ${achievement.earned ? '#4CAF50' : '#ddd'}; 
                                 border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 24px;">
                                    ${achievement.earned ? 'âœ…' : 'â³'}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: ${achievement.earned ? '#333' : '#999'}">
                                        ${achievement.text}
                                    </div>
                                    <div style="color: ${achievement.earned ? '#4CAF50' : '#999'}; font-size: 12px; margin-top: 5px;">
                                        ${achievement.earned ? 'å·²è·å¾—' : 'æœªè·å¾—'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showStudentDashboard()">è¿”å›ä¸»é¡µ</button>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('åŠ è½½æˆå°±é”™è¯¯:', error);
        document.getElementById('achievements-content').innerHTML = 
            '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥</p>';
    }
}

async function manualSyncWords() {
    try {
        showAlert('æ­£åœ¨åŒæ­¥å•è¯...', 'info');
        const syncedCount = await syncGroupWordsToStudent(appState.currentUser);
        
        if (syncedCount > 0) {
            showAlert(`åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥ ${syncedCount} ä¸ªæ–°å•è¯`, 'success');
        } else {
            showAlert('æ‚¨å·²ç»åŒæ­¥äº†æ‰€æœ‰åˆ†ç»„å•è¯', 'info');
        }
        
        await loadStudentDashboardSimple();
        
    } catch (error) {
        console.error('æ‰‹åŠ¨åŒæ­¥é”™è¯¯:', error);
        showAlert('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
    }
}

// ========== é€€å‡ºç™»å½• ==========
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        appState.currentUser = null;
        appState.isTeacher = false;
        appState.userId = null;
        appState.userWords = [];
        appState.trainingWords = [];
        appState.selectedGroupId = null;
        appState.selectedWords = [];
        appState.dailyTrainingProgress = 0;
        appState.lastTrainingDate = null;
        appState.consecutiveDays = 0;
        appState.reviewDay = false;
        appState.todayWordsToReview = [];
        appState.teacherGroups = [];
        appState.teacherStudents = [];
        appState.teacherWords = [];
        appState.currentGroup = null;
        
        localStorage.removeItem('kathy_current_user');
        localStorage.removeItem('kathy_user_role');
        
        showScreen('login-screen');
        document.getElementById('username').value = '';
        showMessage('login-message', 'å·²é€€å‡ºç™»å½•', 'info');
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
window.onload = async function() {
    console.log('ğŸš€ Kathyå•è¯æ™ºèƒ½è®­ç»ƒç³»ç»Ÿå¯åŠ¨');
    
    const savedUser = localStorage.getItem('kathy_current_user');
    const savedRole = localStorage.getItem('kathy_user_role');
    
    if (savedUser) {
        appState.currentUser = savedUser;
        appState.isTeacher = (savedRole === 'teacher');
        appState.userId = savedUser;
        
        if (appState.isTeacher) {
            showTeacherDashboard();
        } else {
            showStudentDashboard();
        }
    } else {
        testDatabase();
    }
    
    document.getElementById('username')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
    });
    
    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(event) {
        console.error('å…¨å±€é”™è¯¯:', event.error);
        showAlert(`ç³»ç»Ÿé”™è¯¯: ${event.error.message}`, 'error');
    });
    
    window.addEventListener('unhandledrejection', function(event) {
        console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
        showAlert(`å¼‚æ­¥é”™è¯¯: ${event.reason.message}`, 'error');
    });
};
</script>
</body>
</html>
